<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_cp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_cp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* radeon_cp.c -- CP support for Radeon -*- linux-c -*- */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright 2000 Precision Insight, Inc., Cedar Park, Texas.</span>
<span class="cm"> * Copyright 2000 VA Linux Systems, Inc., Fremont, California.</span>
<span class="cm"> * Copyright 2007 Advanced Micro Devices, Inc.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Kevin E. Martin &lt;martin@valinux.com&gt;</span>
<span class="cm"> *    Gareth Hughes &lt;gareth@valinux.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_sarea.h&quot;</span>
<span class="cp">#include &quot;radeon_drm.h&quot;</span>
<span class="cp">#include &quot;radeon_drv.h&quot;</span>
<span class="cp">#include &quot;r300_reg.h&quot;</span>

<span class="cp">#define RADEON_FIFO_DEBUG	0</span>

<span class="cm">/* Firmware Names */</span>
<span class="cp">#define FIRMWARE_R100		&quot;radeon/R100_cp.bin&quot;</span>
<span class="cp">#define FIRMWARE_R200		&quot;radeon/R200_cp.bin&quot;</span>
<span class="cp">#define FIRMWARE_R300		&quot;radeon/R300_cp.bin&quot;</span>
<span class="cp">#define FIRMWARE_R420		&quot;radeon/R420_cp.bin&quot;</span>
<span class="cp">#define FIRMWARE_RS690		&quot;radeon/RS690_cp.bin&quot;</span>
<span class="cp">#define FIRMWARE_RS600		&quot;radeon/RS600_cp.bin&quot;</span>
<span class="cp">#define FIRMWARE_R520		&quot;radeon/R520_cp.bin&quot;</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_R100</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_R200</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_R300</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_R420</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_RS690</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_RS600</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_R520</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">radeon_do_cp_start</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">radeon_read_ring_rptr</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">DRM_READ32</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(((</span><span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span>
			 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">off</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)));</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">radeon_get_ring_head</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">radeon_read_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R600_CP_RB_RPTR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_write_ring_rptr</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span>
		<span class="n">DRM_WRITE32</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="p">(((</span><span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="o">+</span>
		  <span class="p">(</span><span class="n">off</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_set_ring_head</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">radeon_write_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">radeon_get_scratch</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">radeon_read_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
						     <span class="n">R600_SCRATCHOFF</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">radeon_read_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
						     <span class="n">RADEON_SCRATCHOFF</span><span class="p">(</span><span class="n">index</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R600_SCRATCH_REG0</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">index</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_SCRATCH_REG0</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">RADEON_READ_MM</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DRM_READ32</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_WRITE32</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">RADEON_MM_INDEX</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">DRM_READ32</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">RADEON_MM_DATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">R500_READ_MCIND</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R520_MC_IND_INDEX</span><span class="p">,</span> <span class="mh">0x7f0000</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R520_MC_IND_DATA</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R520_MC_IND_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">RS480_READ_MCIND</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RS480_NB_MC_INDEX</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RS480_NB_MC_DATA</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RS480_NB_MC_INDEX</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">RS690_READ_MCIND</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RS690_MC_INDEX</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">RS690_MC_INDEX_MASK</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RS690_MC_DATA</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RS690_MC_INDEX</span><span class="p">,</span> <span class="n">RS690_MC_INDEX_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">RS600_READ_MCIND</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RS600_MC_INDEX</span><span class="p">,</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">RS600_MC_ADDR_MASK</span><span class="p">)</span> <span class="o">|</span>
				      <span class="n">RS600_MC_IND_CITF_ARB0</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RS600_MC_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">IGP_READ_MCIND</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RS690_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RS600_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">RS480_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">radeon_read_fb_location</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R700_MC_VM_FB_LOCATION</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R600_MC_VM_FB_LOCATION</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV515</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">R500_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RV515_MC_FB_LOCATION</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">RS690_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS690_MC_FB_LOCATION</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RS600_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_FB_LOCATION</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CHIP_RV515</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">R500_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">R520_MC_FB_LOCATION</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_MC_FB_LOCATION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_write_fb_location</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fb_loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R700_MC_VM_FB_LOCATION</span><span class="p">,</span> <span class="n">fb_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R600_MC_VM_FB_LOCATION</span><span class="p">,</span> <span class="n">fb_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV515</span><span class="p">)</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">RV515_MC_FB_LOCATION</span><span class="p">,</span> <span class="n">fb_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span>
		<span class="n">RS690_WRITE_MCIND</span><span class="p">(</span><span class="n">RS690_MC_FB_LOCATION</span><span class="p">,</span> <span class="n">fb_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
		<span class="n">RS600_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_FB_LOCATION</span><span class="p">,</span> <span class="n">fb_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CHIP_RV515</span><span class="p">)</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">R520_MC_FB_LOCATION</span><span class="p">,</span> <span class="n">fb_loc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_MC_FB_LOCATION</span><span class="p">,</span> <span class="n">fb_loc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_write_agp_location</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">agp_loc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*R6xx/R7xx: AGP_TOP and BOT are actually 18 bits each */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R700_MC_VM_AGP_BOT</span><span class="p">,</span> <span class="n">agp_loc</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span> <span class="cm">/* FIX ME */</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R700_MC_VM_AGP_TOP</span><span class="p">,</span> <span class="p">(</span><span class="n">agp_loc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R600_MC_VM_AGP_BOT</span><span class="p">,</span> <span class="n">agp_loc</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span> <span class="cm">/* FIX ME */</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R600_MC_VM_AGP_TOP</span><span class="p">,</span> <span class="p">(</span><span class="n">agp_loc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV515</span><span class="p">)</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">RV515_MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">agp_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span>
		<span class="n">RS690_WRITE_MCIND</span><span class="p">(</span><span class="n">RS690_MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">agp_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
		<span class="n">RS600_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">agp_loc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CHIP_RV515</span><span class="p">)</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">R520_MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">agp_loc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_MC_AGP_LOCATION</span><span class="p">,</span> <span class="n">agp_loc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_write_agp_base</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u64</span> <span class="n">agp_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">agp_base_hi</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">agp_base</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">agp_base_lo</span> <span class="o">=</span> <span class="n">agp_base</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r6xx_agp_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">agp_base</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ffff</span><span class="p">;</span>

	<span class="cm">/* R6xx/R7xx must be aligned to a 4MB boundary */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R700_MC_VM_AGP_BASE</span><span class="p">,</span> <span class="n">r6xx_agp_base</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R600_MC_VM_AGP_BASE</span><span class="p">,</span> <span class="n">r6xx_agp_base</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV515</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">RV515_MC_AGP_BASE</span><span class="p">,</span> <span class="n">agp_base_lo</span><span class="p">);</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">RV515_MC_AGP_BASE_2</span><span class="p">,</span> <span class="n">agp_base_hi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RS690_WRITE_MCIND</span><span class="p">(</span><span class="n">RS690_MC_AGP_BASE</span><span class="p">,</span> <span class="n">agp_base_lo</span><span class="p">);</span>
		<span class="n">RS690_WRITE_MCIND</span><span class="p">(</span><span class="n">RS690_MC_AGP_BASE_2</span><span class="p">,</span> <span class="n">agp_base_hi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RS600_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_AGP_BASE</span><span class="p">,</span> <span class="n">agp_base_lo</span><span class="p">);</span>
		<span class="n">RS600_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_AGP_BASE_2</span><span class="p">,</span> <span class="n">agp_base_hi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CHIP_RV515</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">R520_MC_AGP_BASE</span><span class="p">,</span> <span class="n">agp_base_lo</span><span class="p">);</span>
		<span class="n">R500_WRITE_MCIND</span><span class="p">(</span><span class="n">R520_MC_AGP_BASE_2</span><span class="p">,</span> <span class="n">agp_base_hi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS400</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS480</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AGP_BASE</span><span class="p">,</span> <span class="n">agp_base_lo</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RS480_AGP_BASE_2</span><span class="p">,</span> <span class="n">agp_base_hi</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AGP_BASE</span><span class="p">,</span> <span class="n">agp_base_lo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R200</span><span class="p">)</span>
			<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AGP_BASE_2</span><span class="p">,</span> <span class="n">agp_base_hi</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_enable_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_radeon_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="cm">/* Turn on bus mastering */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* rs600/rs690/rs740 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_BUS_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RS600_BUS_MASTER_DIS</span><span class="p">;</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_BUS_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CHIP_RV350</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R420</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS400</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS480</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* r1xx, r2xx, r300, r(v)350, r420/r481, rs400/rs480 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_BUS_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RADEON_BUS_MASTER_DIS</span><span class="p">;</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_BUS_CNTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* PCIE cards appears to not need this */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">RADEON_READ_PLL</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">RADEON_WRITE8</span><span class="p">(</span><span class="n">RADEON_CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CLOCK_CNTL_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">RADEON_READ_PCIE</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RADEON_WRITE8</span><span class="p">(</span><span class="n">RADEON_PCIE_INDEX</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_PCIE_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if RADEON_FIFO_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_status</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RBBM_STATUS = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_STATUS</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CP_RB_RTPR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CP_RB_WTPR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_WPTR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AIC_CNTL = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_AIC_CNTL</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AIC_STAT = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_AIC_STAT</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AIC_PT_BASE = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_AIC_PT_BASE</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TLB_ADDR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_AIC_TLB_ADDR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TLB_DATA = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_AIC_TLB_DATA</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Engine, FIFO control</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_pixcache_flush</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_WAIT_IDLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CHIP_RV280</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RB3D_DSTCACHE_CTLSTAT</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">RADEON_RB3D_DC_FLUSH_ALL</span><span class="p">;</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_RB3D_DSTCACHE_CTLSTAT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RB3D_DSTCACHE_CTLSTAT</span><span class="p">)</span>
			      <span class="o">&amp;</span> <span class="n">RADEON_RB3D_DC_BUSY</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t flush or purge cache here or lockup */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if RADEON_FIFO_DEBUG</span>
	<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">radeon_status</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_wait_for_fifo</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_WAIT_IDLE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_STATUS</span><span class="p">)</span>
			     <span class="o">&amp;</span> <span class="n">RADEON_RBBM_FIFOCNT_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slots</span> <span class="o">&gt;=</span> <span class="n">entries</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;wait for fifo failed status : 0x%08X 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_STATUS</span><span class="p">),</span>
		 <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R300_VAP_CNTL_STATUS</span><span class="p">));</span>

<span class="cp">#if RADEON_FIFO_DEBUG</span>
	<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">radeon_status</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_wait_for_idle</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_WAIT_IDLE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_do_wait_for_fifo</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_STATUS</span><span class="p">)</span>
		      <span class="o">&amp;</span> <span class="n">RADEON_RBBM_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">radeon_do_pixcache_flush</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;wait idle failed status : 0x%08X 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_STATUS</span><span class="p">),</span>
		 <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R300_VAP_CNTL_STATUS</span><span class="p">));</span>

<span class="cp">#if RADEON_FIFO_DEBUG</span>
	<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">radeon_status</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_init_pipes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">gb_tile_config</span><span class="p">,</span> <span class="n">gb_pipe_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV530</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">z_pipe_sel</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RV530_GB_PIPE_SELECT2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">z_pipe_sel</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_z_pipes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_z_pipes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_z_pipes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* RS4xx/RS6xx/R4xx/R5xx */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R420</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gb_pipe_sel</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R400_GB_PIPE_SELECT</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span> <span class="o">=</span> <span class="p">((</span><span class="n">gb_pipe_sel</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* SE cards have 1 pipe */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5e4c</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5e4f</span><span class="p">))</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* R3xx */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R300</span> <span class="o">&amp;&amp;</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4144</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R350</span> <span class="o">&amp;&amp;</span>
		     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4148</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* RV3xx/R300 AD/R350 AH */</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Num pipes: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span><span class="p">);</span>

	<span class="n">gb_tile_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">R300_ENABLE_TILING</span> <span class="o">|</span> <span class="n">R300_TILE_SIZE_16</span> <span class="cm">/*| R300_SUBPIXEL_1_16*/</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">gb_tile_config</span> <span class="o">|=</span> <span class="n">R300_PIPE_COUNT_R300</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">gb_tile_config</span> <span class="o">|=</span> <span class="n">R300_PIPE_COUNT_R420_3P</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">gb_tile_config</span> <span class="o">|=</span> <span class="n">R300_PIPE_COUNT_R420</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">gb_tile_config</span> <span class="o">|=</span> <span class="n">R300_PIPE_COUNT_RV350</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV515</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE_PLL</span><span class="p">(</span><span class="n">R500_DYN_SCLK_PWMEM_PIPE</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">|</span> <span class="p">((</span><span class="n">gb_pipe_sel</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R300_SU_REG_DEST</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_gb_pipes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R300_GB_TILE_CONFIG</span><span class="p">,</span> <span class="n">gb_tile_config</span><span class="p">);</span>
	<span class="n">radeon_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R300_DST_PIPE_CONFIG</span><span class="p">,</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R300_DST_PIPE_CONFIG</span><span class="p">)</span> <span class="o">|</span> <span class="n">R300_PIPE_AUTO_CONFIG</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R300_RB2D_DSTCACHE_MODE</span><span class="p">,</span> <span class="p">(</span><span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R300_RB2D_DSTCACHE_MODE</span><span class="p">)</span> <span class="o">|</span>
					       <span class="n">R300_DC_AUTOFLUSH_ENABLE</span> <span class="o">|</span>
					       <span class="n">R300_DC_DC_DISABLE_IGNORE_PE</span><span class="p">));</span>


<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * CP control, initialization</span>
<span class="cm"> */</span>

<span class="cm">/* Load the microcode for the CP */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_init_microcode</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;radeon_cp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;radeon_cp: Failed to register firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R100</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV100</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV200</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS100</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS200</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Loading R100 Microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_R100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R200</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV250</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV280</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS300</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Loading R200 Microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_R200</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R300</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R350</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV350</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV380</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS400</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS480</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Loading R300 Microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_R300</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R420</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R423</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV410</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Loading R400 Microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_R420</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Loading RS690/RS740 Microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_RS690</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Loading RS600 Microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_RS600</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV515</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R520</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV530</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R580</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV560</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RV570</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Loading R500 Microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">FIRMWARE_R520</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;radeon_cp: Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fw_name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;radeon_cp: Bogus length %zu in firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_load_microcode</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">radeon_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_ME_RAM_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_ME_RAM_DATAH</span><span class="p">,</span>
				     <span class="n">be32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_ME_RAM_DATAL</span><span class="p">,</span>
				     <span class="n">be32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Flush any pending commands to the CP.  This should only be used just</span>
<span class="cm"> * prior to a wait for idle, as it informs the engine that the command</span>
<span class="cm"> * stream is ending.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_do_cp_flush</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	u32 tmp;</span>

<span class="c">	tmp = RADEON_READ(RADEON_CP_RB_WPTR) | (1 &lt;&lt; 31);</span>
<span class="c">	RADEON_WRITE(RADEON_CP_RB_WPTR, tmp);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Wait for the CP to go idle.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_do_cp_idle</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="n">RADEON_PURGE_CACHE</span><span class="p">();</span>
	<span class="n">RADEON_PURGE_ZCACHE</span><span class="p">();</span>
	<span class="n">RADEON_WAIT_UNTIL_IDLE</span><span class="p">();</span>

	<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="n">COMMIT_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">radeon_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Start the Command Processor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_do_cp_start</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">radeon_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_CSQ_CNTL</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_mode</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* on r420, any DMA from CP to system memory while 2D is active</span>
<span class="cm">	 * can cause a hang.  workaround is to queue a CP RESYNC token</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R420</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">R300_CP_RESYNC_ADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="cm">/* scratch reg 5 */</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mh">0xdeadbeef</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="n">COMMIT_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* isync can only be written through cp on r5xx write it here */</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">RADEON_ISYNC_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">RADEON_ISYNC_ANY2D_IDLE3D</span> <span class="o">|</span>
		 <span class="n">RADEON_ISYNC_ANY3D_IDLE2D</span> <span class="o">|</span>
		 <span class="n">RADEON_ISYNC_WAIT_IDLEGUI</span> <span class="o">|</span>
		 <span class="n">RADEON_ISYNC_CPSCRATCH_IDLEGUI</span><span class="p">);</span>
	<span class="n">RADEON_PURGE_CACHE</span><span class="p">();</span>
	<span class="n">RADEON_PURGE_ZCACHE</span><span class="p">();</span>
	<span class="n">RADEON_WAIT_UNTIL_IDLE</span><span class="p">();</span>
	<span class="n">ADVANCE_RING</span><span class="p">();</span>
	<span class="n">COMMIT_RING</span><span class="p">();</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">track_flush</span> <span class="o">|=</span> <span class="n">RADEON_FLUSH_EMITED</span> <span class="o">|</span> <span class="n">RADEON_PURGE_EMITED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset the Command Processor.  This will not flush any pending</span>
<span class="cm"> * commands, so you must wait for the CP command stream to complete</span>
<span class="cm"> * before calling this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_do_cp_reset</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cur_read_ptr</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cur_read_ptr</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_WPTR</span><span class="p">,</span> <span class="n">cur_read_ptr</span><span class="p">);</span>
	<span class="n">SET_RING_HEAD</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">cur_read_ptr</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">cur_read_ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Stop the Command Processor.  This will not flush any pending</span>
<span class="cm"> * commands, so you must flush the command stream and wait for the CP</span>
<span class="cm"> * to go idle before calling this routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_do_cp_stop</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RING_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* finish the pending CP_RESYNC token */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_R420</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BEGIN_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CP_PACKET0</span><span class="p">(</span><span class="n">R300_RB3D_DSTCACHE_CTLSTAT</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">R300_RB3D_DC_FINISH</span><span class="p">);</span>
		<span class="n">ADVANCE_RING</span><span class="p">();</span>
		<span class="n">COMMIT_RING</span><span class="p">();</span>
		<span class="n">radeon_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_CSQ_CNTL</span><span class="p">,</span> <span class="n">RADEON_CSQ_PRIDIS_INDDIS</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset the engine.  This will stop the CP if it is running.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_engine_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clock_cntl_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mclk_cntl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rbbm_soft_reset</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">radeon_do_pixcache_flush</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CHIP_RV410</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* may need something similar for newer chips */</span>
		<span class="n">clock_cntl_index</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CLOCK_CNTL_INDEX</span><span class="p">);</span>
		<span class="n">mclk_cntl</span> <span class="o">=</span> <span class="n">RADEON_READ_PLL</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RADEON_MCLK_CNTL</span><span class="p">);</span>

		<span class="n">RADEON_WRITE_PLL</span><span class="p">(</span><span class="n">RADEON_MCLK_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">mclk_cntl</span> <span class="o">|</span>
						    <span class="n">RADEON_FORCEON_MCLKA</span> <span class="o">|</span>
						    <span class="n">RADEON_FORCEON_MCLKB</span> <span class="o">|</span>
						    <span class="n">RADEON_FORCEON_YCLKA</span> <span class="o">|</span>
						    <span class="n">RADEON_FORCEON_YCLKB</span> <span class="o">|</span>
						    <span class="n">RADEON_FORCEON_MC</span> <span class="o">|</span>
						    <span class="n">RADEON_FORCEON_AIC</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">rbbm_soft_reset</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_SOFT_RESET</span><span class="p">);</span>

	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_RBBM_SOFT_RESET</span><span class="p">,</span> <span class="p">(</span><span class="n">rbbm_soft_reset</span> <span class="o">|</span>
					      <span class="n">RADEON_SOFT_RESET_CP</span> <span class="o">|</span>
					      <span class="n">RADEON_SOFT_RESET_HI</span> <span class="o">|</span>
					      <span class="n">RADEON_SOFT_RESET_SE</span> <span class="o">|</span>
					      <span class="n">RADEON_SOFT_RESET_RE</span> <span class="o">|</span>
					      <span class="n">RADEON_SOFT_RESET_PP</span> <span class="o">|</span>
					      <span class="n">RADEON_SOFT_RESET_E2</span> <span class="o">|</span>
					      <span class="n">RADEON_SOFT_RESET_RB</span><span class="p">));</span>
	<span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_SOFT_RESET</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_RBBM_SOFT_RESET</span><span class="p">,</span> <span class="p">(</span><span class="n">rbbm_soft_reset</span> <span class="o">&amp;</span>
					      <span class="o">~</span><span class="p">(</span><span class="n">RADEON_SOFT_RESET_CP</span> <span class="o">|</span>
						<span class="n">RADEON_SOFT_RESET_HI</span> <span class="o">|</span>
						<span class="n">RADEON_SOFT_RESET_SE</span> <span class="o">|</span>
						<span class="n">RADEON_SOFT_RESET_RE</span> <span class="o">|</span>
						<span class="n">RADEON_SOFT_RESET_PP</span> <span class="o">|</span>
						<span class="n">RADEON_SOFT_RESET_E2</span> <span class="o">|</span>
						<span class="n">RADEON_SOFT_RESET_RB</span><span class="p">)));</span>
	<span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_RBBM_SOFT_RESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CHIP_RV410</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE_PLL</span><span class="p">(</span><span class="n">RADEON_MCLK_CNTL</span><span class="p">,</span> <span class="n">mclk_cntl</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CLOCK_CNTL_INDEX</span><span class="p">,</span> <span class="n">clock_cntl_index</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_RBBM_SOFT_RESET</span><span class="p">,</span> <span class="n">rbbm_soft_reset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup the raster pipes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R300</span><span class="p">)</span>
	    <span class="n">radeon_init_pipes</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Reset the CP ring */</span>
	<span class="n">radeon_do_cp_reset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/* The CP is no longer running after an engine reset */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset any pending vertex, indirect buffers */</span>
	<span class="n">radeon_freelist_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_cp_init_ring_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				       <span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ring_start</span><span class="p">,</span> <span class="n">cur_read_ptr</span><span class="p">;</span>

	<span class="cm">/* Initialize the memory controller. With new memory map, the fb location</span>
<span class="cm">	 * is not changed, it should have been properly initialized already. Part</span>
<span class="cm">	 * of the problem is that the code below is bogus, assuming the GART is</span>
<span class="cm">	 * always appended to the fb which is not necessarily the case</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">new_memmap</span><span class="p">)</span>
		<span class="n">radeon_write_fb_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
			     <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span>
			     <span class="o">|</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_write_agp_base</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

		<span class="n">radeon_write_agp_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
			     <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)));</span>

		<span class="n">ring_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">offset</span>
			      <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span>
			      <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">ring_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">offset</span>
			      <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="k">virtual</span>
			      <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>

	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_BASE</span><span class="p">,</span> <span class="n">ring_start</span><span class="p">);</span>

	<span class="cm">/* Set the write pointer delay */</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_WPTR_DELAY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Initialize the ring buffer&#39;s read and write pointers */</span>
	<span class="n">cur_read_ptr</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_WPTR</span><span class="p">,</span> <span class="n">cur_read_ptr</span><span class="p">);</span>
	<span class="n">SET_RING_HEAD</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">cur_read_ptr</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">cur_read_ptr</span><span class="p">;</span>

<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR_ADDR</span><span class="p">,</span>
			     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">offset</span>
			     <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR_ADDR</span><span class="p">,</span>
			     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">offset</span>
			     <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="k">virtual</span><span class="p">)</span>
			     <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set ring buffer size */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_CNTL</span><span class="p">,</span>
		     <span class="n">RADEON_BUF_SWAP_32BIT</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">fetch_size_l2ow</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rptr_update_l2qw</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size_l2qw</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_CNTL</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">fetch_size_l2ow</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rptr_update_l2qw</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size_l2qw</span><span class="p">);</span>
<span class="cp">#endif</span>


	<span class="cm">/* Initialize the scratch register pointer.  This will cause</span>
<span class="cm">	 * the scratch register values to be written out to memory</span>
<span class="cm">	 * whenever they are updated.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We simply put this behind the ring read pointer, this works</span>
<span class="cm">	 * with PCI GART as well as (whatever kind of) AGP GART</span>
<span class="cm">	 */</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SCRATCH_ADDR</span><span class="p">,</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR_ADDR</span><span class="p">)</span>
		     <span class="o">+</span> <span class="n">RADEON_SCRATCH_REG_OFFSET</span><span class="p">);</span>

	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SCRATCH_UMSK</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="n">radeon_enable_bm</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">radeon_write_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RADEON_SCRATCHOFF</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_LAST_FRAME_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">radeon_write_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RADEON_SCRATCHOFF</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_LAST_DISPATCH_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">radeon_write_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RADEON_SCRATCHOFF</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_LAST_CLEAR_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* reset sarea copies of these */</span>
	<span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_dispatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_clear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radeon_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/* Sync everything up */</span>
	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_ISYNC_CNTL</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">RADEON_ISYNC_ANY2D_IDLE3D</span> <span class="o">|</span>
		      <span class="n">RADEON_ISYNC_ANY3D_IDLE2D</span> <span class="o">|</span>
		      <span class="n">RADEON_ISYNC_WAIT_IDLEGUI</span> <span class="o">|</span>
		      <span class="n">RADEON_ISYNC_CPSCRATCH_IDLEGUI</span><span class="p">));</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_test_writeback</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Start with assuming that writeback doesn&#39;t work */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Writeback doesn&#39;t seem to work everywhere, test it here and possibly</span>
<span class="cm">	 * enable it if it appears to work</span>
<span class="cm">	 */</span>
	<span class="n">radeon_write_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RADEON_SCRATCHOFF</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SCRATCH_REG1</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">radeon_read_ring_rptr</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RADEON_SCRATCHOFF</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0xdeadbeef</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;writeback test succeeded in %d usecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;writeback test failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_no_wb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;writeback forced off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">writeback_works</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable writeback to avoid unnecessary bus master transfer */</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_CNTL</span><span class="p">,</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_CNTL</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">RADEON_RB_NO_UPDATE</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SCRATCH_UMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enable or disable IGP GART on the chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_set_igpgart</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;programming igp gart %08X %08lX %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS480_MC_MISC_CNTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">))</span>
			<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_MC_MISC_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">RS480_GART_INDEX_REG_EN</span> <span class="o">|</span>
							     <span class="n">RS690_BLOCK_GFX_D3_EN</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_MC_MISC_CNTL</span><span class="p">,</span> <span class="n">RS480_GART_INDEX_REG_EN</span><span class="p">);</span>

		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_AGP_ADDRESS_SPACE_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">RS480_GART_EN</span> <span class="o">|</span>
							       <span class="n">RS480_VA_SIZE_32MB</span><span class="p">));</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS480_GART_FEATURE_ID</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_GART_FEATURE_ID</span><span class="p">,</span> <span class="p">(</span><span class="n">RS480_HANG_EN</span> <span class="o">|</span>
							<span class="n">RS480_TLB_ENABLE</span> <span class="o">|</span>
							<span class="n">RS480_GTW_LAC_EN</span> <span class="o">|</span>
							<span class="n">RS480_1LEVEL_GART</span><span class="p">));</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_GART_BASE</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS480_AGP_MODE_CNTL</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_AGP_MODE_CNTL</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RS480_REQ_TYPE_SNOOP_SHIFT</span><span class="p">)</span> <span class="o">|</span>
						      <span class="n">RS480_REQ_TYPE_SNOOP_DIS</span><span class="p">));</span>

		<span class="n">radeon_write_agp_base</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span> <span class="o">=</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>

		<span class="n">radeon_write_agp_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS480_AGP_ADDRESS_SPACE_SIZE</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_AGP_ADDRESS_SPACE_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">RS480_GART_EN</span> <span class="o">|</span>
							       <span class="n">RS480_VA_SIZE_32MB</span><span class="p">));</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS480_GART_CACHE_CNTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">RS480_GART_CACHE_INVALIDATE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_GART_CACHE_CNTRL</span><span class="p">,</span>
				<span class="n">RS480_GART_CACHE_INVALIDATE</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS480_GART_CACHE_CNTRL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">RS480_GART_CACHE_INVALIDATE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_GART_CACHE_CNTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS480_AGP_ADDRESS_SPACE_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enable or disable IGP GART on the chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rs600_set_igpgart</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;programming igp gart %08X %08lX %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">,</span>
			 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">);</span>

		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">RS600_EFFECTIVE_L2_CACHE_SIZE</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
						    <span class="n">RS600_EFFECTIVE_L2_QUEUE_SIZE</span><span class="p">(</span><span class="mi">6</span><span class="p">)));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">19</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CLIENT0_CNTL</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					<span class="p">(</span><span class="n">RS600_ENABLE_TRANSLATION_MODE_OVERRIDE</span> <span class="o">|</span>
					 <span class="n">RS600_SYSTEM_ACCESS_MODE_IN_SYS</span> <span class="o">|</span>
					 <span class="n">RS600_SYSTEM_APERTURE_UNMAPPED_ACCESS_PASSTHROUGH</span> <span class="o">|</span>
					 <span class="n">RS600_EFFECTIVE_L1_CACHE_SIZE</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">RS600_ENABLE_FRAGMENT_PROCESSING</span> <span class="o">|</span>
					 <span class="n">RS600_EFFECTIVE_L1_QUEUE_SIZE</span><span class="p">(</span><span class="mi">3</span><span class="p">)));</span>

		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CONTEXT0_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">RS600_ENABLE_PAGE_TABLE</span> <span class="o">|</span>
							     <span class="n">RS600_PAGE_TABLE_TYPE_FLAT</span><span class="p">));</span>

		<span class="cm">/* disable all other contexts */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CONTEXT0_CNTL</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* setup the page table aperture */</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CONTEXT0_FLAT_BASE_ADDR</span><span class="p">,</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CONTEXT0_FLAT_START_ADDR</span><span class="p">,</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CONTEXT0_FLAT_END_ADDR</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CONTEXT0_DEFAULT_READ_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* setup the system aperture */</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_SYSTEM_APERTURE_LOW_ADDR</span><span class="p">,</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_SYSTEM_APERTURE_HIGH_ADDR</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="cm">/* enable page tables */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_PT0_CNTL</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CNTL</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">RS600_ENABLE_PT</span><span class="p">));</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_CNTL1</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_CNTL1</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="n">RS600_ENABLE_PAGE_TABLES</span><span class="p">));</span>

		<span class="cm">/* invalidate the cache */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_PT0_CNTL</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RS600_INVALIDATE_ALL_L1_TLBS</span> <span class="o">|</span> <span class="n">RS600_INVALIDATE_L2_CACHE</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CNTL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_PT0_CNTL</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">|=</span> <span class="n">RS600_INVALIDATE_ALL_L1_TLBS</span> <span class="o">|</span> <span class="n">RS600_INVALIDATE_L2_CACHE</span><span class="p">;</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CNTL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_PT0_CNTL</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RS600_INVALIDATE_ALL_L1_TLBS</span> <span class="o">|</span> <span class="n">RS600_INVALIDATE_L2_CACHE</span><span class="p">);</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CNTL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_PT0_CNTL</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_PT0_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">IGP_READ_MCIND</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RS600_MC_CNTL1</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RS600_ENABLE_PAGE_TABLES</span><span class="p">;</span>
		<span class="n">IGP_WRITE_MCIND</span><span class="p">(</span><span class="n">RS600_MC_CNTL1</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_set_pciegart</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">RADEON_READ_PCIE</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">RADEON_PCIE_TX_GART_CNTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;programming pcie %08X %08lX %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">);</span>
		<span class="n">RADEON_WRITE_PCIE</span><span class="p">(</span><span class="n">RADEON_PCIE_TX_DISCARD_RD_ADDR_LO</span><span class="p">,</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
		<span class="n">RADEON_WRITE_PCIE</span><span class="p">(</span><span class="n">RADEON_PCIE_TX_GART_BASE</span><span class="p">,</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">);</span>
		<span class="n">RADEON_WRITE_PCIE</span><span class="p">(</span><span class="n">RADEON_PCIE_TX_GART_START_LO</span><span class="p">,</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
		<span class="n">RADEON_WRITE_PCIE</span><span class="p">(</span><span class="n">RADEON_PCIE_TX_GART_END_LO</span><span class="p">,</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">+</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">radeon_write_agp_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mh">0xffffffc0</span><span class="p">);</span> <span class="cm">/* ?? */</span>

		<span class="n">RADEON_WRITE_PCIE</span><span class="p">(</span><span class="n">RADEON_PCIE_TX_GART_CNTL</span><span class="p">,</span>
				  <span class="n">RADEON_PCIE_TX_GART_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE_PCIE</span><span class="p">(</span><span class="n">RADEON_PCIE_TX_GART_CNTL</span><span class="p">,</span>
				  <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RADEON_PCIE_TX_GART_EN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Enable or disable PCI GART on the chip */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_set_pcigart</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS690</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS740</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGPGART</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">radeon_set_igpgart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rs600_set_igpgart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_PCIE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_set_pciegart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_AIC_CNTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AIC_CNTL</span><span class="p">,</span>
			     <span class="n">tmp</span> <span class="o">|</span> <span class="n">RADEON_PCIGART_TRANSLATE_EN</span><span class="p">);</span>

		<span class="cm">/* set PCI GART page-table base address</span>
<span class="cm">		 */</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AIC_PT_BASE</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">);</span>

		<span class="cm">/* set address range for PCI address translate</span>
<span class="cm">		 */</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AIC_LO_ADDR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AIC_HI_ADDR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span>
			     <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Turn off AGP aperture -- is this required for PCI GART?</span>
<span class="cm">		 */</span>
		<span class="n">radeon_write_agp_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mh">0xffffffc0</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AGP_COMMAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* clear AGP_COMMAND */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_AIC_CNTL</span><span class="p">,</span>
			     <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RADEON_PCIGART_TRANSLATE_EN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_setup_pcigart_surface</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_ati_pcigart_info</span> <span class="o">*</span><span class="n">gart_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_virt_surface</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_MAX_SURFACES</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">file_priv</span> <span class="o">||</span>
		    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">file_priv</span> <span class="o">==</span> <span class="n">PCIGART_FILE_PRIV</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">vp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">virt_surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">radeon_surface</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">surfaces</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">surface_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">lower</span> <span class="o">=</span> <span class="n">gart_info</span><span class="o">-&gt;</span><span class="n">bus_addr</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">upper</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">lower</span> <span class="o">+</span> <span class="n">gart_info</span><span class="o">-&gt;</span><span class="n">table_size</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">PCIGART_FILE_PRIV</span><span class="p">;</span>

		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">lower</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">upper</span> <span class="o">=</span> <span class="n">vp</span><span class="o">-&gt;</span><span class="n">upper</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_INFO</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_LOWER_BOUND</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">lower</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_UPPER_BOUND</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">upper</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_init_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">drm_radeon_init_t</span> <span class="o">*</span><span class="n">init</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* if we require new memory map but we don&#39;t have it fail */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_NEW_MEMMAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">new_memmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Cannot initialise DRM on this card</span><span class="se">\n</span><span class="s">This card requires a new X.org DDX for 3D</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">is_pci</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;Forcing AGP card to PCI mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RADEON_IS_AGP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_IS_AGP</span> <span class="o">|</span> <span class="n">RADEON_IS_PCI</span> <span class="o">|</span> <span class="n">RADEON_IS_PCIE</span><span class="p">))</span>
		   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">is_pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;Restoring AGP flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_IS_AGP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;PCI GART memory not allocated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span> <span class="o">&gt;</span> <span class="n">RADEON_MAX_USEC_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;TIMEOUT problem!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable vblank on CRTC1 for older X servers</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">vblank_crtc</span> <span class="o">=</span> <span class="n">DRM_RADEON_VBLANK_CRTC1</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_INIT_R200_CP</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">=</span> <span class="n">UCODE_R200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RADEON_INIT_R300_CP</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">=</span> <span class="n">UCODE_R300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">=</span> <span class="n">UCODE_R100</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">do_boxes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_mode</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">cp_mode</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t support anything other than bus-mastering ring mode,</span>
<span class="cm">	 * but the ring can be in either AGP or PCI space for the ring</span>
<span class="cm">	 * read pointer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">cp_mode</span> <span class="o">!=</span> <span class="n">RADEON_CSQ_PRIBM_INDDIS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">cp_mode</span> <span class="o">!=</span> <span class="n">RADEON_CSQ_PRIBM_INDBM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;BAD cp_mode (%x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">cp_mode</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">fb_bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">color_fmt</span> <span class="o">=</span> <span class="n">RADEON_COLOR_FORMAT_RGB565</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
	<span class="nl">default:</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">color_fmt</span> <span class="o">=</span> <span class="n">RADEON_COLOR_FORMAT_ARGB8888</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">front_pitch</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">back_pitch</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">depth_bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_fmt</span> <span class="o">=</span> <span class="n">RADEON_DEPTH_FORMAT_16BIT_INT_Z</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
	<span class="nl">default:</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_fmt</span> <span class="o">=</span> <span class="n">RADEON_DEPTH_FORMAT_24BIT_INT_Z</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">depth_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">depth_pitch</span><span class="p">;</span>

	<span class="cm">/* Hardware state for depth clears.  Remove this if/when we no</span>
<span class="cm">	 * longer clear the depth buffer with a 3D rectangle.  Hard-code</span>
<span class="cm">	 * all values to prevent unwanted 3D state from slipping through</span>
<span class="cm">	 * and screwing with the clear operation.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_clear</span><span class="p">.</span><span class="n">rb3d_cntl</span> <span class="o">=</span> <span class="p">(</span><span class="n">RADEON_PLANE_MASK_ENABLE</span> <span class="o">|</span>
					   <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">color_fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
					   <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">microcode_version</span> <span class="o">==</span>
					    <span class="n">UCODE_R100</span> <span class="o">?</span> <span class="n">RADEON_ZBLOCK16</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_clear</span><span class="p">.</span><span class="n">rb3d_zstencilcntl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_fmt</span> <span class="o">|</span>
	     <span class="n">RADEON_Z_TEST_ALWAYS</span> <span class="o">|</span>
	     <span class="n">RADEON_STENCIL_TEST_ALWAYS</span> <span class="o">|</span>
	     <span class="n">RADEON_STENCIL_S_FAIL_REPLACE</span> <span class="o">|</span>
	     <span class="n">RADEON_STENCIL_ZPASS_REPLACE</span> <span class="o">|</span>
	     <span class="n">RADEON_STENCIL_ZFAIL_REPLACE</span> <span class="o">|</span> <span class="n">RADEON_Z_WRITE_ENABLE</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_clear</span><span class="p">.</span><span class="n">se_cntl</span> <span class="o">=</span> <span class="p">(</span><span class="n">RADEON_FFACE_CULL_CW</span> <span class="o">|</span>
					 <span class="n">RADEON_BFACE_SOLID</span> <span class="o">|</span>
					 <span class="n">RADEON_FFACE_SOLID</span> <span class="o">|</span>
					 <span class="n">RADEON_FLAT_SHADE_VTX_LAST</span> <span class="o">|</span>
					 <span class="n">RADEON_DIFFUSE_SHADE_FLAT</span> <span class="o">|</span>
					 <span class="n">RADEON_ALPHA_SHADE_FLAT</span> <span class="o">|</span>
					 <span class="n">RADEON_SPECULAR_SHADE_FLAT</span> <span class="o">|</span>
					 <span class="n">RADEON_FOG_SHADE_FLAT</span> <span class="o">|</span>
					 <span class="n">RADEON_VTX_PIX_CENTER_OGL</span> <span class="o">|</span>
					 <span class="n">RADEON_ROUND_MODE_TRUNC</span> <span class="o">|</span>
					 <span class="n">RADEON_ROUND_PREC_8TH_PIX</span><span class="p">);</span>


	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_rptr_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">buffers_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">buffers_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_textures_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">gart_textures_offset</span><span class="p">;</span>

	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span> <span class="o">=</span> <span class="n">drm_getsarea</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;could not find sarea!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span> <span class="o">=</span> <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;could not find cp ring region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span> <span class="o">=</span> <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_rptr_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;could not find ring read pointer!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_token</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">buffers_offset</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span> <span class="o">=</span> <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">buffers_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;could not find dma buffer region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">gart_textures_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_textures</span> <span class="o">=</span>
		    <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">gart_textures_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_textures</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;could not find GART texture region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_core_ioremap_wc</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">drm_core_ioremap_wc</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">drm_core_ioremap_wc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;could not find ioremap agp regions!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;dev_priv-&gt;cp_ring-&gt;handle %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;dev_priv-&gt;ring_rptr-&gt;handle %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;dev-&gt;agp_buffer_map-&gt;handle %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">=</span> <span class="p">(</span><span class="n">radeon_read_fb_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_size</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">radeon_read_fb_location</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff0000u</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch_offset</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span>
					  <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch_offset</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
				       <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span>
					 <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_pitch_offset</span> <span class="o">=</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_pitch</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_offset</span>
					  <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">));</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">;</span>

	<span class="cm">/* New let&#39;s set the memory map ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">new_memmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Setting GART location based on new memory map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* If using AGP, try to locate the AGP aperture at the same</span>
<span class="cm">		 * location in the card and on the bus, though we have to</span>
<span class="cm">		 * align it down.</span>
<span class="cm">		 */</span>
<span class="cp">#if __OS_HAS_AGP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="cm">/* Check if valid */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">base</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">&amp;&amp;</span>
			    <span class="n">base</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Can&#39;t use AGP base @0x%08lx, won&#39;t fit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
				<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* If not or if AGP is at 0 (Macs), try to put it elsewhere */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">base</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">base</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffffful</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">base</span><span class="p">)</span>
				<span class="n">base</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span>
					<span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">=</span> <span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0xffc00000u</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">!=</span> <span class="n">base</span><span class="p">)</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;GART aligned down from 0x%08x to 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">base</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Setting GART location based on old memory map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span> <span class="o">+</span>
			<span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CONFIG_APER_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">offset</span>
						 <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span>
						 <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
	<span class="k">else</span>
<span class="cp">#endif</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">offset</span>
					<span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sg</span><span class="o">-&gt;</span><span class="k">virtual</span>
					<span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;dev_priv-&gt;gart_size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_size</span><span class="p">);</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;dev_priv-&gt;gart_vm_start 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_vm_start</span><span class="p">);</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;dev_priv-&gt;gart_buffers_offset 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_buffers_offset</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="o">-&gt;</span><span class="n">handle</span>
			      <span class="o">+</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_size</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size_l2qw</span> <span class="o">=</span> <span class="n">drm_order</span><span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rptr_update</span> <span class="o">=</span> <span class="cm">/* init-&gt;rptr_update */</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">rptr_update_l2qw</span> <span class="o">=</span> <span class="n">drm_order</span><span class="p">(</span> <span class="cm">/* init-&gt;rptr_update */</span> <span class="mi">4096</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">fetch_size</span> <span class="o">=</span> <span class="cm">/* init-&gt;fetch_size */</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">fetch_size_l2ow</span> <span class="o">=</span> <span class="n">drm_order</span><span class="p">(</span> <span class="cm">/* init-&gt;fetch_size */</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">high_mark</span> <span class="o">=</span> <span class="n">RADEON_RING_HIGH_MARK</span><span class="p">;</span>

<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn off PCI GART */</span>
		<span class="n">radeon_set_pcigart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">sctrl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">table_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
		<span class="cm">/* if we have an offset set from userspace */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pcigart_offset_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">resource_size_t</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pcigart_offset</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_location</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">mapping</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span>
			    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pcigart_offset</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_aper_offset</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">mapping</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span>
			    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">table_size</span><span class="p">;</span>

			<span class="n">drm_core_ioremap_wc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">mapping</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>
			    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">mapping</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_PCIE</span><span class="p">)</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">gart_reg_if</span> <span class="o">=</span> <span class="n">DRM_ATI_GART_PCIE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">gart_reg_if</span> <span class="o">=</span> <span class="n">DRM_ATI_GART_PCI</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">gart_table_location</span> <span class="o">=</span>
			    <span class="n">DRM_ATI_GART_FB</span><span class="p">;</span>

			<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;Setting phys_pci_gart to %p %08lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pcigart_offset</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_IGPGART</span><span class="p">)</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">gart_reg_if</span> <span class="o">=</span> <span class="n">DRM_ATI_GART_IGP</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">gart_reg_if</span> <span class="o">=</span> <span class="n">DRM_ATI_GART_PCI</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">gart_table_location</span> <span class="o">=</span>
			    <span class="n">DRM_ATI_GART_MAIN</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_PCIE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;Cannot use PCI Express without GART in FB memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">sctrl</span> <span class="o">=</span> <span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_SURFACE_CNTL</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">r600_page_table_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_ati_pcigart_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">);</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE_CNTL</span><span class="p">,</span> <span class="n">sctrl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to init PCI GART!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_setup_pcigart_surface</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to setup GART surface!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
				<span class="n">r600_page_table_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">drm_ati_pcigart_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">);</span>
			<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Turn on PCI GART */</span>
		<span class="n">radeon_set_pcigart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">radeon_cp_init_microcode</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to load firmware!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">radeon_cp_load_microcode</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">radeon_cp_init_ring_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">radeon_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">radeon_test_writeback</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_cleanup_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Make sure interrupts are disabled here because the uninstall ioctl</span>
<span class="cm">	 * may not have been called from userspace and after dev_private</span>
<span class="cm">	 * is freed, it&#39;s too late.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_enabled</span><span class="p">)</span>
		<span class="n">drm_irq_uninstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_core_ioremapfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_core_ioremapfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring_rptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_core_ioremapfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">bus_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Turn off PCI GART */</span>
			<span class="n">radeon_set_pcigart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIP_RS600</span><span class="p">)</span>
				<span class="n">r600_page_table_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_ati_pcigart_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">))</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to cleanup PCI GART!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">gart_table_location</span> <span class="o">==</span> <span class="n">DRM_ATI_GART_FB</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">drm_core_ioremapfree</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">mapping</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* only clear to the start of flags */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">drm_radeon_private_t</span><span class="p">,</span> <span class="n">flags</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This code will reinit the Radeon CP hardware after a resume from disc.</span>
<span class="cm"> * AFAIK, it would be very difficult to pickle the state at suspend time, so</span>
<span class="cm"> * here we make sure that all Radeon hardware initialisation is re-done without</span>
<span class="cm"> * affecting running applications.</span>
<span class="cm"> *</span>
<span class="cm"> * Charl P. Botha &lt;http://cpbotha.net&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_do_resume_cp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;Starting radeon_do_resume_cp()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn off PCI GART */</span>
		<span class="n">radeon_set_pcigart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="cm">/* Turn on PCI GART */</span>
		<span class="n">radeon_set_pcigart</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">radeon_cp_load_microcode</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">radeon_cp_init_ring_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">have_z_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">radeon_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">radeon_irq_set_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RADEON_SW_INT_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;radeon_do_resume_cp() complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_cp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_init_t</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">==</span> <span class="n">RADEON_INIT_R300_CP</span><span class="p">)</span>
		<span class="n">r300_init_reg_flags</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RADEON_INIT_CP</span>:
	<span class="k">case</span> <span class="n">RADEON_INIT_R200_CP</span>:
	<span class="k">case</span> <span class="n">RADEON_INIT_R300_CP</span>:
		<span class="k">return</span> <span class="n">radeon_do_init_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">RADEON_INIT_R600_CP</span>:
		<span class="k">return</span> <span class="n">r600_do_init_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">RADEON_CLEANUP_CP</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r600_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_cp_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;while CP running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_mode</span> <span class="o">==</span> <span class="n">RADEON_CSQ_PRIDIS_INDDIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;called with bogus CP mode (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">r600_do_cp_start</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">radeon_do_cp_start</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Stop the CP.  The engine must have been idled before calling this</span>
<span class="cm"> * routine.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_cp_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_cp_stop_t</span> <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Flush any pending CP commands.  This ensures any outstanding</span>
<span class="cm">	 * commands are exectuted by the engine before we turn it off.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_do_cp_flush</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we fail to make the engine go idle, we return an error</span>
<span class="cm">	 * code so that the DRM ioctl wrapper can try again.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stop</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">r600_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finally, we can turn off the CP.  If the engine isn&#39;t idle,</span>
<span class="cm">	 * we will get some dropped triangles as they won&#39;t be fully</span>
<span class="cm">	 * rendered before the CP is shut down.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">r600_do_cp_stop</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">radeon_do_cp_stop</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/* Reset the engine */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">r600_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">radeon_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_do_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Stop the cp */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">r600_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;radeon_do_cp_idle %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#ifdef __linux__</span>
					<span class="n">schedule</span><span class="p">();</span>
<span class="cp">#else</span>
					<span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="n">PZERO</span><span class="p">,</span> <span class="s">&quot;rdnrel&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;radeon_do_cp_idle %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#ifdef __linux__</span>
					<span class="n">schedule</span><span class="p">();</span>
<span class="cp">#else</span>
					<span class="n">tsleep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="n">PZERO</span><span class="p">,</span> <span class="s">&quot;rdnrel&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r600_do_cp_stop</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
				<span class="n">r600_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">radeon_do_cp_stop</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
				<span class="n">radeon_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable *all* interrupts */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span>	<span class="cm">/* remove this after permanent addmaps */</span>
				<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_GEN_INT_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* remove all surfaces */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_MAX_SURFACES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_INFO</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_LOWER_BOUND</span> <span class="o">+</span>
						     <span class="mi">16</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_SURFACE0_UPPER_BOUND</span> <span class="o">+</span>
						     <span class="mi">16</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Free memory heap structures */</span>
		<span class="n">radeon_mem_takedown</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_heap</span><span class="p">));</span>
		<span class="n">radeon_mem_takedown</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_heap</span><span class="p">));</span>

		<span class="cm">/* deallocate kernel resources */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
			<span class="n">r600_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">radeon_do_cleanup_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">me_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pfp_fw</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pfp_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Just reset the CP ring.  Called as part of an X Server engine reset.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_cp_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;called before init done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="n">r600_do_cp_reset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">radeon_do_cp_reset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/* The CP is no longer running after an engine reset */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cp_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_cp_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r600_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">radeon_do_cp_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Added by Charl P. Botha to call radeon_do_resume_cp().</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_cp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r600_do_resume_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">radeon_do_resume_cp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_engine_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r600_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">radeon_do_engine_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Fullscreen mode</span>
<span class="cm"> */</span>

<span class="cm">/* KW: Deprecated to say the least:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_fullscreen</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Freelist management</span>
<span class="cm"> */</span>

<span class="cm">/* Original comment: FIXME: ROTATE_BUFS is a hack to cycle through</span>
<span class="cm"> *   bufs until freelist code is used.  Note this hides a problem with</span>
<span class="cm"> *   the scratch register * (used to keep track of last buffer</span>
<span class="cm"> *   completed) being written to before * the last buffer has actually</span>
<span class="cm"> *   completed rendering.</span>
<span class="cm"> *</span>
<span class="cm"> * KW:  It&#39;s also a good way to find free buffers quickly.</span>
<span class="cm"> *</span>
<span class="cm"> * KW: Ideally this loop wouldn&#39;t exist, and freelist_get wouldn&#39;t</span>
<span class="cm"> * sleep.  However, bugs in older versions of radeon_accel.c mean that</span>
<span class="cm"> * we essentially have to do this, else old clients will break.</span>
<span class="cm"> *</span>
<span class="cm"> * However, it does leave open a potential deadlock where all the</span>
<span class="cm"> * buffers are held by other clients, which can&#39;t release them because</span>
<span class="cm"> * they can&#39;t get the lock.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="nf">radeon_freelist_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_radeon_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_buf</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">done_age</span> <span class="o">=</span> <span class="n">GET_SCRATCH</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;done_age = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">done_age</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">start</span><span class="p">];</span>
			<span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&amp;&amp;</span>
						       <span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">&lt;=</span>
						       <span class="n">done_age</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">requested_bufs</span><span class="o">++</span><span class="p">;</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
				<span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">freelist_loops</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_freelist_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">drm_radeon_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * CP command submission</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">radeon_wait_ring</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_ring_buffer_t</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_head</span> <span class="o">=</span> <span class="n">GET_RING_HEAD</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">head</span> <span class="o">=</span> <span class="n">GET_RING_HEAD</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">-</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">+=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">boxes</span> <span class="o">|=</span> <span class="n">RADEON_BOX_WAIT_IDLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="n">last_head</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">last_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>

		<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: This return value is ignored in the BEGIN_RING macro! */</span>
<span class="cp">#if RADEON_FIFO_DEBUG</span>
	<span class="n">radeon_status</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_cp_get_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_dma</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">granted_count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">radeon_freelist_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>	<span class="cm">/* NOTE: broken client */</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">d</span><span class="o">-&gt;</span><span class="n">granted_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_cp_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_dma</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="cm">/* Please don&#39;t send us buffers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">send_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Process %d trying to send %d buffers via drmDMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">send_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We&#39;ll send you buffers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span> <span class="o">&gt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Process %d trying to get %d buffers (of %d max)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">granted_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">radeon_cp_get_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_driver_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">drm_radeon_private_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_R100</span>:
	<span class="k">case</span> <span class="n">CHIP_RV200</span>:
	<span class="k">case</span> <span class="n">CHIP_R200</span>:
	<span class="k">case</span> <span class="n">CHIP_R300</span>:
	<span class="k">case</span> <span class="n">CHIP_R350</span>:
	<span class="k">case</span> <span class="n">CHIP_R420</span>:
	<span class="k">case</span> <span class="n">CHIP_R423</span>:
	<span class="k">case</span> <span class="n">CHIP_RV410</span>:
	<span class="k">case</span> <span class="n">CHIP_RV515</span>:
	<span class="k">case</span> <span class="n">CHIP_R520</span>:
	<span class="k">case</span> <span class="n">CHIP_RV570</span>:
	<span class="k">case</span> <span class="n">CHIP_R580</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_HAS_HIERZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* all other chips have no hierarchical z buffer */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_pci_device_is_agp</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_IS_AGP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_IS_PCIE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RADEON_IS_PCI</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			 <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">_DRM_REGISTERS</span><span class="p">,</span>
			 <span class="n">_DRM_READ_ONLY</span> <span class="o">|</span> <span class="n">_DRM_DRIVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_vblank_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_driver_unload</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;%s card detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;AGP&quot;</span> <span class="o">:</span> <span class="p">(((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_PCIE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PCIE&quot;</span> <span class="o">:</span> <span class="s">&quot;PCI&quot;</span><span class="p">))));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_master_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sareapage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">master_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">master_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* prebuild the SAREA */</span>
	<span class="n">sareapage</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">SAREA_MAX</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sareapage</span><span class="p">,</span> <span class="n">_DRM_SHM</span><span class="p">,</span> <span class="n">_DRM_CONTAINS_LOCK</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;SAREA setup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">master_priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_sarea</span><span class="p">);</span>
	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_master_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_radeon_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span> <span class="o">&amp;&amp;</span>
	    <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pfCurrentPage</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">radeon_cp_dispatch_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>

	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="p">)</span>
		<span class="n">drm_rmmap_locked</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">master_priv</span><span class="p">);</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create mappings for registers and framebuffer so userland doesn&#39;t necessarily</span>
<span class="cm"> * have to find them.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">radeon_driver_firstopen</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gart_info</span><span class="p">.</span><span class="n">table_size</span> <span class="o">=</span> <span class="n">RADEON_PCIGART_TABLE_SIZE</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_aper_offset</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_aper_offset</span><span class="p">,</span>
			 <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">_DRM_FRAME_BUFFER</span><span class="p">,</span>
			 <span class="n">_DRM_WRITE_COMBINING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_driver_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">drm_rmmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_commit_ring</span><span class="p">(</span><span class="n">drm_radeon_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tail_aligned</span><span class="p">;</span>

	<span class="cm">/* check if the ring is padded out to 16-dword alignment */</span>

	<span class="n">tail_aligned</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RADEON_RING_ALIGN</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tail_aligned</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">num_p2</span> <span class="o">=</span> <span class="n">RADEON_RING_ALIGN</span> <span class="o">-</span> <span class="n">tail_aligned</span><span class="p">;</span>

		<span class="n">ring</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
		<span class="cm">/* pad with some CP_PACKET2 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_p2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ring</span><span class="p">[</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CP_PACKET2</span><span class="p">();</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">space</span> <span class="o">-=</span> <span class="n">num_p2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span> <span class="o">&amp;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail_mask</span><span class="p">;</span>

	<span class="n">DRM_MEMORYBARRIER</span><span class="p">();</span>
	<span class="n">GET_RING_HEAD</span><span class="p">(</span> <span class="n">dev_priv</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_FAMILY_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">R600_CP_RB_WPTR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span><span class="p">);</span>
		<span class="cm">/* read from PCI bus to ensure correct posting */</span>
		<span class="n">RADEON_READ</span><span class="p">(</span><span class="n">R600_CP_RB_RPTR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RADEON_WRITE</span><span class="p">(</span><span class="n">RADEON_CP_RB_WPTR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">.</span><span class="n">tail</span><span class="p">);</span>
		<span class="cm">/* read from PCI bus to ensure correct posting */</span>
		<span class="n">RADEON_READ</span><span class="p">(</span><span class="n">RADEON_CP_RB_RPTR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
