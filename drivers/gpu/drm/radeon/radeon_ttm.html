<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › radeon_ttm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radeon_ttm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2009 Jerome Glisse.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the</span>
<span class="cm"> * &quot;Software&quot;), to deal in the Software without restriction, including</span>
<span class="cm"> * without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="cm"> * distribute, sub license, and/or sell copies of the Software, and to</span>
<span class="cm"> * permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,</span>
<span class="cm"> * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<span class="cm"> * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<span class="cm"> * USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the</span>
<span class="cm"> * next paragraph) shall be included in all copies or substantial portions</span>
<span class="cm"> * of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Jerome Glisse &lt;glisse@freedesktop.org&gt;</span>
<span class="cm"> *    Thomas Hellstrom &lt;thomas-at-tungstengraphics-dot-com&gt;</span>
<span class="cm"> *    Dave Airlie</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;ttm/ttm_bo_api.h&gt;</span>
<span class="cp">#include &lt;ttm/ttm_bo_driver.h&gt;</span>
<span class="cp">#include &lt;ttm/ttm_placement.h&gt;</span>
<span class="cp">#include &lt;ttm/ttm_module.h&gt;</span>
<span class="cp">#include &lt;ttm/ttm_page_alloc.h&gt;</span>
<span class="cp">#include &lt;drm/drmP.h&gt;</span>
<span class="cp">#include &lt;drm/radeon_drm.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;radeon_reg.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>

<span class="cp">#define DRM_FILE_PAGE_OFFSET (0x100000000ULL &gt;&gt; PAGE_SHIFT)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">radeon_ttm_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="nf">radeon_get_rdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_bo_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_mman</span> <span class="o">*</span><span class="n">mman</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">mman</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_mman</span><span class="p">,</span> <span class="n">bdev</span><span class="p">);</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">mman</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_device</span><span class="p">,</span> <span class="n">mman</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rdev</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Global memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_mem_global_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_global_reference</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ttm_mem_global_init</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_ttm_mem_global_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_global_reference</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ttm_mem_global_release</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_global_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_global_reference</span> <span class="o">*</span><span class="n">global_ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_referenced</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">global_ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_ref</span><span class="p">;</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">global_type</span> <span class="o">=</span> <span class="n">DRM_GLOBAL_TTM_MEM</span><span class="p">;</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_mem_global</span><span class="p">);</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_mem_global_init</span><span class="p">;</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_mem_global_release</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">drm_global_item_ref</span><span class="p">(</span><span class="n">global_ref</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed setting up TTM memory accounting &quot;</span>
			  <span class="s">&quot;subsystem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bo_global_ref</span><span class="p">.</span><span class="n">mem_glob</span> <span class="o">=</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_ref</span><span class="p">.</span><span class="n">object</span><span class="p">;</span>
	<span class="n">global_ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bo_global_ref</span><span class="p">.</span><span class="n">ref</span><span class="p">;</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">global_type</span> <span class="o">=</span> <span class="n">DRM_GLOBAL_TTM_BO</span><span class="p">;</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_bo_global</span><span class="p">);</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ttm_bo_global_init</span><span class="p">;</span>
	<span class="n">global_ref</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ttm_bo_global_release</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">drm_global_item_ref</span><span class="p">(</span><span class="n">global_ref</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed setting up TTM BO subsystem.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drm_global_item_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_ref</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_referenced</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_ttm_global_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_referenced</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_global_item_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bo_global_ref</span><span class="p">.</span><span class="n">ref</span><span class="p">);</span>
		<span class="n">drm_global_item_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_ref</span><span class="p">);</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">mem_global_referenced</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_invalidate_caches</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_bo_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_init_mem_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_bo_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">type</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ttm_mem_type_manager</span> <span class="o">*</span><span class="n">man</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TTM_PL_SYSTEM</span>:
		<span class="cm">/* System memory */</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTM_MEMTYPE_FLAG_MAPPABLE</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">available_caching</span> <span class="o">=</span> <span class="n">TTM_PL_MASK_CACHING</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">default_caching</span> <span class="o">=</span> <span class="n">TTM_PL_FLAG_CACHED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTM_PL_TT</span>:
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ttm_bo_manager_func</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">gpu_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">gtt_start</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">available_caching</span> <span class="o">=</span> <span class="n">TTM_PL_MASK_CACHING</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">default_caching</span> <span class="o">=</span> <span class="n">TTM_PL_FLAG_CACHED</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTM_MEMTYPE_FLAG_MAPPABLE</span> <span class="o">|</span> <span class="n">TTM_MEMTYPE_FLAG_CMA</span><span class="p">;</span>
<span class="cp">#if __OS_HAS_AGP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">drm_core_has_AGP</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;AGP is not enabled for memory type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">type</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">cant_use_aperture</span><span class="p">)</span>
				<span class="n">man</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTM_MEMTYPE_FLAG_MAPPABLE</span><span class="p">;</span>
			<span class="n">man</span><span class="o">-&gt;</span><span class="n">available_caching</span> <span class="o">=</span> <span class="n">TTM_PL_FLAG_UNCACHED</span> <span class="o">|</span>
						 <span class="n">TTM_PL_FLAG_WC</span><span class="p">;</span>
			<span class="n">man</span><span class="o">-&gt;</span><span class="n">default_caching</span> <span class="o">=</span> <span class="n">TTM_PL_FLAG_WC</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTM_PL_VRAM</span>:
		<span class="cm">/* &quot;On-card&quot; video ram */</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ttm_bo_manager_func</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">gpu_offset</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">vram_start</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTM_MEMTYPE_FLAG_FIXED</span> <span class="o">|</span>
			     <span class="n">TTM_MEMTYPE_FLAG_MAPPABLE</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">available_caching</span> <span class="o">=</span> <span class="n">TTM_PL_FLAG_UNCACHED</span> <span class="o">|</span> <span class="n">TTM_PL_FLAG_WC</span><span class="p">;</span>
		<span class="n">man</span><span class="o">-&gt;</span><span class="n">default_caching</span> <span class="o">=</span> <span class="n">TTM_PL_FLAG_WC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unsupported memory type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_evict_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ttm_placement</span> <span class="o">*</span><span class="n">placement</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">rbo</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">placements</span> <span class="o">=</span> <span class="n">TTM_PL_MASK_CACHING</span> <span class="o">|</span> <span class="n">TTM_PL_FLAG_SYSTEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">radeon_ttm_bo_is_radeon_bo</span><span class="p">(</span><span class="n">bo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">placement</span><span class="o">-&gt;</span><span class="n">fpfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">placement</span><span class="o">-&gt;</span><span class="n">lpfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">placement</span><span class="o">-&gt;</span><span class="n">placement</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">placements</span><span class="p">;</span>
		<span class="n">placement</span><span class="o">-&gt;</span><span class="n">busy_placement</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">placements</span><span class="p">;</span>
		<span class="n">placement</span><span class="o">-&gt;</span><span class="n">num_placement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">placement</span><span class="o">-&gt;</span><span class="n">num_busy_placement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rbo</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_bo</span><span class="p">,</span> <span class="n">tbo</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">.</span><span class="n">mem_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TTM_PL_VRAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rbo</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RADEON_RING_TYPE_GFX_INDEX</span><span class="p">].</span><span class="n">ready</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
			<span class="n">radeon_ttm_placement_from_domain</span><span class="p">(</span><span class="n">rbo</span><span class="p">,</span> <span class="n">RADEON_GEM_DOMAIN_CPU</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">radeon_ttm_placement_from_domain</span><span class="p">(</span><span class="n">rbo</span><span class="p">,</span> <span class="n">RADEON_GEM_DOMAIN_GTT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTM_PL_TT</span>:
	<span class="nl">default:</span>
		<span class="n">radeon_ttm_placement_from_domain</span><span class="p">(</span><span class="n">rbo</span><span class="p">,</span> <span class="n">RADEON_GEM_DOMAIN_CPU</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">placement</span> <span class="o">=</span> <span class="n">rbo</span><span class="o">-&gt;</span><span class="n">placement</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_verify_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_move_null</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">old_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mm_node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="o">*</span><span class="n">old_mem</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">;</span>
	<span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">mm_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_move_blit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">evict</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_wait_gpu</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">old_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">old_start</span><span class="p">,</span> <span class="n">new_start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_fence</span> <span class="o">*</span><span class="n">fence</span><span class="p">,</span> <span class="o">*</span><span class="n">old_fence</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_semaphore</span> <span class="o">*</span><span class="n">sem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_fence_create</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fence</span><span class="p">,</span> <span class="n">radeon_copy_ring_index</span><span class="p">(</span><span class="n">rdev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">old_start</span> <span class="o">=</span> <span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">new_start</span> <span class="o">=</span> <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TTM_PL_VRAM</span>:
		<span class="n">old_start</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">vram_start</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTM_PL_TT</span>:
		<span class="n">old_start</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">gtt_start</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown placement %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span><span class="p">);</span>
		<span class="n">radeon_fence_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TTM_PL_VRAM</span>:
		<span class="n">new_start</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">vram_start</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTM_PL_TT</span>:
		<span class="n">new_start</span> <span class="o">+=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">gtt_start</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown placement %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span><span class="p">);</span>
		<span class="n">radeon_fence_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">radeon_copy_ring_index</span><span class="p">(</span><span class="n">rdev</span><span class="p">)].</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Trying to move memory with ring turned off.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">radeon_fence_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">%</span> <span class="n">RADEON_GPU_PAGE_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* sync other rings */</span>
	<span class="n">old_fence</span> <span class="o">=</span> <span class="n">bo</span><span class="o">-&gt;</span><span class="n">sync_obj</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_fence</span> <span class="o">&amp;&amp;</span> <span class="n">old_fence</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">!=</span> <span class="n">fence</span><span class="o">-&gt;</span><span class="n">ring</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">radeon_fence_signaled</span><span class="p">(</span><span class="n">old_fence</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">sync_to_ring</span><span class="p">[</span><span class="n">RADEON_NUM_RINGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
		<span class="n">sync_to_ring</span><span class="p">[</span><span class="n">old_fence</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_semaphore_create</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_fence_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_semaphore_sync_rings</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sem</span><span class="p">,</span>
						<span class="n">sync_to_ring</span><span class="p">,</span> <span class="n">fence</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_semaphore_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">radeon_fence_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_copy</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">old_start</span><span class="p">,</span> <span class="n">new_start</span><span class="p">,</span>
			<span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">*</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">/</span> <span class="n">RADEON_GPU_PAGE_SIZE</span><span class="p">),</span> <span class="cm">/* GPU pages */</span>
			<span class="n">fence</span><span class="p">);</span>
	<span class="cm">/* FIXME: handle copy error */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_move_accel_cleanup</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fence</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				      <span class="n">evict</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">);</span>
	<span class="n">radeon_semaphore_free</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">sem</span><span class="p">,</span> <span class="n">fence</span><span class="p">);</span>
	<span class="n">radeon_fence_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_move_vram_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">evict</span><span class="p">,</span> <span class="n">bool</span> <span class="n">interruptible</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_wait_gpu</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">old_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="n">tmp_mem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">placements</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_placement</span> <span class="n">placement</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">tmp_mem</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">;</span>
	<span class="n">tmp_mem</span><span class="p">.</span><span class="n">mm_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">fpfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">lpfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">num_placement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">placement</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">placements</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">num_busy_placement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">busy_placement</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">placements</span><span class="p">;</span>
	<span class="n">placements</span> <span class="o">=</span> <span class="n">TTM_PL_MASK_CACHING</span> <span class="o">|</span> <span class="n">TTM_PL_FLAG_TT</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_mem_space</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">placement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_mem</span><span class="p">,</span>
			     <span class="n">interruptible</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_tt_set_placement_caching</span><span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">,</span> <span class="n">tmp_mem</span><span class="p">.</span><span class="n">placement</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_tt_bind</span><span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_move_blit</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_mem</span><span class="p">,</span> <span class="n">old_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_move_ttm</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">);</span>
<span class="nl">out_cleanup:</span>
	<span class="n">ttm_bo_mem_put</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_mem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_move_ram_vram</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">evict</span><span class="p">,</span> <span class="n">bool</span> <span class="n">interruptible</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_wait_gpu</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">old_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="n">tmp_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_placement</span> <span class="n">placement</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">placements</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">tmp_mem</span> <span class="o">=</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">;</span>
	<span class="n">tmp_mem</span><span class="p">.</span><span class="n">mm_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">fpfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">lpfn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">num_placement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">placement</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">placements</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">num_busy_placement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">placement</span><span class="p">.</span><span class="n">busy_placement</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">placements</span><span class="p">;</span>
	<span class="n">placements</span> <span class="o">=</span> <span class="n">TTM_PL_MASK_CACHING</span> <span class="o">|</span> <span class="n">TTM_PL_FLAG_TT</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_mem_space</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">placement</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_mem</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_move_ttm</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_move_blit</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">,</span> <span class="n">old_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_cleanup</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_cleanup:</span>
	<span class="n">ttm_bo_mem_put</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_mem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_bo_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">evict</span><span class="p">,</span> <span class="n">bool</span> <span class="n">interruptible</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">bool</span> <span class="n">no_wait_gpu</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">new_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">old_mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_SYSTEM</span> <span class="o">&amp;&amp;</span> <span class="n">bo</span><span class="o">-&gt;</span><span class="n">ttm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_move_null</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_TT</span> <span class="o">&amp;&amp;</span>
	     <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_SYSTEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_SYSTEM</span> <span class="o">&amp;&amp;</span>
	     <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_TT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* bind is enough */</span>
		<span class="n">radeon_move_null</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">radeon_copy_ring_index</span><span class="p">(</span><span class="n">rdev</span><span class="p">)].</span><span class="n">ready</span> <span class="o">||</span>
	    <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">asic</span><span class="o">-&gt;</span><span class="n">copy</span><span class="p">.</span><span class="n">copy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use memcpy */</span>
		<span class="k">goto</span> <span class="n">memcpy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_VRAM</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_move_vram_ram</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">evict</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">,</span>
					<span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">old_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_SYSTEM</span> <span class="o">&amp;&amp;</span>
		   <span class="n">new_mem</span><span class="o">-&gt;</span><span class="n">mem_type</span> <span class="o">==</span> <span class="n">TTM_PL_VRAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_move_ram_vram</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">evict</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">,</span>
					    <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_move_blit</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">evict</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">,</span> <span class="n">old_mem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">memcpy:</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_move_memcpy</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">evict</span><span class="p">,</span> <span class="n">no_wait_reserve</span><span class="p">,</span> <span class="n">no_wait_gpu</span><span class="p">,</span> <span class="n">new_mem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_io_mem_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_bo_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ttm_mem_type_manager</span> <span class="o">*</span><span class="n">man</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">man</span><span class="p">[</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">mem_type</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>

	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">is_iomem</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">man</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TTM_MEMTYPE_FLAG_MAPPABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">mem_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TTM_PL_SYSTEM</span>:
		<span class="cm">/* system memory */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTM_PL_TT</span>:
<span class="cp">#if __OS_HAS_AGP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* RADEON_IS_AGP is set only if AGP is active */</span>
			<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
			<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">agp_base</span><span class="p">;</span>
			<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">is_iomem</span> <span class="o">=</span> <span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">cant_use_aperture</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TTM_PL_VRAM</span>:
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="cm">/* check if it&#39;s visible */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">visible_vram_size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">aper_base</span><span class="p">;</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">is_iomem</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#ifdef __alpha__</span>
		<span class="cm">/*</span>
<span class="cm">		 * Alpha: use bus.addr to hold the ioremap() return,</span>
<span class="cm">		 * so we can modify bus.base below.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">placement</span> <span class="o">&amp;</span> <span class="n">TTM_PL_FLAG_WC</span><span class="p">)</span>
			<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>
				<span class="n">ioremap_wc</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
					   <span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span>
				<span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
						<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Alpha: Use just the bus offset plus</span>
<span class="cm">		 * the hose/domain memory base for bus.base.</span>
<span class="cm">		 * It then can be used to build PTEs for VRAM</span>
<span class="cm">		 * access, as done in ttm_bo_vm_fault().</span>
<span class="cm">		 */</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">base</span> <span class="o">&amp;</span> <span class="mh">0x0ffffffffUL</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">hose</span><span class="o">-&gt;</span><span class="n">dense_mem_base</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_ttm_io_mem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_bo_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_sync_obj_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">sync_obj</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sync_arg</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">lazy</span><span class="p">,</span> <span class="n">bool</span> <span class="n">interruptible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">radeon_fence_wait</span><span class="p">((</span><span class="k">struct</span> <span class="n">radeon_fence</span> <span class="o">*</span><span class="p">)</span><span class="n">sync_obj</span><span class="p">,</span> <span class="n">interruptible</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_sync_obj_flush</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">sync_obj</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sync_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_sync_obj_unref</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">sync_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">radeon_fence_unref</span><span class="p">((</span><span class="k">struct</span> <span class="n">radeon_fence</span> <span class="o">**</span><span class="p">)</span><span class="n">sync_obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">radeon_sync_obj_ref</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">sync_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">radeon_fence_ref</span><span class="p">((</span><span class="k">struct</span> <span class="n">radeon_fence</span> <span class="o">*</span><span class="p">)</span><span class="n">sync_obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">radeon_sync_obj_signaled</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">sync_obj</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sync_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">radeon_fence_signaled</span><span class="p">((</span><span class="k">struct</span> <span class="n">radeon_fence</span> <span class="o">*</span><span class="p">)</span><span class="n">sync_obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TTM backend functions.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">radeon_ttm_tt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ttm_dma_tt</span>		<span class="n">ttm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span>		<span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="n">u64</span>				<span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_backend_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_tt</span> <span class="o">*</span><span class="n">ttm</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ttm_mem_reg</span> <span class="o">*</span><span class="n">bo_mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_ttm_tt</span> <span class="o">*</span><span class="n">gtt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">ttm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">bo_mem</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;nothing to bind %lu pages for mreg %p back %p!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">bo_mem</span><span class="p">,</span> <span class="n">ttm</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_gart_bind</span><span class="p">(</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			     <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to bind %lu pages at 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_backend_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_tt</span> <span class="o">*</span><span class="n">ttm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_ttm_tt</span> <span class="o">*</span><span class="n">gtt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ttm</span><span class="p">;</span>

	<span class="n">radeon_gart_unbind</span><span class="p">(</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_ttm_backend_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_tt</span> <span class="o">*</span><span class="n">ttm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_ttm_tt</span> <span class="o">*</span><span class="n">gtt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ttm</span><span class="p">;</span>

	<span class="n">ttm_dma_tt_fini</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gtt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ttm_backend_func</span> <span class="n">radeon_backend_func</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_backend_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_backend_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_backend_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ttm_tt</span> <span class="o">*</span><span class="nf">radeon_ttm_tt_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_bo_device</span> <span class="o">*</span><span class="n">bdev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">page_flags</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">dummy_read_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_ttm_tt</span> <span class="o">*</span><span class="n">gtt</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bdev</span><span class="p">);</span>
<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ttm_agp_tt_create</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">bridge</span><span class="p">,</span>
					 <span class="n">size</span><span class="p">,</span> <span class="n">page_flags</span><span class="p">,</span> <span class="n">dummy_read_page</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">gtt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_ttm_tt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gtt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">ttm</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_backend_func</span><span class="p">;</span>
	<span class="n">gtt</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ttm_dma_tt_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">,</span> <span class="n">bdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">page_flags</span><span class="p">,</span> <span class="n">dummy_read_page</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gtt</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">ttm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_tt_populate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_tt</span> <span class="o">*</span><span class="n">ttm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_ttm_tt</span> <span class="o">*</span><span class="n">gtt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ttm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">slave</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ttm</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">&amp;</span> <span class="n">TTM_PAGE_FLAG_SG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ttm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">tt_unpopulated</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_prime_sg_to_page_addr_arrays</span><span class="p">(</span><span class="n">ttm</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span>
						 <span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">,</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">);</span>
		<span class="n">ttm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">tt_unbound</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">ttm</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ttm_agp_tt_populate</span><span class="p">(</span><span class="n">ttm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SWIOTLB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swiotlb_nr_tbl</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ttm_dma_populate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_pool_populate</span><span class="p">(</span><span class="n">ttm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_map_page</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						       <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
						       <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
				<span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ttm_pool_unpopulate</span><span class="p">(</span><span class="n">ttm</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">radeon_ttm_tt_unpopulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ttm_tt</span> <span class="o">*</span><span class="n">ttm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_ttm_tt</span> <span class="o">*</span><span class="n">gtt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ttm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">slave</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ttm</span><span class="o">-&gt;</span><span class="n">page_flags</span> <span class="o">&amp;</span> <span class="n">TTM_PAGE_FLAG_SG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">ttm</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
<span class="cp">#if __OS_HAS_AGP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RADEON_IS_AGP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ttm_agp_tt_unpopulate</span><span class="p">(</span><span class="n">ttm</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SWIOTLB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swiotlb_nr_tbl</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ttm_dma_unpopulate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">,</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ttm</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">gtt</span><span class="o">-&gt;</span><span class="n">ttm</span><span class="p">.</span><span class="n">dma_address</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ttm_pool_unpopulate</span><span class="p">(</span><span class="n">ttm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ttm_bo_driver</span> <span class="n">radeon_bo_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ttm_tt_create</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_tt_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ttm_tt_populate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_tt_populate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ttm_tt_unpopulate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_tt_unpopulate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">invalidate_caches</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_invalidate_caches</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_mem_type</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_init_mem_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">evict_flags</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_evict_flags</span><span class="p">,</span>
	<span class="p">.</span><span class="n">move</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_bo_move</span><span class="p">,</span>
	<span class="p">.</span><span class="n">verify_access</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_verify_access</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_obj_signaled</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_sync_obj_signaled</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_obj_wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_sync_obj_wait</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_obj_flush</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_sync_obj_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_obj_unref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_sync_obj_unref</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sync_obj_ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_sync_obj_ref</span><span class="p">,</span>
	<span class="p">.</span><span class="n">move_notify</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_bo_move_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fault_reserve_notify</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_bo_fault_reserve_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">io_mem_reserve</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_io_mem_reserve</span><span class="p">,</span>
	<span class="p">.</span><span class="n">io_mem_free</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_io_mem_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">radeon_ttm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_ttm_global_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* No others user of address space so set it to 0 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_device_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">,</span>
			       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bo_global_ref</span><span class="p">.</span><span class="n">ref</span><span class="p">.</span><span class="n">object</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">radeon_bo_driver</span><span class="p">,</span> <span class="n">DRM_FILE_PAGE_OFFSET</span><span class="p">,</span>
			       <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">need_dma32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed initializing buffer object driver(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_init_mm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">,</span> <span class="n">TTM_PL_VRAM</span><span class="p">,</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">real_vram_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed initializing VRAM heap.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_create</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
			     <span class="n">RADEON_GEM_DOMAIN_VRAM</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_reserve</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_pin</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">,</span> <span class="n">RADEON_GEM_DOMAIN_VRAM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">radeon_bo_unreserve</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radeon_bo_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;radeon: %uM of VRAM memory ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">real_vram_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_init_mm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">,</span> <span class="n">TTM_PL_TT</span><span class="p">,</span>
				<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">gtt_size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed initializing GTT heap.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;radeon: %uM of GTT memory ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">gtt_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">.</span><span class="n">dev_mapping</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">.</span><span class="n">dev_mapping</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="o">-&gt;</span><span class="n">dev_mapping</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_ttm_debugfs_init</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to init debugfs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">radeon_ttm_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_bo_reserve</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">radeon_bo_unpin</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">);</span>
			<span class="n">radeon_bo_unreserve</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">radeon_bo_unref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">stollen_vga_memory</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ttm_bo_clean_mm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">,</span> <span class="n">TTM_PL_VRAM</span><span class="p">);</span>
	<span class="n">ttm_bo_clean_mm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">,</span> <span class="n">TTM_PL_TT</span><span class="p">);</span>
	<span class="n">ttm_bo_device_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">radeon_gart_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">radeon_ttm_global_fini</span><span class="p">(</span><span class="n">rdev</span><span class="p">);</span>
	<span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;radeon: ttm finalized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this should only be called at bootup or when userspace</span>
<span class="cm"> * isn&#39;t running */</span>
<span class="kt">void</span> <span class="nf">radeon_ttm_set_active_vram_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ttm_mem_type_manager</span> <span class="o">*</span><span class="n">man</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">man</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">.</span><span class="n">man</span><span class="p">[</span><span class="n">TTM_PL_VRAM</span><span class="p">];</span>
	<span class="cm">/* this just adjusts TTM size idea, which sets lpfn to the correct value */</span>
	<span class="n">man</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">radeon_ttm_vm_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="o">*</span><span class="n">ttm_vm_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_fault</span> <span class="o">*</span><span class="n">vmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="n">bo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">bo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ttm_buffer_object</span> <span class="o">*</span><span class="p">)</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>	
	<span class="k">if</span> <span class="p">(</span><span class="n">bo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VM_FAULT_NOPAGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">radeon_get_rdev</span><span class="p">(</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vram_mutex</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_vm_ops</span><span class="o">-&gt;</span><span class="n">fault</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vmf</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">vram_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">radeon_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;</span> <span class="n">DRM_FILE_PAGE_OFFSET</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">drm_mmap</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">file_priv</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">rdev</span> <span class="o">=</span> <span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ttm_bo_mmap</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ttm_vm_ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ttm_vm_ops</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span><span class="p">;</span>
		<span class="n">radeon_ttm_vm_ops</span> <span class="o">=</span> <span class="o">*</span><span class="n">ttm_vm_ops</span><span class="p">;</span>
		<span class="n">radeon_ttm_vm_ops</span><span class="p">.</span><span class="n">fault</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_fault</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_ttm_vm_ops</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define RADEON_DEBUGFS_MEM_TYPES 2</span>

<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_mm_dump_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mm</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_mm</span> <span class="o">*</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">info_ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ttm_bo_global</span> <span class="o">*</span><span class="n">glob</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">.</span><span class="n">glob</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">glob</span><span class="o">-&gt;</span><span class="n">lru_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mm_dump_table</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">mm</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">glob</span><span class="o">-&gt;</span><span class="n">lru_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radeon_ttm_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_info_list</span> <span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">RADEON_DEBUGFS_MEM_TYPES</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">RADEON_DEBUGFS_MEM_TYPES</span><span class="o">+</span><span class="mi">2</span><span class="p">][</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RADEON_DEBUGFS_MEM_TYPES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;radeon_vram_mm&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;radeon_gtt_mm&quot;</span><span class="p">);</span>
		<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">show</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radeon_mm_dump_table</span><span class="p">;</span>
		<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">driver_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">.</span><span class="n">man</span><span class="p">[</span><span class="n">TTM_PL_VRAM</span><span class="p">].</span><span class="n">priv</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">-&gt;</span><span class="n">mman</span><span class="p">.</span><span class="n">bdev</span><span class="p">.</span><span class="n">man</span><span class="p">[</span><span class="n">TTM_PL_TT</span><span class="p">].</span><span class="n">priv</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* Add ttm page pool to debugfs */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;ttm_page_pool&quot;</span><span class="p">);</span>
	<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">show</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ttm_page_alloc_debugfs</span><span class="p">;</span>
	<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">driver_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SWIOTLB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">swiotlb_nr_tbl</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;ttm_dma_page_pool&quot;</span><span class="p">);</span>
		<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">radeon_mem_types_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">show</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ttm_dma_page_alloc_debugfs</span><span class="p">;</span>
		<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">driver_features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">radeon_mem_types_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">radeon_debugfs_add_files</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">radeon_mem_types_list</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
