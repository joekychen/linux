<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › r600_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>r600_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2008 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright 2008 Red Hat Inc.</span>
<span class="cm"> * Copyright 2009 Jerome Glisse.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Dave Airlie</span>
<span class="cm"> *          Alex Deucher</span>
<span class="cm"> *          Jerome Glisse</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>
<span class="cp">#include &quot;r600d.h&quot;</span>
<span class="cp">#include &quot;r600_reg_safe.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">r600_cs_packet_next_reloc_mm</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">**</span><span class="n">cs_reloc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">r600_cs_packet_next_reloc_nomm</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">**</span><span class="n">cs_reloc</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">next_reloc_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_cs_reloc</span><span class="o">**</span><span class="p">);</span>
<span class="k">static</span> <span class="n">next_reloc_t</span> <span class="n">r600_cs_packet_next_reloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r600_cs_packet_next_reloc_mm</span><span class="p">;</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">r600_cs_legacy_get_tiling_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">npipes</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">nbanks</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">group_size</span><span class="p">);</span>


<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="p">{</span>
	<span class="cm">/* configuration we miror so that we use same code btw kms/ums */</span>
	<span class="n">u32</span>			<span class="n">group_size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">nbanks</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">npipes</span><span class="p">;</span>
	<span class="cm">/* value we track */</span>
	<span class="n">u32</span>			<span class="n">sq_config</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">nsamples</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cb_color_base_last</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u64</span>			<span class="n">cb_color_bo_mc</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">cb_color_frag_bo</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="cm">/* unused */</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">cb_color_tile_bo</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">cb_color_info</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_view</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_size_idx</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">cb_target_mask</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cb_shader_mask</span><span class="p">;</span>  <span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">cb_color_size</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_en</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_buffer_en</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u64</span>			<span class="n">vgt_strmout_bo_mc</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_size</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">db_depth_control</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_depth_info</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_depth_size_idx</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_depth_view</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_depth_size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">db_bo</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">db_bo_mc</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">sx_misc_kill_all_prims</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">cb_dirty</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">db_dirty</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">streamout_dirty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">htile_bo</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">htile_offset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">htile_surface</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FMT_8_BIT(fmt, vc)   [fmt] = { 1, 1, 1, vc, CHIP_R600 }</span>
<span class="cp">#define FMT_16_BIT(fmt, vc)  [fmt] = { 1, 1, 2, vc, CHIP_R600 }</span>
<span class="cp">#define FMT_24_BIT(fmt)      [fmt] = { 1, 1, 4,  0, CHIP_R600 }</span>
<span class="cp">#define FMT_32_BIT(fmt, vc)  [fmt] = { 1, 1, 4, vc, CHIP_R600 }</span>
<span class="cp">#define FMT_48_BIT(fmt)      [fmt] = { 1, 1, 8,  0, CHIP_R600 }</span>
<span class="cp">#define FMT_64_BIT(fmt, vc)  [fmt] = { 1, 1, 8, vc, CHIP_R600 }</span>
<span class="cp">#define FMT_96_BIT(fmt)      [fmt] = { 1, 1, 12, 0, CHIP_R600 }</span>
<span class="cp">#define FMT_128_BIT(fmt, vc) [fmt] = { 1, 1, 16,vc, CHIP_R600 }</span>

<span class="k">struct</span> <span class="n">gpu_formats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">blockwidth</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">blockheight</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">valid_color</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">radeon_family</span> <span class="n">min_family</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gpu_formats</span> <span class="n">color_formats_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 8 bit */</span>
	<span class="n">FMT_8_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_8_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_4_4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_8_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_3_3_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_8_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* 16-bit */</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_16</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_16_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_8_8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_5_6_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_6_5_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_1_5_5_5</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_4_4_4_4</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_16_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_5_5_5_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="cm">/* 24-bit */</span>
	<span class="n">FMT_24_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_8_8_8</span><span class="p">),</span>

	<span class="cm">/* 32-bit */</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_32_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_16_16</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_16_16_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_8_24</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_8_24_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_24_8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_24_8_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_10_11_11</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_10_11_11_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_11_11_10</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_11_11_10_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_2_10_10_10</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_8_8_8_8</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_10_10_10_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_5_9_9_9_SHAREDEXP</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_32_AS_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">FMT_32_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_32_AS_8_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>

	<span class="cm">/* 48-bit */</span>
	<span class="n">FMT_48_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_16_16_16</span><span class="p">),</span>
	<span class="n">FMT_48_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_16_16_16_FLOAT</span><span class="p">),</span>

	<span class="cm">/* 64-bit */</span>
	<span class="n">FMT_64_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_X24_8_32_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_64_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_32_32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_64_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_32_32_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_64_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_16_16_16_16</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_64_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_16_16_16_16_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="n">FMT_96_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_32_32_32</span><span class="p">),</span>
	<span class="n">FMT_96_BIT</span><span class="p">(</span><span class="n">V_038004_FMT_32_32_32_FLOAT</span><span class="p">),</span>

	<span class="cm">/* 128-bit */</span>
	<span class="n">FMT_128_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_32_32_32_32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">FMT_128_BIT</span><span class="p">(</span><span class="n">V_038004_COLOR_32_32_32_32_FLOAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

	<span class="p">[</span><span class="n">V_038004_FMT_GB_GR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BG_RG</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="cm">/* block compressed formats */</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BC1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BC2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BC3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BC4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BC5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BC6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CHIP_CEDAR</span><span class="p">},</span> <span class="cm">/* Evergreen-only */</span>
	<span class="p">[</span><span class="n">V_038004_FMT_BC7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CHIP_CEDAR</span><span class="p">},</span> <span class="cm">/* Evergreen-only */</span>

	<span class="cm">/* The other Evergreen formats */</span>
	<span class="p">[</span><span class="n">V_038004_FMT_32_AS_32_32_32_32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CHIP_CEDAR</span><span class="p">},</span>
<span class="p">};</span>

<span class="n">bool</span> <span class="nf">r600_fmt_is_valid_color</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">color_formats_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">color_formats_table</span><span class="p">[</span><span class="n">format</span><span class="p">].</span><span class="n">valid_color</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">r600_fmt_is_valid_texture</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">,</span> <span class="k">enum</span> <span class="n">radeon_family</span> <span class="n">family</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">color_formats_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">color_formats_table</span><span class="p">[</span><span class="n">format</span><span class="p">].</span><span class="n">min_family</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">color_formats_table</span><span class="p">[</span><span class="n">format</span><span class="p">].</span><span class="n">blockwidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">r600_fmt_get_blocksize</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">color_formats_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">color_formats_table</span><span class="p">[</span><span class="n">format</span><span class="p">].</span><span class="n">blocksize</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">r600_fmt_get_nblocksx</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">,</span> <span class="n">u32</span> <span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">color_formats_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bw</span> <span class="o">=</span> <span class="n">color_formats_table</span><span class="p">[</span><span class="n">format</span><span class="p">].</span><span class="n">blockwidth</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bw</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">bw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bw</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">r600_fmt_get_nblocksy</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">color_formats_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bh</span> <span class="o">=</span> <span class="n">color_formats_table</span><span class="p">[</span><span class="n">format</span><span class="p">].</span><span class="n">blockheight</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="n">bh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">bh</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">array_mode_checker</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">array_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">group_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nbanks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">npipes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nsamples</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blocksize</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* returns alignment in pixels for pitch/height/depth and bytes for base */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_get_array_mode_alignment</span><span class="p">(</span><span class="k">struct</span> <span class="n">array_mode_checker</span> <span class="o">*</span><span class="n">values</span><span class="p">,</span>
						<span class="n">u32</span> <span class="o">*</span><span class="n">pitch_align</span><span class="p">,</span>
						<span class="n">u32</span> <span class="o">*</span><span class="n">height_align</span><span class="p">,</span>
						<span class="n">u32</span> <span class="o">*</span><span class="n">depth_align</span><span class="p">,</span>
						<span class="n">u64</span> <span class="o">*</span><span class="n">base_align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tile_width</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tile_height</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macro_tile_width</span> <span class="o">=</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macro_tile_height</span> <span class="o">=</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tile_bytes</span> <span class="o">=</span> <span class="n">tile_width</span> <span class="o">*</span> <span class="n">tile_height</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macro_tile_bytes</span> <span class="o">=</span> <span class="n">macro_tile_width</span> <span class="o">*</span> <span class="n">macro_tile_height</span> <span class="o">*</span> <span class="n">tile_bytes</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">values</span><span class="o">-&gt;</span><span class="n">array_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ARRAY_LINEAR_GENERAL</span>:
		<span class="cm">/* technically tile_width/_height for pitch/height */</span>
		<span class="o">*</span><span class="n">pitch_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* tile_width */</span>
		<span class="o">*</span><span class="n">height_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* tile_height */</span>
		<span class="o">*</span><span class="n">depth_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">base_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ARRAY_LINEAR_ALIGNED</span>:
		<span class="o">*</span><span class="n">pitch_align</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">values</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">/</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">blocksize</span><span class="p">));</span>
		<span class="o">*</span><span class="n">height_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">depth_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">base_align</span> <span class="o">=</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ARRAY_1D_TILED_THIN1</span>:
		<span class="o">*</span><span class="n">pitch_align</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">tile_width</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">values</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">/</span>
					 <span class="p">(</span><span class="n">tile_height</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">)));</span>
		<span class="o">*</span><span class="n">height_align</span> <span class="o">=</span> <span class="n">tile_height</span><span class="p">;</span>
		<span class="o">*</span><span class="n">depth_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">base_align</span> <span class="o">=</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ARRAY_2D_TILED_THIN1</span>:
		<span class="o">*</span><span class="n">pitch_align</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">macro_tile_width</span> <span class="o">*</span> <span class="n">tile_width</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">values</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">)</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">values</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">nsamples</span> <span class="o">*</span> <span class="n">tile_width</span><span class="p">)));</span>
		<span class="o">*</span><span class="n">height_align</span> <span class="o">=</span> <span class="n">macro_tile_height</span> <span class="o">*</span> <span class="n">tile_height</span><span class="p">;</span>
		<span class="o">*</span><span class="n">depth_align</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">base_align</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">macro_tile_bytes</span><span class="p">,</span>
				  <span class="p">(</span><span class="o">*</span><span class="n">pitch_align</span><span class="p">)</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">blocksize</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">height_align</span><span class="p">)</span> <span class="o">*</span> <span class="n">values</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r600_cs_track_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* assume DX9 mode */</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">sq_config</span> <span class="o">=</span> <span class="n">DX9_CONSTS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_base_last</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_size_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_mc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_shader_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo_mc</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="cm">/* assume the biggest format and that htile is enabled */</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_view</span> <span class="o">=</span> <span class="mh">0xFFFFC000</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_offset</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_mc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">sx_misc_kill_all_prims</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_track_validate_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">slice_tile_max</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height</span><span class="p">,</span> <span class="n">height_align</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">depth_align</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">array_mode_checker</span> <span class="n">array_check</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">array_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">G_0280A0_TILE_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FMASK or CMASK buffer are not supported by this kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">G_0280A0_FORMAT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_fmt_is_valid_color</span><span class="p">(</span><span class="n">format</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d cb invalid format %d for %d (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
			<span class="n">i</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* pitch in pixels */</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_028060_PITCH_TILE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_size</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">slice_tile_max</span> <span class="o">=</span> <span class="n">G_028060_SLICE_TILE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_size</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">slice_tile_max</span> <span class="o">*=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">slice_tile_max</span> <span class="o">/</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span>
		<span class="n">height</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">array_mode</span> <span class="o">=</span> <span class="n">G_0280A0_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">base_offset</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_mc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">array_mode</span> <span class="o">=</span> <span class="n">array_mode</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">group_size</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">npipes</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">r600_fmt_get_blocksize</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r600_get_array_mode_alignment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_check</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">pitch_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s invalid tiling %d for %d (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">G_0280A0_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">i</span><span class="p">,</span>
			 <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">array_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_LINEAR_GENERAL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_LINEAR_ALIGNED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_1D_TILED_THIN1</span>:
		<span class="cm">/* avoid breaking userspace */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">height</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_2D_TILED_THIN1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s invalid tiling %d for %d (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">G_0280A0_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">i</span><span class="p">,</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d cb pitch (%d, 0x%x, %d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">array_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">height_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d cb height (%d, 0x%x, %d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">height_align</span><span class="p">,</span> <span class="n">array_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s offset[%d] 0x%llx 0x%llx, %d not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			 <span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">,</span> <span class="n">array_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check offset */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">r600_fmt_get_nblocksy</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="n">r600_fmt_get_nblocksx</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">pitch</span><span class="p">)</span> <span class="o">*</span> <span class="n">r600_fmt_get_blocksize</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">array_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_LINEAR_GENERAL</span>:
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_LINEAR_ALIGNED</span>:
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_1D_TILED_THIN1</span>:
	<span class="k">case</span> <span class="n">V_0280A0_ARRAY_2D_TILED_THIN1</span>:
		<span class="n">tmp</span> <span class="o">+=</span> <span class="n">G_028080_SLICE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">array_mode</span> <span class="o">==</span> <span class="n">V_0280A0_ARRAY_LINEAR_GENERAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the initial DDX does bad things with the CB size occasionally */</span>
			<span class="cm">/* it rounds up height too far for slice tile max but the BO is smaller */</span>
			<span class="cm">/* r600c,g also seem to flush at bad times in some apps resulting in</span>
<span class="cm">			 * bogus values here. So for linear just allow anything to avoid breaking</span>
<span class="cm">			 * broken userspace.</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s offset[%d] %d %d %d %lu too big (%d %d) (%d %d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">array_mode</span><span class="p">,</span>
				 <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span>
				 <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				 <span class="n">pitch</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">r600_fmt_get_nblocksx</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">pitch</span><span class="p">),</span>
				 <span class="n">r600_fmt_get_nblocksy</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
				 <span class="n">r600_fmt_get_blocksize</span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* limit max tile */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="n">pitch</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">slice_tile_max</span><span class="p">)</span>
		<span class="n">slice_tile_max</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">S_028060_PITCH_TILE_MAX</span><span class="p">((</span><span class="n">pitch</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">S_028060_SLICE_TILE_MAX</span><span class="p">(</span><span class="n">slice_tile_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ib</span><span class="p">[</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_size_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_track_validate_db</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nviews</span><span class="p">,</span> <span class="n">bpe</span><span class="p">,</span> <span class="n">ntiles</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">slice_tile_max</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height_align</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">depth_align</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pitch</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">array_mode_checker</span> <span class="n">array_check</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">array_mode</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;z/stencil with no depth buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">G_028010_FORMAT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V_028010_DEPTH_16</span>:
		<span class="n">bpe</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_028010_DEPTH_X8_24</span>:
	<span class="k">case</span> <span class="n">V_028010_DEPTH_8_24</span>:
	<span class="k">case</span> <span class="n">V_028010_DEPTH_X8_24_FLOAT</span>:
	<span class="k">case</span> <span class="n">V_028010_DEPTH_8_24_FLOAT</span>:
	<span class="k">case</span> <span class="n">V_028010_DEPTH_32_FLOAT</span>:
		<span class="n">bpe</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_028010_DEPTH_X24_8_32_FLOAT</span>:
		<span class="n">bpe</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;z/stencil with invalid format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">G_028010_FORMAT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFC00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFFFC00</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;z/stencil buffer size not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span><span class="p">)</span> <span class="o">-</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_offset</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">/</span> <span class="n">bpe</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;z/stencil buffer too small (0x%08X %d %d %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">,</span> <span class="n">bpe</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_offset</span><span class="p">,</span>
					<span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">S_028000_SLICE_TILE_MAX</span><span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span><span class="p">);</span>
		<span class="cm">/* pitch in pixels */</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_028000_PITCH_TILE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">slice_tile_max</span> <span class="o">=</span> <span class="n">G_028000_SLICE_TILE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">slice_tile_max</span> <span class="o">*=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">slice_tile_max</span> <span class="o">/</span> <span class="n">pitch</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span>
			<span class="n">height</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
		<span class="n">base_offset</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo_mc</span> <span class="o">+</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_offset</span><span class="p">;</span>
		<span class="n">array_mode</span> <span class="o">=</span> <span class="n">G_028010_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">);</span>
		<span class="n">array_check</span><span class="p">.</span><span class="n">array_mode</span> <span class="o">=</span> <span class="n">array_mode</span><span class="p">;</span>
		<span class="n">array_check</span><span class="p">.</span><span class="n">group_size</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">;</span>
		<span class="n">array_check</span><span class="p">.</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">;</span>
		<span class="n">array_check</span><span class="p">.</span><span class="n">npipes</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">;</span>
		<span class="n">array_check</span><span class="p">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">;</span>
		<span class="n">array_check</span><span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">bpe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r600_get_array_mode_alignment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_check</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">pitch_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_align</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s invalid tiling %d (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">G_028010_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">),</span>
					<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">array_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V_028010_ARRAY_1D_TILED_THIN1</span>:
			<span class="cm">/* don&#39;t break userspace */</span>
			<span class="n">height</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V_028010_ARRAY_2D_TILED_THIN1</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s invalid tiling %d (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">G_028010_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">),</span>
					<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d db pitch (%d, 0x%x, %d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">array_mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">height_align</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d db height (%d, 0x%x, %d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">height_align</span><span class="p">,</span> <span class="n">array_mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s offset 0x%llx, 0x%llx, %d not aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					<span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">,</span> <span class="n">array_mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ntiles</span> <span class="o">=</span> <span class="n">G_028000_SLICE_TILE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">nviews</span> <span class="o">=</span> <span class="n">G_028004_SLICE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_view</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ntiles</span> <span class="o">*</span> <span class="n">bpe</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">nviews</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;z/stencil buffer (%d) too small (0x%08X %d %d %d -&gt; %u have %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">array_mode</span><span class="p">,</span>
					<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">,</span> <span class="n">ntiles</span><span class="p">,</span> <span class="n">nviews</span><span class="p">,</span> <span class="n">bpe</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_offset</span><span class="p">,</span>
					<span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* hyperz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">G_028010_TILE_SURFACE_ENABLE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">nbx</span><span class="p">,</span> <span class="n">nby</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d htile enabled without htile surface 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFC00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFFFC00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d htile can&#39;t be enabled with bogus db_depth_size 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">nbx</span> <span class="o">=</span> <span class="n">pitch</span><span class="p">;</span>
		<span class="n">nby</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">G_028D24_LINEAR</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* nbx must be 16 htiles aligned == 16 * 8 pixel aligned */</span>
			<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="cm">/* nby is npipes htiles aligned == npipes * 8 pixel aligned */</span>
			<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* htile widht &amp; nby (8 or 4) make 2 bits number */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="cm">/* align is htile align * 8, htile align vary according to</span>
<span class="cm">			 * number of pipe and tile width and nby</span>
<span class="cm">			 */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 8*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 8*/</span>
				<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 8*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 8*/</span>
				<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 8*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 8*/</span>
				<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 8*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 8*/</span>
				<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* HTILE_WIDTH = 8 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* HTILE_WIDTH = 4 &amp; HTILE_HEIGHT = 4*/</span>
					<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid num pipes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* compute number of htile */</span>
		<span class="n">nbx</span> <span class="o">=</span> <span class="n">G_028D24_HTILE_WIDTH</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span><span class="p">)</span> <span class="o">?</span> <span class="n">nbx</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">:</span> <span class="n">nbx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">nby</span> <span class="o">=</span> <span class="n">G_028D24_HTILE_HEIGHT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span><span class="p">)</span> <span class="o">?</span> <span class="n">nby</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">:</span> <span class="n">nby</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">nbx</span> <span class="o">*</span> <span class="n">nby</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d htile surface too small %ld for %ld (%d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span><span class="p">),</span>
				 <span class="n">size</span><span class="p">,</span> <span class="n">nbx</span><span class="p">,</span> <span class="n">nby</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_track_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* on legacy kernel we don&#39;t perform advanced check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check streamout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">&amp;&amp;</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_buffer_en</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">u64</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_size</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
						<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;streamout %d bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							  <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							  <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No buffer for streamout %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">sx_misc_kill_all_prims</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check that we have a cb for each enabled target, we don&#39;t check</span>
<span class="cm">	 * shader_mask because it seems mesa isn&#39;t always setting it :(</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* at least one component is enabled */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d mask 0x%08X | 0x%08X no cb for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_shader_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* perform rewrite of CB_COLOR[0-7]_SIZE */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_track_validate_cb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check depth buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">G_028800_STENCIL_ENABLE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">G_028800_Z_ENABLE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_track_validate_db</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * r600_cs_packet_parse() - parse cp packet and point ib index to next packet</span>
<span class="cm"> * @parser:	parser structure holding parsing context.</span>
<span class="cm"> * @pkt:	where to store packet informations</span>
<span class="cm"> *</span>
<span class="cm"> * Assume that chunk_ib_index is properly set. Will return -EINVAL</span>
<span class="cm"> * if packet is bigger than remaining ib size. or if packets is unknown.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">r600_cs_packet_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_chunk</span> <span class="o">*</span><span class="n">ib_chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_ib_idx</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Can not parse packet at %d after CS end %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">idx</span><span class="p">,</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">header</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CP_PACKET_GET_TYPE</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">CP_PACKET_GET_COUNT</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">one_reg_wr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET_TYPE0</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">CP_PACKET0_GET_REG</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_TYPE3</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">CP_PACKET3_GET_OPCODE</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_TYPE2</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown packet type %d at %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet (%d:%d:%d) end after CS buffer (%d) !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * r600_cs_packet_next_reloc_mm() - parse next packet which should be reloc packet3</span>
<span class="cm"> * @parser:		parser structure holding parsing context.</span>
<span class="cm"> * @data:		pointer to relocation data</span>
<span class="cm"> * @offset_start:	starting offset</span>
<span class="cm"> * @offset_mask:	offset mask (to align start offset on)</span>
<span class="cm"> * @reloc:		reloc informations</span>
<span class="cm"> *</span>
<span class="cm"> * Check next packet is relocation packet3, do bo validation and compute</span>
<span class="cm"> * GPU offset using the provided start.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_packet_next_reloc_mm</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">**</span><span class="n">cs_reloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_chunk</span> <span class="o">*</span><span class="n">relocs_chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">p3reloc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_relocs_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No relocation chunk !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cs_reloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">relocs_chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_relocs_idx</span><span class="p">];</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p3reloc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p3reloc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PACKET_TYPE3</span> <span class="o">||</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">PACKET3_NOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No packet3 for relocation for packet at %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">p3reloc</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Relocs at %d after relocations chunk end %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">idx</span><span class="p">,</span> <span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME: we assume reloc size is 4 dwords */</span>
	<span class="o">*</span><span class="n">cs_reloc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">relocs_ptr</span><span class="p">[(</span><span class="n">idx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * r600_cs_packet_next_reloc_nomm() - parse next packet which should be reloc packet3</span>
<span class="cm"> * @parser:		parser structure holding parsing context.</span>
<span class="cm"> * @data:		pointer to relocation data</span>
<span class="cm"> * @offset_start:	starting offset</span>
<span class="cm"> * @offset_mask:	offset mask (to align start offset on)</span>
<span class="cm"> * @reloc:		reloc informations</span>
<span class="cm"> *</span>
<span class="cm"> * Check next packet is relocation packet3, do bo validation and compute</span>
<span class="cm"> * GPU offset using the provided start.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_packet_next_reloc_nomm</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">**</span><span class="n">cs_reloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_chunk</span> <span class="o">*</span><span class="n">relocs_chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">p3reloc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_relocs_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No relocation chunk !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cs_reloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">relocs_chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_relocs_idx</span><span class="p">];</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p3reloc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p3reloc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PACKET_TYPE3</span> <span class="o">||</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">PACKET3_NOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No packet3 for relocation for packet at %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">p3reloc</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Relocs at %d after relocations chunk end %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">idx</span><span class="p">,</span> <span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cs_reloc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">relocs</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">cs_reloc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">kdata</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">cs_reloc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">|=</span> <span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">kdata</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * r600_cs_packet_next_is_pkt3_nop() - test if next packet is packet3 nop for reloc</span>
<span class="cm"> * @parser:		parser structure holding parsing context.</span>
<span class="cm"> *</span>
<span class="cm"> * Check next packet is relocation packet3, do bo validation and compute</span>
<span class="cm"> * GPU offset using the provided start.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_packet_next_is_pkt3_nop</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">p3reloc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p3reloc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p3reloc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PACKET_TYPE3</span> <span class="o">||</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">PACKET3_NOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * r600_cs_packet_next_vline() - parse userspace VLINE packet</span>
<span class="cm"> * @parser:		parser structure holding parsing context.</span>
<span class="cm"> *</span>
<span class="cm"> * Userspace sends a special sequence for VLINE waits.</span>
<span class="cm"> * PACKET0 - VLINE_START_END + value</span>
<span class="cm"> * PACKET3 - WAIT_REG_MEM poll vline status reg</span>
<span class="cm"> * RELOC (P3) - crtc_id in reloc.</span>
<span class="cm"> *</span>
<span class="cm"> * This function parses this and relocates the VLINE START END</span>
<span class="cm"> * and WAIT_REG_MEM packets to the correct crtc.</span>
<span class="cm"> * It also detects a switched off crtc and nulls out the</span>
<span class="cm"> * wait in that case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_packet_parse_vline</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">p3reloc</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crtc_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">header</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">wait_reg_mem_info</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ib</span><span class="p">;</span>

	<span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* parse the WAIT_REG_MEM */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait_reg_mem</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* check its a WAIT_REG_MEM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PACKET_TYPE3</span> <span class="o">||</span>
	    <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">PACKET3_WAIT_REG_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline wait missing WAIT_REG_MEM segment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_reg_mem_info</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* bit 4 is reg (0) or mem (1) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_reg_mem_info</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM waiting on MEM rather than REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* waiting for value to be equal */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wait_reg_mem_info</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM function not equal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AVIVO_D1MODE_VLINE_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM bad reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">AVIVO_D1MODE_VLINE_STAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM bad bit mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* jump over the NOP */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p3reloc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">h_idx</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">);</span>
	<span class="n">crtc_id</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">h_idx</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">CP_PACKET0_GET_REG</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">crtc_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;cannot find crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">crtc_id</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the CRTC isn&#39;t enabled - we need to nop out the WAIT_REG_MEM */</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">crtc_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AVIVO_D1MODE_VLINE_START_END</span>:
			<span class="n">header</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R600_CP_PACKET0_REG_MASK</span><span class="p">;</span>
			<span class="n">header</span> <span class="o">|=</span> <span class="n">AVIVO_D2MODE_VLINE_START_END</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;unknown crtc reloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">AVIVO_D2MODE_VLINE_STATUS</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_packet0_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AVIVO_D1MODE_VLINE_START_END</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_parse_vline</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No reloc for ib[%d]=0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Forbidden register 0x%04X in cs at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_parse_packet0</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_packet0_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * r600_cs_check_reg() - check if register is authorized or not</span>
<span class="cm"> * @parser: parser structure holding parsing context</span>
<span class="cm"> * @reg: register we are testing</span>
<span class="cm"> * @idx: index into the cs buffer</span>
<span class="cm"> *</span>
<span class="cm"> * This function will test against r600_reg_safe_bm and return 0</span>
<span class="cm"> * if register is safe. If register is not flag as safe this function</span>
<span class="cm"> * will test it against a list of register needind special handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_check_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">*</span><span class="n">reloc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">ib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">r600_reg_safe_bm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r600_reg_safe_bm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* force following reg to 0 in an attempt to disable out buffer</span>
<span class="cm">	 * which will need us to better understand how it works to perform</span>
<span class="cm">	 * security check on it (Jerome)</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">R_0288A8_SQ_ESGS_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C44_SQ_ESGS_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288B0_SQ_ESTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C54_SQ_ESTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288C0_SQ_FBUF_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C74_SQ_FBUF_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288B4_SQ_GSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C5C_SQ_GSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288AC_SQ_GSVS_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C4C_SQ_GSVS_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288BC_SQ_PSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C6C_SQ_PSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288C4_SQ_REDUC_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C7C_SQ_REDUC_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288B8_SQ_VSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">R_008C64_SQ_VSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">R_0288C8_SQ_GS_VERT_ITEMSIZE</span>:
		<span class="cm">/* get value to populate the IB don&#39;t remove */</span>
		<span class="n">tmp</span> <span class="o">=</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SQ_CONFIG</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">sq_config</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028800_DB_DEPTH_CONTROL</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028010_DB_DEPTH_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">r600_cs_packet_next_is_pkt3_nop</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					 <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">C_028010_ARRAY_MODE</span><span class="p">;</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span> <span class="o">&amp;=</span> <span class="n">C_028010_ARRAY_MODE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_028010_ARRAY_MODE</span><span class="p">(</span><span class="n">V_028010_ARRAY_2D_TILED_THIN1</span><span class="p">);</span>
				<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span> <span class="o">|=</span> <span class="n">S_028010_ARRAY_MODE</span><span class="p">(</span><span class="n">V_028010_ARRAY_2D_TILED_THIN1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_028010_ARRAY_MODE</span><span class="p">(</span><span class="n">V_028010_ARRAY_1D_TILED_THIN1</span><span class="p">);</span>
				<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span> <span class="o">|=</span> <span class="n">S_028010_ARRAY_MODE</span><span class="p">(</span><span class="n">V_028010_ARRAY_1D_TILED_THIN1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_info</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028004_DB_DEPTH_VIEW</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_view</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028000_DB_DEPTH_SIZE</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028AB0_VGT_STRMOUT_EN</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_en</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028B20_VGT_STRMOUT_BUFFER_EN</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_buffer_en</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_0</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_1</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_2</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_3</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_mc</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_0</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_1</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_2</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_3</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="cm">/* size in register is DWs, convert to bytes */</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_size</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CP_COHER_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;missing reloc for CP_COHER_BASE &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028238_CB_TARGET_MASK</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_02823C_CB_SHADER_MASK</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_shader_mask</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028C04_PA_SC_AA_CONFIG</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">G_028C04_MSAA_NUM_SAMPLES</span><span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">));</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_0280A0_CB_COLOR0_INFO</span>:
	<span class="k">case</span> <span class="n">R_0280A4_CB_COLOR1_INFO</span>:
	<span class="k">case</span> <span class="n">R_0280A8_CB_COLOR2_INFO</span>:
	<span class="k">case</span> <span class="n">R_0280AC_CB_COLOR3_INFO</span>:
	<span class="k">case</span> <span class="n">R_0280B0_CB_COLOR4_INFO</span>:
	<span class="k">case</span> <span class="n">R_0280B4_CB_COLOR5_INFO</span>:
	<span class="k">case</span> <span class="n">R_0280B8_CB_COLOR6_INFO</span>:
	<span class="k">case</span> <span class="n">R_0280BC_CB_COLOR7_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">r600_cs_packet_next_is_pkt3_nop</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">R_0280A0_CB_COLOR0_INFO</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_0280A0_ARRAY_MODE</span><span class="p">(</span><span class="n">V_0280A0_ARRAY_2D_TILED_THIN1</span><span class="p">);</span>
				<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_0280A0_ARRAY_MODE</span><span class="p">(</span><span class="n">V_0280A0_ARRAY_2D_TILED_THIN1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MICRO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_0280A0_ARRAY_MODE</span><span class="p">(</span><span class="n">V_0280A0_ARRAY_1D_TILED_THIN1</span><span class="p">);</span>
				<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_0280A0_ARRAY_MODE</span><span class="p">(</span><span class="n">V_0280A0_ARRAY_1D_TILED_THIN1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">R_0280A0_CB_COLOR0_INFO</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028080_CB_COLOR0_VIEW</span>:
	<span class="k">case</span> <span class="n">R_028084_CB_COLOR1_VIEW</span>:
	<span class="k">case</span> <span class="n">R_028088_CB_COLOR2_VIEW</span>:
	<span class="k">case</span> <span class="n">R_02808C_CB_COLOR3_VIEW</span>:
	<span class="k">case</span> <span class="n">R_028090_CB_COLOR4_VIEW</span>:
	<span class="k">case</span> <span class="n">R_028094_CB_COLOR5_VIEW</span>:
	<span class="k">case</span> <span class="n">R_028098_CB_COLOR6_VIEW</span>:
	<span class="k">case</span> <span class="n">R_02809C_CB_COLOR7_VIEW</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">R_028080_CB_COLOR0_VIEW</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_028060_CB_COLOR0_SIZE</span>:
	<span class="k">case</span> <span class="n">R_028064_CB_COLOR1_SIZE</span>:
	<span class="k">case</span> <span class="n">R_028068_CB_COLOR2_SIZE</span>:
	<span class="k">case</span> <span class="n">R_02806C_CB_COLOR3_SIZE</span>:
	<span class="k">case</span> <span class="n">R_028070_CB_COLOR4_SIZE</span>:
	<span class="k">case</span> <span class="n">R_028074_CB_COLOR5_SIZE</span>:
	<span class="k">case</span> <span class="n">R_028078_CB_COLOR6_SIZE</span>:
	<span class="k">case</span> <span class="n">R_02807C_CB_COLOR7_SIZE</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">R_028060_CB_COLOR0_SIZE</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_size</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_size_idx</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* This register were added late, there is userspace</span>
<span class="cm">		 * which does provide relocation for those but set</span>
<span class="cm">		 * 0 offset. In order to avoid breaking old userspace</span>
<span class="cm">		 * we detect this and set address to point to last</span>
<span class="cm">		 * CB_COLOR0_BASE, note that if userspace doesn&#39;t set</span>
<span class="cm">		 * CB_COLOR0_BASE before this register we will report</span>
<span class="cm">		 * error. Old userspace always set CB_COLOR0_BASE</span>
<span class="cm">		 * before any of this.</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">R_0280E0_CB_COLOR0_FRAG</span>:
	<span class="k">case</span> <span class="n">R_0280E4_CB_COLOR1_FRAG</span>:
	<span class="k">case</span> <span class="n">R_0280E8_CB_COLOR2_FRAG</span>:
	<span class="k">case</span> <span class="n">R_0280EC_CB_COLOR3_FRAG</span>:
	<span class="k">case</span> <span class="n">R_0280F0_CB_COLOR4_FRAG</span>:
	<span class="k">case</span> <span class="n">R_0280F4_CB_COLOR5_FRAG</span>:
	<span class="k">case</span> <span class="n">R_0280F8_CB_COLOR6_FRAG</span>:
	<span class="k">case</span> <span class="n">R_0280FC_CB_COLOR7_FRAG</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">R_0280E0_CB_COLOR0_FRAG</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_cs_packet_next_is_pkt3_nop</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_base_last</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Broken old userspace ? no cb_color0_base supplied before trying to write 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_base_last</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_frag_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_frag_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_0280C0_CB_COLOR0_TILE</span>:
	<span class="k">case</span> <span class="n">R_0280C4_CB_COLOR1_TILE</span>:
	<span class="k">case</span> <span class="n">R_0280C8_CB_COLOR2_TILE</span>:
	<span class="k">case</span> <span class="n">R_0280CC_CB_COLOR3_TILE</span>:
	<span class="k">case</span> <span class="n">R_0280D0_CB_COLOR4_TILE</span>:
	<span class="k">case</span> <span class="n">R_0280D4_CB_COLOR5_TILE</span>:
	<span class="k">case</span> <span class="n">R_0280D8_CB_COLOR6_TILE</span>:
	<span class="k">case</span> <span class="n">R_0280DC_CB_COLOR7_TILE</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">R_0280C0_CB_COLOR0_TILE</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_cs_packet_next_is_pkt3_nop</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_base_last</span><span class="p">[</span><span class="n">tmp</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Broken old userspace ? no cb_color0_base supplied before trying to write 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_base_last</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_tile_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_tile_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_BASE</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_base_last</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_mc</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_DEPTH_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_bo_mc</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_HTILE_DATA_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_HTILE_SURFACE</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SQ_PGM_START_FS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_ES</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_VS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_GS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_PS</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_15</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_15</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_15</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SX_MEMORY_EXPORT_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONFIG_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SX_MISC</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">sx_misc_kill_all_prims</span> <span class="o">=</span> <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="nf">r600_mip_minify</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">1U</span><span class="p">,</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">r600_texture_size</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">nfaces</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">blevel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">llevel</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">w0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">h0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">d0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">format</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">block_align</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">height_align</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">base_align</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="o">*</span><span class="n">l0_size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="o">*</span><span class="n">mipmap_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nbx</span><span class="p">,</span> <span class="n">nby</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">nlevels</span> <span class="o">=</span> <span class="n">llevel</span> <span class="o">-</span> <span class="n">blevel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">l0_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">blocksize</span> <span class="o">=</span> <span class="n">r600_fmt_get_blocksize</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>

	<span class="n">w0</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">h0</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">d0</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">level</span> <span class="o">=</span> <span class="n">blevel</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nlevels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">width</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">nbx</span> <span class="o">=</span> <span class="n">r600_fmt_get_nblocksx</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>

		<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="n">block_align</span><span class="p">);</span>

		<span class="n">height</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">h0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">nby</span> <span class="o">=</span> <span class="n">r600_fmt_get_nblocksy</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="n">height_align</span><span class="p">);</span>

		<span class="n">depth</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">nbx</span> <span class="o">*</span> <span class="n">nby</span> <span class="o">*</span> <span class="n">blocksize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nfaces</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">*=</span> <span class="n">nfaces</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">size</span> <span class="o">*=</span> <span class="n">depth</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">l0_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">mipmap_size</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">llevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mipmap_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">l0_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blevel</span><span class="p">)</span>
		<span class="o">*</span><span class="n">mipmap_size</span> <span class="o">-=</span> <span class="o">*</span><span class="n">l0_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * r600_check_texture_resource() - check if register is authorized or not</span>
<span class="cm"> * @p: parser structure holding parsing context</span>
<span class="cm"> * @idx: index into the cs buffer</span>
<span class="cm"> * @texture: texture&#39;s bo structure</span>
<span class="cm"> * @mipmap: mipmap&#39;s bo structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function will check that the resource has valid field and that</span>
<span class="cm"> * the texture and mipmap bo object are big enough to cover this resource.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_check_texture_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>  <span class="n">u32</span> <span class="n">idx</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">texture</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">mipmap</span><span class="p">,</span>
					      <span class="n">u64</span> <span class="n">base_offset</span><span class="p">,</span>
					      <span class="n">u64</span> <span class="n">mip_offset</span><span class="p">,</span>
					      <span class="n">u32</span> <span class="n">tiling_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nfaces</span><span class="p">,</span> <span class="n">llevel</span><span class="p">,</span> <span class="n">blevel</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">d0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">word0</span><span class="p">,</span> <span class="n">word1</span><span class="p">,</span> <span class="n">l0_size</span><span class="p">,</span> <span class="n">mipmap_size</span><span class="p">,</span> <span class="n">word2</span><span class="p">,</span> <span class="n">word3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">height_align</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">depth_align</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">array</span><span class="p">,</span> <span class="n">barray</span><span class="p">,</span> <span class="n">larray</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">base_align</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">array_mode_checker</span> <span class="n">array_check</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">format</span><span class="p">;</span>

	<span class="cm">/* on legacy kernel we don&#39;t perform advanced check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* convert to bytes */</span>
	<span class="n">base_offset</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mip_offset</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">word0</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span>
			<span class="n">word0</span> <span class="o">|=</span> <span class="n">S_038000_TILE_MODE</span><span class="p">(</span><span class="n">V_038000_ARRAY_2D_TILED_THIN1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MICRO</span><span class="p">)</span>
			<span class="n">word0</span> <span class="o">|=</span> <span class="n">S_038000_TILE_MODE</span><span class="p">(</span><span class="n">V_038000_ARRAY_1D_TILED_THIN1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">word1</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">w0</span> <span class="o">=</span> <span class="n">G_038000_TEX_WIDTH</span><span class="p">(</span><span class="n">word0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">h0</span> <span class="o">=</span> <span class="n">G_038004_TEX_HEIGHT</span><span class="p">(</span><span class="n">word1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">d0</span> <span class="o">=</span> <span class="n">G_038004_TEX_DEPTH</span><span class="p">(</span><span class="n">word1</span><span class="p">);</span>
	<span class="n">nfaces</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">array</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">G_038000_DIM</span><span class="p">(</span><span class="n">word0</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_1D</span>:
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_2D</span>:
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_3D</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_CUBEMAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span><span class="p">)</span>
			<span class="n">nfaces</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nfaces</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_1D_ARRAY</span>:
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_2D_ARRAY</span>:
		<span class="n">array</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_2D_MSAA</span>:
	<span class="k">case</span> <span class="n">V_038000_SQ_TEX_DIM_2D_ARRAY_MSAA</span>:
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;this kernel doesn&#39;t support %d texture dim</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">G_038000_DIM</span><span class="p">(</span><span class="n">word0</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">G_038004_DATA_FORMAT</span><span class="p">(</span><span class="n">word1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_fmt_is_valid_texture</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d texture invalid format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pitch in texels */</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_038000_PITCH</span><span class="p">(</span><span class="n">word0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">array_mode</span> <span class="o">=</span> <span class="n">G_038000_TILE_MODE</span><span class="p">(</span><span class="n">word0</span><span class="p">);</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">group_size</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">npipes</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">array_check</span><span class="p">.</span><span class="n">blocksize</span> <span class="o">=</span> <span class="n">r600_fmt_get_blocksize</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r600_get_array_mode_alignment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array_check</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">pitch_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth_align</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">base_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d tex array mode (%d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">G_038000_TILE_MODE</span><span class="p">(</span><span class="n">word0</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX check height as well... */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d tex pitch (%d, 0x%x, %d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">G_038000_TILE_MODE</span><span class="p">(</span><span class="n">word0</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d tex base offset (0x%llx, 0x%llx, %d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">base_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">,</span> <span class="n">G_038000_TILE_MODE</span><span class="p">(</span><span class="n">word0</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">(</span><span class="n">mip_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d tex mip offset (0x%llx, 0x%llx, %d) invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">mip_offset</span><span class="p">,</span> <span class="n">base_align</span><span class="p">,</span> <span class="n">G_038000_TILE_MODE</span><span class="p">(</span><span class="n">word0</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">word2</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">word3</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">word0</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">word1</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">blevel</span> <span class="o">=</span> <span class="n">G_038010_BASE_LEVEL</span><span class="p">(</span><span class="n">word0</span><span class="p">);</span>
	<span class="n">llevel</span> <span class="o">=</span> <span class="n">G_038014_LAST_LEVEL</span><span class="p">(</span><span class="n">word1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blevel</span> <span class="o">&gt;</span> <span class="n">llevel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;texture blevel %d &gt; llevel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">blevel</span><span class="p">,</span> <span class="n">llevel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">array</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">barray</span> <span class="o">=</span> <span class="n">G_038014_BASE_ARRAY</span><span class="p">(</span><span class="n">word1</span><span class="p">);</span>
		<span class="n">larray</span> <span class="o">=</span> <span class="n">G_038014_LAST_ARRAY</span><span class="p">(</span><span class="n">word1</span><span class="p">);</span>

		<span class="n">nfaces</span> <span class="o">=</span> <span class="n">larray</span> <span class="o">-</span> <span class="n">barray</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r600_texture_size</span><span class="p">(</span><span class="n">nfaces</span><span class="p">,</span> <span class="n">blevel</span><span class="p">,</span> <span class="n">llevel</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">d0</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
			  <span class="n">pitch_align</span><span class="p">,</span> <span class="n">height_align</span><span class="p">,</span> <span class="n">base_align</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">l0_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mipmap_size</span><span class="p">);</span>
	<span class="cm">/* using get ib will give us the offset into the texture bo */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">l0_size</span> <span class="o">+</span> <span class="n">word2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">texture</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;texture bo too small ((%d %d) (%d %d) %d %d %d -&gt; %d have %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">w0</span><span class="p">,</span> <span class="n">h0</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">height_align</span><span class="p">,</span>
			 <span class="n">array_check</span><span class="p">.</span><span class="n">array_mode</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">word2</span><span class="p">,</span>
			 <span class="n">l0_size</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">texture</span><span class="p">));</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alignments %d %d %d %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">pitch_align</span><span class="p">,</span> <span class="n">height_align</span><span class="p">,</span> <span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* using get ib will give us the offset into the mipmap bo */</span>
	<span class="n">word3</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mipmap_size</span> <span class="o">+</span> <span class="n">word3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">mipmap</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*dev_warn(p-&gt;dev, &quot;mipmap bo too small (%d %d %d %d %d %d -&gt; %d have %ld)\n&quot;,</span>
<span class="cm">		  w0, h0, format, blevel, nlevels, word3, mipmap_size, radeon_bo_size(texture));*/</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">r600_is_safe_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">r600_reg_safe_bm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">r600_reg_safe_bm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_packet3_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">*</span><span class="n">reloc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ib</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">start_reg</span><span class="p">,</span> <span class="n">end_reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx_value</span><span class="p">;</span>

	<span class="n">track</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">idx_value</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_PREDICATION</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pred_op</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET PREDICATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pred_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="cm">/* for the clear predicate operation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pred_op</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pred_op</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET PREDICATION operation %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pred_op</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET PREDICATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PACKET3_START_3D_CMDBUF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span> <span class="o">||</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad START_3D</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_CONTEXT_CONTROL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad CONTEXT_CONTROL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_INDEX_TYPE</span>:
	<span class="k">case</span> <span class="n">PACKET3_NUM_INSTANCES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad INDEX_TYPE/NUM_INSTANCES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX</span>:
	<span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="n">idx_value</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_AUTO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_IMMD_BE</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_IMMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_IMMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_WAIT_REG_MEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad WAIT_REG_MEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* bit 4 is reg (0) or mem (1) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad WAIT_REG_MEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
			         <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">+</span>
			         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">);</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SURFACE_SYNC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SURFACE_SYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* 0xffffffff/0x0 is flush all cache flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">||</span>
		    <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SURFACE_SYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
			         <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffff8</span><span class="p">)</span> <span class="o">+</span>
			         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfffffff8</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE_EOP</span>:
	<span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE_EOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">)</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_CONFIG_REG</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_CONFIG_REG_OFFSET</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_CONFIG_REG_OFFSET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONFIG_REG_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONFIG_REG_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad PACKET3_SET_CONFIG_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">start_reg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_check_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_CONTEXT_REG</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_CONTEXT_REG_OFFSET</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_CONTEXT_REG_OFFSET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONTEXT_REG_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONTEXT_REG_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad PACKET3_SET_CONTEXT_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">start_reg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_check_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_RESOURCE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_RESOURCE_OFFSET</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_RESOURCE_OFFSET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_RESOURCE_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_RESOURCE_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">/</span> <span class="mi">7</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">texture</span><span class="p">,</span> <span class="o">*</span><span class="n">mipmap</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">base_offset</span><span class="p">,</span> <span class="n">mip_offset</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">G__SQ_VTX_CONSTANT_TYPE</span><span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_VALID_TEXTURE</span>:
				<span class="cm">/* tex base */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">base_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span>
						<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_038000_TILE_MODE</span><span class="p">(</span><span class="n">V_038000_ARRAY_2D_TILED_THIN1</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MICRO</span><span class="p">)</span>
						<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">S_038000_TILE_MODE</span><span class="p">(</span><span class="n">V_038000_ARRAY_1D_TILED_THIN1</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">texture</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
				<span class="cm">/* tex mip base */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mip_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
				<span class="n">mipmap</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">r600_check_texture_resource</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>  <span class="n">idx</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
								<span class="n">texture</span><span class="p">,</span> <span class="n">mipmap</span><span class="p">,</span>
								<span class="n">base_offset</span> <span class="o">+</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span>
								<span class="n">mip_offset</span> <span class="o">+</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
								<span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">base_offset</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mip_offset</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_VALID_BUFFER</span>:
			<span class="p">{</span>
				<span class="kt">uint64_t</span> <span class="n">offset64</span><span class="p">;</span>
				<span class="cm">/* vtx base */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* force size to size of the buffer */</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vbo resource seems too big (%d) for the bo (%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">size</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
					<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">offset64</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset64</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">|</span>
						    <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_INVALID_TEXTURE</span>:
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_INVALID_BUFFER</span>:
			<span class="nl">default:</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_ALU_CONST</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">sq_config</span> <span class="o">&amp;</span> <span class="n">DX9_CONSTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_ALU_CONST_OFFSET</span><span class="p">;</span>
			<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_ALU_CONST_OFFSET</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_ALU_CONST_END</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_ALU_CONST_END</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_ALU_CONST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_BOOL_CONST</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_BOOL_CONST_OFFSET</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_BOOL_CONST_OFFSET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_BOOL_CONST_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_BOOL_CONST_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_BOOL_CONST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_LOOP_CONST</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_LOOP_CONST_OFFSET</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_LOOP_CONST_OFFSET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_LOOP_CONST_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_LOOP_CONST_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_LOOP_CONST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_CTL_CONST</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_CTL_CONST_OFFSET</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_CTL_CONST_OFFSET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CTL_CONST_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CTL_CONST_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_CTL_CONST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_SAMPLER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_SAMPLER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_SAMPLER_OFFSET</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_SAMPLER_OFFSET</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_SAMPLER_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_SAMPLER_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_SAMPLER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_STRMOUT_BASE_UPDATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_RV770</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;STRMOUT_BASE_UPDATE only supported on 7xx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BASE_UPDATE packet count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BASE_UPDATE index</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BASE_UPDATE reloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span> <span class="o">!=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">idx_value</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BASE_UPDATE, bo does not match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">idx_value</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BASE_UPDATE, bo offset does not match: 0x%llx, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">idx_value</span><span class="p">]);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BASE_UPDATE bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SURFACE_BASE_UPDATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_RV770</span> <span class="o">||</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">CHIP_R600</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SURFACE_BASE_UPDATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SURFACE_BASE_UPDATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_STRMOUT_BUFFER_UPDATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE (invalid count)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Updating memory at DST_ADDRESS. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE (missing dst reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE dst bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Reading data from SRC_ADDRESS. */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">idx_value</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE (missing src reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE src bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_COPY_DW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW (invalid count)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="cm">/* SRC is memory. */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW (missing src reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW src bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* SRC is a reg. */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_is_safe_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="cm">/* DST is memory. */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW (missing dst reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW dst bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DST is a reg. */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_is_safe_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_NOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet3 opcode %x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">r600_cs_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize tracker, we are in kms */</span>
		<span class="n">track</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">track</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">track</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">r600_cs_track_init</span><span class="p">(</span><span class="n">track</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_RV770</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">tiling_npipes</span><span class="p">;</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">tiling_nbanks</span><span class="p">;</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">r600</span><span class="p">.</span><span class="n">tiling_group_size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;=</span> <span class="n">CHIP_RV740</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">tiling_npipes</span><span class="p">;</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">tiling_nbanks</span><span class="p">;</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rv770</span><span class="p">.</span><span class="n">tiling_group_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">track</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">pkt</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE0</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_parse_packet0</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE2</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE3</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">r600_packet3_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown packet type %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_ib_idx</span><span class="p">].</span><span class="n">length_dw</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	for (r = 0; r &lt; p-&gt;ib.length_dw; r++) {</span>
<span class="c">		printk(KERN_INFO &quot;%05d  0x%08X\n&quot;, r, p-&gt;ib.ptr[r]);</span>
<span class="c">		mdelay(1);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">r600_cs_parser_relocs_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_relocs_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">relocs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_reloc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">relocs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cs_parser_fini() - clean parser states</span>
<span class="cm"> * @parser:	parser structure holding parsing context.</span>
<span class="cm"> * @error:	error number</span>
<span class="cm"> *</span>
<span class="cm"> * If error is set than unvalidate buffer, otherwise just free memory</span>
<span class="cm"> * used by parsing context.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">r600_cs_parser_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">parser</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">relocs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">parser</span><span class="o">-&gt;</span><span class="n">nchunks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kdata</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kpage</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kpage</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">chunks_array</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">r600_cs_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">family</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ib</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="n">parser</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_chunk</span> <span class="o">*</span><span class="n">ib_chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">r600_cs_track</span> <span class="o">*</span><span class="n">track</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* initialize tracker */</span>
	<span class="n">track</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">track</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">track</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">r600_cs_track_init</span><span class="p">(</span><span class="n">track</span><span class="p">);</span>
	<span class="n">r600_cs_legacy_get_tiling_conf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">);</span>
	<span class="cm">/* initialize parser */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span><span class="p">));</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">filp</span> <span class="o">=</span> <span class="n">filp</span><span class="p">;</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span><span class="p">;</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">track</span> <span class="o">=</span> <span class="n">track</span><span class="p">;</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ib</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_cs_parser_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to initialize parser !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r600_cs_parser_fini</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_parser_relocs_legacy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to parse relocation !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r600_cs_parser_fini</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Copy the packet into the IB, the parser will read from the</span>
<span class="cm">	 * input memory (cached) and write to the IB (which can be</span>
<span class="cm">	 * uncached). */</span>
	<span class="n">ib_chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">parser</span><span class="p">.</span><span class="n">chunks</span><span class="p">[</span><span class="n">parser</span><span class="p">.</span><span class="n">chunk_ib_idx</span><span class="p">];</span>
	<span class="n">parser</span><span class="p">.</span><span class="n">ib</span><span class="p">.</span><span class="n">length_dw</span> <span class="o">=</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">;</span>
	<span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">ib</span><span class="p">.</span><span class="n">length_dw</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">r600_cs_parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid command stream !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r600_cs_parser_fini</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">radeon_cs_finish_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid command stream !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">r600_cs_parser_fini</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r600_cs_parser_fini</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parser</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">r600_cs_legacy_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">r600_cs_packet_next_reloc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r600_cs_packet_next_reloc_nomm</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
