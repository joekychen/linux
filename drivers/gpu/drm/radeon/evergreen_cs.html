<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › radeon › evergreen_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>evergreen_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2010 Advanced Micro Devices, Inc.</span>
<span class="cm"> * Copyright 2008 Red Hat Inc.</span>
<span class="cm"> * Copyright 2009 Jerome Glisse.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Dave Airlie</span>
<span class="cm"> *          Alex Deucher</span>
<span class="cm"> *          Jerome Glisse</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;radeon.h&quot;</span>
<span class="cp">#include &quot;evergreend.h&quot;</span>
<span class="cp">#include &quot;evergreen_reg_safe.h&quot;</span>
<span class="cp">#include &quot;cayman_reg_safe.h&quot;</span>

<span class="cp">#define MAX(a,b)                   (((a)&gt;(b))?(a):(b))</span>
<span class="cp">#define MIN(a,b)                   (((a)&lt;(b))?(a):(b))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">**</span><span class="n">cs_reloc</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="p">{</span>
	<span class="n">u32</span>			<span class="n">group_size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">nbanks</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">npipes</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">row_size</span><span class="p">;</span>
	<span class="cm">/* value we track */</span>
	<span class="n">u32</span>			<span class="n">nsamples</span><span class="p">;</span>		<span class="cm">/* unused */</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">cb_color_fmask_bo</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* unused */</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">cb_color_cmask_bo</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>	<span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">cb_color_info</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_view</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_pitch</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_slice</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_slice_idx</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_attrib</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">cb_color_cmask_slice</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">cb_color_fmask_slice</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">cb_target_mask</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">cb_shader_mask</span><span class="p">;</span> <span class="cm">/* unused */</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_config</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_buffer_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">vgt_strmout_size</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span>			<span class="n">db_depth_control</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_depth_view</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_depth_slice</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_depth_size</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_z_info</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_z_read_offset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_z_write_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">db_z_read_bo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">db_z_write_bo</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_s_info</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_s_read_offset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">db_s_write_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">db_s_read_bo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">db_s_write_bo</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">sx_misc_kill_all_prims</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">cb_dirty</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">db_dirty</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">streamout_dirty</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">htile_offset</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">htile_surface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_bo</span>	<span class="o">*</span><span class="n">htile_bo</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">u32</span> <span class="n">tiling_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ARRAY_2D_TILED_THIN1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MICRO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ARRAY_1D_TILED_THIN1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ARRAY_LINEAR_GENERAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">evergreen_cs_get_num_banks</span><span class="p">(</span><span class="n">u32</span> <span class="n">nbanks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">nbanks</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">ADDR_SURF_2_BANK</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="n">ADDR_SURF_4_BANK</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ADDR_SURF_8_BANK</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">return</span> <span class="n">ADDR_SURF_16_BANK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">evergreen_cs_track_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_fmask_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_cmask_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_cmask_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_fmask_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_pitch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfffffff</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_shader_mask</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_view</span> <span class="o">=</span> <span class="mh">0xFFFFC000</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_offset</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_offset</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_info</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_offset</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_offset</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_offset</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">track</span><span class="o">-&gt;</span><span class="n">sx_misc_kill_all_prims</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">eg_surface</span> <span class="p">{</span>
	<span class="cm">/* value gathered from cs */</span>
	<span class="kt">unsigned</span>	<span class="n">nbx</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">nby</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">format</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">nbanks</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">bankw</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">bankh</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">tsplit</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">mtilea</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">nsamples</span><span class="p">;</span>
	<span class="cm">/* output value */</span>
	<span class="kt">unsigned</span>	<span class="n">bpe</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">layer_size</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">palign</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">halign</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">base_align</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_surface_check_linear</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">eg_surface</span> <span class="o">*</span><span class="n">surf</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">layer_size</span> <span class="o">=</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">base_align</span> <span class="o">=</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">halign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_surface_check_linear_aligned</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">eg_surface</span> <span class="o">*</span><span class="n">surf</span><span class="p">,</span>
						  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">palign</span><span class="p">;</span>

	<span class="n">palign</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">/</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span><span class="p">);</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">layer_size</span> <span class="o">=</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">base_align</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">=</span> <span class="n">palign</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">halign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">palign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s pitch %d invalid must be aligned with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span><span class="p">,</span> <span class="n">palign</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_surface_check_1d</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">eg_surface</span> <span class="o">*</span><span class="n">surf</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">palign</span><span class="p">;</span>

	<span class="n">palign</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">);</span>
	<span class="n">palign</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">palign</span><span class="p">);</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">layer_size</span> <span class="o">=</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">base_align</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">=</span> <span class="n">palign</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">halign</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">palign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s pitch %d invalid must be aligned with %d (%d %d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span><span class="p">,</span> <span class="n">palign</span><span class="p">,</span>
				 <span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s height %d invalid must be aligned with 8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_surface_check_2d</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">eg_surface</span> <span class="o">*</span><span class="n">surf</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">palign</span><span class="p">,</span> <span class="n">halign</span><span class="p">,</span> <span class="n">tileb</span><span class="p">,</span> <span class="n">slice_pt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mtile_pr</span><span class="p">,</span> <span class="n">mtile_ps</span><span class="p">,</span> <span class="n">mtileb</span><span class="p">;</span>

	<span class="n">tileb</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nsamples</span><span class="p">;</span>
	<span class="n">slice_pt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tileb</span> <span class="o">&gt;</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slice_pt</span> <span class="o">=</span> <span class="n">tileb</span> <span class="o">/</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tileb</span> <span class="o">=</span> <span class="n">tileb</span> <span class="o">/</span> <span class="n">slice_pt</span><span class="p">;</span>
	<span class="cm">/* macro tile width &amp; height */</span>
	<span class="n">palign</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankw</span> <span class="o">*</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">)</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span><span class="p">;</span>
	<span class="n">halign</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankh</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">)</span> <span class="o">/</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span><span class="p">;</span>
	<span class="n">mtileb</span> <span class="o">=</span> <span class="p">(</span><span class="n">palign</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">halign</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">tileb</span><span class="p">;;</span>
	<span class="n">mtile_pr</span> <span class="o">=</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span> <span class="o">/</span> <span class="n">palign</span><span class="p">;</span>
	<span class="n">mtile_ps</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtile_pr</span> <span class="o">*</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span><span class="p">)</span> <span class="o">/</span> <span class="n">halign</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">layer_size</span> <span class="o">=</span> <span class="n">mtile_ps</span> <span class="o">*</span> <span class="n">mtileb</span> <span class="o">*</span> <span class="n">slice_pt</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">base_align</span> <span class="o">=</span> <span class="p">(</span><span class="n">palign</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">halign</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">tileb</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">palign</span> <span class="o">=</span> <span class="n">palign</span><span class="p">;</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">halign</span> <span class="o">=</span> <span class="n">halign</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">palign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s pitch %d invalid must be aligned with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbx</span><span class="p">,</span> <span class="n">palign</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">halign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s height %d invalid must be aligned with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nby</span><span class="p">,</span> <span class="n">halign</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_surface_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">eg_surface</span> <span class="o">*</span><span class="n">surf</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* some common value computed here */</span>
	<span class="n">surf</span><span class="o">-&gt;</span><span class="n">bpe</span> <span class="o">=</span> <span class="n">r600_fmt_get_blocksize</span><span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ARRAY_LINEAR_GENERAL</span>:
		<span class="k">return</span> <span class="n">evergreen_surface_check_linear</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">surf</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ARRAY_LINEAR_ALIGNED</span>:
		<span class="k">return</span> <span class="n">evergreen_surface_check_linear_aligned</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">surf</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ARRAY_1D_TILED_THIN1</span>:
		<span class="k">return</span> <span class="n">evergreen_surface_check_1d</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">surf</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ARRAY_2D_TILED_THIN1</span>:
		<span class="k">return</span> <span class="n">evergreen_surface_check_2d</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">surf</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s invalid array mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_surface_value_conv_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">eg_surface</span> <span class="o">*</span><span class="n">surf</span><span class="p">,</span>
					      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ARRAY_2D_TILED_THIN1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ARRAY_LINEAR_GENERAL</span>:
	<span class="k">case</span> <span class="n">ARRAY_LINEAR_ALIGNED</span>:
	<span class="k">case</span> <span class="n">ARRAY_1D_TILED_THIN1</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s invalid array mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s invalid number of banks %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankw</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankw</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankw</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s invalid bankw %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankh</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankh</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankh</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankh</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s invalid bankh %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">bankh</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s invalid macro tile aspect %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">mtilea</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d %s invalid tile split %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">surf</span><span class="o">-&gt;</span><span class="n">tsplit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_track_validate_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eg_surface</span> <span class="n">surf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">slice</span><span class="p">,</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mslice</span> <span class="o">=</span> <span class="n">G_028C6C_SLICE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_pitch</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="n">slice</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="p">((</span><span class="n">slice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">G_028C70_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">G_028C70_FORMAT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">tsplit</span> <span class="o">=</span> <span class="n">G_028C74_TILE_SPLIT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">G_028C74_NUM_BANKS</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankw</span> <span class="o">=</span> <span class="n">G_028C74_BANK_WIDTH</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankh</span> <span class="o">=</span> <span class="n">G_028C74_BANK_HEIGHT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mtilea</span> <span class="o">=</span> <span class="n">G_028C74_MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_fmt_is_valid_color</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d cb invalid format %d for %d (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">,</span>
			<span class="n">id</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_value_conv_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;cb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;cb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d cb[%d] invalid (0x%08x 0x%08x 0x%08x 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_pitch</span><span class="p">[</span><span class="n">id</span><span class="p">],</span>
			 <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">id</span><span class="p">],</span>
			 <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">base_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d cb[%d] bo base %ld not aligned with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">id</span><span class="p">]))</span> <span class="p">{</span>
		<span class="cm">/* old ddx are broken they allocate bo with w*h*bpp but</span>
<span class="cm">		 * program slice with ALIGN(h, 8), catch this and patch</span>
<span class="cm">		 * command stream.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">surf</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">nby</span><span class="p">,</span> <span class="n">bsize</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* find the height the ddx wants */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">min</span> <span class="o">=</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bsize</span> <span class="o">=</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">nby</span> <span class="o">=</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">;</span> <span class="n">nby</span> <span class="o">&gt;</span> <span class="n">min</span><span class="p">;</span> <span class="n">nby</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">nby</span> <span class="o">*</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">*</span> <span class="n">surf</span><span class="p">.</span><span class="n">bpe</span> <span class="o">*</span> <span class="n">surf</span><span class="p">.</span><span class="n">nsamples</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bsize</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nby</span> <span class="o">&gt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="n">nby</span><span class="p">;</span>
				<span class="n">slice</span> <span class="o">=</span> <span class="p">((</span><span class="n">nby</span> <span class="o">*</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;cb&quot;</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* check if this one works */</span>
					<span class="n">tmp</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="n">bsize</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">ib</span><span class="p">[</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice_idx</span><span class="p">[</span><span class="n">id</span><span class="p">]]</span> <span class="o">=</span> <span class="n">slice</span><span class="p">;</span>
						<span class="k">goto</span> <span class="n">old_ddx_ok</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d cb[%d] bo too small (layer size %d, &quot;</span>
			 <span class="s">&quot;offset %d, max layer %d, bo size %ld, slice %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span><span class="p">,</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span>
			<span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">id</span><span class="p">]),</span> <span class="n">slice</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d problematic surf: (%d %d) (%d %d %d %d %d %d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">,</span>
			<span class="n">surf</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">bpe</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nsamples</span><span class="p">,</span>
			<span class="n">surf</span><span class="p">.</span><span class="n">bankw</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">bankh</span><span class="p">,</span>
			<span class="n">surf</span><span class="p">.</span><span class="n">tsplit</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">mtilea</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">old_ddx_ok:</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_track_validate_htile</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="n">nbx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nby</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d htile enabled without htile surface 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">G_028ABC_LINEAR</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* pitch must be 16 htiles aligned == 16 * 8 pixel aligned */</span>
		<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="cm">/* height is npipes htiles aligned == npipes * 8 pixel aligned */</span>
		<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">nbx</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nbx</span><span class="p">,</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">nby</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">nby</span><span class="p">,</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid num pipes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* compute number of htile */</span>
	<span class="n">nbx</span> <span class="o">=</span> <span class="n">nbx</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">nby</span> <span class="o">=</span> <span class="n">nby</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">nbx</span> <span class="o">*</span> <span class="n">nby</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d htile surface too small %ld for %ld (%d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span><span class="p">),</span>
				<span class="n">size</span><span class="p">,</span> <span class="n">nbx</span><span class="p">,</span> <span class="n">nby</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_track_validate_stencil</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eg_surface</span> <span class="n">surf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">slice</span><span class="p">,</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mslice</span> <span class="o">=</span> <span class="n">G_028008_SLICE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_view</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="n">G_028058_PITCH_TILE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">);</span>
	<span class="n">slice</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="p">((</span><span class="n">slice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">G_028040_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">G_028044_FORMAT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">tsplit</span> <span class="o">=</span> <span class="n">G_028044_TILE_SPLIT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">G_028040_NUM_BANKS</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankw</span> <span class="o">=</span> <span class="n">G_028040_BANK_WIDTH</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankh</span> <span class="o">=</span> <span class="n">G_028040_BANK_HEIGHT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mtilea</span> <span class="o">=</span> <span class="n">G_028040_MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil invalid format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* replace by color format so we can use same code */</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">V_028C70_COLOR_8</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_value_conv_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;stencil&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* old userspace doesn&#39;t compute proper depth/stencil alignment</span>
<span class="cm">		 * check that alignment against a bigger byte per elements and</span>
<span class="cm">		 * only report if that alignment is wrong too.</span>
<span class="cm">		 */</span>
		<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">V_028C70_COLOR_8_8_8_8</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;stencil&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil invalid (0x%08x 0x%08x 0x%08x 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">,</span>
				 <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_info</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">base_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil read bo base %ld not aligned with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_bo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil read bo too small (layer size %d, &quot;</span>
			 <span class="s">&quot;offset %ld, max layer %d, bo size %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span>
			<span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_bo</span><span class="p">));</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil invalid (0x%08x 0x%08x 0x%08x 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">,</span>
			 <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_info</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">base_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil write bo base %ld not aligned with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_bo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil write bo too small (layer size %d, &quot;</span>
			 <span class="s">&quot;offset %ld, max layer %d, bo size %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span>
			<span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_bo</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hyperz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">G_028040_TILE_SURFACE_ENABLE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_validate_htile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_track_validate_depth</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eg_surface</span> <span class="n">surf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">slice</span><span class="p">,</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mslice</span> <span class="o">=</span> <span class="n">G_028008_SLICE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_view</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="n">G_028058_PITCH_TILE_MAX</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">);</span>
	<span class="n">slice</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="p">((</span><span class="n">slice</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">G_028040_ARRAY_MODE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">G_028040_FORMAT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">tsplit</span> <span class="o">=</span> <span class="n">G_028040_TILE_SPLIT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">G_028040_NUM_BANKS</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankw</span> <span class="o">=</span> <span class="n">G_028040_BANK_WIDTH</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankh</span> <span class="o">=</span> <span class="n">G_028040_BANK_HEIGHT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mtilea</span> <span class="o">=</span> <span class="n">G_028040_MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V_028040_Z_16</span>:
		<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">V_028C70_COLOR_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_028040_Z_24</span>:
	<span class="k">case</span> <span class="n">V_028040_Z_32_FLOAT</span>:
		<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">V_028C70_COLOR_8_8_8_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d depth invalid format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_value_conv_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;depth&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d depth invalid (0x%08x 0x%08x 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">,</span>
			 <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;depth&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d depth invalid (0x%08x 0x%08x 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span><span class="p">,</span>
			 <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">base_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil read bo base %ld not aligned with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_bo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d depth read bo too small (layer size %d, &quot;</span>
			 <span class="s">&quot;offset %ld, max layer %d, bo size %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span>
			<span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_bo</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">base_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d stencil write bo base %ld not aligned with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">offset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_bo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d depth write bo too small (layer size %d, &quot;</span>
			 <span class="s">&quot;offset %ld, max layer %d, bo size %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span>
			<span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_bo</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hyperz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">G_028040_TILE_SURFACE_ENABLE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_validate_htile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_track_validate_texture</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">texture</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">mipmap</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eg_surface</span> <span class="n">surf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">toffset</span><span class="p">,</span> <span class="n">moffset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dim</span><span class="p">,</span> <span class="n">llevel</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">texdw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">texdw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">texdw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">texdw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">texdw</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">texdw</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">texdw</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">texdw</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">dim</span> <span class="o">=</span> <span class="n">G_030000_DIM</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">llevel</span> <span class="o">=</span> <span class="n">G_030014_LAST_LEVEL</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">mslice</span> <span class="o">=</span> <span class="n">G_030014_LAST_ARRAY</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">G_030000_TEX_WIDTH</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span>  <span class="n">G_030004_TEX_HEIGHT</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">depth</span> <span class="o">=</span> <span class="n">G_030004_TEX_DEPTH</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">G_03001C_DATA_FORMAT</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_030000_PITCH</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">=</span> <span class="n">r600_fmt_get_nblocksx</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="n">r600_fmt_get_nblocksy</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">G_030004_ARRAY_MODE</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">tsplit</span> <span class="o">=</span> <span class="n">G_030018_TILE_SPLIT</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nbanks</span> <span class="o">=</span> <span class="n">G_03001C_NUM_BANKS</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankw</span> <span class="o">=</span> <span class="n">G_03001C_BANK_WIDTH</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">bankh</span> <span class="o">=</span> <span class="n">G_03001C_BANK_HEIGHT</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">mtilea</span> <span class="o">=</span> <span class="n">G_03001C_MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">texdw</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">toffset</span> <span class="o">=</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">moffset</span> <span class="o">=</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r600_fmt_is_valid_texture</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d texture invalid format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V_030000_SQ_TEX_DIM_1D</span>:
	<span class="k">case</span> <span class="n">V_030000_SQ_TEX_DIM_2D</span>:
	<span class="k">case</span> <span class="n">V_030000_SQ_TEX_DIM_CUBEMAP</span>:
	<span class="k">case</span> <span class="n">V_030000_SQ_TEX_DIM_1D_ARRAY</span>:
	<span class="k">case</span> <span class="n">V_030000_SQ_TEX_DIM_2D_ARRAY</span>:
		<span class="n">depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V_030000_SQ_TEX_DIM_3D</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d texture invalid dimension %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">dim</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_value_conv_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;texture&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* align height */</span>
	<span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">halign</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;texture&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d texture invalid 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			 <span class="n">texdw</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">texdw</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check texture size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">toffset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">base_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d texture bo base %ld not aligned with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">toffset</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">moffset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">base_align</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d mipmap bo base %ld not aligned with %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">moffset</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">base_align</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dim</span> <span class="o">==</span> <span class="n">SQ_TEX_DIM_3D</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">toffset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">depth</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">toffset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">toffset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">texture</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d texture bo too small (layer size %d, &quot;</span>
			 <span class="s">&quot;offset %ld, max layer %d, depth %d, bo size %ld) (%d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">texdw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span>
			<span class="n">depth</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">texture</span><span class="p">),</span>
			<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check mipmap size */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">llevel</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

		<span class="n">w</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">r600_mip_minify</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">=</span> <span class="n">r600_fmt_get_nblocksx</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">,</span> <span class="n">w</span><span class="p">);</span>
		<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="n">r600_fmt_get_nblocksy</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">format</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ARRAY_2D_TILED_THIN1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">&lt;</span> <span class="n">surf</span><span class="p">.</span><span class="n">palign</span> <span class="o">||</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">&lt;</span> <span class="n">surf</span><span class="p">.</span><span class="n">halign</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">surf</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ARRAY_1D_TILED_THIN1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* recompute alignment */</span>
			<span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ARRAY_LINEAR_GENERAL</span>:
		<span class="k">case</span> <span class="n">ARRAY_LINEAR_ALIGNED</span>:
		<span class="k">case</span> <span class="n">ARRAY_1D_TILED_THIN1</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid array mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">surf</span><span class="p">.</span><span class="n">nbx</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">palign</span><span class="p">);</span>
		<span class="n">surf</span><span class="p">.</span><span class="n">nby</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">halign</span><span class="p">);</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_surface_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">surf</span><span class="p">,</span> <span class="s">&quot;mipmap&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dim</span> <span class="o">==</span> <span class="n">SQ_TEX_DIM_3D</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">moffset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">moffset</span> <span class="o">+=</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span> <span class="o">*</span> <span class="n">mslice</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">moffset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">mipmap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d mipmap [%d] bo too small (layer size %d, &quot;</span>
					<span class="s">&quot;offset %ld, coffset %ld, max layer %d, depth %d, &quot;</span>
					<span class="s">&quot;bo size %ld) level0 (%d %d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">layer_size</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">texdw</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">moffset</span><span class="p">,</span> <span class="n">mslice</span><span class="p">,</span>
					<span class="n">d</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">mipmap</span><span class="p">),</span>
					<span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d problematic surf: (%d %d) (%d %d %d %d %d %d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nbx</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nby</span><span class="p">,</span>
				<span class="n">surf</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">bpe</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">nsamples</span><span class="p">,</span>
				<span class="n">surf</span><span class="p">.</span><span class="n">bankw</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">bankh</span><span class="p">,</span>
				<span class="n">surf</span><span class="p">.</span><span class="n">tsplit</span><span class="p">,</span> <span class="n">surf</span><span class="p">.</span><span class="n">mtilea</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_track_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">buffer_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check streamout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">&amp;&amp;</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_config</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">buffer_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_buffer_config</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">u64</span> <span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
							<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_size</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
						<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;streamout %d bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							  <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
							  <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No buffer for streamout %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">sx_misc_kill_all_prims</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check that we have a cb for each enabled target</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* at least one component is enabled */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d mask 0x%08X | 0x%08X no cb for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span><span class="p">,</span> <span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_shader_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* check cb */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_validate_cb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check stencil buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">G_028800_STENCIL_ENABLE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_validate_stencil</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check depth buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">G_028800_Z_ENABLE</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_validate_depth</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * evergreen_cs_packet_parse() - parse cp packet and point ib index to next packet</span>
<span class="cm"> * @parser:	parser structure holding parsing context.</span>
<span class="cm"> * @pkt:	where to store packet informations</span>
<span class="cm"> *</span>
<span class="cm"> * Assume that chunk_ib_index is properly set. Will return -EINVAL</span>
<span class="cm"> * if packet is bigger than remaining ib size. or if packets is unknown.</span>
<span class="cm"> **/</span>
<span class="kt">int</span> <span class="nf">evergreen_cs_packet_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_chunk</span> <span class="o">*</span><span class="n">ib_chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_ib_idx</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Can not parse packet at %d after CS end %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">idx</span><span class="p">,</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">header</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CP_PACKET_GET_TYPE</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">CP_PACKET_GET_COUNT</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">one_reg_wr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET_TYPE0</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">CP_PACKET0_GET_REG</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_TYPE3</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">CP_PACKET3_GET_OPCODE</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET_TYPE2</span>:
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown packet type %d at %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet (%d:%d:%d) end after CS buffer (%d) !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="n">ib_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * evergreen_cs_packet_next_reloc() - parse next packet which should be reloc packet3</span>
<span class="cm"> * @parser:		parser structure holding parsing context.</span>
<span class="cm"> * @data:		pointer to relocation data</span>
<span class="cm"> * @offset_start:	starting offset</span>
<span class="cm"> * @offset_mask:	offset mask (to align start offset on)</span>
<span class="cm"> * @reloc:		reloc informations</span>
<span class="cm"> *</span>
<span class="cm"> * Check next packet is relocation packet3, do bo validation and compute</span>
<span class="cm"> * GPU offset using the provided start.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">**</span><span class="n">cs_reloc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_chunk</span> <span class="o">*</span><span class="n">relocs_chunk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">p3reloc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_relocs_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No relocation chunk !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">cs_reloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">relocs_chunk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_relocs_idx</span><span class="p">];</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p3reloc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p3reloc</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PACKET_TYPE3</span> <span class="o">||</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">PACKET3_NOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No packet3 for relocation for packet at %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">p3reloc</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Relocs at %d after relocations chunk end %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">idx</span><span class="p">,</span> <span class="n">relocs_chunk</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* FIXME: we assume reloc size is 4 dwords */</span>
	<span class="o">*</span><span class="n">cs_reloc</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">relocs_ptr</span><span class="p">[(</span><span class="n">idx</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * evergreen_cs_packet_next_vline() - parse userspace VLINE packet</span>
<span class="cm"> * @parser:		parser structure holding parsing context.</span>
<span class="cm"> *</span>
<span class="cm"> * Userspace sends a special sequence for VLINE waits.</span>
<span class="cm"> * PACKET0 - VLINE_START_END + value</span>
<span class="cm"> * PACKET3 - WAIT_REG_MEM poll vline status reg</span>
<span class="cm"> * RELOC (P3) - crtc_id in reloc.</span>
<span class="cm"> *</span>
<span class="cm"> * This function parses this and relocates the VLINE START END</span>
<span class="cm"> * and WAIT_REG_MEM packets to the correct crtc.</span>
<span class="cm"> * It also detects a switched off crtc and nulls out the</span>
<span class="cm"> * wait in that case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_packet_parse_vline</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_crtc</span> <span class="o">*</span><span class="n">radeon_crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">p3reloc</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crtc_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">header</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">wait_reg_mem_info</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">ib</span><span class="p">;</span>

	<span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* parse the WAIT_REG_MEM */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait_reg_mem</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* check its a WAIT_REG_MEM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">PACKET_TYPE3</span> <span class="o">||</span>
	    <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">opcode</span> <span class="o">!=</span> <span class="n">PACKET3_WAIT_REG_MEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline wait missing WAIT_REG_MEM segment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wait_reg_mem_info</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* bit 4 is reg (0) or mem (1) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_reg_mem_info</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM waiting on MEM rather than REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* waiting for value to be equal */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wait_reg_mem_info</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM function not equal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EVERGREEN_VLINE_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM bad reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EVERGREEN_VLINE_STAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;vline WAIT_REG_MEM bad bit mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* jump over the NOP */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p3reloc</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">h_idx</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">wait_reg_mem</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">p3reloc</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">h_idx</span><span class="p">);</span>
	<span class="n">crtc_id</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">h_idx</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">CP_PACKET0_GET_REG</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">,</span> <span class="n">crtc_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;cannot find crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">radeon_crtc</span> <span class="o">=</span> <span class="n">to_radeon_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">crtc_id</span> <span class="o">=</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if the CRTC isn&#39;t enabled - we need to nop out the WAIT_REG_MEM */</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">PACKET2</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">EVERGREEN_VLINE_START_END</span>:
			<span class="n">header</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">R600_CP_PACKET0_REG_MASK</span><span class="p">;</span>
			<span class="n">header</span> <span class="o">|=</span> <span class="p">(</span><span class="n">EVERGREEN_VLINE_START_END</span> <span class="o">+</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">EVERGREEN_VLINE_STATUS</span> <span class="o">+</span> <span class="n">radeon_crtc</span><span class="o">-&gt;</span><span class="n">crtc_offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;unknown crtc reloc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_packet0_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EVERGREEN_VLINE_START_END</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_parse_vline</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No reloc for ib[%d]=0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Forbidden register 0x%04X in cs at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_parse_packet0</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">idx</span><span class="o">++</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_packet0_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * evergreen_cs_check_reg() - check if register is authorized or not</span>
<span class="cm"> * @parser: parser structure holding parsing context</span>
<span class="cm"> * @reg: register we are testing</span>
<span class="cm"> * @idx: index into the cs buffer</span>
<span class="cm"> *</span>
<span class="cm"> * This function will test against evergreen_reg_safe_bm and return 0</span>
<span class="cm"> * if register is safe. If register is not flag as safe this function</span>
<span class="cm"> * will test it against a list of register needind special handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_cs_check_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">*</span><span class="n">reloc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">ib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
		<span class="n">last_reg</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cayman_reg_safe_bm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">last_reg</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">evergreen_reg_safe_bm</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">last_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cayman_reg_safe_bm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">evergreen_reg_safe_bm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* force following reg to 0 in an attempt to disable out buffer</span>
<span class="cm">	 * which will need us to better understand how it works to perform</span>
<span class="cm">	 * security check on it (Jerome)</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">SQ_ESGS_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_ESTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_HSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_LSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_PSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_VSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_ESGS_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_ESTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE_1</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE_2</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE_3</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_OFFSET_1</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_OFFSET_2</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_OFFSET_3</span>:
	<span class="k">case</span> <span class="n">SQ_HSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_LSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_PSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_VSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">VGT_TF_RING_SIZE</span>:
		<span class="cm">/* get value to populate the IB don&#39;t remove */</span>
		<span class="cm">/*tmp =radeon_get_ib_value(p, idx);</span>
<span class="cm">		  ib[idx] = 0;*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SQ_ESGS_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_ESTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_GSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_HSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_LSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_PSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_VSTMP_RING_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_DEPTH_CONTROL</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_control</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAYMAN_DB_EQAA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
				 <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAYMAN_DB_DEPTH_INFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
				 <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_Z_INFO</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
						<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Z_ARRAY_MODE</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Z_ARRAY_MODE</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">Z_ARRAY_MODE</span><span class="p">(</span><span class="n">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">));</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_info</span> <span class="o">|=</span> <span class="n">Z_ARRAY_MODE</span><span class="p">(</span><span class="n">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">bankw</span><span class="p">,</span> <span class="n">bankh</span><span class="p">,</span> <span class="n">mtaspect</span><span class="p">,</span> <span class="n">tile_split</span><span class="p">;</span>

				<span class="n">evergreen_tiling_fields</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">bankw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bankh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtaspect</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tile_split</span><span class="p">);</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DB_NUM_BANKS</span><span class="p">(</span><span class="n">evergreen_cs_get_num_banks</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">));</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DB_TILE_SPLIT</span><span class="p">(</span><span class="n">tile_split</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">DB_BANK_WIDTH</span><span class="p">(</span><span class="n">bankw</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">DB_BANK_HEIGHT</span><span class="p">(</span><span class="n">bankh</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">DB_MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">mtaspect</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_STENCIL_INFO</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_info</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_DEPTH_VIEW</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_view</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_DEPTH_SIZE</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_size</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">R_02805C_DB_DEPTH_SLICE</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_depth_slice</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_Z_READ_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_read_bo</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_Z_WRITE_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_z_write_bo</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_STENCIL_READ_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_read_bo</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_STENCIL_WRITE_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_s_write_bo</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VGT_STRMOUT_CONFIG</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_config</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_CONFIG</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_buffer_config</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_0</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_1</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_2</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_3</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">VGT_STRMOUT_BUFFER_BASE_0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo_offset</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_0</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_1</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_2</span>:
	<span class="k">case</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_3</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">VGT_STRMOUT_BUFFER_SIZE_0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="cm">/* size in register is DWs, convert to bytes */</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">vgt_strmout_size</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">streamout_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CP_COHER_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;missing reloc for CP_COHER_BASE &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CB_TARGET_MASK</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_target_mask</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_SHADER_MASK</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_shader_mask</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PA_SC_AA_CONFIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
				 <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MSAA_NUM_SAMPLES_MASK</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAYMAN_PA_SC_AA_CONFIG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
				 <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CAYMAN_MSAA_NUM_SAMPLES_MASK</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">nsamples</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_VIEW</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_VIEW</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR8_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR9_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR10_VIEW</span>:
	<span class="k">case</span> <span class="n">CB_COLOR11_VIEW</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR8_VIEW</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_view</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_INFO</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_INFO</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
						<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_ARRAY_MODE</span><span class="p">(</span><span class="n">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">));</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_ARRAY_MODE</span><span class="p">(</span><span class="n">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR8_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR9_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR10_INFO</span>:
	<span class="k">case</span> <span class="n">CB_COLOR11_INFO</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR8_INFO</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
						<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_ARRAY_MODE</span><span class="p">(</span><span class="n">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">));</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_info</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_ARRAY_MODE</span><span class="p">(</span><span class="n">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_PITCH</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_PITCH</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_pitch</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR8_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR9_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR10_PITCH</span>:
	<span class="k">case</span> <span class="n">CB_COLOR11_PITCH</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR8_PITCH</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_pitch</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_SLICE</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_SLICE</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice_idx</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR8_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR9_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR10_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR11_SLICE</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR8_SLICE</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_slice_idx</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_ATTRIB</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">bankw</span><span class="p">,</span> <span class="n">bankh</span><span class="p">,</span> <span class="n">mtaspect</span><span class="p">,</span> <span class="n">tile_split</span><span class="p">;</span>

				<span class="n">evergreen_tiling_fields</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">bankw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bankh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtaspect</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tile_split</span><span class="p">);</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_NUM_BANKS</span><span class="p">(</span><span class="n">evergreen_cs_get_num_banks</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">));</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_TILE_SPLIT</span><span class="p">(</span><span class="n">tile_split</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">CB_BANK_WIDTH</span><span class="p">(</span><span class="n">bankw</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">CB_BANK_HEIGHT</span><span class="p">(</span><span class="n">bankh</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">CB_MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">mtaspect</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_ATTRIB</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR8_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR9_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR10_ATTRIB</span>:
	<span class="k">case</span> <span class="n">CB_COLOR11_ATTRIB</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">bankw</span><span class="p">,</span> <span class="n">bankh</span><span class="p">,</span> <span class="n">mtaspect</span><span class="p">,</span> <span class="n">tile_split</span><span class="p">;</span>

				<span class="n">evergreen_tiling_fields</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">bankw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bankh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtaspect</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tile_split</span><span class="p">);</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_NUM_BANKS</span><span class="p">(</span><span class="n">evergreen_cs_get_num_banks</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">));</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CB_TILE_SPLIT</span><span class="p">(</span><span class="n">tile_split</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">CB_BANK_WIDTH</span><span class="p">(</span><span class="n">bankw</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">CB_BANK_HEIGHT</span><span class="p">(</span><span class="n">bankh</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">CB_MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">mtaspect</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR8_ATTRIB</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_attrib</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_FMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_FMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_FMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_FMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_FMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_FMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_FMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_FMASK</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_FMASK</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_fmask_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_CMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_CMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_CMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_CMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_CMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_CMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_CMASK</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_CMASK</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_CMASK</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_cmask_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_FMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_FMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_FMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_FMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_FMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_FMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_FMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_FMASK_SLICE</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_FMASK_SLICE</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_fmask_slice</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_CMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_CMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_CMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_CMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_CMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_CMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_CMASK_SLICE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_CMASK_SLICE</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_CMASK_SLICE</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_cmask_slice</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR0_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR1_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR2_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR3_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR4_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR5_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR6_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR7_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR0_BASE</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x3c</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_COLOR8_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR9_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR10_BASE</span>:
	<span class="k">case</span> <span class="n">CB_COLOR11_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span> <span class="o">-</span> <span class="n">CB_COLOR8_BASE</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo_offset</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_color_bo</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">cb_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_HTILE_DATA_BASE</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_bo</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_HTILE_SURFACE</span>:
		<span class="cm">/* 8x8 only */</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">htile_surface</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">db_dirty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CB_IMMED0_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED1_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED2_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED3_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED4_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED5_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED6_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED7_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED8_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED9_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED10_BASE</span>:
	<span class="k">case</span> <span class="n">CB_IMMED11_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_FS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_ES</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_VS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_GS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_PS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_HS</span>:
	<span class="k">case</span> <span class="n">SQ_PGM_START_LS</span>:
	<span class="k">case</span> <span class="n">SQ_CONST_MEM_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_GS_15</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_PS_15</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_VS_15</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_HS_15</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_0</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_1</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_2</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_3</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_4</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_5</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_6</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_7</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_8</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_9</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_10</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_11</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_12</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_13</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_14</span>:
	<span class="k">case</span> <span class="n">SQ_ALU_CONST_CACHE_LS_15</span>:
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SX_MEMORY_EXPORT_BASE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONFIG_REG &quot;</span>
				 <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONFIG_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAYMAN_SX_SCATTER_EXPORT_BASE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
				 <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad SET_CONTEXT_REG &quot;</span>
					<span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SX_MISC</span>:
		<span class="n">track</span><span class="o">-&gt;</span><span class="n">sx_misc_kill_all_prims</span> <span class="o">=</span> <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">evergreen_is_safe_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">last_reg</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
		<span class="n">last_reg</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cayman_reg_safe_bm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">last_reg</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">evergreen_reg_safe_bm</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">last_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cayman_reg_safe_bm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">evergreen_reg_safe_bm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forbidden register 0x%08x at %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_packet3_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_reloc</span> <span class="o">*</span><span class="n">reloc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ib</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">start_reg</span><span class="p">,</span> <span class="n">end_reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx_value</span><span class="p">;</span>

	<span class="n">track</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">;</span>
	<span class="n">ib</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ib</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">idx_value</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_PREDICATION</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pred_op</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET PREDICATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pred_op</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="cm">/* for the clear predicate operation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pred_op</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pred_op</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET PREDICATION operation %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pred_op</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET PREDICATION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0xfffffff0</span><span class="p">)</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_CONTEXT_CONTROL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad CONTEXT_CONTROL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_INDEX_TYPE</span>:
	<span class="k">case</span> <span class="n">PACKET3_NUM_INSTANCES</span>:
	<span class="k">case</span> <span class="n">PACKET3_CLEAR_STATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad INDEX_TYPE/NUM_INSTANCES/CLEAR_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CAYMAN_PACKET3_DEALLOC_STATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&lt;</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad PACKET3_DEALLOC_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad INDEX_TYPE/NUM_INSTANCES/CLEAR_STATE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_INDEX_BASE</span>:
	<span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad INDEX_BASE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad INDEX_BASE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="n">idx_value</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX</span>:
	<span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="n">idx_value</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_2</span>:
	<span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_AUTO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_MULTI_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_MULTI_AUTO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_IMMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_IMMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_OFFSET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_OFFSET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_OFFSET_2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DRAW_INDEX_OFFSET_2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DISPATCH_DIRECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DISPATCH_DIRECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_DISPATCH_INDIRECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DISPATCH_INDIRECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad DISPATCH_INDIRECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_value</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_check</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s:%d invalid cmd stream</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_WAIT_REG_MEM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad WAIT_REG_MEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* bit 4 is reg (0) or mem (1) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad WAIT_REG_MEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
			         <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">)</span> <span class="o">+</span>
			         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">);</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SURFACE_SYNC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SURFACE_SYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* 0xffffffff/0x0 is flush all cache flag */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffffffff</span> <span class="o">||</span>
		    <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SURFACE_SYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
			         <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffff8</span><span class="p">)</span> <span class="o">+</span>
			         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfffffff8</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE_EOP</span>:
	<span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE_EOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE_EOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">)</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE_EOS</span>:
	<span class="p">{</span>
		<span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE_EOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad EVENT_WRITE_EOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span>
		         <span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">)</span> <span class="o">+</span>
		         <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xfffffffc</span><span class="p">;</span>
		<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_CONFIG_REG</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_CONFIG_REG_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_CONFIG_REG_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONFIG_REG_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONFIG_REG_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad PACKET3_SET_CONFIG_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">start_reg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_check_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_CONTEXT_REG</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_CONTEXT_REG_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_CONTEXT_REG_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONTEXT_REG_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONTEXT_REG_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad PACKET3_SET_CONTEXT_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">start_reg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_check_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_RESOURCE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_RESOURCE_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_RESOURCE_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_RESOURCE_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_RESOURCE_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">radeon_bo</span> <span class="o">*</span><span class="n">texture</span><span class="p">,</span> <span class="o">*</span><span class="n">mipmap</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">toffset</span><span class="p">,</span> <span class="n">moffset</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">G__SQ_CONSTANT_TYPE</span><span class="p">(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">7</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_VALID_TEXTURE</span>:
				<span class="cm">/* tex base */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE (tex)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cs_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_CS_KEEP_TILING_FLAGS</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span>
						<span class="n">TEX_ARRAY_MODE</span><span class="p">(</span><span class="n">evergreen_cs_get_aray_mode</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">));</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span> <span class="o">&amp;</span> <span class="n">RADEON_TILING_MACRO</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">unsigned</span> <span class="n">bankw</span><span class="p">,</span> <span class="n">bankh</span><span class="p">,</span> <span class="n">mtaspect</span><span class="p">,</span> <span class="n">tile_split</span><span class="p">;</span>

						<span class="n">evergreen_tiling_fields</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">tiling_flags</span><span class="p">,</span>
									<span class="o">&amp;</span><span class="n">bankw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bankh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mtaspect</span><span class="p">,</span>
									<span class="o">&amp;</span><span class="n">tile_split</span><span class="p">);</span>
						<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TEX_TILE_SPLIT</span><span class="p">(</span><span class="n">tile_split</span><span class="p">);</span>
						<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">7</span><span class="p">]</span> <span class="o">|=</span>
							<span class="n">TEX_BANK_WIDTH</span><span class="p">(</span><span class="n">bankw</span><span class="p">)</span> <span class="o">|</span>
							<span class="n">TEX_BANK_HEIGHT</span><span class="p">(</span><span class="n">bankh</span><span class="p">)</span> <span class="o">|</span>
							<span class="n">MACRO_TILE_ASPECT</span><span class="p">(</span><span class="n">mtaspect</span><span class="p">)</span> <span class="o">|</span>
							<span class="n">TEX_NUM_BANKS</span><span class="p">(</span><span class="n">evergreen_cs_get_num_banks</span><span class="p">(</span><span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">texture</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
				<span class="n">toffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
				<span class="cm">/* tex mip base */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE (tex)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">moffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
				<span class="n">mipmap</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">;</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_track_validate_texture</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">texture</span><span class="p">,</span> <span class="n">mipmap</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">toffset</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">moffset</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_VALID_BUFFER</span>:
			<span class="p">{</span>
				<span class="kt">uint64_t</span> <span class="n">offset64</span><span class="p">;</span>
				<span class="cm">/* vtx base */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE (vtx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* force size to size of the buffer */</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vbo resource seems too big for the bo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">offset64</span> <span class="o">=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset64</span><span class="p">;</span>
				<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">)</span> <span class="o">|</span>
						    <span class="p">(</span><span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset64</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_INVALID_TEXTURE</span>:
			<span class="k">case</span> <span class="n">SQ_TEX_VTX_INVALID_BUFFER</span>:
			<span class="nl">default:</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_RESOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_ALU_CONST</span>:
		<span class="cm">/* XXX fix me ALU const buffers only */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_BOOL_CONST</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_BOOL_CONST_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_BOOL_CONST_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_BOOL_CONST_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_BOOL_CONST_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_BOOL_CONST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_LOOP_CONST</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_LOOP_CONST_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_LOOP_CONST_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_LOOP_CONST_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_LOOP_CONST_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_LOOP_CONST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_CTL_CONST</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_CTL_CONST_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_CTL_CONST_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CTL_CONST_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CTL_CONST_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_CTL_CONST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_SAMPLER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_SAMPLER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_SAMPLER_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_SAMPLER_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_SAMPLER_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_SAMPLER_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad SET_SAMPLER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_STRMOUT_BUFFER_UPDATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE (invalid count)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Updating memory at DST_ADDRESS. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE (missing dst reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE dst bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Reading data from SRC_ADDRESS. */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">idx_value</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE (missing src reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad STRMOUT_BUFFER_UPDATE src bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_COPY_DW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW (invalid count)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="cm">/* SRC is memory. */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW (missing src reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW src bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* SRC is a reg. */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evergreen_is_safe_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u64</span> <span class="n">offset</span><span class="p">;</span>
			<span class="cm">/* DST is memory. */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_next_reloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reloc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW (missing dst reloc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad COPY_DW dst bo too small: 0x%llx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">radeon_bo_size</span><span class="p">(</span><span class="n">reloc</span><span class="o">-&gt;</span><span class="n">robj</span><span class="p">));</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">reloc</span><span class="o">-&gt;</span><span class="n">lobj</span><span class="p">.</span><span class="n">gpu_offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DST is a reg. */</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">radeon_get_ib_value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evergreen_is_safe_reg</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_NOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Packet3 opcode %x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">evergreen_cs_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_cs_parser</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">evergreen_cs_track</span> <span class="o">*</span><span class="n">track</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize tracker, we are in kms */</span>
		<span class="n">track</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">track</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">track</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">evergreen_cs_track_init</span><span class="p">(</span><span class="n">track</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">CHIP_CAYMAN</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cayman</span><span class="p">.</span><span class="n">tile_config</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">evergreen</span><span class="p">.</span><span class="n">tile_config</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">npipes</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">nbanks</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">group_size</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">row_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">row_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">track</span><span class="o">-&gt;</span><span class="n">row_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="n">track</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_packet_parse</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="n">pkt</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE0</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_cs_parse_packet0</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE2</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE3</span>:
			<span class="n">r</span> <span class="o">=</span> <span class="n">evergreen_packet3_check</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown packet type %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">chunk_ib_idx</span><span class="p">].</span><span class="n">length_dw</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	for (r = 0; r &lt; p-&gt;ib.length_dw; r++) {</span>
<span class="c">		printk(KERN_INFO &quot;%05d  0x%08X\n&quot;, r, p-&gt;ib.ptr[r]);</span>
<span class="c">		mdelay(1);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">track</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* vm parser */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">evergreen_vm_reg_valid</span><span class="p">(</span><span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* context regs are fine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x28000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* check config regs */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GRBM_GFX_INDEX</span>:
	<span class="k">case</span> <span class="n">VGT_VTX_VECT_EJECT_REG</span>:
	<span class="k">case</span> <span class="n">VGT_CACHE_INVALIDATION</span>:
	<span class="k">case</span> <span class="n">VGT_GS_VERTEX_REUSE</span>:
	<span class="k">case</span> <span class="n">VGT_PRIMITIVE_TYPE</span>:
	<span class="k">case</span> <span class="n">VGT_INDEX_TYPE</span>:
	<span class="k">case</span> <span class="n">VGT_NUM_INDICES</span>:
	<span class="k">case</span> <span class="n">VGT_NUM_INSTANCES</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_DIM_X</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_DIM_Y</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_DIM_Z</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_START_X</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_START_Y</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_START_Z</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_INDEX</span>:
	<span class="k">case</span> <span class="n">VGT_COMPUTE_THREAD_GROUP_SIZE</span>:
	<span class="k">case</span> <span class="n">VGT_HS_OFFCHIP_PARAM</span>:
	<span class="k">case</span> <span class="n">PA_CL_ENHANCE</span>:
	<span class="k">case</span> <span class="n">PA_SU_LINE_STIPPLE_VALUE</span>:
	<span class="k">case</span> <span class="n">PA_SC_LINE_STIPPLE_STATE</span>:
	<span class="k">case</span> <span class="n">PA_SC_ENHANCE</span>:
	<span class="k">case</span> <span class="n">SQ_DYN_GPR_CNTL_PS_FLUSH_REQ</span>:
	<span class="k">case</span> <span class="n">SQ_DYN_GPR_SIMD_LOCK_EN</span>:
	<span class="k">case</span> <span class="n">SQ_CONFIG</span>:
	<span class="k">case</span> <span class="n">SQ_GPR_RESOURCE_MGMT_1</span>:
	<span class="k">case</span> <span class="n">SQ_GLOBAL_GPR_RESOURCE_MGMT_1</span>:
	<span class="k">case</span> <span class="n">SQ_GLOBAL_GPR_RESOURCE_MGMT_2</span>:
	<span class="k">case</span> <span class="n">SQ_CONST_MEM_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_STATIC_THREAD_MGMT_1</span>:
	<span class="k">case</span> <span class="n">SQ_STATIC_THREAD_MGMT_2</span>:
	<span class="k">case</span> <span class="n">SQ_STATIC_THREAD_MGMT_3</span>:
	<span class="k">case</span> <span class="n">SPI_CONFIG_CNTL</span>:
	<span class="k">case</span> <span class="n">SPI_CONFIG_CNTL_1</span>:
	<span class="k">case</span> <span class="n">TA_CNTL_AUX</span>:
	<span class="k">case</span> <span class="n">DB_DEBUG</span>:
	<span class="k">case</span> <span class="n">DB_DEBUG2</span>:
	<span class="k">case</span> <span class="n">DB_DEBUG3</span>:
	<span class="k">case</span> <span class="n">DB_DEBUG4</span>:
	<span class="k">case</span> <span class="n">DB_WATERMARKS</span>:
	<span class="k">case</span> <span class="n">TD_PS_BORDER_COLOR_INDEX</span>:
	<span class="k">case</span> <span class="n">TD_PS_BORDER_COLOR_RED</span>:
	<span class="k">case</span> <span class="n">TD_PS_BORDER_COLOR_GREEN</span>:
	<span class="k">case</span> <span class="n">TD_PS_BORDER_COLOR_BLUE</span>:
	<span class="k">case</span> <span class="n">TD_PS_BORDER_COLOR_ALPHA</span>:
	<span class="k">case</span> <span class="n">TD_VS_BORDER_COLOR_INDEX</span>:
	<span class="k">case</span> <span class="n">TD_VS_BORDER_COLOR_RED</span>:
	<span class="k">case</span> <span class="n">TD_VS_BORDER_COLOR_GREEN</span>:
	<span class="k">case</span> <span class="n">TD_VS_BORDER_COLOR_BLUE</span>:
	<span class="k">case</span> <span class="n">TD_VS_BORDER_COLOR_ALPHA</span>:
	<span class="k">case</span> <span class="n">TD_GS_BORDER_COLOR_INDEX</span>:
	<span class="k">case</span> <span class="n">TD_GS_BORDER_COLOR_RED</span>:
	<span class="k">case</span> <span class="n">TD_GS_BORDER_COLOR_GREEN</span>:
	<span class="k">case</span> <span class="n">TD_GS_BORDER_COLOR_BLUE</span>:
	<span class="k">case</span> <span class="n">TD_GS_BORDER_COLOR_ALPHA</span>:
	<span class="k">case</span> <span class="n">TD_HS_BORDER_COLOR_INDEX</span>:
	<span class="k">case</span> <span class="n">TD_HS_BORDER_COLOR_RED</span>:
	<span class="k">case</span> <span class="n">TD_HS_BORDER_COLOR_GREEN</span>:
	<span class="k">case</span> <span class="n">TD_HS_BORDER_COLOR_BLUE</span>:
	<span class="k">case</span> <span class="n">TD_HS_BORDER_COLOR_ALPHA</span>:
	<span class="k">case</span> <span class="n">TD_LS_BORDER_COLOR_INDEX</span>:
	<span class="k">case</span> <span class="n">TD_LS_BORDER_COLOR_RED</span>:
	<span class="k">case</span> <span class="n">TD_LS_BORDER_COLOR_GREEN</span>:
	<span class="k">case</span> <span class="n">TD_LS_BORDER_COLOR_BLUE</span>:
	<span class="k">case</span> <span class="n">TD_LS_BORDER_COLOR_ALPHA</span>:
	<span class="k">case</span> <span class="n">TD_CS_BORDER_COLOR_INDEX</span>:
	<span class="k">case</span> <span class="n">TD_CS_BORDER_COLOR_RED</span>:
	<span class="k">case</span> <span class="n">TD_CS_BORDER_COLOR_GREEN</span>:
	<span class="k">case</span> <span class="n">TD_CS_BORDER_COLOR_BLUE</span>:
	<span class="k">case</span> <span class="n">TD_CS_BORDER_COLOR_ALPHA</span>:
	<span class="k">case</span> <span class="n">SQ_ESGS_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_ESTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_HSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_LSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_PSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_VSTMP_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_ESGS_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_ESTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE_1</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE_2</span>:
	<span class="k">case</span> <span class="n">SQ_GS_VERT_ITEMSIZE_3</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_OFFSET_1</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_OFFSET_2</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_OFFSET_3</span>:
	<span class="k">case</span> <span class="n">SQ_HSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_LSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_PSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">SQ_VSTMP_RING_ITEMSIZE</span>:
	<span class="k">case</span> <span class="n">VGT_TF_RING_SIZE</span>:
	<span class="k">case</span> <span class="n">SQ_ESGS_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_GSVS_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_ESTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_GSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_HSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_LSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_PSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">SQ_VSTMP_RING_BASE</span>:
	<span class="k">case</span> <span class="n">CAYMAN_VGT_OFFCHIP_LDS_BASE</span>:
	<span class="k">case</span> <span class="n">CAYMAN_SQ_EX_ALLOC_TABLE_SLOTS</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">evergreen_vm_packet3_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="o">*</span><span class="n">ib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx_value</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">start_reg</span><span class="p">,</span> <span class="n">end_reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PACKET3_NOP</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_BASE</span>:
	<span class="k">case</span> <span class="n">PACKET3_CLEAR_STATE</span>:
	<span class="k">case</span> <span class="n">PACKET3_INDEX_BUFFER_SIZE</span>:
	<span class="k">case</span> <span class="n">PACKET3_DISPATCH_DIRECT</span>:
	<span class="k">case</span> <span class="n">PACKET3_DISPATCH_INDIRECT</span>:
	<span class="k">case</span> <span class="n">PACKET3_MODE_CONTROL</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_PREDICATION</span>:
	<span class="k">case</span> <span class="n">PACKET3_COND_EXEC</span>:
	<span class="k">case</span> <span class="n">PACKET3_PRED_EXEC</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDIRECT</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_INDIRECT</span>:
	<span class="k">case</span> <span class="n">PACKET3_INDEX_BASE</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_2</span>:
	<span class="k">case</span> <span class="n">PACKET3_CONTEXT_CONTROL</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_OFFSET</span>:
	<span class="k">case</span> <span class="n">PACKET3_INDEX_TYPE</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_AUTO</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_IMMD</span>:
	<span class="k">case</span> <span class="n">PACKET3_NUM_INSTANCES</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_MULTI_AUTO</span>:
	<span class="k">case</span> <span class="n">PACKET3_STRMOUT_BUFFER_UPDATE</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_OFFSET_2</span>:
	<span class="k">case</span> <span class="n">PACKET3_DRAW_INDEX_MULTI_ELEMENT</span>:
	<span class="k">case</span> <span class="n">PACKET3_MPEG_INDEX</span>:
	<span class="k">case</span> <span class="n">PACKET3_WAIT_REG_MEM</span>:
	<span class="k">case</span> <span class="n">PACKET3_MEM_WRITE</span>:
	<span class="k">case</span> <span class="n">PACKET3_SURFACE_SYNC</span>:
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE</span>:
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE_EOP</span>:
	<span class="k">case</span> <span class="n">PACKET3_EVENT_WRITE_EOS</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_CONTEXT_REG</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_BOOL_CONST</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_LOOP_CONST</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_RESOURCE</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_SAMPLER</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_CTL_CONST</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_RESOURCE_OFFSET</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_CONTEXT_REG_INDIRECT</span>:
	<span class="k">case</span> <span class="n">PACKET3_SET_RESOURCE_INDIRECT</span>:
	<span class="k">case</span> <span class="n">CAYMAN_PACKET3_DEALLOC_STATE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_COND_WRITE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evergreen_vm_reg_valid</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_COPY_DW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">ib</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evergreen_vm_reg_valid</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PACKET3_SET_CONFIG_REG</span>:
		<span class="n">start_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx_value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">PACKET3_SET_CONFIG_REG_START</span><span class="p">;</span>
		<span class="n">end_reg</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">start_reg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">start_reg</span> <span class="o">&lt;</span> <span class="n">PACKET3_SET_CONFIG_REG_START</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">start_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONFIG_REG_END</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">end_reg</span> <span class="o">&gt;=</span> <span class="n">PACKET3_SET_CONFIG_REG_END</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad PACKET3_SET_CONFIG_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">start_reg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">evergreen_vm_reg_valid</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">evergreen_ib_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">radeon_device</span> <span class="o">*</span><span class="n">rdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">radeon_ib</span> <span class="o">*</span><span class="n">ib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">radeon_cs_packet</span> <span class="n">pkt</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">pkt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CP_PACKET_GET_TYPE</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="n">pkt</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">CP_PACKET_GET_COUNT</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="n">pkt</span><span class="p">.</span><span class="n">one_reg_wr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE0</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Packet0 not allowed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE2</span>:
			<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PACKET_TYPE3</span>:
			<span class="n">pkt</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">CP_PACKET3_GET_OPCODE</span><span class="p">(</span><span class="n">ib</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">evergreen_vm_packet3_check</span><span class="p">(</span><span class="n">rdev</span><span class="p">,</span> <span class="n">ib</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="n">pkt</span><span class="p">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown packet type %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ib</span><span class="o">-&gt;</span><span class="n">length_dw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
