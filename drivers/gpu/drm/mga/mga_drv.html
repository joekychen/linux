<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › mga › mga_drv.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mga_drv.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* mga_drv.h -- Private header for the Matrox G200/G400 driver -*- linux-c -*-</span>
<span class="cm"> * Created: Mon Dec 13 01:50:01 1999 by jhartmann@precisioninsight.com</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1999 Precision Insight, Inc., Cedar Park, Texas.</span>
<span class="cm"> * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Gareth Hughes &lt;gareth@valinux.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __MGA_DRV_H__</span>
<span class="cp">#define __MGA_DRV_H__</span>

<span class="cm">/* General customization:</span>
<span class="cm"> */</span>

<span class="cp">#define DRIVER_AUTHOR		&quot;Gareth Hughes, VA Linux Systems Inc.&quot;</span>

<span class="cp">#define DRIVER_NAME		&quot;mga&quot;</span>
<span class="cp">#define DRIVER_DESC		&quot;Matrox G200/G400&quot;</span>
<span class="cp">#define DRIVER_DATE		&quot;20051102&quot;</span>

<span class="cp">#define DRIVER_MAJOR		3</span>
<span class="cp">#define DRIVER_MINOR		2</span>
<span class="cp">#define DRIVER_PATCHLEVEL	1</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drm_mga_primary_buffer</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">space</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">long</span> <span class="n">wrapped</span><span class="p">;</span>

	<span class="k">volatile</span> <span class="n">u32</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">last_flush</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_wrap</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">high_mark</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_mga_primary_buffer_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drm_mga_freelist</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mga_freelist</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mga_freelist</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">drm_mga_age_t</span> <span class="n">age</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_mga_freelist_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">list_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">discard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dispatched</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_mga_buf_priv_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">drm_mga_private</span> <span class="p">{</span>
	<span class="n">drm_mga_primary_buffer_t</span> <span class="n">prim</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span><span class="p">;</span>

	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">warp_pipe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">warp_pipe_phys</span><span class="p">[</span><span class="n">MGA_MAX_WARP_PIPES</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">chipset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usec_timeout</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If set, the new DMA initialization sequence was used.  This is</span>
<span class="cm">	 * primarilly used to select how the driver should uninitialized its</span>
<span class="cm">	 * internal DMA structures.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">used_new_dma_init</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If AGP memory is used for DMA buffers, this will be the value</span>
<span class="cm">	 * \c MGA_PAGPXFER.  Otherwise, it will be zero (for a PCI transfer).</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">dma_access</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If AGP memory is used for DMA buffers, this will be the value</span>
<span class="cm">	 * \c MGA_WAGP_ENABLE.  Otherwise, it will be zero (for a PCI</span>
<span class="cm">	 * transfer).</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">wagp_enable</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * \name MMIO region parameters.</span>
<span class="cm">	 *</span>
<span class="cm">	 * \sa drm_mga_private_t::mmio</span>
<span class="cm">	 */</span>
	<span class="cm">/*@{ */</span>
	<span class="n">resource_size_t</span> <span class="n">mmio_base</span><span class="p">;</span>	   <span class="cm">/**&lt; Bus address of base of MMIO. */</span>
	<span class="n">resource_size_t</span> <span class="n">mmio_size</span><span class="p">;</span>	   <span class="cm">/**&lt; Size of the MMIO region. */</span>
	<span class="cm">/*@} */</span>

	<span class="n">u32</span> <span class="n">clear_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">maccess</span><span class="p">;</span>

	<span class="n">atomic_t</span> <span class="n">vbl_received</span><span class="p">;</span>          <span class="cm">/**&lt; Number of vblanks received. */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">fence_queue</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">last_fence_retired</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">next_fence_to_post</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fb_cpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">front_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">front_pitch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">back_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">back_pitch</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth_cpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth_pitch</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">texture_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">texture_size</span><span class="p">;</span>

	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">sarea</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">warp</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">primary</span><span class="p">;</span>
	<span class="n">drm_local_map_t</span> <span class="o">*</span><span class="n">agp_textures</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">agp_handle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">agp_size</span><span class="p">;</span>
<span class="p">}</span> <span class="n">drm_mga_private_t</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">drm_ioctl_desc</span> <span class="n">mga_ioctls</span><span class="p">[];</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_max_ioctl</span><span class="p">;</span>

				<span class="cm">/* mga_dma.c */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_dma_bootstrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_dma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_dma_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_dma_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_dma_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_driver_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_driver_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mga_driver_lastclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_driver_dma_quiescent</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_do_wait_for_idle</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">mga_do_dma_flush</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mga_do_dma_wrap_start</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mga_do_dma_wrap_end</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">);</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_freelist_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

				<span class="cm">/* mga_warp.c */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_warp_install_microcode</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_warp_init</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">);</span>

				<span class="cm">/* mga_irq.c */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_enable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mga_disable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">u32</span> <span class="n">mga_get_vblank_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_driver_fence_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sequence</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_driver_vblank_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sequence</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">irqreturn_t</span> <span class="n">mga_driver_irq_handler</span><span class="p">(</span><span class="n">DRM_IRQ_ARGS</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mga_driver_irq_preinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">mga_driver_irq_postinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mga_driver_irq_uninstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">long</span> <span class="n">mga_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>

<span class="cp">#define mga_flush_write_combine()	DRM_WRITEMEMORYBARRIER()</span>

<span class="cp">#define MGA_READ8(reg)		DRM_READ8(dev_priv-&gt;mmio, (reg))</span>
<span class="cp">#define MGA_READ(reg)		DRM_READ32(dev_priv-&gt;mmio, (reg))</span>
<span class="cp">#define MGA_WRITE8(reg, val)	DRM_WRITE8(dev_priv-&gt;mmio, (reg), (val))</span>
<span class="cp">#define MGA_WRITE(reg, val)	DRM_WRITE32(dev_priv-&gt;mmio, (reg), (val))</span>

<span class="cp">#define DWGREG0		0x1c00</span>
<span class="cp">#define DWGREG0_END	0x1dff</span>
<span class="cp">#define DWGREG1		0x2c00</span>
<span class="cp">#define DWGREG1_END	0x2dff</span>

<span class="cp">#define ISREG0(r)	(r &gt;= DWGREG0 &amp;&amp; r &lt;= DWGREG0_END)</span>
<span class="cp">#define DMAREG0(r)	(u8)((r - DWGREG0) &gt;&gt; 2)</span>
<span class="cp">#define DMAREG1(r)	(u8)(((r - DWGREG1) &gt;&gt; 2) | 0x80)</span>
<span class="cp">#define DMAREG(r)	(ISREG0(r) ? DMAREG0(r) : DMAREG1(r))</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Helper macross...</span>
<span class="cm"> */</span>

<span class="cp">#define MGA_EMIT_STATE(dev_priv, dirty)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if ((dirty) &amp; ~MGA_UPLOAD_CLIPRECTS) {				\</span>
<span class="cp">		if (dev_priv-&gt;chipset &gt;= MGA_CARD_TYPE_G400)		\</span>
<span class="cp">			mga_g400_emit_state(dev_priv);			\</span>
<span class="cp">		else							\</span>
<span class="cp">			mga_g200_emit_state(dev_priv);			\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define WRAP_TEST_WITH_RETURN(dev_priv)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (test_bit(0, &amp;dev_priv-&gt;prim.wrapped)) {			\</span>
<span class="cp">		if (mga_is_idle(dev_priv)) {				\</span>
<span class="cp">			mga_do_dma_wrap_end(dev_priv);			\</span>
<span class="cp">		} else if (dev_priv-&gt;prim.space &lt;			\</span>
<span class="cp">			   dev_priv-&gt;prim.high_mark) {			\</span>
<span class="cp">			if (MGA_DMA_DEBUG)				\</span>
<span class="cp">				DRM_INFO(&quot;wrap...\n&quot;);			\</span>
<span class="cp">			return -EBUSY;					\</span>
<span class="cp">		}							\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define WRAP_WAIT_WITH_RETURN(dev_priv)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (test_bit(0, &amp;dev_priv-&gt;prim.wrapped)) {			\</span>
<span class="cp">		if (mga_do_wait_for_idle(dev_priv) &lt; 0) {		\</span>
<span class="cp">			if (MGA_DMA_DEBUG)				\</span>
<span class="cp">				DRM_INFO(&quot;wrap...\n&quot;);			\</span>
<span class="cp">			return -EBUSY;					\</span>
<span class="cp">		}							\</span>
<span class="cp">		mga_do_dma_wrap_end(dev_priv);				\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Primary DMA command stream</span>
<span class="cm"> */</span>

<span class="cp">#define MGA_VERBOSE	0</span>

<span class="cp">#define DMA_LOCALS	unsigned int write; volatile u8 *prim;</span>

<span class="cp">#define DMA_BLOCK_SIZE	(5 * sizeof(u32))</span>

<span class="cp">#define BEGIN_DMA(n)							\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (MGA_VERBOSE) {						\</span>
<span class="cp">		DRM_INFO(&quot;BEGIN_DMA(%d)\n&quot;, (n));			\</span>
<span class="cp">		DRM_INFO(&quot;   space=0x%x req=0x%Zx\n&quot;,			\</span>
<span class="cp">			 dev_priv-&gt;prim.space, (n) * DMA_BLOCK_SIZE);	\</span>
<span class="cp">	}								\</span>
<span class="cp">	prim = dev_priv-&gt;prim.start;					\</span>
<span class="cp">	write = dev_priv-&gt;prim.tail;					\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define BEGIN_DMA_WRAP()						\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (MGA_VERBOSE) {						\</span>
<span class="cp">		DRM_INFO(&quot;BEGIN_DMA()\n&quot;);				\</span>
<span class="cp">		DRM_INFO(&quot;   space=0x%x\n&quot;, dev_priv-&gt;prim.space);	\</span>
<span class="cp">	}								\</span>
<span class="cp">	prim = dev_priv-&gt;prim.start;					\</span>
<span class="cp">	write = dev_priv-&gt;prim.tail;					\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define ADVANCE_DMA()							\</span>
<span class="cp">do {									\</span>
<span class="cp">	dev_priv-&gt;prim.tail = write;					\</span>
<span class="cp">	if (MGA_VERBOSE)						\</span>
<span class="cp">		DRM_INFO(&quot;ADVANCE_DMA() tail=0x%05x sp=0x%x\n&quot;,		\</span>
<span class="cp">			 write, dev_priv-&gt;prim.space);			\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define FLUSH_DMA()							\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (0) {							\</span>
<span class="cp">		DRM_INFO(&quot;\n&quot;);						\</span>
<span class="cp">		DRM_INFO(&quot;   tail=0x%06x head=0x%06lx\n&quot;,		\</span>
<span class="cp">			 dev_priv-&gt;prim.tail,				\</span>
<span class="cp">			 (unsigned long)(MGA_READ(MGA_PRIMADDRESS) -	\</span>
<span class="cp">					 dev_priv-&gt;primary-&gt;offset));	\</span>
<span class="cp">	}								\</span>
<span class="cp">	if (!test_bit(0, &amp;dev_priv-&gt;prim.wrapped)) {			\</span>
<span class="cp">		if (dev_priv-&gt;prim.space &lt; dev_priv-&gt;prim.high_mark)	\</span>
<span class="cp">			mga_do_dma_wrap_start(dev_priv);		\</span>
<span class="cp">		else							\</span>
<span class="cp">			mga_do_dma_flush(dev_priv);			\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cm">/* Never use this, always use DMA_BLOCK(...) for primary DMA output.</span>
<span class="cm"> */</span>
<span class="cp">#define DMA_WRITE(offset, val)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (MGA_VERBOSE)						\</span>
<span class="cp">		DRM_INFO(&quot;   DMA_WRITE( 0x%08x ) at 0x%04Zx\n&quot;,		\</span>
<span class="cp">			 (u32)(val), write + (offset) * sizeof(u32));	\</span>
<span class="cp">	*(volatile u32 *)(prim + write + (offset) * sizeof(u32)) = val;	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define DMA_BLOCK(reg0, val0, reg1, val1, reg2, val2, reg3, val3)	\</span>
<span class="cp">do {									\</span>
<span class="cp">	DMA_WRITE(0, ((DMAREG(reg0) &lt;&lt; 0) |				\</span>
<span class="cp">		      (DMAREG(reg1) &lt;&lt; 8) |				\</span>
<span class="cp">		      (DMAREG(reg2) &lt;&lt; 16) |				\</span>
<span class="cp">		      (DMAREG(reg3) &lt;&lt; 24)));				\</span>
<span class="cp">	DMA_WRITE(1, val0);						\</span>
<span class="cp">	DMA_WRITE(2, val1);						\</span>
<span class="cp">	DMA_WRITE(3, val2);						\</span>
<span class="cp">	DMA_WRITE(4, val3);						\</span>
<span class="cp">	write += DMA_BLOCK_SIZE;					\</span>
<span class="cp">} while (0)</span>

<span class="cm">/* Buffer aging via primary DMA stream head pointer.</span>
<span class="cm"> */</span>

<span class="cp">#define SET_AGE(age, h, w)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	(age)-&gt;head = h;						\</span>
<span class="cp">	(age)-&gt;wrap = w;						\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define TEST_AGE(age, h, w)		((age)-&gt;wrap &lt; w ||		\</span>
<span class="cp">					 ((age)-&gt;wrap == w &amp;&amp;		\</span>
<span class="cp">					  (age)-&gt;head &lt; h))</span>

<span class="cp">#define AGE_BUFFER(buf_priv)						\</span>
<span class="cp">do {									\</span>
<span class="cp">	drm_mga_freelist_t *entry = (buf_priv)-&gt;list_entry;		\</span>
<span class="cp">	if ((buf_priv)-&gt;dispatched) {					\</span>
<span class="cp">		entry-&gt;age.head = (dev_priv-&gt;prim.tail +		\</span>
<span class="cp">				   dev_priv-&gt;primary-&gt;offset);		\</span>
<span class="cp">		entry-&gt;age.wrap = dev_priv-&gt;sarea_priv-&gt;last_wrap;	\</span>
<span class="cp">	} else {							\</span>
<span class="cp">		entry-&gt;age.head = 0;					\</span>
<span class="cp">		entry-&gt;age.wrap = 0;					\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define MGA_ENGINE_IDLE_MASK		(MGA_SOFTRAPEN |		\</span>
<span class="cp">					 MGA_DWGENGSTS |		\</span>
<span class="cp">					 MGA_ENDPRDMASTS)</span>
<span class="cp">#define MGA_DMA_IDLE_MASK		(MGA_SOFTRAPEN |		\</span>
<span class="cp">					 MGA_ENDPRDMASTS)</span>

<span class="cp">#define MGA_DMA_DEBUG			0</span>

<span class="cm">/* A reduced set of the mga registers.</span>
<span class="cm"> */</span>
<span class="cp">#define MGA_CRTC_INDEX			0x1fd4</span>
<span class="cp">#define MGA_CRTC_DATA			0x1fd5</span>

<span class="cm">/* CRTC11 */</span>
<span class="cp">#define MGA_VINTCLR			(1 &lt;&lt; 4)</span>
<span class="cp">#define MGA_VINTEN			(1 &lt;&lt; 5)</span>

<span class="cp">#define MGA_ALPHACTRL			0x2c7c</span>
<span class="cp">#define MGA_AR0				0x1c60</span>
<span class="cp">#define MGA_AR1				0x1c64</span>
<span class="cp">#define MGA_AR2				0x1c68</span>
<span class="cp">#define MGA_AR3				0x1c6c</span>
<span class="cp">#define MGA_AR4				0x1c70</span>
<span class="cp">#define MGA_AR5				0x1c74</span>
<span class="cp">#define MGA_AR6				0x1c78</span>

<span class="cp">#define MGA_CXBNDRY			0x1c80</span>
<span class="cp">#define MGA_CXLEFT			0x1ca0</span>
<span class="cp">#define MGA_CXRIGHT			0x1ca4</span>

<span class="cp">#define MGA_DMAPAD			0x1c54</span>
<span class="cp">#define MGA_DSTORG			0x2cb8</span>
<span class="cp">#define MGA_DWGCTL			0x1c00</span>
<span class="cp">#	define MGA_OPCOD_MASK			(15 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_OPCOD_TRAP			(4 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_OPCOD_TEXTURE_TRAP		(6 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_OPCOD_BITBLT			(8 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_OPCOD_ILOAD			(9 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_ATYPE_MASK			(7 &lt;&lt; 4)</span>
<span class="cp">#	define MGA_ATYPE_RPL			(0 &lt;&lt; 4)</span>
<span class="cp">#	define MGA_ATYPE_RSTR			(1 &lt;&lt; 4)</span>
<span class="cp">#	define MGA_ATYPE_ZI			(3 &lt;&lt; 4)</span>
<span class="cp">#	define MGA_ATYPE_BLK			(4 &lt;&lt; 4)</span>
<span class="cp">#	define MGA_ATYPE_I			(7 &lt;&lt; 4)</span>
<span class="cp">#	define MGA_LINEAR			(1 &lt;&lt; 7)</span>
<span class="cp">#	define MGA_ZMODE_MASK			(7 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_ZMODE_NOZCMP			(0 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_ZMODE_ZE			(2 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_ZMODE_ZNE			(3 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_ZMODE_ZLT			(4 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_ZMODE_ZLTE			(5 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_ZMODE_ZGT			(6 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_ZMODE_ZGTE			(7 &lt;&lt; 8)</span>
<span class="cp">#	define MGA_SOLID			(1 &lt;&lt; 11)</span>
<span class="cp">#	define MGA_ARZERO			(1 &lt;&lt; 12)</span>
<span class="cp">#	define MGA_SGNZERO			(1 &lt;&lt; 13)</span>
<span class="cp">#	define MGA_SHIFTZERO			(1 &lt;&lt; 14)</span>
<span class="cp">#	define MGA_BOP_MASK			(15 &lt;&lt; 16)</span>
<span class="cp">#	define MGA_BOP_ZERO			(0 &lt;&lt; 16)</span>
<span class="cp">#	define MGA_BOP_DST			(10 &lt;&lt; 16)</span>
<span class="cp">#	define MGA_BOP_SRC			(12 &lt;&lt; 16)</span>
<span class="cp">#	define MGA_BOP_ONE			(15 &lt;&lt; 16)</span>
<span class="cp">#	define MGA_TRANS_SHIFT			20</span>
<span class="cp">#	define MGA_TRANS_MASK			(15 &lt;&lt; 20)</span>
<span class="cp">#	define MGA_BLTMOD_MASK			(15 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_BMONOLEF		(0 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_BMONOWF		(4 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_PLAN			(1 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_BFCOL			(2 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_BU32BGR		(3 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_BU32RGB		(7 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_BU24BGR		(11 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_BLTMOD_BU24RGB		(15 &lt;&lt; 25)</span>
<span class="cp">#	define MGA_PATTERN			(1 &lt;&lt; 29)</span>
<span class="cp">#	define MGA_TRANSC			(1 &lt;&lt; 30)</span>
<span class="cp">#	define MGA_CLIPDIS			(1 &lt;&lt; 31)</span>
<span class="cp">#define MGA_DWGSYNC			0x2c4c</span>

<span class="cp">#define MGA_FCOL			0x1c24</span>
<span class="cp">#define MGA_FIFOSTATUS			0x1e10</span>
<span class="cp">#define MGA_FOGCOL			0x1cf4</span>
<span class="cp">#define MGA_FXBNDRY			0x1c84</span>
<span class="cp">#define MGA_FXLEFT			0x1ca8</span>
<span class="cp">#define MGA_FXRIGHT			0x1cac</span>

<span class="cp">#define MGA_ICLEAR			0x1e18</span>
<span class="cp">#	define MGA_SOFTRAPICLR			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_VLINEICLR			(1 &lt;&lt; 5)</span>
<span class="cp">#define MGA_IEN				0x1e1c</span>
<span class="cp">#	define MGA_SOFTRAPIEN			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_VLINEIEN			(1 &lt;&lt; 5)</span>

<span class="cp">#define MGA_LEN				0x1c5c</span>

<span class="cp">#define MGA_MACCESS			0x1c04</span>

<span class="cp">#define MGA_PITCH			0x1c8c</span>
<span class="cp">#define MGA_PLNWT			0x1c1c</span>
<span class="cp">#define MGA_PRIMADDRESS			0x1e58</span>
<span class="cp">#	define MGA_DMA_GENERAL			(0 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_DMA_BLIT			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_DMA_VECTOR			(2 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_DMA_VERTEX			(3 &lt;&lt; 0)</span>
<span class="cp">#define MGA_PRIMEND			0x1e5c</span>
<span class="cp">#	define MGA_PRIMNOSTART			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_PAGPXFER			(1 &lt;&lt; 1)</span>
<span class="cp">#define MGA_PRIMPTR			0x1e50</span>
<span class="cp">#	define MGA_PRIMPTREN0			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_PRIMPTREN1			(1 &lt;&lt; 1)</span>

<span class="cp">#define MGA_RST				0x1e40</span>
<span class="cp">#	define MGA_SOFTRESET			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_SOFTEXTRST			(1 &lt;&lt; 1)</span>

<span class="cp">#define MGA_SECADDRESS			0x2c40</span>
<span class="cp">#define MGA_SECEND			0x2c44</span>
<span class="cp">#define MGA_SETUPADDRESS		0x2cd0</span>
<span class="cp">#define MGA_SETUPEND			0x2cd4</span>
<span class="cp">#define MGA_SGN				0x1c58</span>
<span class="cp">#define MGA_SOFTRAP			0x2c48</span>
<span class="cp">#define MGA_SRCORG			0x2cb4</span>
<span class="cp">#	define MGA_SRMMAP_MASK			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_SRCMAP_FB			(0 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_SRCMAP_SYSMEM		(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_SRCACC_MASK			(1 &lt;&lt; 1)</span>
<span class="cp">#	define MGA_SRCACC_PCI			(0 &lt;&lt; 1)</span>
<span class="cp">#	define MGA_SRCACC_AGP			(1 &lt;&lt; 1)</span>
<span class="cp">#define MGA_STATUS			0x1e14</span>
<span class="cp">#	define MGA_SOFTRAPEN			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_VSYNCPEN			(1 &lt;&lt; 4)</span>
<span class="cp">#	define MGA_VLINEPEN			(1 &lt;&lt; 5)</span>
<span class="cp">#	define MGA_DWGENGSTS			(1 &lt;&lt; 16)</span>
<span class="cp">#	define MGA_ENDPRDMASTS			(1 &lt;&lt; 17)</span>
<span class="cp">#define MGA_STENCIL			0x2cc8</span>
<span class="cp">#define MGA_STENCILCTL			0x2ccc</span>

<span class="cp">#define MGA_TDUALSTAGE0			0x2cf8</span>
<span class="cp">#define MGA_TDUALSTAGE1			0x2cfc</span>
<span class="cp">#define MGA_TEXBORDERCOL		0x2c5c</span>
<span class="cp">#define MGA_TEXCTL			0x2c30</span>
<span class="cp">#define MGA_TEXCTL2			0x2c3c</span>
<span class="cp">#	define MGA_DUALTEX			(1 &lt;&lt; 7)</span>
<span class="cp">#	define MGA_G400_TC2_MAGIC		(1 &lt;&lt; 15)</span>
<span class="cp">#	define MGA_MAP1_ENABLE			(1 &lt;&lt; 31)</span>
<span class="cp">#define MGA_TEXFILTER			0x2c58</span>
<span class="cp">#define MGA_TEXHEIGHT			0x2c2c</span>
<span class="cp">#define MGA_TEXORG			0x2c24</span>
<span class="cp">#	define MGA_TEXORGMAP_MASK		(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_TEXORGMAP_FB			(0 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_TEXORGMAP_SYSMEM		(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_TEXORGACC_MASK		(1 &lt;&lt; 1)</span>
<span class="cp">#	define MGA_TEXORGACC_PCI		(0 &lt;&lt; 1)</span>
<span class="cp">#	define MGA_TEXORGACC_AGP		(1 &lt;&lt; 1)</span>
<span class="cp">#define MGA_TEXORG1			0x2ca4</span>
<span class="cp">#define MGA_TEXORG2			0x2ca8</span>
<span class="cp">#define MGA_TEXORG3			0x2cac</span>
<span class="cp">#define MGA_TEXORG4			0x2cb0</span>
<span class="cp">#define MGA_TEXTRANS			0x2c34</span>
<span class="cp">#define MGA_TEXTRANSHIGH		0x2c38</span>
<span class="cp">#define MGA_TEXWIDTH			0x2c28</span>

<span class="cp">#define MGA_WACCEPTSEQ			0x1dd4</span>
<span class="cp">#define MGA_WCODEADDR			0x1e6c</span>
<span class="cp">#define MGA_WFLAG			0x1dc4</span>
<span class="cp">#define MGA_WFLAG1			0x1de0</span>
<span class="cp">#define MGA_WFLAGNB			0x1e64</span>
<span class="cp">#define MGA_WFLAGNB1			0x1e08</span>
<span class="cp">#define MGA_WGETMSB			0x1dc8</span>
<span class="cp">#define MGA_WIADDR			0x1dc0</span>
<span class="cp">#define MGA_WIADDR2			0x1dd8</span>
<span class="cp">#	define MGA_WMODE_SUSPEND		(0 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_WMODE_RESUME			(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_WMODE_JUMP			(2 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_WMODE_START			(3 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_WAGP_ENABLE			(1 &lt;&lt; 2)</span>
<span class="cp">#define MGA_WMISC			0x1e70</span>
<span class="cp">#	define MGA_WUCODECACHE_ENABLE		(1 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_WMASTER_ENABLE		(1 &lt;&lt; 1)</span>
<span class="cp">#	define MGA_WCACHEFLUSH_ENABLE		(1 &lt;&lt; 3)</span>
<span class="cp">#define MGA_WVRTXSZ			0x1dcc</span>

<span class="cp">#define MGA_YBOT			0x1c9c</span>
<span class="cp">#define MGA_YDST			0x1c90</span>
<span class="cp">#define MGA_YDSTLEN			0x1c88</span>
<span class="cp">#define MGA_YDSTORG			0x1c94</span>
<span class="cp">#define MGA_YTOP			0x1c98</span>

<span class="cp">#define MGA_ZORG			0x1c0c</span>

<span class="cm">/* This finishes the current batch of commands</span>
<span class="cm"> */</span>
<span class="cp">#define MGA_EXEC			0x0100</span>

<span class="cm">/* AGP PLL encoding (for G200 only).</span>
<span class="cm"> */</span>
<span class="cp">#define MGA_AGP_PLL			0x1e4c</span>
<span class="cp">#	define MGA_AGP2XPLL_DISABLE		(0 &lt;&lt; 0)</span>
<span class="cp">#	define MGA_AGP2XPLL_ENABLE		(1 &lt;&lt; 0)</span>

<span class="cm">/* Warp registers</span>
<span class="cm"> */</span>
<span class="cp">#define MGA_WR0				0x2d00</span>
<span class="cp">#define MGA_WR1				0x2d04</span>
<span class="cp">#define MGA_WR2				0x2d08</span>
<span class="cp">#define MGA_WR3				0x2d0c</span>
<span class="cp">#define MGA_WR4				0x2d10</span>
<span class="cp">#define MGA_WR5				0x2d14</span>
<span class="cp">#define MGA_WR6				0x2d18</span>
<span class="cp">#define MGA_WR7				0x2d1c</span>
<span class="cp">#define MGA_WR8				0x2d20</span>
<span class="cp">#define MGA_WR9				0x2d24</span>
<span class="cp">#define MGA_WR10			0x2d28</span>
<span class="cp">#define MGA_WR11			0x2d2c</span>
<span class="cp">#define MGA_WR12			0x2d30</span>
<span class="cp">#define MGA_WR13			0x2d34</span>
<span class="cp">#define MGA_WR14			0x2d38</span>
<span class="cp">#define MGA_WR15			0x2d3c</span>
<span class="cp">#define MGA_WR16			0x2d40</span>
<span class="cp">#define MGA_WR17			0x2d44</span>
<span class="cp">#define MGA_WR18			0x2d48</span>
<span class="cp">#define MGA_WR19			0x2d4c</span>
<span class="cp">#define MGA_WR20			0x2d50</span>
<span class="cp">#define MGA_WR21			0x2d54</span>
<span class="cp">#define MGA_WR22			0x2d58</span>
<span class="cp">#define MGA_WR23			0x2d5c</span>
<span class="cp">#define MGA_WR24			0x2d60</span>
<span class="cp">#define MGA_WR25			0x2d64</span>
<span class="cp">#define MGA_WR26			0x2d68</span>
<span class="cp">#define MGA_WR27			0x2d6c</span>
<span class="cp">#define MGA_WR28			0x2d70</span>
<span class="cp">#define MGA_WR29			0x2d74</span>
<span class="cp">#define MGA_WR30			0x2d78</span>
<span class="cp">#define MGA_WR31			0x2d7c</span>
<span class="cp">#define MGA_WR32			0x2d80</span>
<span class="cp">#define MGA_WR33			0x2d84</span>
<span class="cp">#define MGA_WR34			0x2d88</span>
<span class="cp">#define MGA_WR35			0x2d8c</span>
<span class="cp">#define MGA_WR36			0x2d90</span>
<span class="cp">#define MGA_WR37			0x2d94</span>
<span class="cp">#define MGA_WR38			0x2d98</span>
<span class="cp">#define MGA_WR39			0x2d9c</span>
<span class="cp">#define MGA_WR40			0x2da0</span>
<span class="cp">#define MGA_WR41			0x2da4</span>
<span class="cp">#define MGA_WR42			0x2da8</span>
<span class="cp">#define MGA_WR43			0x2dac</span>
<span class="cp">#define MGA_WR44			0x2db0</span>
<span class="cp">#define MGA_WR45			0x2db4</span>
<span class="cp">#define MGA_WR46			0x2db8</span>
<span class="cp">#define MGA_WR47			0x2dbc</span>
<span class="cp">#define MGA_WR48			0x2dc0</span>
<span class="cp">#define MGA_WR49			0x2dc4</span>
<span class="cp">#define MGA_WR50			0x2dc8</span>
<span class="cp">#define MGA_WR51			0x2dcc</span>
<span class="cp">#define MGA_WR52			0x2dd0</span>
<span class="cp">#define MGA_WR53			0x2dd4</span>
<span class="cp">#define MGA_WR54			0x2dd8</span>
<span class="cp">#define MGA_WR55			0x2ddc</span>
<span class="cp">#define MGA_WR56			0x2de0</span>
<span class="cp">#define MGA_WR57			0x2de4</span>
<span class="cp">#define MGA_WR58			0x2de8</span>
<span class="cp">#define MGA_WR59			0x2dec</span>
<span class="cp">#define MGA_WR60			0x2df0</span>
<span class="cp">#define MGA_WR61			0x2df4</span>
<span class="cp">#define MGA_WR62			0x2df8</span>
<span class="cp">#define MGA_WR63			0x2dfc</span>
<span class="cp">#	define MGA_G400_WR_MAGIC		(1 &lt;&lt; 6)</span>
<span class="cp">#	define MGA_G400_WR56_MAGIC		0x46480000	</span><span class="cm">/* 12800.0f */</span><span class="cp"></span>

<span class="cp">#define MGA_ILOAD_ALIGN		64</span>
<span class="cp">#define MGA_ILOAD_MASK		(MGA_ILOAD_ALIGN - 1)</span>

<span class="cp">#define MGA_DWGCTL_FLUSH	(MGA_OPCOD_TEXTURE_TRAP |		\</span>
<span class="cp">				 MGA_ATYPE_I |				\</span>
<span class="cp">				 MGA_ZMODE_NOZCMP |			\</span>
<span class="cp">				 MGA_ARZERO |				\</span>
<span class="cp">				 MGA_SGNZERO |				\</span>
<span class="cp">				 MGA_BOP_SRC |				\</span>
<span class="cp">				 (15 &lt;&lt; MGA_TRANS_SHIFT))</span>

<span class="cp">#define MGA_DWGCTL_CLEAR	(MGA_OPCOD_TRAP |			\</span>
<span class="cp">				 MGA_ZMODE_NOZCMP |			\</span>
<span class="cp">				 MGA_SOLID |				\</span>
<span class="cp">				 MGA_ARZERO |				\</span>
<span class="cp">				 MGA_SGNZERO |				\</span>
<span class="cp">				 MGA_SHIFTZERO |			\</span>
<span class="cp">				 MGA_BOP_SRC |				\</span>
<span class="cp">				 (0 &lt;&lt; MGA_TRANS_SHIFT) |		\</span>
<span class="cp">				 MGA_BLTMOD_BMONOLEF |			\</span>
<span class="cp">				 MGA_TRANSC |				\</span>
<span class="cp">				 MGA_CLIPDIS)</span>

<span class="cp">#define MGA_DWGCTL_COPY		(MGA_OPCOD_BITBLT |			\</span>
<span class="cp">				 MGA_ATYPE_RPL |			\</span>
<span class="cp">				 MGA_SGNZERO |				\</span>
<span class="cp">				 MGA_SHIFTZERO |			\</span>
<span class="cp">				 MGA_BOP_SRC |				\</span>
<span class="cp">				 (0 &lt;&lt; MGA_TRANS_SHIFT) |		\</span>
<span class="cp">				 MGA_BLTMOD_BFCOL |			\</span>
<span class="cp">				 MGA_CLIPDIS)</span>

<span class="cm">/* Simple idle test.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">mga_is_idle</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MGA_READ</span><span class="p">(</span><span class="n">MGA_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MGA_ENGINE_IDLE_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MGA_ENDPRDMASTS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
