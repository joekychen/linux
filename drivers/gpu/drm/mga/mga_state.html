<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › mga › mga_state.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mga_state.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* mga_state.c -- State support for MGA G200/G400 -*- linux-c -*-</span>
<span class="cm"> * Created: Thu Jan 27 02:53:43 2000 by jhartmann@precisioninsight.com</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1999 Precision Insight, Inc., Cedar Park, Texas.</span>
<span class="cm"> * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * VA LINUX SYSTEMS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Jeff Hartmann &lt;jhartmann@valinux.com&gt;</span>
<span class="cm"> *    Keith Whitwell &lt;keith@tungstengraphics.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Rewritten by:</span>
<span class="cm"> *    Gareth Hughes &lt;gareth@valinux.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;mga_drm.h&quot;</span>
<span class="cp">#include &quot;mga_drv.h&quot;</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * DMA hardware state programming functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_emit_clip_rect</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">box</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Force reset of DWGCTL on G400 (eliminates clip disable bit).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="n">MGA_CARD_TYPE_G400</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dwgctl</span><span class="p">,</span>
			  <span class="n">MGA_LEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">,</span>
			  <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dwgctl</span><span class="p">,</span>
			  <span class="n">MGA_LEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_CXBNDRY</span><span class="p">,</span> <span class="p">((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span>
		  <span class="n">MGA_YTOP</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">*</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">MGA_YBOT</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pitch</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">mga_g200_emit_context</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dstorg</span><span class="p">,</span>
		  <span class="n">MGA_MACCESS</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">maccess</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">plnwt</span><span class="p">,</span> <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dwgctl</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_ALPHACTRL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">alphactrl</span><span class="p">,</span>
		  <span class="n">MGA_FOGCOL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fogcolor</span><span class="p">,</span>
		  <span class="n">MGA_WFLAG</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wflag</span><span class="p">,</span> <span class="n">MGA_ZORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_offset</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_FCOL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcol</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">mga_g400_emit_context</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dstorg</span><span class="p">,</span>
		  <span class="n">MGA_MACCESS</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">maccess</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">plnwt</span><span class="p">,</span> <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dwgctl</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_ALPHACTRL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">alphactrl</span><span class="p">,</span>
		  <span class="n">MGA_FOGCOL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fogcolor</span><span class="p">,</span>
		  <span class="n">MGA_WFLAG</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wflag</span><span class="p">,</span> <span class="n">MGA_ZORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_offset</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WFLAG1</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">wflag</span><span class="p">,</span>
		  <span class="n">MGA_TDUALSTAGE0</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tdualstage0</span><span class="p">,</span>
		  <span class="n">MGA_TDUALSTAGE1</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tdualstage1</span><span class="p">,</span> <span class="n">MGA_FCOL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fcol</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_STENCIL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">stencil</span><span class="p">,</span>
		  <span class="n">MGA_STENCILCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">stencilctl</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">mga_g200_emit_tex0</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_texture_regs_t</span> <span class="o">*</span><span class="n">tex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tex_state</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXCTL2</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texctl2</span><span class="p">,</span>
		  <span class="n">MGA_TEXCTL</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texctl</span><span class="p">,</span>
		  <span class="n">MGA_TEXFILTER</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texfilter</span><span class="p">,</span>
		  <span class="n">MGA_TEXBORDERCOL</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texbordercol</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXORG</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg</span><span class="p">,</span>
		  <span class="n">MGA_TEXORG1</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg1</span><span class="p">,</span>
		  <span class="n">MGA_TEXORG2</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg2</span><span class="p">,</span> <span class="n">MGA_TEXORG3</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg3</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXORG4</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg4</span><span class="p">,</span>
		  <span class="n">MGA_TEXWIDTH</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texwidth</span><span class="p">,</span>
		  <span class="n">MGA_TEXHEIGHT</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texheight</span><span class="p">,</span> <span class="n">MGA_WR24</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texwidth</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR34</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texheight</span><span class="p">,</span>
		  <span class="n">MGA_TEXTRANS</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span>
		  <span class="n">MGA_TEXTRANSHIGH</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">mga_g400_emit_tex0</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_texture_regs_t</span> <span class="o">*</span><span class="n">tex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tex_state</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

<span class="cm">/*	printk(&quot;mga_g400_emit_tex0 %x %x %x\n&quot;, tex-&gt;texorg, */</span>
<span class="cm">/*	       tex-&gt;texctl, tex-&gt;texctl2); */</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXCTL2</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texctl2</span> <span class="o">|</span> <span class="n">MGA_G400_TC2_MAGIC</span><span class="p">,</span>
		  <span class="n">MGA_TEXCTL</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texctl</span><span class="p">,</span>
		  <span class="n">MGA_TEXFILTER</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texfilter</span><span class="p">,</span>
		  <span class="n">MGA_TEXBORDERCOL</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texbordercol</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXORG</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg</span><span class="p">,</span>
		  <span class="n">MGA_TEXORG1</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg1</span><span class="p">,</span>
		  <span class="n">MGA_TEXORG2</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg2</span><span class="p">,</span> <span class="n">MGA_TEXORG3</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg3</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXORG4</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg4</span><span class="p">,</span>
		  <span class="n">MGA_TEXWIDTH</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texwidth</span><span class="p">,</span>
		  <span class="n">MGA_TEXHEIGHT</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texheight</span><span class="p">,</span> <span class="n">MGA_WR49</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR57</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WR53</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WR61</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_WR52</span><span class="p">,</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR60</span><span class="p">,</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">,</span>
		  <span class="n">MGA_WR54</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texwidth</span> <span class="o">|</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">,</span>
		  <span class="n">MGA_WR62</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texheight</span> <span class="o">|</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_TEXTRANS</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">MGA_TEXTRANSHIGH</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">mga_g400_emit_tex1</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_texture_regs_t</span> <span class="o">*</span><span class="n">tex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tex_state</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

<span class="cm">/*	printk(&quot;mga_g400_emit_tex1 %x %x %x\n&quot;, tex-&gt;texorg,  */</span>
<span class="cm">/*	       tex-&gt;texctl, tex-&gt;texctl2); */</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXCTL2</span><span class="p">,</span> <span class="p">(</span><span class="n">tex</span><span class="o">-&gt;</span><span class="n">texctl2</span> <span class="o">|</span>
				<span class="n">MGA_MAP1_ENABLE</span> <span class="o">|</span>
				<span class="n">MGA_G400_TC2_MAGIC</span><span class="p">),</span>
		  <span class="n">MGA_TEXCTL</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texctl</span><span class="p">,</span>
		  <span class="n">MGA_TEXFILTER</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texfilter</span><span class="p">,</span>
		  <span class="n">MGA_TEXBORDERCOL</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texbordercol</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXORG</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg</span><span class="p">,</span>
		  <span class="n">MGA_TEXORG1</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg1</span><span class="p">,</span>
		  <span class="n">MGA_TEXORG2</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg2</span><span class="p">,</span> <span class="n">MGA_TEXORG3</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg3</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXORG4</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg4</span><span class="p">,</span>
		  <span class="n">MGA_TEXWIDTH</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texwidth</span><span class="p">,</span>
		  <span class="n">MGA_TEXHEIGHT</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texheight</span><span class="p">,</span> <span class="n">MGA_WR49</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR57</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WR53</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WR61</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WR52</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texwidth</span> <span class="o">|</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR60</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texheight</span> <span class="o">|</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">,</span>
		  <span class="n">MGA_TEXTRANS</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span>
		  <span class="n">MGA_TEXTRANSHIGH</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span>
		  <span class="n">MGA_TEXCTL2</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texctl2</span> <span class="o">|</span> <span class="n">MGA_G400_TC2_MAGIC</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">mga_g200_emit_pipe</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WIADDR</span><span class="p">,</span> <span class="n">MGA_WMODE_SUSPEND</span><span class="p">,</span>
		  <span class="n">MGA_WVRTXSZ</span><span class="p">,</span> <span class="mh">0x00000007</span><span class="p">,</span>
		  <span class="n">MGA_WFLAG</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_WR24</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR25</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">,</span>
		  <span class="n">MGA_WR34</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WR42</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">MGA_WR60</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>

	<span class="cm">/* Padding required due to hardware bug.</span>
<span class="cm">	 */</span>
	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		  <span class="n">MGA_WIADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe_phys</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">|</span>
			       <span class="n">MGA_WMODE_START</span> <span class="o">|</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wagp_enable</span><span class="p">));</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">mga_g400_emit_pipe</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

<span class="cm">/*	printk(&quot;mga_g400_emit_pipe %x\n&quot;, pipe); */</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WIADDR2</span><span class="p">,</span> <span class="n">MGA_WMODE_SUSPEND</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&amp;</span> <span class="n">MGA_T2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WVRTXSZ</span><span class="p">,</span> <span class="mh">0x00001e09</span><span class="p">,</span>
			  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

		<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x1e000000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">&amp;</span> <span class="n">MGA_T2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Flush the WARP pipe */</span>
			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_YDST</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_FXLEFT</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_FXRIGHT</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">,</span>
				  <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">MGA_DWGCTL_FLUSH</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_LEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">,</span>
				  <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007000</span><span class="p">,</span>
				  <span class="n">MGA_TEXCTL2</span><span class="p">,</span> <span class="n">MGA_G400_TC2_MAGIC</span><span class="p">,</span>
				  <span class="n">MGA_LEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_TEXCTL2</span><span class="p">,</span> <span class="p">(</span><span class="n">MGA_DUALTEX</span> <span class="o">|</span>
						<span class="n">MGA_G400_TC2_MAGIC</span><span class="p">),</span>
				  <span class="n">MGA_LEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_TEXCTL2</span><span class="p">,</span> <span class="n">MGA_G400_TC2_MAGIC</span><span class="p">,</span>
				  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WVRTXSZ</span><span class="p">,</span> <span class="mh">0x00001807</span><span class="p">,</span>
			  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

		<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
			  <span class="n">MGA_WACCEPTSEQ</span><span class="p">,</span> <span class="mh">0x18000000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WFLAG</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WFLAG1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_WR56</span><span class="p">,</span> <span class="n">MGA_G400_WR56_MAGIC</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR49</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>	<span class="cm">/* tex0              */</span>
		  <span class="n">MGA_WR57</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>	<span class="cm">/* tex0              */</span>
		  <span class="n">MGA_WR53</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>	<span class="cm">/* tex1              */</span>
		  <span class="n">MGA_WR61</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>	<span class="cm">/* tex1              */</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_WR54</span><span class="p">,</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">,</span>	<span class="cm">/* tex0 width        */</span>
		  <span class="n">MGA_WR62</span><span class="p">,</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">,</span>	<span class="cm">/* tex0 height       */</span>
		  <span class="n">MGA_WR52</span><span class="p">,</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">,</span>	<span class="cm">/* tex1 width        */</span>
		  <span class="n">MGA_WR60</span><span class="p">,</span> <span class="n">MGA_G400_WR_MAGIC</span><span class="p">);</span>	<span class="cm">/* tex1 height       */</span>

	<span class="cm">/* Padding required due to hardware bug */</span>
	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		  <span class="n">MGA_WIADDR2</span><span class="p">,</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe_phys</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">|</span>
				<span class="n">MGA_WMODE_START</span> <span class="o">|</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wagp_enable</span><span class="p">));</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_g200_emit_state</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">!=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_g200_emit_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_g200_emit_context</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_TEX0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_g200_emit_tex0</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MGA_UPLOAD_TEX0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_g400_emit_state</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">multitex</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">&amp;</span> <span class="n">MGA_T2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">!=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_g400_emit_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_g400_emit_context</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_TEX0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_g400_emit_tex0</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MGA_UPLOAD_TEX0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_TEX1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">multitex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_g400_emit_tex1</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MGA_UPLOAD_TEX1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * SAREA state verification</span>
<span class="cm"> */</span>

<span class="cm">/* Disallow all write destinations except the front and backbuffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_verify_context</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dstorg</span> <span class="o">!=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dstorg</span> <span class="o">!=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;*** bad DSTORG: %x (front %x, back %x)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dstorg</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dstorg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Disallow texture reads from PCI space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_verify_tex</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_texture_regs_t</span> <span class="o">*</span><span class="n">tex</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">tex_state</span><span class="p">[</span><span class="n">unit</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">org</span><span class="p">;</span>

	<span class="n">org</span> <span class="o">=</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MGA_TEXORGMAP_MASK</span> <span class="o">|</span> <span class="n">MGA_TEXORGACC_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">org</span> <span class="o">==</span> <span class="p">(</span><span class="n">MGA_TEXORGMAP_SYSMEM</span> <span class="o">|</span> <span class="n">MGA_TEXORGACC_PCI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;*** bad TEXORG: 0x%x, unit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="n">tex</span><span class="o">-&gt;</span><span class="n">texorg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_verify_state</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">&gt;</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">mga_verify_context</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_TEX0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">mga_verify_tex</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="n">MGA_CARD_TYPE_G400</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_TEX1</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">mga_verify_tex</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_PIPE</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">&gt;</span> <span class="n">MGA_MAX_G400_PIPES</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dirty</span> <span class="o">&amp;</span> <span class="n">MGA_UPLOAD_PIPE</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">&gt;</span> <span class="n">MGA_MAX_G200_PIPES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_verify_iload</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dstorg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dstorg</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">texture_offset</span> <span class="o">||</span>
	    <span class="n">dstorg</span> <span class="o">+</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">texture_offset</span> <span class="o">+</span>
			       <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">texture_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;*** bad iload DSTORG: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dstorg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="n">MGA_ILOAD_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;*** bad iload length: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">length</span> <span class="o">&amp;</span> <span class="n">MGA_ILOAD_MASK</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_verify_blit</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srcorg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dstorg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">srcorg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">MGA_SRCACC_PCI</span> <span class="o">|</span> <span class="n">MGA_SRCMAP_SYSMEM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dstorg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">MGA_SRCACC_PCI</span> <span class="o">|</span> <span class="n">MGA_SRCMAP_SYSMEM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;*** bad blit: src=0x%x dst=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srcorg</span><span class="p">,</span> <span class="n">dstorg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_dma_dispatch_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">drm_mga_clear_t</span> <span class="o">*</span><span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">pbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007100</span><span class="p">,</span> <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007000</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">box</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">height</span> <span class="o">=</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">-</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">;</span>

		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   from=%d,%d to=%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MGA_FRONT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">color_mask</span><span class="p">,</span>
				  <span class="n">MGA_YDSTLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">height</span><span class="p">,</span>
				  <span class="n">MGA_FXBNDRY</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_FCOL</span><span class="p">,</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">clear_color</span><span class="p">,</span>
				  <span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">,</span>
				  <span class="n">MGA_DWGCTL</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">clear_cmd</span><span class="p">);</span>

			<span class="n">ADVANCE_DMA</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MGA_BACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">color_mask</span><span class="p">,</span>
				  <span class="n">MGA_YDSTLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">height</span><span class="p">,</span>
				  <span class="n">MGA_FXBNDRY</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_FCOL</span><span class="p">,</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">clear_color</span><span class="p">,</span>
				  <span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">,</span>
				  <span class="n">MGA_DWGCTL</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">clear_cmd</span><span class="p">);</span>

			<span class="n">ADVANCE_DMA</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clear</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MGA_DEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">depth_mask</span><span class="p">,</span>
				  <span class="n">MGA_YDSTLEN</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">height</span><span class="p">,</span>
				  <span class="n">MGA_FXBNDRY</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_FCOL</span><span class="p">,</span> <span class="n">clear</span><span class="o">-&gt;</span><span class="n">clear_depth</span><span class="p">,</span>
				  <span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_offset</span><span class="p">,</span>
				  <span class="n">MGA_DWGCTL</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">clear_cmd</span><span class="p">);</span>

			<span class="n">ADVANCE_DMA</span><span class="p">();</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Force reset of DWGCTL */</span>
	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">plnwt</span><span class="p">,</span> <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dwgctl</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>

	<span class="n">FLUSH_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_dma_dispatch_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">pbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">.</span><span class="n">wrap</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">last_wrap</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">nbox</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007100</span><span class="p">,</span> <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">,</span>
		  <span class="n">MGA_MACCESS</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">maccess</span><span class="p">,</span>
		  <span class="n">MGA_SRCORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">,</span>
		  <span class="n">MGA_AR5</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">MGA_DWGCTL_COPY</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">box</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">height</span> <span class="o">=</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">-</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">start</span> <span class="o">=</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span><span class="p">;</span>

		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   from=%d,%d to=%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">);</span>

		<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_AR0</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">MGA_AR3</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span>
			  <span class="n">MGA_FXBNDRY</span><span class="p">,</span> <span class="p">((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span>
			  <span class="n">MGA_YDSTLEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">height</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">plnwt</span><span class="p">,</span>
		  <span class="n">MGA_SRCORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">,</span> <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dwgctl</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>

	<span class="n">FLUSH_DMA</span><span class="p">();</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;... done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_dma_dispatch_vertex</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bus_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;buf=%d used=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">MGA_EMIT_STATE</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mga_emit_clip_rect</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_SECADDRESS</span><span class="p">,</span> <span class="p">(</span><span class="n">address</span> <span class="o">|</span>
						   <span class="n">MGA_DMA_VERTEX</span><span class="p">),</span>
				  <span class="n">MGA_SECEND</span><span class="p">,</span> <span class="p">((</span><span class="n">address</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="o">|</span>
					       <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span><span class="p">));</span>

			<span class="n">ADVANCE_DMA</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AGE_BUFFER</span><span class="p">(</span><span class="n">buf_priv</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mga_freelist_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FLUSH_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_dma_dispatch_indices</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bus_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;buf=%d start=%d end=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">MGA_EMIT_STATE</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">);</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mga_emit_clip_rect</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
				  <span class="n">MGA_SETUPADDRESS</span><span class="p">,</span> <span class="n">address</span> <span class="o">+</span> <span class="n">start</span><span class="p">,</span>
				  <span class="n">MGA_SETUPEND</span><span class="p">,</span> <span class="p">((</span><span class="n">address</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span> <span class="o">|</span>
						 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span><span class="p">));</span>

			<span class="n">ADVANCE_DMA</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AGE_BUFFER</span><span class="p">(</span><span class="n">buf_priv</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mga_freelist_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FLUSH_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* This copies a 64 byte aligned agp region to the frambuffer with a</span>
<span class="cm"> * standard blit, the ioctl needs to do checking.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_dma_dispatch_iload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dstorg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">srcorg</span> <span class="o">=</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bus_address</span> <span class="o">|</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span> <span class="o">|</span> <span class="n">MGA_SRCMAP_SYSMEM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y2</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;buf=%d used=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>

	<span class="n">y2</span> <span class="o">=</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007100</span><span class="p">,</span> <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">dstorg</span><span class="p">,</span>
		  <span class="n">MGA_MACCESS</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_SRCORG</span><span class="p">,</span> <span class="n">srcorg</span><span class="p">,</span> <span class="n">MGA_AR5</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_PITCH</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">MGA_DWGCTL_COPY</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_AR0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span>
		  <span class="n">MGA_AR3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">MGA_FXBNDRY</span><span class="p">,</span> <span class="p">(</span><span class="mi">63</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MGA_YDSTLEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="n">y2</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">plnwt</span><span class="p">,</span>
		  <span class="n">MGA_SRCORG</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">,</span>
		  <span class="n">MGA_PITCH</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span><span class="p">,</span> <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007000</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>

	<span class="n">AGE_BUFFER</span><span class="p">(</span><span class="n">buf_priv</span><span class="p">);</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mga_freelist_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="n">FLUSH_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_dma_dispatch_blit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">drm_mga_blit_t</span> <span class="o">*</span><span class="n">blit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_context_regs_t</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">context_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">pbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">boxes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scandir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="n">nbox</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007100</span><span class="p">,</span> <span class="n">MGA_DWGSYNC</span><span class="p">,</span> <span class="mh">0x00007000</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">MGA_DWGCTL_COPY</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">planemask</span><span class="p">,</span>
		  <span class="n">MGA_SRCORG</span><span class="p">,</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">srcorg</span><span class="p">,</span> <span class="n">MGA_DSTORG</span><span class="p">,</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">dstorg</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_SGN</span><span class="p">,</span> <span class="n">scandir</span><span class="p">,</span>
		  <span class="n">MGA_MACCESS</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">maccess</span><span class="p">,</span>
		  <span class="n">MGA_AR5</span><span class="p">,</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">ydir</span> <span class="o">*</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">src_pitch</span><span class="p">,</span>
		  <span class="n">MGA_PITCH</span><span class="p">,</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">dst_pitch</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">srcx</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span> <span class="o">+</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">delta_sx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">srcy</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">+</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">delta_sy</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dstx</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span> <span class="o">+</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">delta_dx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dsty</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span> <span class="o">+</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">delta_dy</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y2</span> <span class="o">-</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x2</span> <span class="o">-</span> <span class="n">pbox</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blit</span><span class="o">-&gt;</span><span class="n">ydir</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">srcy</span> <span class="o">=</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">srcy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">=</span> <span class="n">srcy</span> <span class="o">*</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">src_pitch</span> <span class="o">+</span> <span class="n">srcx</span><span class="p">;</span>

		<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_AR0</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span>
			  <span class="n">MGA_AR3</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span>
			  <span class="n">MGA_FXBNDRY</span><span class="p">,</span> <span class="p">((</span><span class="n">dstx</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dstx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span>
			  <span class="n">MGA_YDSTLEN</span> <span class="o">+</span> <span class="n">MGA_EXEC</span><span class="p">,</span> <span class="p">(</span><span class="n">dsty</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">h</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Do something to flush AGP?</span>
<span class="cm">	 */</span>

	<span class="cm">/* Force reset of DWGCTL */</span>
	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_PLNWT</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">plnwt</span><span class="p">,</span>
		  <span class="n">MGA_PITCH</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span><span class="p">,</span> <span class="n">MGA_DWGCTL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dwgctl</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_dma_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_clear_t</span> <span class="o">*</span><span class="n">clear</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">&gt;</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">;</span>

	<span class="n">WRAP_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">mga_dma_dispatch_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>

	<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">|=</span> <span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_dma_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">&gt;</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">;</span>

	<span class="n">WRAP_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">mga_dma_dispatch_swap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">|=</span> <span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_dma_vertex</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">;</span>
	<span class="n">drm_mga_vertex_t</span> <span class="o">*</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
	<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">discard</span> <span class="o">=</span> <span class="n">vertex</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mga_verify_state</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vertex</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">AGE_BUFFER</span><span class="p">(</span><span class="n">buf_priv</span><span class="p">);</span>
			<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mga_freelist_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WRAP_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">mga_dma_dispatch_vertex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_dma_indices</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">;</span>
	<span class="n">drm_mga_indices_t</span> <span class="o">*</span><span class="n">indices</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indices</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">indices</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">indices</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">discard</span> <span class="o">=</span> <span class="n">indices</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mga_verify_state</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">indices</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">AGE_BUFFER</span><span class="p">(</span><span class="n">buf_priv</span><span class="p">);</span>
			<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mga_freelist_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WRAP_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">mga_dma_dispatch_indices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">indices</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">indices</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_dma_iload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">;</span>
	<span class="n">drm_mga_iload_t</span> <span class="o">*</span><span class="n">iload</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (mga_do_wait_for_idle(dev_priv) &lt; 0) {</span>
<span class="c">		if (MGA_DMA_DEBUG)</span>
<span class="c">			DRM_INFO(&quot;-EBUSY\n&quot;);</span>
<span class="c">		return -EBUSY;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iload</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">iload</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">iload</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mga_verify_iload</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">iload</span><span class="o">-&gt;</span><span class="n">dstorg</span><span class="p">,</span> <span class="n">iload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mga_freelist_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WRAP_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">mga_dma_dispatch_iload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">iload</span><span class="o">-&gt;</span><span class="n">dstorg</span><span class="p">,</span> <span class="n">iload</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">|=</span> <span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_dma_blit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_blit_t</span> <span class="o">*</span><span class="n">blit</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">&gt;</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">nbox</span> <span class="o">=</span> <span class="n">MGA_NR_SAREA_CLIPRECTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mga_verify_blit</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">srcorg</span><span class="p">,</span> <span class="n">blit</span><span class="o">-&gt;</span><span class="n">dstorg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">WRAP_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">mga_dma_dispatch_blit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">blit</span><span class="p">);</span>

	<span class="cm">/* Make sure we restore the 3D state next time.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">|=</span> <span class="n">MGA_UPLOAD_CONTEXT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_getparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_getparam_t</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRM_CURRENTPID</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGA_PARAM_IRQ_NR</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">drm_dev_to_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGA_PARAM_CARD_TYPE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;copy_to_user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_set_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRM_CURRENTPID</span><span class="p">);</span>

	<span class="cm">/* I would normal do this assignment in the declaration of fence,</span>
<span class="cm">	 * but dev_priv may be NULL.</span>
<span class="cm">	 */</span>

	<span class="o">*</span><span class="n">fence</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">next_fence_to_post</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">next_fence_to_post</span><span class="o">++</span><span class="p">;</span>

	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_SOFTRAP</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">ADVANCE_DMA</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_wait_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span>
<span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">fence</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;pid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRM_CURRENTPID</span><span class="p">);</span>

	<span class="n">mga_driver_fence_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fence</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_ioctl_desc</span> <span class="n">mga_ioctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_INIT</span><span class="p">,</span> <span class="n">mga_dma_init</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_FLUSH</span><span class="p">,</span> <span class="n">mga_dma_flush</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_RESET</span><span class="p">,</span> <span class="n">mga_dma_reset</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_SWAP</span><span class="p">,</span> <span class="n">mga_dma_swap</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_CLEAR</span><span class="p">,</span> <span class="n">mga_dma_clear</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_VERTEX</span><span class="p">,</span> <span class="n">mga_dma_vertex</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_INDICES</span><span class="p">,</span> <span class="n">mga_dma_indices</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_ILOAD</span><span class="p">,</span> <span class="n">mga_dma_iload</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_BLIT</span><span class="p">,</span> <span class="n">mga_dma_blit</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_GETPARAM</span><span class="p">,</span> <span class="n">mga_getparam</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_SET_FENCE</span><span class="p">,</span> <span class="n">mga_set_fence</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_WAIT_FENCE</span><span class="p">,</span> <span class="n">mga_wait_fence</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">MGA_DMA_BOOTSTRAP</span><span class="p">,</span> <span class="n">mga_dma_bootstrap</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">mga_max_ioctl</span> <span class="o">=</span> <span class="n">DRM_ARRAY_SIZE</span><span class="p">(</span><span class="n">mga_ioctls</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
