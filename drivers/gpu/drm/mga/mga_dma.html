<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › mga › mga_dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mga_dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* mga_dma.c -- DMA support for mga g200/g400 -*- linux-c -*-</span>
<span class="cm"> * Created: Mon Dec 13 01:50:01 1999 by jhartmann@precisioninsight.com</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1999 Precision Insight, Inc., Cedar Park, Texas.</span>
<span class="cm"> * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * \file mga_dma.c</span>
<span class="cm"> * DMA support for MGA G200 / G400.</span>
<span class="cm"> *</span>
<span class="cm"> * \author Rickard E. (Rik) Faith &lt;faith@valinux.com&gt;</span>
<span class="cm"> * \author Jeff Hartmann &lt;jhartmann@valinux.com&gt;</span>
<span class="cm"> * \author Keith Whitwell &lt;keith@tungstengraphics.com&gt;</span>
<span class="cm"> * \author Gareth Hughes &lt;gareth@valinux.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_sarea.h&quot;</span>
<span class="cp">#include &quot;mga_drm.h&quot;</span>
<span class="cp">#include &quot;mga_drv.h&quot;</span>

<span class="cp">#define MGA_DEFAULT_USEC_TIMEOUT	10000</span>
<span class="cp">#define MGA_FREELIST_DEBUG		0</span>

<span class="cp">#define MINIMAL_CLEANUP 0</span>
<span class="cp">#define FULL_CLEANUP 1</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mga_do_cleanup_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">full_cleanup</span><span class="p">);</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Engine control</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">mga_do_wait_for_idle</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MGA_READ</span><span class="p">(</span><span class="n">MGA_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MGA_ENGINE_IDLE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MGA_ENDPRDMASTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MGA_WRITE8</span><span class="p">(</span><span class="n">MGA_CRTC_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if MGA_DMA_DEBUG</span>
	<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;   status=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_do_dma_reset</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_mga_primary_buffer_t</span> <span class="o">*</span><span class="n">primary</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* The primary DMA stream should look like new right about now.</span>
<span class="cm">	 */</span>
	<span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">primary</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">primary</span><span class="o">-&gt;</span><span class="n">last_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* FIXME: Reset counters, buffer ages etc...</span>
<span class="cm">	 */</span>

	<span class="cm">/* FIXME: What else do we need to reinitialize?  WARP stuff?</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Primary DMA stream</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">mga_do_dma_flush</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_primary_buffer_t</span> <span class="o">*</span><span class="n">primary</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* We need to wait so that we can do an safe flush */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">MGA_READ</span><span class="p">(</span><span class="n">MGA_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MGA_ENGINE_IDLE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">MGA_ENDPRDMASTS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">DRM_UDELAY</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">last_flush</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   bailing out...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tail</span> <span class="o">=</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* We need to pad the stream between flushes, as the card</span>
<span class="cm">	 * actually (partially?) reads the first of these commands.</span>
<span class="cm">	 * See page 4-16 in the G400 manual, middle of the page or so.</span>
<span class="cm">	 */</span>
	<span class="n">BEGIN_DMA</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>

	<span class="n">primary</span><span class="o">-&gt;</span><span class="n">last_flush</span> <span class="o">=</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">MGA_READ</span><span class="p">(</span><span class="n">MGA_PRIMADDRESS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">&lt;=</span> <span class="n">tail</span><span class="p">)</span>
		<span class="n">primary</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">primary</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">head</span> <span class="o">-</span> <span class="n">tail</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   head = 0x%06lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">head</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   tail = 0x%06lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tail</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;  space = 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">);</span>

	<span class="n">mga_flush_write_combine</span><span class="p">();</span>
	<span class="n">MGA_WRITE</span><span class="p">(</span><span class="n">MGA_PRIMEND</span><span class="p">,</span> <span class="n">tail</span> <span class="o">|</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span><span class="p">);</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mga_do_dma_wrap_start</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_primary_buffer_t</span> <span class="o">*</span><span class="n">primary</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">DMA_LOCALS</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BEGIN_DMA_WRAP</span><span class="p">();</span>

	<span class="n">DMA_BLOCK</span><span class="p">(</span><span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span>
		  <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">MGA_DMAPAD</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">ADVANCE_DMA</span><span class="p">();</span>

	<span class="n">tail</span> <span class="o">=</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">primary</span><span class="o">-&gt;</span><span class="n">last_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">primary</span><span class="o">-&gt;</span><span class="n">last_wrap</span><span class="o">++</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">MGA_READ</span><span class="p">(</span><span class="n">MGA_PRIMADDRESS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="n">primary</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">primary</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">head</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   head = 0x%06lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">head</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   tail = 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   wrap = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">last_wrap</span><span class="p">);</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;  space = 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">primary</span><span class="o">-&gt;</span><span class="n">space</span><span class="p">);</span>

	<span class="n">mga_flush_write_combine</span><span class="p">();</span>
	<span class="n">MGA_WRITE</span><span class="p">(</span><span class="n">MGA_PRIMEND</span><span class="p">,</span> <span class="n">tail</span> <span class="o">|</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">wrapped</span><span class="p">);</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mga_do_dma_wrap_end</span><span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_primary_buffer_t</span> <span class="o">*</span><span class="n">primary</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">;</span>
	<span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_wrap</span><span class="o">++</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   wrap = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_wrap</span><span class="p">);</span>

	<span class="n">mga_flush_write_combine</span><span class="p">();</span>
	<span class="n">MGA_WRITE</span><span class="p">(</span><span class="n">MGA_PRIMADDRESS</span><span class="p">,</span> <span class="n">head</span> <span class="o">|</span> <span class="n">MGA_DMA_GENERAL</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">wrapped</span><span class="p">);</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Freelist management</span>
<span class="cm"> */</span>

<span class="cp">#define MGA_BUFFER_USED		(~0)</span>
<span class="cp">#define MGA_BUFFER_FREE		0</span>

<span class="cp">#if MGA_FREELIST_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_freelist_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;current dispatch: last=0x%x done=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_dispatch</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">MGA_READ</span><span class="p">(</span><span class="n">MGA_PRIMADDRESS</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;current freelist:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">entry</span><span class="p">;</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;   %p   idx=%2d  age=0x%x 0x%06lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">entry</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">head</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_freelist_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">drm_mga_freelist_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">SET_AGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">,</span> <span class="n">MGA_BUFFER_USED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buflist</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">drm_mga_freelist_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">SET_AGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">,</span> <span class="n">MGA_BUFFER_FREE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">list_entry</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">discard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">dispatched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mga_freelist_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* FIXME: Still needed?</span>
<span class="c"> */</span>
<span class="c">static void mga_freelist_reset(struct drm_device *dev)</span>
<span class="c">{</span>
<span class="c">	struct drm_device_dma *dma = dev-&gt;dma;</span>
<span class="c">	struct drm_buf *buf;</span>
<span class="c">	drm_mga_buf_priv_t *buf_priv;</span>
<span class="c">	int i;</span>

<span class="c">	for (i = 0; i &lt; dma-&gt;buf_count; i++) {</span>
<span class="c">		buf = dma-&gt;buflist[i];</span>
<span class="c">		buf_priv = buf-&gt;dev_private;</span>
<span class="c">		SET_AGE(&amp;buf_priv-&gt;list_entry-&gt;age, MGA_BUFFER_FREE, 0);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="nf">mga_freelist_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">tail</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">head</span><span class="p">,</span> <span class="n">wrap</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">MGA_READ</span><span class="p">(</span><span class="n">MGA_PRIMADDRESS</span><span class="p">);</span>
	<span class="n">wrap</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_wrap</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   tail=0x%06lx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">tail</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">head</span> <span class="o">?</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">head</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">tail</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">wrap</span><span class="p">);</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;   head=0x%06lx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">head</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">wrap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TEST_AGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">wrap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="n">SET_AGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">,</span> <span class="n">MGA_BUFFER_USED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;returning NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mga_freelist_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_buf_priv_t</span> <span class="o">*</span><span class="n">buf_priv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_mga_freelist_t</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;age=0x%06lx wrap=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">list_entry</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">head</span> <span class="o">-</span>
				  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span>
		  <span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">list_entry</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">wrap</span><span class="p">);</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">list_entry</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_priv</span><span class="o">-&gt;</span><span class="n">list_entry</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="n">MGA_BUFFER_USED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SET_AGE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">,</span> <span class="n">MGA_BUFFER_FREE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">prev</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * DMA initialization, cleanup</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">mga_driver_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">drm_mga_private_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_priv</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">usec_timeout</span> <span class="o">=</span> <span class="n">MGA_DEFAULT_USEC_TIMEOUT</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">counters</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DRM_STAT_IRQ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DRM_STAT_PRIMARY</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DRM_STAT_SECONDARY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_vblank_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">mga_driver_unload</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if __OS_HAS_AGP</span>
<span class="cm">/**</span>
<span class="cm"> * Bootstrap the driver for AGP DMA.</span>
<span class="cm"> *</span>
<span class="cm"> * \todo</span>
<span class="cm"> * Investigate whether there is any benefit to storing the WARP microcode in</span>
<span class="cm"> * AGP memory.  If not, the microcode may as well always be put in PCI</span>
<span class="cm"> * memory.</span>
<span class="cm"> *</span>
<span class="cm"> * \todo</span>
<span class="cm"> * This routine needs to set dma_bs-&gt;agp_mode to the mode actually configured</span>
<span class="cm"> * in the hardware.  Looking just at the Linux AGP driver code, I don&#39;t see</span>
<span class="cm"> * an easy way to determine this.</span>
<span class="cm"> *</span>
<span class="cm"> * \sa mga_do_dma_bootstrap, mga_do_pci_dma_bootstrap</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_do_agp_dma_bootstrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">drm_mga_dma_bootstrap_t</span> <span class="o">*</span><span class="n">dma_bs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">dev_priv</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">warp_size</span> <span class="o">=</span> <span class="n">MGA_WARP_UCODE_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">secondary_size</span> <span class="o">=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_count</span>
	    <span class="o">*</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="n">agp_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">agp_size</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_buf_desc</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_agp_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_agp_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_agp_buffer</span> <span class="n">agp_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_agp_binding</span> <span class="n">bind_req</span><span class="p">;</span>

	<span class="cm">/* Acquire AGP. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_agp_acquire</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to acquire AGP: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_agp_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to get AGP info: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mode</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">)</span> <span class="o">|</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">agp_mode</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_agp_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to enable AGP (mode = 0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In addition to the usual AGP mode configuration, the G200 AGP cards</span>
<span class="cm">	 * need to have the AGP mode &quot;manually&quot; set.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="n">MGA_CARD_TYPE_G200</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">MGA_WRITE</span><span class="p">(</span><span class="n">MGA_AGP_PLL</span><span class="p">,</span> <span class="n">MGA_AGP2XPLL_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">MGA_WRITE</span><span class="p">(</span><span class="n">MGA_AGP_PLL</span><span class="p">,</span> <span class="n">MGA_AGP2XPLL_DISABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate and bind AGP memory. */</span>
	<span class="n">agp_req</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">agp_size</span><span class="p">;</span>
	<span class="n">agp_req</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_agp_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">agp_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to allocate %uMB AGP memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">agp_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_size</span> <span class="o">=</span> <span class="n">agp_size</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_handle</span> <span class="o">=</span> <span class="n">agp_req</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">bind_req</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">agp_req</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">bind_req</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_agp_bind</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bind_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to bind AGP memory: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make drm_addbufs happy by not trying to create a mapping for less</span>
<span class="cm">	 * than a page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">warp_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">warp_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">warp_size</span><span class="p">,</span>
			 <span class="n">_DRM_AGP</span><span class="p">,</span> <span class="n">_DRM_READ_ONLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to map WARP microcode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">warp_size</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">primary_size</span><span class="p">,</span>
			 <span class="n">_DRM_AGP</span><span class="p">,</span> <span class="n">_DRM_READ_ONLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to map primary DMA region: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">primary_size</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">secondary_size</span><span class="p">,</span>
			 <span class="n">_DRM_AGP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to map secondary DMA region: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
	<span class="n">req</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_count</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_size</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">_DRM_AGP_BUFFER</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">agp_start</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addbufs_agp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to add secondary DMA buffers: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_map_list</span> <span class="o">*</span><span class="n">_entry</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">agp_token</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">maplist</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">_entry</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">)</span>
				<span class="n">agp_token</span> <span class="o">=</span> <span class="n">_entry</span><span class="o">-&gt;</span><span class="n">user_token</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agp_token</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_token</span> <span class="o">=</span> <span class="n">agp_token</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="n">secondary_size</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">agp_size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">,</span>
			 <span class="n">_DRM_AGP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_textures</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to map AGP texture region %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_core_ioremap</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">drm_core_ioremap</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">drm_core_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to ioremap agp regions! (%p, %p, %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span> <span class="o">=</span> <span class="n">MGA_PAGPXFER</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wagp_enable</span> <span class="o">=</span> <span class="n">MGA_WAGP_ENABLE</span><span class="p">;</span>

	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Initialized card for AGP DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_do_agp_dma_bootstrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">drm_mga_dma_bootstrap_t</span> <span class="o">*</span><span class="n">dma_bs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * Bootstrap the driver for PCI DMA.</span>
<span class="cm"> *</span>
<span class="cm"> * \todo</span>
<span class="cm"> * The algorithm for decreasing the size of the primary DMA buffer could be</span>
<span class="cm"> * better.  The size should be rounded up to the nearest page size, then</span>
<span class="cm"> * decrease the request size by a single page each pass through the loop.</span>
<span class="cm"> *</span>
<span class="cm"> * \todo</span>
<span class="cm"> * Determine whether the maximum address passed to drm_pci_alloc is correct.</span>
<span class="cm"> * The same goes for drm_addbufs_pci.</span>
<span class="cm"> *</span>
<span class="cm"> * \sa mga_do_dma_bootstrap, mga_do_agp_dma_bootstrap</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_do_pci_dma_bootstrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">drm_mga_dma_bootstrap_t</span> <span class="o">*</span><span class="n">dma_bs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">dev_priv</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">warp_size</span> <span class="o">=</span> <span class="n">MGA_WARP_UCODE_SIZE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">primary_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bin_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_buf_desc</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;dev-&gt;dma is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make drm_addbufs happy by not trying to create a mapping for less</span>
<span class="cm">	 * than a page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">warp_size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
		<span class="n">warp_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="cm">/* The proper alignment is 0x100 for this mapping */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">warp_size</span><span class="p">,</span> <span class="n">_DRM_CONSISTENT</span><span class="p">,</span>
			 <span class="n">_DRM_READ_ONLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to create mapping for WARP microcode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Other than the bottom two bits being used to encode other</span>
<span class="cm">	 * information, there don&#39;t appear to be any restrictions on the</span>
<span class="cm">	 * alignment of the primary or secondary DMA buffers.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">primary_size</span> <span class="o">=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">primary_size</span><span class="p">;</span> <span class="n">primary_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">primary_size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The proper alignment for this mapping is 0x04 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">primary_size</span><span class="p">,</span> <span class="n">_DRM_CONSISTENT</span><span class="p">,</span>
				 <span class="n">_DRM_READ_ONLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to allocate primary DMA region: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">primary_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Primary DMA buffer size reduced from %u to %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">primary_size</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">primary_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bin_count</span> <span class="o">=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_count</span><span class="p">;</span> <span class="n">bin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">bin_count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
		<span class="n">req</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">bin_count</span><span class="p">;</span>
		<span class="n">req</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_size</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addbufs_pci</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bin_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to add secondary DMA buffers: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bin_count</span> <span class="o">!=</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Secondary PCI DMA buffer bin count reduced from %u &quot;</span>
			 <span class="s">&quot;to %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_count</span><span class="p">,</span> <span class="n">bin_count</span><span class="p">);</span>

		<span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">secondary_bin_count</span> <span class="o">=</span> <span class="n">bin_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wagp_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">agp_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Initialized card for PCI DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_do_dma_bootstrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">drm_mga_dma_bootstrap_t</span> <span class="o">*</span><span class="n">dma_bs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">is_agp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_bs</span><span class="o">-&gt;</span><span class="n">agp_mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">drm_pci_device_is_agp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">dev_priv</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">used_new_dma_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* The first steps are the same for both PCI and AGP based DMA.  Map</span>
<span class="cm">	 * the cards MMIO registers and map a status page.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">,</span>
			 <span class="n">_DRM_REGISTERS</span><span class="p">,</span> <span class="n">_DRM_READ_ONLY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to map MMIO region: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">drm_addmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAREA_MAX</span><span class="p">,</span> <span class="n">_DRM_SHM</span><span class="p">,</span>
			 <span class="n">_DRM_READ_ONLY</span> <span class="o">|</span> <span class="n">_DRM_LOCKED</span> <span class="o">|</span> <span class="n">_DRM_KERNEL</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to map status region: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The DMA initialization procedure is slightly different for PCI and</span>
<span class="cm">	 * AGP cards.  AGP cards just allocate a large block of AGP memory and</span>
<span class="cm">	 * carve off portions of it for internal uses.  The remaining memory</span>
<span class="cm">	 * is returned to user-mode to be used for AGP textures.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_agp</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mga_do_agp_dma_bootstrap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_bs</span><span class="p">);</span>

	<span class="cm">/* If we attempted to initialize the card for AGP DMA but failed,</span>
<span class="cm">	 * clean-up any mess that may have been created.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">mga_do_cleanup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MINIMAL_CLEANUP</span><span class="p">);</span>

	<span class="cm">/* Not only do we want to try and initialized PCI cards for PCI DMA,</span>
<span class="cm">	 * but we also try to initialized AGP cards that could not be</span>
<span class="cm">	 * initialized for AGP DMA.  This covers the case where we have an AGP</span>
<span class="cm">	 * card in a system with an unsupported AGP chipset.  In that case the</span>
<span class="cm">	 * card will be detected as AGP, but we won&#39;t be able to allocate any</span>
<span class="cm">	 * AGP memory, etc.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_agp</span> <span class="o">||</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mga_do_pci_dma_bootstrap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_bs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mga_dma_bootstrap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_dma_bootstrap_t</span> <span class="o">*</span><span class="n">bootstrap</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span> <span class="p">};</span>
	<span class="k">const</span> <span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="k">const</span> <span class="n">dev_priv</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mga_do_dma_bootstrap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mga_do_cleanup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FULL_CLEANUP</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_textures</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bootstrap</span><span class="o">-&gt;</span><span class="n">texture_handle</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_textures</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">bootstrap</span><span class="o">-&gt;</span><span class="n">texture_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_textures</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bootstrap</span><span class="o">-&gt;</span><span class="n">texture_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bootstrap</span><span class="o">-&gt;</span><span class="n">texture_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bootstrap</span><span class="o">-&gt;</span><span class="n">agp_mode</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">bootstrap</span><span class="o">-&gt;</span><span class="n">agp_mode</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_do_init_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">drm_mga_init_t</span> <span class="o">*</span><span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">sgram</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">clear_cmd</span> <span class="o">=</span> <span class="n">MGA_DWGCTL_CLEAR</span> <span class="o">|</span> <span class="n">MGA_ATYPE_BLK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">clear_cmd</span> <span class="o">=</span> <span class="n">MGA_DWGCTL_CLEAR</span> <span class="o">|</span> <span class="n">MGA_ATYPE_RSTR</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">maccess</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">maccess</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_cpp</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">fb_cpp</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">front_pitch</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">back_pitch</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_cpp</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">depth_cpp</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">depth_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">depth_pitch</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">depth_pitch</span><span class="p">;</span>

	<span class="cm">/* FIXME: Need to support AGP textures...</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">texture_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">texture_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">texture_size</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">texture_size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea</span> <span class="o">=</span> <span class="n">drm_getsarea</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to find sarea!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">used_new_dma_init</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span> <span class="o">=</span> <span class="n">MGA_PAGPXFER</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wagp_enable</span> <span class="o">=</span> <span class="n">MGA_WAGP_ENABLE</span><span class="p">;</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">status_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to find status page!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">mmio_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to find mmio region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span> <span class="o">=</span> <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">warp_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to find warp microcode region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">primary_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to find primary dma region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_token</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">buffers_offset</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span> <span class="o">=</span>
		    <span class="n">drm_core_findmap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">buffers_offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to find dma buffer region!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">drm_core_ioremap</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">drm_core_ioremap</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">drm_core_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">drm_mga_sarea_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">+</span>
				 <span class="n">init</span><span class="o">-&gt;</span><span class="n">sarea_priv_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dma_access</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to ioremap agp regions!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mga_warp_install_microcode</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to install WARP ucode!: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mga_warp_init</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to init WARP engine!: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="n">mga_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/* Init the primary DMA registers.</span>
<span class="cm">	 */</span>
	<span class="n">MGA_WRITE</span><span class="p">(</span><span class="n">MGA_PRIMADDRESS</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">|</span> <span class="n">MGA_DMA_GENERAL</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	MGA_WRITE(MGA_PRIMPTR, virt_to_bus((void *)dev_priv-&gt;prim.status) | MGA_PRIMPTREN0 |	/* Soft trap, SECEND, SETUPEND */</span>
<span class="c">		  MGA_PRIMPTREN1);	/* DWGSYNC */</span>
<span class="cp">#endif</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">handle</span>
			      <span class="o">+</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">wrapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">last_flush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">last_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">high_mark</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">DMA_BLOCK_SIZE</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_frame</span><span class="p">.</span><span class="n">wrap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mga_freelist_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;could not initialize freelist</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_do_cleanup_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">full_cleanup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Make sure interrupts are disabled here because the uninstall ioctl</span>
<span class="cm">	 * may not have been called from userspace and after dev_private</span>
<span class="cm">	 * is freed, it&#39;s too late.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_enabled</span><span class="p">)</span>
		<span class="n">drm_irq_uninstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">_DRM_CONSISTENT</span><span class="p">))</span>
			<span class="n">drm_core_ioremapfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">_DRM_CONSISTENT</span><span class="p">))</span>
			<span class="n">drm_core_ioremapfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">drm_core_ioremapfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">used_new_dma_init</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if __OS_HAS_AGP</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_handle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">drm_agp_binding</span> <span class="n">unbind_req</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">drm_agp_buffer</span> <span class="n">free_req</span><span class="p">;</span>

				<span class="n">unbind_req</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_handle</span><span class="p">;</span>
				<span class="n">drm_agp_unbind</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unbind_req</span><span class="p">);</span>

				<span class="n">free_req</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_handle</span><span class="p">;</span>
				<span class="n">drm_agp_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">free_req</span><span class="p">);</span>

				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_textures</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">agp_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">acquired</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">drm_agp_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">primary</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp_buffer_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">full_cleanup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">used_new_dma_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">));</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe_phys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">warp_pipe_phys</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">mga_freelist_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mga_dma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_init_t</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MGA_INIT_DMA</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">mga_do_init_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">mga_do_cleanup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FULL_CLEANUP</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MGA_CLEANUP_DMA</span>:
		<span class="k">return</span> <span class="n">mga_do_cleanup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FULL_CLEANUP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * Primary DMA stream management</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">mga_dma_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_lock</span> <span class="o">*</span><span class="n">lock</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_DRM_LOCK_FLUSH</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;flush, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_DRM_LOCK_FLUSH_ALL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;flush all, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_DRM_LOCK_QUIESCENT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;idle, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">WRAP_WAIT_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">_DRM_LOCK_FLUSH</span> <span class="o">|</span> <span class="n">_DRM_LOCK_FLUSH_ALL</span><span class="p">))</span>
		<span class="n">mga_do_dma_flush</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">_DRM_LOCK_QUIESCENT</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if MGA_DMA_DEBUG</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">mga_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;-EBUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">return</span> <span class="n">mga_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mga_dma_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mga_do_dma_reset</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ================================================================</span>
<span class="cm"> * DMA buffer management</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mga_dma_get_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_dma</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">granted_count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">mga_freelist_get</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">d</span><span class="o">-&gt;</span><span class="n">granted_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mga_dma_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device_dma</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_dma</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="cm">/* Please don&#39;t send us buffers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">send_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Process %d trying to send %d buffers via drmDMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">send_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We&#39;ll send you buffers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span> <span class="o">&gt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Process %d trying to get %d buffers (of %d max)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">DRM_CURRENTPID</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">buf_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WRAP_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">d</span><span class="o">-&gt;</span><span class="n">granted_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request_count</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mga_dma_get_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called just before the module is unloaded.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mga_driver_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called when the last opener of the device is closed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mga_driver_lastclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mga_do_cleanup_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FULL_CLEANUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">mga_driver_dma_quiescent</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mga_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mga_do_wait_for_idle</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
