<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › nouveau › nv04_crtc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nv04_crtc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 1993-2003 NVIDIA, Corporation</span>
<span class="cm"> * Copyright 2006 Dave Airlie</span>
<span class="cm"> * Copyright 2007 Maarten Maathuis</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>

<span class="cp">#include &quot;nouveau_drv.h&quot;</span>
<span class="cp">#include &quot;nouveau_encoder.h&quot;</span>
<span class="cp">#include &quot;nouveau_connector.h&quot;</span>
<span class="cp">#include &quot;nouveau_crtc.h&quot;</span>
<span class="cp">#include &quot;nouveau_fb.h&quot;</span>
<span class="cp">#include &quot;nouveau_hw.h&quot;</span>
<span class="cp">#include &quot;nvreg.h&quot;</span>
<span class="cp">#include &quot;nouveau_fbcon.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">nv04_crtc_mode_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">crtc_wr_cio_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">crtcstate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
		       <span class="n">crtcstate</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_set_digital_vibrance</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_CSB</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">&amp;&amp;</span> <span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_CSB</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_5B</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_5B</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_CSB</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_set_image_sharpening</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">sharpness</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* blur is in hw range 0x3f -&gt; 0x20 */</span>
		<span class="n">level</span> <span class="o">+=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_634</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_PRAMDAC_634</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_634</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PLLSEL_VPLL1_MASK				\</span>
<span class="cp">	(NV_PRAMDAC_PLL_COEFF_SELECT_SOURCE_PROG_VPLL	\</span>
<span class="cp">	 | NV_PRAMDAC_PLL_COEFF_SELECT_VCLK_RATIO_DB2)</span>
<span class="cp">#define PLLSEL_VPLL2_MASK				\</span>
<span class="cp">	(NV_PRAMDAC_PLL_COEFF_SELECT_PLL_SOURCE_VPLL2		\</span>
<span class="cp">	 | NV_PRAMDAC_PLL_COEFF_SELECT_VCLK2_RATIO_DB2)</span>
<span class="cp">#define PLLSEL_TV_MASK					\</span>
<span class="cp">	(NV_PRAMDAC_PLL_COEFF_SELECT_TV_VSCLK1		\</span>
<span class="cp">	 | NV_PRAMDAC_PLL_COEFF_SELECT_TV_PCLK1		\</span>
<span class="cp">	 | NV_PRAMDAC_PLL_COEFF_SELECT_TV_VSCLK2	\</span>
<span class="cp">	 | NV_PRAMDAC_PLL_COEFF_SELECT_TV_PCLK2)</span>

<span class="cm">/* NV4x 0x40.. pll notes:</span>
<span class="cm"> * gpu pll: 0x4000 + 0x4004</span>
<span class="cm"> * ?gpu? pll: 0x4008 + 0x400c</span>
<span class="cm"> * vpll1: 0x4010 + 0x4014</span>
<span class="cm"> * vpll2: 0x4018 + 0x401c</span>
<span class="cm"> * mpll: 0x4020 + 0x4024</span>
<span class="cm"> * mpll: 0x4038 + 0x403c</span>
<span class="cm"> *</span>
<span class="cm"> * the first register of each pair has some unknown details:</span>
<span class="cm"> * bits 0-7: redirected values from elsewhere? (similar to PLL_SETUP_CONTROL?)</span>
<span class="cm"> * bits 20-23: (mpll) something to do with post divider?</span>
<span class="cm"> * bits 28-31: related to single stage mode? (bit 8/12)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_calc_state_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dot_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regp</span><span class="o">-&gt;</span><span class="n">pllvals</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pll_lims</span> <span class="n">pll_lim</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_pll_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">?</span> <span class="n">PLL_VPLL1</span> <span class="o">:</span> <span class="n">PLL_VPLL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll_lim</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* NM2 == 0 is used to determine single stage mode on two stage plls */</span>
	<span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* for newer nv4x the blob uses only the first stage of the vpll below a</span>
<span class="cm">	 * certain clock.  for a certain nv4b this is 150MHz.  since the max</span>
<span class="cm">	 * output frequency of the first stage for this card is 300MHz, it is</span>
<span class="cm">	 * assumed the threshold is given by vco1 maxfreq/2</span>
<span class="cm">	 */</span>
	<span class="cm">/* for early nv4x, specifically nv40 and *some* nv43 (devids 0 and 6,</span>
<span class="cm">	 * not 8, others unknown), the blob always uses both plls.  no problem</span>
<span class="cm">	 * has yet been observed in allowing the use a single stage pll on all</span>
<span class="cm">	 * nv43 however.  the behaviour of single stage use is untested on nv40</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span> <span class="n">dot_clock</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">pll_lim</span><span class="p">.</span><span class="n">vco1</span><span class="p">.</span><span class="n">maxfreq</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pll_lim</span><span class="p">.</span><span class="n">vco2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pll_lim</span><span class="p">.</span><span class="n">vco2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nouveau_calc_pll_mnp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll_lim</span><span class="p">,</span> <span class="n">dot_clock</span><span class="p">,</span> <span class="n">pv</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span> <span class="o">&amp;=</span> <span class="n">PLLSEL_VPLL1_MASK</span> <span class="o">|</span> <span class="n">PLLSEL_VPLL2_MASK</span> <span class="o">|</span> <span class="n">PLLSEL_TV_MASK</span><span class="p">;</span>

	<span class="cm">/* The blob uses this always, so let&#39;s do the same */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span> <span class="o">|=</span> <span class="n">NV_PRAMDAC_PLL_COEFF_SELECT_USE_VPLL2_TRUE</span><span class="p">;</span>
	<span class="cm">/* again nv40 and some nv43 act more like nv3x as described above */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&lt;</span> <span class="mh">0x41</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span> <span class="o">|=</span> <span class="n">NV_PRAMDAC_PLL_COEFF_SELECT_SOURCE_PROG_MPLL</span> <span class="o">|</span>
				 <span class="n">NV_PRAMDAC_PLL_COEFF_SELECT_SOURCE_PROG_NVPLL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span> <span class="o">|=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">?</span> <span class="n">PLLSEL_VPLL2_MASK</span> <span class="o">:</span> <span class="n">PLLSEL_VPLL1_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM2</span><span class="p">)</span>
		<span class="n">NV_DEBUG_KMS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vpll: n1 %d n2 %d m1 %d m2 %d log2p %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N1</span><span class="p">,</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N2</span><span class="p">,</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M1</span><span class="p">,</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M2</span><span class="p">,</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">NV_DEBUG_KMS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vpll: n %d m %d log2p %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N1</span><span class="p">,</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M1</span><span class="p">,</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span><span class="p">);</span>

	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">set_offset</span><span class="p">(</span><span class="n">nv_crtc</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seq1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">crtc17</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">crtc1A</span><span class="p">;</span>

	<span class="n">NV_DEBUG_KMS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Setting dpms mode %d on CRTC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
							<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">last_dpms</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span> <span class="cm">/* Don&#39;t do unnecessary mode changes. */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">last_dpms</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVSetOwner</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* nv4ref indicates these two RPC1 bits inhibit h/v sync */</span>
	<span class="n">crtc1A</span> <span class="o">=</span> <span class="n">NVReadVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
					<span class="n">NV_CIO_CRE_RPC1_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xC0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
		<span class="cm">/* Screen: Off; HSync: Off, VSync: On -- Not Supported */</span>
		<span class="n">seq1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">crtc17</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">crtc1A</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="cm">/* Screen: Off; HSync: On, VSync: Off -- Not Supported */</span>
		<span class="n">seq1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">crtc17</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">crtc1A</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="cm">/* Screen: Off; HSync: Off, VSync: Off */</span>
		<span class="n">seq1</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">crtc17</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">crtc1A</span> <span class="o">|=</span> <span class="mh">0xC0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="nl">default:</span>
		<span class="cm">/* Screen: On; HSync: On, VSync: On */</span>
		<span class="n">seq1</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">crtc17</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NVVgaSeqReset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="cm">/* Each head has it&#39;s own sequencer, so we can turn it off when we want */</span>
	<span class="n">seq1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NVReadVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_VIO_SR_CLOCK_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
	<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_VIO_SR_CLOCK_INDEX</span><span class="p">,</span> <span class="n">seq1</span><span class="p">);</span>
	<span class="n">crtc17</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NVReadVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_CIO_CR_MODE_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_CIO_CR_MODE_INDEX</span><span class="p">,</span> <span class="n">crtc17</span><span class="p">);</span>
	<span class="n">NVVgaSeqReset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC1_INDEX</span><span class="p">,</span> <span class="n">crtc1A</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">nv_crtc_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_crtc_mode_set_vga</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>

	<span class="cm">/* Calculate our timings */</span>
	<span class="kt">int</span> <span class="n">horizDisplay</span>	<span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>		<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">horizStart</span>		<span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> 	<span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">horizEnd</span>		<span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>		<span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">horizTotal</span>		<span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>		<span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">horizBlankStart</span>	<span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>		<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">horizBlankEnd</span>	<span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>		<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vertDisplay</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span>			<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vertStart</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> 		<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vertEnd</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span>			<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vertTotal</span>		<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> 			<span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vertBlankStart</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> 			<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vertBlankEnd</span>	<span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span>			<span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fp_output</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nouveau_encoder</span> <span class="o">*</span><span class="n">nv_encoder</span> <span class="o">=</span> <span class="n">nouveau_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">nv_encoder</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OUTPUT_LVDS</span> <span class="o">||</span>
		     <span class="n">nv_encoder</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OUTPUT_TMDS</span><span class="p">))</span>
			<span class="n">fp_output</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vertStart</span> <span class="o">=</span> <span class="n">vertTotal</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">vertEnd</span> <span class="o">=</span> <span class="n">vertTotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">vertBlankStart</span> <span class="o">=</span> <span class="n">vertStart</span><span class="p">;</span>
		<span class="n">horizStart</span> <span class="o">=</span> <span class="n">horizTotal</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">horizEnd</span> <span class="o">=</span> <span class="n">horizTotal</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">horizBlankEnd</span> <span class="o">=</span> <span class="n">horizTotal</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		if (dev-&gt;overlayAdaptor &amp;&amp; dev_priv-&gt;card_type &gt;= NV_10)</span>
<span class="c">			/* This reportedly works around some video overlay bandwidth problems */</span>
<span class="c">			horizTotal += 2;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span>
		<span class="n">vertTotal</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	ErrorF(&quot;horizDisplay: 0x%X \n&quot;, horizDisplay);</span>
<span class="c">	ErrorF(&quot;horizStart: 0x%X \n&quot;, horizStart);</span>
<span class="c">	ErrorF(&quot;horizEnd: 0x%X \n&quot;, horizEnd);</span>
<span class="c">	ErrorF(&quot;horizTotal: 0x%X \n&quot;, horizTotal);</span>
<span class="c">	ErrorF(&quot;horizBlankStart: 0x%X \n&quot;, horizBlankStart);</span>
<span class="c">	ErrorF(&quot;horizBlankEnd: 0x%X \n&quot;, horizBlankEnd);</span>
<span class="c">	ErrorF(&quot;vertDisplay: 0x%X \n&quot;, vertDisplay);</span>
<span class="c">	ErrorF(&quot;vertStart: 0x%X \n&quot;, vertStart);</span>
<span class="c">	ErrorF(&quot;vertEnd: 0x%X \n&quot;, vertEnd);</span>
<span class="c">	ErrorF(&quot;vertTotal: 0x%X \n&quot;, vertTotal);</span>
<span class="c">	ErrorF(&quot;vertBlankStart: 0x%X \n&quot;, vertBlankStart);</span>
<span class="c">	ErrorF(&quot;vertBlankEnd: 0x%X \n&quot;, vertBlankEnd);</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	* compute correct Hsync &amp; Vsync polarity</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span><span class="p">))</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DRM_MODE_FLAG_PVSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">vdisplay</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">)</span>
			<span class="n">vdisplay</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vscan</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">vdisplay</span> <span class="o">*=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vscan</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vdisplay</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0xA3</span><span class="p">;</span>	<span class="cm">/* +hsync -vsync */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vdisplay</span> <span class="o">&lt;</span> <span class="mi">480</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0x63</span><span class="p">;</span>	<span class="cm">/* -hsync +vsync */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vdisplay</span> <span class="o">&lt;</span> <span class="mi">768</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0xE3</span><span class="p">;</span>	<span class="cm">/* -hsync -vsync */</span>
		<span class="k">else</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="mh">0x23</span><span class="p">;</span>	<span class="cm">/* +hsync +vsync */</span>
	<span class="p">}</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock_index</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Time Sequencer</span>
<span class="cm">	 */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">NV_VIO_SR_RESET_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* 0x20 disables the sequencer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_CLKDIV2</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">NV_VIO_SR_CLOCK_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x29</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">NV_VIO_SR_CLOCK_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">NV_VIO_SR_PLANE_MASK_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">NV_VIO_SR_CHAR_MAP_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">NV_VIO_SR_MEM_MODE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CRTC</span>
<span class="cm">	 */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_HDT_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">horizTotal</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_HDE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">horizDisplay</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_HBS_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">horizBlankStart</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_HBE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">horizBlankEnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_CR_HBE_4_0</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_HRS_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">horizStart</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_HRE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">XLATE</span><span class="p">(</span><span class="n">horizBlankEnd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">NV_CIO_CR_HRE_HBE_5</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">horizEnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_CR_HRE_4_0</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_VDT_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertTotal</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_OVL_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">XLATE</span><span class="p">(</span><span class="n">vertStart</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">NV_CIO_CR_OVL_VRS_9</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">vertDisplay</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">NV_CIO_CR_OVL_VDE_9</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">vertTotal</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">NV_CIO_CR_OVL_VDT_9</span><span class="p">)</span> <span class="o">|</span>
					  <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">vertBlankStart</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CR_OVL_VBS_8</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">vertStart</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CR_OVL_VRS_8</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">vertDisplay</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CR_OVL_VDE_8</span><span class="p">)</span> <span class="o">|</span>
					  <span class="n">XLATE</span><span class="p">(</span><span class="n">vertTotal</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CR_OVL_VDT_8</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_RSAL_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_CELL_HT_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">)</span> <span class="o">?</span> <span class="n">MASK</span><span class="p">(</span><span class="n">NV_CIO_CR_CELL_HT_SCANDBL</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
					      <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span>
					      <span class="n">XLATE</span><span class="p">(</span><span class="n">vertBlankStart</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">NV_CIO_CR_CELL_HT_VBS_9</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_CURS_ST_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_CURS_END_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_SA_HI_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_SA_LO_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_TCOFF_HI_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_TCOFF_LO_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_VRS_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertStart</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_VRE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span> <span class="n">XLATE</span><span class="p">(</span><span class="n">vertEnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_CR_VRE_3_0</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_VDE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertDisplay</span><span class="p">;</span>
	<span class="cm">/* framebuffer can be larger than crtc scanout area. */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_OFFSET_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_ULINE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_VBS_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertBlankStart</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_VBE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertBlankEnd</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_MODE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_LCOMP_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some extended CRTC registers (they are not saved with the rest of the vga regs).</span>
<span class="cm">	 */</span>

	<span class="cm">/* framebuffer can be larger than crtc scanout area. */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_RPC0_INDEX</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">XLATE</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC0_OFFSET_10_8</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_42</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">XLATE</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">NV_CIO_CRE_42_OFFSET_11</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_RPC1_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">&lt;</span> <span class="mi">1280</span> <span class="o">?</span>
					    <span class="n">MASK</span><span class="p">(</span><span class="n">NV_CIO_CRE_RPC1_LARGE</span><span class="p">)</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_LSR_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">XLATE</span><span class="p">(</span><span class="n">horizBlankEnd</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LSR_HBE_6</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">XLATE</span><span class="p">(</span><span class="n">vertBlankStart</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LSR_VBS_10</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">XLATE</span><span class="p">(</span><span class="n">vertStart</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LSR_VRS_10</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">XLATE</span><span class="p">(</span><span class="n">vertDisplay</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LSR_VDE_10</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">XLATE</span><span class="p">(</span><span class="n">vertTotal</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LSR_VDT_10</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_HEB__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">XLATE</span><span class="p">(</span><span class="n">horizStart</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HEB_HRS_8</span><span class="p">)</span> <span class="o">|</span>
					    <span class="n">XLATE</span><span class="p">(</span><span class="n">horizBlankStart</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HEB_HBS_8</span><span class="p">)</span> <span class="o">|</span>
					    <span class="n">XLATE</span><span class="p">(</span><span class="n">horizDisplay</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HEB_HDE_8</span><span class="p">)</span> <span class="o">|</span>
					    <span class="n">XLATE</span><span class="p">(</span><span class="n">horizTotal</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HEB_HDT_8</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_EBR_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">XLATE</span><span class="p">(</span><span class="n">vertBlankStart</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">NV_CIO_CRE_EBR_VBS_11</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">XLATE</span><span class="p">(</span><span class="n">vertStart</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">NV_CIO_CRE_EBR_VRS_11</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">XLATE</span><span class="p">(</span><span class="n">vertDisplay</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">NV_CIO_CRE_EBR_VDE_11</span><span class="p">)</span> <span class="o">|</span>
					   <span class="n">XLATE</span><span class="p">(</span><span class="n">vertTotal</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">NV_CIO_CRE_EBR_VDT_11</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">horizTotal</span> <span class="o">=</span> <span class="p">(</span><span class="n">horizTotal</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_ILACE__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">horizTotal</span><span class="p">;</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_HEB__INDEX</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XLATE</span><span class="p">(</span><span class="n">horizTotal</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HEB_ILC_8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_ILACE__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>  <span class="cm">/* interlace off */</span>

	<span class="cm">/*</span>
<span class="cm">	* Graphics Display Controller</span>
<span class="cm">	*/</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_SR_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_SREN_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_CCOMP_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_ROP_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_READ_MAP_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_MODE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="cm">/* 256 color mode */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_MISC_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span> <span class="cm">/* map 64k mem + graphic mode */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_DONT_CARE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">NV_VIO_GX_BIT_MASK_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* standard colormap translation */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0C</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0D</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0E</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">NV_CIO_AR_MODE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* Enable graphic mode */</span>
	<span class="cm">/* Non-vga */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">NV_CIO_AR_OSCAN_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">NV_CIO_AR_PLANE_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span> <span class="cm">/* enable all color planes */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">NV_CIO_AR_HPP_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">NV_CIO_AR_CSEL_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets up registers for the given mode/adjusted_mode pair.</span>
<span class="cm"> *</span>
<span class="cm"> * The clocks, CRTCs and outputs attached to this CRTC must be off.</span>
<span class="cm"> *</span>
<span class="cm"> * This shouldn&#39;t enable any clocks, CRTCs, or outputs, but they should</span>
<span class="cm"> * be easily turned on/off after this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_crtc_mode_set_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">savep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">saved_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">lvds_output</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">tmds_output</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">tv_output</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="n">off_chip_digital</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">nouveau_encoder</span> <span class="o">*</span><span class="n">nv_encoder</span> <span class="o">=</span> <span class="n">nouveau_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="n">bool</span> <span class="n">digital</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nv_encoder</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OUTPUT_LVDS</span><span class="p">)</span>
			<span class="n">digital</span> <span class="o">=</span> <span class="n">lvds_output</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_encoder</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OUTPUT_TV</span><span class="p">)</span>
			<span class="n">tv_output</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_encoder</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OUTPUT_TMDS</span><span class="p">)</span>
			<span class="n">digital</span> <span class="o">=</span> <span class="n">tmds_output</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_encoder</span><span class="o">-&gt;</span><span class="n">dcb</span><span class="o">-&gt;</span><span class="n">location</span> <span class="o">!=</span> <span class="n">DCB_LOC_ON_CHIP</span> <span class="o">&amp;&amp;</span> <span class="n">digital</span><span class="p">)</span>
			<span class="n">off_chip_digital</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Registers not directly related to the (s)vga mode */</span>

	<span class="cm">/* What is the meaning of this register? */</span>
	<span class="cm">/* A few popular values are 0x18, 0x1c, 0x38, 0x3c */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_ENH_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">savep</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_ENH_INDEX</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_eng_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Except for rare conditions I2C is enabled on the primary crtc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_eng_ctrl</span> <span class="o">|=</span> <span class="n">NV_CRTC_FSEL_I2C</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Set overlay to desired crtc. */</span>
<span class="c">	if (dev-&gt;overlayAdaptor) {</span>
<span class="c">		NVPortPrivPtr pPriv = GET_OVERLAY_PRIVATE(dev);</span>
<span class="c">		if (pPriv-&gt;overlayCRTC == nv_crtc-&gt;index)</span>
<span class="c">			regp-&gt;crtc_eng_ctrl |= NV_CRTC_FSEL_OVERLAY;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="cm">/* ADDRESS_SPACE_PNVM is the same as setting HCUR_ASI */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">cursor_cfg</span> <span class="o">=</span> <span class="n">NV_PCRTC_CURSOR_CONFIG_CUR_LINES_64</span> <span class="o">|</span>
			     <span class="n">NV_PCRTC_CURSOR_CONFIG_CUR_PIXELS_64</span> <span class="o">|</span>
			     <span class="n">NV_PCRTC_CURSOR_CONFIG_ADDRESS_SPACE_PNVM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">cursor_cfg</span> <span class="o">|=</span> <span class="n">NV_PCRTC_CURSOR_CONFIG_CUR_BPP_32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">cursor_cfg</span> <span class="o">|=</span> <span class="n">NV_PCRTC_CURSOR_CONFIG_DOUBLE_SCAN_ENABLE</span><span class="p">;</span>

	<span class="cm">/* Unblock some timings */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_53</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_54</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* 0x00 is disabled, 0x11 is lvds, 0x22 crt and 0x88 tmds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvds_output</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_SCRATCH3__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmds_output</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_SCRATCH3__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x88</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_SCRATCH3__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>

	<span class="cm">/* These values seem to vary */</span>
	<span class="cm">/* This register seems to be used by the bios to make certain decisions on some G70 cards? */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_SCRATCH4__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">savep</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_SCRATCH4__INDEX</span><span class="p">];</span>

	<span class="n">nv_crtc_set_digital_vibrance</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">);</span>

	<span class="cm">/* probably a scratch reg, but kept for cargo-cult purposes:</span>
<span class="cm">	 * bit0: crtc0?, head A</span>
<span class="cm">	 * bit6: lvds, head A</span>
<span class="cm">	 * bit7: (only in X), head A</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_4B</span><span class="p">]</span> <span class="o">=</span> <span class="n">savep</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_4B</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="cm">/* The blob seems to take the current value from crtc 0, add 4 to that</span>
<span class="cm">	 * and reuse the old value for crtc 1 */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_TVOUT_LATENCY</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">saved_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_TVOUT_LATENCY</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_TVOUT_LATENCY</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* the blob sometimes sets |= 0x10 (which is the same as setting |=</span>
<span class="cm">	 * 1 &lt;&lt; 30 on 0x60.830), for no apparent reason */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_59</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_chip_digital</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_30</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="mh">0x9f</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_chip_digital</span> <span class="o">?</span> <span class="mh">0x11</span> <span class="o">:</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_830</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_834</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span>
		<span class="cm">/* This is what the blob does */</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_850</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PCRTC_850</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_30</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">gpio_ext</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PCRTC_GPIO_EXT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_cfg</span> <span class="o">=</span> <span class="n">NV10_PCRTC_CONFIG_START_ADDRESS_HSYNC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_cfg</span> <span class="o">=</span> <span class="n">NV04_PCRTC_CONFIG_START_ADDRESS_HSYNC</span><span class="p">;</span>

	<span class="cm">/* Some misc regs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_85</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_86</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_PIXEL_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="cm">/* Enable slaved mode (called MODE_TV in nv4ref.h) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvds_output</span> <span class="o">||</span> <span class="n">tmds_output</span> <span class="o">||</span> <span class="n">tv_output</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_PIXEL_INDEX</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="cm">/* Generic PRAMDAC regs */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span>
		<span class="cm">/* Only bit that bios and blob set. */</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">nv10_cursync</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">);</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span> <span class="o">=</span> <span class="n">NV_PRAMDAC_GENERAL_CONTROL_BPC_8BITS</span> <span class="o">|</span>
				<span class="n">NV_PRAMDAC_GENERAL_CONTROL_VGA_STATE_SEL</span> <span class="o">|</span>
				<span class="n">NV_PRAMDAC_GENERAL_CONTROL_PIXMIX_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span> <span class="o">|=</span> <span class="n">NV_PRAMDAC_GENERAL_CONTROL_ALT_MODE_SEL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span> <span class="o">|=</span> <span class="n">NV_PRAMDAC_GENERAL_CONTROL_PIPE_LONG</span><span class="p">;</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_630</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* turn off green mode (tv test pattern?) */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_setup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nv_crtc_set_image_sharpening</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">sharpness</span><span class="p">);</span>

	<span class="cm">/* Some values the blob sets */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_8c0</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a20</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a24</span> <span class="o">=</span> <span class="mh">0xfffff</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a34</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets up registers for the given mode/adjusted_mode pair.</span>
<span class="cm"> *</span>
<span class="cm"> * The clocks, CRTCs and outputs attached to this CRTC must be off.</span>
<span class="cm"> *</span>
<span class="cm"> * This shouldn&#39;t enable any clocks, CRTCs, or outputs, but they should</span>
<span class="cm"> * be easily turned on/off after this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nv_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">NV_DEBUG_KMS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CTRC mode on CRTC %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="cm">/* unlock must come after turning off FP_TG_CONTROL in output_prepare */</span>
	<span class="n">nv_lock_vga_crtc_shadow</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">nv_crtc_mode_set_vga</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="cm">/* calculated in nv04_dfp_prepare, nv40 needs it written before calculating PLLs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_SEL_CLK</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">.</span><span class="n">sel_clk</span><span class="p">);</span>
	<span class="n">nv_crtc_mode_set_regs</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="n">nv_crtc_calc_state_ext</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">crtc_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">saved</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">saved_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">crtc_saved</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saved</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVSetOwner</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">nouveau_hw_save_state</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">saved</span><span class="p">);</span>

	<span class="cm">/* init some state to saved value */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">sel_clk</span> <span class="o">=</span> <span class="n">saved</span><span class="o">-&gt;</span><span class="n">sel_clk</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x5</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_LCD__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">crtc_saved</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_LCD__INDEX</span><span class="p">];</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span> <span class="o">=</span> <span class="n">saved</span><span class="o">-&gt;</span><span class="n">pllsel</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PLLSEL_VPLL1_MASK</span> <span class="o">|</span> <span class="n">PLLSEL_VPLL2_MASK</span> <span class="o">|</span> <span class="n">PLLSEL_TV_MASK</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">gpio_ext</span> <span class="o">=</span> <span class="n">crtc_saved</span><span class="o">-&gt;</span><span class="n">gpio_ext</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">head</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">saved_cr21</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">saved_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_21</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVSetOwner</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>

	<span class="n">nouveau_hw_load_state</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">saved_reg</span><span class="p">);</span>
	<span class="n">nv_lock_vga_crtc_shadow</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">saved_cr21</span><span class="p">);</span>

	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">last_dpms</span> <span class="o">=</span> <span class="n">NV_DPMS_CLEARED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVSetOwner</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">drm_vblank_pre_modeset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>

	<span class="n">NVBlankScreen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Some more preparation. */</span>
	<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_PCRTC_CONFIG</span><span class="p">,</span> <span class="n">NV_PCRTC_CONFIG_START_ADDRESS_NON_VGA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">reg900</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_PRAMDAC_900</span><span class="p">);</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_PRAMDAC_900</span><span class="p">,</span> <span class="n">reg900</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">nouveau_hw_load_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">);</span>
	<span class="n">nv04_crtc_mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="cm">/* turn on LFB swapping */</span>
	<span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">NVReadVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RCR</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">MASK</span><span class="p">(</span><span class="n">NV_CIO_CRE_RCR_ENDIAN_BIG</span><span class="p">);</span>
		<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RCR</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
	<span class="n">drm_vblank_post_modeset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_crtc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">NV_DEBUG_KMS</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_crtc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">drm_crtc_cleanup</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">nouveau_bo_unmap</span><span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">);</span>
	<span class="n">nouveau_bo_ref</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">nv_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_crtc_gamma_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rgb</span> <span class="p">{</span> <span class="kt">uint8_t</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="o">*</span><span class="n">rgbs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rgbs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rgb</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">DAC</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rgbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">r</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rgbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">g</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">rgbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nouveau_hw_load_state_palette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_crtc_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">start</span><span class="p">,</span>
		  <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* We need to know the depth before we upload, but it&#39;s possible to</span>
<span class="cm">	 * get called before a framebuffer is bound.  If this is the case,</span>
<span class="cm">	 * mark the lut values as dirty by setting depth==0, and it&#39;ll be</span>
<span class="cm">	 * uploaded on the first mode_set_base()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nv_crtc_gamma_load</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nv04_crtc_do_mode_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">passed_fb</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="n">bool</span> <span class="n">atomic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">.</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">drm_fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arb_burst</span><span class="p">,</span> <span class="n">arb_lwm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">NV_DEBUG_KMS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/* no fb bound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NV_DEBUG_KMS</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No FB bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* If atomic, we want to switch to the fb we were passed, so</span>
<span class="cm">	 * now we update pointers to do that.  (We don&#39;t pin; just</span>
<span class="cm">	 * assume we&#39;re already pinned and update the base address.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_fb</span> <span class="o">=</span> <span class="n">passed_fb</span><span class="p">;</span>
		<span class="n">fb</span> <span class="o">=</span> <span class="n">nouveau_framebuffer</span><span class="p">(</span><span class="n">passed_fb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">drm_fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
		<span class="n">fb</span> <span class="o">=</span> <span class="n">nouveau_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
		<span class="cm">/* If not atomic, we can go ahead and pin, and unpin the</span>
<span class="cm">		 * old fb we were passed.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nouveau_bo_pin</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">nvbo</span><span class="p">,</span> <span class="n">TTM_PL_FLAG_VRAM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">passed_fb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">nouveau_framebuffer</span> <span class="o">*</span><span class="n">ofb</span> <span class="o">=</span> <span class="n">nouveau_framebuffer</span><span class="p">(</span><span class="n">passed_fb</span><span class="p">);</span>
			<span class="n">nouveau_bo_unpin</span><span class="p">(</span><span class="n">ofb</span><span class="o">-&gt;</span><span class="n">nvbo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">nvbo</span><span class="o">-&gt;</span><span class="n">bo</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">depth</span> <span class="o">!=</span> <span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
		<span class="n">nv_crtc_gamma_load</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update the framebuffer format. */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_PIXEL_INDEX</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_PIXEL_INDEX</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_PRAMDAC_GENERAL_CONTROL_ALT_MODE_SEL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span> <span class="o">|=</span> <span class="n">NV_PRAMDAC_GENERAL_CONTROL_ALT_MODE_SEL</span><span class="p">;</span>
	<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_PIXEL_INDEX</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">NV_PRAMDAC_GENERAL_CONTROL</span><span class="p">,</span>
		      <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span><span class="p">);</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CR_OFFSET_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_RPC0_INDEX</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">XLATE</span><span class="p">(</span><span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC0_OFFSET_10_8</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_42</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">XLATE</span><span class="p">(</span><span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">NV_CIO_CRE_42_OFFSET_11</span><span class="p">);</span>
	<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC0_INDEX</span><span class="p">);</span>
	<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CR_OFFSET_INDEX</span><span class="p">);</span>
	<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_42</span><span class="p">);</span>

	<span class="cm">/* Update the framebuffer location. */</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fb_start</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fb_start</span> <span class="o">+=</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">nv_set_crtc_base</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fb_start</span><span class="p">);</span>

	<span class="cm">/* Update the arbitration parameters. */</span>
	<span class="n">nouveau_calc_arb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">,</span> <span class="n">drm_fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">arb_burst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arb_lwm</span><span class="p">);</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_FF_INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">arb_burst</span><span class="p">;</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_FFLWM__INDEX</span><span class="p">]</span> <span class="o">=</span> <span class="n">arb_lwm</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_FF_INDEX</span><span class="p">);</span>
	<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_FFLWM__INDEX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">NV_CIO_CRE_47</span><span class="p">]</span> <span class="o">=</span> <span class="n">arb_lwm</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">crtc_wr_cio_state</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_47</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nv04_crtc_mode_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">nv04_crtc_do_mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nv04_crtc_mode_set_base_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="k">enum</span> <span class="n">mode_set_atomic</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ENTER_ATOMIC_MODE_SET</span><span class="p">)</span>
		<span class="n">nouveau_fbcon_save_disable_accel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nouveau_fbcon_restore_accel</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nv04_crtc_do_mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv04_cursor_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nouveau_bo</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">nouveau_bo</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">nv_cursor_width</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pixel</span> <span class="o">=</span> <span class="n">nouveau_bo_rd32</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">64</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>

			<span class="n">nouveau_bo_wr16</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">width</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
				     <span class="o">|</span> <span class="p">(</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0xf80000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span>
				     <span class="o">|</span> <span class="p">(</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span>
				     <span class="o">|</span> <span class="p">(</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv11_cursor_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nouveau_bo</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">nouveau_bo</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* nv11+ supports premultiplied (PM), or non-premultiplied (NPM) alpha</span>
<span class="cm">	 * cursors (though NPM in combination with fp dithering may not work on</span>
<span class="cm">	 * nv11, from &quot;nv&quot; driver history)</span>
<span class="cm">	 * NPM mode needs NV_PCRTC_CURSOR_CONFIG_ALPHA_BLEND set and is what the</span>
<span class="cm">	 * blob uses, however we get given PM cursors so we use PM mode</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pixel</span> <span class="o">=</span> <span class="n">nouveau_bo_rd32</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="cm">/* hw gets unhappy if alpha &lt;= rgb values.  for a PM image &quot;less</span>
<span class="cm">		 * than&quot; shouldn&#39;t happen; fix &quot;equal to&quot; case by adding one to</span>
<span class="cm">		 * alpha channel (slightly inaccurate, but so is attempting to</span>
<span class="cm">		 * get back to NPM images, due to limits of integer precision)</span>
<span class="cm">		 */</span>
		<span class="n">alpha</span> <span class="o">=</span> <span class="n">pixel</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alpha</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">alpha</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pixel</span> <span class="o">=</span> <span class="p">((</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">pixel</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="n">nouveau_bo_wr32</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pixel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nv04_crtc_cursor_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
		     <span class="kt">uint32_t</span> <span class="n">buffer_handle</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">width</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nouveau_bo</span> <span class="o">*</span><span class="n">cursor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">gem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">hide</span><span class="p">(</span><span class="n">nv_crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">!=</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">height</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">gem</span> <span class="o">=</span> <span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">buffer_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="n">cursor</span> <span class="o">=</span> <span class="n">nouveau_gem_object</span><span class="p">(</span><span class="n">gem</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nouveau_bo_map</span><span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="n">nv11_cursor_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nv04_cursor_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">);</span>

	<span class="n">nouveau_bo_unmap</span><span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="o">-&gt;</span><span class="n">bo</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">set_offset</span><span class="p">(</span><span class="n">nv_crtc</span><span class="p">,</span> <span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">nv_crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="n">gem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nv04_crtc_cursor_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">nouveau_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">set_pos</span><span class="p">(</span><span class="n">nv_crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_funcs</span> <span class="n">nv04_crtc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">nv_crtc_save</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">nv_crtc_restore</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_set</span> <span class="o">=</span> <span class="n">nv04_crtc_cursor_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_move</span> <span class="o">=</span> <span class="n">nv04_crtc_cursor_move</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gamma_set</span> <span class="o">=</span> <span class="n">nv_crtc_gamma_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_config</span> <span class="o">=</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page_flip</span> <span class="o">=</span> <span class="n">nouveau_crtc_page_flip</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">nv_crtc_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="n">nv04_crtc_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">nv_crtc_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">nv_crtc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">nv_crtc_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">nv_crtc_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">nv_crtc_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base</span> <span class="o">=</span> <span class="n">nv04_crtc_mode_set_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base_atomic</span> <span class="o">=</span> <span class="n">nv04_crtc_mode_set_base_atomic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_lut</span> <span class="o">=</span> <span class="n">nv_crtc_gamma_load</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">nv04_crtc_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">crtc_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_crtc</span> <span class="o">*</span><span class="n">nv_crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nv_crtc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nv_crtc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_crtc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">lut</span><span class="p">.</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">crtc_num</span><span class="p">;</span>
	<span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">last_dpms</span> <span class="o">=</span> <span class="n">NV_DPMS_CLEARED</span><span class="p">;</span>

	<span class="n">drm_crtc_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv04_crtc_funcs</span><span class="p">);</span>
	<span class="n">drm_crtc_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv04_crtc_helper_funcs</span><span class="p">);</span>
	<span class="n">drm_mode_crtc_set_gamma_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nouveau_bo_new</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">64</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">,</span> <span class="n">TTM_PL_FLAG_VRAM</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">nouveau_bo_pin</span><span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">,</span> <span class="n">TTM_PL_FLAG_VRAM</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">nouveau_bo_map</span><span class="p">(</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">nouveau_bo_ref</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_crtc</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">.</span><span class="n">nvbo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nv04_cursor_init</span><span class="p">(</span><span class="n">nv_crtc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
