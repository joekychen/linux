<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › nouveau › nv40_grctx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nv40_grctx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2009 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR</span>
<span class="cm"> * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,</span>
<span class="cm"> * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="cm"> * OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Ben Skeggs</span>
<span class="cm"> */</span>

<span class="cm">/* NVIDIA context programs handle a number of other conditions which are</span>
<span class="cm"> * not implemented in our versions.  It&#39;s not clear why NVIDIA context</span>
<span class="cm"> * programs have this code, nor whether it&#39;s strictly necessary for</span>
<span class="cm"> * correct operation.  We&#39;ll implement additional handling if/when we</span>
<span class="cm"> * discover it&#39;s necessary.</span>
<span class="cm"> *</span>
<span class="cm"> * - On context save, NVIDIA set 0x400314 bit 0 to 1 if the &quot;3D state&quot;</span>
<span class="cm"> *   flag is set, this gets saved into the context.</span>
<span class="cm"> * - On context save, the context program for all cards load nsource</span>
<span class="cm"> *   into a flag register and check for ILLEGAL_MTHD.  If it&#39;s set,</span>
<span class="cm"> *   opcode 0x60000d is called before resuming normal operation.</span>
<span class="cm"> * - Some context programs check more conditions than the above.  NV44</span>
<span class="cm"> *   checks: ((nsource &amp; 0x0857) || (0x400718 &amp; 0x0100) || (intr &amp; 0x0001))</span>
<span class="cm"> *   and calls 0x60000d before resuming normal operation.</span>
<span class="cm"> * - At the very beginning of NVIDIA&#39;s context programs, flag 9 is checked</span>
<span class="cm"> *   and if true 0x800001 is called with count=0, pos=0, the flag is cleared</span>
<span class="cm"> *   and then the ctxprog is aborted.  It looks like a complicated NOP,</span>
<span class="cm"> *   its purpose is unknown.</span>
<span class="cm"> * - In the section of code that loads the per-vs state, NVIDIA check</span>
<span class="cm"> *   flag 10.  If it&#39;s set, they only transfer the small 0x300 byte block</span>
<span class="cm"> *   of state + the state for a single vs as opposed to the state for</span>
<span class="cm"> *   all vs units.  It doesn&#39;t seem likely that it&#39;ll occur in normal</span>
<span class="cm"> *   operation, especially seeing as it appears NVIDIA may have screwed</span>
<span class="cm"> *   up the ctxprogs for some cards and have an invalid instruction</span>
<span class="cm"> *   rather than a cp_lsr(ctx, dwords_for_1_vs_unit) instruction.</span>
<span class="cm"> * - There&#39;s a number of places where context offset 0 (where we place</span>
<span class="cm"> *   the PRAMIN offset of the context) is loaded into either 0x408000,</span>
<span class="cm"> *   0x408004 or 0x408008.  Not sure what&#39;s up there either.</span>
<span class="cm"> * - The ctxprogs for some cards save 0x400a00 again during the cleanup</span>
<span class="cm"> *   path for auto-loadctx.</span>
<span class="cm"> */</span>

<span class="cp">#define CP_FLAG_CLEAR                 0</span>
<span class="cp">#define CP_FLAG_SET                   1</span>
<span class="cp">#define CP_FLAG_SWAP_DIRECTION        ((0 * 32) + 0)</span>
<span class="cp">#define CP_FLAG_SWAP_DIRECTION_LOAD   0</span>
<span class="cp">#define CP_FLAG_SWAP_DIRECTION_SAVE   1</span>
<span class="cp">#define CP_FLAG_USER_SAVE             ((0 * 32) + 5)</span>
<span class="cp">#define CP_FLAG_USER_SAVE_NOT_PENDING 0</span>
<span class="cp">#define CP_FLAG_USER_SAVE_PENDING     1</span>
<span class="cp">#define CP_FLAG_USER_LOAD             ((0 * 32) + 6)</span>
<span class="cp">#define CP_FLAG_USER_LOAD_NOT_PENDING 0</span>
<span class="cp">#define CP_FLAG_USER_LOAD_PENDING     1</span>
<span class="cp">#define CP_FLAG_STATUS                ((3 * 32) + 0)</span>
<span class="cp">#define CP_FLAG_STATUS_IDLE           0</span>
<span class="cp">#define CP_FLAG_STATUS_BUSY           1</span>
<span class="cp">#define CP_FLAG_AUTO_SAVE             ((3 * 32) + 4)</span>
<span class="cp">#define CP_FLAG_AUTO_SAVE_NOT_PENDING 0</span>
<span class="cp">#define CP_FLAG_AUTO_SAVE_PENDING     1</span>
<span class="cp">#define CP_FLAG_AUTO_LOAD             ((3 * 32) + 5)</span>
<span class="cp">#define CP_FLAG_AUTO_LOAD_NOT_PENDING 0</span>
<span class="cp">#define CP_FLAG_AUTO_LOAD_PENDING     1</span>
<span class="cp">#define CP_FLAG_UNK54                 ((3 * 32) + 6)</span>
<span class="cp">#define CP_FLAG_UNK54_CLEAR           0</span>
<span class="cp">#define CP_FLAG_UNK54_SET             1</span>
<span class="cp">#define CP_FLAG_ALWAYS                ((3 * 32) + 8)</span>
<span class="cp">#define CP_FLAG_ALWAYS_FALSE          0</span>
<span class="cp">#define CP_FLAG_ALWAYS_TRUE           1</span>
<span class="cp">#define CP_FLAG_UNK57                 ((3 * 32) + 9)</span>
<span class="cp">#define CP_FLAG_UNK57_CLEAR           0</span>
<span class="cp">#define CP_FLAG_UNK57_SET             1</span>

<span class="cp">#define CP_CTX                   0x00100000</span>
<span class="cp">#define CP_CTX_COUNT             0x000fc000</span>
<span class="cp">#define CP_CTX_COUNT_SHIFT               14</span>
<span class="cp">#define CP_CTX_REG               0x00003fff</span>
<span class="cp">#define CP_LOAD_SR               0x00200000</span>
<span class="cp">#define CP_LOAD_SR_VALUE         0x000fffff</span>
<span class="cp">#define CP_BRA                   0x00400000</span>
<span class="cp">#define CP_BRA_IP                0x0000ff00</span>
<span class="cp">#define CP_BRA_IP_SHIFT                   8</span>
<span class="cp">#define CP_BRA_IF_CLEAR          0x00000080</span>
<span class="cp">#define CP_BRA_FLAG              0x0000007f</span>
<span class="cp">#define CP_WAIT                  0x00500000</span>
<span class="cp">#define CP_WAIT_SET              0x00000080</span>
<span class="cp">#define CP_WAIT_FLAG             0x0000007f</span>
<span class="cp">#define CP_SET                   0x00700000</span>
<span class="cp">#define CP_SET_1                 0x00000080</span>
<span class="cp">#define CP_SET_FLAG              0x0000007f</span>
<span class="cp">#define CP_NEXT_TO_SWAP          0x00600007</span>
<span class="cp">#define CP_NEXT_TO_CURRENT       0x00600009</span>
<span class="cp">#define CP_SET_CONTEXT_POINTER   0x0060000a</span>
<span class="cp">#define CP_END                   0x0060000e</span>
<span class="cp">#define CP_LOAD_MAGIC_UNK01      0x00800001 </span><span class="cm">/* unknown */</span><span class="cp"></span>
<span class="cp">#define CP_LOAD_MAGIC_NV44TCL    0x00800029 </span><span class="cm">/* per-vs state (0x4497) */</span><span class="cp"></span>
<span class="cp">#define CP_LOAD_MAGIC_NV40TCL    0x00800041 </span><span class="cm">/* per-vs state (0x4097) */</span><span class="cp"></span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;nouveau_drv.h&quot;</span>
<span class="cp">#include &quot;nouveau_grctx.h&quot;</span>

<span class="cm">/* TODO:</span>
<span class="cm"> *  - get vs count from 0x1540</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">nv40_graph_vs_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x47</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x40</span>:
		<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x41</span>:
	<span class="k">case</span> <span class="mh">0x42</span>:
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x43</span>:
	<span class="k">case</span> <span class="mh">0x44</span>:
	<span class="k">case</span> <span class="mh">0x46</span>:
	<span class="k">case</span> <span class="mh">0x4a</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4c</span>:
	<span class="k">case</span> <span class="mh">0x4e</span>:
	<span class="k">case</span> <span class="mh">0x67</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">enum</span> <span class="n">cp_label</span> <span class="p">{</span>
	<span class="n">cp_check_load</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">cp_setup_auto_load</span><span class="p">,</span>
	<span class="n">cp_setup_load</span><span class="p">,</span>
	<span class="n">cp_setup_save</span><span class="p">,</span>
	<span class="n">cp_swap_state</span><span class="p">,</span>
	<span class="n">cp_swap_state3d_3_is_save</span><span class="p">,</span>
	<span class="n">cp_prepare_exit</span><span class="p">,</span>
	<span class="n">cp_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv40_graph_construct_general</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_grctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4000a4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4000a4</span><span class="p">,</span> <span class="mh">0x00000008</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400144</span><span class="p">,</span> <span class="mi">58</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400144</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400314</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400314</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400400</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400480</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400500</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400514</span><span class="p">,</span> <span class="mh">0x00040000</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400524</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400528</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40052c</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400530</span><span class="p">,</span> <span class="mh">0x55555555</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400560</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400568</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40056c</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40057c</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400710</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400710</span><span class="p">,</span> <span class="mh">0x20010001</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400714</span><span class="p">,</span> <span class="mh">0x0f73ef00</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400724</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400724</span><span class="p">,</span> <span class="mh">0x02008821</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400770</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400814</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400828</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400840</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400850</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400858</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400858</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40085c</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400864</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40086c</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40086c</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400870</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400874</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400878</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400888</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40088c</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4009c0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4009cc</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4009dc</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400840</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv44_graph_class</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400860</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400880</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400884</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400888</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400894</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400894</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv44_graph_class</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4008a0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4008e0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4008f8</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x4c</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x60</span><span class="p">)</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4009f8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400a00</span><span class="p">,</span> <span class="mi">73</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400b0c</span><span class="p">,</span> <span class="mh">0x0b0b0b0c</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401000</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x405004</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x47</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403448</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403448</span><span class="p">,</span> <span class="mh">0x00001010</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403440</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x40</span>:
			<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403440</span><span class="p">,</span> <span class="mh">0x00000010</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x44</span>:
		<span class="k">case</span> <span class="mh">0x46</span>:
		<span class="k">case</span> <span class="mh">0x4a</span>:
			<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403440</span><span class="p">,</span> <span class="mh">0x00003010</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x41</span>:
		<span class="k">case</span> <span class="mh">0x42</span>:
		<span class="k">case</span> <span class="mh">0x43</span>:
		<span class="k">case</span> <span class="mh">0x4c</span>:
		<span class="k">case</span> <span class="mh">0x4e</span>:
		<span class="k">case</span> <span class="mh">0x67</span>:
		<span class="nl">default:</span>
			<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403440</span><span class="p">,</span> <span class="mh">0x00001010</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv40_graph_construct_state3d</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_grctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401880</span><span class="p">,</span> <span class="mi">51</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401940</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x46</span> <span class="o">||</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x47</span> <span class="o">||</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x49</span> <span class="o">||</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x4b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401880</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401880</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00000111</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x46</span><span class="p">)</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401900</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401940</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40194c</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401954</span><span class="p">,</span> <span class="mh">0x00000111</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401958</span><span class="p">,</span> <span class="mh">0x00080060</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401974</span><span class="p">,</span> <span class="mh">0x00000080</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401978</span><span class="p">,</span> <span class="mh">0xffff0000</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40197c</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401990</span><span class="p">,</span> <span class="mh">0x46400000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4019a0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4019ac</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4019a0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4019b4</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4019bc</span><span class="p">,</span> <span class="mh">0xffff0000</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x46</span>:
	<span class="k">case</span> <span class="mh">0x47</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4019c0</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4019c0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x88888888</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a08</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a10</span><span class="p">,</span> <span class="mh">0x0fff0000</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a14</span><span class="p">,</span> <span class="mh">0x0fff0000</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a1c</span><span class="p">,</span> <span class="mh">0x00011100</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a2c</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a44</span><span class="p">,</span> <span class="mi">26</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a44</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x07ff0000</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401a8c</span><span class="p">,</span> <span class="mh">0x4b7fffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ab8</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ab8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ac0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ad0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ad0</span><span class="p">,</span> <span class="mh">0x30201000</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ad4</span><span class="p">,</span> <span class="mh">0x70605040</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ad8</span><span class="p">,</span> <span class="mh">0xb8a89888</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401adc</span><span class="p">,</span> <span class="mh">0xf8e8d8c8</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b10</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b10</span><span class="p">,</span> <span class="mh">0x40100000</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b18</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b28</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span>
			      <span class="mh">0x00000004</span> <span class="o">:</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b30</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b34</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b68</span><span class="p">,</span> <span class="mh">0x435185d6</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b6c</span><span class="p">,</span> <span class="mh">0x2155b699</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b70</span><span class="p">,</span> <span class="mh">0xfedcba98</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b74</span><span class="p">,</span> <span class="mh">0x00000098</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b84</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b88</span><span class="p">,</span> <span class="mh">0x00ff7000</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b8c</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x44</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x4a</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x4e</span><span class="p">)</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b94</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b98</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401b9c</span><span class="p">,</span> <span class="mh">0x00ff0000</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401bc0</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401be0</span><span class="p">,</span> <span class="mh">0x00ffff00</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401c00</span><span class="p">,</span> <span class="mi">192</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* fragment texture units */</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401c40</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00018488</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401c80</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00028202</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401d00</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x0000aae4</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401d40</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x01012000</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401d80</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00080008</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401e00</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00100008</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* vertex texture units */</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401e90</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x0001bc80</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ea0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00000202</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ec0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00000008</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x401ee0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00080008</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400f5c</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400f5c</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x400f84</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv40_graph_construct_state3d_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_grctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402404</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x40</span>:
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402404</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x4c</span>:
	<span class="k">case</span> <span class="mh">0x4e</span>:
	<span class="k">case</span> <span class="mh">0x67</span>:
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402404</span><span class="p">,</span> <span class="mh">0x00000020</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x46</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402404</span><span class="p">,</span> <span class="mh">0x00000421</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402404</span><span class="p">,</span> <span class="mh">0x00000021</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402408</span><span class="p">,</span> <span class="mh">0x030c30c3</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x44</span>:
	<span class="k">case</span> <span class="mh">0x46</span>:
	<span class="k">case</span> <span class="mh">0x4a</span>:
	<span class="k">case</span> <span class="mh">0x4c</span>:
	<span class="k">case</span> <span class="mh">0x4e</span>:
	<span class="k">case</span> <span class="mh">0x67</span>:
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402440</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402440</span><span class="p">,</span> <span class="mh">0x00011001</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402480</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402488</span><span class="p">,</span> <span class="mh">0x3e020200</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40248c</span><span class="p">,</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x40</span>:
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402490</span><span class="p">,</span> <span class="mh">0x60103f00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x47</span>:
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402490</span><span class="p">,</span> <span class="mh">0x40103f00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x41</span>:
	<span class="k">case</span> <span class="mh">0x42</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402490</span><span class="p">,</span> <span class="mh">0x20103f00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402490</span><span class="p">,</span> <span class="mh">0x0c103f00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40249c</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&lt;=</span> <span class="mh">0x43</span> <span class="o">?</span>
			      <span class="mh">0x00020000</span> <span class="o">:</span> <span class="mh">0x00040000</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402500</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402530</span><span class="p">,</span> <span class="mh">0x00008100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x40257c</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402594</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402800</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402800</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x47</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402864</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402864</span><span class="p">,</span> <span class="mh">0x00001001</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402870</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402878</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x47</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* belong at end!! */</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402900</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402940</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402980</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4029c0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402a00</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402a40</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402a80</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402ac0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x40</span>:
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402844</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402844</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402850</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402844</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402844</span><span class="p">,</span> <span class="mh">0x00001001</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402850</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402854</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c00</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c00</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span>
			      <span class="mh">0x80800001</span> <span class="o">:</span> <span class="mh">0x00888001</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x47</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c20</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c40</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4030b8</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4030dc</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x4030e8</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c10</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c20</span><span class="p">,</span> <span class="mi">36</span><span class="p">);</span>
		<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&lt;=</span> <span class="mh">0x42</span><span class="p">)</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c20</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&lt;=</span> <span class="mh">0x4a</span><span class="p">)</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c20</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402c20</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402cb0</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402cd4</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x402ce0</span><span class="p">,</span> <span class="mh">0x0000ffff</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403400</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403410</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403420</span><span class="p">,</span> <span class="n">nv40_graph_vs_count</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nv40_graph_vs_count</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403420</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0x00005555</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403600</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403600</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403800</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403c18</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x403c18</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x46</span>:
	<span class="k">case</span> <span class="mh">0x47</span>:
	<span class="k">case</span> <span class="mh">0x49</span>:
	<span class="k">case</span> <span class="mh">0x4b</span>:
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x405018</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x405018</span><span class="p">,</span> <span class="mh">0x08e00001</span><span class="p">);</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x405c24</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">gr_def</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x405c24</span><span class="p">,</span> <span class="mh">0x000e3000</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">!=</span> <span class="mh">0x4e</span><span class="p">)</span>
		<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x405800</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">cp_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x407000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv40_graph_construct_state3d_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_grctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nv44_graph_class</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0084</span> <span class="o">:</span> <span class="mh">0x0684</span><span class="p">;</span>

	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x300000</span><span class="p">);</span>
	<span class="n">cp_lsr</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SWAP_DIRECTION</span><span class="p">,</span> <span class="n">SAVE</span><span class="p">,</span> <span class="n">cp_swap_state3d_3_is_save</span><span class="p">);</span>
	<span class="n">cp_lsr</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_swap_state3d_3_is_save</span><span class="p">);</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x800001</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxvals_pos</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv40_graph_construct_shader</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_grctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_gpuobj</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vs</span><span class="p">,</span> <span class="n">vs_nr</span><span class="p">,</span> <span class="n">vs_len</span><span class="p">,</span> <span class="n">vs_nr_b0</span><span class="p">,</span> <span class="n">vs_nr_b1</span><span class="p">,</span> <span class="n">b0_offset</span><span class="p">,</span> <span class="n">b1_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vs_nr</span>    <span class="o">=</span> <span class="n">nv40_graph_vs_count</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">vs_nr_b0</span> <span class="o">=</span> <span class="mi">363</span><span class="p">;</span>
	<span class="n">vs_nr_b1</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">128</span> <span class="o">:</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b0_offset</span> <span class="o">=</span> <span class="mh">0x2200</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* 33a0 */</span>
		<span class="n">b1_offset</span> <span class="o">=</span> <span class="mh">0x55a0</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* 1500 */</span>
		<span class="n">vs_len</span> <span class="o">=</span> <span class="mh">0x6aa0</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x41</span> <span class="o">||</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x42</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b0_offset</span> <span class="o">=</span> <span class="mh">0x2200</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* 2200 */</span>
		<span class="n">b1_offset</span> <span class="o">=</span> <span class="mh">0x4400</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* 0b00 */</span>
		<span class="n">vs_len</span> <span class="o">=</span> <span class="mh">0x4f00</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b0_offset</span> <span class="o">=</span> <span class="mh">0x1d40</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* 2200 */</span>
		<span class="n">b1_offset</span> <span class="o">=</span> <span class="mh">0x3f40</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="cm">/* 0b00 : 0a40 */</span>
		<span class="n">vs_len</span> <span class="o">=</span> <span class="n">nv44_graph_class</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x4980</span><span class="o">/</span><span class="mi">4</span> <span class="o">:</span> <span class="mh">0x4a40</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cp_lsr</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">vs_len</span> <span class="o">*</span> <span class="n">vs_nr</span> <span class="o">+</span> <span class="mh">0x300</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">cp_out</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">nv44_graph_class</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x800029</span> <span class="o">:</span> <span class="mh">0x800041</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxvals_pos</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxvals_pos</span> <span class="o">+=</span> <span class="p">(</span><span class="mh">0x0300</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">vs_nr</span> <span class="o">*</span> <span class="n">vs_len</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">NOUVEAU_GRCTX_VALS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x0280</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">nv_wo32</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">offset</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3f800000</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vs</span> <span class="o">&lt;</span> <span class="n">vs_nr</span><span class="p">;</span> <span class="n">vs</span><span class="o">++</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">vs_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vs_nr_b0</span> <span class="o">*</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">nv_wo32</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">b0_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vs_nr_b1</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">nv_wo32</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">b1_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x3f800000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv40_grctx_generate</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_grctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* decide whether we&#39;re loading/unloading the context */</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">AUTO_SAVE</span><span class="p">,</span> <span class="n">PENDING</span><span class="p">,</span> <span class="n">cp_setup_save</span><span class="p">);</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">USER_SAVE</span><span class="p">,</span> <span class="n">PENDING</span><span class="p">,</span> <span class="n">cp_setup_save</span><span class="p">);</span>

	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_check_load</span><span class="p">);</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">AUTO_LOAD</span><span class="p">,</span> <span class="n">PENDING</span><span class="p">,</span> <span class="n">cp_setup_auto_load</span><span class="p">);</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">USER_LOAD</span><span class="p">,</span> <span class="n">PENDING</span><span class="p">,</span> <span class="n">cp_setup_load</span><span class="p">);</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ALWAYS</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">cp_exit</span><span class="p">);</span>

	<span class="cm">/* setup for context load */</span>
	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_setup_auto_load</span><span class="p">);</span>
	<span class="n">cp_wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">);</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">CP_NEXT_TO_SWAP</span><span class="p">);</span>
	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_setup_load</span><span class="p">);</span>
	<span class="n">cp_wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">);</span>
	<span class="n">cp_set</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SWAP_DIRECTION</span><span class="p">,</span> <span class="n">LOAD</span><span class="p">);</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x00910880</span><span class="p">);</span> <span class="cm">/* ?? */</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x00901ffe</span><span class="p">);</span> <span class="cm">/* ?? */</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x01940000</span><span class="p">);</span> <span class="cm">/* ?? */</span>
	<span class="n">cp_lsr</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x0060000b</span><span class="p">);</span> <span class="cm">/* ?? */</span>
	<span class="n">cp_wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">UNK57</span><span class="p">,</span> <span class="n">CLEAR</span><span class="p">);</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x0060000c</span><span class="p">);</span> <span class="cm">/* ?? */</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ALWAYS</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">cp_swap_state</span><span class="p">);</span>

	<span class="cm">/* setup for context save */</span>
	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_setup_save</span><span class="p">);</span>
	<span class="n">cp_set</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SWAP_DIRECTION</span><span class="p">,</span> <span class="n">SAVE</span><span class="p">);</span>

	<span class="cm">/* general PGRAPH state */</span>
	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_swap_state</span><span class="p">);</span>
	<span class="n">cp_pos</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mh">0x00020</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">nv40_graph_construct_general</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">cp_wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">);</span>

	<span class="cm">/* 3D state, block 1 */</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">UNK54</span><span class="p">,</span> <span class="n">CLEAR</span><span class="p">,</span> <span class="n">cp_prepare_exit</span><span class="p">);</span>
	<span class="n">nv40_graph_construct_state3d</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="n">cp_wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">,</span> <span class="n">IDLE</span><span class="p">);</span>

	<span class="cm">/* 3D state, block 2 */</span>
	<span class="n">nv40_graph_construct_state3d_2</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/* Some other block of &quot;random&quot; state */</span>
	<span class="n">nv40_graph_construct_state3d_3</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/* Per-vertex shader state */</span>
	<span class="n">cp_pos</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxvals_pos</span><span class="p">);</span>
	<span class="n">nv40_graph_construct_shader</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/* pre-exit state updates */</span>
	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_prepare_exit</span><span class="p">);</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">SWAP_DIRECTION</span><span class="p">,</span> <span class="n">SAVE</span><span class="p">,</span> <span class="n">cp_check_load</span><span class="p">);</span>
	<span class="n">cp_bra</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">USER_SAVE</span><span class="p">,</span> <span class="n">PENDING</span><span class="p">,</span> <span class="n">cp_exit</span><span class="p">);</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">CP_NEXT_TO_CURRENT</span><span class="p">);</span>

	<span class="n">cp_name</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">cp_exit</span><span class="p">);</span>
	<span class="n">cp_set</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">USER_SAVE</span><span class="p">,</span> <span class="n">NOT_PENDING</span><span class="p">);</span>
	<span class="n">cp_set</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">USER_LOAD</span><span class="p">,</span> <span class="n">NOT_PENDING</span><span class="p">);</span>
	<span class="n">cp_out</span> <span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">CP_END</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nv40_grctx_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nouveau_gpuobj</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">nv40_grctx_generate</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_grctx</span><span class="p">)</span> <span class="p">{</span>
			     <span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">,</span>
			     <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">NOUVEAU_GRCTX_VALS</span><span class="p">,</span>
			     <span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">mem</span><span class="p">,</span>
			   <span class="p">});</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nv40_grctx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctxprog</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_grctx</span> <span class="n">ctx</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">NOUVEAU_GRCTX_PROG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">ctxprog</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ctxprog_max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ctxprog</span><span class="p">)</span>
	<span class="p">};</span>

	<span class="n">nv40_grctx_generate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="p">);</span>

	<span class="n">nv_wr32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV40_PGRAPH_CTXCTL_UCODE_INDEX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="p">.</span><span class="n">ctxprog_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nv_wr32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV40_PGRAPH_CTXCTL_UCODE_DATA</span><span class="p">,</span> <span class="n">ctxprog</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">ctxvals_pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
