<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › nouveau › nouveau_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>nouveau_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2006 Dave Airlie</span>
<span class="cm"> * Copyright 2007 Maarten Maathuis</span>
<span class="cm"> * Copyright 2007-2009 Stuart Bennett</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice shall be included in</span>
<span class="cm"> * all copies or substantial portions of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span>
<span class="cm"> * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;nouveau_drv.h&quot;</span>
<span class="cp">#include &quot;nouveau_hw.h&quot;</span>

<span class="cp">#define CHIPSET_NFORCE 0x01a0</span>
<span class="cp">#define CHIPSET_NFORCE2 0x01f0</span>

<span class="cm">/*</span>
<span class="cm"> * misc hw access wrappers/control functions</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">NVWriteVgaSeq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_SRX</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_SR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint8_t</span>
<span class="nf">NVReadVgaSeq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_SRX</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NVReadPRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_SR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">NVWriteVgaGr</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">index</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_GRX</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_GX</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">uint8_t</span>
<span class="nf">NVReadVgaGr</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_GRX</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NVReadPRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_GX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* CR44 takes values 0 (head A), 3 (head B) and 4 (heads tied)</span>
<span class="cm"> * it affects only the 8 bit vga io regs, which we access using mmio at</span>
<span class="cm"> * 0xc{0,2}3c*, 0x60{1,3}3*, and 0x68{1,3}3d*</span>
<span class="cm"> * in general, the set value of cr44 does not matter: reg access works as</span>
<span class="cm"> * expected and values can be set for the appropriate head by using a 0x2000</span>
<span class="cm"> * offset as required</span>
<span class="cm"> * however:</span>
<span class="cm"> * a) pre nv40, the head B range of PRMVIO regs at 0xc23c* was not exposed and</span>
<span class="cm"> *    cr44 must be set to 0 or 3 for accessing values on the correct head</span>
<span class="cm"> *    through the common 0xc03c* addresses</span>
<span class="cm"> * b) in tied mode (4) head B is programmed to the values set on head A, and</span>
<span class="cm"> *    access using the head B addresses can have strange results, ergo we leave</span>
<span class="cm"> *    tied mode in init once we know to what cr44 should be restored on exit</span>
<span class="cm"> *</span>
<span class="cm"> * the owner parameter is slightly abused:</span>
<span class="cm"> * 0 and 1 are treated as head values and so the set value is (owner * 3)</span>
<span class="cm"> * other values are treated as literal values to set</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">NVSetOwner</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">owner</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">owner</span> <span class="o">*=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This might seem stupid, but the blob does it and</span>
<span class="cm">		 * omitting it often locks the system up.</span>
<span class="cm">		 */</span>
		<span class="n">NVReadVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_SR_LOCK_INDEX</span><span class="p">);</span>
		<span class="n">NVReadVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NV_CIO_SR_LOCK_INDEX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* CR44 is always changed on CRTC0 */</span>
	<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_CRE_44</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* set me harder */</span>
		<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_CRE_2E</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
		<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_CRE_2E</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">NVBlankScreen</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blank</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seq1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVSetOwner</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>

	<span class="n">seq1</span> <span class="o">=</span> <span class="n">NVReadVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_VIO_SR_CLOCK_INDEX</span><span class="p">);</span>

	<span class="n">NVVgaSeqReset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span>
		<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_VIO_SR_CLOCK_INDEX</span><span class="p">,</span> <span class="n">seq1</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_VIO_SR_CLOCK_INDEX</span><span class="p">,</span> <span class="n">seq1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
	<span class="n">NVVgaSeqReset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PLL setting</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">powerctrl_1_shift</span><span class="p">(</span><span class="kt">int</span> <span class="n">chip_version</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_version</span> <span class="o">&lt;</span> <span class="mh">0x17</span> <span class="o">||</span> <span class="n">chip_version</span> <span class="o">==</span> <span class="mh">0x1a</span> <span class="o">||</span> <span class="n">chip_version</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NV_RAMDAC_VPLL2</span>:
		<span class="n">shift</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NV_PRAMDAC_VPLL_COEFF</span>:
		<span class="n">shift</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NV_PRAMDAC_MPLL_COEFF</span>:
		<span class="n">shift</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NV_PRAMDAC_NVPLL_COEFF</span>:
		<span class="n">shift</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * the shift for vpll regs is only used for nv3x chips with a single</span>
<span class="cm">	 * stage pll</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip_version</span> <span class="o">&lt;</span> <span class="mh">0x32</span> <span class="o">||</span> <span class="n">chip_version</span> <span class="o">==</span> <span class="mh">0x35</span> <span class="o">||</span>
			  <span class="n">chip_version</span> <span class="o">==</span> <span class="mh">0x36</span> <span class="o">||</span> <span class="n">chip_version</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setPLL_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_version</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">vbios</span><span class="p">.</span><span class="n">chip_version</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">oldpll</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">oldN</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldpll</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">oldM</span> <span class="o">=</span> <span class="n">oldpll</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pll</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldpll</span> <span class="o">&amp;</span> <span class="mh">0xfff80000</span><span class="p">)</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM1</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">saved_powerctrl_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_powerctrl_1</span> <span class="o">=</span> <span class="n">powerctrl_1_shift</span><span class="p">(</span><span class="n">chip_version</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldpll</span> <span class="o">==</span> <span class="n">pll</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* already set */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift_powerctrl_1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_powerctrl_1</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PBUS_POWERCTRL_1</span><span class="p">);</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PBUS_POWERCTRL_1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">saved_powerctrl_1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">shift_powerctrl_1</span><span class="p">))</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift_powerctrl_1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldM</span> <span class="o">&amp;&amp;</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oldN</span> <span class="o">/</span> <span class="n">oldM</span> <span class="o">&lt;</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N1</span> <span class="o">/</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M1</span><span class="p">))</span>
		<span class="cm">/* upclock -- write new post divider first */</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">oldpll</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="cm">/* downclock -- write new NM first */</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">oldpll</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_version</span> <span class="o">&lt;</span> <span class="mh">0x17</span> <span class="o">&amp;&amp;</span> <span class="n">chip_version</span> <span class="o">!=</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="cm">/* wait a bit on older chips */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* then write the other half as well */</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">pll</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift_powerctrl_1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PBUS_POWERCTRL_1</span><span class="p">,</span> <span class="n">saved_powerctrl_1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">new_ramdac580</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ss</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ramdac580</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">head_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">==</span> <span class="n">NV_PRAMDAC_VPLL_COEFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ss</span><span class="p">)</span>	<span class="cm">/* single stage pll mode */</span>
		<span class="n">ramdac580</span> <span class="o">|=</span> <span class="n">head_a</span> <span class="o">?</span> <span class="n">NV_RAMDAC_580_VPLL1_ACTIVE</span> <span class="o">:</span>
				      <span class="n">NV_RAMDAC_580_VPLL2_ACTIVE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ramdac580</span> <span class="o">&amp;=</span> <span class="n">head_a</span> <span class="o">?</span> <span class="o">~</span><span class="n">NV_RAMDAC_580_VPLL1_ACTIVE</span> <span class="o">:</span>
				      <span class="o">~</span><span class="n">NV_RAMDAC_580_VPLL2_ACTIVE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ramdac580</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setPLL_double_highregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">reg1</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_version</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">vbios</span><span class="p">.</span><span class="n">chip_version</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">nv3035</span> <span class="o">=</span> <span class="n">chip_version</span> <span class="o">==</span> <span class="mh">0x30</span> <span class="o">||</span> <span class="n">chip_version</span> <span class="o">==</span> <span class="mh">0x35</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">reg1</span> <span class="o">+</span> <span class="p">((</span><span class="n">reg1</span> <span class="o">==</span> <span class="n">NV_RAMDAC_VPLL2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x5c</span> <span class="o">:</span> <span class="mh">0x70</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">oldpll1</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">oldpll2</span> <span class="o">=</span> <span class="o">!</span><span class="n">nv3035</span> <span class="o">?</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg2</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pll1</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldpll1</span> <span class="o">&amp;</span> <span class="mh">0xfff80000</span><span class="p">)</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM1</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pll2</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldpll2</span> <span class="o">&amp;</span> <span class="mh">0x7fff0000</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM2</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">oldramdac580</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ramdac580</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">single_stage</span> <span class="o">=</span> <span class="o">!</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM2</span> <span class="o">||</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N2</span> <span class="o">==</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M2</span><span class="p">;</span>	<span class="cm">/* nv41+ only */</span>
	<span class="kt">uint32_t</span> <span class="n">saved_powerctrl_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">savedc040</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_powerctrl_1</span> <span class="o">=</span> <span class="n">powerctrl_1_shift</span><span class="p">(</span><span class="n">chip_version</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>

	<span class="cm">/* model specific additions to generic pll1 and pll2 set up above */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv3035</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll1</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll1</span> <span class="o">&amp;</span> <span class="mh">0xfcc7ffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">N2</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">N2</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="p">(</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">M2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">pll2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_version</span> <span class="o">&gt;</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span> <span class="n">reg1</span> <span class="o">&gt;=</span> <span class="n">NV_PRAMDAC_VPLL_COEFF</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* !nv40 */</span>
		<span class="n">oldramdac580</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_580</span><span class="p">);</span>
		<span class="n">ramdac580</span> <span class="o">=</span> <span class="n">new_ramdac580</span><span class="p">(</span><span class="n">reg1</span><span class="p">,</span> <span class="n">single_stage</span><span class="p">,</span> <span class="n">oldramdac580</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldramdac580</span> <span class="o">!=</span> <span class="n">ramdac580</span><span class="p">)</span>
			<span class="n">oldpll1</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* force mismatch */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">single_stage</span><span class="p">)</span>
			<span class="cm">/* magic value used by nvidia in single stage mode */</span>
			<span class="n">pll2</span> <span class="o">|=</span> <span class="mh">0x011f</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_version</span> <span class="o">&gt;</span> <span class="mh">0x70</span><span class="p">)</span>
		<span class="cm">/* magic bits set by the blob (but not the bios) on g71-73 */</span>
		<span class="n">pll1</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll1</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">single_stage</span> <span class="o">?</span> <span class="mh">0x4</span> <span class="o">:</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldpll1</span> <span class="o">==</span> <span class="n">pll1</span> <span class="o">&amp;&amp;</span> <span class="n">oldpll2</span> <span class="o">==</span> <span class="n">pll2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* already set */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift_powerctrl_1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saved_powerctrl_1</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PBUS_POWERCTRL_1</span><span class="p">);</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PBUS_POWERCTRL_1</span><span class="p">,</span>
			<span class="p">(</span><span class="n">saved_powerctrl_1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">shift_powerctrl_1</span><span class="p">))</span> <span class="o">|</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift_powerctrl_1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip_version</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">shift_c040</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reg1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NV_PRAMDAC_MPLL_COEFF</span>:
			<span class="n">shift_c040</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NV_PRAMDAC_NVPLL_COEFF</span>:
			<span class="n">shift_c040</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NV_RAMDAC_VPLL2</span>:
			<span class="n">shift_c040</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NV_PRAMDAC_VPLL_COEFF</span>:
			<span class="n">shift_c040</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">savedc040</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xc040</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shift_c040</span> <span class="o">!=</span> <span class="mi">14</span><span class="p">)</span>
			<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xc040</span><span class="p">,</span> <span class="n">savedc040</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">shift_c040</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldramdac580</span> <span class="o">!=</span> <span class="n">ramdac580</span><span class="p">)</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_580</span><span class="p">,</span> <span class="n">ramdac580</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv3035</span><span class="p">)</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg2</span><span class="p">,</span> <span class="n">pll2</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">pll1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shift_powerctrl_1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PBUS_POWERCTRL_1</span><span class="p">,</span> <span class="n">saved_powerctrl_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip_version</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xc040</span><span class="p">,</span> <span class="n">savedc040</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">setPLL_double_lowregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">NMNMreg</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* When setting PLLs, there is a merry game of disabling and enabling</span>
<span class="cm">	 * various bits of hardware during the process. This function is a</span>
<span class="cm">	 * synthesis of six nv4x traces, nearly each card doing a subtly</span>
<span class="cm">	 * different thing. With luck all the necessary bits for each card are</span>
<span class="cm">	 * combined herein. Without luck it deviates from each card&#39;s formula</span>
<span class="cm">	 * so as to not work on any :)</span>
<span class="cm">	 */</span>

	<span class="kt">uint32_t</span> <span class="n">Preg</span> <span class="o">=</span> <span class="n">NMNMreg</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mpll</span> <span class="o">=</span> <span class="n">Preg</span> <span class="o">==</span> <span class="mh">0x4020</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">oldPval</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Preg</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">NMNM</span> <span class="o">=</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM1</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">Pval</span> <span class="o">=</span> <span class="p">(</span><span class="n">oldPval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mpll</span> <span class="o">?</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x77</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">:</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)))</span> <span class="o">|</span>
			<span class="mh">0xc</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span> <span class="o">|</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">saved4600</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* some cards have different maskc040s */</span>
	<span class="kt">uint32_t</span> <span class="n">maskc040</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span> <span class="n">savedc040</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">single_stage</span> <span class="o">=</span> <span class="o">!</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">NM2</span> <span class="o">||</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N2</span> <span class="o">==</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NMNMreg</span><span class="p">)</span> <span class="o">==</span> <span class="n">NMNM</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">oldPval</span> <span class="o">&amp;</span> <span class="mh">0xc0070000</span><span class="p">)</span> <span class="o">==</span> <span class="n">Pval</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Preg</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">)</span>
		<span class="n">maskc040</span> <span class="o">=</span> <span class="o">~</span><span class="mh">0x333</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Preg</span> <span class="o">==</span> <span class="mh">0x4058</span><span class="p">)</span>
		<span class="n">maskc040</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xc</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpll</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pll_lims</span> <span class="n">pll_lim</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">Pval2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_pll_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Preg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll_lim</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">Pval2</span> <span class="o">=</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span> <span class="o">+</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">log2p_bias</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Pval2</span> <span class="o">&gt;</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">max_log2p</span><span class="p">)</span>
			<span class="n">Pval2</span> <span class="o">=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">max_log2p</span><span class="p">;</span>
		<span class="n">Pval</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span> <span class="o">|</span> <span class="n">Pval2</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>

		<span class="n">saved4600</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4600</span><span class="p">);</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4600</span><span class="p">,</span> <span class="n">saved4600</span> <span class="o">|</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single_stage</span><span class="p">)</span>
		<span class="n">Pval</span> <span class="o">|=</span> <span class="n">mpll</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Preg</span><span class="p">,</span> <span class="n">oldPval</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Preg</span><span class="p">,</span> <span class="n">Pval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Pval</span> <span class="o">|=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4020</span><span class="p">,</span> <span class="n">Pval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xc</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">));</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4038</span><span class="p">,</span> <span class="n">Pval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xc</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">savedc040</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xc040</span><span class="p">);</span>
	<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xc040</span><span class="p">,</span> <span class="n">savedc040</span> <span class="o">&amp;</span> <span class="n">maskc040</span><span class="p">);</span>

	<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NMNMreg</span><span class="p">,</span> <span class="n">NMNM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NMNMreg</span> <span class="o">==</span> <span class="mh">0x4024</span><span class="p">)</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x403c</span><span class="p">,</span> <span class="n">NMNM</span><span class="p">);</span>

	<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Preg</span><span class="p">,</span> <span class="n">Pval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Pval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4020</span><span class="p">,</span> <span class="n">Pval</span><span class="p">);</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4038</span><span class="p">,</span> <span class="n">Pval</span><span class="p">);</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4600</span><span class="p">,</span> <span class="n">saved4600</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xc040</span><span class="p">,</span> <span class="n">savedc040</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4020</span><span class="p">,</span> <span class="n">Pval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">));</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4038</span><span class="p">,</span> <span class="n">Pval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nouveau_hw_setpll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">reg1</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cv</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">vbios</span><span class="p">.</span><span class="n">chip_version</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cv</span> <span class="o">==</span> <span class="mh">0x30</span> <span class="o">||</span> <span class="n">cv</span> <span class="o">==</span> <span class="mh">0x31</span> <span class="o">||</span> <span class="n">cv</span> <span class="o">==</span> <span class="mh">0x35</span> <span class="o">||</span> <span class="n">cv</span> <span class="o">==</span> <span class="mh">0x36</span> <span class="o">||</span>
	    <span class="n">cv</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">&gt;</span> <span class="mh">0x405c</span><span class="p">)</span>
			<span class="n">setPLL_double_highregs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">setPLL_double_lowregs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">setPLL_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">pv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PLL getting</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nouveau_hw_decode_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">reg1</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pll1</span><span class="p">,</span>
		      <span class="kt">uint32_t</span> <span class="n">pll2</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pllvals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* to force parsing as single stage (i.e. nv40 vplls) pass pll2 as 0 */</span>

	<span class="cm">/* log2P is &amp; 0x7 as never more than 7, and nv30/35 only uses 3 bits */</span>
	<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">log2P</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">N2</span> <span class="o">=</span> <span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">M2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">&lt;=</span> <span class="mh">0x405c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">NM1</span> <span class="o">=</span> <span class="n">pll2</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="cm">/* single stage NVPLL and VPLLs use 1 &lt;&lt; 8, MPLL uses 1 &lt;&lt; 12 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pll1</span> <span class="o">&amp;</span> <span class="mh">0x1100</span><span class="p">))</span>
			<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">NM2</span> <span class="o">=</span> <span class="n">pll2</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">NM1</span> <span class="o">=</span> <span class="n">pll1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_reg_pll</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pll2</span> <span class="o">&amp;</span> <span class="n">NV31_RAMDAC_ENABLE_VCO2</span><span class="p">)</span>
			<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">NM2</span> <span class="o">=</span> <span class="n">pll2</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x30</span> <span class="o">||</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x35</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">M1</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span> <span class="cm">/* only 4 bits */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pll1</span> <span class="o">&amp;</span> <span class="n">NV30_RAMDAC_ENABLE_VCO2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">M2</span> <span class="o">=</span> <span class="p">(</span><span class="n">pll1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">N2</span> <span class="o">=</span> <span class="p">((</span><span class="n">pll1</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">|</span>
					      <span class="p">((</span><span class="n">pll1</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nouveau_hw_get_pllvals</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pll_types</span> <span class="n">plltype</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pllvals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reg1</span> <span class="o">=</span> <span class="n">get_pll_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plltype</span><span class="p">),</span> <span class="n">pll1</span><span class="p">,</span> <span class="n">pll2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pll_lims</span> <span class="n">pll_lim</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">pll1</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">&lt;=</span> <span class="mh">0x405c</span><span class="p">)</span>
		<span class="n">pll2</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nv_two_reg_pll</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">reg1</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">==</span> <span class="n">NV_RAMDAC_VPLL2</span> <span class="o">?</span> <span class="mh">0x5c</span> <span class="o">:</span> <span class="mh">0x70</span><span class="p">);</span>

		<span class="n">pll2</span> <span class="o">=</span> <span class="n">nvReadMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="mh">0x40</span> <span class="o">&amp;&amp;</span> <span class="n">reg1</span> <span class="o">&gt;=</span> <span class="n">NV_PRAMDAC_VPLL_COEFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">ramdac580</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_580</span><span class="p">);</span>

		<span class="cm">/* check whether vpll has been forced into single stage mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">==</span> <span class="n">NV_PRAMDAC_VPLL_COEFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ramdac580</span> <span class="o">&amp;</span> <span class="n">NV_RAMDAC_580_VPLL1_ACTIVE</span><span class="p">)</span>
				<span class="n">pll2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ramdac580</span> <span class="o">&amp;</span> <span class="n">NV_RAMDAC_580_VPLL2_ACTIVE</span><span class="p">)</span>
				<span class="n">pll2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nouveau_hw_decode_pll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg1</span><span class="p">,</span> <span class="n">pll1</span><span class="p">,</span> <span class="n">pll2</span><span class="p">,</span> <span class="n">pllvals</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_pll_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plltype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll_lim</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pllvals</span><span class="o">-&gt;</span><span class="n">refclk</span> <span class="o">=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">refclk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nouveau_hw_pllvals_to_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="o">*</span><span class="n">pv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Avoid divide by zero if called at an inappropriate time */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">M1</span> <span class="o">||</span> <span class="o">!</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">M2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N1</span> <span class="o">*</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">N2</span> <span class="o">*</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">refclk</span> <span class="o">/</span> <span class="p">(</span><span class="n">pv</span><span class="o">-&gt;</span><span class="n">M1</span> <span class="o">*</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">M2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">pv</span><span class="o">-&gt;</span><span class="n">log2P</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">nouveau_hw_get_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pll_types</span> <span class="n">plltype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="n">pllvals</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plltype</span> <span class="o">==</span> <span class="n">PLL_MEMORY</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_device</span> <span class="o">&amp;</span> <span class="mh">0x0ff0</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPSET_NFORCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">mpllP</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpllP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpllP</span><span class="p">)</span>
			<span class="n">mpllP</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">return</span> <span class="mi">400000</span> <span class="o">/</span> <span class="n">mpllP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plltype</span> <span class="o">==</span> <span class="n">PLL_MEMORY</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_device</span> <span class="o">&amp;</span> <span class="mh">0xff0</span><span class="p">)</span> <span class="o">==</span> <span class="n">CHIPSET_NFORCE2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">clock</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">clock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">nouveau_hw_get_pllvals</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plltype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pllvals</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nouveau_hw_pllvals_to_clk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pllvals</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nouveau_hw_fix_bad_vpll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the vpll on an unused head can come up with a random value, way</span>
<span class="cm">	 * beyond the pll limits.  for some reason this causes the chip to</span>
<span class="cm">	 * lock up when reading the dac palette regs, so set a valid pll here</span>
<span class="cm">	 * when such a condition detected.  only seen on nv11 to date</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">pll_lims</span> <span class="n">pll_lim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nouveau_pll_vals</span> <span class="n">pv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pll_types</span> <span class="n">pll</span> <span class="o">=</span> <span class="n">head</span> <span class="o">?</span> <span class="n">PLL_VPLL1</span> <span class="o">:</span> <span class="n">PLL_VPLL0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_pll_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pll_lim</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">nouveau_hw_get_pllvals</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pv</span><span class="p">.</span><span class="n">M1</span> <span class="o">&gt;=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">vco1</span><span class="p">.</span><span class="n">min_m</span> <span class="o">&amp;&amp;</span> <span class="n">pv</span><span class="p">.</span><span class="n">M1</span> <span class="o">&lt;=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">vco1</span><span class="p">.</span><span class="n">max_m</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pv</span><span class="p">.</span><span class="n">N1</span> <span class="o">&gt;=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">vco1</span><span class="p">.</span><span class="n">min_n</span> <span class="o">&amp;&amp;</span> <span class="n">pv</span><span class="p">.</span><span class="n">N1</span> <span class="o">&lt;=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">vco1</span><span class="p">.</span><span class="n">max_n</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pv</span><span class="p">.</span><span class="n">log2P</span> <span class="o">&lt;=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">max_log2p</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">NV_WARN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VPLL %d outwith limits, attempting to fix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* set lowest clock within static limits */</span>
	<span class="n">pv</span><span class="p">.</span><span class="n">M1</span> <span class="o">=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">vco1</span><span class="p">.</span><span class="n">max_m</span><span class="p">;</span>
	<span class="n">pv</span><span class="p">.</span><span class="n">N1</span> <span class="o">=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">vco1</span><span class="p">.</span><span class="n">min_n</span><span class="p">;</span>
	<span class="n">pv</span><span class="p">.</span><span class="n">log2P</span> <span class="o">=</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">max_usable_log2p</span><span class="p">;</span>
	<span class="n">nouveau_hw_setpll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pll_lim</span><span class="p">.</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * vga font save/restore</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nouveau_vga_font_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iovram</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">save</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_SR_PLANE_MASK_INDEX</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plane</span><span class="p">);</span>
	<span class="n">NVWriteVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_READ_MAP_INDEX</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16384</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">save</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">saved_vga_font</span><span class="p">[</span><span class="n">plane</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ioread32_native</span><span class="p">(</span><span class="n">iovram</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">iowrite32_native</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">saved_vga_font</span><span class="p">[</span><span class="n">plane</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
							<span class="n">iovram</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nouveau_hw_save_vga_fonts</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">save</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">misc</span><span class="p">,</span> <span class="n">gr4</span><span class="p">,</span> <span class="n">gr5</span><span class="p">,</span> <span class="n">gr6</span><span class="p">,</span> <span class="n">seq2</span><span class="p">,</span> <span class="n">seq4</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">graphicsmode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">plane</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iovram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVSetOwner</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">graphicsmode</span> <span class="o">=</span> <span class="n">NVReadVgaAttr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_CIO_AR_MODE_INDEX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">graphicsmode</span><span class="p">)</span> <span class="cm">/* graphics mode =&gt; framebuffer =&gt; no need to save */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">NV_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%sing VGA fonts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">?</span> <span class="s">&quot;Sav&quot;</span> <span class="o">:</span> <span class="s">&quot;Restor&quot;</span><span class="p">);</span>

	<span class="cm">/* map first 64KiB of VRAM, holds VGA fonts etc */</span>
	<span class="n">iovram</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">65536</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iovram</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NV_ERROR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to map VRAM, &quot;</span>
					<span class="s">&quot;cannot save/restore VGA fonts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVBlankScreen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">NVBlankScreen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* save control regs */</span>
	<span class="n">misc</span> <span class="o">=</span> <span class="n">NVReadPRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRMVIO_MISC__READ</span><span class="p">);</span>
	<span class="n">seq2</span> <span class="o">=</span> <span class="n">NVReadVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_SR_PLANE_MASK_INDEX</span><span class="p">);</span>
	<span class="n">seq4</span> <span class="o">=</span> <span class="n">NVReadVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_SR_MEM_MODE_INDEX</span><span class="p">);</span>
	<span class="n">gr4</span> <span class="o">=</span> <span class="n">NVReadVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_READ_MAP_INDEX</span><span class="p">);</span>
	<span class="n">gr5</span> <span class="o">=</span> <span class="n">NVReadVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_MODE_INDEX</span><span class="p">);</span>
	<span class="n">gr6</span> <span class="o">=</span> <span class="n">NVReadVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_MISC_INDEX</span><span class="p">);</span>

	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRMVIO_MISC__WRITE</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>
	<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_SR_MEM_MODE_INDEX</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
	<span class="n">NVWriteVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_MODE_INDEX</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">NVWriteVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_MISC_INDEX</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>

	<span class="cm">/* store font in planes 0..3 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">plane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">plane</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">plane</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nouveau_vga_font_io</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">iovram</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>

	<span class="cm">/* restore control regs */</span>
	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRMVIO_MISC__WRITE</span><span class="p">,</span> <span class="n">misc</span><span class="p">);</span>
	<span class="n">NVWriteVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_READ_MAP_INDEX</span><span class="p">,</span> <span class="n">gr4</span><span class="p">);</span>
	<span class="n">NVWriteVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_MODE_INDEX</span><span class="p">,</span> <span class="n">gr5</span><span class="p">);</span>
	<span class="n">NVWriteVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_GX_MISC_INDEX</span><span class="p">,</span> <span class="n">gr6</span><span class="p">);</span>
	<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_SR_PLANE_MASK_INDEX</span><span class="p">,</span> <span class="n">seq2</span><span class="p">);</span>
	<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_VIO_SR_MEM_MODE_INDEX</span><span class="p">,</span> <span class="n">seq4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVBlankScreen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">NVBlankScreen</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">iovram</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mode state save/load</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rd_cio_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">crtcstate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crtcstate</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">wr_cio_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">crtcstate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NVWriteVgaCrtc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">crtcstate</span><span class="o">-&gt;</span><span class="n">CRTC</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_save_state_ramdac</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">nv10_cursync</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_RAMDAC_NV10_CURSYNC</span><span class="p">);</span>

	<span class="n">nouveau_hw_get_pllvals</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span> <span class="o">?</span> <span class="n">PLL_VPLL1</span> <span class="o">:</span> <span class="n">PLL_VPLL0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regp</span><span class="o">-&gt;</span><span class="n">pllvals</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_PLL_COEFF_SELECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">sel_clk</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_SEL_CLK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_RAMDAC_DITHER_NV11</span><span class="p">);</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_GENERAL_CONTROL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_630</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_630</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_634</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_634</span><span class="p">);</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_setup</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_SETUP</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_vtotal</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_VTOTAL</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_vskew</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_VSKEW</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_vsync_delay</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_VSYNC_DELAY</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_htotal</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HTOTAL</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_hskew</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HSKEW</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_hsync_delay</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HSYNC_DELAY</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_hsync_delay2</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HSYNC_DELAY2</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">ramdac_reg</span> <span class="o">=</span> <span class="n">NV_PRAMDAC_FP_VDISPLAY_END</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_vert_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">ramdac_reg</span><span class="p">);</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_horiz_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">ramdac_reg</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_RAMDAC_FP_DITHER</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_850</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither_regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_85C</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_control</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_TG_CONTROL</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_debug_0</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_DEBUG_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">head</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* early chips don&#39;t allow access to PRAMDAC_TMDS_* without</span>
<span class="cm">		 * the head A FPCLK on (nv11 even locks up) */</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_DEBUG_0</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_debug_0</span> <span class="o">&amp;</span>
			      <span class="o">~</span><span class="n">NV_PRAMDAC_FP_DEBUG_0_PWRDOWN_FPCLK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_debug_1</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_DEBUG_1</span><span class="p">);</span>
	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_debug_2</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_DEBUG_2</span><span class="p">);</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_margin_color</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_MARGIN_COLOR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_8c0</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_8C0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a20</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_A20</span><span class="p">);</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a24</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_A24</span><span class="p">);</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a34</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_A34</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">38</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">ctv_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span>
							 <span class="n">NV_PRAMDAC_CTV</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_load_state_ramdac</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">pllreg</span> <span class="o">=</span> <span class="n">head</span> <span class="o">?</span> <span class="n">NV_RAMDAC_VPLL2</span> <span class="o">:</span> <span class="n">NV_PRAMDAC_VPLL_COEFF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_RAMDAC_NV10_CURSYNC</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">nv10_cursync</span><span class="p">);</span>

	<span class="n">nouveau_hw_setpll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pllreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regp</span><span class="o">-&gt;</span><span class="n">pllvals</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_PLL_COEFF_SELECT</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pllsel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_PRAMDAC_SEL_CLK</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">sel_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_RAMDAC_DITHER_NV11</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither</span><span class="p">);</span>

	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_GENERAL_CONTROL</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_gen_ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_630</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_630</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_634</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_634</span><span class="p">);</span>

	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_SETUP</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_setup</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_VTOTAL</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_vtotal</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_VSKEW</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_vskew</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_VSYNC_DELAY</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_vsync_delay</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HTOTAL</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_htotal</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HSKEW</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_hskew</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HSYNC_DELAY</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_hsync_delay</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_TV_HSYNC_DELAY2</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">tv_hsync_delay2</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">ramdac_reg</span> <span class="o">=</span> <span class="n">NV_PRAMDAC_FP_VDISPLAY_END</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">ramdac_reg</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_vert_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">ramdac_reg</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_horiz_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_RAMDAC_FP_DITHER</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_850</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_85C</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">dither_regs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_TG_CONTROL</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_control</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_DEBUG_0</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_debug_0</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_DEBUG_1</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_debug_1</span><span class="p">);</span>
	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_DEBUG_2</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_debug_2</span><span class="p">);</span>

	<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_FP_MARGIN_COLOR</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fp_margin_color</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_8C0</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_8c0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_A20</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a20</span><span class="p">);</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_A24</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a24</span><span class="p">);</span>
		<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_A34</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ramdac_a34</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">38</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span>
				      <span class="n">NV_PRAMDAC_CTV</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">ctv_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_save_state_vga</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span> <span class="o">=</span> <span class="n">NVReadPRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_MISC__READ</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadVgaAttr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_load_state_vga</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">NVWritePRMVIO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRMVIO_MISC__WRITE</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">MiscOutReg</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">NVWriteVgaSeq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">Sequencer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">nv_lock_vga_crtc_base</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">nv_lock_vga_crtc_base</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">NVWriteVgaGr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">Graphics</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">NVWriteVgaAttr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">Attribute</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_save_state_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LCD__INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC0_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC1_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LSR_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_PIXEL_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HEB__INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_ENH_INDEX</span><span class="p">);</span>

	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_FF_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_FFLWM__INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_21</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_20</span><span class="p">)</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_47</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_30</span><span class="p">)</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">);</span>

	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_49</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HCUR_ADDR0_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HCUR_ADDR1_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HCUR_ADDR2_INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_ILACE__INDEX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_830</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_830</span><span class="p">);</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_834</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_834</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_30</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">gpio_ext</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_GPIO_EXT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_850</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_850</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_eng_ctrl</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_ENGINE_CTRL</span><span class="p">);</span>
		<span class="n">regp</span><span class="o">-&gt;</span><span class="n">cursor_cfg</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_CURSOR_CONFIG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_cfg</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_CONFIG</span><span class="p">);</span>

	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_SCRATCH3__INDEX</span><span class="p">);</span>
	<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_SCRATCH4__INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_EBR_INDEX</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_CSB</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_4B</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_TVOUT_LATENCY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* NV11 and NV20 don&#39;t have this, they stop at 0x52. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_42</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_53</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_54</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">regp</span><span class="o">-&gt;</span><span class="n">CR58</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NVReadVgaCrtc5758</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_59</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_5B</span><span class="p">);</span>

		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_85</span><span class="p">);</span>
		<span class="n">rd_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_86</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">regp</span><span class="o">-&gt;</span><span class="n">fb_start</span> <span class="o">=</span> <span class="n">NVReadCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_load_state_ext</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv04_crtc_reg</span> <span class="o">*</span><span class="n">regp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">reg900</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_two_heads</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="cm">/* setting ENGINE_CTRL (EC) *must* come before</span>
<span class="cm">			 * CIO_CRE_LCD, as writing CRE_LCD sets bits 16 &amp; 17 in</span>
<span class="cm">			 * EC that should not be overwritten by writing stale EC</span>
<span class="cm">			 */</span>
			<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_ENGINE_CTRL</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_eng_ctrl</span><span class="p">);</span>

		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_STOP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_INTR_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_OFFSET_BUFF</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_OFFSET_BUFF</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_available_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_LIMIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_available_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_UVPLANE_LIMIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_available_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nvWriteVIDEO</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PVIDEO_UVPLANE_LIMIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fb_available_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">nvWriteMC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PBUS_POWERCTRL_2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_CURSOR_CONFIG</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">cursor_cfg</span><span class="p">);</span>
		<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_830</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_830</span><span class="p">);</span>
		<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_834</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_834</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_30</span><span class="p">)</span>
			<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_GPIO_EXT</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">gpio_ext</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_850</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_850</span><span class="p">);</span>

			<span class="n">reg900</span> <span class="o">=</span> <span class="n">NVReadRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_900</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_cfg</span> <span class="o">==</span> <span class="n">NV10_PCRTC_CONFIG_START_ADDRESS_HSYNC</span><span class="p">)</span>
				<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_900</span><span class="p">,</span> <span class="n">reg900</span> <span class="o">|</span> <span class="mh">0x10000</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">NVWriteRAMDAC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PRAMDAC_900</span><span class="p">,</span> <span class="n">reg900</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x10000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_CONFIG</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">crtc_cfg</span><span class="p">);</span>

	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC0_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_RPC1_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LSR_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_PIXEL_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_LCD__INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HEB__INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_ENH_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_FF_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_FFLWM__INDEX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_20</span><span class="p">)</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_47</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_30</span><span class="p">)</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">);</span>

	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_49</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HCUR_ADDR0_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HCUR_ADDR1_INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_HCUR_ADDR2_INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_40</span><span class="p">)</span>
		<span class="n">nv_fix_nv40_hw_cursor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_ILACE__INDEX</span><span class="p">);</span>

	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_SCRATCH3__INDEX</span><span class="p">);</span>
	<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_SCRATCH4__INDEX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">&gt;=</span> <span class="n">NV_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_EBR_INDEX</span><span class="p">);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_CSB</span><span class="p">);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_4B</span><span class="p">);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_TVOUT_LATENCY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* NV11 and NV20 stop at 0x52. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nv_gf4_disp_arch</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">NV_10</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Not waiting for vertical retrace before modifying</span>
<span class="cm">			   CRE_53/CRE_54 causes lockups. */</span>
			<span class="n">nouveau_wait_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">650000000</span><span class="p">,</span> <span class="n">NV_PRMCIO_INP0__COLOR</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
			<span class="n">nouveau_wait_eq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">650000000</span><span class="p">,</span> <span class="n">NV_PRMCIO_INP0__COLOR</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_42</span><span class="p">);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_53</span><span class="p">);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_54</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">NVWriteVgaCrtc5758</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">CR58</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_59</span><span class="p">);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_5B</span><span class="p">);</span>

		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_85</span><span class="p">);</span>
		<span class="n">wr_cio_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">regp</span><span class="p">,</span> <span class="n">NV_CIO_CRE_86</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">NVWriteCRTC</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">NV_PCRTC_START</span><span class="p">,</span> <span class="n">regp</span><span class="o">-&gt;</span><span class="n">fb_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">nv_save_state_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">head_offset</span> <span class="o">=</span> <span class="n">head</span> <span class="o">*</span> <span class="n">NV_PRMDIO_SIZE</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nv_wr08</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PRMDIO_PIXEL_MASK</span> <span class="o">+</span> <span class="n">head_offset</span><span class="p">,</span>
				<span class="n">NV_PRMDIO_PIXEL_MASK_MASK</span><span class="p">);</span>
	<span class="n">nv_wr08</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PRMDIO_READ_MODE_ADDRESS</span> <span class="o">+</span> <span class="n">head_offset</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">768</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">DAC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nv_rd08</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">NV_PRMDIO_PALETTE_DATA</span> <span class="o">+</span> <span class="n">head_offset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">nouveau_hw_load_state_palette</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">head_offset</span> <span class="o">=</span> <span class="n">head</span> <span class="o">*</span> <span class="n">NV_PRMDIO_SIZE</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">nv_wr08</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PRMDIO_PIXEL_MASK</span> <span class="o">+</span> <span class="n">head_offset</span><span class="p">,</span>
				<span class="n">NV_PRMDIO_PIXEL_MASK_MASK</span><span class="p">);</span>
	<span class="n">nv_wr08</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PRMDIO_WRITE_MODE_ADDRESS</span> <span class="o">+</span> <span class="n">head_offset</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">768</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_wr08</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_PRMDIO_PALETTE_DATA</span> <span class="o">+</span> <span class="n">head_offset</span><span class="p">,</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">crtc_reg</span><span class="p">[</span><span class="n">head</span><span class="p">].</span><span class="n">DAC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">NVSetEnablePalette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nouveau_hw_save_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_nouveau_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="cm">/* NB: no attempt is made to restore the bad pll later on */</span>
		<span class="n">nouveau_hw_fix_bad_vpll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
	<span class="n">nv_save_state_ramdac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nv_save_state_vga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nv_save_state_palette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nv_save_state_ext</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">nouveau_hw_load_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">head</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">nv04_mode_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NVVgaProtect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">nv_load_state_ramdac</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nv_load_state_ext</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nouveau_hw_load_state_palette</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">nv_load_state_vga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">NVVgaProtect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
