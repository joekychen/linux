<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › gem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>gem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  psb GEM interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2011, Intel Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Alan Cox</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *	-	we need to work out if the MMU is relevant (eg for</span>
<span class="cm"> *		accelerated operations on a GEM object)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;drm/drmP.h&gt;</span>
<span class="cp">#include &lt;drm/drm.h&gt;</span>
<span class="cp">#include &quot;gma_drm.h&quot;</span>
<span class="cp">#include &quot;psb_drv.h&quot;</span>

<span class="kt">int</span> <span class="nf">psb_gem_init_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_gem_free_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">gtt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>
	<span class="n">drm_gem_object_release_wrap</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="cm">/* This must occur last as it frees up the memory of the GEM object */</span>
	<span class="n">psb_gtt_free_range</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">gtt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">psb_gem_get_aperture</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	psb_gem_dumb_map_gtt	-	buffer mapping for dumb interface</span>
<span class="cm"> *	@file: our drm client file</span>
<span class="cm"> *	@dev: drm device</span>
<span class="cm"> *	@handle: GEM handle to the object (from dumb_create)</span>
<span class="cm"> *</span>
<span class="cm"> *	Do the necessary setup to allow the mapping of the frame buffer</span>
<span class="cm"> *	into user memory. We don&#39;t have to do much here at the moment.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">psb_gem_dumb_map_gtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">driver_features</span> <span class="o">&amp;</span> <span class="n">DRIVER_GEM</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* GEM does all our handle to object mapping */</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* What validation is needed here ? */</span>

	<span class="cm">/* Make it mmapable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_list</span><span class="p">.</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gem_create_mmap_offset</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* GEM should really work out the hash offsets for us */</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_list</span><span class="p">.</span><span class="n">hash</span><span class="p">.</span><span class="n">key</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	psb_gem_create		-	create a mappable object</span>
<span class="cm"> *	@file: the DRM file of the client</span>
<span class="cm"> *	@dev: our device</span>
<span class="cm"> *	@size: the size requested</span>
<span class="cm"> *	@handlep: returned handle (opaque number)</span>
<span class="cm"> *</span>
<span class="cm"> *	Create a GEM object, fill in the boilerplate and attach a handle to</span>
<span class="cm"> *	it so that userspace can speak about it. This does the core work</span>
<span class="cm"> *	for the various methods that do/will create GEM objects for things</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_gem_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">handlep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="cm">/* Allocate our object - for now a direct gtt range which is not</span>
<span class="cm">	   stolen memory backed */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">psb_gtt_alloc_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;gem&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no memory for %lld byte GEM object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize the extra goodies GEM needs to do all the hard work */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_gem_object_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psb_gtt_free_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="cm">/* GEM doesn&#39;t give an error code so use -ENOMEM */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GEM init failed for %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Limit the object to 32bit mappings */</span>
	<span class="n">mapping_set_gfp_mask</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_mapping</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_DMA32</span><span class="p">);</span>
	<span class="cm">/* Give the object a handle so we can carry it more easily */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_gem_handle_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GEM handle failed for %p, %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">drm_gem_object_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">);</span>
		<span class="n">psb_gtt_free_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We have the initial and handle reference but need only one now */</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">);</span>
	<span class="o">*</span><span class="n">handlep</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	psb_gem_dumb_create	-	create a dumb buffer</span>
<span class="cm"> *	@drm_file: our client file</span>
<span class="cm"> *	@dev: our device</span>
<span class="cm"> *	@args: the requested arguments copied from userspace</span>
<span class="cm"> *</span>
<span class="cm"> *	Allocate a buffer suitable for use for a frame buffer of the</span>
<span class="cm"> *	form described by user space. Give userspace a handle by which</span>
<span class="cm"> *	to reference it.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">psb_gem_dumb_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_mode_create_dumb</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="p">((</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">psb_gem_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	psb_gem_dumb_destroy	-	destroy a dumb buffer</span>
<span class="cm"> *	@file: client file</span>
<span class="cm"> *	@dev: our DRM device</span>
<span class="cm"> *	@handle: the object handle</span>
<span class="cm"> *</span>
<span class="cm"> *	Destroy a handle that was created via psb_gem_dumb_create, at least</span>
<span class="cm"> *	we hope it was created that way. i915 seems to assume the caller</span>
<span class="cm"> *	does the checking but that might be worth review ! FIXME</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">psb_gem_dumb_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No special work needed, drop the reference and see what falls out */</span>
	<span class="k">return</span> <span class="n">drm_gem_handle_delete</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	psb_gem_fault		-	pagefault handler for GEM objects</span>
<span class="cm"> *	@vma: the VMA of the GEM object</span>
<span class="cm"> *	@vmf: fault detail</span>
<span class="cm"> *</span>
<span class="cm"> *	Invoked when a fault occurs on an mmap of a GEM managed area. GEM</span>
<span class="cm"> *	does most of the work for us including the actual map/unmap calls</span>
<span class="cm"> *	but we need to do the actual page work.</span>
<span class="cm"> *</span>
<span class="cm"> *	This code eventually needs to handle faulting objects in and out</span>
<span class="cm"> *	of the GTT and repacking it when we run out of space. We can put</span>
<span class="cm"> *	that off for now and for our simple uses</span>
<span class="cm"> *</span>
<span class="cm"> *	The VMA was set up by GEM. In doing so it also ensured that the</span>
<span class="cm"> *	vma-&gt;vm_private_data points to the GEM object that is backing this</span>
<span class="cm"> *	mapping.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">psb_gem_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_fault</span> <span class="o">*</span><span class="n">vmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">page_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>	<span class="cm">/* GEM object */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>	<span class="cm">/* Get the gtt range */</span>

	<span class="cm">/* Make sure we don&#39;t parallel update on a fault, nor move or remove</span>
<span class="cm">	   something from beneath our feet */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* For now the mmap pins the object and it stays pinned. As things</span>
<span class="cm">	   stand that will do us no harm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mmapping</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">psb_gtt_pin</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;gma500: pin failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">mmapping</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Page relative to the VMA start - we must calculate this ourselves</span>
<span class="cm">	   because vmf-&gt;pgoff is the fake GEM offset */</span>
	<span class="n">page_offset</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">vmf</span><span class="o">-&gt;</span><span class="n">virtual_address</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="cm">/* CPU view of the page, don&#39;t go via the GART for CPU writes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">stolen</span><span class="p">)</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stolen_base</span> <span class="o">+</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pfn</span> <span class="o">=</span> <span class="n">page_to_pfn</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page_offset</span><span class="p">]);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vm_insert_pfn</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vmf</span><span class="o">-&gt;</span><span class="n">virtual_address</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ERESTARTSYS</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">EINTR</span>:
		<span class="k">return</span> <span class="n">VM_FAULT_NOPAGE</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="k">return</span> <span class="n">VM_FAULT_OOM</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">VM_FAULT_SIGBUS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_gem_create_stolen</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">gtt</span> <span class="o">=</span> <span class="n">psb_gtt_alloc_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;gem&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gtt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_gem_private_object_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_gtt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_gem_handle_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">gem</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">free_gtt:</span>
	<span class="n">psb_gtt_free_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gtt</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	GEM interfaces for our specific client</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">psb_gem_create_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_gem_create</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">GMA_GEM_CREATE_STOLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">psb_gem_create_stolen</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Fall throguh */</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GMA_GEM_CREATE_STOLEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">psb_gem_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">psb_gem_mmap_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_gem_mmap</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dumb_map_offset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
						<span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
