<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › psb_intel_display.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>psb_intel_display.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright Â© 2006-2011 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;drm/drmP.h&gt;</span>
<span class="cp">#include &quot;framebuffer.h&quot;</span>
<span class="cp">#include &quot;psb_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_reg.h&quot;</span>
<span class="cp">#include &quot;psb_intel_display.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>

<span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="p">{</span>
	<span class="cm">/* given values */</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
	<span class="cm">/* derived values */</span>
	<span class="kt">int</span> <span class="n">dot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vco</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">psb_intel_range_t</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">psb_intel_p2_t</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">dot_limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p2_slow</span><span class="p">,</span> <span class="n">p2_fast</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define INTEL_P2_NUM		      2</span>

<span class="k">struct</span> <span class="n">psb_intel_limit_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_range_t</span> <span class="n">dot</span><span class="p">,</span> <span class="n">vco</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_p2_t</span> <span class="n">p2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define I8XX_DOT_MIN		  25000</span>
<span class="cp">#define I8XX_DOT_MAX		 350000</span>
<span class="cp">#define I8XX_VCO_MIN		 930000</span>
<span class="cp">#define I8XX_VCO_MAX		1400000</span>
<span class="cp">#define I8XX_N_MIN		      3</span>
<span class="cp">#define I8XX_N_MAX		     16</span>
<span class="cp">#define I8XX_M_MIN		     96</span>
<span class="cp">#define I8XX_M_MAX		    140</span>
<span class="cp">#define I8XX_M1_MIN		     18</span>
<span class="cp">#define I8XX_M1_MAX		     26</span>
<span class="cp">#define I8XX_M2_MIN		      6</span>
<span class="cp">#define I8XX_M2_MAX		     16</span>
<span class="cp">#define I8XX_P_MIN		      4</span>
<span class="cp">#define I8XX_P_MAX		    128</span>
<span class="cp">#define I8XX_P1_MIN		      2</span>
<span class="cp">#define I8XX_P1_MAX		     33</span>
<span class="cp">#define I8XX_P1_LVDS_MIN	      1</span>
<span class="cp">#define I8XX_P1_LVDS_MAX	      6</span>
<span class="cp">#define I8XX_P2_SLOW		      4</span>
<span class="cp">#define I8XX_P2_FAST		      2</span>
<span class="cp">#define I8XX_P2_LVDS_SLOW	      14</span>
<span class="cp">#define I8XX_P2_LVDS_FAST	      14	</span><span class="cm">/* No fast option */</span><span class="cp"></span>
<span class="cp">#define I8XX_P2_SLOW_LIMIT	 165000</span>

<span class="cp">#define I9XX_DOT_MIN		  20000</span>
<span class="cp">#define I9XX_DOT_MAX		 400000</span>
<span class="cp">#define I9XX_VCO_MIN		1400000</span>
<span class="cp">#define I9XX_VCO_MAX		2800000</span>
<span class="cp">#define I9XX_N_MIN		      3</span>
<span class="cp">#define I9XX_N_MAX		      8</span>
<span class="cp">#define I9XX_M_MIN		     70</span>
<span class="cp">#define I9XX_M_MAX		    120</span>
<span class="cp">#define I9XX_M1_MIN		     10</span>
<span class="cp">#define I9XX_M1_MAX		     20</span>
<span class="cp">#define I9XX_M2_MIN		      5</span>
<span class="cp">#define I9XX_M2_MAX		      9</span>
<span class="cp">#define I9XX_P_SDVO_DAC_MIN	      5</span>
<span class="cp">#define I9XX_P_SDVO_DAC_MAX	     80</span>
<span class="cp">#define I9XX_P_LVDS_MIN		      7</span>
<span class="cp">#define I9XX_P_LVDS_MAX		     98</span>
<span class="cp">#define I9XX_P1_MIN		      1</span>
<span class="cp">#define I9XX_P1_MAX		      8</span>
<span class="cp">#define I9XX_P2_SDVO_DAC_SLOW		     10</span>
<span class="cp">#define I9XX_P2_SDVO_DAC_FAST		      5</span>
<span class="cp">#define I9XX_P2_SDVO_DAC_SLOW_LIMIT	 200000</span>
<span class="cp">#define I9XX_P2_LVDS_SLOW		     14</span>
<span class="cp">#define I9XX_P2_LVDS_FAST		      7</span>
<span class="cp">#define I9XX_P2_LVDS_SLOW_LIMIT		 112000</span>

<span class="cp">#define INTEL_LIMIT_I8XX_DVO_DAC    0</span>
<span class="cp">#define INTEL_LIMIT_I8XX_LVDS	    1</span>
<span class="cp">#define INTEL_LIMIT_I9XX_SDVO_DAC   2</span>
<span class="cp">#define INTEL_LIMIT_I9XX_LVDS	    3</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">psb_intel_limit_t</span> <span class="n">psb_intel_limits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/* INTEL_LIMIT_I8XX_DVO_DAC */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_VCO_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_VCO_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_N_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_N_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_M_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_M_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_M1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_M1_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_M2_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_M2_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_P_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_P_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_P1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_P1_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="n">I8XX_P2_SLOW_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="n">I8XX_P2_SLOW</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="n">I8XX_P2_FAST</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* INTEL_LIMIT_I8XX_LVDS */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_VCO_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_VCO_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_N_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_N_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_M_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_M_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_M1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_M1_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_M2_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_M2_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_P_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_P_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I8XX_P1_LVDS_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I8XX_P1_LVDS_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="n">I8XX_P2_SLOW_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="n">I8XX_P2_LVDS_SLOW</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="n">I8XX_P2_LVDS_FAST</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* INTEL_LIMIT_I9XX_SDVO_DAC */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_VCO_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_VCO_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_N_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_N_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_M_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_M_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_M1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_M1_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_M2_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_M2_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_P_SDVO_DAC_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_P_SDVO_DAC_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_P1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_P1_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="n">I9XX_P2_SDVO_DAC_SLOW_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="n">I9XX_P2_SDVO_DAC_SLOW</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span>
		<span class="n">I9XX_P2_SDVO_DAC_FAST</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* INTEL_LIMIT_I9XX_LVDS */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_VCO_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_VCO_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_N_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_N_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_M_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_M_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_M1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_M1_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_M2_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_M2_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_P_LVDS_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_P_LVDS_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">I9XX_P1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">I9XX_P1_MAX</span><span class="p">},</span>
	 <span class="cm">/* The single-channel range is 25-112Mhz, and dual-channel</span>
<span class="cm">	  * is 80-224Mhz.  Prefer single channel as much as possible.</span>
<span class="cm">	  */</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="n">I9XX_P2_LVDS_SLOW_LIMIT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="n">I9XX_P2_LVDS_SLOW</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="n">I9XX_P2_LVDS_FAST</span><span class="p">},</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">psb_intel_limit_t</span> <span class="o">*</span><span class="nf">psb_intel_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psb_intel_limits</span><span class="p">[</span><span class="n">INTEL_LIMIT_I9XX_LVDS</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psb_intel_limits</span><span class="p">[</span><span class="n">INTEL_LIMIT_I9XX_SDVO_DAC</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Derive the pixel clock for the given refclk and divisors for 8xx chips. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">=</span> <span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Derive the pixel clock for the given refclk and divisors for 9xx chips. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">=</span> <span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i9xx_clock</span><span class="p">(</span><span class="n">refclk</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Returns whether any output on the specified pipe is of the specified type</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">psb_intel_pipe_has_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">l_entry</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">l_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_entry</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">&amp;&amp;</span> <span class="n">l_entry</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
					<span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">l_entry</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define INTELPllInvalid(s)   { </span><span class="cm">/* ErrorF (s) */</span><span class="cp">; return false; }</span>
<span class="cm">/**</span>
<span class="cm"> * Returns whether the given set of divisors are valid for a given refclk with</span>
<span class="cm"> * the given connectors.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">psb_intel_PLL_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_intel_limit_t</span> <span class="o">*</span><span class="n">limit</span> <span class="o">=</span> <span class="n">psb_intel_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;p1 out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;p out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m2 out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m1 out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m1 &lt;= m2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;n out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;vco out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* XXX: We may need to be checking &quot;Dot clock&quot;</span>
<span class="cm">	 * depending on the multiplier, connector, etc.,</span>
<span class="cm">	 * rather than just a single range.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;dot out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Returns a set of divisors for the desired target clock with the given</span>
<span class="cm"> * refclk, or FALSE.  The returned values represent the clock equation:</span>
<span class="cm"> * reflck * (5 * (m1 + 2) + (m2 + 2)) / (n + 2) / p1 / p2.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">psb_intel_find_best_PLL</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_intel_limit_t</span> <span class="o">*</span><span class="n">limit</span> <span class="o">=</span> <span class="n">psb_intel_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For LVDS, if the panel is on, just rely on its current</span>
<span class="cm">		 * settings for dual-channel.  We haven&#39;t figured out how to</span>
<span class="cm">		 * reliably set up different single/dual channel state, if we</span>
<span class="cm">		 * even can.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_CLKB_POWER_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">dot_limit</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">best_clock</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
	     <span class="n">clock</span><span class="p">.</span><span class="n">m1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
		     <span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&amp;&amp;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
		     <span class="n">clock</span><span class="p">.</span><span class="n">m2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			     <span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">max</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
				     <span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
				     <span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">this_err</span><span class="p">;</span>

					<span class="n">psb_intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psb_intel_PLL_is_valid</span>
					    <span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="n">this_err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">dot</span> <span class="o">-</span> <span class="n">target</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">this_err</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">best_clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
						<span class="n">err</span> <span class="o">=</span> <span class="n">this_err</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Wait for 20ms, i.e. one cycle at 50hz. */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_intel_pipe_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_framebuffer</span> <span class="o">*</span><span class="n">psbfb</span> <span class="o">=</span> <span class="n">to_psb_fb</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* no fb bound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No FB bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">psb_intel_pipe_cleaner</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We are displaying this buffer, make sure it is actually loaded</span>
<span class="cm">	   into the GTT */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">psb_gtt_pin</span><span class="p">(</span><span class="n">psbfb</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">psb_intel_pipe_set_base_exit</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">psbfb</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PIXFORMAT_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_8BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_15_16BPP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown color depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">psbfb</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">psb_intel_pipe_set_base_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

<span class="nl">psb_intel_pipe_cleaner:</span>
	<span class="cm">/* If there was a previous display we can now unpin it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_fb</span><span class="p">)</span>
		<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">to_psb_fb</span><span class="p">(</span><span class="n">old_fb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="p">);</span>

<span class="nl">psb_intel_pipe_set_base_exit:</span>
	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets the power management mode of the pipe and plane.</span>
<span class="cm"> *</span>
<span class="cm"> * This code should probably grow support for turning the cursor off and back</span>
<span class="cm"> * on appropriately at the same time as we&#39;re turning the pipe off/on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* XXX: When our outputs are all unaware of DPMS modes other than off</span>
<span class="cm">	 * and on, we should map those modes to DRM_MODE_DPMS_OFF in the CRTC.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="cm">/* Enable the DPLL */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Enable the pipe */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">);</span>

		<span class="cm">/* Enable the plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				  <span class="n">temp</span> <span class="o">|</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">psb_intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

		<span class="cm">/* Give the overlay scaler a chance to enable</span>
<span class="cm">		 * if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, true); TODO */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="cm">/* Give the overlay scaler a chance to disable</span>
<span class="cm">		 * if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, FALSE); TODO */</span>

		<span class="cm">/* Disable the VGA plane that we never use */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">,</span> <span class="n">VGA_DISP_DISABLE</span><span class="p">);</span>

		<span class="cm">/* Disable display plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				  <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Next, disable display pipes */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIPEACONF_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for vblank for the disable to take effect. */</span>
		<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for the clocks to turn off. */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*Set FIFO Watermarks*/</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPARB</span><span class="p">,</span> <span class="mh">0x3F3E</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_encoder_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span>
	    <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="cm">/* lvds has its own version of prepare see psb_intel_lvds_prepare */</span>
	<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_encoder_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span>
	    <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="cm">/* lvds has its own version of commit see psb_intel_lvds_commit */</span>
	<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_encoder_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span> <span class="o">=</span> <span class="n">to_psb_intel_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="n">drm_encoder_cleanup</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">intel_encoder</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">psb_intel_crtc_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Return the pipe currently connected to the panel fitter,</span>
<span class="cm"> * or -1 if the panel fitter is not present or not in use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_intel_panel_fitter_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pfit_control</span><span class="p">;</span>

	<span class="n">pfit_control</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">);</span>

	<span class="cm">/* See if the panel fitter is in use */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pfit_control</span> <span class="o">&amp;</span> <span class="n">PFIT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Must be on PIPE 1 for PSB */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_intel_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">refclk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ok</span><span class="p">,</span> <span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_tv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="cm">/* No scan out no play */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
					<span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span>
		    <span class="o">||</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_LVDS</span>:
			<span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_SDVO</span>:
			<span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_TVOUT</span>:
			<span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">refclk</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">psb_intel_find_best_PLL</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t find PLL settings for mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">clock</span><span class="p">.</span><span class="n">m2</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">=</span> <span class="n">DPLL_VGA_MODE_DIS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_MODE_LVDS</span><span class="p">;</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DVO_HIGH_SPEED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_MODE_DAC_SERIAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sdvo_pixel_multiply</span> <span class="o">=</span>
			    <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">/</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DVO_HIGH_SPEED</span><span class="p">;</span>
		<span class="n">dpll</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">sdvo_pixel_multiply</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SDVO_MULTIPLIER_SHIFT_HIRES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* compute bitmask from p1 value */</span>
	<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DAC_SERIAL_P2_CLOCK_DIV_5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_LVDS_P2_CLOCK_DIV_7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DAC_SERIAL_P2_CLOCK_DIV_10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_LVDS_P2_CLOCK_DIV_14</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* XXX: just matching BIOS for now */</span>
<span class="cm">/*	dpll |= PLL_REF_INPUT_TVCLKINBC; */</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_REF_INPUT_DREFCLK</span><span class="p">;</span>

	<span class="cm">/* setup pipeconf */</span>
	<span class="n">pipeconf</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

	<span class="cm">/* Set up the display plane register */</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">DISPPLANE_GAMMA_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_SEL_PIPE_A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_SEL_PIPE_B</span><span class="p">;</span>

	<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">;</span>
	<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">;</span>
	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>


	<span class="cm">/* Disable the panel fitter if it was on our pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_panel_fitter_pipe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">pipe</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The LVDS pin pair needs to be on before the DPLLs are enabled.</span>
<span class="cm">	 * This is an exception to the general rule that mode_set doesn&#39;t turn</span>
<span class="cm">	 * things on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">lvds</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">);</span>

		<span class="n">lvds</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_PIPEB_SELECT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">lvds</span> <span class="o">|=</span> <span class="n">LVDS_PIPEB_SELECT</span><span class="p">;</span>

		<span class="n">lvds</span> <span class="o">|=</span> <span class="n">LVDS_PORT_EN</span> <span class="o">|</span> <span class="n">LVDS_A0A2_CLKA_POWER_UP</span><span class="p">;</span>
		<span class="cm">/* Set the B0-B3 data pairs corresponding to</span>
<span class="cm">		 * whether we&#39;re going to</span>
<span class="cm">		 * set the DPLLs for dual-channel mode or not.</span>
<span class="cm">		 */</span>
		<span class="n">lvds</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">lvds</span> <span class="o">|=</span> <span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">;</span>

		<span class="cm">/* It would be nice to set 24 vs 18-bit mode (LVDS_A3_POWER_UP)</span>
<span class="cm">		 * appropriately here, but we need to look more</span>
<span class="cm">		 * thoroughly into how panels behave in the two modes.</span>
<span class="cm">		 */</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">LVDS</span><span class="p">,</span> <span class="n">lvds</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="cm">/* Wait for the clocks to stabilize. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* write it again -- the BIOS does, after all */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>

	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="cm">/* Wait for the clocks to stabilize. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="cm">/* pipesrc and dspsize control the size that is scaled from,</span>
<span class="cm">	 * which should always be the user&#39;s requested size.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="cm">/* Flush the plane changes */</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>

	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Loads the palette/gamma unit for the CRTC with the prepared values */</span>
<span class="kt">void</span> <span class="nf">psb_intel_crtc_load_lut</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">palreg</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* The clocks have to be on to load the palette. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Illegal Pipe Number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">palreg</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Save HW states of giving crtc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_crtc_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc_state</span> <span class="o">*</span><span class="n">crtc_state</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">paletteReg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No CRTC state found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPCNTR</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPECONF</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPESRC</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP0</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP1</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHTOTAL</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHBLANK</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHSYNC</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVTOTAL</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVBLANK</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVSYNC</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSTRIDE</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">);</span>

	<span class="cm">/*NOTE: DSPSIZE DSPPOS only for psb*/</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSIZE</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPPOS</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">paletteReg</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePalette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">paletteReg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Restore HW states of giving crtc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_crtc_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span>  <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc_state</span> <span class="o">*</span><span class="n">crtc_state</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">paletteReg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No crtc state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP0</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP1</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHTOTAL</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHBLANK</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHSYNC</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVTOTAL</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVBLANK</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVSYNC</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSTRIDE</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSIZE</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPPOS</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPESRC</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPECONF</span><span class="p">);</span>

	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPCNTR</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span><span class="p">);</span>

	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">paletteReg</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">paletteReg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePalette</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_intel_crtc_cursor_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">width</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURACNTR</span> <span class="o">:</span> <span class="n">CURBCNTR</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURABASE</span> <span class="o">:</span> <span class="n">CURBBASE</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">gt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">cursor_gt</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_gt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tmp_dst</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cursor_pages</span><span class="p">;</span>

	<span class="cm">/* if we want to turn of the cursor ignore width and height */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* turn off the cursor */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">CURSOR_MODE_DISABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Unpin the old GEM object */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>
			<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">gt</span><span class="p">);</span>
			<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">);</span>
			<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Currently we only support 64x64 cursors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">!=</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">height</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;we currently only support 64x64 cursors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;buffer is to small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>

	<span class="cm">/* Pin the memory into the GTT */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">psb_gtt_pin</span><span class="p">(</span><span class="n">gt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can not pin down handle 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cursor_needs_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cursor_gt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No hardware cursor mem available&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Prevent overflow */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">npage</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">cursor_pages</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cursor_pages</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">npage</span><span class="p">;</span>

		<span class="cm">/* Copy the cursor to cursor mem */</span>
		<span class="n">tmp_dst</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">vram_addr</span> <span class="o">+</span> <span class="n">cursor_gt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cursor_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp_src</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_dst</span><span class="p">,</span> <span class="n">tmp_src</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="n">kunmap</span><span class="p">(</span><span class="n">gt</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">tmp_dst</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>      <span class="cm">/* Or resource.start ??? */</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* set the pipe for the cursor */</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_64_ARGB_AX</span> <span class="o">|</span> <span class="n">MCURSOR_GAMMA_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* unpin the old bo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>
		<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">gt</span><span class="p">);</span>
		<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">);</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_intel_crtc_cursor_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CURSOR_POS_SIGN</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_X_SHIFT</span><span class="p">);</span>
		<span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CURSOR_POS_SIGN</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_Y_SHIFT</span><span class="p">);</span>
		<span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">CURSOR_POS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_X_SHIFT</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">CURSOR_POS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_Y_SHIFT</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">((</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURAPOS</span> <span class="o">:</span> <span class="n">CURBPOS</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">((</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURABASE</span> <span class="o">:</span> <span class="n">CURBBASE</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_crtc_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">type</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">256</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psb_intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_crtc_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rpm_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">(</span><span class="n">set</span><span class="p">);</span>

	<span class="n">pm_runtime_forbid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">(</span><span class="n">set</span><span class="p">);</span>
	<span class="n">pm_runtime_allow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns the clock of the currently programmed mode of the given pipe. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_intel_crtc_clock_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dpll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_lvds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_pipe</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pipe</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">);</span>
		<span class="n">is_lvds</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">;</span>
		<span class="k">else</span>
		        <span class="n">fp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">;</span>

		<span class="n">is_lvds</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">psb</span><span class="p">.</span><span class="n">saveLVDS</span> <span class="o">&amp;</span>
								<span class="n">LVDS_PORT_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_M1_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M1_DIV_SHIFT</span><span class="p">;</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_M2_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIV_SHIFT</span><span class="p">;</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_N_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIV_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span>
		    <span class="n">ffs</span><span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span>
			 <span class="n">DPLL_FPA01_P1_POST_DIV_MASK_I830_LVDS</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">);</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_REF_INPUT_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">PLLB_REF_INPUT_SPREADSPECTRUMIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* XXX: might not be 66MHz */</span>
			<span class="n">i8xx_clock</span><span class="p">(</span><span class="mi">66000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">i8xx_clock</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_P1_DIVIDE_BY_TWO</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span>
			      <span class="n">DPLL_FPA01_P1_POST_DIV_MASK_I830</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			     <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_P2_DIVIDE_BY_4</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">i8xx_clock</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* XXX: It would be nice to validate the clocks, but we can&#39;t reuse</span>
<span class="cm">	 * i830PllIsValid() because it relies on the xf86_config connector</span>
<span class="cm">	 * configuration being accurate, which it isn&#39;t necessarily.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">clock</span><span class="p">.</span><span class="n">dot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Returns the currently programmed mode of the given pipe. */</span>
<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="nf">psb_intel_crtc_mode_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">htot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vtot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vsync</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_pipe</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pipe</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">htot</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
		<span class="n">hsync</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">);</span>
		<span class="n">vtot</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
		<span class="n">vsync</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">htot</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">;</span>
		<span class="n">hsync</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">;</span>
		<span class="n">vtot</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
		<span class="n">vsync</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">psb_intel_crtc_clock_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">htot</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="p">((</span><span class="n">htot</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsync</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">hsync</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">vtot</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="p">((</span><span class="n">vtot</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsync</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">vsync</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">drm_mode_set_name</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_crtc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">gt</span><span class="p">;</span>

	<span class="cm">/* Unpin the old GEM object */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>
		<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">gt</span><span class="p">);</span>
		<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">);</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_gt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">psb_gtt_free_range</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_gt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span><span class="p">);</span>
	<span class="n">drm_crtc_cleanup</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="n">psb_intel_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">psb_intel_crtc_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">psb_intel_crtc_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">psb_intel_crtc_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base</span> <span class="o">=</span> <span class="n">psb_intel_pipe_set_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">psb_intel_crtc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">psb_intel_crtc_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_funcs</span> <span class="n">psb_intel_crtc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">psb_intel_crtc_save</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">psb_intel_crtc_restore</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_set</span> <span class="o">=</span> <span class="n">psb_intel_crtc_cursor_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_move</span> <span class="o">=</span> <span class="n">psb_intel_crtc_cursor_move</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gamma_set</span> <span class="o">=</span> <span class="n">psb_intel_crtc_gamma_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_config</span> <span class="o">=</span> <span class="n">psb_crtc_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">psb_intel_crtc_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Set the default value of cursor control and base register</span>
<span class="cm"> * to zero. This is a workaround for h/w defect on Oaktrail</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_cursor_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CURACNTR</span><span class="p">,</span> <span class="n">CURBCNTR</span><span class="p">,</span> <span class="n">CURCCNTR</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">CURABASE</span><span class="p">,</span> <span class="n">CURBBASE</span><span class="p">,</span> <span class="n">CURCBASE</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">cursor_gt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cursor_needs_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate 4 pages of stolen mem for a hardware cursor. That</span>
<span class="cm">		 * is enough for the 64 x 64 ARGB cursors we support.</span>
<span class="cm">		 */</span>
		<span class="n">cursor_gt</span> <span class="o">=</span> <span class="n">psb_gtt_alloc_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;cursor&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cursor_gt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_gt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_gt</span> <span class="o">=</span> <span class="n">cursor_gt</span><span class="p">;</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stolen_base</span> <span class="o">+</span>
							<span class="n">cursor_gt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_gt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">control</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_crtc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">psb_intel_mode_device</span> <span class="o">*</span><span class="n">mode_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">r_base</span><span class="p">,</span> <span class="o">*</span><span class="n">g_base</span><span class="p">,</span> <span class="o">*</span><span class="n">b_base</span><span class="p">;</span>

	<span class="cm">/* We allocate a extra array of drm_connector pointers</span>
<span class="cm">	 * for fbdev after the crtc */</span>
	<span class="n">psb_intel_crtc</span> <span class="o">=</span>
	    <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psb_intel_crtc</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">INTELFB_CONN_LIMIT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="p">)),</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psb_intel_crtc_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Crtc state error: No memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the CRTC operations from the chip specific data */</span>
	<span class="n">drm_crtc_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">crtc_funcs</span><span class="p">);</span>

	<span class="n">drm_mode_crtc_set_gamma_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">r_base</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">gamma_store</span><span class="p">;</span>
	<span class="n">g_base</span> <span class="o">=</span> <span class="n">r_base</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">b_base</span> <span class="o">=</span> <span class="n">g_base</span> <span class="o">+</span> <span class="mi">256</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">r_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">g_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">b_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">mode_dev</span> <span class="o">=</span> <span class="n">mode_dev</span><span class="p">;</span>
	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drm_crtc_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
						<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">crtc_helper</span><span class="p">);</span>

	<span class="cm">/* Setup the array of drm_connector pointer array */</span>
	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pipe</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span>
							<span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span>
							<span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">mode_set</span><span class="p">.</span><span class="n">connectors</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">**</span><span class="p">)</span> <span class="p">(</span><span class="n">psb_intel_crtc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">mode_set</span><span class="p">.</span><span class="n">num_connectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psb_intel_cursor_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">psb_intel_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">psb_intel_get_pipe_from_crtc_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_get_pipe_from_crtc_id_arg</span> <span class="o">*</span><span class="n">pipe_from_crtc_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">drmmode_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drmmode_obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe_from_crtc_id</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span>
			<span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drmmode_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no such CRTC id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">drmmode_obj</span><span class="p">));</span>
	<span class="n">pipe_from_crtc_id</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="nf">psb_intel_get_crtc_from_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">pipe</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">crtc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">psb_intel_connector_clones</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span>
			    <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
					<span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
			<span class="n">index_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">index_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* current intel driver doesn&#39;t take advantage of encoders</span>
<span class="cm">   always give back the encoder for the connector</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="nf">psb_intel_best_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
					<span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">psb_intel_connector_attach_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">psb_intel_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">;</span>
	<span class="n">drm_mode_connector_attach_encoder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
