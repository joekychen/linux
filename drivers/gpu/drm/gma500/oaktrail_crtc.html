<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › oaktrail_crtc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>oaktrail_crtc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2009 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;drm/drmP.h&gt;</span>
<span class="cp">#include &quot;framebuffer.h&quot;</span>
<span class="cp">#include &quot;psb_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_reg.h&quot;</span>
<span class="cp">#include &quot;psb_intel_display.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>

<span class="k">struct</span> <span class="n">psb_intel_range_t</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">oaktrail_limit_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_range_t</span> <span class="n">dot</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">oaktrail_clock_t</span> <span class="p">{</span>
	<span class="cm">/* derived values */</span>
	<span class="kt">int</span> <span class="n">dot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MRST_LIMIT_LVDS_100L	    0</span>
<span class="cp">#define MRST_LIMIT_LVDS_83	    1</span>
<span class="cp">#define MRST_LIMIT_LVDS_100	    2</span>

<span class="cp">#define MRST_DOT_MIN		  19750</span>
<span class="cp">#define MRST_DOT_MAX		  120000</span>
<span class="cp">#define MRST_M_MIN_100L		    20</span>
<span class="cp">#define MRST_M_MIN_100		    10</span>
<span class="cp">#define MRST_M_MIN_83		    12</span>
<span class="cp">#define MRST_M_MAX_100L		    34</span>
<span class="cp">#define MRST_M_MAX_100		    17</span>
<span class="cp">#define MRST_M_MAX_83		    20</span>
<span class="cp">#define MRST_P1_MIN		    2</span>
<span class="cp">#define MRST_P1_MAX_0		    7</span>
<span class="cp">#define MRST_P1_MAX_1		    8</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">oaktrail_limit_t</span> <span class="n">oaktrail_limits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/* MRST_LIMIT_LVDS_100L */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_M_MIN_100L</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_M_MAX_100L</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_P1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_P1_MAX_1</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MRST_LIMIT_LVDS_83L */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_M_MIN_83</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_M_MAX_83</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_P1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_P1_MAX_0</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MRST_LIMIT_LVDS_100 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_M_MIN_100</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_M_MAX_100</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MRST_P1_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MRST_P1_MAX_1</span><span class="p">},</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define MRST_M_MIN	    10</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">oaktrail_m_converts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x2B</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">,</span>
	<span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x3B</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="mh">0x2E</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span>
	<span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">oaktrail_limit_t</span> <span class="o">*</span><span class="nf">oaktrail_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">oaktrail_limit_t</span> <span class="o">*</span><span class="n">limit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">psb_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_MIPI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">100</span>:
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">oaktrail_limits</span><span class="p">[</span><span class="n">MRST_LIMIT_LVDS_100L</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">166</span>:
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">oaktrail_limits</span><span class="p">[</span><span class="n">MRST_LIMIT_LVDS_83</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">200</span>:
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">oaktrail_limits</span><span class="p">[</span><span class="n">MRST_LIMIT_LVDS_100</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;oaktrail_limit Wrong display type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Derive the pixel clock for the given refclk and divisors for 8xx chips. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">oaktrail_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="p">(</span><span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mrstPrintPll</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="k">struct</span> <span class="n">oaktrail_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: dotclock = %d,  m = %d, p1 = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">prefix</span><span class="p">,</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">,</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">,</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Returns a set of divisors for the desired target clock with the given refclk,</span>
<span class="cm"> * or FALSE.  Divisor values are the actual divisors for</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mrstFindBestPLL</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">oaktrail_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">oaktrail_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">oaktrail_limit_t</span> <span class="o">*</span><span class="n">limit</span> <span class="o">=</span> <span class="n">oaktrail_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">best_clock</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">max</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
		     <span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">this_err</span><span class="p">;</span>

			<span class="n">oaktrail_clock</span><span class="p">(</span><span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

			<span class="n">this_err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">dot</span> <span class="o">-</span> <span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this_err</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">best_clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">this_err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mrstFindBestPLL err = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets the power management mode of the pipe and plane.</span>
<span class="cm"> *</span>
<span class="cm"> * This code should probably grow support for turning the cursor off and back</span>
<span class="cm"> * on appropriately at the same time as we&#39;re turning the pipe off/on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* XXX: When our outputs are all unaware of DPMS modes other than off</span>
<span class="cm">	 * and on, we should map those modes to DRM_MODE_DPMS_OFF in the CRTC.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="cm">/* Enable the DPLL */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Enable the pipe */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">);</span>
		<span class="cm">/* Enable the plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				  <span class="n">temp</span> <span class="o">|</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">psb_intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

		<span class="cm">/* Give the overlay scaler a chance to enable</span>
<span class="cm">		   if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, true); TODO */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="cm">/* Give the overlay scaler a chance to disable</span>
<span class="cm">		 * if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, FALSE); TODO */</span>

		<span class="cm">/* Disable the VGA plane that we never use */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">,</span> <span class="n">VGA_DISP_DISABLE</span><span class="p">);</span>
		<span class="cm">/* Disable display plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				  <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Next, disable display pipes */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIPEACONF_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Wait for for the pipe disable to take effect. */</span>
		<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for the clocks to turn off. */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*Set FIFO Watermarks*/</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPARB</span><span class="p">,</span> <span class="mh">0x3FFF</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">,</span> <span class="mh">0x3F88080A</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">,</span> <span class="mh">0x0b060808</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW4</span><span class="p">,</span> <span class="mh">0x08030404</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW5</span><span class="p">,</span> <span class="mh">0x04040404</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW6</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="mh">0x70400</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="mh">0x70400</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="cm">/* Must write Bit 14 of the Chicken Bit Register */</span>

	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return the pipe currently connected to the panel fitter,</span>
<span class="cm"> * or -1 if the panel fitter is not present or not in use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">oaktrail_panel_fitter_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pfit_control</span><span class="p">;</span>

	<span class="n">pfit_control</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">);</span>

	<span class="cm">/* See if the panel fitter is in use */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pfit_control</span> <span class="o">&amp;</span> <span class="n">PFIT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pfit_control</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">oaktrail_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">refclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">oaktrail_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ok</span><span class="p">,</span> <span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_mipi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">scalingType</span> <span class="o">=</span> <span class="n">DRM_MODE_SCALE_FULLSCREEN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">saved_mode</span><span class="p">,</span>
		<span class="n">mode</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">saved_adjusted_mode</span><span class="p">,</span>
		<span class="n">adjusted_mode</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span><span class="p">));</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">||</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">psb_intel_encoder</span> <span class="o">=</span> <span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_LVDS</span>:
			<span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_SDVO</span>:
			<span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_MIPI</span>:
			<span class="n">is_mipi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the VGA plane that we never use */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">,</span> <span class="n">VGA_DISP_DISABLE</span><span class="p">);</span>

	<span class="cm">/* Disable the panel fitter if it was on our pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oaktrail_panel_fitter_pipe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">pipe</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="p">)</span>
		<span class="n">drm_connector_property_get_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">scaling_mode_property</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scalingType</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scalingType</span> <span class="o">==</span> <span class="n">DRM_MODE_SCALE_NO_SCALE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Moorestown doesn&#39;t have register support for centering so</span>
<span class="cm">		 * we need to mess with the h/vblank and h/vsync start and</span>
<span class="cm">		 * ends to get centering */</span>
		<span class="kt">int</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">offsetX</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span>
			   <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">offsetY</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span>
			   <span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span>
			<span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span> <span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span>
			<span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span> <span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span>
			<span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span> <span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span>
			<span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span> <span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Flush the plane changes */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span>
		    <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup pipeconf */</span>
	<span class="n">pipeconf</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

	<span class="cm">/* Set up the display plane register */</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_GAMMA_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_SEL_PIPE_A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_SEL_PIPE_B</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oaktrail_crtc_mode_set_exit</span><span class="p">;</span>

	<span class="n">refclk</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/*BIT16 = 0 for 100MHz reference */</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">mrstFindBestPLL</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mrstFindBestPLL fail in oaktrail_crtc_mode_set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;oaktrail_crtc_mode_set pixel clock = %d,&quot;</span>
			 <span class="s">&quot;m = %x, p1 = %x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clock</span><span class="p">.</span><span class="n">dot</span><span class="p">,</span> <span class="n">clock</span><span class="p">.</span><span class="n">m</span><span class="p">,</span>
			 <span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">oaktrail_m_converts</span><span class="p">[(</span><span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">MRST_M_MIN</span><span class="p">)]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VGA_MODE_DIS</span><span class="p">;</span>


	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLA_MODE_LVDS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_MODE_DAC_SERIAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sdvo_pixel_multiply</span> <span class="o">=</span>
		    <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">/</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>

		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DVO_HIGH_SPEED</span><span class="p">;</span>
		<span class="n">dpll</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">sdvo_pixel_multiply</span> <span class="o">-</span>
		     <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SDVO_MULTIPLIER_SHIFT_HIRES</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* compute bitmask from p1 value */</span>
	<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>

	<span class="n">mrstPrintPll</span><span class="p">(</span><span class="s">&quot;chosen&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="cm">/* Check the DPLLA lock bit PIPEACONF[29] */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="cm">/* Wait for the clocks to stabilize. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* write it again -- the BIOS does, after all */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="cm">/* Wait for the clocks to stabilize. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>
	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">oaktrail_crtc_mode_set_exit:</span>
	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">oaktrail_crtc_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">oaktrail_pipe_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_framebuffer</span> <span class="o">*</span><span class="n">psbfb</span> <span class="o">=</span> <span class="n">to_psb_fb</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* no fb bound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No FB bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">psbfb</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PIXFORMAT_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_8BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_15_16BPP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown color depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">pipe_set_base_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">surf</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">surf</span><span class="p">);</span>

<span class="nl">pipe_set_base_exit:</span>
	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="n">oaktrail_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">oaktrail_crtc_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">oaktrail_crtc_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">oaktrail_crtc_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base</span> <span class="o">=</span> <span class="n">oaktrail_pipe_set_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">oaktrail_crtc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">oaktrail_crtc_commit</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
