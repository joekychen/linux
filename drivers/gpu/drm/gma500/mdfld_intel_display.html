<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › mdfld_intel_display.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>mdfld_intel_display.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright Â© 2006-2007 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;drm/drmP.h&gt;</span>
<span class="cp">#include &quot;psb_intel_reg.h&quot;</span>
<span class="cp">#include &quot;psb_intel_display.h&quot;</span>
<span class="cp">#include &quot;framebuffer.h&quot;</span>
<span class="cp">#include &quot;mdfld_output.h&quot;</span>
<span class="cp">#include &quot;mdfld_dsi_output.h&quot;</span>

<span class="cm">/* Hardcoded currently */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ksel</span> <span class="o">=</span> <span class="n">KSEL_CRYSTAL_19</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">psb_intel_range_t</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mrst_limit_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_range_t</span> <span class="n">dot</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mrst_clock_t</span> <span class="p">{</span>
	<span class="cm">/* derived values */</span>
	<span class="kt">int</span> <span class="n">dot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define COUNT_MAX 0x10000000</span>

<span class="kt">void</span> <span class="nf">mdfldWaitForPipeDisable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Illegal Pipe Number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME JLIU7_PO */</span>
	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Wait for for the pipe disable to take effect. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">COUNT_MAX</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_PIPE_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mdfldWaitForPipeEnable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Illegal Pipe Number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME JLIU7_PO */</span>
	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Wait for for the pipe enable to take effect. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">COUNT_MAX</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_PIPE_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">psb_intel_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">psb_intel_crtc_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return the pipe currently connected to the panel fitter,</span>
<span class="cm"> * or -1 if the panel fitter is not present or not in use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">psb_intel_panel_fitter_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pfit_control</span><span class="p">;</span>

	<span class="n">pfit_control</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">);</span>

	<span class="cm">/* See if the panel fitter is in use */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pfit_control</span> <span class="o">&amp;</span> <span class="n">PFIT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* 965 can place panel fitter on either pipe */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pfit_control</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_device</span> <span class="n">globle_dev</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">mdfld__intel_plane_set_alpha</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">globle_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dspcntr_reg</span> <span class="o">=</span> <span class="n">DSPACNTR</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">;</span>

	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">dspcntr_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_32BPP</span><span class="p">;</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">dspcntr_reg</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">16</span>:
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown color depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdfld__intel_pipe_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_framebuffer</span> <span class="o">*</span><span class="n">psbfb</span> <span class="o">=</span> <span class="n">to_psb_fb</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">globle_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pipe = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* no fb bound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No FB bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_fb</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Illegal Pipe Number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">psbfb</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PIXFORMAT_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_8BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_15_16BPP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Writing base %08lX %08lX %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">linoff</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">linoff</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">surf</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">surf</span><span class="p">);</span>

	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable the pipe, plane and pll.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mdfld_disable_crtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pipe = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mdfld_dsi_gen_fifo_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MIPI_GEN_FIFO_STAT_REG</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
				<span class="n">HS_CTRL_FIFO_EMPTY</span> <span class="o">|</span> <span class="n">HS_DATA_FIFO_EMPTY</span><span class="p">);</span>

	<span class="cm">/* Disable display plane */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
			  <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
		<span class="cm">/* Flush the plane changes */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME_JLIU7 MDFLD_PO revisit */</span>

	<span class="cm">/* Next, disable display pipes */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPEACONF_ENABLE</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPECONF_PLANE_OFF</span> <span class="o">|</span> <span class="n">PIPECONF_CURSOR_OFF</span><span class="p">;</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

		<span class="cm">/* Wait for for the pipe disable to take effect. */</span>
		<span class="n">mdfldWaitForPipeDisable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pipe</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">PIPEACONF</span><span class="p">)</span> <span class="o">|</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PIPECCONF</span><span class="p">))</span>
				<span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">))</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to turn off. */</span>
			<span class="cm">/* FIXME_MDFLD PO may need more delay */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">MDFLD_PWR_GATE_EN</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* gating power of DPLL */</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">MDFLD_PWR_GATE_EN</span><span class="p">);</span>
				<span class="cm">/* FIXME_MDFLD PO - change 500 to 1 after PO */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets the power management mode of the pipe and plane.</span>
<span class="cm"> *</span>
<span class="cm"> * This code should probably grow support for turning the cursor off and back</span>
<span class="cm"> * on appropriately at the same time as we&#39;re turning the pipe off/on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdfld_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pipeconf</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipeconf</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mode = %d, pipe = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* Note: Old code uses pipe a stat for pipe b but that appears</span>
<span class="cm">	   to be a bug */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* XXX: When our outputs are all unaware of DPMS modes other than off</span>
<span class="cm">	 * and on, we should map those modes to DRM_MODE_DPMS_OFF in the CRTC.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="cm">/* Enable the DPLL */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* When ungating power of DPLL, needs to wait 0.5us</span>
<span class="cm">			   before enable the VCO */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">MDFLD_PWR_GATE_EN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDFLD_PWR_GATE_EN</span><span class="p">;</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
				<span class="cm">/* FIXME_MDFLD PO - change 500 to 1 after PO */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* FIXME_MDFLD PO - change 500 to 1 after PO */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>

			<span class="cm">/**</span>
<span class="cm">			 * wait for DSI PLL to lock</span>
<span class="cm">			 * NOTE: only need to poll status of pipe 0 and pipe 1,</span>
<span class="cm">			 * since both MIPI pipes share the same PLL.</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">pipe</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			  <span class="o">!</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PIPECONF_DSIPLL_LOCK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
				<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Enable the plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				<span class="n">temp</span> <span class="o">|</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Enable the pipe */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">);</span>

			<span class="cm">/* Wait for for the pipe enable to take effect. */</span>
			<span class="n">mdfldWaitForPipeEnable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*workaround for sighting 3741701 Random X blank display*/</span>
		<span class="cm">/*perform w/a in video mode only on pipe A or C*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PIPE_VBLANK_STATUS</span> <span class="o">&amp;</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;STUCK!!!!&quot;</span><span class="p">);</span>
				<span class="cm">/*shutdown controller*/</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
						<span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
				<span class="cm">/*mdfld_dsi_dpi_shut_down(dev, pipe);*/</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="mh">0xb048</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPEACONF_ENABLE</span><span class="p">;</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="cm">/*wait for pipe disable*/</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">MIPI_DEVICE_READY_REG</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="mh">0xb004</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="mh">0xb004</span><span class="p">));</span>
				<span class="cm">/* try to bring the controller back up again*/</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">MIPI_DEVICE_READY_REG</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
						<span class="n">temp</span> <span class="o">|</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
				<span class="cm">/*mdfld_dsi_dpi_turn_on(dev, pipe);*/</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="mh">0xb048</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">;</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">psb_intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

		<span class="cm">/* Give the overlay scaler a chance to enable</span>
<span class="cm">		   if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, true); TODO */</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="cm">/* Give the overlay scaler a chance to disable</span>
<span class="cm">		 * if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, FALSE); TODO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mdfld_dsi_gen_fifo_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">MIPI_GEN_FIFO_STAT_REG</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
				<span class="n">HS_CTRL_FIFO_EMPTY</span> <span class="o">|</span> <span class="n">HS_DATA_FIFO_EMPTY</span><span class="p">);</span>

		<span class="cm">/* Disable the VGA plane that we never use */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">,</span> <span class="n">VGA_DISP_DISABLE</span><span class="p">);</span>

		<span class="cm">/* Disable display plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				  <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Next, disable display pipes */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPEACONF_ENABLE</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPECONF_PLANE_OFF</span> <span class="o">|</span> <span class="n">PIPECONF_CURSOR_OFF</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

			<span class="cm">/* Wait for for the pipe disable to take effect. */</span>
			<span class="n">mdfldWaitForPipeDisable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pipe</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">PIPEACONF</span><span class="p">)</span>
				<span class="o">|</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PIPECCONF</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">))</span>
					<span class="o">||</span> <span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
				<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
				<span class="cm">/* Wait for the clocks to turn off. */</span>
				<span class="cm">/* FIXME_MDFLD PO may need more delay */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define MDFLD_LIMT_DPLL_19	    0</span>
<span class="cp">#define MDFLD_LIMT_DPLL_25	    1</span>
<span class="cp">#define MDFLD_LIMT_DPLL_83	    2</span>
<span class="cp">#define MDFLD_LIMT_DPLL_100	    3</span>
<span class="cp">#define MDFLD_LIMT_DSIPLL_19	    4</span>
<span class="cp">#define MDFLD_LIMT_DSIPLL_25	    5</span>
<span class="cp">#define MDFLD_LIMT_DSIPLL_83	    6</span>
<span class="cp">#define MDFLD_LIMT_DSIPLL_100	    7</span>

<span class="cp">#define MDFLD_DOT_MIN		  19750</span>
<span class="cp">#define MDFLD_DOT_MAX		  120000</span>
<span class="cp">#define MDFLD_DPLL_M_MIN_19	    113</span>
<span class="cp">#define MDFLD_DPLL_M_MAX_19	    155</span>
<span class="cp">#define MDFLD_DPLL_P1_MIN_19	    2</span>
<span class="cp">#define MDFLD_DPLL_P1_MAX_19	    10</span>
<span class="cp">#define MDFLD_DPLL_M_MIN_25	    101</span>
<span class="cp">#define MDFLD_DPLL_M_MAX_25	    130</span>
<span class="cp">#define MDFLD_DPLL_P1_MIN_25	    2</span>
<span class="cp">#define MDFLD_DPLL_P1_MAX_25	    10</span>
<span class="cp">#define MDFLD_DPLL_M_MIN_83	    64</span>
<span class="cp">#define MDFLD_DPLL_M_MAX_83	    64</span>
<span class="cp">#define MDFLD_DPLL_P1_MIN_83	    2</span>
<span class="cp">#define MDFLD_DPLL_P1_MAX_83	    2</span>
<span class="cp">#define MDFLD_DPLL_M_MIN_100	    64</span>
<span class="cp">#define MDFLD_DPLL_M_MAX_100	    64</span>
<span class="cp">#define MDFLD_DPLL_P1_MIN_100	    2</span>
<span class="cp">#define MDFLD_DPLL_P1_MAX_100	    2</span>
<span class="cp">#define MDFLD_DSIPLL_M_MIN_19	    131</span>
<span class="cp">#define MDFLD_DSIPLL_M_MAX_19	    175</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MIN_19	    3</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MAX_19	    8</span>
<span class="cp">#define MDFLD_DSIPLL_M_MIN_25	    97</span>
<span class="cp">#define MDFLD_DSIPLL_M_MAX_25	    140</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MIN_25	    3</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MAX_25	    9</span>
<span class="cp">#define MDFLD_DSIPLL_M_MIN_83	    33</span>
<span class="cp">#define MDFLD_DSIPLL_M_MAX_83	    92</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MIN_83	    2</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MAX_83	    3</span>
<span class="cp">#define MDFLD_DSIPLL_M_MIN_100	    97</span>
<span class="cp">#define MDFLD_DSIPLL_M_MAX_100	    140</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MIN_100	    3</span>
<span class="cp">#define MDFLD_DSIPLL_P1_MAX_100	    9</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mrst_limit_t</span> <span class="n">mdfld_limits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DPLL_19 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MIN_19</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MAX_19</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MIN_19</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MAX_19</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DPLL_25 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MIN_25</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MAX_25</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MIN_25</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MAX_25</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DPLL_83 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MIN_83</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MAX_83</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MIN_83</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MAX_83</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DPLL_100 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MIN_100</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_M_MAX_100</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MIN_100</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DPLL_P1_MAX_100</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DSIPLL_19 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MIN_19</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MAX_19</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MIN_19</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MAX_19</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DSIPLL_25 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MIN_25</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MAX_25</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MIN_25</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MAX_25</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DSIPLL_83 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MIN_83</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MAX_83</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MIN_83</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MAX_83</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* MDFLD_LIMT_DSIPLL_100 */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MIN</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DOT_MAX</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MIN_100</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_M_MAX_100</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MIN_100</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MDFLD_DSIPLL_P1_MAX_100</span><span class="p">},</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define MDFLD_M_MIN	    21</span>
<span class="cp">#define MDFLD_M_MAX	    180</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">mdfld_m_converts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* M configuration table from 9-bit LFSR table */</span>
	<span class="mi">224</span><span class="p">,</span> <span class="mi">368</span><span class="p">,</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">366</span><span class="p">,</span> <span class="mi">439</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">365</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">347</span><span class="p">,</span> <span class="cm">/* 21 - 30 */</span>
	<span class="mi">173</span><span class="p">,</span> <span class="mi">342</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">298</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">265</span><span class="p">,</span>   <span class="cm">/* 31 - 40 */</span>
	<span class="mi">388</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">353</span><span class="p">,</span> <span class="mi">432</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">310</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">333</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="cm">/* 41 - 50 */</span>
	<span class="mi">83</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">276</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">325</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">337</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">340</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="cm">/* 51 - 60 */</span>
	<span class="mi">341</span><span class="p">,</span> <span class="mi">426</span><span class="p">,</span> <span class="mi">469</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">373</span><span class="p">,</span> <span class="mi">442</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">311</span><span class="p">,</span> <span class="mi">411</span><span class="p">,</span> <span class="cm">/* 61 - 70 */</span>
	<span class="mi">461</span><span class="p">,</span> <span class="mi">486</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">377</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">343</span><span class="p">,</span> <span class="mi">427</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="cm">/* 71 - 80 */</span>
	<span class="mi">106</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">282</span><span class="p">,</span> <span class="mi">397</span><span class="p">,</span> <span class="mi">354</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">284</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="cm">/* 81 - 90 */</span>
	<span class="mi">71</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">324</span><span class="p">,</span> <span class="mi">418</span><span class="p">,</span> <span class="mi">465</span><span class="p">,</span> <span class="mi">488</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">506</span><span class="p">,</span> <span class="cm">/* 91 - 100 */</span>
	<span class="mi">253</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">287</span><span class="p">,</span> <span class="mi">399</span><span class="p">,</span> <span class="mi">455</span><span class="p">,</span> <span class="mi">483</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">376</span><span class="p">,</span> <span class="mi">444</span><span class="p">,</span> <span class="cm">/* 101 - 110 */</span>
	<span class="mi">478</span><span class="p">,</span> <span class="mi">495</span><span class="p">,</span> <span class="mi">503</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">381</span><span class="p">,</span> <span class="mi">446</span><span class="p">,</span> <span class="mi">479</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">443</span><span class="p">,</span> <span class="cm">/* 111 - 120 */</span>
	<span class="mi">477</span><span class="p">,</span> <span class="mi">238</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">315</span><span class="p">,</span> <span class="mi">157</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">295</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">329</span><span class="p">,</span> <span class="mi">420</span><span class="p">,</span> <span class="cm">/* 121 - 130 */</span>
	<span class="mi">210</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">308</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">275</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="cm">/* 131 - 140 */</span>
	<span class="mi">145</span><span class="p">,</span> <span class="mi">328</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">297</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="mi">458</span><span class="p">,</span> <span class="mi">485</span><span class="p">,</span> <span class="mi">498</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="cm">/* 141 - 150 */</span>
	<span class="mi">380</span><span class="p">,</span> <span class="mi">190</span><span class="p">,</span> <span class="mi">351</span><span class="p">,</span> <span class="mi">431</span><span class="p">,</span> <span class="mi">471</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">314</span><span class="p">,</span> <span class="mi">413</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="cm">/* 151 - 160 */</span>
	<span class="mi">103</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">262</span><span class="p">,</span> <span class="mi">387</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="cm">/* 161 - 170 */</span>
	<span class="mi">396</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">294</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="mi">457</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="cm">/* 171 - 180 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mrst_limit_t</span> <span class="o">*</span><span class="nf">mdfld_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mrst_limit_t</span> <span class="o">*</span><span class="n">limit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_MIPI</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">psb_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_MIPI2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_CRYSTAL_19</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_19</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DSIPLL_19</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_25</span><span class="p">)</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DSIPLL_25</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_83_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">166</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DSIPLL_83</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_83_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">100</span> <span class="o">||</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">200</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DSIPLL_100</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_HDMI</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_CRYSTAL_19</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_19</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DPLL_19</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_25</span><span class="p">)</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DPLL_25</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_83_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">166</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DPLL_83</span><span class="p">];</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_83_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				 <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">100</span> <span class="o">||</span>
				 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">200</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mdfld_limits</span><span class="p">[</span><span class="n">MDFLD_LIMT_DPLL_100</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mdfld_limit Wrong display type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Derive the pixel clock for the given refclk and divisors for 8xx chips. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mdfld_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mrst_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="p">(</span><span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Returns a set of divisors for the desired target clock with the given refclk,</span>
<span class="cm"> * or FALSE.  Divisor values are the actual divisors for</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mdfldFindBestPLL</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">mrst_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrst_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mrst_limit_t</span> <span class="o">*</span><span class="n">limit</span> <span class="o">=</span> <span class="n">mdfld_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">best_clock</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">max</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
		     <span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">this_err</span><span class="p">;</span>

			<span class="n">mdfld_clock</span><span class="p">(</span><span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

			<span class="n">this_err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">dot</span> <span class="o">-</span> <span class="n">target</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this_err</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">best_clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">this_err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mdfld_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">refclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clk_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clk_byte</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_conv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
								<span class="n">clk_tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mrst_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ok</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_mipi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_mipi2</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_hdmi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">scalingType</span> <span class="o">=</span> <span class="n">DRM_MODE_SCALE_FULLSCREEN</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pipe = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if (pipe == 1) {</span>
<span class="c">		if (!gma_power_begin(dev, true))</span>
<span class="c">			return 0;</span>
<span class="c">		android_hdmi_crtc_mode_set(crtc, mode, adjusted_mode,</span>
<span class="c">			x, y, old_fb);</span>
<span class="c">		goto mrst_crtc_mode_set_exit;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_fb</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_hdisplay = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_vdisplay = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_hsync_start = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_hsync_end = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_htotal = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_vsync_start = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_vsync_end = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_vtotal = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_clock = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hdisplay = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdisplay = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">saved_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">saved_adjusted_mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span><span class="p">));</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">encoder</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoder</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">psb_intel_encoder</span> <span class="o">=</span> <span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_MIPI</span>:
			<span class="n">is_mipi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_MIPI2</span>:
			<span class="n">is_mipi2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_HDMI</span>:
			<span class="n">is_hdmi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Disable the VGA plane that we never use */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">,</span> <span class="n">VGA_DISP_DISABLE</span><span class="p">);</span>

	<span class="cm">/* Disable the panel fitter if it was on our pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_panel_fitter_pipe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">pipe</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* pipesrc and dspsize control the size that is scaled from,</span>
<span class="cm">	 * which should always be the user&#39;s requested size.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: To make HDMI display with 864x480 (TPO), 480x864</span>
<span class="cm">		 * (PYR) or 480x854 (TMD), set the sprite width/height and</span>
<span class="cm">		 * souce image size registers with the adjusted mode for</span>
<span class="cm">		 * pipe B.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * The defined sprite rectangle must always be completely</span>
<span class="cm">		 * contained within the displayable area of the screen image</span>
<span class="cm">		 * (frame buffer).</span>
<span class="cm">		 */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="p">((</span><span class="n">min</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="cm">/* Set the CRTC with encoder mode. */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				 <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				<span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span>
				<span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="p">)</span>
		<span class="n">drm_connector_property_get_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">scaling_mode_property</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scalingType</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scalingType</span> <span class="o">==</span> <span class="n">DRM_MODE_SCALE_NO_SCALE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Medfield doesn&#39;t have register support for centering so we</span>
<span class="cm">		 * need to mess with the h/vblank and h/vsync start and ends</span>
<span class="cm">		 * to get centering</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetY</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">offsetX</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span>
					<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">offsetY</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span>
					<span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span>
								<span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span>
								<span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="n">offsetX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span>
								<span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span>
								<span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="n">offsetY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Flush the plane changes */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span>
		    <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* setup pipeconf */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipeconf</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">;</span> <span class="cm">/* FIXME_JLIU7 REG_READ(pipeconf_reg); */</span>

	<span class="cm">/* Set up the display plane register */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dspcntr</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dspcntr</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="n">DISPPLANE_SEL_PIPE_POS</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dspcntr</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mrst_crtc_mode_set_exit</span><span class="p">;</span>
	<span class="n">clk</span> <span class="o">=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_hdmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_CRYSTAL_19</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_19</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">refclk</span> <span class="o">=</span> <span class="mi">19200</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi</span> <span class="o">||</span> <span class="n">is_mipi2</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_hdmi</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_25</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">refclk</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi</span> <span class="o">||</span> <span class="n">is_mipi2</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_hdmi</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_83_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">166</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">refclk</span> <span class="o">=</span> <span class="mi">83000</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi</span> <span class="o">||</span> <span class="n">is_mipi2</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_hdmi</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ksel</span> <span class="o">==</span> <span class="n">KSEL_BYPASS_83_100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">100</span> <span class="o">||</span>
					<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">core_freq</span> <span class="o">==</span> <span class="mi">200</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">refclk</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi</span> <span class="o">||</span> <span class="n">is_mipi2</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_hdmi</span><span class="p">)</span>
				<span class="n">clk_n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">clk_p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi</span><span class="p">)</span>
			<span class="n">clk_byte</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_mipi2</span><span class="p">)</span>
			<span class="n">clk_byte</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bpp2</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">clk_tmp</span> <span class="o">=</span> <span class="n">clk</span> <span class="o">*</span> <span class="n">clk_n</span> <span class="o">*</span> <span class="n">clk_p2</span> <span class="o">*</span> <span class="n">clk_byte</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk = %d, clk_n = %d, clk_p2 = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">clk</span><span class="p">,</span> <span class="n">clk_n</span><span class="p">,</span> <span class="n">clk_p2</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;adjusted_mode-&gt;clock = %d, clk_tmp = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">clk_tmp</span><span class="p">);</span>

		<span class="n">ok</span> <span class="o">=</span> <span class="n">mdfldFindBestPLL</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">clk_tmp</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span>
			    <span class="p">(</span><span class="s">&quot;mdfldFindBestPLL fail in mdfld_crtc_mode_set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">m_conv</span> <span class="o">=</span> <span class="n">mdfld_m_converts</span><span class="p">[(</span><span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">-</span> <span class="n">MDFLD_M_MIN</span><span class="p">)];</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dot clock = %d,&quot;</span>
				 <span class="s">&quot;m = %d, p1 = %d, m_conv = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">clock</span><span class="p">.</span><span class="n">dot</span><span class="p">,</span> <span class="n">clock</span><span class="p">.</span><span class="n">m</span><span class="p">,</span>
					<span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="p">,</span> <span class="n">m_conv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dpll</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>

			<span class="cm">/* FIXME jliu7 check the DPLL lock bit PIPEACONF[29] */</span>
			<span class="cm">/* FIXME_MDFLD PO - change 500 to 1 after PO */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

			<span class="cm">/* reset M1, N1 &amp; P1 */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDFLD_P1_MASK</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* FIXME_MDFLD PO - change 500 to 1 after PO */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* When ungating power of DPLL, needs to wait 0.5us before</span>
<span class="cm">		 * enable the VCO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">MDFLD_PWR_GATE_EN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MDFLD_PWR_GATE_EN</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* FIXME_MDFLD PO - change 500 to 1 after PO */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"> /* FIXME revisit later */</span>
<span class="c">		if (ksel == KSEL_CRYSTAL_19 || ksel == KSEL_BYPASS_19 ||</span>
<span class="c">						ksel == KSEL_BYPASS_25)</span>
<span class="c">			dpll &amp;= ~MDFLD_INPUT_REF_SEL;</span>
<span class="c">		else if (ksel == KSEL_BYPASS_83_100)</span>
<span class="c">			dpll |= MDFLD_INPUT_REF_SEL;</span>
<span class="cp">#endif /* FIXME revisit later */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_hdmi</span><span class="p">)</span>
			<span class="n">dpll</span> <span class="o">|=</span> <span class="n">MDFLD_VCO_SEL</span><span class="p">;</span>

		<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">clk_n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">|=</span> <span class="n">m_conv</span><span class="p">;</span>

		<span class="cm">/* compute bitmask from p1 value */</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"> /* 1080p30 &amp; 720p */</span>
<span class="c">		dpll = 0x00050000;</span>
<span class="c">		fp = 0x000001be;</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"> /* 480p */</span>
<span class="c">		dpll = 0x02010000;</span>
<span class="c">		fp = 0x000000d2;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /*DBI_TPO_480x864*/</span>
<span class="c">		dpll = 0x00020000;</span>
<span class="c">		fp = 0x00000156;</span>
<span class="cp">#endif /* DBI_TPO_480x864 */ /* get from spec. */</span>

		<span class="n">dpll</span> <span class="o">=</span> <span class="mh">0x00800000</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="mh">0x000000c1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
	<span class="cm">/* FIXME_MDFLD PO - change 500 to 1 after PO */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>

	<span class="cm">/* wait for DSI PLL to lock */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">20000</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PIPECONF_DSIPLL_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_mipi</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">mrst_crtc_mode_set_exit</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;is_mipi = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is_mipi</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipeconf</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

	<span class="cm">/* Wait for for the pipe enable to take effect. */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dspcntr</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
	<span class="n">psb_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">mrst_crtc_mode_set_exit:</span>

	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="n">mdfld_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">mdfld_crtc_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">psb_intel_crtc_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">mdfld_crtc_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base</span> <span class="o">=</span> <span class="n">mdfld__intel_pipe_set_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">psb_intel_crtc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">psb_intel_crtc_commit</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
