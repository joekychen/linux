<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › cdv_intel_display.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cdv_intel_display.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2006-2011 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cp">#include &lt;drm/drmP.h&gt;</span>
<span class="cp">#include &quot;framebuffer.h&quot;</span>
<span class="cp">#include &quot;psb_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_reg.h&quot;</span>
<span class="cp">#include &quot;psb_intel_display.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>
<span class="cp">#include &quot;cdv_device.h&quot;</span>


<span class="k">struct</span> <span class="n">cdv_intel_range_t</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cdv_intel_p2_t</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">dot_limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p2_slow</span><span class="p">,</span> <span class="n">p2_fast</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="p">{</span>
	<span class="cm">/* given values */</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
	<span class="cm">/* derived values */</span>
	<span class="kt">int</span> <span class="n">dot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vco</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define INTEL_P2_NUM		      2</span>

<span class="k">struct</span> <span class="n">cdv_intel_limit_t</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdv_intel_range_t</span> <span class="n">dot</span><span class="p">,</span> <span class="n">vco</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdv_intel_p2_t</span> <span class="n">p2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define CDV_LIMIT_SINGLE_LVDS_96	0</span>
<span class="cp">#define CDV_LIMIT_SINGLE_LVDS_100	1</span>
<span class="cp">#define CDV_LIMIT_DAC_HDMI_27		2</span>
<span class="cp">#define CDV_LIMIT_DAC_HDMI_96		3</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cdv_intel_limit_t</span> <span class="n">cdv_intel_limits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/* CDV_SIGNLE_LVDS_96MHz */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">115500</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1800000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3600000</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">160</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">58</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">158</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">140</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">10</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">14</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* CDV_SINGLE_LVDS_100MHz */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">115500</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1800000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3600000</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">160</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">58</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">158</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">140</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">10</span><span class="p">},</span>
	 <span class="cm">/* The single-channel range is 25-112Mhz, and dual-channel</span>
<span class="cm">	  * is 80-224Mhz.  Prefer single channel as much as possible.</span>
<span class="cm">	  */</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">14</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* CDV_DAC_HDMI_27MHz */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">400000</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1809000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3564000</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">67</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">132</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">65</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">130</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">90</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">225000</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">5</span><span class="p">},</span>
	 <span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/* CDV_DAC_HDMI_96MHz */</span>
	 <span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">400000</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1800000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3600000</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">160</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">58</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">158</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">100</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">10</span><span class="p">},</span>
	 <span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">225000</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">5</span><span class="p">},</span>
	 <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define _wait_for(COND, MS, W) ({ \</span>
<span class="cp">	unsigned long timeout__ = jiffies + msecs_to_jiffies(MS);	\</span>
<span class="cp">	int ret__ = 0;							\</span>
<span class="cp">	while (!(COND)) {						\</span>
<span class="cp">		if (time_after(jiffies, timeout__)) {			\</span>
<span class="cp">			ret__ = -ETIMEDOUT;				\</span>
<span class="cp">			break;						\</span>
<span class="cp">		}							\</span>
<span class="cp">		if (W &amp;&amp; !in_dbg_master())				\</span>
<span class="cp">			msleep(W);					\</span>
<span class="cp">	}								\</span>
<span class="cp">	ret__;								\</span>
<span class="cp">})</span>

<span class="cp">#define wait_for(COND, MS) _wait_for(COND, MS, 1)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_sb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for</span><span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">SB_PCKT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SB_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SB to idle before read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">SB_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">SB_PCKT</span><span class="p">,</span>
		   <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_OPCODE_READ</span><span class="p">,</span> <span class="n">SB_OPCODE</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_DEST_DPLL</span><span class="p">,</span> <span class="n">SB_DEST</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">SET_FIELD</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">SB_BYTE_ENABLE</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for</span><span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">SB_PCKT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SB_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SB to idle after read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">SB_DATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_sb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">dpio_debug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpio_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;0x%08x: 0x%08x (before)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;0x%08x: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for</span><span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">SB_PCKT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SB_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SB to idle before write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">SB_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">SB_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">SB_PCKT</span><span class="p">,</span>
		   <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_OPCODE_WRITE</span><span class="p">,</span> <span class="n">SB_OPCODE</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_DEST_DPLL</span><span class="p">,</span> <span class="n">SB_DEST</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">SET_FIELD</span><span class="p">(</span><span class="mh">0xf</span><span class="p">,</span> <span class="n">SB_BYTE_ENABLE</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for</span><span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">SB_PCKT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SB_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SB to idle after write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpio_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;0x%08x: 0x%08x (after)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset the DPIO configuration register.  The BIOS does this at every</span>
<span class="cm"> * mode set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_sb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DPIO_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">DPIO_CFG</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DPIO_CFG</span><span class="p">,</span> <span class="n">DPIO_MODE_SELECT_0</span> <span class="o">|</span> <span class="n">DPIO_CMN_RESET_N</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Unlike most Intel display engines, on Cedarview the DPLL registers</span>
<span class="cm"> * are behind this sideband bus.  They must be programmed while the</span>
<span class="cm"> * DPLL reference clock is on in the DPLL control register, but before</span>
<span class="cm"> * the DPLL is enabled in the DPLL control register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cdv_dpll_set_clock_cdv</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_lvds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">n_vco</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dpll_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">DPLL_A</span> <span class="o">:</span> <span class="n">DPLL_B</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ref_sfr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">SB_REF_DPLLA</span> <span class="o">:</span> <span class="n">SB_REF_DPLLB</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ref_value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="n">lane_value</span><span class="p">;</span>

	<span class="n">cdv_sb_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">,</span> <span class="n">DPLL_SYNCLOCK_ENABLE</span> <span class="o">|</span> <span class="n">DPLL_VGA_MODE_DIS</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Follow the BIOS and write the REF/SFR Register. Hardcoded value */</span>
	<span class="n">ref_value</span> <span class="o">=</span> <span class="mh">0x68A701</span><span class="p">;</span>

	<span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SB_REF_SFR</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">ref_value</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t know what the other fields of these regs are, so</span>
<span class="cm">	 * leave them in place.</span>
<span class="cm">	 */</span>
	<span class="cm">/* </span>
<span class="cm">	 * The BIT 14:13 of 0x8010/0x8030 is used to select the ref clk</span>
<span class="cm">	 * for the pipe A/B. Display spec 1.06 has wrong definition.</span>
<span class="cm">	 * Correct definition is like below:</span>
<span class="cm">	 *</span>
<span class="cm">	 * refclka mean use clock from same PLL</span>
<span class="cm">	 *</span>
<span class="cm">	 * if DPLLA sets 01 and DPLLB sets 01, they use clock from their pll</span>
<span class="cm">	 *</span>
<span class="cm">	 * if DPLLA sets 01 and DPLLB sets 02, both use clk from DPLLA</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>  
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ref_sfr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ref_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ref_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">REF_CLK_MASK</span><span class="p">);</span>

	<span class="cm">/* use DPLL_A for pipeB on CRT/HDMI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;use DPLLA for pipe B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ref_value</span> <span class="o">|=</span> <span class="n">REF_CLK_DPLLA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;use their DPLL for pipe A/B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ref_value</span> <span class="o">|=</span> <span class="n">REF_CLK_DPLL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ref_sfr</span><span class="p">,</span> <span class="n">ref_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SB_M</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SB_M_DIVIDER_MASK</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">|=</span> <span class="p">((</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SB_M_DIVIDER_SHIFT</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SB_M</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SB_N_VCO</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">n_vco</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Follow the BIOS to program the N_DIVIDER REG */</span>
	<span class="n">n_vco</span> <span class="o">&amp;=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">n_vco</span> <span class="o">|=</span> <span class="mh">0x107</span><span class="p">;</span>
	<span class="n">n_vco</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SB_N_VCO_SEL_MASK</span> <span class="o">|</span>
		   <span class="n">SB_N_DIVIDER_MASK</span> <span class="o">|</span>
		   <span class="n">SB_N_CB_TUNE_MASK</span><span class="p">);</span>

	<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">((</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_DIVIDER_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">&lt;</span> <span class="mi">2250000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_CB_TUNE_SHIFT</span><span class="p">);</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_VCO_SEL_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">&lt;</span> <span class="mi">2750000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_CB_TUNE_SHIFT</span><span class="p">);</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_VCO_SEL_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">&lt;</span> <span class="mi">3300000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_CB_TUNE_SHIFT</span><span class="p">);</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_VCO_SEL_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_CB_TUNE_SHIFT</span><span class="p">);</span>
		<span class="n">n_vco</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">SB_N_VCO_SEL_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SB_N_VCO</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">n_vco</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SB_P</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SB_P2_DIVIDER_MASK</span> <span class="o">|</span> <span class="n">SB_P1_DIVIDER_MASK</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">|=</span> <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">,</span> <span class="n">SB_P1_DIVIDER</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">p</span> <span class="o">|=</span> <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_P2_5</span><span class="p">,</span> <span class="n">SB_P2_DIVIDER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">p</span> <span class="o">|=</span> <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_P2_10</span><span class="p">,</span> <span class="n">SB_P2_DIVIDER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">p</span> <span class="o">|=</span> <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_P2_14</span><span class="p">,</span> <span class="n">SB_P2_DIVIDER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">p</span> <span class="o">|=</span> <span class="n">SET_FIELD</span><span class="p">(</span><span class="n">SB_P2_7</span><span class="p">,</span> <span class="n">SB_P2_DIVIDER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Bad P2 clock: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SB_P</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lane_reg</span> <span class="o">=</span> <span class="n">PSB_LANE0</span><span class="p">;</span>
	<span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lane_value</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LANE_PLL_MASK</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">|=</span> <span class="n">LANE_PLL_ENABLE</span> <span class="o">|</span> <span class="n">LANE_PLL_PIPE</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="n">lane_value</span><span class="p">);</span>

	<span class="n">lane_reg</span> <span class="o">=</span> <span class="n">PSB_LANE1</span><span class="p">;</span>
	<span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lane_value</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LANE_PLL_MASK</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">|=</span> <span class="n">LANE_PLL_ENABLE</span> <span class="o">|</span> <span class="n">LANE_PLL_PIPE</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="n">lane_value</span><span class="p">);</span>

	<span class="n">lane_reg</span> <span class="o">=</span> <span class="n">PSB_LANE2</span><span class="p">;</span>
	<span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lane_value</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LANE_PLL_MASK</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">|=</span> <span class="n">LANE_PLL_ENABLE</span> <span class="o">|</span> <span class="n">LANE_PLL_PIPE</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="n">lane_value</span><span class="p">);</span>

	<span class="n">lane_reg</span> <span class="o">=</span> <span class="n">PSB_LANE3</span><span class="p">;</span>
	<span class="n">cdv_sb_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lane_value</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LANE_PLL_MASK</span><span class="p">);</span>
	<span class="n">lane_value</span> <span class="o">|=</span> <span class="n">LANE_PLL_ENABLE</span> <span class="o">|</span> <span class="n">LANE_PLL_PIPE</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">cdv_sb_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lane_reg</span><span class="p">,</span> <span class="n">lane_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns whether any encoder on the specified pipe is of the specified type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">cdv_intel_pipe_has_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">l_entry</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">l_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l_entry</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">&amp;&amp;</span> <span class="n">l_entry</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
					<span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">l_entry</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cdv_intel_limit_t</span> <span class="o">*</span><span class="nf">cdv_intel_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
							<span class="kt">int</span> <span class="n">refclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cdv_intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdv_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Now only single-channel LVDS is supported on CDV. If it is</span>
<span class="cm">		 * incorrect, please add the dual-channel LVDS.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">refclk</span> <span class="o">==</span> <span class="mi">96000</span><span class="p">)</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdv_intel_limits</span><span class="p">[</span><span class="n">CDV_LIMIT_SINGLE_LVDS_96</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdv_intel_limits</span><span class="p">[</span><span class="n">CDV_LIMIT_SINGLE_LVDS_100</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">refclk</span> <span class="o">==</span> <span class="mi">27000</span><span class="p">)</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdv_intel_limits</span><span class="p">[</span><span class="n">CDV_LIMIT_DAC_HDMI_27</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdv_intel_limits</span><span class="p">[</span><span class="n">CDV_LIMIT_DAC_HDMI_96</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* m1 is reserved as 0 in CDV, n is a ring counter */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">=</span> <span class="p">(</span><span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define INTELPllInvalid(s)   { </span><span class="cm">/* ErrorF (s) */</span><span class="cp">; return false; }</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">cdv_intel_PLL_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">cdv_intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;p1 out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;p out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* unnecessary to check the range of m(m1/M2)/n again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;vco out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* XXX: We may need to be checking &quot;Dot clock&quot;</span>
<span class="cm">	 * depending on the multiplier, connector, etc.,</span>
<span class="cm">	 * rather than just a single range.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;dot out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">cdv_intel_find_best_PLL</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cdv_intel_limit_t</span> <span class="o">*</span><span class="n">limit</span> <span class="o">=</span> <span class="n">cdv_intel_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">refclk</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">cdv_intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For LVDS, if the panel is on, just rely on its current</span>
<span class="cm">		 * settings for dual-channel.  We haven&#39;t figured out how to</span>
<span class="cm">		 * reliably set up different single/dual channel state, if we</span>
<span class="cm">		 * even can.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_CLKB_POWER_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">dot_limit</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">best_clock</span><span class="p">));</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* m1 is reserved as 0 in CDV, n is a ring counter.</span>
<span class="cm">	   So skip the m1 loop */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">max</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
					     <span class="n">clock</span><span class="p">.</span><span class="n">m2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
					<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
					<span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">this_err</span><span class="p">;</span>

				<span class="n">cdv_intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdv_intel_PLL_is_valid</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span>
								<span class="n">limit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>

				<span class="n">this_err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">dot</span> <span class="o">-</span> <span class="n">target</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">this_err</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">best_clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">this_err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_intel_pipe_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_framebuffer</span> <span class="o">*</span><span class="n">psbfb</span> <span class="o">=</span> <span class="n">to_psb_fb</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* no fb bound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No FB bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">psb_intel_pipe_cleaner</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* We are displaying this buffer, make sure it is actually loaded</span>
<span class="cm">	   into the GTT */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">psb_gtt_pin</span><span class="p">(</span><span class="n">psbfb</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">psb_intel_pipe_set_base_exit</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">psbfb</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PIXFORMAT_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_8BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_15_16BPP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown color depth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">psb_intel_pipe_set_base_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Writing base %08lX %08lX %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">surf</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">surf</span><span class="p">);</span>

<span class="nl">psb_intel_pipe_cleaner:</span>
	<span class="cm">/* If there was a previous display we can now unpin it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_fb</span><span class="p">)</span>
		<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">to_psb_fb</span><span class="p">(</span><span class="n">old_fb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gtt</span><span class="p">);</span>

<span class="nl">psb_intel_pipe_set_base_exit:</span>
	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define		FIFO_PIPEA		(1 &lt;&lt; 0)</span>
<span class="cp">#define		FIFO_PIPEB		(1 &lt;&lt; 1)</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">cdv_intel_pipe_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">cdv_intel_single_pipe_active</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">pipe_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdv_intel_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pipe_enabled</span> <span class="o">|=</span> <span class="n">FIFO_PIPEA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdv_intel_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">pipe_enabled</span> <span class="o">|=</span> <span class="n">FIFO_PIPEB</span><span class="p">;</span>


	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;pipe enabled %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe_enabled</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_enabled</span> <span class="o">==</span> <span class="n">FIFO_PIPEA</span> <span class="o">||</span> <span class="n">pipe_enabled</span> <span class="o">==</span> <span class="n">FIFO_PIPEB</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_pipeb_lvds</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
					<span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span>
		    <span class="o">||</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_disable_self_refresh</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FW_BLC_SELF_EN</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Disable self-refresh before adjust WM */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FW_BLC_SELF_EN</span><span class="p">));</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">);</span>

		<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Cedarview workaround to write ovelay plane, which force to leave</span>
<span class="cm">		 * MAX_FIFO state.</span>
<span class="cm">		 */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">OV_OVADD</span><span class="p">,</span> <span class="mi">0</span><span class="cm">/*dev_priv-&gt;ovl_offset*/</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">OV_OVADD</span><span class="p">);</span>

		<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_update_watermark</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdv_intel_single_pipe_active</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fw</span><span class="p">;</span>

		<span class="n">fw</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">);</span>
		<span class="n">fw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_FIFO_SR_WM_MASK</span><span class="p">;</span>
		<span class="n">fw</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x7e</span> <span class="o">&lt;&lt;</span> <span class="n">DSP_FIFO_SR_WM_SHIFT</span><span class="p">);</span>
		<span class="n">fw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CURSOR_B_FIFO_WM_MASK</span><span class="p">;</span>
		<span class="n">fw</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x4</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_B_FIFO_WM_SHIFT</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>

		<span class="n">fw</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">);</span>
		<span class="n">fw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CURSOR_A_FIFO_WM_MASK</span><span class="p">;</span>
		<span class="n">fw</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x6</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_A_FIFO_WM_SHIFT</span><span class="p">);</span>
		<span class="n">fw</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSP_PLANE_C_FIFO_WM_MASK</span><span class="p">;</span>
		<span class="n">fw</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x8</span> <span class="o">&lt;&lt;</span> <span class="n">DSP_PLANE_C_FIFO_WM_SHIFT</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="mh">0x36000000</span><span class="p">);</span>

		<span class="cm">/* ignore FW4 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_pipeb_lvds</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW5</span><span class="p">,</span> <span class="mh">0x00040330</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fw</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">DSP_PLANE_B_FIFO_WM1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">DSP_PLANE_A_FIFO_WM1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_B_FIFO_WM1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			     <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_FIFO_SR_WM1_SHIFT</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW5</span><span class="p">,</span> <span class="n">fw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW6</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

		<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* enable self-refresh for single pipe active */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span> <span class="n">FW_BLC_SELF_EN</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">);</span>
		<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* HW team suggested values... */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">,</span> <span class="mh">0x3f880808</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">,</span> <span class="mh">0x0b020202</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="mh">0x24000000</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW4</span><span class="p">,</span> <span class="mh">0x08030202</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW5</span><span class="p">,</span> <span class="mh">0x01010101</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPFW6</span><span class="p">,</span> <span class="mh">0x1d0</span><span class="p">);</span>

		<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">cdv_intel_disable_self_refresh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/** Loads the palette/gamma unit for the CRTC with the prepared values */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_load_lut</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">palreg</span> <span class="o">=</span> <span class="n">PALETTE_A</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* The clocks have to be on to load the palette. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">palreg</span> <span class="o">=</span> <span class="n">PALETTE_B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">palreg</span> <span class="o">=</span> <span class="n">PALETTE_C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Illegal Pipe Number.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">palreg</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">((</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
				  <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_adj</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets the power management mode of the pipe and plane.</span>
<span class="cm"> *</span>
<span class="cm"> * This code should probably grow support for turning the cursor off and back</span>
<span class="cm"> * on appropriately at the same time as we&#39;re turning the pipe off/on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* XXX: When our outputs are all unaware of DPMS modes other than off</span>
<span class="cm">	 * and on, we should map those modes to DRM_MODE_DPMS_OFF in the CRTC.</span>
<span class="cm">	 */</span>
	<span class="n">cdv_intel_disable_self_refresh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/* Enable the DPLL */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
			<span class="cm">/* Wait for the clocks to stabilize. */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Jim Bish - switch plan and pipe per scott */</span>
		<span class="cm">/* Enable the plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				  <span class="n">temp</span> <span class="o">|</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

		<span class="cm">/* Enable the pipe */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPE_FIFO_UNDERRUN</span><span class="p">;</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">cdv_intel_update_watermark</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="n">cdv_intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

		<span class="cm">/* Give the overlay scaler a chance to enable</span>
<span class="cm">		 * if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, true); TODO */</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Give the overlay scaler a chance to disable</span>
<span class="cm">		 * if it&#39;s on this pipe */</span>
		<span class="cm">/* psb_intel_crtc_dpms_video(crtc, FALSE); TODO */</span>

		<span class="cm">/* Disable the VGA plane that we never use */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">VGACNTRL</span><span class="p">,</span> <span class="n">VGA_DISP_DISABLE</span><span class="p">);</span>

		<span class="cm">/* Jim Bish - changed pipe/plane here as well. */</span>

		<span class="n">drm_vblank_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="cm">/* Wait for vblank for the disable to take effect */</span>
		<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Next, disable display pipes */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIPEACONF_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for vblank for the disable to take effect. */</span>
		<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

		<span class="cm">/* Disable display plane */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span>
				  <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
			<span class="cm">/* Flush the plane changes */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
			<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for the clocks to turn off. */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
		<span class="n">cdv_intel_update_watermark</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*Set FIFO Watermarks*/</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">DSPARB</span><span class="p">,</span> <span class="mh">0x3F3E</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">cdv_intel_crtc_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Return the pipe currently connected to the panel fitter,</span>
<span class="cm"> * or -1 if the panel fitter is not present or not in use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_intel_panel_fitter_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pfit_control</span><span class="p">;</span>

	<span class="n">pfit_control</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">);</span>

	<span class="cm">/* See if the panel fitter is in use */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pfit_control</span> <span class="o">&amp;</span> <span class="n">PFIT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pfit_control</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_intel_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">refclk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ok</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_crt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_tv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_hdmi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
					<span class="n">psb_intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span>
		    <span class="o">||</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_LVDS</span>:
			<span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_TVOUT</span>:
			<span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_ANALOG</span>:
			<span class="n">is_crt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_HDMI</span>:
			<span class="n">is_hdmi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dplla_96mhz</span><span class="p">)</span>
		<span class="cm">/* low-end sku, 96/100 mhz */</span>
		<span class="n">refclk</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* high-end sku, 27/100 mhz */</span>
		<span class="n">refclk</span> <span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_use_ssc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">refclk</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_ssc_freq</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Use SSC reference clock %d Mhz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_ssc_freq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="n">ok</span> <span class="o">=</span> <span class="n">cdv_intel_find_best_PLL</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t find PLL settings for mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dpll</span> <span class="o">=</span> <span class="n">DPLL_VGA_MODE_DIS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* XXX: just matching BIOS for now */</span>
<span class="cm">/*	dpll |= PLL_REF_INPUT_TVCLKINBC; */</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*		dpll |= PLL_REF_INPUT_DREFCLK; */</span>

	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_SYNCLOCK_ENABLE</span><span class="p">;</span>
<span class="cm">/*	if (is_lvds)</span>
<span class="cm">		dpll |= DPLLB_MODE_LVDS;</span>
<span class="cm">	else</span>
<span class="cm">		dpll |= DPLLB_MODE_DAC_SERIAL; */</span>
	<span class="cm">/* dpll |= (2 &lt;&lt; 11); */</span>

	<span class="cm">/* setup pipeconf */</span>
	<span class="n">pipeconf</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

	<span class="cm">/* Set up the display plane register */</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">DISPPLANE_GAMMA_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_SEL_PIPE_A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_SEL_PIPE_B</span><span class="p">;</span>

	<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">;</span>
	<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPEACONF_ENABLE</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">dpll</span> <span class="o">|</span> <span class="n">DPLL_VGA_MODE_DIS</span> <span class="o">|</span> <span class="n">DPLL_SYNCLOCK_ENABLE</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>

	<span class="n">cdv_dpll_set_clock_cdv</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span> <span class="n">is_lvds</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>


	<span class="cm">/* The LVDS pin pair needs to be on before the DPLLs are enabled.</span>
<span class="cm">	 * This is an exception to the general rule that mode_set doesn&#39;t turn</span>
<span class="cm">	 * things on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">lvds</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">);</span>

		<span class="n">lvds</span> <span class="o">|=</span>
		    <span class="n">LVDS_PORT_EN</span> <span class="o">|</span> <span class="n">LVDS_A0A2_CLKA_POWER_UP</span> <span class="o">|</span>
		    <span class="n">LVDS_PIPEB_SELECT</span><span class="p">;</span>
		<span class="cm">/* Set the B0-B3 data pairs corresponding to</span>
<span class="cm">		 * whether we&#39;re going to</span>
<span class="cm">		 * set the DPLLs for dual-channel mode or not.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">lvds</span> <span class="o">|=</span> <span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lvds</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">);</span>

		<span class="cm">/* It would be nice to set 24 vs 18-bit mode (LVDS_A3_POWER_UP)</span>
<span class="cm">		 * appropriately here, but we need to look more</span>
<span class="cm">		 * thoroughly into how panels behave in the two modes.</span>
<span class="cm">		 */</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">LVDS</span><span class="p">,</span> <span class="n">lvds</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>

	<span class="cm">/* Disable the panel fitter if it was on our pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdv_intel_panel_fitter_pipe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">pipe</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Mode for pipe %c:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span> <span class="o">:</span> <span class="sc">&#39;B&#39;</span><span class="p">);</span>
	<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span>
		<span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_LOCK</span><span class="p">)</span> <span class="o">|</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="cm">/* Wait for the clocks to stabilize. */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span> <span class="cm">/* 42 usec w/o calibration, 110 with.  rounded up. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPLL_LOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get DPLL lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">sdvo_pixel_multiply</span> <span class="o">=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">/</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll_md</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_MD_UDI_DIVIDER_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">sdvo_pixel_multiply</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_MD_UDI_MULTIPLIER_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="cm">/* pipesrc and dspsize control the size that is scaled from,</span>
<span class="cm">	 * which should always be the user&#39;s requested size.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>

	<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="cm">/* Flush the plane changes */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span>
		    <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Save HW states of giving crtc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc_state</span> <span class="o">*</span><span class="n">crtc_state</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">paletteReg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No CRTC state found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPCNTR</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPECONF</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPESRC</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP0</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP1</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHTOTAL</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHBLANK</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHSYNC</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVTOTAL</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVBLANK</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVSYNC</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSTRIDE</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">);</span>

	<span class="cm">/*NOTE: DSPSIZE DSPPOS only for psb*/</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSIZE</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPPOS</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;(%x %x %x %x %x %x %x %x %x %x %x %x %x %x %x %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPCNTR</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPECONF</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPESRC</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP0</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP1</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHTOTAL</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHBLANK</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHSYNC</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVTOTAL</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVBLANK</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVSYNC</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSTRIDE</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSIZE</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPPOS</span><span class="p">,</span>
			<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span>
		<span class="p">);</span>

	<span class="n">paletteReg</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePalette</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">paletteReg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Restore HW states of giving crtc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span>  <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc_state</span> <span class="o">*</span><span class="n">crtc_state</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">paletteReg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No crtc state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span>
		<span class="s">&quot;current:(%x %x %x %x %x %x %x %x %x %x %x %x %x %x %x %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
	<span class="p">);</span>

	<span class="n">DRM_DEBUG</span><span class="p">(</span>
		<span class="s">&quot;saved: (%x %x %x %x %x %x %x %x %x %x %x %x %x %x %x %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPCNTR</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPECONF</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPESRC</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP0</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP1</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHTOTAL</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHBLANK</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHSYNC</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVTOTAL</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVBLANK</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVSYNC</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSTRIDE</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSIZE</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPPOS</span><span class="p">,</span>
		<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span>
	<span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span>
				<span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;write dpll: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP0</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveFP1</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDPLL</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHTOTAL</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHBLANK</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveHSYNC</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVTOTAL</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVBLANK</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveVSYNC</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stride</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSTRIDE</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPSIZE</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPPOS</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPESRC</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePIPECONF</span><span class="p">);</span>

	<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">cntr</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPCNTR</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">saveDSPBASE</span><span class="p">);</span>

	<span class="n">cdv_intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">paletteReg</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">paletteReg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">crtc_state</span><span class="o">-&gt;</span><span class="n">savePalette</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_intel_crtc_cursor_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">width</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">control</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURACNTR</span> <span class="o">:</span> <span class="n">CURBCNTR</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURABASE</span> <span class="o">:</span> <span class="n">CURBBASE</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gtt_range</span> <span class="o">*</span><span class="n">gt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* if we want to turn of the cursor ignore width and height */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* turn off the cursor */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">CURSOR_MODE_DISABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* unpin the old GEM object */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>
			<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">gt</span><span class="p">);</span>
			<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">);</span>
			<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Currently we only support 64x64 cursors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">!=</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">height</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;we currently only support 64x64 cursors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;buffer is to small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>

	<span class="cm">/* Pin the memory into the GTT */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">psb_gtt_pin</span><span class="p">(</span><span class="n">gt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Can not pin down handle 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">gt</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>	<span class="cm">/* Or resource.start ??? */</span>

	<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* set the pipe for the cursor */</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_64_ARGB_AX</span> <span class="o">|</span> <span class="n">MCURSOR_GAMMA_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* unpin the old GEM object */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gt</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">gtt_range</span><span class="p">,</span> <span class="n">gem</span><span class="p">);</span>
		<span class="n">psb_gtt_unpin</span><span class="p">(</span><span class="n">gt</span><span class="p">);</span>
		<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span><span class="p">);</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_intel_crtc_cursor_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">adder</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CURSOR_POS_SIGN</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_X_SHIFT</span><span class="p">);</span>
		<span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CURSOR_POS_SIGN</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_Y_SHIFT</span><span class="p">);</span>
		<span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">CURSOR_POS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_X_SHIFT</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">CURSOR_POS_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_Y_SHIFT</span><span class="p">);</span>

	<span class="n">adder</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">((</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURAPOS</span> <span class="o">:</span> <span class="n">CURBPOS</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">((</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CURABASE</span> <span class="o">:</span> <span class="n">CURBBASE</span><span class="p">,</span> <span class="n">adder</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">start</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cdv_intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_crtc_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rpm_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">(</span><span class="n">set</span><span class="p">);</span>

	<span class="n">pm_runtime_forbid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">(</span><span class="n">set</span><span class="p">);</span>

	<span class="n">pm_runtime_allow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Derive the pixel clock for the given refclk and divisors for 8xx chips. */</span>

<span class="cm">/* FIXME: why are we using this, should it be cdv_ in this tree ? */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">=</span> <span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns the clock of the currently programmed mode of the given pipe. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdv_intel_crtc_clock_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dpll</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdv_intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_lvds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_pipe</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pipe</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">);</span>
		<span class="n">is_lvds</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dpll</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fp0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">fp1</span><span class="p">;</span>

		<span class="n">is_lvds</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">psb</span><span class="p">.</span><span class="n">saveLVDS</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_M1_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M1_DIV_SHIFT</span><span class="p">;</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_M2_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIV_SHIFT</span><span class="p">;</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_N_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIV_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span>
		    <span class="n">ffs</span><span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span>
			 <span class="n">DPLL_FPA01_P1_POST_DIV_MASK_I830_LVDS</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PLL %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_REF_INPUT_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">PLLB_REF_INPUT_SPREADSPECTRUMIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* XXX: might not be 66MHz */</span>
			<span class="n">i8xx_clock</span><span class="p">(</span><span class="mi">66000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">i8xx_clock</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_P1_DIVIDE_BY_TWO</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span>
			      <span class="n">DPLL_FPA01_P1_POST_DIV_MASK_I830</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			     <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_P2_DIVIDE_BY_4</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">i8xx_clock</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* XXX: It would be nice to validate the clocks, but we can&#39;t reuse</span>
<span class="cm">	 * i830PllIsValid() because it relies on the xf86_config connector</span>
<span class="cm">	 * configuration being accurate, which it isn&#39;t necessarily.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">clock</span><span class="p">.</span><span class="n">dot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Returns the currently programmed mode of the given pipe. */</span>
<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="nf">cdv_intel_crtc_mode_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_pipe</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pipe</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">psb_offset</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">htot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vtot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vsync</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">htot</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
		<span class="n">hsync</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">);</span>
		<span class="n">vtot</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
		<span class="n">vsync</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">);</span>
		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">htot</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">;</span>
		<span class="n">hsync</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hsync</span><span class="p">;</span>
		<span class="n">vtot</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
		<span class="n">vsync</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_clock_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">htot</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="p">((</span><span class="n">htot</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsync</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">hsync</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">vtot</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="p">((</span><span class="n">vtot</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsync</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">vsync</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">drm_mode_set_name</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdv_intel_crtc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_crtc</span> <span class="o">*</span><span class="n">psb_intel_crtc</span> <span class="o">=</span> <span class="n">to_psb_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="o">-&gt;</span><span class="n">crtc_state</span><span class="p">);</span>
	<span class="n">drm_crtc_cleanup</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psb_intel_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="n">cdv_intel_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base</span> <span class="o">=</span> <span class="n">cdv_intel_pipe_set_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_funcs</span> <span class="n">cdv_intel_crtc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_save</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_restore</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_set</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_cursor_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_move</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_cursor_move</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gamma_set</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_gamma_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_config</span> <span class="o">=</span> <span class="n">cdv_crtc_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">cdv_intel_crtc_destroy</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
