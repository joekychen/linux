<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › tc35876x-dsi-lvds.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tc35876x-dsi-lvds.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2011 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __MDFLD_DSI_LVDS_BRIDGE_H__</span>
<span class="cp">#define __MDFLD_DSI_LVDS_BRIDGE_H__</span>

<span class="kt">void</span> <span class="n">tc35876x_set_bridge_reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">tc35876x_configure_lvds_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">tc35876x_brightness_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">tc35876x_toshiba_bridge_panel_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">tc35876x_toshiba_bridge_panel_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">tc35876x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">tc35876x_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">panel_funcs</span> <span class="n">mdfld_tc35876x_funcs</span><span class="p">;</span>

<span class="cp">#endif </span><span class="cm">/*__MDFLD_DSI_LVDS_BRIDGE_H__*/</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
PI_D3S_CLRSIPOCOUNT	0x0170</span>
<span class="cp">#define CLS_PRE			0x0180</span>
<span class="cp">#define D0S_PRE			0x0184</span>
<span class="cp">#define D1S_PRE			0x0188</span>
<span class="cp">#define D2S_PRE			0x018C</span>
<span class="cp">#define D3S_PRE			0x0190</span>
<span class="cp">#define CLS_PREP		0x01A0</span>
<span class="cp">#define D0S_PREP		0x01A4</span>
<span class="cp">#define D1S_PREP		0x01A8</span>
<span class="cp">#define D2S_PREP		0x01AC</span>
<span class="cp">#define D3S_PREP		0x01B0</span>
<span class="cp">#define CLS_ZERO		0x01C0</span>
<span class="cp">#define D0S_ZERO		0x01C4</span>
<span class="cp">#define D1S_ZERO		0x01C8</span>
<span class="cp">#define D2S_ZERO		0x01CC</span>
<span class="cp">#define D3S_ZERO		0x01D0</span>
<span class="cp">#define PPI_CLRFLG		0x01E0</span>
<span class="cp">#define PPI_CLRSIPO		0x01E4</span>
<span class="cp">#define HSTIMEOUT		0x01F0</span>
<span class="cp">#define HSTIMEOUTENABLE		0x01F4</span>

<span class="cm">/* DSI Protocol Layer Registers */</span>
<span class="cp">#define DSI_STARTDSI		0x0204</span>
<span class="cp">#define DSI_BUSYDSI		0x0208</span>
<span class="cp">#define DSI_LANEENABLE		0x0210</span>
<span class="cp">#define DSI_LANESTATUS0		0x0214</span>
<span class="cp">#define DSI_LANESTATUS1		0x0218</span>
<span class="cp">#define DSI_INTSTATUS		0x0220</span>
<span class="cp">#define DSI_INTMASK		0x0224</span>
<span class="cp">#define DSI_INTCLR		0x0228</span>
<span class="cp">#define DSI_LPTXTO		0x0230</span>

<span class="cm">/* DSI General Registers */</span>
<span class="cp">#define DSIERRCNT		0x0300</span>

<span class="cm">/* DSI Application Layer Registers */</span>
<span class="cp">#define APLCTRL			0x0400</span>
<span class="cp">#define RDPKTLN			0x0404</span>

<span class="cm">/* Video Path Registers */</span>
<span class="cp">#define VPCTRL			0x0450</span>
<span class="cp">#define HTIM1			0x0454</span>
<span class="cp">#define HTIM2			0x0458</span>
<span class="cp">#define VTIM1			0x045C</span>
<span class="cp">#define VTIM2			0x0460</span>
<span class="cp">#define VFUEN			0x0464</span>

<span class="cm">/* LVDS Registers */</span>
<span class="cp">#define LVMX0003		0x0480</span>
<span class="cp">#define LVMX0407		0x0484</span>
<span class="cp">#define LVMX0811		0x0488</span>
<span class="cp">#define LVMX1215		0x048C</span>
<span class="cp">#define LVMX1619		0x0490</span>
<span class="cp">#define LVMX2023		0x0494</span>
<span class="cp">#define LVMX2427		0x0498</span>
<span class="cp">#define LVCFG			0x049C</span>
<span class="cp">#define LVPHY0			0x04A0</span>
<span class="cp">#define LVPHY1			0x04A4</span>

<span class="cm">/* System Registers */</span>
<span class="cp">#define SYSSTAT			0x0500</span>
<span class="cp">#define SYSRST			0x0504</span>

<span class="cm">/* GPIO Registers */</span>
<span class="cm">/*#define GPIOC			0x0520*/</span>
<span class="cp">#define GPIOO			0x0524</span>
<span class="cp">#define GPIOI			0x0528</span>

<span class="cm">/* I2C Registers */</span>
<span class="cp">#define I2CTIMCTRL		0x0540</span>
<span class="cp">#define I2CMADDR		0x0544</span>
<span class="cp">#define WDATAQ			0x0548</span>
<span class="cp">#define RDATAQ			0x054C</span>

<span class="cm">/* Chip/Rev Registers */</span>
<span class="cp">#define IDREG			0x0580</span>

<span class="cm">/* Debug Registers */</span>
<span class="cp">#define DEBUG00			0x05A0</span>
<span class="cp">#define DEBUG01			0x05A4</span>

<span class="cm">/* Panel CABC registers */</span>
<span class="cp">#define PANEL_PWM_CONTROL	0x90</span>
<span class="cp">#define PANEL_FREQ_DIVIDER_HI	0x91</span>
<span class="cp">#define PANEL_FREQ_DIVIDER_LO	0x92</span>
<span class="cp">#define PANEL_DUTY_CONTROL	0x93</span>
<span class="cp">#define PANEL_MODIFY_RGB	0x94</span>
<span class="cp">#define PANEL_FRAMERATE_CONTROL	0x96</span>
<span class="cp">#define PANEL_PWM_MIN		0x97</span>
<span class="cp">#define PANEL_PWM_REF		0x98</span>
<span class="cp">#define PANEL_PWM_MAX		0x99</span>
<span class="cp">#define PANEL_ALLOW_DISTORT	0x9A</span>
<span class="cp">#define PANEL_BYPASS_PWMI	0x9B</span>

<span class="cm">/* Panel color management registers */</span>
<span class="cp">#define PANEL_CM_ENABLE		0x700</span>
<span class="cp">#define PANEL_CM_HUE		0x701</span>
<span class="cp">#define PANEL_CM_SATURATION	0x702</span>
<span class="cp">#define PANEL_CM_INTENSITY	0x703</span>
<span class="cp">#define PANEL_CM_BRIGHTNESS	0x704</span>
<span class="cp">#define PANEL_CM_CE_ENABLE	0x705</span>
<span class="cp">#define PANEL_CM_PEAK_EN	0x710</span>
<span class="cp">#define PANEL_CM_GAIN		0x711</span>
<span class="cp">#define PANEL_CM_HUETABLE_START	0x730</span>
<span class="cp">#define PANEL_CM_HUETABLE_END	0x747 </span><span class="cm">/* inclusive */</span><span class="cp"></span>

<span class="cm">/* Input muxing for registers LVMX0003...LVMX2427 */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">INPUT_R0</span><span class="p">,</span>	<span class="cm">/* 0 */</span>
	<span class="n">INPUT_R1</span><span class="p">,</span>
	<span class="n">INPUT_R2</span><span class="p">,</span>
	<span class="n">INPUT_R3</span><span class="p">,</span>
	<span class="n">INPUT_R4</span><span class="p">,</span>
	<span class="n">INPUT_R5</span><span class="p">,</span>
	<span class="n">INPUT_R6</span><span class="p">,</span>
	<span class="n">INPUT_R7</span><span class="p">,</span>
	<span class="n">INPUT_G0</span><span class="p">,</span>	<span class="cm">/* 8 */</span>
	<span class="n">INPUT_G1</span><span class="p">,</span>
	<span class="n">INPUT_G2</span><span class="p">,</span>
	<span class="n">INPUT_G3</span><span class="p">,</span>
	<span class="n">INPUT_G4</span><span class="p">,</span>
	<span class="n">INPUT_G5</span><span class="p">,</span>
	<span class="n">INPUT_G6</span><span class="p">,</span>
	<span class="n">INPUT_G7</span><span class="p">,</span>
	<span class="n">INPUT_B0</span><span class="p">,</span>	<span class="cm">/* 16 */</span>
	<span class="n">INPUT_B1</span><span class="p">,</span>
	<span class="n">INPUT_B2</span><span class="p">,</span>
	<span class="n">INPUT_B3</span><span class="p">,</span>
	<span class="n">INPUT_B4</span><span class="p">,</span>
	<span class="n">INPUT_B5</span><span class="p">,</span>
	<span class="n">INPUT_B6</span><span class="p">,</span>
	<span class="n">INPUT_B7</span><span class="p">,</span>
	<span class="n">INPUT_HSYNC</span><span class="p">,</span>	<span class="cm">/* 24 */</span>
	<span class="n">INPUT_VSYNC</span><span class="p">,</span>
	<span class="n">INPUT_DE</span><span class="p">,</span>
	<span class="n">LOGIC_0</span><span class="p">,</span>
	<span class="cm">/* 28...31 undefined */</span>
<span class="p">};</span>

<span class="cp">#define INPUT_MUX(lvmx03, lvmx02, lvmx01, lvmx00)		\</span>
<span class="cp">	(FLD_VAL(lvmx03, 29, 24) | FLD_VAL(lvmx02, 20, 16) |	\</span>
<span class="cp">	FLD_VAL(lvmx01, 12, 8) | FLD_VAL(lvmx00, 4, 0))</span>

<span class="cm">/**</span>
<span class="cm"> * tc35876x_regw - Write DSI-LVDS bridge register using I2C</span>
<span class="cm"> * @client: struct i2c_client to use</span>
<span class="cm"> * @reg: register address</span>
<span class="cm"> * @value: value to write</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or a negative error value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35876x_regw</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* NOTE: Register address big-endian, data little-endian. */</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tx_data</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msgs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reg 0x%04x val 0x%08x error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msgs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reg 0x%04x val 0x%08x msgs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reg 0x%04x val 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * tc35876x_regr - Read DSI-LVDS bridge register using I2C</span>
<span class="cm"> * @client: struct i2c_client to use</span>
<span class="cm"> * @reg: register address</span>
<span class="cm"> * @value: pointer for storing the value</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, or a negative error value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35876x_regr</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">rx_data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tx_data</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rx_data</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rx_data</span><span class="p">),</span>
		 <span class="p">},</span>
	<span class="p">};</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msgs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reg 0x%04x error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msgs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reg 0x%04x msgs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">rx_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">rx_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="n">rx_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">rx_data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reg 0x%04x value 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tc35876x_set_bridge_reset_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35876x_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">tc35876x_client</span><span class="p">,</span> <span class="s">&quot;%s called before probe&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Pull MIPI Bridge reset pin to Low */</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="cm">/* Pull MIPI Bridge reset pin to High */</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tc35876x_configure_lvds_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">tc35876x_client</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ppi_lptxtimecnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txtagocnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txtasurecnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">tc35876x_client</span><span class="p">,</span> <span class="s">&quot;%s called before probe&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc35876x_regr</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">IDREG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">))</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tc35876x ID 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot read ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ppi_lptxtimecnt</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">txtagocnt</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">ppi_lptxtimecnt</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">txtasurecnt</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ppi_lptxtimecnt</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_TX_RX_TA</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">txtagocnt</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FLD_VAL</span><span class="p">(</span><span class="n">txtasurecnt</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_LPTXTIMECNT</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="n">ppi_lptxtimecnt</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_D0S_CLRSIPOCOUNT</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_D1S_CLRSIPOCOUNT</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_D2S_CLRSIPOCOUNT</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_D3S_CLRSIPOCOUNT</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Enabling MIPI &amp; PPI lanes, Enable 4 lanes */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_LANEENABLE</span><span class="p">,</span>
		<span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">DSI_LANEENABLE</span><span class="p">,</span>
		<span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">PPI_STARTPPI</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">DSI_STARTDSI</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Setting LVDS output frequency */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVPHY0</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span> <span class="cm">/* 0x00048006 */</span>

	<span class="cm">/* Setting video panel control register,0x00000120 VTGen=ON ?!?!? */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">VPCTRL</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>

	<span class="cm">/* Horizontal back porch and horizontal pulse width. 0x00280028 */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">HTIM1</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Horizontal front porch and horizontal active video size. 0x00500500*/</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">HTIM2</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Vertical back porch and vertical sync pulse width. 0x000e000a */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">VTIM1</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Vertical front porch and vertical display size. 0x000e0320 */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">VTIM2</span><span class="p">,</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_VAL</span><span class="p">(</span><span class="mi">800</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Set above HTIM1, HTIM2, VTIM1, and VTIM2 at next VSYNC. */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">VFUEN</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Soft reset LCD controller. */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">SYSRST</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* LVDS-TX input muxing */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVMX0003</span><span class="p">,</span>
		<span class="n">INPUT_MUX</span><span class="p">(</span><span class="n">INPUT_R5</span><span class="p">,</span> <span class="n">INPUT_R4</span><span class="p">,</span> <span class="n">INPUT_R3</span><span class="p">,</span> <span class="n">INPUT_R2</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVMX0407</span><span class="p">,</span>
		<span class="n">INPUT_MUX</span><span class="p">(</span><span class="n">INPUT_G2</span><span class="p">,</span> <span class="n">INPUT_R7</span><span class="p">,</span> <span class="n">INPUT_R1</span><span class="p">,</span> <span class="n">INPUT_R6</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVMX0811</span><span class="p">,</span>
		<span class="n">INPUT_MUX</span><span class="p">(</span><span class="n">INPUT_G1</span><span class="p">,</span> <span class="n">INPUT_G0</span><span class="p">,</span> <span class="n">INPUT_G4</span><span class="p">,</span> <span class="n">INPUT_G3</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVMX1215</span><span class="p">,</span>
		<span class="n">INPUT_MUX</span><span class="p">(</span><span class="n">INPUT_B2</span><span class="p">,</span> <span class="n">INPUT_G7</span><span class="p">,</span> <span class="n">INPUT_G6</span><span class="p">,</span> <span class="n">INPUT_G5</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVMX1619</span><span class="p">,</span>
		<span class="n">INPUT_MUX</span><span class="p">(</span><span class="n">INPUT_B4</span><span class="p">,</span> <span class="n">INPUT_B3</span><span class="p">,</span> <span class="n">INPUT_B1</span><span class="p">,</span> <span class="n">INPUT_B0</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVMX2023</span><span class="p">,</span>
		<span class="n">INPUT_MUX</span><span class="p">(</span><span class="n">LOGIC_0</span><span class="p">,</span>  <span class="n">INPUT_B7</span><span class="p">,</span> <span class="n">INPUT_B6</span><span class="p">,</span> <span class="n">INPUT_B5</span><span class="p">));</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVMX2427</span><span class="p">,</span>
		<span class="n">INPUT_MUX</span><span class="p">(</span><span class="n">INPUT_R0</span><span class="p">,</span> <span class="n">INPUT_DE</span><span class="p">,</span> <span class="n">INPUT_VSYNC</span><span class="p">,</span> <span class="n">INPUT_HSYNC</span><span class="p">));</span>

	<span class="cm">/* Enable LVDS transmitter. */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">LVCFG</span><span class="p">,</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Clear notifications. Don&#39;t write reserved bits. Was write 0xffffffff</span>
<span class="cm">	 * to 0x0288, must be in error?! */</span>
	<span class="n">tc35876x_regw</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">DSI_INTCLR</span><span class="p">,</span> <span class="n">FLD_MASK</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="n">FLD_MASK</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define GPIOPWMCTRL	0x38F</span>
<span class="cp">#define PWM0CLKDIV0	0x62 </span><span class="cm">/* low byte */</span><span class="cp"></span>
<span class="cp">#define PWM0CLKDIV1	0x61 </span><span class="cm">/* high byte */</span><span class="cp"></span>

<span class="cp">#define SYSTEMCLK	19200000UL </span><span class="cm">/* 19.2 MHz */</span><span class="cp"></span>
<span class="cp">#define PWM_FREQUENCY	9600 </span><span class="cm">/* Hz */</span><span class="cp"></span>

<span class="cm">/* f = baseclk / (clkdiv + 1) =&gt; clkdiv = (baseclk - f) / f */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">calc_clkdiv</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">baseclk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">baseclk</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tc35876x_brightness_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pwmctrl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">clkdiv</span><span class="p">;</span>

	<span class="cm">/* Make sure the PWM reference is the 19.2 MHz system clock. Read first</span>
<span class="cm">	 * instead of setting directly to catch potential conflicts between PWM</span>
<span class="cm">	 * users. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_scu_ipc_ioread8</span><span class="p">(</span><span class="n">GPIOPWMCTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwmctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">pwmctrl</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIOPWMCTRL read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIOPWMCTRL was not set to system clock (pwmctrl = 0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pwmctrl</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_scu_ipc_iowrite8</span><span class="p">(</span><span class="n">GPIOPWMCTRL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPIOPWMCTRL set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clkdiv</span> <span class="o">=</span> <span class="n">calc_clkdiv</span><span class="p">(</span><span class="n">SYSTEMCLK</span><span class="p">,</span> <span class="n">PWM_FREQUENCY</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_scu_ipc_iowrite8</span><span class="p">(</span><span class="n">PWM0CLKDIV1</span><span class="p">,</span> <span class="p">(</span><span class="n">clkdiv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_scu_ipc_iowrite8</span><span class="p">(</span><span class="n">PWM0CLKDIV0</span><span class="p">,</span> <span class="n">clkdiv</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PWM0CLKDIV set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PWM0CLKDIV set to 0x%04x (%d Hz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">clkdiv</span><span class="p">,</span> <span class="n">PWM_FREQUENCY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PWM0DUTYCYCLE			0x67</span>

<span class="kt">void</span> <span class="nf">tc35876x_brightness_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">duty_val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">panel_duty_val</span><span class="p">;</span>

	<span class="n">level</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MDFLD_DSI_BRIGHTNESS_MAX_LEVEL</span><span class="p">);</span>

	<span class="cm">/* PWM duty cycle 0x00...0x63 corresponds to 0...99% */</span>
	<span class="n">duty_val</span> <span class="o">=</span> <span class="n">level</span> <span class="o">*</span> <span class="mh">0x63</span> <span class="o">/</span> <span class="n">MDFLD_DSI_BRIGHTNESS_MAX_LEVEL</span><span class="p">;</span>

	<span class="cm">/* I won&#39;t pretend to understand this formula. The panel spec is quite</span>
<span class="cm">	 * bad engrish.</span>
<span class="cm">	 */</span>
	<span class="n">panel_duty_val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0xA9</span> <span class="o">/</span>
			 <span class="n">MDFLD_DSI_BRIGHTNESS_MAX_LEVEL</span> <span class="o">+</span> <span class="mh">0x56</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_scu_ipc_iowrite8</span><span class="p">(</span><span class="n">PWM0DUTYCYCLE</span><span class="p">,</span> <span class="n">duty_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ipc write fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmi_lcd_i2c_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">cmi_lcd_i2c_client</span><span class="p">,</span>
						<span class="n">PANEL_PWM_MAX</span><span class="p">,</span> <span class="n">panel_duty_val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi_lcd_i2c_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: i2c write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tc35876x_toshiba_bridge_panel_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35876x_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">tc35876x_client</span><span class="p">,</span> <span class="s">&quot;%s called before probe&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tc35876x_toshiba_bridge_panel_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35876x_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">tc35876x_client</span><span class="p">,</span> <span class="s">&quot;%s called before probe&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">260</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmi_lcd_i2c_client</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi_lcd_i2c_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting TCON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Bit 4 is average_saving. Setting it to 1, the brightness is</span>
<span class="cm">		 * referenced to the average of the frame content. 0 means</span>
<span class="cm">		 * reference to the maximum of frame contents. Bits 3:0 are</span>
<span class="cm">		 * allow_distort. When set to a nonzero value, all color values</span>
<span class="cm">		 * between 255-allow_distort*2 and 255 are mapped to the</span>
<span class="cm">		 * 255-allow_distort*2 value.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">cmi_lcd_i2c_client</span><span class="p">,</span>
						<span class="n">PANEL_ALLOW_DISTORT</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi_lcd_i2c_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;i2c write failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">cmi_lcd_i2c_client</span><span class="p">,</span>
						<span class="n">PANEL_BYPASS_PWMI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi_lcd_i2c_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;i2c write failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="cm">/* Set minimum brightness value - this is tunable */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">cmi_lcd_i2c_client</span><span class="p">,</span>
						<span class="n">PANEL_PWM_MIN</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi_lcd_i2c_client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;i2c write failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">gpio_set_value_cansleep</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tc35876x_brightness_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">brightness_adjusted</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="nf">tc35876x_get_config_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* FIXME: do this properly. */</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="mi">1280</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="mi">1360</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="mi">1400</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="mi">1440</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="mi">814</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="mi">824</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="mi">838</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">33324</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hdisplay(w) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdisplay(h) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HSS = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HSE = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;htotal = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VSS = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VSE = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vtotal = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clock = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>

	<span class="n">drm_mode_set_name</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DV1 Active area 216.96 x 135.6 mm */</span>
<span class="cp">#define DV1_PANEL_WIDTH 217</span>
<span class="cp">#define DV1_PANEL_HEIGHT 136</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35876x_get_panel_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">panel_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">pi</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">width_mm</span> <span class="o">=</span> <span class="n">DV1_PANEL_WIDTH</span><span class="p">;</span>
	<span class="n">pi</span><span class="o">-&gt;</span><span class="n">height_mm</span> <span class="o">=</span> <span class="n">DV1_PANEL_HEIGHT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35876x_bridge_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35876x_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_I2C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: i2c_check_functionality() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: no platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_request</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span><span class="p">,</span> <span class="s">&quot;tc35876x bridge reset&quot;</span><span class="p">);</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_request</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span><span class="p">,</span> <span class="s">&quot;tc35876x panel bl en&quot;</span><span class="p">);</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gpio_request</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span><span class="p">,</span> <span class="s">&quot;tc35876x panel vadd&quot;</span><span class="p">);</span>
		<span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tc35876x_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tc35876x_bridge_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tc35876x_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_bridge_reset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_bl_en</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_panel_vadd</span><span class="p">);</span>

	<span class="n">tc35876x_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tc35876x_bridge_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;i2c_disp_brig&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tc35876x_bridge_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tc35876x_bridge_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i2c_disp_brig&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">tc35876x_bridge_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">tc35876x_bridge_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">tc35876x_bridge_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* LCD panel I2C */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmi_lcd_i2c_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_I2C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: i2c_check_functionality() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmi_lcd_i2c_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmi_lcd_i2c_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">cmi_lcd_i2c_client</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">cmi_lcd_i2c_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;cmi-lcd&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">cmi_lcd_i2c_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">cmi_lcd_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmi-lcd&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cmi_lcd_i2c_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">cmi_lcd_i2c_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cmi_lcd_i2c_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* HACK to create I2C device while it&#39;s not created by platform code */</span>
<span class="cp">#define CMI_LCD_I2C_ADAPTER	2</span>
<span class="cp">#define CMI_LCD_I2C_ADDR	0x60</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmi_lcd_hack_create_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;cmi-lcd&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">CMI_LCD_I2C_ADDR</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="n">CMI_LCD_I2C_ADAPTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: i2c_get_adapter(%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">CMI_LCD_I2C_ADAPTER</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">i2c_new_device</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: i2c_new_device() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">i2c_put_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">tc35876x_encoder_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">mdfld_dsi_dpi_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">mdfld_dsi_dpi_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">mdfld_dsi_dpi_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">mdfld_dsi_dpi_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">mdfld_dsi_dpi_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_funcs</span> <span class="n">tc35876x_encoder_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">drm_encoder_cleanup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">panel_funcs</span> <span class="n">mdfld_tc35876x_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">encoder_funcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tc35876x_encoder_funcs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">encoder_helper_funcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tc35876x_encoder_helper_funcs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_config_mode</span> <span class="o">=</span> <span class="n">tc35876x_get_config_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_panel_info</span> <span class="o">=</span> <span class="n">tc35876x_get_panel_info</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">tc35876x_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">cmi_lcd_hack_create_device</span><span class="p">();</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi_lcd_i2c_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: i2c_add_driver() for %s failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">cmi_lcd_i2c_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_bridge_i2c_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: i2c_add_driver() for %s failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">tc35876x_bridge_i2c_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

	<span class="n">tc35876x_brightness_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">tc35876x_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tc35876x_bridge_i2c_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmi_lcd_i2c_client</span><span class="p">)</span>
		<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi_lcd_i2c_driver</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
