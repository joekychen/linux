<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › oaktrail_lvds.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>oaktrail_lvds.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2006-2009 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> *	Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> *	Jesse Barnes &lt;jesse.barnes@intel.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;drm/drmP.h&gt;</span>
<span class="cp">#include &lt;asm/mrst.h&gt;</span>

<span class="cp">#include &quot;intel_bios.h&quot;</span>
<span class="cp">#include &quot;psb_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_drv.h&quot;</span>
<span class="cp">#include &quot;psb_intel_reg.h&quot;</span>
<span class="cp">#include &quot;power.h&quot;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>

<span class="cm">/* The max/min PWM frequency in BPCR[31:17] - */</span>
<span class="cm">/* The smallest number is 1 (not 0) that can fit in the</span>
<span class="cm"> * 15-bit field of the and then*/</span>
<span class="cm">/* shifts to the left by one bit to get the actual 16-bit</span>
<span class="cm"> * value that the 15-bits correspond to.*/</span>
<span class="cp">#define MRST_BLC_MAX_PWM_REG_FREQ	    0xFFFF</span>
<span class="cp">#define BRIGHTNESS_MAX_LEVEL 100</span>

<span class="cm">/**</span>
<span class="cm"> * Sets the power state for the panel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_lvds_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pp_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PP_CONTROL</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PP_CONTROL</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">POWER_TARGET_ON</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">pp_status</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PP_STATUS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">pp_status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PP_ON</span> <span class="o">|</span> <span class="n">PP_READY</span><span class="p">))</span> <span class="o">==</span> <span class="n">PP_READY</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">is_lvds_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lvds_bl_power</span><span class="p">)</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lvds_bl_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lvds_bl_power</span><span class="p">)</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lvds_bl_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PP_CONTROL</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PP_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="o">~</span><span class="n">POWER_TARGET_ON</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">pp_status</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">PP_STATUS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">pp_status</span> <span class="o">&amp;</span> <span class="n">PP_ON</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">is_lvds_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">pm_request_idle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_lvds_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
						<span class="n">to_psb_intel_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span>
		<span class="n">oaktrail_lvds_set_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">psb_intel_encoder</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">oaktrail_lvds_set_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">psb_intel_encoder</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* XXX: We never power down the LVDS pairs. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_lvds_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_mode_device</span> <span class="o">*</span><span class="n">mode_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lvds_port</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">v</span> <span class="o">=</span> <span class="n">DRM_MODE_SCALE_FULLSCREEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The LVDS pin pair will already have been turned on in the</span>
<span class="cm">	 * psb_intel_crtc_mode_set since it has a large impact on the DPLL</span>
<span class="cm">	 * settings.</span>
<span class="cm">	 */</span>
	<span class="n">lvds_port</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="o">~</span><span class="n">LVDS_PIPEB_SELECT</span><span class="p">))</span> <span class="o">|</span>
		    <span class="n">LVDS_PORT_EN</span> <span class="o">|</span>
		    <span class="n">LVDS_BORDER_EN</span><span class="p">;</span>

	<span class="cm">/* If the firmware says dither on Moorestown, or the BIOS does</span>
<span class="cm">	   on Oaktrail then enable dithering */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_wants_dither</span> <span class="o">||</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_dither</span><span class="p">)</span>
		<span class="n">lvds_port</span> <span class="o">|=</span> <span class="n">MRST_PANEL_8TO6_DITHER_ENABLE</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">LVDS</span><span class="p">,</span> <span class="n">lvds_port</span><span class="p">);</span>

	<span class="cm">/* Find the connector we&#39;re trying to set up */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">||</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find connector when setting mode&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_connector_property_get_value</span><span class="p">(</span>
		<span class="n">connector</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">scaling_mode_property</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">DRM_MODE_SCALE_NO_SCALE</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">DRM_MODE_SCALE_ASPECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">!=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">!=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">*</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">)</span> <span class="o">==</span>
			    <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">*</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span><span class="p">))</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="n">PFIT_ENABLE</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">*</span>
				<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">*</span>
				<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span><span class="p">))</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="n">PFIT_ENABLE</span> <span class="o">|</span>
					  <span class="n">PFIT_SCALING_MODE_PILLARBOX</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="n">PFIT_ENABLE</span> <span class="o">|</span>
					  <span class="n">PFIT_SCALING_MODE_LETTERBOX</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="n">PFIT_ENABLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/*(v == DRM_MODE_SCALE_FULLSCREEN)*/</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="n">PFIT_ENABLE</span><span class="p">);</span>

	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_lvds_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
						<span class="n">to_psb_intel_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_intel_mode_device</span> <span class="o">*</span><span class="n">mode_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">saveBLC_PWM_CTL</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">BLC_PWM_CTL</span><span class="p">);</span>
	<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">backlight_duty_cycle</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">saveBLC_PWM_CTL</span> <span class="o">&amp;</span>
					  <span class="n">BACKLIGHT_DUTY_CYCLE_MASK</span><span class="p">);</span>
	<span class="n">oaktrail_lvds_set_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">psb_intel_encoder</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">oaktrail_lvds_get_max_backlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gma_power_begin</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">BLC_PWM_CTL</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="n">BACKLIGHT_MODULATION_FREQ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			  <span class="n">BACKLIGHT_MODULATION_FREQ_SHIFT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">gma_power_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">saveBLC_PWM_CTL</span> <span class="o">&amp;</span>
			  <span class="n">BACKLIGHT_MODULATION_FREQ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			  <span class="n">BACKLIGHT_MODULATION_FREQ_SHIFT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_lvds_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span> <span class="o">=</span>
						<span class="n">to_psb_intel_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">psb_intel_mode_device</span> <span class="o">*</span><span class="n">mode_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mode_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">backlight_duty_cycle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">backlight_duty_cycle</span> <span class="o">=</span>
					<span class="n">oaktrail_lvds_get_max_backlight</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">oaktrail_lvds_set_power</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">psb_intel_encoder</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">oaktrail_lvds_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">oaktrail_lvds_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">psb_intel_lvds_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">oaktrail_lvds_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">oaktrail_lvds_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">oaktrail_lvds_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="n">lvds_configuration_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* hard coded fixed mode for TPO LTPS LPJ040K001A */</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;800x480&quot;</span><span class="p">,</span>  <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">33264</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">836</span><span class="p">,</span>
		   <span class="mi">846</span><span class="p">,</span> <span class="mi">1056</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">489</span><span class="p">,</span> <span class="mi">491</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* hard coded fixed mode for LVDS 800x480 */</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;800x480&quot;</span><span class="p">,</span>  <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">30994</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">801</span><span class="p">,</span>
		   <span class="mi">802</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">481</span><span class="p">,</span> <span class="mi">482</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* hard coded fixed mode for Samsung 480wsvga LVDS 1024x600@75 */</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;1024x600&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">53990</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1072</span><span class="p">,</span>
		   <span class="mi">1104</span><span class="p">,</span> <span class="mi">1184</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">603</span><span class="p">,</span> <span class="mi">604</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* hard coded fixed mode for Samsung 480wsvga LVDS 1024x600@75 */</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;1024x600&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">53990</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1104</span><span class="p">,</span>
		   <span class="mi">1136</span><span class="p">,</span> <span class="mi">1184</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">603</span><span class="p">,</span> <span class="mi">604</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* hard coded fixed mode for Sharp wsvga LVDS 1024x600 */</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;1024x600&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">48885</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1124</span><span class="p">,</span>
		   <span class="mi">1204</span><span class="p">,</span> <span class="mi">1312</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">607</span><span class="p">,</span> <span class="mi">610</span><span class="p">,</span> <span class="mi">621</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* hard coded fixed mode for LVDS 1024x768 */</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;1024x768&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">65000</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1048</span><span class="p">,</span>
		   <span class="mi">1184</span><span class="p">,</span> <span class="mi">1344</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">771</span><span class="p">,</span> <span class="mi">777</span><span class="p">,</span> <span class="mi">806</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* hard coded fixed mode for LVDS 1366x768 */</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;1366x768&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">77500</span><span class="p">,</span> <span class="mi">1366</span><span class="p">,</span> <span class="mi">1430</span><span class="p">,</span>
		   <span class="mi">1558</span><span class="p">,</span> <span class="mi">1664</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">769</span><span class="p">,</span> <span class="mi">770</span><span class="p">,</span> <span class="mi">776</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Returns the panel fixed mode from configuration. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oaktrail_lvds_get_configuration_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">psb_intel_mode_device</span> <span class="o">*</span><span class="n">mode_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">oaktrail_timing_info</span> <span class="o">*</span><span class="n">ti</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gct_data</span><span class="p">.</span><span class="n">DTD</span><span class="p">;</span>

	<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Use the firmware provided data on Moorestown */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">has_gct</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">hactive_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">hactive_lo</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">vactive_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">vactive_lo</span><span class="p">;</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">+</span> \
				<span class="p">((</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">hsync_offset_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> \
				<span class="n">ti</span><span class="o">-&gt;</span><span class="n">hsync_offset_lo</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">+</span> \
				<span class="p">((</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">hsync_pulse_width_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> \
				<span class="n">ti</span><span class="o">-&gt;</span><span class="n">hsync_pulse_width_lo</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">+</span> <span class="p">((</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">hblank_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> \
							<span class="n">ti</span><span class="o">-&gt;</span><span class="n">hblank_lo</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> \
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">+</span> <span class="p">((</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">vsync_offset_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> \
						<span class="n">ti</span><span class="o">-&gt;</span><span class="n">vsync_offset_lo</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> \
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">+</span> <span class="p">((</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">vsync_pulse_width_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> \
						<span class="n">ti</span><span class="o">-&gt;</span><span class="n">vsync_pulse_width_lo</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">+</span> \
				<span class="p">((</span><span class="n">ti</span><span class="o">-&gt;</span><span class="n">vblank_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">vblank_lo</span><span class="p">);</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">ti</span><span class="o">-&gt;</span><span class="n">pixel_clock</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		printk(KERN_INFO &quot;hdisplay is %d\n&quot;, mode-&gt;hdisplay);</span>
<span class="c">		printk(KERN_INFO &quot;vdisplay is %d\n&quot;, mode-&gt;vdisplay);</span>
<span class="c">		printk(KERN_INFO &quot;HSS is %d\n&quot;, mode-&gt;hsync_start);</span>
<span class="c">		printk(KERN_INFO &quot;HSE is %d\n&quot;, mode-&gt;hsync_end);</span>
<span class="c">		printk(KERN_INFO &quot;htotal is %d\n&quot;, mode-&gt;htotal);</span>
<span class="c">		printk(KERN_INFO &quot;VSS is %d\n&quot;, mode-&gt;vsync_start);</span>
<span class="c">		printk(KERN_INFO &quot;VSE is %d\n&quot;, mode-&gt;vsync_end);</span>
<span class="c">		printk(KERN_INFO &quot;vtotal is %d\n&quot;, mode-&gt;vtotal);</span>
<span class="c">		printk(KERN_INFO &quot;clock is %d\n&quot;, mode-&gt;clock);</span>
<span class="cp">#endif</span>
		<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use the BIOS VBT mode if available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">vbt_mode</span><span class="p">)</span>
		<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">vbt_mode</span><span class="p">);</span>

	<span class="cm">/* Then try the LVDS VBT mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lfp_lvds_vbt_mode</span><span class="p">)</span>
			<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">=</span>
				<span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lfp_lvds_vbt_mode</span><span class="p">);</span>
	<span class="cm">/* Then guess */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span>
			<span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lvds_configuration_modes</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">drm_mode_set_name</span><span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">);</span>
	<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * oaktrail_lvds_init - setup LVDS connectors on this device</span>
<span class="cm"> * @dev: drm device</span>
<span class="cm"> *</span>
<span class="cm"> * Create the connector, register the LVDS DDC bus, and try to figure out what</span>
<span class="cm"> * modes we can display on the LVDS panel (if present).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">oaktrail_lvds_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">psb_intel_mode_device</span> <span class="o">*</span><span class="n">mode_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">psb_intel_encoder</span> <span class="o">*</span><span class="n">psb_intel_encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">psb_intel_connector</span> <span class="o">*</span><span class="n">psb_intel_connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">scan</span><span class="p">;</span>	<span class="cm">/* *modes, *bios_mode; */</span>

	<span class="n">psb_intel_encoder</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psb_intel_encoder</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psb_intel_encoder</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">psb_intel_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">psb_intel_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psb_intel_connector</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_connector</span><span class="p">;</span>

	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psb_intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">is_lvds_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">drm_connector_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">psb_intel_lvds_connector_funcs</span><span class="p">,</span>
			   <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">);</span>

	<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psb_intel_lvds_enc_funcs</span><span class="p">,</span>
			 <span class="n">DRM_MODE_ENCODER_LVDS</span><span class="p">);</span>

	<span class="n">psb_intel_connector_attach_encoder</span><span class="p">(</span><span class="n">psb_intel_connector</span><span class="p">,</span>
					   <span class="n">psb_intel_encoder</span><span class="p">);</span>
	<span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">;</span>

	<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oaktrail_lvds_helper_funcs</span><span class="p">);</span>
	<span class="n">drm_connector_helper_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">psb_intel_lvds_connector_helper_funcs</span><span class="p">);</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">subpixel_order</span> <span class="o">=</span> <span class="n">SubPixelHorizontalRGB</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">interlace_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">doublescan_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">scaling_mode_property</span><span class="p">,</span>
					<span class="n">DRM_MODE_SCALE_FULLSCREEN</span><span class="p">);</span>
	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">backlight_property</span><span class="p">,</span>
					<span class="n">BRIGHTNESS_MAX_LEVEL</span><span class="p">);</span>

	<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_wants_dither</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">has_gct</span><span class="p">)</span>
		<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_wants_dither</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gct_data</span><span class="p">.</span>
			<span class="n">Panel_Port_Control</span> <span class="o">&amp;</span> <span class="n">MRST_PANEL_8TO6_DITHER_ENABLE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_dither</span><span class="p">)</span>
                <span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_wants_dither</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * LVDS discovery:</span>
<span class="cm">	 * 1) check for EDID on DDC</span>
<span class="cm">	 * 2) check for VBT data</span>
<span class="cm">	 * 3) check to see if LVDS is already on</span>
<span class="cm">	 *    if none of the above, no panel</span>
<span class="cm">	 * 4) make sure lid is open</span>
<span class="cm">	 *    if closed, act like it&#39;s not there for now</span>
<span class="cm">	 */</span>

	<span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_adap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No ddc adapter available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Attempt to get the fixed panel mode from DDC.  Assume that the</span>
<span class="cm">	 * preferred mode is the right one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_adap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">drm_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">i2c_adap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_mode_connector_update_edid_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
									<span class="n">edid</span><span class="p">);</span>
			<span class="n">drm_add_edid_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">edid</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">=</span>
				    <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">scan</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>	<span class="cm">/* FIXME: check for quirks */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we didn&#39;t get EDID, try geting panel timing</span>
<span class="cm">	 * from configuration data</span>
<span class="cm">	 */</span>
	<span class="n">oaktrail_lvds_get_configuration_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>	<span class="cm">/* FIXME: check for quirks */</span>
	<span class="p">}</span>

	<span class="cm">/* If we still don&#39;t have a mode after all that, give up. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_dev</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Found no modes on the lvds, ignoring the LVDS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed_find</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">drm_sysfs_connector_add</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">failed_find:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No LVDS modes found, disabling.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">ddc_bus</span><span class="p">)</span>
		<span class="n">psb_intel_i2c_destroy</span><span class="p">(</span><span class="n">psb_intel_encoder</span><span class="o">-&gt;</span><span class="n">ddc_bus</span><span class="p">);</span>

<span class="cm">/* failed_ddc: */</span>

	<span class="n">drm_encoder_cleanup</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">drm_connector_cleanup</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psb_intel_connector</span><span class="p">);</span>
<span class="nl">failed_connector:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psb_intel_encoder</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
