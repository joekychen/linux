<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › gma500 › power.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>power.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**************************************************************************</span>
<span class="cm"> * Copyright (c) 2009-2011, Intel Corporation.</span>
<span class="cm"> * All Rights Reserved.</span>

<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm"> * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Benjamin Defnet &lt;benjamin.r.defnet@intel.com&gt;</span>
<span class="cm"> *    Rajesh Poornachandran &lt;rajesh.poornachandran@intel.com&gt;</span>
<span class="cm"> * Massively reworked</span>
<span class="cm"> *    Alan Cox &lt;alan@linux.intel.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _PSB_POWERMGMT_H_</span>
<span class="cp">#define _PSB_POWERMGMT_H_</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;drm/drmP.h&gt;</span>

<span class="kt">void</span> <span class="n">gma_power_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">gma_power_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The kernel bus power management  will call these functions</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">gma_power_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">gma_power_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * These are the functions the driver should use to wrap all hw access</span>
<span class="cm"> * (i.e. register reads and writes)</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="n">gma_power_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">gma_power_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Use this function to do an instantaneous check for if the hw is on.</span>
<span class="cm"> * Only use this in cases where you know the mutex is already held such</span>
<span class="cm"> * as in irq install/uninstall and you need to</span>
<span class="cm"> * prevent a deadlock situation.  Otherwise use gma_power_begin().</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="n">gma_power_is_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * GFX-Runtime PM callbacks</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">psb_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">psb_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">psb_runtime_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/*_PSB_POWERMGMT_H_*/</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
>{</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_set_suspended</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_suspend_display	-	suspend the display logic</span>
<span class="cm"> *	@dev: our DRM device</span>
<span class="cm"> *</span>
<span class="cm"> *	Suspend the display logic of the graphics interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gma_suspend_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">save_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">power_down</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_power</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_resume_display	-	resume display side logic</span>
<span class="cm"> *</span>
<span class="cm"> *	Resume the display hardware restoring state and enabling</span>
<span class="cm"> *	as necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gma_resume_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* turn on the display power island */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">power_up</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_power</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">PSB_WVDC32</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pge_ctl</span> <span class="o">|</span> <span class="n">_PSB_PGETBL_ENABLED</span><span class="p">,</span> <span class="n">PSB_PGETBL_CTL</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PSB_GMCH_CTRL</span><span class="p">,</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gmch_ctrl</span> <span class="o">|</span> <span class="n">_PSB_GMCH_ENABLED</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">restore_regs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_suspend_pci		-	suspend PCI side</span>
<span class="cm"> *	@pdev: PCI device</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform the suspend processing on our PCI device state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gma_suspend_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bsm</span><span class="p">,</span> <span class="n">vbt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bsm</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">saveBSM</span> <span class="o">=</span> <span class="n">bsm</span><span class="p">;</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vbt</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">saveVBT</span> <span class="o">=</span> <span class="n">vbt</span><span class="p">;</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PSB_PCIx_MSI_ADDR_LOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">msi_addr</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PSB_PCIx_MSI_DATA_LOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">msi_data</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_resume_pci		-	resume helper</span>
<span class="cm"> *	@dev: our PCI device</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform the resume processing on our PCI device state - rewrite</span>
<span class="cm"> *	register state and re-enable the PCI device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">gma_resume_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">saveBSM</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">saveVBT</span><span class="p">);</span>
	<span class="cm">/* restoring MSI address and data in PCIx space */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PSB_PCIx_MSI_ADDR_LOC</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">msi_addr</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PSB_PCIx_MSI_DATA_LOC</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">msi_data</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pci_enable failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_power_suspend		-	bus callback for suspend</span>
<span class="cm"> *	@pdev: our PCI device</span>
<span class="cm"> *	@state: suspend type</span>
<span class="cm"> *</span>
<span class="cm"> *	Called back by the PCI layer during a suspend of the system. We</span>
<span class="cm"> *	perform the necessary shut down steps and save enough state that</span>
<span class="cm"> *	we can undo this when resume is called.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gma_power_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_mutex</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GPU hardware busy, cannot suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">psb_irq_uninstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">gma_suspend_display</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">gma_suspend_pci</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_power_resume		-	resume power</span>
<span class="cm"> *	@pdev: PCI device</span>
<span class="cm"> *</span>
<span class="cm"> *	Resume the PCI side of the graphics and then the displays</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gma_power_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_mutex</span><span class="p">);</span>
	<span class="n">gma_resume_pci</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">gma_resume_display</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">psb_irq_preinstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">psb_irq_postinstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_power_is_on		-	returne true if power is on</span>
<span class="cm"> *	@dev: our DRM device</span>
<span class="cm"> *</span>
<span class="cm"> *	Returns true if the display island power is on at this moment</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">gma_power_is_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_power</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_power_begin		-	begin requiring power</span>
<span class="cm"> *	@dev: our DRM device</span>
<span class="cm"> *	@force_on: true to force power on</span>
<span class="cm"> *</span>
<span class="cm"> *	Begin an action that requires the display power island is enabled.</span>
<span class="cm"> *	We refcount the islands.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">gma_power_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Power already on ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pm_runtime_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">force_on</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_false</span><span class="p">;</span>

	<span class="cm">/* Ok power up needed */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gma_resume_pci</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psb_irq_preinstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">psb_irq_postinstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">pm_runtime_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_false:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	gma_power_end		-	end use of power</span>
<span class="cm"> *	@dev: Our DRM device</span>
<span class="cm"> *</span>
<span class="cm"> *	Indicate that one of our gma_power_begin() requested periods when</span>
<span class="cm"> *	the diplay island power is needed has completed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gma_power_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">power_ctrl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">psb_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gma_power_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">psb_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gma_power_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">psb_runtime_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">drmdev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">drm_psb_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">drmdev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
