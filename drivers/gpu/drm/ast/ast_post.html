<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › ast › ast_post.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ast_post.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the</span>
<span class="cm"> * &quot;Software&quot;), to deal in the Software without restriction, including</span>
<span class="cm"> * without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="cm"> * distribute, sub license, and/or sell copies of the Software, and to</span>
<span class="cm"> * permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDERS, AUTHORS AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM,</span>
<span class="cm"> * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR</span>
<span class="cm"> * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE</span>
<span class="cm"> * USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the</span>
<span class="cm"> * next paragraph) shall be included in all copies or substantial portions</span>
<span class="cm"> * of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Authors: Dave Airlie &lt;airlied@redhat.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;ast_drv.h&quot;</span>

<span class="cp">#include &quot;ast_dram_tables.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ast_init_dram_2300</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ast_enable_vga</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">ast_io_write8</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">ast_io_write8</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* will use later */</span>
<span class="c">static bool</span>
<span class="c">ast_is_vga_enabled(struct drm_device *dev)</span>
<span class="c">{</span>
<span class="c">	struct ast_private *ast = dev-&gt;dev_private;</span>
<span class="c">	u8 ch;</span>

<span class="c">	if (ast-&gt;chip == AST1180) {</span>
<span class="c">		/* TODO 1180 */</span>
<span class="c">	} else {</span>
<span class="c">		ch = ast_io_read8(ast, 0x43);</span>
<span class="c">		if (ch) {</span>
<span class="c">			ast_open_key(ast);</span>
<span class="c">			ch = ast_get_index_reg_mask(ast, AST_IO_CRTC_PORT, 0xb6, 0xff);</span>
<span class="c">			return ch &amp; 0x04;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">extreginfo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">extreginfo_ast2300a0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">extreginfo_ast2300</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ast_set_def_ext_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ext_reg_info</span><span class="p">;</span>

	<span class="cm">/* reset scratch */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mh">0x8f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ast_set_index_reg</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">AST2300</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">ext_reg_info</span> <span class="o">=</span> <span class="n">extreginfo_ast2300</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ext_reg_info</span> <span class="o">=</span> <span class="n">extreginfo_ast2300a0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ext_reg_info</span> <span class="o">=</span> <span class="n">extreginfo</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ext_reg_info</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ast_set_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">*</span><span class="n">ext_reg_info</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ext_reg_info</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable standard IO/MEM decode if secondary */</span>
	<span class="cm">/* ast_set_index_reg-mask(ast, AST_IO_CRTC_PORT, 0xa1, 0xff, 0x3); */</span>

	<span class="cm">/* Set Ext. Default */</span>
	<span class="n">ast_set_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">ast_set_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Enable RAMDAC for A1 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">AST2300</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">ast_set_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">mindwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="n">u32</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf004</span><span class="p">,</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span>
	<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">moutdwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">u32</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf004</span><span class="p">,</span> <span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span>
	<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">),</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AST2100/2150 DLL CBR Setting</span>
<span class="cm"> */</span>
<span class="cp">#define CBR_SIZE_AST2150	     ((16 &lt;&lt; 10) - 1)</span>
<span class="cp">#define CBR_PASSNUM_AST2150          5</span>
<span class="cp">#define CBR_THRESHOLD_AST2150        10</span>
<span class="cp">#define CBR_THRESHOLD2_AST2150       10</span>
<span class="cp">#define TIMEOUT_AST2150              5000000</span>

<span class="cp">#define CBR_PATNUM_AST2150           8</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">pattern_AST2150</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xFF00FF00</span><span class="p">,</span>
	<span class="mh">0xCC33CC33</span><span class="p">,</span>
	<span class="mh">0xAA55AA55</span><span class="p">,</span>
	<span class="mh">0xFFFE0001</span><span class="p">,</span>
	<span class="mh">0x683501FE</span><span class="p">,</span>
	<span class="mh">0x0F1929B0</span><span class="p">,</span>
	<span class="mh">0x2D0B4346</span><span class="p">,</span>
	<span class="mh">0x60767F02</span><span class="p">,</span>
	<span class="mh">0x6FBE36A6</span><span class="p">,</span>
	<span class="mh">0x3A253035</span><span class="p">,</span>
	<span class="mh">0x3019686D</span><span class="p">,</span>
	<span class="mh">0x41C6167E</span><span class="p">,</span>
	<span class="mh">0x620152BF</span><span class="p">,</span>
	<span class="mh">0x20F050E0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">mmctestburst2_ast2150</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="n">u32</span> <span class="n">datagen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000001</span> <span class="o">|</span> <span class="p">(</span><span class="n">datagen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">TIMEOUT_AST2150</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000003</span> <span class="o">|</span> <span class="p">(</span><span class="n">datagen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">TIMEOUT_AST2150</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* unused in DDX driver - here for completeness */</span>
<span class="c">static u32 mmctestsingle2_ast2150(struct ast_private *ast, u32 datagen)</span>
<span class="c">{</span>
<span class="c">	u32 data, timeout;</span>

<span class="c">	moutdwm(ast, 0x1e6e0070, 0x00000000);</span>
<span class="c">	moutdwm(ast, 0x1e6e0070, 0x00000005 | (datagen &lt;&lt; 3));</span>
<span class="c">	timeout = 0;</span>
<span class="c">	do {</span>
<span class="c">		data = mindwm(ast, 0x1e6e0070) &amp; 0x40;</span>
<span class="c">		if (++timeout &gt; TIMEOUT_AST2150) {</span>
<span class="c">			moutdwm(ast, 0x1e6e0070, 0x00000000);</span>
<span class="c">			return 0xffffffff;</span>
<span class="c">		}</span>
<span class="c">	} while (!data);</span>
<span class="c">	data = (mindwm(ast, 0x1e6e0070) &amp; 0x80) &gt;&gt; 7;</span>
<span class="c">	moutdwm(ast, 0x1e6e0070, 0x00000000);</span>
<span class="c">	return data;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbrtest_ast2150</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mmctestburst2_ast2150</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbrscan_ast2150</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">patcnt</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">patcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">patcnt</span> <span class="o">&lt;</span> <span class="n">CBR_PATNUM_AST2150</span><span class="p">;</span> <span class="n">patcnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e007c</span><span class="p">,</span> <span class="n">pattern_AST2150</span><span class="p">[</span><span class="n">patcnt</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">CBR_PASSNUM_AST2150</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cbrtest_ast2150</span><span class="p">(</span><span class="n">ast</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="n">CBR_PASSNUM_AST2150</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbrdlli_ast2150</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="kt">int</span> <span class="n">busw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dll_min</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dll_max</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dlli</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">passcnt</span><span class="p">;</span>

<span class="nl">cbr_start:</span>
	<span class="n">dll_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dll_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dll_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dll_min</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dll_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dll_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dll_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dll_max</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">passcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dlli</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">dlli</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0068</span><span class="p">,</span> <span class="n">dlli</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">cbrscan_ast2150</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">busw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dll_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dlli</span><span class="p">)</span>
					<span class="n">dll_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dll_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dlli</span><span class="p">)</span>
					<span class="n">dll_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">passcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">passcnt</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD_AST2150</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cbr_start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dll_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">dll_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dll_min</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">CBR_THRESHOLD_AST2150</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cbr_start</span><span class="p">;</span>

	<span class="n">dlli</span> <span class="o">=</span> <span class="n">dll_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(((</span><span class="n">dll_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dll_min</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0068</span><span class="p">,</span> <span class="n">dlli</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">ast_init_dram_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ast_dramstruct</span> <span class="o">*</span><span class="n">dram_reg_info</span><span class="p">;</span>

	<span class="n">j</span> <span class="o">=</span> <span class="n">ast_get_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* VGA only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">AST2000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dram_reg_info</span> <span class="o">=</span> <span class="n">ast2000_dram_table_data</span><span class="p">;</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf004</span><span class="p">,</span> <span class="mh">0x1e6e0000</span><span class="p">);</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10100</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">);</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10100</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xa8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="cm">/* AST2100/1100 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">AST2100</span> <span class="o">||</span> <span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="mi">2200</span><span class="p">)</span>
				<span class="n">dram_reg_info</span> <span class="o">=</span> <span class="n">ast2100_dram_table_data</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dram_reg_info</span> <span class="o">=</span> <span class="n">ast1100_dram_table_data</span><span class="p">;</span>

			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf004</span><span class="p">,</span> <span class="mh">0x1e6e0000</span><span class="p">);</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12000</span><span class="p">,</span> <span class="mh">0x1688A8A8</span><span class="p">);</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">);</span>

			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="mh">0xfc600309</span><span class="p">);</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* delay fn */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">udelay</span><span class="p">(</span><span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mh">0x4</span> <span class="o">&amp;&amp;</span> <span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">!=</span> <span class="n">AST2000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">dram_type</span> <span class="o">==</span> <span class="n">AST_DRAM_1Gx16</span><span class="p">)</span>
					<span class="n">data</span> <span class="o">=</span> <span class="mh">0x00000d89</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">dram_type</span> <span class="o">==</span> <span class="n">AST_DRAM_1Gx32</span><span class="p">)</span>
					<span class="n">data</span> <span class="o">=</span> <span class="mh">0x00000c8d</span><span class="p">;</span>

				<span class="n">temp</span> <span class="o">=</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12070</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="mh">0xc</span><span class="p">;</span>
				<span class="n">temp</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span> <span class="o">+</span> <span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">temp</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span> <span class="o">+</span> <span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">dram_reg_info</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">dram_reg_info</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* AST 2100/2150 DRAM calibration */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10120</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0x5061</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* 266Mhz */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10004</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
				<span class="n">cbrdlli_ast2150</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span> <span class="cm">/* 16 bits */</span>
			<span class="k">else</span>
				<span class="n">cbrdlli_ast2150</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span> <span class="cm">/* 32 bits */</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AST2000</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10140</span><span class="p">);</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10140</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST1100</span>:
		<span class="k">case</span> <span class="n">AST2100</span>:
		<span class="k">case</span> <span class="n">AST2200</span>:
		<span class="k">case</span> <span class="n">AST2150</span>:
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1200c</span><span class="p">);</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1200c</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffffffd</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12040</span><span class="p">);</span>
			<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12040</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* wait ready */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">ast_get_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ast_post_gpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">ast_enable_vga</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ast_open_key</span><span class="p">(</span><span class="n">ast</span><span class="p">);</span>
	<span class="n">ast_set_def_ext_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ast</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">==</span> <span class="n">AST2300</span><span class="p">)</span>
		<span class="n">ast_init_dram_2300</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ast_init_dram_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* AST 2300 DRAM settings */</span>
<span class="cp">#define AST_DDR3 0</span>
<span class="cp">#define AST_DDR2 1</span>

<span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">dram_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dram_chipid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dram_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vram_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">odt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wodt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rodt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dram_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_PERIOD</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_MADJ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_SADJ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_MRS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_EMRS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_AC1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_AC2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_DQSIC</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_DRV</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_IOZ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_DQIDLY</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_FREQ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">madj_max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dll2_finetune_step</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * DQSI DLL CBR Setting</span>
<span class="cm"> */</span>
<span class="cp">#define CBR_SIZE1            ((4  &lt;&lt; 10) - 1)</span>
<span class="cp">#define CBR_SIZE2            ((64 &lt;&lt; 10) - 1)</span>
<span class="cp">#define CBR_PASSNUM          5</span>
<span class="cp">#define CBR_PASSNUM2         5</span>
<span class="cp">#define CBR_THRESHOLD        10</span>
<span class="cp">#define CBR_THRESHOLD2       10</span>
<span class="cp">#define TIMEOUT              5000000</span>
<span class="cp">#define CBR_PATNUM           8</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">pattern</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xFF00FF00</span><span class="p">,</span>
	<span class="mh">0xCC33CC33</span><span class="p">,</span>
	<span class="mh">0xAA55AA55</span><span class="p">,</span>
	<span class="mh">0x88778877</span><span class="p">,</span>
	<span class="mh">0x92CC4D6E</span><span class="p">,</span>
	<span class="mh">0x543D3CDE</span><span class="p">,</span>
	<span class="mh">0xF1E843C7</span><span class="p">,</span>
	<span class="mh">0x7C61D253</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"> /* unused in DDX, included for completeness */</span>
<span class="c">static int mmc_test_burst(struct ast_private *ast, u32 datagen)</span>
<span class="c">{</span>
<span class="c">	u32 data, timeout;</span>

<span class="c">	moutdwm(ast, 0x1e6e0070, 0x00000000);</span>
<span class="c">	moutdwm(ast, 0x1e6e0070, 0x000000c1 | (datagen &lt;&lt; 3));</span>
<span class="c">	timeout = 0;</span>
<span class="c">	do {</span>
<span class="c">		data = mindwm(ast, 0x1e6e0070) &amp; 0x3000;</span>
<span class="c">		if (data &amp; 0x2000) {</span>
<span class="c">			return 0;</span>
<span class="c">		}</span>
<span class="c">		if (++timeout &gt; TIMEOUT) {</span>
<span class="c">			moutdwm(ast, 0x1e6e0070, 0x00000000);</span>
<span class="c">			return 0;</span>
<span class="c">		}</span>
<span class="c">	} while (!data);</span>
<span class="c">	moutdwm(ast, 0x1e6e0070, 0x00000000);</span>
<span class="c">	return 1;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_burst2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="n">u32</span> <span class="n">datagen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000041</span> <span class="o">|</span> <span class="p">(</span><span class="n">datagen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0078</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* Unused in DDX here for completeness */</span>
<span class="c">static int mmc_test_single(struct ast_private *ast, u32 datagen)</span>
<span class="c">{</span>
<span class="c">	u32 data, timeout;</span>

<span class="c">	moutdwm(ast, 0x1e6e0070, 0x00000000);</span>
<span class="c">	moutdwm(ast, 0x1e6e0070, 0x000000c5 | (datagen &lt;&lt; 3));</span>
<span class="c">	timeout = 0;</span>
<span class="c">	do {</span>
<span class="c">		data = mindwm(ast, 0x1e6e0070) &amp; 0x3000;</span>
<span class="c">		if (data &amp; 0x2000)</span>
<span class="c">			return 0;</span>
<span class="c">		if (++timeout &gt; TIMEOUT) {</span>
<span class="c">			moutdwm(ast, 0x1e6e0070, 0x0);</span>
<span class="c">			return 0;</span>
<span class="c">		}</span>
<span class="c">	} while (!data);</span>
<span class="c">	moutdwm(ast, 0x1e6e0070, 0x0);</span>
<span class="c">	return 1;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_single2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="n">u32</span> <span class="n">datagen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x00000005</span> <span class="o">|</span> <span class="p">(</span><span class="n">datagen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0078</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e0070</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbr_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mmc_test_single2</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mmc_test_burst2</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cbr_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">patcnt</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>

	<span class="n">data2</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">patcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">patcnt</span> <span class="o">&lt;</span> <span class="n">CBR_PATNUM</span><span class="p">;</span> <span class="n">patcnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e007c</span><span class="p">,</span> <span class="n">pattern</span><span class="p">[</span><span class="n">patcnt</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">CBR_PASSNUM2</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">=</span> <span class="n">cbr_test</span><span class="p">(</span><span class="n">ast</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data2</span> <span class="o">&amp;=</span> <span class="n">data</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data2</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="n">CBR_PASSNUM2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">cbr_test2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">mmc_test_burst2</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mmc_test_single2</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">~</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">cbr_scan2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">patcnt</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>

	<span class="n">data2</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">patcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">patcnt</span> <span class="o">&lt;</span> <span class="n">CBR_PATNUM</span><span class="p">;</span> <span class="n">patcnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e007c</span><span class="p">,</span> <span class="n">pattern</span><span class="p">[</span><span class="n">patcnt</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="n">CBR_PASSNUM2</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">=</span> <span class="n">cbr_test2</span><span class="p">(</span><span class="n">ast</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">data2</span> <span class="o">&amp;=</span> <span class="n">data</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="n">CBR_PASSNUM2</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* unused in DDX - added for completeness */</span>
<span class="c">static void finetuneDQI(struct ast_private *ast, struct ast2300_dram_param *param)</span>
<span class="c">{</span>
<span class="c">	u32 gold_sadj[2], dllmin[16], dllmax[16], dlli, data, cnt, mask, passcnt;</span>

<span class="c">	gold_sadj[0] = (mindwm(ast, 0x1E6E0024) &gt;&gt; 16) &amp; 0xffff;</span>
<span class="c">	gold_sadj[1] = gold_sadj[0] &gt;&gt; 8;</span>
<span class="c">	gold_sadj[0] = gold_sadj[0] &amp; 0xff;</span>
<span class="c">	gold_sadj[0] = (gold_sadj[0] + gold_sadj[1]) &gt;&gt; 1;</span>
<span class="c">	gold_sadj[1] = gold_sadj[0];</span>

<span class="c">	for (cnt = 0; cnt &lt; 16; cnt++) {</span>
<span class="c">		dllmin[cnt] = 0xff;</span>
<span class="c">		dllmax[cnt] = 0x0;</span>
<span class="c">	}</span>
<span class="c">	passcnt = 0;</span>
<span class="c">	for (dlli = 0; dlli &lt; 76; dlli++) {</span>
<span class="c">		moutdwm(ast, 0x1E6E0068, 0x00001400 | (dlli &lt;&lt; 16) | (dlli &lt;&lt; 24));</span>
<span class="c">		/* Wait DQSI latch phase calibration */</span>
<span class="c">		moutdwm(ast, 0x1E6E0074, 0x00000010);</span>
<span class="c">		moutdwm(ast, 0x1E6E0070, 0x00000003);</span>
<span class="c">		do {</span>
<span class="c">			data = mindwm(ast, 0x1E6E0070);</span>
<span class="c">		} while (!(data &amp; 0x00001000));</span>
<span class="c">		moutdwm(ast, 0x1E6E0070, 0x00000000);</span>

<span class="c">		moutdwm(ast, 0x1E6E0074, CBR_SIZE1);</span>
<span class="c">		data = cbr_scan2(ast);</span>
<span class="c">		if (data != 0) {</span>
<span class="c">			mask = 0x00010001;</span>
<span class="c">			for (cnt = 0; cnt &lt; 16; cnt++) {</span>
<span class="c">				if (data &amp; mask) {</span>
<span class="c">					if (dllmin[cnt] &gt; dlli) {</span>
<span class="c">						dllmin[cnt] = dlli;</span>
<span class="c">					}</span>
<span class="c">					if (dllmax[cnt] &lt; dlli) {</span>
<span class="c">						dllmax[cnt] = dlli;</span>
<span class="c">					}</span>
<span class="c">				}</span>
<span class="c">				mask &lt;&lt;= 1;</span>
<span class="c">			}</span>
<span class="c">			passcnt++;</span>
<span class="c">		} else if (passcnt &gt;= CBR_THRESHOLD) {</span>
<span class="c">			break;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	data = 0;</span>
<span class="c">	for (cnt = 0; cnt &lt; 8; cnt++) {</span>
<span class="c">		data &gt;&gt;= 3;</span>
<span class="c">		if ((dllmax[cnt] &gt; dllmin[cnt]) &amp;&amp; ((dllmax[cnt] - dllmin[cnt]) &gt;= CBR_THRESHOLD)) {</span>
<span class="c">			dlli = (dllmin[cnt] + dllmax[cnt]) &gt;&gt; 1;</span>
<span class="c">			if (gold_sadj[0] &gt;= dlli) {</span>
<span class="c">				dlli = (gold_sadj[0] - dlli) &gt;&gt; 1;</span>
<span class="c">				if (dlli &gt; 3) {</span>
<span class="c">					dlli = 3;</span>
<span class="c">				}</span>
<span class="c">			} else {</span>
<span class="c">				dlli = (dlli - gold_sadj[0]) &gt;&gt; 1;</span>
<span class="c">				if (dlli &gt; 4) {</span>
<span class="c">					dlli = 4;</span>
<span class="c">				}</span>
<span class="c">				dlli = (8 - dlli) &amp; 0x7;</span>
<span class="c">			}</span>
<span class="c">			data |= dlli &lt;&lt; 21;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	moutdwm(ast, 0x1E6E0080, data);</span>

<span class="c">	data = 0;</span>
<span class="c">	for (cnt = 8; cnt &lt; 16; cnt++) {</span>
<span class="c">		data &gt;&gt;= 3;</span>
<span class="c">		if ((dllmax[cnt] &gt; dllmin[cnt]) &amp;&amp; ((dllmax[cnt] - dllmin[cnt]) &gt;= CBR_THRESHOLD)) {</span>
<span class="c">			dlli = (dllmin[cnt] + dllmax[cnt]) &gt;&gt; 1;</span>
<span class="c">			if (gold_sadj[1] &gt;= dlli) {</span>
<span class="c">				dlli = (gold_sadj[1] - dlli) &gt;&gt; 1;</span>
<span class="c">				if (dlli &gt; 3) {</span>
<span class="c">					dlli = 3;</span>
<span class="c">				} else {</span>
<span class="c">					dlli = (dlli - 1) &amp; 0x7;</span>
<span class="c">				}</span>
<span class="c">			} else {</span>
<span class="c">				dlli = (dlli - gold_sadj[1]) &gt;&gt; 1;</span>
<span class="c">				dlli += 1;</span>
<span class="c">				if (dlli &gt; 4) {</span>
<span class="c">					dlli = 4;</span>
<span class="c">				}</span>
<span class="c">				dlli = (8 - dlli) &amp; 0x7;</span>
<span class="c">			}</span>
<span class="c">			data |= dlli &lt;&lt; 21;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	moutdwm(ast, 0x1E6E0084, data);</span>

<span class="c">} /* finetuneDQI */</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finetuneDQI_L</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dllmin</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">dllmax</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">dlli</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">passcnt</span><span class="p">;</span>

<span class="nl">FINETUNE_START:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">passcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dlli</span> <span class="o">&lt;</span> <span class="mi">76</span><span class="p">;</span> <span class="n">dlli</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="mh">0x00001400</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
		<span class="cm">/* Wait DQSI latch phase calibration */</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="mh">0x00000010</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">));</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="n">CBR_SIZE1</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">cbr_scan2</span><span class="p">(</span><span class="n">ast</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x00010001</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">passcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">passcnt</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">passcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">-</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="n">passcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">passcnt</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">FINETUNE_START</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">-</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dlli</span> <span class="o">=</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">((</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">*</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">((</span><span class="n">dlli</span> <span class="o">-</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">-</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dlli</span> <span class="o">=</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">((</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">*</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">((</span><span class="n">dlli</span> <span class="o">-</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">dlli</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0084</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* finetuneDQI_L */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finetuneDQI_L2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dllmin</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">dllmax</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">dlli</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">passcnt</span><span class="p">,</span> <span class="n">data2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">passcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dlli</span> <span class="o">&lt;</span> <span class="mi">76</span><span class="p">;</span> <span class="n">dlli</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="mh">0x00001400</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
		<span class="cm">/* Wait DQSI latch phase calibration */</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="mh">0x00000010</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">));</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="n">CBR_SIZE2</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">cbr_scan2</span><span class="p">(</span><span class="n">ast</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x00010001</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">passcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">passcnt</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">-</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">data2</span> <span class="o">=</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">-</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">+</span> <span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data2</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">data2</span> <span class="o">+</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">-</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data2</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">data2</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">data2</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">-</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0084</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">data2</span> <span class="o">=</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">gold_sadj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">-</span> <span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">+</span> <span class="n">dllmax</span><span class="p">[</span><span class="n">cnt</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data2</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">data2</span> <span class="o">+</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dlli</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">-</span> <span class="n">gold_sadj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dlli</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data2</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">data2</span> <span class="o">-</span> <span class="n">dlli</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">data2</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0084</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* finetuneDQI_L2 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cbr_dll2</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dllmin</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dllmax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dlli</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">passcnt</span><span class="p">;</span>


	<span class="n">finetuneDQI_L</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="n">finetuneDQI_L2</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

<span class="nl">CBR_START2:</span>
	<span class="n">dllmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dllmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dllmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dllmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">passcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dlli</span> <span class="o">&lt;</span> <span class="mi">76</span><span class="p">;</span> <span class="n">dlli</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="mh">0x00001300</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
		<span class="cm">/* Wait DQSI latch phase calibration */</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="mh">0x00000010</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">));</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="n">CBR_SIZE2</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">cbr_scan</span><span class="p">(</span><span class="n">ast</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dllmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dllmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dllmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dlli</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dllmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlli</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">passcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">passcnt</span> <span class="o">&gt;=</span> <span class="n">CBR_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dllmin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">CBR_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">CBR_START2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">dllmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dllmin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">CBR_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">CBR_START2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dlli</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dllmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dlli</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dlli</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dllmin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dllmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dlli</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">data</span>  <span class="o">=</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
	<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff80ffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0024</span><span class="p">,</span> <span class="mh">0x8001</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* Wait DQSI latch phase calibration */</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="mh">0x00000010</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">));</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">));</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* CBRDLL2 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_ddr3_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">trap</span><span class="p">,</span> <span class="n">trap_AC2</span><span class="p">,</span> <span class="n">trap_MRS</span><span class="p">;</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2000</span><span class="p">,</span> <span class="mh">0x1688A8A8</span><span class="p">);</span>

	<span class="cm">/* Ger trap info */</span>
	<span class="n">trap</span> <span class="o">=</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2070</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">trap_AC2</span>  <span class="o">=</span> <span class="mh">0x00020000</span> <span class="o">+</span> <span class="p">(</span><span class="n">trap</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">trap_AC2</span> <span class="o">|=</span> <span class="mh">0x00300000</span> <span class="o">+</span> <span class="p">((</span><span class="n">trap</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">trap_MRS</span>  <span class="o">=</span> <span class="mh">0x00000010</span> <span class="o">+</span> <span class="p">(</span><span class="n">trap</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">trap_MRS</span> <span class="o">|=</span> <span class="p">((</span><span class="n">trap</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">);</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span>       <span class="o">=</span> <span class="mh">0x00034C4C</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_SADJ</span>       <span class="o">=</span> <span class="mh">0x00001800</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>        <span class="o">=</span> <span class="mh">0x000000F0</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_PERIOD</span>     <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_freq</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_freq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">336</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0190</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x22202725</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xAA007613</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000BA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x04001400</span> <span class="o">|</span> <span class="n">trap_MRS</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000074</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x00004DC0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">396</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x03F1</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302825</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xCC009617</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000E2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x04001600</span> <span class="o">|</span> <span class="n">trap_MRS</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000FA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000089</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000050C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_chipid</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">AST_DRAM_512Mx16</span>:
		<span class="k">case</span> <span class="n">AST_DRAM_1Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC009617</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_2Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC009622</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_4Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00963F</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">408</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x01F0</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302825</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xCC009617</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000E2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x04001600</span> <span class="o">|</span> <span class="n">trap_MRS</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000FA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000089</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000050C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_chipid</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">AST_DRAM_512Mx16</span>:
		<span class="k">case</span> <span class="n">AST_DRAM_1Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC009617</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_2Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC009622</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_4Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00963F</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">456</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0230</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302926</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xCD44961A</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000FC</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00081830</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000045</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000097</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000052C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">504</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0270</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302926</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xDE44A61D</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x00000117</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00081A30</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x070000BB</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x000000A0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000054C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">79</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">528</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0290</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302926</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xEF44B61E</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x00000125</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00081A30</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000F5</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000088</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000055C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">76</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">576</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0140</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span>      <span class="o">=</span> <span class="mh">0x00136868</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_SADJ</span>      <span class="o">=</span> <span class="mh">0x00004534</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302A37</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xEF56B61E</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x0000013F</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00101A50</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000FA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000078</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000057C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">136</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">600</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x02E1</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span>      <span class="o">=</span> <span class="mh">0x00136868</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_SADJ</span>      <span class="o">=</span> <span class="mh">0x00004534</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x32302A37</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xDF56B61F</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x0000014D</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00101A50</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000F5</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000023</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000078</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000058C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">132</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">624</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0160</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span>      <span class="o">=</span> <span class="mh">0x00136868</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_SADJ</span>      <span class="o">=</span> <span class="mh">0x00004534</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x32302A37</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xEF56B621</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x0000015A</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x02101A50</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000F5</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000078</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000059C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* switch freq */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_chipid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AST_DRAM_512Mx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x130</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">AST_DRAM_1Gx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x131</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_DRAM_2Gx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x132</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_DRAM_4Gx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x133</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span> <span class="cm">/* switch size */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_8M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_16M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_32M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_64M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x0c</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddr3_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">data2</span><span class="p">;</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0000</span><span class="p">,</span> <span class="mh">0xFC600309</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0024</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_SADJ</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span> <span class="o">|</span> <span class="mh">0xC0000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0004</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0008</span><span class="p">,</span> <span class="mh">0x90040f</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0010</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0014</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0020</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0084</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0088</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="mh">0x4040A170</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="mh">0x20402370</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0038</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0040</span><span class="p">,</span> <span class="mh">0xFF444444</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0044</span><span class="p">,</span> <span class="mh">0x22222222</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0048</span><span class="p">,</span> <span class="mh">0x22222222</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E004C</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0054</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0060</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E006C</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0078</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E007C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="cm">/* Wait MCLK2X lock to MCLK */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x08000000</span><span class="p">));</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00005C04</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff3ffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data2</span> <span class="o">=</span> <span class="p">((</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data2</span> <span class="o">=</span> <span class="p">((</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">;</span>
		<span class="n">data2</span> <span class="o">+=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="p">(</span><span class="n">data2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC0000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff1ff</span><span class="p">;</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x08000000</span><span class="p">));</span>

		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00005C04</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC00</span><span class="p">;</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="cm">/* Mode Register Setting */</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E002C</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0030</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000007</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E002C</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00005C08</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x7FFF5C01</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x300</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x3000</span> <span class="o">|</span> <span class="p">((</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span> <span class="o">&amp;</span> <span class="mh">0x60000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>

	<span class="cm">/* Wait DQI delay lock */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">));</span>
	<span class="cm">/* Wait DQSI delay lock */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0020</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00000800</span><span class="p">));</span>
	<span class="cm">/* Calibrate the DQSI delay */</span>
	<span class="n">cbr_dll2</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0120</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span><span class="p">);</span>
	<span class="cm">/* ECC Memory Initialization */</span>
<span class="cp">#ifdef ECC</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E007C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x221</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">));</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_ddr2_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">trap</span><span class="p">,</span> <span class="n">trap_AC2</span><span class="p">,</span> <span class="n">trap_MRS</span><span class="p">;</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2000</span><span class="p">,</span> <span class="mh">0x1688A8A8</span><span class="p">);</span>

	<span class="cm">/* Ger trap info */</span>
	<span class="n">trap</span> <span class="o">=</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2070</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">trap_AC2</span>  <span class="o">=</span> <span class="p">(</span><span class="n">trap</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">trap</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">trap_AC2</span> <span class="o">+=</span> <span class="mh">0x00110000</span><span class="p">;</span>
	<span class="n">trap_MRS</span>  <span class="o">=</span> <span class="mh">0x00000040</span> <span class="o">|</span> <span class="p">(</span><span class="n">trap</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>


	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span>       <span class="o">=</span> <span class="mh">0x00034C4C</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_SADJ</span>       <span class="o">=</span> <span class="mh">0x00001800</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>        <span class="o">=</span> <span class="mh">0x000000F0</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_PERIOD</span>     <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_freq</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_freq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">264</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0130</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x11101513</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0x78117011</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x00000092</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000842</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000F0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x0000005A</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x00004AC0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">138</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">336</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0190</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x22202613</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xAA009016</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000BA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000A02</span> <span class="o">|</span> <span class="n">trap_MRS</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000FA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000074</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x00004DC0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">396</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x03F1</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302714</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xCC00B01B</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000E2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000C02</span> <span class="o">|</span> <span class="n">trap_MRS</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000FA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000089</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000050C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_chipid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AST_DRAM_512Mx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B016</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">AST_DRAM_1Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B01B</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_2Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B02B</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_4Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B03F</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">408</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x01F0</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302714</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xCC00B01B</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000E2</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000C02</span> <span class="o">|</span> <span class="n">trap_MRS</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000FA</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000089</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000050C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">96</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_chipid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AST_DRAM_512Mx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B016</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">AST_DRAM_1Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B01B</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_2Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B02B</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AST_DRAM_4Gx16</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>   <span class="o">=</span> <span class="mh">0xCC00B03F</span> <span class="o">|</span> <span class="n">trap_AC2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">456</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0230</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302815</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xCD44B01E</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x000000FC</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000E72</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000034</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x00000097</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000052C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">504</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0261</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302815</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xDE44C022</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x00000117</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000E72</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x0000000A</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000045</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x000000A0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000054C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">79</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">528</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x33302815</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xEF44D024</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x00000125</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000E72</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000F9</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000045</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x000000A7</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000055C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">76</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">552</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x02A1</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x43402915</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xFF44E025</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x00000132</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000E72</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000040</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x0000000A</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000045</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x000000AD</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000056C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">76</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">576</span>:
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E2020</span><span class="p">,</span> <span class="mh">0x0140</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span>       <span class="o">=</span> <span class="mh">0x43402915</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span>       <span class="o">=</span> <span class="mh">0xFF44E027</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span>     <span class="o">=</span> <span class="mh">0x0000013F</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span>       <span class="o">=</span> <span class="mh">0x00000E72</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span>      <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span>       <span class="o">=</span> <span class="mh">0x000000F5</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span>       <span class="o">=</span> <span class="mh">0x00000045</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span>    <span class="o">=</span> <span class="mh">0x000000B3</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span>      <span class="o">=</span> <span class="mh">0x000057C0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span>      <span class="o">=</span> <span class="mi">76</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dll2_finetune_step</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_chipid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AST_DRAM_512Mx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">AST_DRAM_1Gx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x121</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_DRAM_2Gx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x122</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_DRAM_4Gx16</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">=</span> <span class="mh">0x123</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span> <span class="cm">/* switch size */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_8M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_16M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_32M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AST_VIDMEM_SIZE_64M</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span> <span class="o">|=</span> <span class="mh">0x0c</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ddr2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">data2</span><span class="p">;</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0000</span><span class="p">,</span> <span class="mh">0xFC600309</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0024</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_SADJ</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MADJ</span> <span class="o">|</span> <span class="mh">0xC0000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0004</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">dram_config</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0008</span><span class="p">,</span> <span class="mh">0x90040f</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0010</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC1</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0014</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0020</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQSIC</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0084</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0088</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DQIDLY</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="mh">0x4040A130</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="mh">0x20402330</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0038</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0040</span><span class="p">,</span> <span class="mh">0xFF808000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0044</span><span class="p">,</span> <span class="mh">0x88848466</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0048</span><span class="p">,</span> <span class="mh">0x44440008</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E004C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0054</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0060</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_DRV</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E006C</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_IOZ</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0074</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0078</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E007C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/* Wait MCLK2X lock to MCLK */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x08000000</span><span class="p">));</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00005C04</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data2</span> <span class="o">=</span> <span class="p">(</span><span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff3ffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">madj_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">data2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0x00100000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data2</span> <span class="o">=</span> <span class="p">((</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data2</span> <span class="o">=</span> <span class="p">((</span><span class="n">data2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff00ff</span><span class="p">;</span>
		<span class="n">data2</span> <span class="o">+=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="p">(</span><span class="n">data2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0068</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">,</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0064</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC0000</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffff1ff</span><span class="p">;</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x200</span><span class="p">;</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x08000000</span><span class="p">));</span>

		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00005C04</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E001C</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xC00</span><span class="p">;</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0018</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="cm">/* Mode Register Setting */</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E002C</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0030</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000007</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x00005C08</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E002C</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_MRS</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0030</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span> <span class="o">|</span> <span class="mh">0x380</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0030</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_EMRS</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0028</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>

	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E000C</span><span class="p">,</span> <span class="mh">0x7FFF5C01</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">wodt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x500</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">rodt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x3000</span> <span class="o">|</span> <span class="p">((</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_AC2</span> <span class="o">&amp;</span> <span class="mh">0x60000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0034</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0120</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">reg_FREQ</span><span class="p">);</span>

	<span class="cm">/* Wait DQI delay lock */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0080</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">));</span>
	<span class="cm">/* Wait DQSI delay lock */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0020</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00000800</span><span class="p">));</span>
	<span class="cm">/* Calibrate the DQSI delay */</span>
	<span class="n">cbr_dll2</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

	<span class="cm">/* ECC Memory Initialization */</span>
<span class="cp">#ifdef ECC</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E007C</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x221</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x00001000</span><span class="p">));</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0070</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1E6E0050</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ast_init_dram_2300</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ast_private</span> <span class="o">*</span><span class="n">ast</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ast2300_dram_param</span> <span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">ast_get_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* vga only */</span>
		<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf004</span><span class="p">,</span> <span class="mh">0x1e6e0000</span><span class="p">);</span>
		<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12000</span><span class="p">,</span> <span class="mh">0x1688a8a8</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">,</span> <span class="mh">0xfc600309</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="cm">/* Slow down CPU/AHB CLK in VGA only mode */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">ast_read32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12008</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="mh">0x73</span><span class="p">;</span>
		<span class="n">ast_write32</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x12008</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">param</span><span class="p">.</span><span class="n">dram_type</span> <span class="o">=</span> <span class="n">AST_DDR3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x01000000</span><span class="p">)</span>
			<span class="n">param</span><span class="p">.</span><span class="n">dram_type</span> <span class="o">=</span> <span class="n">AST_DDR2</span><span class="p">;</span>
		<span class="n">param</span><span class="p">.</span><span class="n">dram_chipid</span> <span class="o">=</span> <span class="n">ast</span><span class="o">-&gt;</span><span class="n">dram_type</span><span class="p">;</span>
		<span class="n">param</span><span class="p">.</span><span class="n">dram_freq</span> <span class="o">=</span> <span class="n">ast</span><span class="o">-&gt;</span><span class="n">mclk</span><span class="p">;</span>
		<span class="n">param</span><span class="p">.</span><span class="n">vram_size</span> <span class="o">=</span> <span class="n">ast</span><span class="o">-&gt;</span><span class="n">vram_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">dram_type</span> <span class="o">==</span> <span class="n">AST_DDR3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">get_ddr3_info</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
			<span class="n">ddr3_init</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">get_ddr2_info</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
			<span class="n">ddr2_init</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">mindwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e2040</span><span class="p">);</span>
		<span class="n">moutdwm</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="mh">0x1e6e2040</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait ready */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">ast_get_index_reg_mask</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span> <span class="n">AST_IO_CRTC_PORT</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
