<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › drm_fb_helper.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drm_fb_helper.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006-2009 Red Hat Inc.</span>
<span class="cm"> * Copyright (c) 2006-2008 Intel Corporation</span>
<span class="cm"> * Copyright (c) 2007 Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * DRM framebuffer helper functions</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, distribute, and sell this software and its</span>
<span class="cm"> * documentation for any purpose is hereby granted without fee, provided that</span>
<span class="cm"> * the above copyright notice appear in all copies and that both that copyright</span>
<span class="cm"> * notice and this permission notice appear in supporting documentation, and</span>
<span class="cm"> * that the name of the copyright holders not be used in advertising or</span>
<span class="cm"> * publicity pertaining to distribution of the software without specific,</span>
<span class="cm"> * written prior permission.  The copyright holders make no representations</span>
<span class="cm"> * about the suitability of this software for any purpose.  It is provided &quot;as</span>
<span class="cm"> * is&quot; without express or implied warranty.</span>
<span class="cm"> *</span>
<span class="cm"> * THE COPYRIGHT HOLDERS DISCLAIM ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,</span>
<span class="cm"> * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO</span>
<span class="cm"> * EVENT SHALL THE COPYRIGHT HOLDERS BE LIABLE FOR ANY SPECIAL, INDIRECT OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,</span>
<span class="cm"> * DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER</span>
<span class="cm"> * TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE</span>
<span class="cm"> * OF THIS SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *      Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> *      Jesse Barnes &lt;jesse.barnes@intel.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm_crtc.h&quot;</span>
<span class="cp">#include &quot;drm_fb_helper.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Airlie, Jesse Barnes&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DRM KMS helper&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL and additional rights&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">kernel_fb_helper_list</span><span class="p">);</span>

<span class="cm">/* simple single crtc case helper function */</span>
<span class="kt">int</span> <span class="nf">drm_fb_helper_single_add_all_connectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_helper_connector</span><span class="p">;</span>

		<span class="n">fb_helper_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_helper_connector</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">fb_helper_connector</span><span class="o">-&gt;</span><span class="n">connector</span> <span class="o">=</span> <span class="n">connector</span><span class="p">;</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_helper_connector</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_single_add_all_connectors</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_fb_helper_parse_command_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_helper_conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_cmdline_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">option</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">fb_helper_conn</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">cmdline_mode</span><span class="p">;</span>

		<span class="cm">/* do something on return - turn off connector maybe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb_get_options</span><span class="p">(</span><span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">option</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">drm_mode_parse_command_line_for_connector</span><span class="p">(</span><span class="n">option</span><span class="p">,</span>
							      <span class="n">connector</span><span class="p">,</span>
							      <span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">DRM_FORCE_OFF</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;OFF&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">DRM_FORCE_ON_DIGITAL</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;ON - dig&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
				<span class="k">case</span> <span class="n">DRM_FORCE_ON</span>: <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;ON&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;forcing %s connector %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">connector</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;cmdline mode for connector %s %dx%d@%dHz%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
				      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
				      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">refresh_specified</span> <span class="o">?</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">:</span> <span class="mi">60</span><span class="p">,</span>
				      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">rb</span> <span class="o">?</span> <span class="s">&quot; reduced blanking&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">margins</span> <span class="o">?</span> <span class="s">&quot; with margins&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">interlace</span> <span class="o">?</span>  <span class="s">&quot; interlaced&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_fb_helper_save_lut_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">r_base</span><span class="p">,</span> <span class="o">*</span><span class="n">g_base</span><span class="p">,</span> <span class="o">*</span><span class="n">b_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">r_base</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span><span class="p">;</span>
	<span class="n">g_base</span> <span class="o">=</span> <span class="n">r_base</span> <span class="o">+</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span>
	<span class="n">b_base</span> <span class="o">=</span> <span class="n">g_base</span> <span class="o">+</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">helper</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_get</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_base</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">g_base</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">b_base</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_fb_helper_restore_lut_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="o">*</span><span class="n">r_base</span><span class="p">,</span> <span class="o">*</span><span class="n">g_base</span><span class="p">,</span> <span class="o">*</span><span class="n">b_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_set</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">r_base</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span><span class="p">;</span>
	<span class="n">g_base</span> <span class="o">=</span> <span class="n">r_base</span> <span class="o">+</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span>
	<span class="n">b_base</span> <span class="o">=</span> <span class="n">g_base</span> <span class="o">+</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">r_base</span><span class="p">,</span> <span class="n">g_base</span><span class="p">,</span> <span class="n">b_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_debug_enter</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">funcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernel_fb_helper_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">helper</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kernel_fb_helper_list</span><span class="p">,</span> <span class="n">kernel_fb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">mode_set</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">funcs</span> <span class="o">=</span>	<span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="n">drm_fb_helper_save_lut_atomic</span><span class="p">(</span><span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">helper</span><span class="p">);</span>
			<span class="n">funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base_atomic</span><span class="p">(</span><span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span>
						    <span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span>
						    <span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span>
						    <span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span>
						    <span class="n">ENTER_ATOMIC_MODE_SET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_debug_enter</span><span class="p">);</span>

<span class="cm">/* Find the real fb for a given fb helper CRTC */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="nf">drm_mode_config_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_debug_leave</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">funcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">mode_set</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">;</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
		<span class="n">funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">fb</span> <span class="o">=</span> <span class="n">drm_mode_config_fb</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;no fb to restore??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">drm_fb_helper_restore_lut_atomic</span><span class="p">(</span><span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
		<span class="n">funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base_atomic</span><span class="p">(</span><span class="n">mode_set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span>
					    <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">LEAVE_ATOMIC_MODE_SET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_debug_leave</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">drm_fb_helper_restore_fbdev_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">mode_set</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">(</span><span class="n">mode_set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_restore_fbdev_mode</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">drm_fb_helper_force_kernel_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">helper</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernel_fb_helper_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">helper</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kernel_fb_helper_list</span><span class="p">,</span> <span class="n">kernel_fb_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">switch_power_state</span> <span class="o">==</span> <span class="n">DRM_SWITCH_POWER_OFF</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_fb_helper_restore_fbdev_mode</span><span class="p">(</span><span class="n">helper</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_panic</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ununsed</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">panic_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s a waste of time and effort to switch back to text console</span>
<span class="cm">	 * if the kernel should reboot before panic messages can be seen.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">panic_timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;panic occurred, switching back to text console</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drm_fb_helper_force_kernel_mode</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_panic</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">paniced</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">drm_fb_helper_panic</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * drm_fb_helper_restore - restore the framebuffer console (kernel) config</span>
<span class="cm"> *</span>
<span class="cm"> * Restore&#39;s the kernel&#39;s fbcon mode, used for lastclose &amp; panic paths.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_fb_helper_restore</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_fb_helper_force_kernel_mode</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to restore crtc configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_restore</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MAGIC_SYSRQ</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_fb_helper_restore_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_fb_helper_restore</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">drm_fb_helper_restore_work</span><span class="p">,</span> <span class="n">drm_fb_helper_restore_work_fn</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_fb_helper_sysrq</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drm_fb_helper_restore_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_drm_fb_helper_restore_op</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">drm_fb_helper_sysrq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help_msg</span> <span class="o">=</span> <span class="s">&quot;force-fb(V)&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">action_msg</span> <span class="o">=</span> <span class="s">&quot;Restore framebuffer console&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sysrq_key_op</span> <span class="n">sysrq_drm_fb_helper_restore_op</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_fb_helper_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dpms_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For each CRTC in this fb, turn the connectors on/off.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Walk the connectors &amp; encoders on this fb turning them on/off */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">connector</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">;</span>
			<span class="n">drm_helper_connector_dpms</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">dpms_mode</span><span class="p">);</span>
			<span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dpms_property</span><span class="p">,</span> <span class="n">dpms_mode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Display: On; HSync: On, VSync: On */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">drm_fb_helper_dpms</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Display: Off; HSync: On, VSync: On */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="n">drm_fb_helper_dpms</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_STANDBY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Display: Off; HSync: Off, VSync: On */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="n">drm_fb_helper_dpms</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_STANDBY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Display: Off; HSync: On, VSync: Off */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">drm_fb_helper_dpms</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Display: Off; HSync: Off, VSync: Off */</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">drm_fb_helper_dpms</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_blank</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_fb_helper_crtc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">connectors</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span>
			<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">crtc_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_conn_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">kernel_fb_list</span><span class="p">);</span>

	<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">crtc_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span> <span class="o">=</span> <span class="n">crtc_count</span><span class="p">;</span>
	<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">connectors</span> <span class="o">=</span>
			<span class="n">kcalloc</span><span class="p">(</span><span class="n">max_conn_count</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">connectors</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">num_connectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_free:</span>
	<span class="n">drm_fb_helper_crtc_free</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_fb_helper_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">kernel_fb_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">kernel_fb_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernel_fb_helper_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drm: unregistered panic notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atomic_notifier_chain_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">panic_notifier_list</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">paniced</span><span class="p">);</span>
			<span class="n">unregister_sysrq_key</span><span class="p">(</span><span class="sc">&#39;v&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysrq_drm_fb_helper_restore_op</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drm_fb_helper_crtc_free</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_fini</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setcolreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="n">green</span><span class="p">,</span>
		     <span class="n">u16</span> <span class="n">blue</span><span class="p">,</span> <span class="n">u16</span> <span class="n">regno</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pindex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">==</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">palette</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
		<span class="cm">/* place color in psuedopalette */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">palette</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
		<span class="n">red</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">green</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">blue</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">green</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">blue</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pindex</span> <span class="o">=</span> <span class="n">regno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pindex</span> <span class="o">=</span> <span class="n">regno</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span>
						<span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">pindex</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_get</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">g</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span>
						    <span class="n">pindex</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
							    <span class="n">green</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
							    <span class="p">(</span><span class="n">pindex</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">pindex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_setcmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_cmap</span> <span class="o">*</span><span class="n">cmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="o">*</span><span class="n">transp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>
		<span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>

		<span class="n">red</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">;</span>
		<span class="n">green</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">;</span>
		<span class="n">blue</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">;</span>
		<span class="n">transp</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">cmap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">hred</span><span class="p">,</span> <span class="n">hgreen</span><span class="p">,</span> <span class="n">hblue</span><span class="p">,</span> <span class="n">htransp</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

			<span class="n">hred</span> <span class="o">=</span> <span class="o">*</span><span class="n">red</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hgreen</span> <span class="o">=</span> <span class="o">*</span><span class="n">green</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hblue</span> <span class="o">=</span> <span class="o">*</span><span class="n">blue</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">transp</span><span class="p">)</span>
				<span class="n">htransp</span> <span class="o">=</span> <span class="o">*</span><span class="n">transp</span><span class="o">++</span><span class="p">;</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">setcolreg</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">hred</span><span class="p">,</span> <span class="n">hgreen</span><span class="p">,</span> <span class="n">hblue</span><span class="p">,</span> <span class="n">start</span><span class="o">++</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_setcmap</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">in_dbg_master</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Need to resize the fb object !!! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;fb userspace requested width/height/bpp is greater than current fb &quot;</span>
			  <span class="s">&quot;request %dx%d-%d (virtual %dx%d) &gt; %dx%d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">,</span>
			  <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span>
			  <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">depth</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_check_var</span><span class="p">);</span>

<span class="cm">/* this will let fbcon do the mode init */</span>
<span class="kt">int</span> <span class="nf">drm_fb_helper_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;PIXEL CLOCK SET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">delayed_hotplug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">delayed_hotplug</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">drm_fb_helper_hotplug_event</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_set_par</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">modeset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>

		<span class="n">modeset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">;</span>

		<span class="n">modeset</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
		<span class="n">modeset</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">modeset</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">(</span><span class="n">modeset</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_pan_display</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_fb_helper_single_fb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">preferred_bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_fb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crtc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_surface_size</span> <span class="n">sizes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gamma_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sizes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_surface_size</span><span class="p">));</span>
	<span class="n">sizes</span><span class="p">.</span><span class="n">surface_depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">sizes</span><span class="p">.</span><span class="n">fb_width</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sizes</span><span class="p">.</span><span class="n">fb_height</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if driver picks 8 or 16 by default use that</span>
<span class="cm">	   for both depth/bpp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">preferred_bpp</span> <span class="o">!=</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sizes</span><span class="p">.</span><span class="n">surface_depth</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="n">preferred_bpp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* first up get a count of crtcs now in use and new min/maxes width/heights */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_helper_conn</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">drm_cmdline_mode</span> <span class="o">*</span><span class="n">cmdline_mode</span><span class="p">;</span>

		<span class="n">cmdline_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">cmdline_mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">bpp_specified</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_depth</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">15</span>:
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_depth</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">16</span>:
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_depth</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">24</span>:
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_depth</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">32</span>:
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">crtc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">desired_mode</span><span class="p">;</span>
		<span class="n">desired_mode</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desired_mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desired_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gamma_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">gamma_size</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&lt;</span> <span class="n">sizes</span><span class="p">.</span><span class="n">fb_width</span><span class="p">)</span>
				<span class="n">sizes</span><span class="p">.</span><span class="n">fb_width</span> <span class="o">=</span> <span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">&lt;</span> <span class="n">sizes</span><span class="p">.</span><span class="n">fb_height</span><span class="p">)</span>
				<span class="n">sizes</span><span class="p">.</span><span class="n">fb_height</span> <span class="o">=</span> <span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_width</span><span class="p">)</span>
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_width</span> <span class="o">=</span> <span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">&gt;</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_height</span><span class="p">)</span>
				<span class="n">sizes</span><span class="p">.</span><span class="n">surface_height</span> <span class="o">=</span> <span class="n">desired_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
			<span class="n">crtc_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sizes</span><span class="p">.</span><span class="n">fb_width</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">sizes</span><span class="p">.</span><span class="n">fb_height</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* hmm everyone went away - assume VGA cable just fell out</span>
<span class="cm">		   and will come back later. */</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Cannot find any crtc or sizes - going 1024x768</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sizes</span><span class="p">.</span><span class="n">fb_width</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_width</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">sizes</span><span class="p">.</span><span class="n">fb_height</span> <span class="o">=</span> <span class="n">sizes</span><span class="p">.</span><span class="n">surface_height</span> <span class="o">=</span> <span class="mi">768</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* push down into drivers */</span>
	<span class="n">new_fb</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">fb_probe</span><span class="p">)(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sizes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_fb</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">new_fb</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>

	<span class="cm">/* set the fb pointer */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">.</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">pixclock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;fb%d: %s frame buffer device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">drm_fb_helper_set_par</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Switch back to kernel console on panic */</span>
	<span class="cm">/* multi card linked list maybe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kernel_fb_helper_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;drm: registered panic notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">panic_notifier_list</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">paniced</span><span class="p">);</span>
		<span class="n">register_sysrq_key</span><span class="p">(</span><span class="sc">&#39;v&#39;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysrq_drm_fb_helper_restore_op</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_fb</span><span class="p">)</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">kernel_fb_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kernel_fb_helper_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_single_fb_probe</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_fb_helper_fill_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pitch</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span>
		<span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* doing it in hw */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* doing it in hw */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_fill_fix</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_fb_helper_fill_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
			    <span class="kt">uint32_t</span> <span class="n">fb_width</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">fb_height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 8bit DAC */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">fb_width</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">fb_height</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_fill_var</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_fb_helper_probe_connector_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
					       <span class="kt">uint32_t</span> <span class="n">maxX</span><span class="p">,</span>
					       <span class="kt">uint32_t</span> <span class="n">maxY</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">fill_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span> <span class="n">maxY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="nf">drm_has_preferred_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_connector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_connector</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drm_mode_width</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span> <span class="o">||</span>
		    <span class="n">drm_mode_height</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">height</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">drm_has_cmdline_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_cmdline_mode</span> <span class="o">*</span><span class="n">cmdline_mode</span><span class="p">;</span>
	<span class="n">cmdline_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_connector</span><span class="o">-&gt;</span><span class="n">cmdline_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">specified</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="nf">drm_pick_cmdline_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_helper_conn</span><span class="p">,</span>
						      <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_cmdline_mode</span> <span class="o">*</span><span class="n">cmdline_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmdline_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">cmdline_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">specified</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* attempt to find a matching mode in the list of modes</span>
<span class="cm">	 *  we have gotten so far, if not add a CVT mode that conforms</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">rb</span> <span class="o">||</span> <span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">margins</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">create_mode</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check width/height */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">!=</span> <span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span>
		    <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">!=</span> <span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">refresh_specified</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vrefresh</span> <span class="o">!=</span> <span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">refresh</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmdline_mode</span><span class="o">-&gt;</span><span class="n">interlace</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">create_mode:</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">drm_mode_create_from_cmdline_mode</span><span class="p">(</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">cmdline_mode</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">drm_connector_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="n">bool</span> <span class="n">strict</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">enable</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_enable_connectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="o">*</span><span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">any_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">;</span>
		<span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm_connector_enabled</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;connector %d enabled? %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			  <span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
		<span class="n">any_enabled</span> <span class="o">|=</span> <span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">any_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">;</span>
		<span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm_connector_enabled</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">drm_target_cloned</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">**</span><span class="n">modes</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="o">*</span><span class="n">enabled</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">can_clone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_helper_conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">dmt_mode</span><span class="p">,</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* only contemplate cloning in the single crtc case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* only contemplate cloning if more than one connector is enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* check the command line or if nothing common pick 1024x768 */</span>
	<span class="n">can_clone</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">fb_helper_conn</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm_pick_cmdline_mode</span><span class="p">(</span><span class="n">fb_helper_conn</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">can_clone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_mode_equal</span><span class="p">(</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="n">can_clone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">can_clone</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;can clone using command line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* try and find a 1024x768 mode on each connector */</span>
	<span class="n">can_clone</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">dmt_mode</span> <span class="o">=</span> <span class="n">drm_mode_find_dmt</span><span class="p">(</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">fb_helper_conn</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">drm_mode_equal</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dmt_mode</span><span class="p">))</span>
				<span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">can_clone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">can_clone</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;can clone using 1024x768</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;kms: can&#39;t enable cloning when we probably wanted to.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">drm_target_preferred</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">**</span><span class="n">modes</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">enabled</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_helper_conn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_helper_conn</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;looking for cmdline mode on connector %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

		<span class="cm">/* got for command line mode first */</span>
		<span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm_pick_cmdline_mode</span><span class="p">(</span><span class="n">fb_helper_conn</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;looking for preferred mode on connector %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm_has_preferred_mode</span><span class="p">(</span><span class="n">fb_helper_conn</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* No preferred modes, pick one off the list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;found mode %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span>
			  <span class="s">&quot;none&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_pick_crtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">**</span><span class="n">best_crtcs</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">**</span><span class="n">modes</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">o</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector_helper_funcs</span> <span class="o">*</span><span class="n">connector_funcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">*</span><span class="n">best_crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">my_score</span><span class="p">,</span> <span class="n">best_score</span><span class="p">,</span> <span class="n">score</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">**</span><span class="n">crtcs</span><span class="p">,</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_connector</span> <span class="o">*</span><span class="n">fb_helper_conn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fb_helper_conn</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="n">fb_helper_conn</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">;</span>

	<span class="n">best_crtcs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">best_crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">best_score</span> <span class="o">=</span> <span class="n">drm_pick_crtcs</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">best_crtcs</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modes</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">best_score</span><span class="p">;</span>

	<span class="n">crtcs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">best_score</span><span class="p">;</span>

	<span class="n">my_score</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_connected</span><span class="p">)</span>
		<span class="n">my_score</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_has_cmdline_mode</span><span class="p">(</span><span class="n">fb_helper_conn</span><span class="p">))</span>
		<span class="n">my_score</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_has_preferred_mode</span><span class="p">(</span><span class="n">fb_helper_conn</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
		<span class="n">my_score</span><span class="o">++</span><span class="p">;</span>

	<span class="n">connector_funcs</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="n">encoder</span> <span class="o">=</span> <span class="n">connector_funcs</span><span class="o">-&gt;</span><span class="n">best_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoder</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* select a crtc for this connector and then attempt to configure</span>
<span class="cm">	   remaining connectors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">o</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">best_crtcs</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">==</span> <span class="n">crtc</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ignore cloning unless only a single crtc */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_mode_equal</span><span class="p">(</span><span class="n">modes</span><span class="p">[</span><span class="n">o</span><span class="p">],</span> <span class="n">modes</span><span class="p">[</span><span class="n">n</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">crtcs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">crtcs</span><span class="p">,</span> <span class="n">best_crtcs</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">*</span><span class="p">));</span>
		<span class="n">score</span> <span class="o">=</span> <span class="n">my_score</span> <span class="o">+</span> <span class="n">drm_pick_crtcs</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">crtcs</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						  <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
			<span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">best_crtcs</span><span class="p">,</span> <span class="n">crtcs</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span> <span class="o">*</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">*</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">crtcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">best_score</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_setup_crtcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">**</span><span class="n">crtcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">**</span><span class="n">modes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">modeset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="o">*</span><span class="n">enabled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span><span class="p">;</span>

	<span class="cm">/* clean out all the encoder/crtc combos */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtcs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">modes</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="n">bool</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">drm_enable_connectors</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_target_cloned</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_target_preferred</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unable to find initial modes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;picking CRTCs for %dx%d config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="n">drm_pick_crtcs</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">crtcs</span><span class="p">,</span> <span class="n">modes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="cm">/* need to set the modesets up here for use later */</span>
	<span class="cm">/* fill out the connector&lt;-&gt;crtc mappings into the modesets */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modeset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">crtc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode_set</span><span class="p">;</span>
		<span class="n">modeset</span><span class="o">-&gt;</span><span class="n">num_connectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">drm_fb_helper_crtc</span> <span class="o">*</span><span class="n">fb_crtc</span> <span class="o">=</span> <span class="n">crtcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">modeset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fb_crtc</span><span class="o">-&gt;</span><span class="n">mode_set</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">fb_crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;desired mode %s set on crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fb_crtc</span><span class="o">-&gt;</span><span class="n">mode_set</span><span class="p">.</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="n">fb_crtc</span><span class="o">-&gt;</span><span class="n">desired_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">modeset</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
				<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">modeset</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
			<span class="n">modeset</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">fb_crtc</span><span class="o">-&gt;</span><span class="n">desired_mode</span><span class="p">);</span>
			<span class="n">modeset</span><span class="o">-&gt;</span><span class="n">connectors</span><span class="p">[</span><span class="n">modeset</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">connector_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">connector</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">crtcs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">modes</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_helper_initial_config - setup a sane initial connector configuration</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Called at init time, must take mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Scan the CRTCs and connectors and try to put together an initial setup.</span>
<span class="cm"> * At the moment, this is a cloned configuration across all heads with</span>
<span class="cm"> * a new framebuffer object as the backing store.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero if everything went ok, nonzero otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">drm_fb_helper_initial_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp_sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disable all the possible outputs/crtcs before entering KMS mode */</span>
	<span class="n">drm_helper_disable_unused_functions</span><span class="p">(</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">drm_fb_helper_parse_command_line</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">drm_fb_helper_probe_connector_modes</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span>
						    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span><span class="p">,</span>
						    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * we shouldn&#39;t end up with no modes here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;No connectors reported connected with modes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drm_setup_crtcs</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drm_fb_helper_single_fb_probe</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">bpp_sel</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_initial_config</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_fb_helper_hotplug_event - respond to a hotplug notification by</span>
<span class="cm"> *                               probing all the outputs attached to the fb.</span>
<span class="cm"> * @fb_helper: the drm_fb_helper</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Called at runtime, must take mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Scan the connectors attached to the fb_helper and try to put together a</span>
<span class="cm"> * setup after *notification of a change in output configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * 0 on success and a non-zero error code otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_fb_helper_hotplug_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">fb_helper</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_width</span><span class="p">,</span> <span class="n">max_height</span><span class="p">,</span> <span class="n">bpp_sel</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bound</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">crtcs_bound</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
			<span class="n">crtcs_bound</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
			<span class="n">bound</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bound</span> <span class="o">&amp;&amp;</span> <span class="n">crtcs_bound</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">delayed_hotplug</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">max_width</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">max_height</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">bpp_sel</span> <span class="o">=</span> <span class="n">fb_helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">drm_fb_helper_probe_connector_modes</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">max_width</span><span class="p">,</span>
						    <span class="n">max_height</span><span class="p">);</span>
	<span class="n">drm_setup_crtcs</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drm_fb_helper_single_fb_probe</span><span class="p">(</span><span class="n">fb_helper</span><span class="p">,</span> <span class="n">bpp_sel</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_helper_hotplug_event</span><span class="p">);</span>

<span class="cm">/* The Kconfig DRM_KMS_HELPER selects FRAMEBUFFER_CONSOLE (if !EXPERT)</span>
<span class="cm"> * but the module doesn&#39;t depend on any fb console symbols.  At least</span>
<span class="cm"> * attempt to load fbcon to avoid leaving the system without a usable console.</span>
<span class="cm"> */</span>
<span class="cp">#if defined(CONFIG_FRAMEBUFFER_CONSOLE_MODULE) &amp;&amp; !defined(CONFIG_EXPERT)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">drm_fb_helper_modinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fbcon&quot;</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">fbcon</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>
	<span class="n">fbcon</span> <span class="o">=</span> <span class="n">find_module</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">module_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fbcon</span><span class="p">)</span>
		<span class="n">request_module_nowait</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">drm_fb_helper_modinit</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
