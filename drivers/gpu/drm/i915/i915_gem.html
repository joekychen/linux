<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › i915_gem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>i915_gem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2008 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;i915_trace.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &lt;linux/shmem_fs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/swap.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-buf.h&gt;</span>

<span class="k">static</span> <span class="n">__must_check</span> <span class="kt">int</span> <span class="n">i915_gem_object_flush_gpu_write_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i915_gem_object_flush_gtt_write_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i915_gem_object_flush_cpu_write_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="k">static</span> <span class="n">__must_check</span> <span class="kt">int</span> <span class="n">i915_gem_object_bind_to_gtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
						    <span class="kt">unsigned</span> <span class="n">alignment</span><span class="p">,</span>
						    <span class="n">bool</span> <span class="n">map_and_fenceable</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">i915_gem_phys_pwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_i915_gem_pwrite</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">i915_gem_write_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i915_gem_object_update_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span><span class="n">fence</span><span class="p">,</span>
					 <span class="n">bool</span> <span class="n">enable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i915_gem_inactive_shrink</span><span class="p">(</span><span class="k">struct</span> <span class="n">shrinker</span> <span class="o">*</span><span class="n">shrinker</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">shrink_control</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">i915_gem_object_truncate</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">i915_gem_object_fence_lost</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">)</span>
		<span class="n">i915_gem_release_mmap</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="cm">/* As we do not have an associated fence register, we will force</span>
<span class="cm">	 * a tiling change if we ever need to acquire one.</span>
<span class="cm">	 */</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">=</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* some bookkeeping */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_info_add_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">object_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">object_memory</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_info_remove_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">object_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">object_memory</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_wait_for_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_completion</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* GPU is hung, bump the completion count to account for</span>
<span class="cm">		 * the token we just consumed so that we never hit zero and</span>
<span class="cm">		 * end up waiting upon a subsequent completion event that</span>
<span class="cm">		 * will never happen.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">x</span><span class="o">-&gt;</span><span class="n">done</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_wait_for_error</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">i915_verify_lists</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span>
<span class="nf">i915_gem_object_is_inactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_init_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_init</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">gtt_start</span> <span class="o">&gt;=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">gtt_end</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">gtt_end</span> <span class="o">|</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">gtt_start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* GEM with user mode setting was never supported on ilk and later. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">i915_gem_init_global_gtt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">gtt_start</span><span class="p">,</span>
				 <span class="n">args</span><span class="o">-&gt;</span><span class="n">gtt_end</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">gtt_end</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_get_aperture_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_get_aperture</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">pinned</span><span class="p">;</span>

	<span class="n">pinned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">,</span> <span class="n">gtt_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span>
			<span class="n">pinned</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">aper_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_total</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">aper_available_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">aper_size</span> <span class="o">-</span> <span class="n">pinned</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="kt">uint64_t</span> <span class="n">size</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">handle_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Allocate the new object */</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">i915_gem_alloc_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_gem_handle_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_gem_object_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">i915_gem_info_remove_obj</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* drop reference from allocate - handle holds it now */</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">trace_i915_gem_object_create</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="o">*</span><span class="n">handle_p</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_dumb_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_mode_create_dumb</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* have to work out size/pitch and return them */</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="p">((</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i915_gem_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			       <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_gem_dumb_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drm_gem_handle_delete</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Creates a new mm object and returns a handle to it.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_create_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_create</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i915_gem_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			       <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_object_needs_bit17_swizzle</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">bit_6_swizzle_x</span> <span class="o">==</span> <span class="n">I915_BIT_6_SWIZZLE_9_10_17</span> <span class="o">&amp;&amp;</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">!=</span> <span class="n">I915_TILING_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">__copy_to_user_swizzled</span><span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cpu_vaddr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">gpu_vaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpu_offset</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">cpu_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cacheline_end</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">gpu_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">this_length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cacheline_end</span> <span class="o">-</span> <span class="n">gpu_offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">swizzled_gpu_offset</span> <span class="o">=</span> <span class="n">gpu_offset</span> <span class="o">^</span> <span class="mi">64</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="n">cpu_vaddr</span> <span class="o">+</span> <span class="n">cpu_offset</span><span class="p">,</span>
				     <span class="n">gpu_vaddr</span> <span class="o">+</span> <span class="n">swizzled_gpu_offset</span><span class="p">,</span>
				     <span class="n">this_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">cpu_offset</span> <span class="o">+=</span> <span class="n">this_length</span><span class="p">;</span>
		<span class="n">gpu_offset</span> <span class="o">+=</span> <span class="n">this_length</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">this_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">__copy_from_user_swizzled</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">gpu_vaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gpu_offset</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">cpu_vaddr</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">cpu_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cacheline_end</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">gpu_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">this_length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cacheline_end</span> <span class="o">-</span> <span class="n">gpu_offset</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">swizzled_gpu_offset</span> <span class="o">=</span> <span class="n">gpu_offset</span> <span class="o">^</span> <span class="mi">64</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="n">gpu_vaddr</span> <span class="o">+</span> <span class="n">swizzled_gpu_offset</span><span class="p">,</span>
				       <span class="n">cpu_vaddr</span> <span class="o">+</span> <span class="n">cpu_offset</span><span class="p">,</span>
				       <span class="n">this_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">cpu_offset</span> <span class="o">+=</span> <span class="n">this_length</span><span class="p">;</span>
		<span class="n">gpu_offset</span> <span class="o">+=</span> <span class="n">this_length</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">this_length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Per-page copy function for the shmem pread fastpath.</span>
<span class="cm"> * Flushes invalid cachelines before reading the target if</span>
<span class="cm"> * needs_clflush is set. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">shmem_pread_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_length</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">,</span>
		 <span class="n">bool</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span> <span class="n">bool</span> <span class="n">needs_clflush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">page_do_bit17_swizzling</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_clflush</span><span class="p">)</span>
		<span class="n">drm_clflush_virt_range</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
				       <span class="n">page_length</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_to_user_inatomic</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span>
				      <span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
				      <span class="n">page_length</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">shmem_clflush_swizzled_range</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">swizzled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">swizzled</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>

		<span class="cm">/* For swizzling simply ensure that we always flush both</span>
<span class="cm">		 * channels. Lame, but simple and it works. Swizzled</span>
<span class="cm">		 * pwrite/pread is far from a hotpath - current userspace</span>
<span class="cm">		 * doesn&#39;t use it at all. */</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">round_down</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

		<span class="n">drm_clflush_virt_range</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">drm_clflush_virt_range</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* Only difference to the fast-path function is that this can handle bit17</span>
<span class="cm"> * and uses non-atomic copy and kmap functions. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">shmem_pread_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_length</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">,</span>
		 <span class="n">bool</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span> <span class="n">bool</span> <span class="n">needs_clflush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_clflush</span><span class="p">)</span>
		<span class="n">shmem_clflush_swizzled_range</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
					     <span class="n">page_length</span><span class="p">,</span>
					     <span class="n">page_do_bit17_swizzling</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_do_bit17_swizzling</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_to_user_swizzled</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span>
					      <span class="n">vaddr</span><span class="p">,</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
					      <span class="n">page_length</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_to_user</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span>
				     <span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
				     <span class="n">page_length</span><span class="p">);</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_shmem_pread</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_i915_gem_pread</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">remain</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="n">page_length</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">obj_do_bit17_swizzling</span><span class="p">,</span> <span class="n">page_do_bit17_swizzling</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hit_slowpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prefaulted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_clflush</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release_page</span><span class="p">;</span>

	<span class="n">user_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">data_ptr</span><span class="p">;</span>
	<span class="n">remain</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="n">obj_do_bit17_swizzling</span> <span class="o">=</span> <span class="n">i915_gem_object_needs_bit17_swizzle</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If we&#39;re not in the cpu read domain, set ourself into the gtt</span>
<span class="cm">		 * read domain and manually flush cachelines (if required). This</span>
<span class="cm">		 * optimizes for the case when the gpu will dirty the data</span>
<span class="cm">		 * anyway again before the next pread happens. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">==</span> <span class="n">I915_CACHE_NONE</span><span class="p">)</span>
			<span class="n">needs_clflush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

		<span class="cm">/* Operation in this page</span>
<span class="cm">		 *</span>
<span class="cm">		 * shmem_page_offset = offset within page in shmem file</span>
<span class="cm">		 * page_length = bytes to copy for this page</span>
<span class="cm">		 */</span>
		<span class="n">shmem_page_offset</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">page_length</span> <span class="o">=</span> <span class="n">remain</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">shmem_page_offset</span> <span class="o">+</span> <span class="n">page_length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">page_length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">shmem_page_offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">];</span>
			<span class="n">release_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">shmem_read_mapping_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">release_page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">page_do_bit17_swizzling</span> <span class="o">=</span> <span class="n">obj_do_bit17_swizzling</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">page_to_phys</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">shmem_pread_fast</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="n">page_length</span><span class="p">,</span>
				       <span class="n">user_data</span><span class="p">,</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span>
				       <span class="n">needs_clflush</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next_page</span><span class="p">;</span>

		<span class="n">hit_slowpath</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">page_cache_get</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prefaulted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fault_in_multipages_writeable</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="n">remain</span><span class="p">);</span>
			<span class="cm">/* Userspace is tricking us, but we&#39;ve already clobbered</span>
<span class="cm">			 * its pages with the prefault and promised to write the</span>
<span class="cm">			 * data up to the first fault. Hence ignore any errors</span>
<span class="cm">			 * and just continue. */</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>
			<span class="n">prefaulted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">shmem_pread_slow</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="n">page_length</span><span class="p">,</span>
				       <span class="n">user_data</span><span class="p">,</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span>
				       <span class="n">needs_clflush</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="nl">next_page:</span>
		<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">release_page</span><span class="p">)</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">remain</span> <span class="o">-=</span> <span class="n">page_length</span><span class="p">;</span>
		<span class="n">user_data</span> <span class="o">+=</span> <span class="n">page_length</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">page_length</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hit_slowpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fixup: Kill any reinstated backing storage pages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">==</span> <span class="n">__I915_MADV_PURGED</span><span class="p">)</span>
			<span class="n">i915_gem_object_truncate</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Reads data from the object referenced by handle.</span>
<span class="cm"> *</span>
<span class="cm"> * On error, the contents of *data are undefined.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_pread_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_pread</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">data_ptr</span><span class="p">,</span>
		       <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bounds check source.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">||</span>
	    <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prime objects have no backing filp to GEM pread/pwrite</span>
<span class="cm">	 * pages from.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_i915_gem_object_pread</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_shmem_pread</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is the fast write path which cannot handle</span>
<span class="cm"> * page faults in the source data</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">fast_user_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">io_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
		<span class="n">loff_t</span> <span class="n">page_base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_offset</span><span class="p">,</span>
		<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vaddr_atomic</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unwritten</span><span class="p">;</span>

	<span class="n">vaddr_atomic</span> <span class="o">=</span> <span class="n">io_mapping_map_atomic_wc</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">page_base</span><span class="p">);</span>
	<span class="cm">/* We can use the cpu mem copy function because this is X86. */</span>
	<span class="n">vaddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span><span class="o">*</span><span class="p">)</span><span class="n">vaddr_atomic</span> <span class="o">+</span> <span class="n">page_offset</span><span class="p">;</span>
	<span class="n">unwritten</span> <span class="o">=</span> <span class="n">__copy_from_user_inatomic_nocache</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span>
						      <span class="n">user_data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="n">io_mapping_unmap_atomic</span><span class="p">(</span><span class="n">vaddr_atomic</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">unwritten</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This is the fast pwrite path, where we copy the data directly from the</span>
<span class="cm"> * user into the GTT, uncached.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_gtt_pwrite_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_i915_gem_pwrite</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">remain</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">page_base</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_offset</span><span class="p">,</span> <span class="n">page_length</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_put_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>

	<span class="n">user_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">data_ptr</span><span class="p">;</span>
	<span class="n">remain</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Operation in this page</span>
<span class="cm">		 *</span>
<span class="cm">		 * page_base = page offset within aperture</span>
<span class="cm">		 * page_offset = offset within page</span>
<span class="cm">		 * page_length = bytes to copy for this page</span>
<span class="cm">		 */</span>
		<span class="n">page_base</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
		<span class="n">page_offset</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">page_length</span> <span class="o">=</span> <span class="n">remain</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">page_offset</span> <span class="o">+</span> <span class="n">remain</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">page_length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">page_offset</span><span class="p">;</span>

		<span class="cm">/* If we get a fault while copying data, then (presumably) our</span>
<span class="cm">		 * source page isn&#39;t available.  Return the error and we&#39;ll</span>
<span class="cm">		 * retry in the slow path.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fast_user_write</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span><span class="p">,</span> <span class="n">page_base</span><span class="p">,</span>
				    <span class="n">page_offset</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">page_length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">remain</span> <span class="o">-=</span> <span class="n">page_length</span><span class="p">;</span>
		<span class="n">user_data</span> <span class="o">+=</span> <span class="n">page_length</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">page_length</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_unpin:</span>
	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Per-page copy function for the shmem pwrite fastpath.</span>
<span class="cm"> * Flushes invalid cachelines before writing to the target if</span>
<span class="cm"> * needs_clflush_before is set and flushes out any written cachelines after</span>
<span class="cm"> * writing if needs_clflush is set. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">shmem_pwrite_fast</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_length</span><span class="p">,</span>
		  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">needs_clflush_before</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">needs_clflush_after</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">page_do_bit17_swizzling</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_clflush_before</span><span class="p">)</span>
		<span class="n">drm_clflush_virt_range</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
				       <span class="n">page_length</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_from_user_inatomic_nocache</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
						<span class="n">user_data</span><span class="p">,</span>
						<span class="n">page_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_clflush_after</span><span class="p">)</span>
		<span class="n">drm_clflush_virt_range</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
				       <span class="n">page_length</span><span class="p">);</span>
	<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">vaddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Only difference to the fast-path function is that this can handle bit17</span>
<span class="cm"> * and uses non-atomic copy and kmap functions. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">shmem_pwrite_slow</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">page_length</span><span class="p">,</span>
		  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">needs_clflush_before</span><span class="p">,</span>
		  <span class="n">bool</span> <span class="n">needs_clflush_after</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">kmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">needs_clflush_before</span> <span class="o">||</span> <span class="n">page_do_bit17_swizzling</span><span class="p">))</span>
		<span class="n">shmem_clflush_swizzled_range</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
					     <span class="n">page_length</span><span class="p">,</span>
					     <span class="n">page_do_bit17_swizzling</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page_do_bit17_swizzling</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_from_user_swizzled</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
						<span class="n">user_data</span><span class="p">,</span>
						<span class="n">page_length</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__copy_from_user</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
				       <span class="n">user_data</span><span class="p">,</span>
				       <span class="n">page_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">needs_clflush_after</span><span class="p">)</span>
		<span class="n">shmem_clflush_swizzled_range</span><span class="p">(</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">shmem_page_offset</span><span class="p">,</span>
					     <span class="n">page_length</span><span class="p">,</span>
					     <span class="n">page_do_bit17_swizzling</span><span class="p">);</span>
	<span class="n">kunmap</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_shmem_pwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_i915_gem_pwrite</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">remain</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="n">page_length</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">obj_do_bit17_swizzling</span><span class="p">,</span> <span class="n">page_do_bit17_swizzling</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hit_slowpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_clflush_after</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">needs_clflush_before</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">release_page</span><span class="p">;</span>

	<span class="n">user_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">data_ptr</span><span class="p">;</span>
	<span class="n">remain</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="n">obj_do_bit17_swizzling</span> <span class="o">=</span> <span class="n">i915_gem_object_needs_bit17_swizzle</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">!=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we&#39;re not in the cpu write domain, set ourself into the gtt</span>
<span class="cm">		 * write domain and manually flush cachelines (if required). This</span>
<span class="cm">		 * optimizes for the case when the gpu will use the data</span>
<span class="cm">		 * right away and we therefore have to clflush anyway. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">==</span> <span class="n">I915_CACHE_NONE</span><span class="p">)</span>
			<span class="n">needs_clflush_after</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Same trick applies for invalidate partially written cachelines before</span>
<span class="cm">	 * writing.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">==</span> <span class="n">I915_CACHE_NONE</span><span class="p">)</span>
		<span class="n">needs_clflush_before</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">remain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">partial_cacheline_write</span><span class="p">;</span>

		<span class="cm">/* Operation in this page</span>
<span class="cm">		 *</span>
<span class="cm">		 * shmem_page_offset = offset within page in shmem file</span>
<span class="cm">		 * page_length = bytes to copy for this page</span>
<span class="cm">		 */</span>
		<span class="n">shmem_page_offset</span> <span class="o">=</span> <span class="n">offset_in_page</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

		<span class="n">page_length</span> <span class="o">=</span> <span class="n">remain</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">shmem_page_offset</span> <span class="o">+</span> <span class="n">page_length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">page_length</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">shmem_page_offset</span><span class="p">;</span>

		<span class="cm">/* If we don&#39;t overwrite a cacheline completely we need to be</span>
<span class="cm">		 * careful to have up-to-date data by first clflushing. Don&#39;t</span>
<span class="cm">		 * overcomplicate things and flush the entire patch. */</span>
		<span class="n">partial_cacheline_write</span> <span class="o">=</span> <span class="n">needs_clflush_before</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">shmem_page_offset</span> <span class="o">|</span> <span class="n">page_length</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_clflush_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">];</span>
			<span class="n">release_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">page</span> <span class="o">=</span> <span class="n">shmem_read_mapping_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">release_page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">page_do_bit17_swizzling</span> <span class="o">=</span> <span class="n">obj_do_bit17_swizzling</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">page_to_phys</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">shmem_pwrite_fast</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="n">page_length</span><span class="p">,</span>
					<span class="n">user_data</span><span class="p">,</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span>
					<span class="n">partial_cacheline_write</span><span class="p">,</span>
					<span class="n">needs_clflush_after</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next_page</span><span class="p">;</span>

		<span class="n">hit_slowpath</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">page_cache_get</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">shmem_pwrite_slow</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">shmem_page_offset</span><span class="p">,</span> <span class="n">page_length</span><span class="p">,</span>
					<span class="n">user_data</span><span class="p">,</span> <span class="n">page_do_bit17_swizzling</span><span class="p">,</span>
					<span class="n">partial_cacheline_write</span><span class="p">,</span>
					<span class="n">needs_clflush_after</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="nl">next_page:</span>
		<span class="n">set_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">release_page</span><span class="p">)</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">remain</span> <span class="o">-=</span> <span class="n">page_length</span><span class="p">;</span>
		<span class="n">user_data</span> <span class="o">+=</span> <span class="n">page_length</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">page_length</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hit_slowpath</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fixup: Kill any reinstated backing storage pages */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">==</span> <span class="n">__I915_MADV_PURGED</span><span class="p">)</span>
			<span class="n">i915_gem_object_truncate</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="cm">/* and flush dirty cachelines in case the object isn&#39;t in the cpu write</span>
<span class="cm">		 * domain anymore. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">!=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i915_gem_clflush_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
			<span class="n">intel_gtt_chipset_flush</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needs_clflush_after</span><span class="p">)</span>
		<span class="n">intel_gtt_chipset_flush</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Writes data to the object referenced by handle.</span>
<span class="cm"> *</span>
<span class="cm"> * On error, the contents of the buffer that were to be modified are undefined.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_pwrite_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_pwrite</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">data_ptr</span><span class="p">,</span>
		       <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fault_in_multipages_readable</span><span class="p">((</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">data_ptr</span><span class="p">,</span>
					   <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bounds check destination. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">||</span>
	    <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prime objects have no backing filp to GEM pread/pwrite</span>
<span class="cm">	 * pages from.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_i915_gem_object_pwrite</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="cm">/* We can only do the GTT pwrite on untiled buffers, as otherwise</span>
<span class="cm">	 * it would end up going through the fenced access, and we&#39;ll get</span>
<span class="cm">	 * different detiling behavior between reading and writing.</span>
<span class="cm">	 * pread/pwrite currently are reading and writing from the CPU</span>
<span class="cm">	 * perspective, requiring manual detiling by the client.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_phys_pwrite</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">&amp;&amp;</span>
	    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">==</span> <span class="n">I915_CACHE_NONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_NONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span> <span class="o">&amp;&amp;</span>
	    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">!=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_gtt_pwrite_fast</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="cm">/* Note that the gtt paths might fail with non-page-backed user</span>
<span class="cm">		 * pointers (e.g. gtt mappings when moving data between</span>
<span class="cm">		 * textures). Fallback to the shmem path in that case. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_shmem_pwrite</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called when user space prepares to use an object with the CPU, either</span>
<span class="cm"> * through the mmap ioctl&#39;s mapping or a GTT mapping.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_set_domain_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_set_domain</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">read_domains</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">read_domains</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">write_domain</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">write_domain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Only handle setting domains to types used by the CPU. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Having something in the write domain implies it&#39;s in the read</span>
<span class="cm">	 * domain, and only that read domain.  Enforce that in the request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_domain</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">read_domains</span> <span class="o">!=</span> <span class="n">write_domain</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">write_domain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Silently promote &quot;you&#39;re not bound, there was nothing to do&quot;</span>
<span class="cm">		 * to success, since the client was just asking us to</span>
<span class="cm">		 * make sure everything was done.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_cpu_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">write_domain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called when user space has done writes to this buffer</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_sw_finish_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_sw_finish</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pinned buffers may be scanout, so flush the cache */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span>
		<span class="n">i915_gem_object_flush_cpu_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Maps the contents of an object, returning the address it is mapped</span>
<span class="cm"> * into.</span>
<span class="cm"> *</span>
<span class="cm"> * While the mapping holds a reference on the contents of the object, it doesn&#39;t</span>
<span class="cm"> * imply a ref on the object itself.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_mmap_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_mmap</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="cm">/* prime objects have no backing filp to GEM mmap</span>
<span class="cm">	 * pages from.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">filp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">vm_mmap</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">filp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
		       <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span>
		       <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">addr_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gem_fault - fault a page into the GTT</span>
<span class="cm"> * vma: VMA in question</span>
<span class="cm"> * vmf: fault info</span>
<span class="cm"> *</span>
<span class="cm"> * The fault handler is set up by drm_gem_mmap() when a object is GTT mapped</span>
<span class="cm"> * from userspace.  The fault handler takes care of binding the object to</span>
<span class="cm"> * the GTT (if needed), allocating and programming a fence register (again,</span>
<span class="cm"> * only if needed based on whether the old reg is still valid or the object</span>
<span class="cm"> * is tiled) and inserting a new PTE into the faulting process.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the faulting process may involve evicting existing objects</span>
<span class="cm"> * from the GTT and/or fence registers to make room.  So performance may</span>
<span class="cm"> * suffer if the GTT working set is large or there are few fence registers</span>
<span class="cm"> * left.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i915_gem_fault</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_fault</span> <span class="o">*</span><span class="n">vmf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">pgoff_t</span> <span class="n">page_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">write</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">vmf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FAULT_FLAG_WRITE</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t use vmf-&gt;pgoff since that has the fake offset */</span>
	<span class="n">page_offset</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vmf</span><span class="o">-&gt;</span><span class="n">virtual_address</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_fault</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">page_offset</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>

	<span class="cm">/* Now bind it into the GTT if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_unbind</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_bind_to_gtt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">has_global_gtt_mapping</span><span class="p">)</span>
		<span class="n">i915_gem_gtt_bind_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_get_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_is_inactive</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fault_mappable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">pfn</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">page_offset</span><span class="p">;</span>

	<span class="cm">/* Finally, remap it using the new GTT offset */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vm_insert_pfn</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vmf</span><span class="o">-&gt;</span><span class="n">virtual_address</span><span class="p">,</span> <span class="n">pfn</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
		<span class="cm">/* Give the error handler a chance to run and move the</span>
<span class="cm">		 * objects off the GPU active list. Next time we service the</span>
<span class="cm">		 * fault, we should be able to transition the page into the</span>
<span class="cm">		 * GTT without touching the GPU (and so avoid further</span>
<span class="cm">		 * EIO/EGAIN). If the GPU is wedged, then there is no issue</span>
<span class="cm">		 * with coherency, just lost writes.</span>
<span class="cm">		 */</span>
		<span class="n">set_need_resched</span><span class="p">();</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ERESTARTSYS</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">EINTR</span>:
		<span class="k">return</span> <span class="n">VM_FAULT_NOPAGE</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="k">return</span> <span class="n">VM_FAULT_OOM</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">VM_FAULT_SIGBUS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gem_release_mmap - remove physical page mappings</span>
<span class="cm"> * @obj: obj in question</span>
<span class="cm"> *</span>
<span class="cm"> * Preserve the reservation of the mmapping with the DRM core code, but</span>
<span class="cm"> * relinquish ownership of the pages back to the system.</span>
<span class="cm"> *</span>
<span class="cm"> * It is vital that we remove the page mapping if we have mapped a tiled</span>
<span class="cm"> * object through the GTT and then lose the fence register due to</span>
<span class="cm"> * resource pressure. Similarly if the object has been moved out of the</span>
<span class="cm"> * aperture, than pages mapped into userspace must be revoked. Removing the</span>
<span class="cm"> * mapping will then trigger a page fault on the next user access, allowing</span>
<span class="cm"> * fixup by i915_gem_fault().</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">i915_gem_release_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fault_mappable</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_mapping</span><span class="p">)</span>
		<span class="n">unmap_mapping_range</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_mapping</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">map_list</span><span class="p">.</span><span class="n">hash</span><span class="p">.</span><span class="n">key</span><span class="o">&lt;&lt;</span><span class="n">PAGE_SHIFT</span><span class="p">,</span>
				    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fault_mappable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">i915_gem_get_gtt_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tiling_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">gtt_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">||</span>
	    <span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Previous chips need a power-of-two fence region when tiling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">gtt_size</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gtt_size</span> <span class="o">=</span> <span class="mi">512</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">gtt_size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="n">gtt_size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">gtt_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gem_get_gtt_alignment - return required GTT alignment for an object</span>
<span class="cm"> * @obj: object to check</span>
<span class="cm"> *</span>
<span class="cm"> * Return the required GTT alignment for an object, taking into account</span>
<span class="cm"> * potential fence register mapping.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">i915_gem_get_gtt_alignment</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">tiling_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Minimum alignment is 4k (GTT page size), but might be greater</span>
<span class="cm">	 * if a fence register is needed for the object.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">||</span>
	    <span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4096</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Previous chips need to be aligned to the size of the smallest</span>
<span class="cm">	 * fence register that can contain the object.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">i915_gem_get_gtt_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tiling_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gem_get_unfenced_gtt_alignment - return required GTT alignment for an</span>
<span class="cm"> *					 unfenced object</span>
<span class="cm"> * @dev: the device</span>
<span class="cm"> * @size: size of the object</span>
<span class="cm"> * @tiling_mode: tiling mode of the object</span>
<span class="cm"> *</span>
<span class="cm"> * Return the required GTT alignment for an object, only taking into account</span>
<span class="cm"> * unfenced tiled surface requirements.</span>
<span class="cm"> */</span>
<span class="kt">uint32_t</span>
<span class="nf">i915_gem_get_unfenced_gtt_alignment</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">tiling_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Minimum alignment is 4k (GTT page size) for sane hw.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">IS_G33</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">4096</span><span class="p">;</span>

	<span class="cm">/* Previous hardware however needs to be aligned to a power-of-two</span>
<span class="cm">	 * tile height. The simplest method for determining this is to reuse</span>
<span class="cm">	 * the power-of-tile object size.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">i915_gem_get_gtt_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tiling_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_mmap_gtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		  <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">,</span>
		  <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mappable_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">!=</span> <span class="n">I915_MADV_WILLNEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to mmap a purgeable buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">map_list</span><span class="p">.</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_gem_create_mmap_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">map_list</span><span class="p">.</span><span class="n">hash</span><span class="p">.</span><span class="n">key</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gem_mmap_gtt_ioctl - prepare an object for GTT mmap&#39;ing</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @data: GTT mapping ioctl data</span>
<span class="cm"> * @file: GEM object info</span>
<span class="cm"> *</span>
<span class="cm"> * Simply returns the fake offset to userspace so it can mmap it.</span>
<span class="cm"> * The mmap call will end up in drm_gem_mmap(), which will set things</span>
<span class="cm"> * up so we can get faults in the handler above.</span>
<span class="cm"> *</span>
<span class="cm"> * The fault handler will take care of binding the object into the GTT</span>
<span class="cm"> * (since it may have been evicted to make room for something), allocating</span>
<span class="cm"> * a fence register, and mapping the appropriate aperture address into</span>
<span class="cm"> * userspace.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_mmap_gtt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_mmap_gtt</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i915_gem_mmap_gtt</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_object_get_pages_gtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			      <span class="n">gfp_t</span> <span class="n">gfpmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page_count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">||</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the list of pages out of our struct file.  They&#39;ll be pinned</span>
<span class="cm">	 * at this point until we release them.</span>
<span class="cm">	 */</span>
	<span class="n">page_count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">drm_malloc_ab</span><span class="p">(</span><span class="n">page_count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">inode</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">mapping</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="n">gfpmask</span> <span class="o">|=</span> <span class="n">mapping_gfp_mask</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">page_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">shmem_read_mapping_page_gfp</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gfpmask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_pages</span><span class="p">;</span>

		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_needs_bit17_swizzle</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
		<span class="n">i915_gem_object_do_bit_17_swizzle</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pages:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">drm_free_large</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_object_put_pages_gtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page_count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">==</span> <span class="n">__I915_MADV_PURGED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_needs_bit17_swizzle</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
		<span class="n">i915_gem_object_save_bit_17_swizzle</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">==</span> <span class="n">I915_MADV_DONTNEED</span><span class="p">)</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">page_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span>
			<span class="n">set_page_dirty</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">==</span> <span class="n">I915_MADV_WILLNEED</span><span class="p">)</span>
			<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drm_free_large</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_gem_object_move_to_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="n">ring</span><span class="p">;</span>

	<span class="cm">/* Add a reference if we&#39;re newly entering the active list. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_gem_object_reference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Move from whatever list we were on to the tail of execution. */</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">);</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span> <span class="o">=</span> <span class="n">seqno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fenced_gpu_access</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_fenced_seqno</span> <span class="o">=</span> <span class="n">seqno</span><span class="p">;</span>

		<span class="cm">/* Bump MRU to take account of the delayed flush */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">!=</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">[</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">];</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">lru_list</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">fence_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_object_move_off_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring_list</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_fenced_seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_object_move_to_flushing</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">);</span>

	<span class="n">i915_gem_object_move_off_active</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_object_move_to_inactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">i915_gem_object_move_off_active</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fenced_gpu_access</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pending_gpu_write</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">i915_verify_lists</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Immediately discard the backing storage */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_object_truncate</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>

	<span class="cm">/* Our goal here is to return as much of the memory as</span>
<span class="cm">	 * is possible back to the system as we are called from OOM.</span>
<span class="cm">	 * To do this we must instruct the shmfs to drop all of its</span>
<span class="cm">	 * backing pages, *now*.</span>
<span class="cm">	 */</span>
	<span class="n">inode</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="n">shmem_truncate_range</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">loff_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">map_list</span><span class="p">.</span><span class="n">map</span><span class="p">)</span>
		<span class="n">drm_gem_free_mmap_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">=</span> <span class="n">__I915_MADV_PURGED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">i915_gem_object_is_purgeable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">==</span> <span class="n">I915_MADV_DONTNEED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_process_flushing_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
			       <span class="kt">uint32_t</span> <span class="n">flush_domains</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">,</span>
				 <span class="n">gpu_write_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">flush_domains</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint32_t</span> <span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>

			<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">);</span>
			<span class="n">i915_gem_object_move_to_active</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span>
						       <span class="n">i915_gem_next_request_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">));</span>

			<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
							    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">,</span>
							    <span class="n">old_write_domain</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">i915_gem_get_seqno</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seqno</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">next_seqno</span><span class="p">;</span>

	<span class="cm">/* reserve 0 for non-seqno */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">next_seqno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">next_seqno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">seqno</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span>
<span class="nf">i915_gem_next_request_seqno</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">outstanding_lazy_request</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">outstanding_lazy_request</span> <span class="o">=</span> <span class="n">i915_gem_get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">outstanding_lazy_request</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_add_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">seqno</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">request_ring_position</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_empty</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">seqno</span> <span class="o">=</span> <span class="n">i915_gem_next_request_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="cm">/* Record the position of the start of the request so that</span>
<span class="cm">	 * should we detect the updated seqno part-way through the</span>
<span class="cm">	 * GPU processing the request, we never over-estimate the</span>
<span class="cm">	 * position of the head.</span>
<span class="cm">	 */</span>
	<span class="n">request_ring_position</span> <span class="o">=</span> <span class="n">intel_ring_get_tail</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">add_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seqno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">trace_i915_gem_request_add</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>

	<span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">seqno</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="n">ring</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">request_ring_position</span><span class="p">;</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">emitted_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">was_empty</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_file_private</span> <span class="o">*</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">client_list</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">request_list</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">outstanding_lazy_request</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i915_enable_hangcheck</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_timer</span><span class="p">,</span>
				  <span class="n">jiffies</span> <span class="o">+</span>
				  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">DRM_I915_HANGCHECK_PERIOD</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">was_empty</span><span class="p">)</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">i915_gem_request_remove_from_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_file_private</span> <span class="o">*</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">file_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">client_list</span><span class="p">);</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_reset_ring_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

		<span class="n">request</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">drm_i915_gem_request</span><span class="p">,</span>
					   <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">i915_gem_request_remove_from_client</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

		<span class="n">obj</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">drm_i915_gem_object</span><span class="p">,</span>
				       <span class="n">ring_list</span><span class="p">);</span>

		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">);</span>
		<span class="n">i915_gem_object_move_to_inactive</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_reset_fences</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">i915_gem_write_fence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">)</span>
			<span class="n">i915_gem_object_fence_lost</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>

		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reg</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">lru_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">fence_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_gem_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">i915_gem_reset_ring_lists</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

	<span class="cm">/* Remove anything from the flushing lists. The GPU cache is likely</span>
<span class="cm">	 * to be lost on reset along with the data, so simply move the</span>
<span class="cm">	 * lost bo to the inactive list.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_i915_gem_object</span><span class="p">,</span>
				      <span class="n">mm_list</span><span class="p">);</span>

		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">);</span>
		<span class="n">i915_gem_object_move_to_inactive</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Move everything out of the GPU domains to ensure we do any</span>
<span class="cm">	 * necessary invalidation upon reuse.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span>
			    <span class="n">mm_list</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The fence registers are invalidated so clear them out */</span>
	<span class="n">i915_gem_reset_fences</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This function clears the request list as sequence numbers are passed.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">i915_gem_retire_requests_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">seqno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">i915_verify_lists</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">seqno</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">sync_seqno</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seqno</span> <span class="o">&gt;=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">sync_seqno</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ring</span><span class="o">-&gt;</span><span class="n">sync_seqno</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

		<span class="n">request</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">drm_i915_gem_request</span><span class="p">,</span>
					   <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_seqno_passed</span><span class="p">(</span><span class="n">seqno</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">trace_i915_gem_request_retire</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
		<span class="cm">/* We know the GPU must have read the request to have</span>
<span class="cm">		 * sent us the seqno + interrupt, so use the position</span>
<span class="cm">		 * of tail of the request to update the last known position</span>
<span class="cm">		 * of the GPU head.</span>
<span class="cm">		 */</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">last_retired_head</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">i915_gem_request_remove_from_client</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Move any buffers on the active list that are no longer referenced</span>
<span class="cm">	 * by the ringbuffer to the flushing/inactive lists as appropriate.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

		<span class="n">obj</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_i915_gem_object</span><span class="p">,</span>
				      <span class="n">ring_list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_seqno_passed</span><span class="p">(</span><span class="n">seqno</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">i915_gem_object_move_to_flushing</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">i915_gem_object_move_to_inactive</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">trace_irq_seqno</span> <span class="o">&amp;&amp;</span>
		     <span class="n">i915_seqno_passed</span><span class="p">(</span><span class="n">seqno</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">trace_irq_seqno</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_put</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">trace_irq_seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">i915_verify_lists</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_gem_retire_requests</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">i915_gem_retire_requests_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_retire_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">idle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">drm_i915_private_t</span><span class="p">,</span>
				<span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Come back later if the device is busy... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_gem_retire_requests</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Send a periodic flush down the ring so we don&#39;t hold onto GEM</span>
<span class="cm">	 * objects indefinitely.</span>
<span class="cm">	 */</span>
	<span class="n">idle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_flush_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">);</span>
			<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">i915_add_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
			    <span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">idle</span> <span class="o">&amp;=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">idle</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_check_wedge</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_completion</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">recovery_complete</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="cm">/* Give the error handler a chance to run. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">recovery_complete</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">recovery_complete</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compare seqno against outstanding lazy request. Emit a request if they are</span>
<span class="cm"> * equal.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_check_olr</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seqno</span> <span class="o">==</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">outstanding_lazy_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

		<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_add_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">seqno</span> <span class="o">!=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__wait_seqno</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="n">u32</span> <span class="n">seqno</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">interruptible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i915_seqno_passed</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">seqno</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_i915_gem_request_wait_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_get</span><span class="p">(</span><span class="n">ring</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#define EXIT_COND \</span>
<span class="cp">	(i915_seqno_passed(ring-&gt;get_seqno(ring), seqno) || \</span>
<span class="cp">	atomic_read(&amp;dev_priv-&gt;mm.wedged))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interruptible</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">,</span>
					       <span class="n">EXIT_COND</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wait_event</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">,</span> <span class="n">EXIT_COND</span><span class="p">);</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_put</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">trace_i915_gem_request_wait_end</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
<span class="cp">#undef EXIT_COND</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Waits for a sequence number to be signaled, and cleans up the</span>
<span class="cm"> * request and object lists appropriately for that event.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_wait_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
		  <span class="kt">uint32_t</span> <span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">seqno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_check_wedge</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_check_olr</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__wait_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">seqno</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Ensures that all rendering to the object has completed and the object is</span>
<span class="cm"> * safe to unbind from the GTT or access from the CPU.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_object_wait_rendering</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* This function only exists to support waiting for existing rendering,</span>
<span class="cm">	 * not for emitting required flushes.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* If there is rendering queued on the buffer being evicted, wait for</span>
<span class="cm">	 * it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_wait_request</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">i915_gem_retire_requests_ring</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gem_object_sync - sync an object to a ring.</span>
<span class="cm"> *</span>
<span class="cm"> * @obj: object which may be in use on another ring.</span>
<span class="cm"> * @to: ring we wish to use the object on. May be NULL.</span>
<span class="cm"> *</span>
<span class="cm"> * This code is meant to abstract object synchronization with the GPU.</span>
<span class="cm"> * Calling with NULL implies synchronizing the object with the CPU</span>
<span class="cm"> * rather than a particular GPU ring.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if successful, else propagates up the lower layer error.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_object_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seqno</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">to</span> <span class="o">==</span> <span class="n">from</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">i915_semaphore_is_enabled</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">i915_gem_object_wait_rendering</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">intel_ring_sync_index</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>

	<span class="n">seqno</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seqno</span> <span class="o">&lt;=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">sync_seqno</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_check_olr</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">to</span><span class="o">-&gt;</span><span class="n">sync_to</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">from</span><span class="o">-&gt;</span><span class="n">sync_seqno</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">seqno</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_object_finish_gtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">old_write_domain</span><span class="p">,</span> <span class="n">old_read_domains</span><span class="p">;</span>

	<span class="cm">/* Act a barrier for all accesses through the GTT */</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="cm">/* Force a pagefault for domain tracking on next user access */</span>
	<span class="n">i915_gem_release_mmap</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">old_read_domains</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">;</span>
	<span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
					    <span class="n">old_read_domains</span><span class="p">,</span>
					    <span class="n">old_write_domain</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Unbinds an object from the GTT aperture.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_object_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_finish_gpu</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Continue on if we fail due to EIO, the GPU is hung so we</span>
<span class="cm">	 * should be safe and we need to cleanup or else we might</span>
<span class="cm">	 * cause memory corruption through use-after-free.</span>
<span class="cm">	 */</span>

	<span class="n">i915_gem_object_finish_gtt</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="cm">/* Move the object to the CPU domain to ensure that</span>
<span class="cm">	 * any possible CPU writes while it&#39;s not in the GTT</span>
<span class="cm">	 * are flushed when we go to remap it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_cpu_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In the event of a disaster, abandon all caches and</span>
<span class="cm">		 * hope for the best.</span>
<span class="cm">		 */</span>
		<span class="n">i915_gem_clflush_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* release the fence reg _after_ flushing */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_put_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_unbind</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">has_global_gtt_mapping</span><span class="p">)</span>
		<span class="n">i915_gem_gtt_unbind_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">has_aliasing_ppgtt_mapping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_ppgtt_unbind_object</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">has_aliasing_ppgtt_mapping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i915_gem_gtt_finish_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">i915_gem_object_put_pages_gtt</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_list</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">);</span>
	<span class="cm">/* Avoid an unnecessary call to unbind on rebind. */</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">drm_mm_put_block</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_is_purgeable</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
		<span class="n">i915_gem_object_truncate</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_flush_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span>
		    <span class="kt">uint32_t</span> <span class="n">invalidate_domains</span><span class="p">,</span>
		    <span class="kt">uint32_t</span> <span class="n">flush_domains</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">invalidate_domains</span> <span class="o">|</span> <span class="n">flush_domains</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_i915_gem_ring_flush</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">invalidate_domains</span><span class="p">,</span> <span class="n">flush_domains</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">invalidate_domains</span><span class="p">,</span> <span class="n">flush_domains</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flush_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span>
		<span class="n">i915_gem_process_flushing_list</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">flush_domains</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_ring_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_flush_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span>
				    <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">,</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i915_wait_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">i915_gem_next_request_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_gpu_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Flush everything onto the inactive list. */</span>
	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_ring_idle</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* Is the device fubar? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sandybridge_write_fence_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">/</span> <span class="mi">128</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">SANDYBRIDGE_FENCE_PITCH_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_Y</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">I965_FENCE_TILING_Y_SHIFT</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">I965_FENCE_REG_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">I915_WRITE64</span><span class="p">(</span><span class="n">FENCE_REG_SANDYBRIDGE_0</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">FENCE_REG_SANDYBRIDGE_0</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i965_write_fence_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="mh">0xfffff000</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">/</span> <span class="mi">128</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">I965_FENCE_PITCH_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_Y</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">I965_FENCE_TILING_Y_SHIFT</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">I965_FENCE_REG_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">I915_WRITE64</span><span class="p">(</span><span class="n">FENCE_REG_965_0</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">FENCE_REG_965_0</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_write_fence_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pitch_val</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">tile_width</span><span class="p">;</span>

		<span class="n">WARN</span><span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I915_FENCE_START_MASK</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
		     <span class="s">&quot;object 0x%08x [fenceable? %d] not 1M or pot-size (0x%08x) aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_Y</span> <span class="o">&amp;&amp;</span> <span class="n">HAS_128_BYTE_Y_TILING</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">tile_width</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tile_width</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>

		<span class="cm">/* Note: pitch better be a power of two tile widths */</span>
		<span class="n">pitch_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">/</span> <span class="n">tile_width</span><span class="p">;</span>
		<span class="n">pitch_val</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">pitch_val</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_Y</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">I830_FENCE_TILING_Y_SHIFT</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">I915_FENCE_SIZE_BITS</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">pitch_val</span> <span class="o">&lt;&lt;</span> <span class="n">I830_FENCE_PITCH_SHIFT</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">I830_FENCE_REG_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FENCE_REG_830_0</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FENCE_REG_945_8</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i830_write_fence_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">pitch_val</span><span class="p">;</span>

		<span class="n">WARN</span><span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I830_FENCE_START_MASK</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
		     <span class="s">&quot;object 0x%08x not 512K or pot-size 0x%08x aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">pitch_val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">stride</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">pitch_val</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">pitch_val</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_Y</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">I830_FENCE_TILING_Y_SHIFT</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">I830_FENCE_SIZE_BITS</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">pitch_val</span> <span class="o">&lt;&lt;</span> <span class="n">I830_FENCE_PITCH_SHIFT</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">I830_FENCE_REG_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FENCE_REG_830_0</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">FENCE_REG_830_0</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_write_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">7</span>:
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">sandybridge_write_fence_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">i965_write_fence_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">i915_write_fence_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">i830_write_fence_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">fence_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span><span class="n">fence</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fence</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_object_update_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span><span class="n">fence</span><span class="p">,</span>
					 <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">fence_number</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">fence</span><span class="p">);</span>

	<span class="n">i915_gem_write_fence</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">obj</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">fence</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="o">-&gt;</span><span class="n">lru_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">fence_list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">=</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">;</span>
		<span class="n">fence</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fence</span><span class="o">-&gt;</span><span class="n">lru_list</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_object_flush_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fenced_gpu_access</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_flush_ring</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fenced_gpu_access</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_fenced_seqno</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_wait_request</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_fenced_seqno</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_fenced_seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that all CPU reads are completed before installing a fence</span>
<span class="cm">	 * and all writes before removing the fence.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_object_put_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_flush_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">==</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i915_gem_object_update_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">[</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">],</span>
				     <span class="nb">false</span><span class="p">);</span>
	<span class="n">i915_gem_object_fence_lost</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span>
<span class="nf">i915_find_fence_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="o">*</span><span class="n">avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* First try to find a free reg */</span>
	<span class="n">avail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_reg_start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span>
			<span class="n">avail</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* None available, try to steal one or wait for a user to finish */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">fence_list</span><span class="p">,</span> <span class="n">lru_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gem_object_get_fence - set up fencing for an object</span>
<span class="cm"> * @obj: object to map through a fence reg</span>
<span class="cm"> *</span>
<span class="cm"> * When mapping objects through the GTT, userspace wants to be able to write</span>
<span class="cm"> * to them without having to worry about swizzling if the object is tiled.</span>
<span class="cm"> * This function walks the fence regs looking for a free one for @obj,</span>
<span class="cm"> * stealing one if it can&#39;t find any.</span>
<span class="cm"> *</span>
<span class="cm"> * It then sets up the reg based on the object&#39;s properties: address, pitch</span>
<span class="cm"> * and tiling format.</span>
<span class="cm"> *</span>
<span class="cm"> * For an untiled surface, this removes any existing fence.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_object_get_fence</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enable</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">!=</span> <span class="n">I915_TILING_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_fence_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Have we updated the tiling parameters upon the object and so</span>
<span class="cm">	 * will need to serialise the write to the associated fence register?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_flush_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Just update our place in the LRU if our fence is getting reused. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">!=</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">[</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_dirty</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">lru_list</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">fence_list</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">i915_find_fence_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EDEADLK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_flush_fence</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">i915_gem_object_fence_lost</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i915_gem_object_update_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_dirty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Finds free space in the GTT aperture and binds the object there.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_object_bind_to_gtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">alignment</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">map_and_fenceable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mm_node</span> <span class="o">*</span><span class="n">free_space</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">gfpmask</span> <span class="o">=</span> <span class="n">__GFP_NORETRY</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">fence_size</span><span class="p">,</span> <span class="n">fence_alignment</span><span class="p">,</span> <span class="n">unfenced_alignment</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mappable</span><span class="p">,</span> <span class="n">fenceable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">!=</span> <span class="n">I915_MADV_WILLNEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to bind a purgeable object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fence_size</span> <span class="o">=</span> <span class="n">i915_gem_get_gtt_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">);</span>
	<span class="n">fence_alignment</span> <span class="o">=</span> <span class="n">i915_gem_get_gtt_alignment</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
						     <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">);</span>
	<span class="n">unfenced_alignment</span> <span class="o">=</span>
		<span class="n">i915_gem_get_unfenced_gtt_alignment</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
						    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">alignment</span> <span class="o">=</span> <span class="n">map_and_fenceable</span> <span class="o">?</span> <span class="n">fence_alignment</span> <span class="o">:</span>
						<span class="n">unfenced_alignment</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map_and_fenceable</span> <span class="o">&amp;&amp;</span> <span class="n">alignment</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fence_alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid object alignment requested %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alignment</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">map_and_fenceable</span> <span class="o">?</span> <span class="n">fence_size</span> <span class="o">:</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="cm">/* If the object is bigger than the entire aperture, reject it early</span>
<span class="cm">	 * before evicting everything in a vain attempt to find space.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span>
	    <span class="p">(</span><span class="n">map_and_fenceable</span> <span class="o">?</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mappable_end</span> <span class="o">:</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_total</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to bind an object larger than the aperture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">search_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map_and_fenceable</span><span class="p">)</span>
		<span class="n">free_space</span> <span class="o">=</span>
			<span class="n">drm_mm_search_free_in_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_space</span><span class="p">,</span>
						    <span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mappable_end</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">free_space</span> <span class="o">=</span> <span class="n">drm_mm_search_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_space</span><span class="p">,</span>
						<span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_space</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map_and_fenceable</span><span class="p">)</span>
			<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">=</span>
				<span class="n">drm_mm_get_block_range_generic</span><span class="p">(</span><span class="n">free_space</span><span class="p">,</span>
							       <span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							       <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mappable_end</span><span class="p">,</span>
							       <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">=</span>
				<span class="n">drm_mm_get_block</span><span class="p">(</span><span class="n">free_space</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the gtt is empty and we&#39;re still having trouble</span>
<span class="cm">		 * fitting our object in, we&#39;re out of memory.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_evict_something</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span>
					       <span class="n">map_and_fenceable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">search_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_get_pages_gtt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">gfpmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_mm_put_block</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="p">);</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* first try to reclaim some memory by clearing the GTT */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_evict_everything</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* now try to shrink everyone else */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gfpmask</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">gfpmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">search_free</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">goto</span> <span class="n">search_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_gtt_prepare_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_gem_object_put_pages_gtt</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="n">drm_mm_put_block</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="p">);</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_evict_everything</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">goto</span> <span class="n">search_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span><span class="p">)</span>
		<span class="n">i915_gem_gtt_bind_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">);</span>

	<span class="cm">/* Assert that the object is not currently in any GPU domain. As it</span>
<span class="cm">	 * wasn&#39;t in the GTT, there shouldn&#39;t be any way it could have been in</span>
<span class="cm">	 * a GPU cache</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="n">fenceable</span> <span class="o">=</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">fence_size</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fence_alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mappable</span> <span class="o">=</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mappable_end</span><span class="p">;</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span> <span class="o">=</span> <span class="n">mappable</span> <span class="o">&amp;&amp;</span> <span class="n">fenceable</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_bind</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">map_and_fenceable</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_gem_clflush_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If we don&#39;t have a page list set up, then we&#39;re not pinned</span>
<span class="cm">	 * to GPU, and we can ignore the cache flush because it&#39;ll happen</span>
<span class="cm">	 * again at bind time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If the GPU is snooping the contents of the CPU cache,</span>
<span class="cm">	 * we do not need to manually clear the CPU cache lines.  However,</span>
<span class="cm">	 * the caches are only snooped when the render cache is</span>
<span class="cm">	 * flushed/invalidated.  As we always have to emit invalidations</span>
<span class="cm">	 * and flushes when moving into and out of the RENDER domain, correct</span>
<span class="cm">	 * snooping behaviour occurs naturally as the result of our domain</span>
<span class="cm">	 * tracking.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">!=</span> <span class="n">I915_CACHE_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_clflush</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">drm_clflush_pages</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Flushes any GPU write domain for the object if it&#39;s dirty. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_object_flush_gpu_write_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Queue the GPU write cache flushing we need. */</span>
	<span class="k">return</span> <span class="n">i915_gem_flush_ring</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Flushes the GTT write domain for the object if it&#39;s dirty. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_object_flush_gtt_write_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">old_write_domain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">!=</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* No actual flushing is required for the GTT write domain.  Writes</span>
<span class="cm">	 * to it immediately go to main memory as far as we know, so there&#39;s</span>
<span class="cm">	 * no chipset flush.  It also doesn&#39;t land in render cache.</span>
<span class="cm">	 *</span>
<span class="cm">	 * However, we do have to enforce the order so that all writes through</span>
<span class="cm">	 * the GTT land before any writes to the device, such as updates to</span>
<span class="cm">	 * the GATT itself.</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
					    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">,</span>
					    <span class="n">old_write_domain</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Flushes the CPU write domain for the object if it&#39;s dirty. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_gem_object_flush_cpu_write_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">old_write_domain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">!=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">i915_gem_clflush_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">intel_gtt_chipset_flush</span><span class="p">();</span>
	<span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
					    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">,</span>
					    <span class="n">old_write_domain</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Moves a single object to the GTT read, and possibly write domain.</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns when the move is complete, including waiting on</span>
<span class="cm"> * flushes to occur.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">old_write_domain</span><span class="p">,</span> <span class="n">old_read_domains</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Not valid to be called on unbound objects. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">==</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_flush_gpu_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pending_gpu_write</span> <span class="o">||</span> <span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_wait_rendering</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_gem_object_flush_cpu_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>
	<span class="n">old_read_domains</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">;</span>

	<span class="cm">/* It should now be out of any other write domains, and we can update</span>
<span class="cm">	 * the domain values for our changes.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">|=</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">;</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">;</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
					    <span class="n">old_read_domains</span><span class="p">,</span>
					    <span class="n">old_write_domain</span><span class="p">);</span>

	<span class="cm">/* And bump the LRU for this access */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_is_inactive</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_gem_object_set_cache_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">i915_cache_level</span> <span class="n">cache_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">==</span> <span class="n">cache_level</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;can not change the cache level of pinned objects</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_finish_gpu</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">i915_gem_object_finish_gtt</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

		<span class="cm">/* Before SandyBridge, you could not use tiling or fence</span>
<span class="cm">		 * registers with snooped memory, so relinquish any fences</span>
<span class="cm">		 * currently pointing to our region in the aperture.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_put_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">has_global_gtt_mapping</span><span class="p">)</span>
			<span class="n">i915_gem_gtt_bind_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cache_level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">has_aliasing_ppgtt_mapping</span><span class="p">)</span>
			<span class="n">i915_ppgtt_bind_object</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span><span class="p">,</span>
					       <span class="n">obj</span><span class="p">,</span> <span class="n">cache_level</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache_level</span> <span class="o">==</span> <span class="n">I915_CACHE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">old_read_domains</span><span class="p">,</span> <span class="n">old_write_domain</span><span class="p">;</span>

		<span class="cm">/* If we&#39;re coming from LLC cached, then we haven&#39;t</span>
<span class="cm">		 * actually been tracking whether the data is in the</span>
<span class="cm">		 * CPU cache or not, since we only allow one bit set</span>
<span class="cm">		 * in obj-&gt;write_domain and have been skipping the clflushes.</span>
<span class="cm">		 * Just set it to the CPU cache for now.</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">);</span>

		<span class="n">old_read_domains</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">;</span>
		<span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>

		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>

		<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
						    <span class="n">old_read_domains</span><span class="p">,</span>
						    <span class="n">old_write_domain</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">=</span> <span class="n">cache_level</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare buffer for display plane (scanout, cursors, etc).</span>
<span class="cm"> * Can be called from an uninterruptible phase (modesetting) and allows</span>
<span class="cm"> * any flushes to be pipelined (for pageflips).</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_object_pin_to_display_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">alignment</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">pipelined</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">old_read_domains</span><span class="p">,</span> <span class="n">old_write_domain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_flush_gpu_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipelined</span> <span class="o">!=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_sync</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">pipelined</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The display engine is not coherent with the LLC cache on gen6.  As</span>
<span class="cm">	 * a result, we make sure that the pinning that is about to occur is</span>
<span class="cm">	 * done with uncached PTEs. This is lowest common denominator for all</span>
<span class="cm">	 * chipsets.</span>
<span class="cm">	 *</span>
<span class="cm">	 * However for gen6+, we could do better by using the GFDT bit instead</span>
<span class="cm">	 * of uncaching, which would allow us to flush all the LLC-cached data</span>
<span class="cm">	 * with that bit in the PTE to main memory with just one PIPE_CONTROL.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_cache_level</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">I915_CACHE_NONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* As the user may map the buffer once pinned in the display plane</span>
<span class="cm">	 * (e.g. libkms for the bootup splash), we have to ensure that we</span>
<span class="cm">	 * always use map_and_fenceable for all scanout buffers.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">i915_gem_object_flush_cpu_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>
	<span class="n">old_read_domains</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">;</span>

	<span class="cm">/* It should now be out of any other write domains, and we can update</span>
<span class="cm">	 * the domain values for our changes.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">|=</span> <span class="n">I915_GEM_DOMAIN_GTT</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
					    <span class="n">old_read_domains</span><span class="p">,</span>
					    <span class="n">old_write_domain</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_object_finish_gpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_flush_ring</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_wait_rendering</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Ensure that we invalidate the GPU&#39;s caches and TLBs. */</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Moves a single object to the CPU read, and possibly write domain.</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns when the move is complete, including waiting on</span>
<span class="cm"> * flushes to occur.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">i915_gem_object_set_to_cpu_domain</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">old_write_domain</span><span class="p">,</span> <span class="n">old_read_domains</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">==</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_flush_gpu_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write</span> <span class="o">||</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">pending_gpu_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_wait_rendering</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_gem_object_flush_gtt_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">old_write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>
	<span class="n">old_read_domains</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">;</span>

	<span class="cm">/* Flush the CPU cache if it&#39;s still invalid. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_gem_clflush_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">|=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* It should now be out of any other write domains, and we can update</span>
<span class="cm">	 * the domain values for our changes.</span>
<span class="cm">	 */</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* If we&#39;re writing through the CPU, then the GPU read domains will</span>
<span class="cm">	 * need to be invalidated at next use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_i915_gem_object_change_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
					    <span class="n">old_read_domains</span><span class="p">,</span>
					    <span class="n">old_write_domain</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Throttle our rendering by waiting until the ring has completed our requests</span>
<span class="cm"> * emitted over 20 msec ago.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that if we were to use the current jiffies each time around the loop,</span>
<span class="cm"> * we wouldn&#39;t escape the function with any frames outstanding if the time to</span>
<span class="cm"> * render a frame was over 20ms.</span>
<span class="cm"> *</span>
<span class="cm"> * This should get us reasonable parallelism between CPU and GPU but also</span>
<span class="cm"> * relatively low latency when blocking on a particular request to finish.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_ring_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_file_private</span> <span class="o">*</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">recent_enough</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">request_list</span><span class="p">,</span> <span class="n">client_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">emitted_jiffies</span><span class="p">,</span> <span class="n">recent_enough</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ring</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>
		<span class="n">seqno</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seqno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__wait_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">seqno</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_object_pin</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
		    <span class="kt">uint32_t</span> <span class="n">alignment</span><span class="p">,</span>
		    <span class="n">bool</span> <span class="n">map_and_fenceable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">==</span> <span class="n">DRM_I915_GEM_OBJECT_MAX_PIN_COUNT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">alignment</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">map_and_fenceable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WARN</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">,</span>
			     <span class="s">&quot;bo is already pinned with incorrect alignment:&quot;</span>
			     <span class="s">&quot; offset=%x, req.alignment=%x, req.map_and_fenceable=%d,&quot;</span>
			     <span class="s">&quot; obj-&gt;map_and_fenceable=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span>
			     <span class="n">map_and_fenceable</span><span class="p">,</span>
			     <span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_unbind</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_bind_to_gtt</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span>
						  <span class="n">map_and_fenceable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">has_global_gtt_mapping</span> <span class="o">&amp;&amp;</span> <span class="n">map_and_fenceable</span><span class="p">)</span>
		<span class="n">i915_gem_gtt_bind_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_mappable</span> <span class="o">|=</span> <span class="n">map_and_fenceable</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_gem_object_unpin</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_mappable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_pin_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_pin</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">!=</span> <span class="n">I915_MADV_WILLNEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to pin a purgeable buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_filp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_filp</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Already pinned in i915_gem_pin_ioctl(): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">user_pin_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_filp</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">user_pin_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">alignment</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX - flush the CPU caches for pinned objects</span>
<span class="cm">	 * as the X server doesn&#39;t manage domains yet</span>
<span class="cm">	 */</span>
	<span class="n">i915_gem_object_flush_cpu_write_domain</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_unpin_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_pin</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_filp</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Not pinned by caller in i915_gem_pin_ioctl(): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">user_pin_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">user_pin_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_busy_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_busy</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Count all active objects as busy, even if they are currently not used</span>
<span class="cm">	 * by the gpu. Users of this interface expect objects to eventually</span>
<span class="cm">	 * become non-busy without any further actions, therefore emit any</span>
<span class="cm">	 * necessary flushes here.</span>
<span class="cm">	 */</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unconditionally flush objects, even when the gpu still uses this</span>
<span class="cm">		 * object. Userspace calling this function indicates that it wants to</span>
<span class="cm">		 * use this buffer rather sooner than later, so issuing the required</span>
<span class="cm">		 * flush earlier is beneficial.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">&amp;</span> <span class="n">I915_GEM_GPU_DOMAINS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_flush_ring</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
						  <span class="mi">0</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_check_olr</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span>
						 <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Update the active list for the hardware&#39;s current position.</span>
<span class="cm">		 * Otherwise this only updates on a delayed timer or when irqs</span>
<span class="cm">		 * are actually unmasked, and our working set ends up being</span>
<span class="cm">		 * larger than required.</span>
<span class="cm">		 */</span>
		<span class="n">i915_gem_retire_requests_ring</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

		<span class="n">args</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_throttle_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i915_gem_ring_throttle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_madvise_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_madvise</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">madv</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_MADV_DONTNEED</span>:
	<span class="k">case</span> <span class="n">I915_MADV_WILLNEED</span>:
	    <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_mutex_lock_interruptible</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">!=</span> <span class="n">__I915_MADV_PURGED</span><span class="p">)</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">madv</span><span class="p">;</span>

	<span class="cm">/* if the object is no longer bound, discard its backing storage */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_is_purgeable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">i915_gem_object_truncate</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">retained</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">!=</span> <span class="n">__I915_MADV_PURGED</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="nf">i915_gem_alloc_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						  <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">obj</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_gem_object_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">GFP_HIGHUSER</span> <span class="o">|</span> <span class="n">__GFP_RECLAIMABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_BROADWATER</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 965gm cannot relocate objects above 4GiB. */</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">__GFP_HIGHMEM</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">__GFP_DMA32</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="n">mapping_set_gfp_mask</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

	<span class="n">i915_gem_info_add_obj</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">=</span> <span class="n">I915_GEM_DOMAIN_CPU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_LLC</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* On some devices, we can have the GPU use the LLC (the CPU</span>
<span class="cm">		 * cache) for about a 10% performance improvement</span>
<span class="cm">		 * compared to uncached.  Graphics requests other than</span>
<span class="cm">		 * display scanout are coherent with the CPU in</span>
<span class="cm">		 * accessing this cache.  This means in this mode we</span>
<span class="cm">		 * don&#39;t need to clflush on the CPU side, and on the</span>
<span class="cm">		 * GPU side we only need to flush internal caches to</span>
<span class="cm">		 * get data visible to the CPU.</span>
<span class="cm">		 *</span>
<span class="cm">		 * However, we maintain the display planes as UC, and so</span>
<span class="cm">		 * need to rebind when first used as such.</span>
<span class="cm">		 */</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">=</span> <span class="n">I915_CACHE_LLC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">=</span> <span class="n">I915_CACHE_NONE</span><span class="p">;</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">driver_private</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">=</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">mm_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">exec_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">);</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">=</span> <span class="n">I915_MADV_WILLNEED</span><span class="p">;</span>
	<span class="cm">/* Avoid an unnecessary call to unbind on the first bind. */</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">map_and_fenceable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_gem_init_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_gem_free_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">gem_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">gem_obj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">trace_i915_gem_object_destroy</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gem_obj</span><span class="o">-&gt;</span><span class="n">import_attach</span><span class="p">)</span>
		<span class="n">drm_prime_gem_destroy</span><span class="p">(</span><span class="n">gem_obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">sg_table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="p">)</span>
		<span class="n">i915_gem_detach_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">i915_gem_object_unbind</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">was_interruptible</span><span class="p">;</span>

		<span class="n">was_interruptible</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">i915_gem_object_unbind</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="n">was_interruptible</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">map_list</span><span class="p">.</span><span class="n">map</span><span class="p">)</span>
		<span class="n">drm_gem_free_mmap_offset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">drm_gem_object_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">i915_gem_info_remove_obj</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">bit_17</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gpu_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i915_gem_retire_requests</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Under UMS, be paranoid and evict. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="n">i915_gem_evict_everything</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">i915_gem_reset_fences</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Hack!  Don&#39;t let anybody do execbuf while we don&#39;t control the chip.</span>
<span class="cm">	 * We need to replace this with a semaphore, or something.</span>
<span class="cm">	 * And not confound mm.suspended!</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_timer</span><span class="p">);</span>

	<span class="n">i915_kernel_lost_context</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">i915_gem_cleanup_ringbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* Cancel the retire work handler, which should be idle now. */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_gem_init_swizzling</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">bit_6_swizzle_x</span> <span class="o">==</span> <span class="n">I915_BIT_6_SWIZZLE_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DISP_ARB_CTL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DISP_ARB_CTL</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">DISP_TILE_SURFACE_SWIZZLING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TILECTL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TILECTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">TILECTL_SWZCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ARB_MODE</span><span class="p">,</span> <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">ARB_MODE_SWIZZLE_SNB</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ARB_MODE</span><span class="p">,</span> <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">ARB_MODE_SWIZZLE_IVB</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_gem_init_ppgtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pd_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i915_hw_ppgtt</span> <span class="o">*</span><span class="n">ppgtt</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pd_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pd_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>


	<span class="n">pd_addr</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">gtt</span> <span class="o">+</span> <span class="n">ppgtt</span><span class="o">-&gt;</span><span class="n">pd_offset</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ppgtt</span><span class="o">-&gt;</span><span class="n">num_pd_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">pt_addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">needs_dmar</span><span class="p">)</span>
			<span class="n">pt_addr</span> <span class="o">=</span> <span class="n">ppgtt</span><span class="o">-&gt;</span><span class="n">pt_dma_addr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">pt_addr</span> <span class="o">=</span> <span class="n">page_to_phys</span><span class="p">(</span><span class="n">ppgtt</span><span class="o">-&gt;</span><span class="n">pt_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">pd_entry</span> <span class="o">=</span> <span class="n">GEN6_PDE_ADDR_ENCODE</span><span class="p">(</span><span class="n">pt_addr</span><span class="p">);</span>
		<span class="n">pd_entry</span> <span class="o">|=</span> <span class="n">GEN6_PDE_VALID</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">pd_entry</span><span class="p">,</span> <span class="n">pd_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">pd_addr</span><span class="p">);</span>

	<span class="n">pd_offset</span> <span class="o">=</span> <span class="n">ppgtt</span><span class="o">-&gt;</span><span class="n">pd_offset</span><span class="p">;</span>
	<span class="n">pd_offset</span> <span class="o">/=</span> <span class="mi">64</span><span class="p">;</span> <span class="cm">/* in cachelines, */</span>
	<span class="n">pd_offset</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">ecochk</span><span class="p">,</span> <span class="n">gab_ctl</span><span class="p">,</span> <span class="n">ecobits</span><span class="p">;</span>

		<span class="n">ecobits</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GAC_ECO_BITS</span><span class="p">);</span> 
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GAC_ECO_BITS</span><span class="p">,</span> <span class="n">ecobits</span> <span class="o">|</span> <span class="n">ECOBITS_PPGTT_CACHE64B</span><span class="p">);</span>

		<span class="n">gab_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GAB_CTL</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GAB_CTL</span><span class="p">,</span> <span class="n">gab_ctl</span> <span class="o">|</span> <span class="n">GAB_CTL_CONT_AFTER_PAGEFAULT</span><span class="p">);</span>

		<span class="n">ecochk</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GAM_ECOCHK</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GAM_ECOCHK</span><span class="p">,</span> <span class="n">ecochk</span> <span class="o">|</span> <span class="n">ECOCHK_SNB_BIT</span> <span class="o">|</span>
				       <span class="n">ECOCHK_PPGTT_CACHE64B</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GFX_MODE</span><span class="p">,</span> <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">GFX_PPGTT_ENABLE</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GAM_ECOCHK</span><span class="p">,</span> <span class="n">ECOCHK_PPGTT_CACHE64B</span><span class="p">);</span>
		<span class="cm">/* GFX_MODE is per-ring on gen7+ */</span>
	<span class="p">}</span>

	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RING_MODE_GEN7</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span>
				   <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">GFX_PPGTT_ENABLE</span><span class="p">));</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RING_PP_DIR_DCLV</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">PP_DIR_DCLV_2G</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RING_PP_DIR_BASE</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">pd_offset</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">i915_gem_init_swizzling</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_init_render_ring_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_BSD</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_init_bsd_ring_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup_render_ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_BLT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_init_blt_ring_buffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cleanup_bsd_ring</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">next_seqno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">i915_gem_init_ppgtt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup_bsd_ring:</span>
	<span class="n">intel_cleanup_ring_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">VCS</span><span class="p">]);</span>
<span class="nl">cleanup_render_ring:</span>
	<span class="n">intel_cleanup_ring_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_enable_ppgtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i915_enable_ppgtt</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i915_enable_ppgtt</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_INTEL_IOMMU</span>
	<span class="cm">/* Disable ppgtt on SNB if VT-d is on. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">intel_iommu_gfx_mapped</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_gem_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gtt_size</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">gtt_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">gtt_total_entries</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">mappable_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">gtt_mappable_entries</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_enable_ppgtt</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">HAS_ALIASING_PPGTT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* PPGTT pdes are stolen from global gtt ptes, so shrink the</span>
<span class="cm">		 * aperture accordingly when using aliasing ppgtt. */</span>
		<span class="n">gtt_size</span> <span class="o">-=</span> <span class="n">I915_PPGTT_PD_ENTRIES</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">;</span>

		<span class="n">i915_gem_init_global_gtt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">,</span> <span class="n">gtt_size</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_init_aliasing_ppgtt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Let GEM Manage all of the aperture.</span>
<span class="cm">		 *</span>
<span class="cm">		 * However, leave one page at the end still bound to the scratch</span>
<span class="cm">		 * page.  There are a number of places where the hardware</span>
<span class="cm">		 * apparently prefetches past the end of the object, and we&#39;ve</span>
<span class="cm">		 * seen multiple hangs with the GPU head pointer stuck in a</span>
<span class="cm">		 * batchbuffer bound at the last page of the aperture.  One page</span>
<span class="cm">		 * should be enough to keep any prefetching inside of the</span>
<span class="cm">		 * aperture.</span>
<span class="cm">		 */</span>
		<span class="n">i915_gem_init_global_gtt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">,</span>
					 <span class="n">gtt_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_init_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_gem_cleanup_aliasing_ppgtt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allow hardware batchbuffers unless told otherwise, but not for KMS. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">allow_batchbuffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_gem_cleanup_ringbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">intel_cleanup_ring_buffer</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_entervt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Reenabling wedged hardware, good luck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_init_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_irq_install</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_ringbuffer</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup_ringbuffer:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">i915_gem_cleanup_ringbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_leavevt_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drm_irq_uninstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">i915_gem_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_gem_lastclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to idle hardware: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_ring_lists</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">active_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">gpu_write_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_gem_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">fence_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I915_NUM_RINGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">init_ring_lists</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I915_MAX_NUM_FENCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lru_list</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">,</span>
			  <span class="n">i915_gem_retire_work_handler</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_completion</span><span class="p">);</span>

	<span class="cm">/* On GEN3 we really need to make sure the ARB C3 LP bit is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN3</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">MI_ARB_STATE</span><span class="p">,</span>
			   <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">MI_ARB_C3_LP_WRITE_ENABLE</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">relative_constants_mode</span> <span class="o">=</span> <span class="n">I915_EXEC_CONSTANTS_REL_GENERAL</span><span class="p">;</span>

	<span class="cm">/* Old X drivers will take 0-2 for front, back, depth buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_reg_start</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_G33</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Initialize fence registers to zero */</span>
	<span class="n">i915_gem_reset_fences</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">i915_gem_detect_bit_6_swizzle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pending_flip_queue</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">.</span><span class="n">shrink</span> <span class="o">=</span> <span class="n">i915_gem_inactive_shrink</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">.</span><span class="n">seeks</span> <span class="o">=</span> <span class="n">DEFAULT_SEEKS</span><span class="p">;</span>
	<span class="n">register_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a physically contiguous memory object for this object</span>
<span class="cm"> * e.g. for cursor + overlay regs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_init_phys_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_phys_object</span> <span class="o">*</span><span class="n">phys_obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">phys_objs</span><span class="p">[</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phys_obj</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_phys_object</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">drm_pci_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">kfree_obj</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_X86</span>
	<span class="n">set_memory_wc</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">phys_objs</span><span class="p">[</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phys_obj</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">kfree_obj:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phys_obj</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_free_phys_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_phys_object</span> <span class="o">*</span><span class="n">phys_obj</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">phys_objs</span><span class="p">[</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">phys_obj</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">phys_objs</span><span class="p">[</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">cur_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_gem_detach_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">cur_obj</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_X86</span>
	<span class="n">set_memory_wb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">drm_pci_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phys_obj</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">phys_objs</span><span class="p">[</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_gem_free_all_phys_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">I915_GEM_PHYS_CURSOR_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">I915_MAX_PHYS_OBJECT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">i915_gem_free_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_gem_detach_phys_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">vaddr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>

	<span class="n">page_count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">page_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span> <span class="o">=</span> <span class="n">shmem_read_mapping_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">vaddr</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>

			<span class="n">drm_clflush_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">set_page_dirty</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
			<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">intel_gtt_chipset_flush</span><span class="p">();</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">cur_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_gem_attach_phys_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_space</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="o">-&gt;</span><span class="n">i_mapping</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">I915_MAX_PHYS_OBJECT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">i915_gem_detach_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* create a new object */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">phys_objs</span><span class="p">[</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_init_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
						<span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to init phys object %d size: %zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">id</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* bind to the object */</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">phys_objs</span><span class="p">[</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">cur_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>

	<span class="n">page_count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">page_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

		<span class="n">page</span> <span class="o">=</span> <span class="n">shmem_read_mapping_page</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

		<span class="n">src</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

		<span class="n">mark_page_accessed</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
		<span class="n">page_cache_release</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_phys_pwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_i915_gem_pwrite</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span> <span class="o">+</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">data_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_from_user_inatomic_nocache</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">unwritten</span><span class="p">;</span>

		<span class="cm">/* The physical object once assigned is fixed for the lifetime</span>
<span class="cm">		 * of the obj, so we can safely drop the lock and continue</span>
<span class="cm">		 * to access vaddr.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">unwritten</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">vaddr</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unwritten</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_gtt_chipset_flush</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_gem_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_file_private</span> <span class="o">*</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="cm">/* Clean up our request list when the client is going away, so that</span>
<span class="cm">	 * later retire_requests won&#39;t dereference our soon-to-be-gone</span>
<span class="cm">	 * file_priv.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

		<span class="n">request</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">request_list</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">drm_i915_gem_request</span><span class="p">,</span>
					   <span class="n">client_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">client_list</span><span class="p">);</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">file_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gpu_is_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lists_empty</span><span class="p">;</span>

	<span class="n">lists_empty</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">lists_empty</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_gem_inactive_shrink</span><span class="p">(</span><span class="k">struct</span> <span class="n">shrinker</span> <span class="o">*</span><span class="n">shrinker</span><span class="p">,</span> <span class="k">struct</span> <span class="n">shrink_control</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">shrinker</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_i915_private</span><span class="p">,</span>
			     <span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_to_scan</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">nr_to_scan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* &quot;fast-path&quot; to count number of available objects */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_to_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span>
				    <span class="n">mm_list</span><span class="p">)</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cnt</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">sysctl_vfs_cache_pressure</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">rescan:</span>
	<span class="cm">/* first scan for clean buffers */</span>
	<span class="n">i915_gem_retire_requests</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span>
				 <span class="n">mm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_is_purgeable</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i915_gem_object_unbind</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="o">--</span><span class="n">nr_to_scan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* second pass, evict/count anything still on the inactive list */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span>
				 <span class="n">mm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_to_scan</span> <span class="o">&amp;&amp;</span>
		    <span class="n">i915_gem_object_unbind</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">nr_to_scan</span><span class="o">--</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_to_scan</span> <span class="o">&amp;&amp;</span> <span class="n">i915_gpu_is_active</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We are desperate for pages, so as a last resort, wait</span>
<span class="cm">		 * for the GPU to finish and discard whatever we can.</span>
<span class="cm">		 * This has a dramatic impact to reduce the number of</span>
<span class="cm">		 * OOM-killer events whilst running the GPU aggressively.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i915_gpu_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rescan</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cnt</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">sysctl_vfs_cache_pressure</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
