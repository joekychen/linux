<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › intel_tv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>intel_tv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2006-2008 Intel Corporation</span>
<span class="cm"> *   Jesse Barnes &lt;jesse.barnes@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/** @file</span>
<span class="cm"> * Integrated TV-out support for the 915GM and 945GM.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_crtc.h&quot;</span>
<span class="cp">#include &quot;drm_edid.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>

<span class="k">enum</span> <span class="n">tv_margin</span> <span class="p">{</span>
	<span class="n">TV_MARGIN_LEFT</span><span class="p">,</span> <span class="n">TV_MARGIN_TOP</span><span class="p">,</span>
	<span class="n">TV_MARGIN_RIGHT</span><span class="p">,</span> <span class="n">TV_MARGIN_BOTTOM</span>
<span class="p">};</span>

<span class="cm">/** Private structure for the integrated TV support */</span>
<span class="k">struct</span> <span class="n">intel_tv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="n">base</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tv_format</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">margin</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">save_TV_H_CTL_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_H_CTL_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_H_CTL_3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CTL_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CTL_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CTL_3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CTL_4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CTL_5</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CTL_6</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CTL_7</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_SC_CTL_1</span><span class="p">,</span> <span class="n">save_TV_SC_CTL_2</span><span class="p">,</span> <span class="n">save_TV_SC_CTL_3</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">save_TV_CSC_Y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CSC_Y2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CSC_U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CSC_U2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CSC_V</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CSC_V2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CLR_KNOBS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CLR_LEVEL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_WIN_POS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_WIN_SIZE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_FILTER_CTL_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_FILTER_CTL_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_FILTER_CTL_3</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">save_TV_H_LUMA</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">save_TV_H_CHROMA</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">save_TV_V_LUMA</span><span class="p">[</span><span class="mi">43</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">save_TV_V_CHROMA</span><span class="p">[</span><span class="mi">43</span><span class="p">];</span>

	<span class="n">u32</span> <span class="n">save_TV_DAC</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_TV_CTL</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">video_levels</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">blank</span><span class="p">,</span> <span class="n">black</span><span class="p">,</span> <span class="n">burst</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">color_conversion</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">ry</span><span class="p">,</span> <span class="n">gy</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">ay</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ru</span><span class="p">,</span> <span class="n">gu</span><span class="p">,</span> <span class="n">bu</span><span class="p">,</span> <span class="n">au</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rv</span><span class="p">,</span> <span class="n">gv</span><span class="p">,</span> <span class="n">bv</span><span class="p">,</span> <span class="n">av</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">filter_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xB1403000</span><span class="p">,</span> <span class="mh">0x2E203500</span><span class="p">,</span> <span class="mh">0x35002E20</span><span class="p">,</span> <span class="mh">0x3000B140</span><span class="p">,</span>
	<span class="mh">0x35A0B160</span><span class="p">,</span> <span class="mh">0x2DC02E80</span><span class="p">,</span> <span class="mh">0xB1403480</span><span class="p">,</span> <span class="mh">0xB1603000</span><span class="p">,</span>
	<span class="mh">0x2EA03640</span><span class="p">,</span> <span class="mh">0x34002D80</span><span class="p">,</span> <span class="mh">0x3000B120</span><span class="p">,</span> <span class="mh">0x36E0B160</span><span class="p">,</span>
	<span class="mh">0x2D202EF0</span><span class="p">,</span> <span class="mh">0xB1203380</span><span class="p">,</span> <span class="mh">0xB1603000</span><span class="p">,</span> <span class="mh">0x2F303780</span><span class="p">,</span>
	<span class="mh">0x33002CC0</span><span class="p">,</span> <span class="mh">0x3000B100</span><span class="p">,</span> <span class="mh">0x3820B160</span><span class="p">,</span> <span class="mh">0x2C802F50</span><span class="p">,</span>
	<span class="mh">0xB10032A0</span><span class="p">,</span> <span class="mh">0xB1603000</span><span class="p">,</span> <span class="mh">0x2F9038C0</span><span class="p">,</span> <span class="mh">0x32202C20</span><span class="p">,</span>
	<span class="mh">0x3000B0E0</span><span class="p">,</span> <span class="mh">0x3980B160</span><span class="p">,</span> <span class="mh">0x2BC02FC0</span><span class="p">,</span> <span class="mh">0xB0E031C0</span><span class="p">,</span>
	<span class="mh">0xB1603000</span><span class="p">,</span> <span class="mh">0x2FF03A20</span><span class="p">,</span> <span class="mh">0x31602B60</span><span class="p">,</span> <span class="mh">0xB020B0C0</span><span class="p">,</span>
	<span class="mh">0x3AE0B160</span><span class="p">,</span> <span class="mh">0x2B001810</span><span class="p">,</span> <span class="mh">0xB0C03120</span><span class="p">,</span> <span class="mh">0xB140B020</span><span class="p">,</span>
	<span class="mh">0x18283BA0</span><span class="p">,</span> <span class="mh">0x30C02A80</span><span class="p">,</span> <span class="mh">0xB020B0A0</span><span class="p">,</span> <span class="mh">0x3C60B140</span><span class="p">,</span>
	<span class="mh">0x2A201838</span><span class="p">,</span> <span class="mh">0xB0A03080</span><span class="p">,</span> <span class="mh">0xB120B020</span><span class="p">,</span> <span class="mh">0x18383D20</span><span class="p">,</span>
	<span class="mh">0x304029C0</span><span class="p">,</span> <span class="mh">0xB040B080</span><span class="p">,</span> <span class="mh">0x3DE0B100</span><span class="p">,</span> <span class="mh">0x29601848</span><span class="p">,</span>
	<span class="mh">0xB0803000</span><span class="p">,</span> <span class="mh">0xB100B040</span><span class="p">,</span> <span class="mh">0x18483EC0</span><span class="p">,</span> <span class="mh">0xB0402900</span><span class="p">,</span>
	<span class="mh">0xB040B060</span><span class="p">,</span> <span class="mh">0x3F80B0C0</span><span class="p">,</span> <span class="mh">0x28801858</span><span class="p">,</span> <span class="mh">0xB060B080</span><span class="p">,</span>
	<span class="mh">0xB0A0B060</span><span class="p">,</span> <span class="mh">0x18602820</span><span class="p">,</span> <span class="mh">0xB0A02820</span><span class="p">,</span> <span class="mh">0x0000B060</span><span class="p">,</span>
	<span class="mh">0xB1403000</span><span class="p">,</span> <span class="mh">0x2E203500</span><span class="p">,</span> <span class="mh">0x35002E20</span><span class="p">,</span> <span class="mh">0x3000B140</span><span class="p">,</span>
	<span class="mh">0x35A0B160</span><span class="p">,</span> <span class="mh">0x2DC02E80</span><span class="p">,</span> <span class="mh">0xB1403480</span><span class="p">,</span> <span class="mh">0xB1603000</span><span class="p">,</span>
	<span class="mh">0x2EA03640</span><span class="p">,</span> <span class="mh">0x34002D80</span><span class="p">,</span> <span class="mh">0x3000B120</span><span class="p">,</span> <span class="mh">0x36E0B160</span><span class="p">,</span>
	<span class="mh">0x2D202EF0</span><span class="p">,</span> <span class="mh">0xB1203380</span><span class="p">,</span> <span class="mh">0xB1603000</span><span class="p">,</span> <span class="mh">0x2F303780</span><span class="p">,</span>
	<span class="mh">0x33002CC0</span><span class="p">,</span> <span class="mh">0x3000B100</span><span class="p">,</span> <span class="mh">0x3820B160</span><span class="p">,</span> <span class="mh">0x2C802F50</span><span class="p">,</span>
	<span class="mh">0xB10032A0</span><span class="p">,</span> <span class="mh">0xB1603000</span><span class="p">,</span> <span class="mh">0x2F9038C0</span><span class="p">,</span> <span class="mh">0x32202C20</span><span class="p">,</span>
	<span class="mh">0x3000B0E0</span><span class="p">,</span> <span class="mh">0x3980B160</span><span class="p">,</span> <span class="mh">0x2BC02FC0</span><span class="p">,</span> <span class="mh">0xB0E031C0</span><span class="p">,</span>
	<span class="mh">0xB1603000</span><span class="p">,</span> <span class="mh">0x2FF03A20</span><span class="p">,</span> <span class="mh">0x31602B60</span><span class="p">,</span> <span class="mh">0xB020B0C0</span><span class="p">,</span>
	<span class="mh">0x3AE0B160</span><span class="p">,</span> <span class="mh">0x2B001810</span><span class="p">,</span> <span class="mh">0xB0C03120</span><span class="p">,</span> <span class="mh">0xB140B020</span><span class="p">,</span>
	<span class="mh">0x18283BA0</span><span class="p">,</span> <span class="mh">0x30C02A80</span><span class="p">,</span> <span class="mh">0xB020B0A0</span><span class="p">,</span> <span class="mh">0x3C60B140</span><span class="p">,</span>
	<span class="mh">0x2A201838</span><span class="p">,</span> <span class="mh">0xB0A03080</span><span class="p">,</span> <span class="mh">0xB120B020</span><span class="p">,</span> <span class="mh">0x18383D20</span><span class="p">,</span>
	<span class="mh">0x304029C0</span><span class="p">,</span> <span class="mh">0xB040B080</span><span class="p">,</span> <span class="mh">0x3DE0B100</span><span class="p">,</span> <span class="mh">0x29601848</span><span class="p">,</span>
	<span class="mh">0xB0803000</span><span class="p">,</span> <span class="mh">0xB100B040</span><span class="p">,</span> <span class="mh">0x18483EC0</span><span class="p">,</span> <span class="mh">0xB0402900</span><span class="p">,</span>
	<span class="mh">0xB040B060</span><span class="p">,</span> <span class="mh">0x3F80B0C0</span><span class="p">,</span> <span class="mh">0x28801858</span><span class="p">,</span> <span class="mh">0xB060B080</span><span class="p">,</span>
	<span class="mh">0xB0A0B060</span><span class="p">,</span> <span class="mh">0x18602820</span><span class="p">,</span> <span class="mh">0xB0A02820</span><span class="p">,</span> <span class="mh">0x0000B060</span><span class="p">,</span>
	<span class="mh">0x36403000</span><span class="p">,</span> <span class="mh">0x2D002CC0</span><span class="p">,</span> <span class="mh">0x30003640</span><span class="p">,</span> <span class="mh">0x2D0036C0</span><span class="p">,</span>
	<span class="mh">0x35C02CC0</span><span class="p">,</span> <span class="mh">0x37403000</span><span class="p">,</span> <span class="mh">0x2C802D40</span><span class="p">,</span> <span class="mh">0x30003540</span><span class="p">,</span>
	<span class="mh">0x2D8037C0</span><span class="p">,</span> <span class="mh">0x34C02C40</span><span class="p">,</span> <span class="mh">0x38403000</span><span class="p">,</span> <span class="mh">0x2BC02E00</span><span class="p">,</span>
	<span class="mh">0x30003440</span><span class="p">,</span> <span class="mh">0x2E2038C0</span><span class="p">,</span> <span class="mh">0x34002B80</span><span class="p">,</span> <span class="mh">0x39803000</span><span class="p">,</span>
	<span class="mh">0x2B402E40</span><span class="p">,</span> <span class="mh">0x30003380</span><span class="p">,</span> <span class="mh">0x2E603A00</span><span class="p">,</span> <span class="mh">0x33402B00</span><span class="p">,</span>
	<span class="mh">0x3A803040</span><span class="p">,</span> <span class="mh">0x2A802EA0</span><span class="p">,</span> <span class="mh">0x30403300</span><span class="p">,</span> <span class="mh">0x2EC03B40</span><span class="p">,</span>
	<span class="mh">0x32802A40</span><span class="p">,</span> <span class="mh">0x3C003040</span><span class="p">,</span> <span class="mh">0x2A002EC0</span><span class="p">,</span> <span class="mh">0x30803240</span><span class="p">,</span>
	<span class="mh">0x2EC03C80</span><span class="p">,</span> <span class="mh">0x320029C0</span><span class="p">,</span> <span class="mh">0x3D403080</span><span class="p">,</span> <span class="mh">0x29402F00</span><span class="p">,</span>
	<span class="mh">0x308031C0</span><span class="p">,</span> <span class="mh">0x2F203DC0</span><span class="p">,</span> <span class="mh">0x31802900</span><span class="p">,</span> <span class="mh">0x3E8030C0</span><span class="p">,</span>
	<span class="mh">0x28802F40</span><span class="p">,</span> <span class="mh">0x30C03140</span><span class="p">,</span> <span class="mh">0x2F203F40</span><span class="p">,</span> <span class="mh">0x31402840</span><span class="p">,</span>
	<span class="mh">0x28003100</span><span class="p">,</span> <span class="mh">0x28002F00</span><span class="p">,</span> <span class="mh">0x00003100</span><span class="p">,</span> <span class="mh">0x36403000</span><span class="p">,</span>
	<span class="mh">0x2D002CC0</span><span class="p">,</span> <span class="mh">0x30003640</span><span class="p">,</span> <span class="mh">0x2D0036C0</span><span class="p">,</span>
	<span class="mh">0x35C02CC0</span><span class="p">,</span> <span class="mh">0x37403000</span><span class="p">,</span> <span class="mh">0x2C802D40</span><span class="p">,</span> <span class="mh">0x30003540</span><span class="p">,</span>
	<span class="mh">0x2D8037C0</span><span class="p">,</span> <span class="mh">0x34C02C40</span><span class="p">,</span> <span class="mh">0x38403000</span><span class="p">,</span> <span class="mh">0x2BC02E00</span><span class="p">,</span>
	<span class="mh">0x30003440</span><span class="p">,</span> <span class="mh">0x2E2038C0</span><span class="p">,</span> <span class="mh">0x34002B80</span><span class="p">,</span> <span class="mh">0x39803000</span><span class="p">,</span>
	<span class="mh">0x2B402E40</span><span class="p">,</span> <span class="mh">0x30003380</span><span class="p">,</span> <span class="mh">0x2E603A00</span><span class="p">,</span> <span class="mh">0x33402B00</span><span class="p">,</span>
	<span class="mh">0x3A803040</span><span class="p">,</span> <span class="mh">0x2A802EA0</span><span class="p">,</span> <span class="mh">0x30403300</span><span class="p">,</span> <span class="mh">0x2EC03B40</span><span class="p">,</span>
	<span class="mh">0x32802A40</span><span class="p">,</span> <span class="mh">0x3C003040</span><span class="p">,</span> <span class="mh">0x2A002EC0</span><span class="p">,</span> <span class="mh">0x30803240</span><span class="p">,</span>
	<span class="mh">0x2EC03C80</span><span class="p">,</span> <span class="mh">0x320029C0</span><span class="p">,</span> <span class="mh">0x3D403080</span><span class="p">,</span> <span class="mh">0x29402F00</span><span class="p">,</span>
	<span class="mh">0x308031C0</span><span class="p">,</span> <span class="mh">0x2F203DC0</span><span class="p">,</span> <span class="mh">0x31802900</span><span class="p">,</span> <span class="mh">0x3E8030C0</span><span class="p">,</span>
	<span class="mh">0x28802F40</span><span class="p">,</span> <span class="mh">0x30C03140</span><span class="p">,</span> <span class="mh">0x2F203F40</span><span class="p">,</span> <span class="mh">0x31402840</span><span class="p">,</span>
	<span class="mh">0x28003100</span><span class="p">,</span> <span class="mh">0x28002F00</span><span class="p">,</span> <span class="mh">0x00003100</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Color conversion values have 3 separate fixed point formats:</span>
<span class="cm"> *</span>
<span class="cm"> * 10 bit fields (ay, au)</span>
<span class="cm"> *   1.9 fixed point (b.bbbbbbbbb)</span>
<span class="cm"> * 11 bit fields (ry, by, ru, gu, gv)</span>
<span class="cm"> *   exp.mantissa (ee.mmmmmmmmm)</span>
<span class="cm"> *   ee = 00 = 10^-1 (0.mmmmmmmmm)</span>
<span class="cm"> *   ee = 01 = 10^-2 (0.0mmmmmmmmm)</span>
<span class="cm"> *   ee = 10 = 10^-3 (0.00mmmmmmmmm)</span>
<span class="cm"> *   ee = 11 = 10^-4 (0.000mmmmmmmmm)</span>
<span class="cm"> * 12 bit fields (gy, rv, bu)</span>
<span class="cm"> *   exp.mantissa (eee.mmmmmmmmm)</span>
<span class="cm"> *   eee = 000 = 10^-1 (0.mmmmmmmmm)</span>
<span class="cm"> *   eee = 001 = 10^-2 (0.0mmmmmmmmm)</span>
<span class="cm"> *   eee = 010 = 10^-3 (0.00mmmmmmmmm)</span>
<span class="cm"> *   eee = 011 = 10^-4 (0.000mmmmmmmmm)</span>
<span class="cm"> *   eee = 100 = reserved</span>
<span class="cm"> *   eee = 101 = reserved</span>
<span class="cm"> *   eee = 110 = reserved</span>
<span class="cm"> *   eee = 111 = 10^0 (m.mmmmmmmm) (only usable for 1.0 representation)</span>
<span class="cm"> *</span>
<span class="cm"> * Saturation and contrast are 8 bits, with their own representation:</span>
<span class="cm"> * 8 bit field (saturation, contrast)</span>
<span class="cm"> *   exp.mantissa (ee.mmmmmm)</span>
<span class="cm"> *   ee = 00 = 10^-1 (0.mmmmmm)</span>
<span class="cm"> *   ee = 01 = 10^0 (m.mmmmm)</span>
<span class="cm"> *   ee = 10 = 10^1 (mm.mmmm)</span>
<span class="cm"> *   ee = 11 = 10^2 (mmm.mmm)</span>
<span class="cm"> *</span>
<span class="cm"> * Simple conversion function:</span>
<span class="cm"> *</span>
<span class="cm"> * static u32</span>
<span class="cm"> * float_to_csc_11(float f)</span>
<span class="cm"> * {</span>
<span class="cm"> *     u32 exp;</span>
<span class="cm"> *     u32 mant;</span>
<span class="cm"> *     u32 ret;</span>
<span class="cm"> *</span>
<span class="cm"> *     if (f &lt; 0)</span>
<span class="cm"> *         f = -f;</span>
<span class="cm"> *</span>
<span class="cm"> *     if (f &gt;= 1) {</span>
<span class="cm"> *         exp = 0x7;</span>
<span class="cm"> *	   mant = 1 &lt;&lt; 8;</span>
<span class="cm"> *     } else {</span>
<span class="cm"> *         for (exp = 0; exp &lt; 3 &amp;&amp; f &lt; 0.5; exp++)</span>
<span class="cm"> *	   f *= 2.0;</span>
<span class="cm"> *         mant = (f * (1 &lt;&lt; 9) + 0.5);</span>
<span class="cm"> *         if (mant &gt;= (1 &lt;&lt; 9))</span>
<span class="cm"> *             mant = (1 &lt;&lt; 9) - 1;</span>
<span class="cm"> *     }</span>
<span class="cm"> *     ret = (exp &lt;&lt; 9) | mant;</span>
<span class="cm"> *     return ret;</span>
<span class="cm"> * }</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Behold, magic numbers!  If we plant them they might grow a big</span>
<span class="cm"> * s-video cable to the sky... or something.</span>
<span class="cm"> *</span>
<span class="cm"> * Pre-converted to appropriate hex value.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * PAL &amp; NTSC values for composite &amp; s-video connections</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">ntsc_m_csc_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0104</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0733</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x052d</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x05c7</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0340</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x030c</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06d0</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">ntsc_m_levels_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">225</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">267</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">113</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">ntsc_m_csc_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0133</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x076a</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0564</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x030d</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x037a</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x033d</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06f6</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">ntsc_m_levels_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">266</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">316</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">133</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">ntsc_j_csc_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0119</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x074c</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0546</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x05ec</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x035a</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x0322</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06e1</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">ntsc_j_levels_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">225</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">225</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">113</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">ntsc_j_csc_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x014c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0788</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0581</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x0322</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0399</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x0356</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x070a</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">ntsc_j_levels_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">266</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">266</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">133</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">pal_csc_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0113</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0745</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x053f</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x05e1</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0353</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x031c</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06dc</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">pal_levels_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">237</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">237</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">118</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">pal_csc_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0145</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0780</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0579</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x031c</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0390</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x034f</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x0705</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">pal_levels_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">280</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">280</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">139</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">pal_m_csc_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0104</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0733</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x052d</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x05c7</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0340</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x030c</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06d0</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">pal_m_levels_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">225</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">267</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">113</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">pal_m_csc_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0133</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x076a</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0564</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x030d</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x037a</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x033d</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06f6</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">pal_m_levels_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">266</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">316</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">133</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">pal_n_csc_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0104</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0733</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x052d</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x05c7</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0340</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x030c</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06d0</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">pal_n_levels_composite</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">225</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">267</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">118</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">pal_n_csc_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0133</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x076a</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0564</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x030d</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x037a</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x033d</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06f6</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">pal_n_levels_svideo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">266</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">316</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">139</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Component connections</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">sdtv_csc_yprpb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0332</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x07d3</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0145</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0559</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0353</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x03ad</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x074d</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">sdtv_csc_rgb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x0f00</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0166</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x0f00</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0166</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0f00</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0166</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">hdtv_csc_yprpb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x05b3</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x016e</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x0728</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0145</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x07d5</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x038b</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x03d1</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x06bc</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="n">hdtv_csc_rgb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ry</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">gy</span> <span class="o">=</span> <span class="mh">0x0f00</span><span class="p">,</span> <span class="p">.</span><span class="n">by</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">ay</span> <span class="o">=</span> <span class="mh">0x0166</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ru</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">gu</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">bu</span> <span class="o">=</span> <span class="mh">0x0f00</span><span class="p">,</span> <span class="p">.</span><span class="n">au</span> <span class="o">=</span> <span class="mh">0x0166</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rv</span> <span class="o">=</span> <span class="mh">0x0f00</span><span class="p">,</span> <span class="p">.</span><span class="n">gv</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">bv</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="p">.</span><span class="n">av</span> <span class="o">=</span> <span class="mh">0x0166</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="n">component_levels</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">blank</span> <span class="o">=</span> <span class="mi">279</span><span class="p">,</span> <span class="p">.</span><span class="n">black</span> <span class="o">=</span> <span class="mi">279</span><span class="p">,</span> <span class="p">.</span><span class="n">burst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">tv_mode</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refresh</span><span class="p">;</span> <span class="cm">/* in millihertz (for precision) */</span>
	<span class="n">u32</span> <span class="n">oversample</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsync_end</span><span class="p">,</span> <span class="n">hblank_start</span><span class="p">,</span> <span class="n">hblank_end</span><span class="p">,</span> <span class="n">htotal</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">progressive</span><span class="p">,</span> <span class="n">trilevel_sync</span><span class="p">,</span> <span class="n">component_only</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vsync_start_f1</span><span class="p">,</span> <span class="n">vsync_start_f2</span><span class="p">,</span> <span class="n">vsync_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">veq_ena</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">veq_start_f1</span><span class="p">,</span> <span class="n">veq_start_f2</span><span class="p">,</span> <span class="n">veq_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vi_end_f1</span><span class="p">,</span> <span class="n">vi_end_f2</span><span class="p">,</span> <span class="n">nbr_end</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">burst_ena</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hburst_start</span><span class="p">,</span> <span class="n">hburst_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vburst_start_f1</span><span class="p">,</span> <span class="n">vburst_end_f1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vburst_start_f2</span><span class="p">,</span> <span class="n">vburst_end_f2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vburst_start_f3</span><span class="p">,</span> <span class="n">vburst_end_f3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vburst_start_f4</span><span class="p">,</span> <span class="n">vburst_end_f4</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * subcarrier programming</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">dda2_size</span><span class="p">,</span> <span class="n">dda3_size</span><span class="p">,</span> <span class="n">dda1_inc</span><span class="p">,</span> <span class="n">dda2_inc</span><span class="p">,</span> <span class="n">dda3_inc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sc_reset</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pal_burst</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * blank/black levels</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="o">*</span><span class="n">composite_levels</span><span class="p">,</span> <span class="o">*</span><span class="n">svideo_levels</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="o">*</span><span class="n">composite_color</span><span class="p">,</span> <span class="o">*</span><span class="n">svideo_color</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">filter_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_srcw</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Sub carrier DDA</span>
<span class="cm"> *</span>
<span class="cm"> *  I think this works as follows:</span>
<span class="cm"> *</span>
<span class="cm"> *  subcarrier freq = pixel_clock * (dda1_inc + dda2_inc / dda2_size) / 4096</span>
<span class="cm"> *</span>
<span class="cm"> * Presumably, when dda3 is added in, it gets to adjust the dda2_inc value</span>
<span class="cm"> *</span>
<span class="cm"> * So,</span>
<span class="cm"> *  dda1_ideal = subcarrier/pixel * 4096</span>
<span class="cm"> *  dda1_inc = floor (dda1_ideal)</span>
<span class="cm"> *  dda2 = dda1_ideal - dda1_inc</span>
<span class="cm"> *</span>
<span class="cm"> *  then pick a ratio for dda2 that gives the closest approximation. If</span>
<span class="cm"> *  you can&#39;t get close enough, you can play with dda3 as well. This</span>
<span class="cm"> *  seems likely to happen when dda2 is small as the jumps would be larger</span>
<span class="cm"> *</span>
<span class="cm"> * To invert this,</span>
<span class="cm"> *</span>
<span class="cm"> *  pixel_clock = subcarrier * 4096 / (dda1_inc + dda2_inc / dda2_size)</span>
<span class="cm"> *</span>
<span class="cm"> * The constants below were all computed using a 107.520MHz clock</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * Register programming values for TV modes.</span>
<span class="cm"> *</span>
<span class="cm"> * These values account for -1s required.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="n">tv_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;NTSC-M&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">108000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">59940</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>	<span class="o">=</span> <span class="n">TV_OVERSAMPLE_8X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 3.580MHz */</span>

		<span class="p">.</span><span class="n">hsync_end</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hblank_end</span>		<span class="o">=</span> <span class="mi">124</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>	<span class="o">=</span> <span class="mi">836</span><span class="p">,</span>		    <span class="p">.</span><span class="n">htotal</span>		<span class="o">=</span> <span class="mi">857</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>	    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vsync_start_f2</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vi_end_f2</span>		<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hburst_start</span>	<span class="o">=</span> <span class="mi">72</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hburst_len</span>		<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f1</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f1</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f2</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f3</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f3</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f4</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f4</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="cm">/* desired 3.5800000 actual 3.5800000 clock 107.52 */</span>
		<span class="p">.</span><span class="n">dda1_inc</span>	<span class="o">=</span>    <span class="mi">135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda2_inc</span>	<span class="o">=</span>  <span class="mi">20800</span><span class="p">,</span>	    <span class="p">.</span><span class="n">dda2_size</span>		<span class="o">=</span>  <span class="mi">27456</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda3_inc</span>	<span class="o">=</span>      <span class="mi">0</span><span class="p">,</span>	    <span class="p">.</span><span class="n">dda3_size</span>		<span class="o">=</span>      <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_reset</span>	<span class="o">=</span> <span class="n">TV_SC_RESET_EVERY_4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pal_burst</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">composite_levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_levels_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">composite_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_csc_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_levels</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_levels_svideo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_csc_svideo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;NTSC-443&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">108000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">59940</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>	<span class="o">=</span> <span class="n">TV_OVERSAMPLE_8X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 4.43MHz */</span>
		<span class="p">.</span><span class="n">hsync_end</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hblank_end</span>		<span class="o">=</span> <span class="mi">124</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>	<span class="o">=</span> <span class="mi">836</span><span class="p">,</span>		    <span class="p">.</span><span class="n">htotal</span>		<span class="o">=</span> <span class="mi">857</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>	    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vsync_start_f2</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vi_end_f2</span>		<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hburst_start</span>	<span class="o">=</span> <span class="mi">72</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hburst_len</span>		<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f1</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f1</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f2</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f3</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f3</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f4</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f4</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="cm">/* desired 4.4336180 actual 4.4336180 clock 107.52 */</span>
		<span class="p">.</span><span class="n">dda1_inc</span>       <span class="o">=</span>    <span class="mi">168</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda2_inc</span>       <span class="o">=</span>   <span class="mi">4093</span><span class="p">,</span>       <span class="p">.</span><span class="n">dda2_size</span>      <span class="o">=</span>  <span class="mi">27456</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda3_inc</span>       <span class="o">=</span>    <span class="mi">310</span><span class="p">,</span>       <span class="p">.</span><span class="n">dda3_size</span>      <span class="o">=</span>    <span class="mi">525</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_reset</span>   <span class="o">=</span> <span class="n">TV_SC_RESET_NEVER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pal_burst</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">composite_levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_levels_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">composite_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_csc_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_levels</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_levels_svideo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_m_csc_svideo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;NTSC-J&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">108000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">59940</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>	<span class="o">=</span> <span class="n">TV_OVERSAMPLE_8X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="cm">/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 3.580MHz */</span>
		<span class="p">.</span><span class="n">hsync_end</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hblank_end</span>		<span class="o">=</span> <span class="mi">124</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span> <span class="o">=</span> <span class="mi">836</span><span class="p">,</span>	    <span class="p">.</span><span class="n">htotal</span>		<span class="o">=</span> <span class="mi">857</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	    <span class="p">.</span><span class="n">vsync_start_f2</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>      <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>	    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vi_end_f2</span>		<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hburst_start</span>	<span class="o">=</span> <span class="mi">72</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hburst_len</span>		<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f1</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f1</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f2</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f3</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f3</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f4</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f4</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="cm">/* desired 3.5800000 actual 3.5800000 clock 107.52 */</span>
		<span class="p">.</span><span class="n">dda1_inc</span>	<span class="o">=</span>    <span class="mi">135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda2_inc</span>	<span class="o">=</span>  <span class="mi">20800</span><span class="p">,</span>	    <span class="p">.</span><span class="n">dda2_size</span>		<span class="o">=</span>  <span class="mi">27456</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda3_inc</span>	<span class="o">=</span>      <span class="mi">0</span><span class="p">,</span>	    <span class="p">.</span><span class="n">dda3_size</span>		<span class="o">=</span>      <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_reset</span>	<span class="o">=</span> <span class="n">TV_SC_RESET_EVERY_4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pal_burst</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">composite_levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_j_levels_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">composite_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_j_csc_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_levels</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_j_levels_svideo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ntsc_j_csc_svideo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;PAL-M&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">108000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">59940</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>	<span class="o">=</span> <span class="n">TV_OVERSAMPLE_8X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="cm">/* 525 Lines, 60 Fields, 15.734KHz line, Sub-Carrier 3.580MHz */</span>
		<span class="p">.</span><span class="n">hsync_end</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>		  <span class="p">.</span><span class="n">hblank_end</span>		<span class="o">=</span> <span class="mi">124</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span> <span class="o">=</span> <span class="mi">836</span><span class="p">,</span>	  <span class="p">.</span><span class="n">htotal</span>		<span class="o">=</span> <span class="mi">857</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>	    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vsync_start_f2</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>	<span class="o">=</span> <span class="mi">20</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vi_end_f2</span>		<span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hburst_start</span>	<span class="o">=</span> <span class="mi">72</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hburst_len</span>		<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f1</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f1</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f2</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f3</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f3</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f4</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f4</span>	<span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

		<span class="cm">/* desired 3.5800000 actual 3.5800000 clock 107.52 */</span>
		<span class="p">.</span><span class="n">dda1_inc</span>	<span class="o">=</span>    <span class="mi">135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda2_inc</span>	<span class="o">=</span>  <span class="mi">16704</span><span class="p">,</span>	    <span class="p">.</span><span class="n">dda2_size</span>		<span class="o">=</span>  <span class="mi">27456</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda3_inc</span>	<span class="o">=</span>      <span class="mi">0</span><span class="p">,</span>	    <span class="p">.</span><span class="n">dda3_size</span>		<span class="o">=</span>      <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_reset</span>	<span class="o">=</span> <span class="n">TV_SC_RESET_EVERY_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pal_burst</span>  <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>

		<span class="p">.</span><span class="n">composite_levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_m_levels_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">composite_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_m_csc_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_levels</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_m_levels_svideo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_m_csc_svideo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* 625 Lines, 50 Fields, 15.625KHz line, Sub-Carrier 4.434MHz */</span>
		<span class="p">.</span><span class="n">name</span>	    <span class="o">=</span> <span class="s">&quot;PAL-N&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">108000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>	<span class="o">=</span> <span class="n">TV_OVERSAMPLE_8X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hblank_end</span>		<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span> <span class="o">=</span> <span class="mi">844</span><span class="p">,</span>	    <span class="p">.</span><span class="n">htotal</span>		<span class="o">=</span> <span class="mi">863</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>


		<span class="p">.</span><span class="n">vsync_start_f1</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	   <span class="p">.</span><span class="n">vsync_start_f2</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vi_end_f2</span>		<span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>	<span class="o">=</span> <span class="mi">286</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hburst_start</span> <span class="o">=</span> <span class="mi">73</span><span class="p">,</span>	    <span class="p">.</span><span class="n">hburst_len</span>		<span class="o">=</span> <span class="mi">34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f1</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	    <span class="p">.</span><span class="n">vburst_end_f1</span>	<span class="o">=</span> <span class="mi">285</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	    <span class="p">.</span><span class="n">vburst_end_f2</span>	<span class="o">=</span> <span class="mi">286</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f3</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	    <span class="p">.</span><span class="n">vburst_end_f3</span>	<span class="o">=</span> <span class="mi">286</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f4</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>	    <span class="p">.</span><span class="n">vburst_end_f4</span>	<span class="o">=</span> <span class="mi">285</span><span class="p">,</span>


		<span class="cm">/* desired 4.4336180 actual 4.4336180 clock 107.52 */</span>
		<span class="p">.</span><span class="n">dda1_inc</span>       <span class="o">=</span>    <span class="mi">135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda2_inc</span>       <span class="o">=</span>  <span class="mi">23578</span><span class="p">,</span>       <span class="p">.</span><span class="n">dda2_size</span>      <span class="o">=</span>  <span class="mi">27648</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda3_inc</span>       <span class="o">=</span>    <span class="mi">134</span><span class="p">,</span>       <span class="p">.</span><span class="n">dda3_size</span>      <span class="o">=</span>    <span class="mi">625</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_reset</span>   <span class="o">=</span> <span class="n">TV_SC_RESET_EVERY_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pal_burst</span>  <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>

		<span class="p">.</span><span class="n">composite_levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_n_levels_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">composite_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_n_csc_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_levels</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_n_levels_svideo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_n_csc_svideo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="cm">/* 625 Lines, 50 Fields, 15.625KHz line, Sub-Carrier 4.434MHz */</span>
		<span class="p">.</span><span class="n">name</span>	    <span class="o">=</span> <span class="s">&quot;PAL&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">108000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>	<span class="o">=</span> <span class="n">TV_OVERSAMPLE_8X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hblank_end</span>		<span class="o">=</span> <span class="mi">142</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>	<span class="o">=</span> <span class="mi">844</span><span class="p">,</span>	    <span class="p">.</span><span class="n">htotal</span>		<span class="o">=</span> <span class="mi">863</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	    <span class="p">.</span><span class="n">vsync_start_f2</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>	    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vi_end_f2</span>		<span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>	<span class="o">=</span> <span class="mi">286</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hburst_start</span>	<span class="o">=</span> <span class="mi">73</span><span class="p">,</span>		    <span class="p">.</span><span class="n">hburst_len</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f1</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f1</span>	<span class="o">=</span> <span class="mi">285</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f2</span>	<span class="o">=</span> <span class="mi">286</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f3</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f3</span>	<span class="o">=</span> <span class="mi">286</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vburst_start_f4</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>		    <span class="p">.</span><span class="n">vburst_end_f4</span>	<span class="o">=</span> <span class="mi">285</span><span class="p">,</span>

		<span class="cm">/* desired 4.4336180 actual 4.4336180 clock 107.52 */</span>
		<span class="p">.</span><span class="n">dda1_inc</span>       <span class="o">=</span>    <span class="mi">168</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda2_inc</span>       <span class="o">=</span>   <span class="mi">4122</span><span class="p">,</span>       <span class="p">.</span><span class="n">dda2_size</span>      <span class="o">=</span>  <span class="mi">27648</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dda3_inc</span>       <span class="o">=</span>     <span class="mi">67</span><span class="p">,</span>       <span class="p">.</span><span class="n">dda3_size</span>      <span class="o">=</span>    <span class="mi">625</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sc_reset</span>   <span class="o">=</span> <span class="n">TV_SC_RESET_EVERY_8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pal_burst</span>  <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>

		<span class="p">.</span><span class="n">composite_levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_levels_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">composite_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_csc_composite</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_levels</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_levels_svideo</span><span class="p">,</span>
		<span class="p">.</span><span class="n">svideo_color</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pal_csc_svideo</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;480p&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">107520</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">59940</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>     <span class="o">=</span> <span class="n">TV_OVERSAMPLE_4X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>      <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>               <span class="p">.</span><span class="n">hblank_end</span>         <span class="o">=</span> <span class="mi">122</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>   <span class="o">=</span> <span class="mi">842</span><span class="p">,</span>              <span class="p">.</span><span class="n">htotal</span>             <span class="o">=</span> <span class="mi">857</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>    <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>               <span class="p">.</span><span class="n">vsync_start_f2</span>     <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>        <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>      <span class="o">=</span> <span class="mi">44</span><span class="p">,</span>               <span class="p">.</span><span class="n">vi_end_f2</span>          <span class="o">=</span> <span class="mi">44</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>        <span class="o">=</span> <span class="mi">479</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>      <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;576p&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">107520</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>     <span class="o">=</span> <span class="n">TV_OVERSAMPLE_4X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>      <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>               <span class="p">.</span><span class="n">hblank_end</span>         <span class="o">=</span> <span class="mi">139</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>   <span class="o">=</span> <span class="mi">859</span><span class="p">,</span>              <span class="p">.</span><span class="n">htotal</span>             <span class="o">=</span> <span class="mi">863</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>    <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>               <span class="p">.</span><span class="n">vsync_start_f2</span>     <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>        <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>      <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>               <span class="p">.</span><span class="n">vi_end_f2</span>          <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>        <span class="o">=</span> <span class="mi">575</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>      <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;720p@60Hz&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">148800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>     <span class="o">=</span> <span class="n">TV_OVERSAMPLE_2X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>      <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>               <span class="p">.</span><span class="n">hblank_end</span>         <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>   <span class="o">=</span> <span class="mi">1580</span><span class="p">,</span>             <span class="p">.</span><span class="n">htotal</span>             <span class="o">=</span> <span class="mi">1649</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>               <span class="p">.</span><span class="n">vsync_start_f2</span>     <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>        <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>      <span class="o">=</span> <span class="mi">29</span><span class="p">,</span>               <span class="p">.</span><span class="n">vi_end_f2</span>          <span class="o">=</span> <span class="mi">29</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>        <span class="o">=</span> <span class="mi">719</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>      <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;720p@50Hz&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">148800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>     <span class="o">=</span> <span class="n">TV_OVERSAMPLE_2X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>      <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>               <span class="p">.</span><span class="n">hblank_end</span>         <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>   <span class="o">=</span> <span class="mi">1580</span><span class="p">,</span>             <span class="p">.</span><span class="n">htotal</span>             <span class="o">=</span> <span class="mi">1979</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>               <span class="p">.</span><span class="n">vsync_start_f2</span>     <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>        <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vi_end_f1</span>      <span class="o">=</span> <span class="mi">29</span><span class="p">,</span>               <span class="p">.</span><span class="n">vi_end_f2</span>          <span class="o">=</span> <span class="mi">29</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>        <span class="o">=</span> <span class="mi">719</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>      <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_srcw</span> <span class="o">=</span> <span class="mi">800</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;1080i@50Hz&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">148800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>     <span class="o">=</span> <span class="n">TV_OVERSAMPLE_2X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>      <span class="o">=</span> <span class="mi">88</span><span class="p">,</span>               <span class="p">.</span><span class="n">hblank_end</span>         <span class="o">=</span> <span class="mi">235</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>   <span class="o">=</span> <span class="mi">2155</span><span class="p">,</span>             <span class="p">.</span><span class="n">htotal</span>             <span class="o">=</span> <span class="mi">2639</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>	  <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>              <span class="p">.</span><span class="n">vsync_start_f2</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>	    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>


		<span class="p">.</span><span class="n">vi_end_f1</span>      <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>           <span class="p">.</span><span class="n">vi_end_f2</span>          <span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>        <span class="o">=</span> <span class="mi">539</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>      <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;1080i@60Hz&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span>		<span class="o">=</span> <span class="mi">148800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">refresh</span>	<span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">oversample</span>     <span class="o">=</span> <span class="n">TV_OVERSAMPLE_2X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">component_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

		<span class="p">.</span><span class="n">hsync_end</span>      <span class="o">=</span> <span class="mi">88</span><span class="p">,</span>               <span class="p">.</span><span class="n">hblank_end</span>         <span class="o">=</span> <span class="mi">235</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hblank_start</span>   <span class="o">=</span> <span class="mi">2155</span><span class="p">,</span>             <span class="p">.</span><span class="n">htotal</span>             <span class="o">=</span> <span class="mi">2199</span><span class="p">,</span>

		<span class="p">.</span><span class="n">progressive</span>	<span class="o">=</span> <span class="nb">false</span><span class="p">,</span>	    <span class="p">.</span><span class="n">trilevel_sync</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vsync_start_f1</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>               <span class="p">.</span><span class="n">vsync_start_f2</span>     <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_len</span>      <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

		<span class="p">.</span><span class="n">veq_ena</span>	<span class="o">=</span> <span class="nb">true</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_start_f1</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">veq_start_f2</span>	<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>		    <span class="p">.</span><span class="n">veq_len</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>


		<span class="p">.</span><span class="n">vi_end_f1</span>      <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>               <span class="p">.</span><span class="n">vi_end_f2</span>          <span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
		<span class="p">.</span><span class="n">nbr_end</span>        <span class="o">=</span> <span class="mi">539</span><span class="p">,</span>

		<span class="p">.</span><span class="n">burst_ena</span>      <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>

		<span class="p">.</span><span class="n">filter_table</span> <span class="o">=</span> <span class="n">filter_table</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="nf">enc_to_intel_tv</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_tv</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="nf">intel_attached_tv</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
			    <span class="k">struct</span> <span class="n">intel_tv</span><span class="p">,</span>
			    <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_tv_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">TV_ENC_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TV_ENC_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span>
<span class="nf">intel_tv_mode_lookup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tv_format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tv_modes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span><span class="n">tv_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tv_modes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">tv_format</span><span class="p">,</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">tv_mode</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span>
<span class="nf">intel_tv_mode_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_tv_mode_lookup</span><span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_mode_status</span>
<span class="nf">intel_tv_mode_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">intel_attached_tv</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span><span class="n">tv_mode</span> <span class="o">=</span> <span class="n">intel_tv_mode_find</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">);</span>

	<span class="cm">/* Ensure TV refresh is close to desired refresh */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span> <span class="o">&amp;&amp;</span> <span class="n">abs</span><span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">-</span> <span class="n">drm_mode_vrefresh</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
				<span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_OK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">MODE_CLOCK_RANGE</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_tv_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">drm_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">enc_to_intel_tv</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span><span class="n">tv_mode</span> <span class="o">=</span> <span class="n">intel_tv_mode_find</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">other_encoder</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* FIXME: lock encoder list */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">other_encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drm_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">other_encoder</span> <span class="o">!=</span> <span class="n">encoder</span> <span class="o">&amp;&amp;</span>
		    <span class="n">other_encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_tv_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">enc_to_intel_tv</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span><span class="n">tv_mode</span> <span class="o">=</span> <span class="n">intel_tv_mode_find</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tv_ctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hctl1</span><span class="p">,</span> <span class="n">hctl2</span><span class="p">,</span> <span class="n">hctl3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vctl1</span><span class="p">,</span> <span class="n">vctl2</span><span class="p">,</span> <span class="n">vctl3</span><span class="p">,</span> <span class="n">vctl4</span><span class="p">,</span> <span class="n">vctl5</span><span class="p">,</span> <span class="n">vctl6</span><span class="p">,</span> <span class="n">vctl7</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scctl1</span><span class="p">,</span> <span class="n">scctl2</span><span class="p">,</span> <span class="n">scctl3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">video_levels</span> <span class="o">*</span><span class="n">video_levels</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">color_conversion</span> <span class="o">*</span><span class="n">color_conversion</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">burst_ena</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* can&#39;t happen (mode_prepare prevents this) */</span>

	<span class="n">tv_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">);</span>
	<span class="n">tv_ctl</span> <span class="o">&amp;=</span> <span class="n">TV_CTL_SAVE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_Unknown</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_Composite</span>:
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_ENC_OUTPUT_COMPOSITE</span><span class="p">;</span>
		<span class="n">video_levels</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">composite_levels</span><span class="p">;</span>
		<span class="n">color_conversion</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">composite_color</span><span class="p">;</span>
		<span class="n">burst_ena</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">burst_ena</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_Component</span>:
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_ENC_OUTPUT_COMPONENT</span><span class="p">;</span>
		<span class="n">video_levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">component_levels</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">burst_ena</span><span class="p">)</span>
			<span class="n">color_conversion</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sdtv_csc_yprpb</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">color_conversion</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdtv_csc_yprpb</span><span class="p">;</span>
		<span class="n">burst_ena</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span>:
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_ENC_OUTPUT_SVIDEO</span><span class="p">;</span>
		<span class="n">video_levels</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">svideo_levels</span><span class="p">;</span>
		<span class="n">color_conversion</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">svideo_color</span><span class="p">;</span>
		<span class="n">burst_ena</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">burst_ena</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hctl1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">&lt;&lt;</span> <span class="n">TV_HSYNC_END_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">&lt;&lt;</span> <span class="n">TV_HTOTAL_SHIFT</span><span class="p">);</span>

	<span class="n">hctl2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">hburst_start</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">hburst_len</span> <span class="o">&lt;&lt;</span> <span class="n">TV_HBURST_LEN_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst_ena</span><span class="p">)</span>
		<span class="n">hctl2</span> <span class="o">|=</span> <span class="n">TV_BURST_ENA</span><span class="p">;</span>

	<span class="n">hctl3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">hblank_start</span> <span class="o">&lt;&lt;</span> <span class="n">TV_HBLANK_START_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">hblank_end</span> <span class="o">&lt;&lt;</span> <span class="n">TV_HBLANK_END_SHIFT</span><span class="p">);</span>

	<span class="n">vctl1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">nbr_end</span> <span class="o">&lt;&lt;</span> <span class="n">TV_NBR_END_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vi_end_f1</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VI_END_F1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vi_end_f2</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VI_END_F2_SHIFT</span><span class="p">);</span>

	<span class="n">vctl2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VSYNC_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vsync_start_f1</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VSYNC_START_F1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vsync_start_f2</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VSYNC_START_F2_SHIFT</span><span class="p">);</span>

	<span class="n">vctl3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">veq_len</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VEQ_LEN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">veq_start_f1</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VEQ_START_F1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">veq_start_f2</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VEQ_START_F2_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">veq_ena</span><span class="p">)</span>
		<span class="n">vctl3</span> <span class="o">|=</span> <span class="n">TV_EQUAL_ENA</span><span class="p">;</span>

	<span class="n">vctl4</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_start_f1</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_START_F1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_end_f1</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_END_F1_SHIFT</span><span class="p">);</span>

	<span class="n">vctl5</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_start_f2</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_START_F2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_end_f2</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_END_F2_SHIFT</span><span class="p">);</span>

	<span class="n">vctl6</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_start_f3</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_START_F3_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_end_f3</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_END_F3_SHIFT</span><span class="p">);</span>

	<span class="n">vctl7</span> <span class="o">=</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_start_f4</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_START_F4_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">vburst_end_f4</span> <span class="o">&lt;&lt;</span> <span class="n">TV_VBURST_END_F4_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_ENC_PIPEB_SELECT</span><span class="p">;</span>
	<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">oversample</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">progressive</span><span class="p">)</span>
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_PROGRESSIVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">trilevel_sync</span><span class="p">)</span>
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_TRILEVEL_SYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">pal_burst</span><span class="p">)</span>
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_PAL_BURST</span><span class="p">;</span>

	<span class="n">scctl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda1_inc</span><span class="p">)</span>
		<span class="n">scctl1</span> <span class="o">|=</span> <span class="n">TV_SC_DDA1_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda2_inc</span><span class="p">)</span>
		<span class="n">scctl1</span> <span class="o">|=</span> <span class="n">TV_SC_DDA2_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda3_inc</span><span class="p">)</span>
		<span class="n">scctl1</span> <span class="o">|=</span> <span class="n">TV_SC_DDA3_EN</span><span class="p">;</span>
	<span class="n">scctl1</span> <span class="o">|=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">sc_reset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_levels</span><span class="p">)</span>
		<span class="n">scctl1</span> <span class="o">|=</span> <span class="n">video_levels</span><span class="o">-&gt;</span><span class="n">burst</span> <span class="o">&lt;&lt;</span> <span class="n">TV_BURST_LEVEL_SHIFT</span><span class="p">;</span>
	<span class="n">scctl1</span> <span class="o">|=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda1_inc</span> <span class="o">&lt;&lt;</span> <span class="n">TV_SCDDA1_INC_SHIFT</span><span class="p">;</span>

	<span class="n">scctl2</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda2_size</span> <span class="o">&lt;&lt;</span> <span class="n">TV_SCDDA2_SIZE_SHIFT</span> <span class="o">|</span>
		<span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda2_inc</span> <span class="o">&lt;&lt;</span> <span class="n">TV_SCDDA2_INC_SHIFT</span><span class="p">;</span>

	<span class="n">scctl3</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda3_size</span> <span class="o">&lt;&lt;</span> <span class="n">TV_SCDDA3_SIZE_SHIFT</span> <span class="o">|</span>
		<span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">dda3_inc</span> <span class="o">&lt;&lt;</span> <span class="n">TV_SCDDA3_INC_SHIFT</span><span class="p">;</span>

	<span class="cm">/* Enable two fixes for the chips that need them. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_device</span> <span class="o">&lt;</span> <span class="mh">0x2772</span><span class="p">)</span>
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_ENC_C0_FIX</span> <span class="o">|</span> <span class="n">TV_ENC_SDP_FIX</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_H_CTL_1</span><span class="p">,</span> <span class="n">hctl1</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_H_CTL_2</span><span class="p">,</span> <span class="n">hctl2</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_H_CTL_3</span><span class="p">,</span> <span class="n">hctl3</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CTL_1</span><span class="p">,</span> <span class="n">vctl1</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CTL_2</span><span class="p">,</span> <span class="n">vctl2</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CTL_3</span><span class="p">,</span> <span class="n">vctl3</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CTL_4</span><span class="p">,</span> <span class="n">vctl4</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CTL_5</span><span class="p">,</span> <span class="n">vctl5</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CTL_6</span><span class="p">,</span> <span class="n">vctl6</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CTL_7</span><span class="p">,</span> <span class="n">vctl7</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_SC_CTL_1</span><span class="p">,</span> <span class="n">scctl1</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_SC_CTL_2</span><span class="p">,</span> <span class="n">scctl2</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_SC_CTL_3</span><span class="p">,</span> <span class="n">scctl3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">color_conversion</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CSC_Y</span><span class="p">,</span> <span class="p">(</span><span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">ry</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">gy</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CSC_Y2</span><span class="p">,</span> <span class="p">(</span><span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">by</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">ay</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CSC_U</span><span class="p">,</span> <span class="p">(</span><span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">ru</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">gu</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CSC_U2</span><span class="p">,</span> <span class="p">(</span><span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">bu</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">au</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CSC_V</span><span class="p">,</span> <span class="p">(</span><span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">rv</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">gv</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CSC_V2</span><span class="p">,</span> <span class="p">(</span><span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">bv</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">color_conversion</span><span class="o">-&gt;</span><span class="n">av</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CLR_KNOBS</span><span class="p">,</span> <span class="mh">0x00404000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CLR_KNOBS</span><span class="p">,</span> <span class="mh">0x00606000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_levels</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CLR_LEVEL</span><span class="p">,</span>
			   <span class="p">((</span><span class="n">video_levels</span><span class="o">-&gt;</span><span class="n">black</span> <span class="o">&lt;&lt;</span> <span class="n">TV_BLACK_LEVEL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">video_levels</span><span class="o">-&gt;</span><span class="n">blank</span> <span class="o">&lt;&lt;</span> <span class="n">TV_BLANK_LEVEL_SHIFT</span><span class="p">)));</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">pipeconf_reg</span> <span class="o">=</span> <span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">dspcntr_reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">pipeconf</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">pipeconf_reg</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">dspcntr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dspcntr_reg</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">dspbase_reg</span> <span class="o">=</span> <span class="n">DSPADDR</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">xpos</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">ypos</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xsize</span><span class="p">,</span> <span class="n">ysize</span><span class="p">;</span>
		<span class="cm">/* Pipe must be off here */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">dspcntr_reg</span><span class="p">,</span> <span class="n">dspcntr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
		<span class="cm">/* Flush the plane changes */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">dspbase_reg</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dspbase_reg</span><span class="p">));</span>

		<span class="cm">/* Wait for vblank for the disable to take effect */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">pipeconf_reg</span><span class="p">,</span> <span class="n">pipeconf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIPECONF_ENABLE</span><span class="p">);</span>
		<span class="cm">/* Wait for vblank for the disable to take effect. */</span>
		<span class="n">intel_wait_for_pipe_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

		<span class="cm">/* Filter ctl must be set before TV_WIN_SIZE */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_FILTER_CTL_1</span><span class="p">,</span> <span class="n">TV_AUTO_SCALE</span><span class="p">);</span>
		<span class="n">xsize</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">hblank_start</span> <span class="o">-</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">hblank_end</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">progressive</span><span class="p">)</span>
			<span class="n">ysize</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">nbr_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ysize</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">nbr_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">xpos</span> <span class="o">+=</span> <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_LEFT</span><span class="p">];</span>
		<span class="n">ypos</span> <span class="o">+=</span> <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_TOP</span><span class="p">];</span>
		<span class="n">xsize</span> <span class="o">-=</span> <span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_LEFT</span><span class="p">]</span> <span class="o">+</span>
			  <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_RIGHT</span><span class="p">]);</span>
		<span class="n">ysize</span> <span class="o">-=</span> <span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_TOP</span><span class="p">]</span> <span class="o">+</span>
			  <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_BOTTOM</span><span class="p">]);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_WIN_POS</span><span class="p">,</span> <span class="p">(</span><span class="n">xpos</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="n">ypos</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_WIN_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">xsize</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="n">ysize</span><span class="p">);</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">pipeconf_reg</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">dspcntr_reg</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>
		<span class="cm">/* Flush the plane changes */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">dspbase_reg</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dspbase_reg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_H_LUMA_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">filter_table</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_H_CHROMA_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">filter_table</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">43</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_LUMA_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">filter_table</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">43</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_V_CHROMA_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">),</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">filter_table</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TV_DAC_SAVE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">,</span> <span class="n">tv_ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="n">reported_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;NTSC 480i&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">107520</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="mi">1280</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="mi">1368</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="mi">1496</span><span class="p">,</span>
		<span class="p">.</span><span class="n">htotal</span> <span class="o">=</span> <span class="mi">1712</span><span class="p">,</span>

		<span class="p">.</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="mi">1027</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="mi">1034</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vtotal</span> <span class="o">=</span> <span class="mi">1104</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Detects TV presence by checking for load.</span>
<span class="cm"> *</span>
<span class="cm"> * Requires that the current pipe&#39;s DPLL is active.</span>

<span class="cm"> * \return true if TV is connected.</span>
<span class="cm"> * \return false if TV is disconnected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_tv_detect_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tv_ctl</span><span class="p">,</span> <span class="n">save_tv_ctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tv_dac</span><span class="p">,</span> <span class="n">save_tv_dac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="cm">/* Disable TV interrupts around load detect or we&#39;ll recurse */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">&amp;</span> <span class="n">DRM_CONNECTOR_POLL_HPD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
		<span class="n">i915_disable_pipestat</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">PIPE_HOTPLUG_INTERRUPT_ENABLE</span> <span class="o">|</span>
				      <span class="n">PIPE_HOTPLUG_TV_INTERRUPT_ENABLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">save_tv_dac</span> <span class="o">=</span> <span class="n">tv_dac</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">);</span>
	<span class="n">save_tv_ctl</span> <span class="o">=</span> <span class="n">tv_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">);</span>

	<span class="cm">/* Poll for TV detection */</span>
	<span class="n">tv_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TV_ENC_ENABLE</span> <span class="o">|</span> <span class="n">TV_TEST_MODE_MASK</span><span class="p">);</span>
	<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_TEST_MODE_MONITOR_DETECT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tv_ctl</span> <span class="o">|=</span> <span class="n">TV_ENC_PIPEB_SELECT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tv_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TV_ENC_PIPEB_SELECT</span><span class="p">;</span>

	<span class="n">tv_dac</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TVDAC_SENSE_MASK</span> <span class="o">|</span> <span class="n">DAC_A_MASK</span> <span class="o">|</span> <span class="n">DAC_B_MASK</span> <span class="o">|</span> <span class="n">DAC_C_MASK</span><span class="p">);</span>
	<span class="n">tv_dac</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TVDAC_STATE_CHG_EN</span> <span class="o">|</span>
		   <span class="n">TVDAC_A_SENSE_CTL</span> <span class="o">|</span>
		   <span class="n">TVDAC_B_SENSE_CTL</span> <span class="o">|</span>
		   <span class="n">TVDAC_C_SENSE_CTL</span> <span class="o">|</span>
		   <span class="n">DAC_CTL_OVERRIDE</span> <span class="o">|</span>
		   <span class="n">DAC_A_0_7_V</span> <span class="o">|</span>
		   <span class="n">DAC_B_0_7_V</span> <span class="o">|</span>
		   <span class="n">DAC_C_0_7_V</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * The TV sense state should be cleared to zero on cantiga platform. Otherwise</span>
<span class="cm">	 * the TV is misdetected. This is hardware requirement.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GM45</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">tv_dac</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TVDAC_STATE_CHG_EN</span> <span class="o">|</span> <span class="n">TVDAC_A_SENSE_CTL</span> <span class="o">|</span>
			    <span class="n">TVDAC_B_SENSE_CTL</span> <span class="o">|</span> <span class="n">TVDAC_C_SENSE_CTL</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">,</span> <span class="n">tv_ctl</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">,</span> <span class="n">tv_dac</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">);</span>

	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">tv_dac</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;TV detected: %x, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tv_ctl</span><span class="p">,</span> <span class="n">tv_dac</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *  A B C</span>
<span class="cm">	 *  0 1 1 Composite</span>
<span class="cm">	 *  1 0 X svideo</span>
<span class="cm">	 *  0 0 0 Component</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tv_dac</span> <span class="o">&amp;</span> <span class="n">TVDAC_SENSE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">TVDAC_B_SENSE</span> <span class="o">|</span> <span class="n">TVDAC_C_SENSE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Detected Composite TV connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_Composite</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tv_dac</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TVDAC_A_SENSE</span><span class="o">|</span><span class="n">TVDAC_B_SENSE</span><span class="p">))</span> <span class="o">==</span> <span class="n">TVDAC_A_SENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Detected S-Video TV connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tv_dac</span> <span class="o">&amp;</span> <span class="n">TVDAC_SENSE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Detected Component TV connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_Component</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unrecognised TV connection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">,</span> <span class="n">save_tv_dac</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TVDAC_STATE_CHG_EN</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">,</span> <span class="n">save_tv_ctl</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">);</span>

	<span class="cm">/* For unknown reasons the hw barfs if we don&#39;t do this vblank wait. */</span>
	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* Restore interrupt config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">&amp;</span> <span class="n">DRM_CONNECTOR_POLL_HPD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
		<span class="n">i915_enable_pipestat</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">PIPE_HOTPLUG_INTERRUPT_ENABLE</span> <span class="o">|</span>
				     <span class="n">PIPE_HOTPLUG_TV_INTERRUPT_ENABLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Here we set accurate tv format according to connector type</span>
<span class="cm"> * i.e Component TV should not be assigned by NTSC or PAL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_tv_find_better_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">intel_attached_tv</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span><span class="n">tv_mode</span> <span class="o">=</span> <span class="n">intel_tv_mode_find</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_Component</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">component_only</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tv_modes</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tv_modes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tv_mode</span> <span class="o">=</span> <span class="n">tv_modes</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DRM_MODE_CONNECTOR_Component</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">component_only</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">tv_format</span> <span class="o">=</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_mode_property</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Detect the TV connection.</span>
<span class="cm"> *</span>
<span class="cm"> * Currently this always returns CONNECTOR_STATUS_UNKNOWN, as we need to be sure</span>
<span class="cm"> * we have a pipe programmed in order to probe the TV.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">intel_tv_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">intel_attached_tv</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">reported_modes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_load_detect_pipe</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_get_load_detect_pipe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">intel_tv_detect_type</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">,</span> <span class="n">connector</span><span class="p">);</span>
			<span class="n">intel_release_load_detect_pipe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
						       <span class="n">connector</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>

	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">intel_tv_find_better_format</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">input_res</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">;</span>
<span class="p">}</span> <span class="n">input_res_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;640x480&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;800x600&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;1024x768&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;1280x1024&quot;</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;848x480&quot;</span><span class="p">,</span> <span class="mi">848</span><span class="p">,</span> <span class="mi">480</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;1280x720&quot;</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;1920x1080&quot;</span><span class="p">,</span> <span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Chose preferred mode  according to line number of TV format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_tv_chose_preferred_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">intel_attached_tv</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span><span class="n">tv_mode</span> <span class="o">=</span> <span class="n">intel_tv_mode_find</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">nbr_end</span> <span class="o">&lt;</span> <span class="mi">480</span> <span class="o">&amp;&amp;</span> <span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">==</span> <span class="mi">480</span><span class="p">)</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">nbr_end</span> <span class="o">&gt;</span> <span class="mi">480</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">progressive</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">nbr_end</span> <span class="o">&lt;</span> <span class="mi">720</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span>
				<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">==</span> <span class="mi">1080</span><span class="p">)</span>
				<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Stub get_modes function.</span>
<span class="cm"> *</span>
<span class="cm"> * This should probably return a set of fixed modes, unless we can figure out</span>
<span class="cm"> * how to probe modes off of TV connections.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_tv_get_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">intel_attached_tv</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tv_mode</span> <span class="o">*</span><span class="n">tv_mode</span> <span class="o">=</span> <span class="n">intel_tv_mode_find</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">input_res_table</span><span class="p">);</span>
	     <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">input_res</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">input_res_table</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hactive_s</span> <span class="o">=</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vactive_s</span> <span class="o">=</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">h</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">max_srcw</span> <span class="o">&amp;&amp;</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">max_srcw</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">w</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">progressive</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">component_only</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mode_ptr</span> <span class="o">=</span> <span class="n">drm_mode_create</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode_ptr</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRM_DISPLAY_MODE_LEN</span><span class="p">);</span>

		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="n">hactive_s</span><span class="p">;</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="n">hactive_s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">hactive_s</span> <span class="o">+</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">&lt;=</span> <span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">hsync_start</span><span class="p">)</span>
			<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">hactive_s</span> <span class="o">+</span> <span class="mi">96</span><span class="p">;</span>

		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="n">vactive_s</span><span class="p">;</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="n">vactive_s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="n">vactive_s</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">&lt;=</span> <span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vsync_start</span><span class="p">)</span>
			<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vsync_start</span>  <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">vactive_s</span> <span class="o">+</span> <span class="mi">33</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">tv_mode</span><span class="o">-&gt;</span><span class="n">refresh</span> <span class="o">*</span> <span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">*=</span> <span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">mode_ptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">;</span>
		<span class="n">intel_tv_chose_preferred_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode_ptr</span><span class="p">);</span>
		<span class="n">drm_mode_probed_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode_ptr</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_tv_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_sysfs_connector_remove</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">drm_connector_cleanup</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_tv_set_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
		      <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span> <span class="o">=</span> <span class="n">intel_attached_tv</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_left_margin_property</span> <span class="o">&amp;&amp;</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_LEFT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_LEFT</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_right_margin_property</span> <span class="o">&amp;&amp;</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_RIGHT</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_RIGHT</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_top_margin_property</span> <span class="o">&amp;&amp;</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_TOP</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_TOP</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_bottom_margin_property</span> <span class="o">&amp;&amp;</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_BOTTOM</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_BOTTOM</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_mode_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tv_modes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">,</span> <span class="n">tv_modes</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">name</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">tv_format</span> <span class="o">=</span> <span class="n">tv_modes</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="p">)</span>
		<span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span>
				<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">intel_tv_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">intel_tv_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">intel_tv_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">intel_encoder_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">intel_tv_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">intel_encoder_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_connector_funcs</span> <span class="n">intel_tv_connector_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">drm_helper_connector_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">intel_tv_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_tv_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_property</span> <span class="o">=</span> <span class="n">intel_tv_set_property</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_modes</span> <span class="o">=</span> <span class="n">drm_helper_probe_single_connector_modes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_connector_helper_funcs</span> <span class="n">intel_tv_connector_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mode_valid</span> <span class="o">=</span> <span class="n">intel_tv_mode_valid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_modes</span> <span class="o">=</span> <span class="n">intel_tv_get_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">best_encoder</span> <span class="o">=</span> <span class="n">intel_best_encoder</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_funcs</span> <span class="n">intel_tv_enc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_encoder_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Enumerate the child dev array parsed from VBT to check whether</span>
<span class="cm"> * the integrated TV is present.</span>
<span class="cm"> * If it is present, return 1.</span>
<span class="cm"> * If it is not present, return false.</span>
<span class="cm"> * If no child dev is parsed from VBT, it assumes that the TV is present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tv_is_present_in_vbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">child_device_config</span> <span class="o">*</span><span class="n">p_child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev_num</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p_child</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the device type is not TV, continue.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_child</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_TYPE_INT_TV</span> <span class="o">&amp;&amp;</span>
			<span class="n">p_child</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_TYPE_TV</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Only when the addin_offset is non-zero, it is regarded</span>
<span class="cm">		 * as present.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_child</span><span class="o">-&gt;</span><span class="n">addin_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">intel_tv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_tv</span> <span class="o">*</span><span class="n">intel_tv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">intel_connector</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tv_dac_on</span><span class="p">,</span> <span class="n">tv_dac_off</span><span class="p">,</span> <span class="n">save_tv_dac</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tv_format_names</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tv_modes</span><span class="p">)];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">initial_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TV_FUSE_STATE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TV_FUSE_STATE_DISABLED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tv_is_present_in_vbt</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Integrated TV is not present.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Even if we have an encoder we may not have a connector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">int_tv_support</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check the TV output by checking to see if the</span>
<span class="cm">	 * DAC register holds a value</span>
<span class="cm">	 */</span>
	<span class="n">save_tv_dac</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">,</span> <span class="n">save_tv_dac</span> <span class="o">|</span> <span class="n">TVDAC_STATE_CHG_EN</span><span class="p">);</span>
	<span class="n">tv_dac_on</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">,</span> <span class="n">save_tv_dac</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TVDAC_STATE_CHG_EN</span><span class="p">);</span>
	<span class="n">tv_dac_off</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TV_DAC</span><span class="p">,</span> <span class="n">save_tv_dac</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the register does not hold the state change enable</span>
<span class="cm">	 * bit, (either as a 0 or a 1), assume it doesn&#39;t really</span>
<span class="cm">	 * exist</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tv_dac_on</span> <span class="o">&amp;</span> <span class="n">TVDAC_STATE_CHG_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">tv_dac_off</span> <span class="o">&amp;</span> <span class="n">TVDAC_STATE_CHG_EN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">intel_tv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_tv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">intel_tv</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="cm">/* The documentation, for the older chipsets at least, recommend</span>
<span class="cm">	 * using a polling method rather than hotplug detection for TVs.</span>
<span class="cm">	 * This is because in order to perform the hotplug detection, the PLLs</span>
<span class="cm">	 * for the TV must be kept alive increasing power drain and starving</span>
<span class="cm">	 * bandwidth from other encoders. Notably for instance, it causes</span>
<span class="cm">	 * pipe underruns on Crestline when this encoder is supposedly idle.</span>
<span class="cm">	 *</span>
<span class="cm">	 * More recent chipsets favour HDMI rather than integrated S-Video.</span>
<span class="cm">	 */</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">=</span> <span class="n">DRM_CONNECTOR_POLL_CONNECT</span><span class="p">;</span>

	<span class="n">drm_connector_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_tv_connector_funcs</span><span class="p">,</span>
			   <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">);</span>

	<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_tv_enc_funcs</span><span class="p">,</span>
			 <span class="n">DRM_MODE_ENCODER_TVDAC</span><span class="p">);</span>

	<span class="n">intel_connector_attach_encoder</span><span class="p">(</span><span class="n">intel_connector</span><span class="p">,</span> <span class="n">intel_encoder</span><span class="p">);</span>
	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">INTEL_OUTPUT_TVOUT</span><span class="p">;</span>
	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">crtc_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_TV_CLONE_BIT</span><span class="p">);</span>
	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">possible_clones</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_OUTPUT_TVOUT</span><span class="p">);</span>
	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">;</span>

	<span class="cm">/* BIOS margin values */</span>
	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_LEFT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">54</span><span class="p">;</span>
	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_TOP</span><span class="p">]</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_RIGHT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">46</span><span class="p">;</span>
	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_BOTTOM</span><span class="p">]</span> <span class="o">=</span> <span class="mi">37</span><span class="p">;</span>

	<span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">tv_format</span> <span class="o">=</span> <span class="n">tv_modes</span><span class="p">[</span><span class="n">initial_mode</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>

	<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_tv_helper_funcs</span><span class="p">);</span>
	<span class="n">drm_connector_helper_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_tv_connector_helper_funcs</span><span class="p">);</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">interlace_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">doublescan_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Create TV properties then attach current values */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tv_modes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tv_format_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">tv_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="n">drm_mode_create_tv_properties</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tv_modes</span><span class="p">),</span>
				      <span class="n">tv_format_names</span><span class="p">);</span>

	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_mode_property</span><span class="p">,</span>
				   <span class="n">initial_mode</span><span class="p">);</span>
	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_left_margin_property</span><span class="p">,</span>
				   <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_LEFT</span><span class="p">]);</span>
	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_top_margin_property</span><span class="p">,</span>
				   <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_TOP</span><span class="p">]);</span>
	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_right_margin_property</span><span class="p">,</span>
				   <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_RIGHT</span><span class="p">]);</span>
	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_bottom_margin_property</span><span class="p">,</span>
				   <span class="n">intel_tv</span><span class="o">-&gt;</span><span class="n">margin</span><span class="p">[</span><span class="n">TV_MARGIN_BOTTOM</span><span class="p">]);</span>
	<span class="n">drm_sysfs_connector_add</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
