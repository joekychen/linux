<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › intel_pm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>intel_pm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2012 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Eugeni Dodonov &lt;eugeni.dodonov@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &quot;../../../platform/x86/intel_ips.h&quot;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cm">/* FBC, or Frame Buffer Compression, is a technique employed to compress the</span>
<span class="cm"> * framebuffer contents in-memory, aiming at reducing the required bandwidth</span>
<span class="cm"> * during in-memory transfers and, therefore, reduce the power packet.</span>
<span class="cm"> *</span>
<span class="cm"> * The benefits of FBC are mostly visible with solid backgrounds and</span>
<span class="cm"> * variation-less patterns.</span>
<span class="cm"> *</span>
<span class="cm"> * FBC-related functionality can be enabled by the means of the</span>
<span class="cm"> * i915.i915_enable_fbc parameter</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_disable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fbc_ctl</span><span class="p">;</span>

	<span class="cm">/* Disable compression */</span>
	<span class="n">fbc_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FBC_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fbc_ctl</span> <span class="o">&amp;</span> <span class="n">FBC_CTL_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fbc_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FBC_CTL_EN</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FBC_CONTROL</span><span class="p">,</span> <span class="n">fbc_ctl</span><span class="p">);</span>

	<span class="cm">/* Wait for compressing bit to clear */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">FBC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FBC_STAT_COMPRESSING</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FBC idle timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disabled FBC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_enable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cfb_pitch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fbc_ctl</span><span class="p">,</span> <span class="n">fbc_ctl2</span><span class="p">;</span>

	<span class="n">cfb_pitch</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_size</span> <span class="o">/</span> <span class="n">FBC_LL_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cfb_pitch</span><span class="p">)</span>
		<span class="n">cfb_pitch</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* FBC_CTL wants 64B units */</span>
	<span class="n">cfb_pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfb_pitch</span> <span class="o">/</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">FBC_CTL_PLANEA</span> <span class="o">:</span> <span class="n">FBC_CTL_PLANEB</span><span class="p">;</span>

	<span class="cm">/* Clear old tags */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FBC_LL_SIZE</span> <span class="o">/</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FBC_TAG</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set it up... */</span>
	<span class="n">fbc_ctl2</span> <span class="o">=</span> <span class="n">FBC_CTL_FENCE_DBL</span> <span class="o">|</span> <span class="n">FBC_CTL_IDLE_IMM</span> <span class="o">|</span> <span class="n">FBC_CTL_CPU_FENCE</span><span class="p">;</span>
	<span class="n">fbc_ctl2</span> <span class="o">|=</span> <span class="n">plane</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FBC_CONTROL2</span><span class="p">,</span> <span class="n">fbc_ctl2</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FBC_FENCE_OFF</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>

	<span class="cm">/* enable it... */</span>
	<span class="n">fbc_ctl</span> <span class="o">=</span> <span class="n">FBC_CTL_EN</span> <span class="o">|</span> <span class="n">FBC_CTL_PERIODIC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">fbc_ctl</span> <span class="o">|=</span> <span class="n">FBC_CTL_C3_IDLE</span><span class="p">;</span> <span class="cm">/* 945 needs special SR handling */</span>
	<span class="n">fbc_ctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cfb_pitch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FBC_CTL_STRIDE_SHIFT</span><span class="p">;</span>
	<span class="n">fbc_ctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&amp;</span> <span class="mh">0x2fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FBC_CTL_INTERVAL_SHIFT</span><span class="p">;</span>
	<span class="n">fbc_ctl</span> <span class="o">|=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FBC_CONTROL</span><span class="p">,</span> <span class="n">fbc_ctl</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;enabled FBC, pitch %d, yoff %d, plane %d, &quot;</span><span class="p">,</span>
		      <span class="n">cfb_pitch</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">i8xx_fbc_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FBC_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FBC_CTL_EN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">g4x_enable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">DPFC_CTL_PLANEA</span> <span class="o">:</span> <span class="n">DPFC_CTL_PLANEB</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stall_watermark</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpfc_ctl</span><span class="p">;</span>

	<span class="n">dpfc_ctl</span> <span class="o">=</span> <span class="n">plane</span> <span class="o">|</span> <span class="n">DPFC_SR_EN</span> <span class="o">|</span> <span class="n">DPFC_CTL_LIMIT_1X</span><span class="p">;</span>
	<span class="n">dpfc_ctl</span> <span class="o">|=</span> <span class="n">DPFC_CTL_FENCE_EN</span> <span class="o">|</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPFC_CHICKEN</span><span class="p">,</span> <span class="n">DPFC_HT_MODIFY</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPFC_RECOMP_CTL</span><span class="p">,</span> <span class="n">DPFC_RECOMP_STALL_EN</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">stall_watermark</span> <span class="o">&lt;&lt;</span> <span class="n">DPFC_RECOMP_STALL_WM_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">interval</span> <span class="o">&lt;&lt;</span> <span class="n">DPFC_RECOMP_TIMER_COUNT_SHIFT</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPFC_FENCE_YOFF</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>

	<span class="cm">/* enable it... */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPFC_CONTROL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DPFC_CONTROL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DPFC_CTL_EN</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;enabled fbc on plane %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">g4x_disable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpfc_ctl</span><span class="p">;</span>

	<span class="cm">/* Disable compression */</span>
	<span class="n">dpfc_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DPFC_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dpfc_ctl</span> <span class="o">&amp;</span> <span class="n">DPFC_CTL_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpfc_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPFC_CTL_EN</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPFC_CONTROL</span><span class="p">,</span> <span class="n">dpfc_ctl</span><span class="p">);</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disabled FBC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">g4x_fbc_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DPFC_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPFC_CTL_EN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sandybridge_blit_fbc_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blt_ecoskpd</span><span class="p">;</span>

	<span class="cm">/* Make sure blitter notifies FBC of writes */</span>
	<span class="n">gen6_gt_force_wake_get</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">blt_ecoskpd</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_BLITTER_ECOSKPD</span><span class="p">);</span>
	<span class="n">blt_ecoskpd</span> <span class="o">|=</span> <span class="n">GEN6_BLITTER_FBC_NOTIFY</span> <span class="o">&lt;&lt;</span>
		<span class="n">GEN6_BLITTER_LOCK_SHIFT</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_BLITTER_ECOSKPD</span><span class="p">,</span> <span class="n">blt_ecoskpd</span><span class="p">);</span>
	<span class="n">blt_ecoskpd</span> <span class="o">|=</span> <span class="n">GEN6_BLITTER_FBC_NOTIFY</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_BLITTER_ECOSKPD</span><span class="p">,</span> <span class="n">blt_ecoskpd</span><span class="p">);</span>
	<span class="n">blt_ecoskpd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">GEN6_BLITTER_FBC_NOTIFY</span> <span class="o">&lt;&lt;</span>
			 <span class="n">GEN6_BLITTER_LOCK_SHIFT</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_BLITTER_ECOSKPD</span><span class="p">,</span> <span class="n">blt_ecoskpd</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">GEN6_BLITTER_ECOSKPD</span><span class="p">);</span>
	<span class="n">gen6_gt_force_wake_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_enable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">DPFC_CTL_PLANEA</span> <span class="o">:</span> <span class="n">DPFC_CTL_PLANEB</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stall_watermark</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpfc_ctl</span><span class="p">;</span>

	<span class="n">dpfc_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DPFC_CONTROL</span><span class="p">);</span>
	<span class="n">dpfc_ctl</span> <span class="o">&amp;=</span> <span class="n">DPFC_RESERVED</span><span class="p">;</span>
	<span class="n">dpfc_ctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">plane</span> <span class="o">|</span> <span class="n">DPFC_CTL_LIMIT_1X</span><span class="p">);</span>
	<span class="cm">/* Set persistent mode for front-buffer rendering, ala X. */</span>
	<span class="n">dpfc_ctl</span> <span class="o">|=</span> <span class="n">DPFC_CTL_PERSISTENT_MODE</span><span class="p">;</span>
	<span class="n">dpfc_ctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DPFC_CTL_FENCE_EN</span> <span class="o">|</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DPFC_CHICKEN</span><span class="p">,</span> <span class="n">DPFC_HT_MODIFY</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DPFC_RECOMP_CTL</span><span class="p">,</span> <span class="n">DPFC_RECOMP_STALL_EN</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">stall_watermark</span> <span class="o">&lt;&lt;</span> <span class="n">DPFC_RECOMP_STALL_WM_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">interval</span> <span class="o">&lt;&lt;</span> <span class="n">DPFC_RECOMP_TIMER_COUNT_SHIFT</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DPFC_FENCE_YOFF</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_FBC_RT_BASE</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">|</span> <span class="n">ILK_FBC_RT_VALID</span><span class="p">);</span>
	<span class="cm">/* enable it... */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DPFC_CONTROL</span><span class="p">,</span> <span class="n">dpfc_ctl</span> <span class="o">|</span> <span class="n">DPFC_CTL_EN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SNB_DPFC_CTL_SA</span><span class="p">,</span>
			   <span class="n">SNB_CPU_FENCE_ENABLE</span> <span class="o">|</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPFC_CPU_FENCE_OFFSET</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="n">sandybridge_blit_fbc_update</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;enabled fbc on plane %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_disable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpfc_ctl</span><span class="p">;</span>

	<span class="cm">/* Disable compression */</span>
	<span class="n">dpfc_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DPFC_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dpfc_ctl</span> <span class="o">&amp;</span> <span class="n">DPFC_CTL_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpfc_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPFC_CTL_EN</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DPFC_CONTROL</span><span class="p">,</span> <span class="n">dpfc_ctl</span><span class="p">);</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disabled FBC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ironlake_fbc_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DPFC_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPFC_CTL_EN</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">intel_fbc_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fbc_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fbc_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_fbc_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">__work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_fbc_work</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">to_delayed_work</span><span class="p">(</span><span class="n">__work</span><span class="p">),</span>
			     <span class="k">struct</span> <span class="n">intel_fbc_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbc_work</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Double check that we haven&#39;t switched fb without cancelling</span>
<span class="cm">		 * the prior work.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">enable_fbc</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span>
						     <span class="n">work</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>

			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_plane</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_fb</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_y</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbc_work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_cancel_fbc_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbc_work</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;cancelling pending FBC enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Synchronisation is provided by struct_mutex and checking of</span>
<span class="cm">	 * dev_priv-&gt;fbc_work, so we can perform the cancellation</span>
<span class="cm">	 * entirely asynchronously.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbc_work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">))</span>
		<span class="cm">/* tasklet was killed before being run, clean up */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbc_work</span><span class="p">);</span>

	<span class="cm">/* Mark the work as no longer wanted so that if it does</span>
<span class="cm">	 * wake-up (because the work was already running and waiting</span>
<span class="cm">	 * for our mutex), it will discover that is no longer</span>
<span class="cm">	 * necessary to run.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbc_work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_enable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_fbc_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">enable_fbc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">intel_cancel_fbc_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">work</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">enable_fbc</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">work</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">intel_fbc_work_fn</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbc_work</span> <span class="o">=</span> <span class="n">work</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;scheduling delayed FBC enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Delay the actual enabling to let pageflipping cease and the</span>
<span class="cm">	 * display to settle before starting the compression. Note that</span>
<span class="cm">	 * this delay also serves a second purpose: it allows for a</span>
<span class="cm">	 * vblank to pass after disabling the FBC before we attempt</span>
<span class="cm">	 * to modify the control registers.</span>
<span class="cm">	 *</span>
<span class="cm">	 * A more complicated solution would involve tracking vblanks</span>
<span class="cm">	 * following the termination of the page-flipping sequence</span>
<span class="cm">	 * and indeed performing the enable as a co-routine and not</span>
<span class="cm">	 * waiting synchronously upon the vblank.</span>
<span class="cm">	 */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_disable_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">intel_cancel_fbc_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">disable_fbc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_plane</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_update_fbc - enable/disable FBC as needed</span>
<span class="cm"> * @dev: the drm_device</span>
<span class="cm"> *</span>
<span class="cm"> * Set up the framebuffer compression hardware at mode set time.  We</span>
<span class="cm"> * enable it if possible:</span>
<span class="cm"> *   - plane A only (on pre-965)</span>
<span class="cm"> *   - no pixel mulitply/line duplication</span>
<span class="cm"> *   - no alpha buffer discard</span>
<span class="cm"> *   - no dual wide</span>
<span class="cm"> *   - framebuffer &lt;= 2048 in width, 1536 in height</span>
<span class="cm"> *</span>
<span class="cm"> * We can&#39;t assume that any compression will take place (worst case),</span>
<span class="cm"> * so the compressed buffer has to be the same size as the uncompressed</span>
<span class="cm"> * one.  It also must reside (along with the line length buffer) in</span>
<span class="cm"> * stolen memory.</span>
<span class="cm"> *</span>
<span class="cm"> * We need to enable/disable FBC on a global basis.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_update_fbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable_fbc</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_powersave</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I915_HAS_FBC</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If FBC is already on, we just have to verify that we can</span>
<span class="cm">	 * keep it that way...</span>
<span class="cm">	 * Need to disable if:</span>
<span class="cm">	 *   - more than one pipe is active</span>
<span class="cm">	 *   - changing FBC params (stride, fence, mode)</span>
<span class="cm">	 *   - new fb is too large to fit in compressed buffer</span>
<span class="cm">	 *   - going to an unsupported config (interlace, pixel multiply, etc.)</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">tmp_crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;more than one pipe active, disabling compression</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_MULTIPLE_PIPES</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">crtc</span> <span class="o">=</span> <span class="n">tmp_crtc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span> <span class="o">||</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;no output, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_NO_OUTPUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>

	<span class="n">enable_fbc</span> <span class="o">=</span> <span class="n">i915_enable_fbc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_fbc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;fbc set to per-chip default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enable_fbc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">enable_fbc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_fbc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;fbc disabled per module param</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_MODULE_PARAM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;framebuffer too large, disabling &quot;</span>
			      <span class="s">&quot;compression</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_STOLEN_TOO_SMALL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;mode incompatible with compression, &quot;</span>
			      <span class="s">&quot;disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_UNSUPPORTED_MODE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">&gt;</span> <span class="mi">1536</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;mode too large for compression, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_MODE_TOO_LARGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;plane not 0, disabling compression</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_BAD_PLANE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The use of a CPU fence is mandatory in order to detect writes</span>
<span class="cm">	 * by the CPU to the scanout and trigger updates to the FBC.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">!=</span> <span class="n">I915_TILING_X</span> <span class="o">||</span>
	    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">==</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;framebuffer not tiled or fenced, disabling compression</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span> <span class="o">=</span> <span class="n">FBC_NOT_TILED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the kernel debugger is active, always disable compression */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_dbg_master</span><span class="p">())</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>

	<span class="cm">/* If the scanout has not changed, don&#39;t modify the FBC settings.</span>
<span class="cm">	 * Note that we make the fundamental assumption that the fb-&gt;obj</span>
<span class="cm">	 * cannot be unpinned (and have its GTT offset and fence revoked)</span>
<span class="cm">	 * without first being decoupled from the scanout and FBC disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_plane</span> <span class="o">==</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_fb</span> <span class="o">==</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_y</span> <span class="o">==</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_fbc_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We update FBC along two paths, after changing fb/crtc</span>
<span class="cm">		 * configuration (modeswitching) and after page-flipping</span>
<span class="cm">		 * finishes. For the latter, we know that not only did</span>
<span class="cm">		 * we disable the FBC at the start of the page-flip</span>
<span class="cm">		 * sequence, but also more than one vblank has passed.</span>
<span class="cm">		 *</span>
<span class="cm">		 * For the former case of modeswitching, it is possible</span>
<span class="cm">		 * to switch between two FBC valid configurations</span>
<span class="cm">		 * instantaneously so we do need to disable the FBC</span>
<span class="cm">		 * before we can modify its control registers. We also</span>
<span class="cm">		 * have to wait for the next vblank for that to take</span>
<span class="cm">		 * effect. However, since we delay enabling FBC we can</span>
<span class="cm">		 * assume that a vblank has passed since disabling and</span>
<span class="cm">		 * that we can safely alter the registers in the deferred</span>
<span class="cm">		 * callback.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In the scenario that we go from a valid to invalid</span>
<span class="cm">		 * and then back to valid FBC configuration we have</span>
<span class="cm">		 * no strict enforcement that a vblank occurred since</span>
<span class="cm">		 * disabling the FBC. However, along all current pipe</span>
<span class="cm">		 * disabling paths we do need to wait for a vblank at</span>
<span class="cm">		 * some point. And we wait before enabling FBC anyway.</span>
<span class="cm">		 */</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disabling active FBC for update</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intel_disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_enable_fbc</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_disable:</span>
	<span class="cm">/* Multiple disables should be harmless */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_fbc_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;unsupported config, disabling FBC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intel_disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_pineview_get_mem_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CLKCFG</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CLKCFG_FSB_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_533</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">533</span><span class="p">;</span> <span class="cm">/* 133*4 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_800</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span> <span class="cm">/* 200*4 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_667</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span>  <span class="mi">667</span><span class="p">;</span> <span class="cm">/* 167*4 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_400</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">400</span><span class="p">;</span> <span class="cm">/* 100*4 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CLKCFG_MEM_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLKCFG_MEM_533</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">533</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_MEM_667</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">667</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_MEM_800</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* detect pineview DDR3 setting */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CSHRDDR3CTL</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">is_ddr3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">CSHRDDR3CTL_DDR3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_ironlake_get_mem_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ddrpll</span><span class="p">,</span> <span class="n">csipll</span><span class="p">;</span>

	<span class="n">ddrpll</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">DDRMPLL1</span><span class="p">);</span>
	<span class="n">csipll</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">CSIPLL0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ddrpll</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0xc</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">1066</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x14</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">1333</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x18</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">1600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;unknown memory frequency 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ddrpll</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">r_t</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">csipll</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00c</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">3200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x00e</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">3733</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x010</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">4266</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x012</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">4800</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x014</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">5333</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x016</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">5866</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x018</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">6400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;unknown fsb frequency 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">csipll</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">==</span> <span class="mi">3200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">c_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">&gt;</span> <span class="mi">3200</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">&lt;=</span> <span class="mi">4800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">c_m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">c_m</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cxsr_latency</span> <span class="n">cxsr_latency_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3382</span><span class="p">,</span> <span class="mi">33382</span><span class="p">,</span> <span class="mi">3983</span><span class="p">,</span> <span class="mi">33983</span><span class="p">},</span>    <span class="cm">/* DDR2-400 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">3354</span><span class="p">,</span> <span class="mi">33354</span><span class="p">,</span> <span class="mi">3807</span><span class="p">,</span> <span class="mi">33807</span><span class="p">},</span>    <span class="cm">/* DDR2-667 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">3347</span><span class="p">,</span> <span class="mi">33347</span><span class="p">,</span> <span class="mi">3763</span><span class="p">,</span> <span class="mi">33763</span><span class="p">},</span>    <span class="cm">/* DDR2-800 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">6420</span><span class="p">,</span> <span class="mi">36420</span><span class="p">,</span> <span class="mi">6873</span><span class="p">,</span> <span class="mi">36873</span><span class="p">},</span>    <span class="cm">/* DDR3-667 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">5902</span><span class="p">,</span> <span class="mi">35902</span><span class="p">,</span> <span class="mi">6318</span><span class="p">,</span> <span class="mi">36318</span><span class="p">},</span>    <span class="cm">/* DDR3-800 SC */</span>

	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3400</span><span class="p">,</span> <span class="mi">33400</span><span class="p">,</span> <span class="mi">4021</span><span class="p">,</span> <span class="mi">34021</span><span class="p">},</span>    <span class="cm">/* DDR2-400 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">3372</span><span class="p">,</span> <span class="mi">33372</span><span class="p">,</span> <span class="mi">3845</span><span class="p">,</span> <span class="mi">33845</span><span class="p">},</span>    <span class="cm">/* DDR2-667 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">3386</span><span class="p">,</span> <span class="mi">33386</span><span class="p">,</span> <span class="mi">3822</span><span class="p">,</span> <span class="mi">33822</span><span class="p">},</span>    <span class="cm">/* DDR2-800 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">6438</span><span class="p">,</span> <span class="mi">36438</span><span class="p">,</span> <span class="mi">6911</span><span class="p">,</span> <span class="mi">36911</span><span class="p">},</span>    <span class="cm">/* DDR3-667 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">5941</span><span class="p">,</span> <span class="mi">35941</span><span class="p">,</span> <span class="mi">6377</span><span class="p">,</span> <span class="mi">36377</span><span class="p">},</span>    <span class="cm">/* DDR3-800 SC */</span>

	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3472</span><span class="p">,</span> <span class="mi">33472</span><span class="p">,</span> <span class="mi">4173</span><span class="p">,</span> <span class="mi">34173</span><span class="p">},</span>    <span class="cm">/* DDR2-400 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">3443</span><span class="p">,</span> <span class="mi">33443</span><span class="p">,</span> <span class="mi">3996</span><span class="p">,</span> <span class="mi">33996</span><span class="p">},</span>    <span class="cm">/* DDR2-667 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">3430</span><span class="p">,</span> <span class="mi">33430</span><span class="p">,</span> <span class="mi">3946</span><span class="p">,</span> <span class="mi">33946</span><span class="p">},</span>    <span class="cm">/* DDR2-800 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">6509</span><span class="p">,</span> <span class="mi">36509</span><span class="p">,</span> <span class="mi">7062</span><span class="p">,</span> <span class="mi">37062</span><span class="p">},</span>    <span class="cm">/* DDR3-667 SC */</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">5985</span><span class="p">,</span> <span class="mi">35985</span><span class="p">,</span> <span class="mi">6501</span><span class="p">,</span> <span class="mi">36501</span><span class="p">},</span>    <span class="cm">/* DDR3-800 SC */</span>

	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3438</span><span class="p">,</span> <span class="mi">33438</span><span class="p">,</span> <span class="mi">4065</span><span class="p">,</span> <span class="mi">34065</span><span class="p">},</span>    <span class="cm">/* DDR2-400 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">3410</span><span class="p">,</span> <span class="mi">33410</span><span class="p">,</span> <span class="mi">3889</span><span class="p">,</span> <span class="mi">33889</span><span class="p">},</span>    <span class="cm">/* DDR2-667 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">3403</span><span class="p">,</span> <span class="mi">33403</span><span class="p">,</span> <span class="mi">3845</span><span class="p">,</span> <span class="mi">33845</span><span class="p">},</span>    <span class="cm">/* DDR2-800 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">6476</span><span class="p">,</span> <span class="mi">36476</span><span class="p">,</span> <span class="mi">6955</span><span class="p">,</span> <span class="mi">36955</span><span class="p">},</span>    <span class="cm">/* DDR3-667 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">5958</span><span class="p">,</span> <span class="mi">35958</span><span class="p">,</span> <span class="mi">6400</span><span class="p">,</span> <span class="mi">36400</span><span class="p">},</span>    <span class="cm">/* DDR3-800 SC */</span>

	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3456</span><span class="p">,</span> <span class="mi">33456</span><span class="p">,</span> <span class="mi">4103</span><span class="p">,</span> <span class="mi">34106</span><span class="p">},</span>    <span class="cm">/* DDR2-400 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">3428</span><span class="p">,</span> <span class="mi">33428</span><span class="p">,</span> <span class="mi">3927</span><span class="p">,</span> <span class="mi">33927</span><span class="p">},</span>    <span class="cm">/* DDR2-667 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">3443</span><span class="p">,</span> <span class="mi">33443</span><span class="p">,</span> <span class="mi">3905</span><span class="p">,</span> <span class="mi">33905</span><span class="p">},</span>    <span class="cm">/* DDR2-800 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">6494</span><span class="p">,</span> <span class="mi">36494</span><span class="p">,</span> <span class="mi">6993</span><span class="p">,</span> <span class="mi">36993</span><span class="p">},</span>    <span class="cm">/* DDR3-667 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">5998</span><span class="p">,</span> <span class="mi">35998</span><span class="p">,</span> <span class="mi">6460</span><span class="p">,</span> <span class="mi">36460</span><span class="p">},</span>    <span class="cm">/* DDR3-800 SC */</span>

	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">3528</span><span class="p">,</span> <span class="mi">33528</span><span class="p">,</span> <span class="mi">4255</span><span class="p">,</span> <span class="mi">34255</span><span class="p">},</span>    <span class="cm">/* DDR2-400 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">3500</span><span class="p">,</span> <span class="mi">33500</span><span class="p">,</span> <span class="mi">4079</span><span class="p">,</span> <span class="mi">34079</span><span class="p">},</span>    <span class="cm">/* DDR2-667 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">3487</span><span class="p">,</span> <span class="mi">33487</span><span class="p">,</span> <span class="mi">4029</span><span class="p">,</span> <span class="mi">34029</span><span class="p">},</span>    <span class="cm">/* DDR2-800 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">667</span><span class="p">,</span> <span class="mi">6566</span><span class="p">,</span> <span class="mi">36566</span><span class="p">,</span> <span class="mi">7145</span><span class="p">,</span> <span class="mi">37145</span><span class="p">},</span>    <span class="cm">/* DDR3-667 SC */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">6042</span><span class="p">,</span> <span class="mi">36042</span><span class="p">,</span> <span class="mi">6584</span><span class="p">,</span> <span class="mi">36584</span><span class="p">},</span>    <span class="cm">/* DDR3-800 SC */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cxsr_latency</span> <span class="o">*</span><span class="nf">intel_get_cxsr_latency</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_desktop</span><span class="p">,</span>
							 <span class="kt">int</span> <span class="n">is_ddr3</span><span class="p">,</span>
							 <span class="kt">int</span> <span class="n">fsb</span><span class="p">,</span>
							 <span class="kt">int</span> <span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cxsr_latency</span> <span class="o">*</span><span class="n">latency</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fsb</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mem</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cxsr_latency_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">latency</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cxsr_latency_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_desktop</span> <span class="o">==</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">is_desktop</span> <span class="o">&amp;&amp;</span>
		    <span class="n">is_ddr3</span> <span class="o">==</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">is_ddr3</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fsb</span> <span class="o">==</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">fsb_freq</span> <span class="o">&amp;&amp;</span> <span class="n">mem</span> <span class="o">==</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">mem_freq</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">latency</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown FSB/MEM found, disable CxSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pineview_disable_cxsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* deactivate cxsr */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PINEVIEW_SELF_REFRESH_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Latency for FIFO fetches is dependent on several factors:</span>
<span class="cm"> *   - memory configuration (speed, channels)</span>
<span class="cm"> *   - chipset</span>
<span class="cm"> *   - current MCH state</span>
<span class="cm"> * It can be fairly high in some situations, so here we assume a fairly</span>
<span class="cm"> * pessimal value.  It&#39;s a tradeoff between extra memory fetches (if we</span>
<span class="cm"> * set this value too high, the FIFO will fetch frequently to stay full)</span>
<span class="cm"> * and power consumption (set it too low to save power and we might see</span>
<span class="cm"> * FIFO underruns and display &quot;flicker&quot;).</span>
<span class="cm"> *</span>
<span class="cm"> * A value of 5us seems to be a good balance; safe for very low end</span>
<span class="cm"> * platforms but not overly aggressive on lower latency configs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">latency_ns</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i9xx_get_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsparb</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPARB</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">dsparb</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">dsparb</span> <span class="o">&gt;&gt;</span> <span class="n">DSPARB_CSTART_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO size - (0x%08x) %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsparb</span><span class="p">,</span>
		      <span class="n">plane</span> <span class="o">?</span> <span class="s">&quot;B&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i85x_get_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsparb</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPARB</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">dsparb</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">dsparb</span> <span class="o">&gt;&gt;</span> <span class="n">DSPARB_BEND_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Convert to cachelines */</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO size - (0x%08x) %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsparb</span><span class="p">,</span>
		      <span class="n">plane</span> <span class="o">?</span> <span class="s">&quot;B&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i845_get_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsparb</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPARB</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">dsparb</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Convert to cachelines */</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO size - (0x%08x) %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsparb</span><span class="p">,</span>
		      <span class="n">plane</span> <span class="o">?</span> <span class="s">&quot;B&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span>
		      <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i830_get_fifo_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dsparb</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPARB</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">dsparb</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Convert to cachelines */</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO size - (0x%08x) %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsparb</span><span class="p">,</span>
		      <span class="n">plane</span> <span class="o">?</span> <span class="s">&quot;B&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Pineview has different values for various configs */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">pineview_display_wm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PINEVIEW_DISPLAY_FIFO</span><span class="p">,</span>
	<span class="n">PINEVIEW_MAX_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_DFT_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_GUARD_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">pineview_display_hplloff_wm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PINEVIEW_DISPLAY_FIFO</span><span class="p">,</span>
	<span class="n">PINEVIEW_MAX_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_DFT_HPLLOFF_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_GUARD_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">pineview_cursor_wm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PINEVIEW_CURSOR_FIFO</span><span class="p">,</span>
	<span class="n">PINEVIEW_CURSOR_MAX_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_CURSOR_DFT_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_CURSOR_GUARD_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_FIFO_LINE_SIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">pineview_cursor_hplloff_wm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PINEVIEW_CURSOR_FIFO</span><span class="p">,</span>
	<span class="n">PINEVIEW_CURSOR_MAX_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_CURSOR_DFT_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_CURSOR_GUARD_WM</span><span class="p">,</span>
	<span class="n">PINEVIEW_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">g4x_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">G4X_FIFO_SIZE</span><span class="p">,</span>
	<span class="n">G4X_MAX_WM</span><span class="p">,</span>
	<span class="n">G4X_MAX_WM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">G4X_FIFO_LINE_SIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">g4x_cursor_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I965_CURSOR_FIFO</span><span class="p">,</span>
	<span class="n">I965_CURSOR_MAX_WM</span><span class="p">,</span>
	<span class="n">I965_CURSOR_DFT_WM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">G4X_FIFO_LINE_SIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">valleyview_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">VALLEYVIEW_FIFO_SIZE</span><span class="p">,</span>
	<span class="n">VALLEYVIEW_MAX_WM</span><span class="p">,</span>
	<span class="n">VALLEYVIEW_MAX_WM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">G4X_FIFO_LINE_SIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">valleyview_cursor_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I965_CURSOR_FIFO</span><span class="p">,</span>
	<span class="n">VALLEYVIEW_CURSOR_MAX_WM</span><span class="p">,</span>
	<span class="n">I965_CURSOR_DFT_WM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">G4X_FIFO_LINE_SIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">i965_cursor_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I965_CURSOR_FIFO</span><span class="p">,</span>
	<span class="n">I965_CURSOR_MAX_WM</span><span class="p">,</span>
	<span class="n">I965_CURSOR_DFT_WM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">I915_FIFO_LINE_SIZE</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">i945_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I945_FIFO_SIZE</span><span class="p">,</span>
	<span class="n">I915_MAX_WM</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">I915_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">i915_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I915_FIFO_SIZE</span><span class="p">,</span>
	<span class="n">I915_MAX_WM</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">I915_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">i855_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I855GM_FIFO_SIZE</span><span class="p">,</span>
	<span class="n">I915_MAX_WM</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">I830_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">i830_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">I830_FIFO_SIZE</span><span class="p">,</span>
	<span class="n">I915_MAX_WM</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">I830_FIFO_LINE_SIZE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">ironlake_display_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ILK_DISPLAY_FIFO</span><span class="p">,</span>
	<span class="n">ILK_DISPLAY_MAXWM</span><span class="p">,</span>
	<span class="n">ILK_DISPLAY_DFTWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">ILK_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">ironlake_cursor_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ILK_CURSOR_FIFO</span><span class="p">,</span>
	<span class="n">ILK_CURSOR_MAXWM</span><span class="p">,</span>
	<span class="n">ILK_CURSOR_DFTWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">ILK_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">ironlake_display_srwm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ILK_DISPLAY_SR_FIFO</span><span class="p">,</span>
	<span class="n">ILK_DISPLAY_MAX_SRWM</span><span class="p">,</span>
	<span class="n">ILK_DISPLAY_DFT_SRWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">ILK_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">ironlake_cursor_srwm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ILK_CURSOR_SR_FIFO</span><span class="p">,</span>
	<span class="n">ILK_CURSOR_MAX_SRWM</span><span class="p">,</span>
	<span class="n">ILK_CURSOR_DFT_SRWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">ILK_FIFO_LINE_SIZE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">sandybridge_display_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNB_DISPLAY_FIFO</span><span class="p">,</span>
	<span class="n">SNB_DISPLAY_MAXWM</span><span class="p">,</span>
	<span class="n">SNB_DISPLAY_DFTWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">SNB_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">sandybridge_cursor_wm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNB_CURSOR_FIFO</span><span class="p">,</span>
	<span class="n">SNB_CURSOR_MAXWM</span><span class="p">,</span>
	<span class="n">SNB_CURSOR_DFTWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">SNB_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">sandybridge_display_srwm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNB_DISPLAY_SR_FIFO</span><span class="p">,</span>
	<span class="n">SNB_DISPLAY_MAX_SRWM</span><span class="p">,</span>
	<span class="n">SNB_DISPLAY_DFT_SRWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">SNB_FIFO_LINE_SIZE</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="n">sandybridge_cursor_srwm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SNB_CURSOR_SR_FIFO</span><span class="p">,</span>
	<span class="n">SNB_CURSOR_MAX_SRWM</span><span class="p">,</span>
	<span class="n">SNB_CURSOR_DFT_SRWM</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">SNB_FIFO_LINE_SIZE</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * intel_calculate_wm - calculate watermark level</span>
<span class="cm"> * @clock_in_khz: pixel clock</span>
<span class="cm"> * @wm: chip FIFO params</span>
<span class="cm"> * @pixel_size: display pixel size</span>
<span class="cm"> * @latency_ns: memory latency for the platform</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the watermark level (the level at which the display plane will</span>
<span class="cm"> * start fetching from memory again).  Each chip has a different display</span>
<span class="cm"> * FIFO size and allocation, so the caller needs to figure that out and pass</span>
<span class="cm"> * in the correct intel_watermark_params structure.</span>
<span class="cm"> *</span>
<span class="cm"> * As the pixel clock runs, the FIFO will be drained at a rate that depends</span>
<span class="cm"> * on the pixel size.  When it reaches the watermark level, it&#39;ll start</span>
<span class="cm"> * fetching FIFO line sized based chunks from memory until the FIFO fills</span>
<span class="cm"> * past the watermark point.  If the FIFO drains completely, a FIFO underrun</span>
<span class="cm"> * will occur, and a display engine hang could result.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">intel_calculate_wm</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clock_in_khz</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">wm</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">pixel_size</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">latency_ns</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">entries_required</span><span class="p">,</span> <span class="n">wm_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: we need to make sure we don&#39;t overflow for various clock &amp;</span>
<span class="cm">	 * latency values.</span>
<span class="cm">	 * clocks go from a few thousand to several hundred thousand.</span>
<span class="cm">	 * latency is usually a few thousand</span>
<span class="cm">	 */</span>
	<span class="n">entries_required</span> <span class="o">=</span> <span class="p">((</span><span class="n">clock_in_khz</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">*</span> <span class="n">latency_ns</span><span class="p">)</span> <span class="o">/</span>
		<span class="mi">1000</span><span class="p">;</span>
	<span class="n">entries_required</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries_required</span><span class="p">,</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO entries required for mode: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entries_required</span><span class="p">);</span>

	<span class="n">wm_size</span> <span class="o">=</span> <span class="n">fifo_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">entries_required</span> <span class="o">+</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO watermark level: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wm_size</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t promote wm_size to unsigned... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">wm</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span>
		<span class="n">wm_size</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wm_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wm_size</span> <span class="o">=</span> <span class="n">wm</span><span class="o">-&gt;</span><span class="n">default_wm</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wm_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="nf">single_enabled_crtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="o">*</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">enabled</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pineview_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cxsr_latency</span> <span class="o">*</span><span class="n">latency</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wm</span><span class="p">;</span>

	<span class="n">latency</span> <span class="o">=</span> <span class="n">intel_get_cxsr_latency</span><span class="p">(</span><span class="n">IS_PINEVIEW_G</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">is_ddr3</span><span class="p">,</span>
					 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latency</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown FSB/MEM found, disable CxSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pineview_disable_cxsr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">single_enabled_crtc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

		<span class="cm">/* Display SR */</span>
		<span class="n">wm</span> <span class="o">=</span> <span class="n">intel_calculate_wm</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pineview_display_wm</span><span class="p">,</span>
					<span class="n">pineview_display_wm</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">,</span>
					<span class="n">pixel_size</span><span class="p">,</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">display_sr</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSPFW_SR_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">wm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_SR_SHIFT</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DSPFW1 register is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* cursor SR */</span>
		<span class="n">wm</span> <span class="o">=</span> <span class="n">intel_calculate_wm</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pineview_cursor_wm</span><span class="p">,</span>
					<span class="n">pineview_display_wm</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">,</span>
					<span class="n">pixel_size</span><span class="p">,</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">cursor_sr</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSPFW_CURSOR_SR_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">wm</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSOR_SR_SHIFT</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* Display HPLL off SR */</span>
		<span class="n">wm</span> <span class="o">=</span> <span class="n">intel_calculate_wm</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pineview_display_hplloff_wm</span><span class="p">,</span>
					<span class="n">pineview_display_hplloff_wm</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">,</span>
					<span class="n">pixel_size</span><span class="p">,</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">display_hpll_disable</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSPFW_HPLL_SR_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">wm</span> <span class="o">&amp;</span> <span class="n">DSPFW_HPLL_SR_MASK</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* cursor HPLL off SR */</span>
		<span class="n">wm</span> <span class="o">=</span> <span class="n">intel_calculate_wm</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pineview_cursor_hplloff_wm</span><span class="p">,</span>
					<span class="n">pineview_display_hplloff_wm</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">,</span>
					<span class="n">pixel_size</span><span class="p">,</span> <span class="n">latency</span><span class="o">-&gt;</span><span class="n">cursor_hpll_disable</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DSPFW_HPLL_CURSOR_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">wm</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_HPLL_CURSOR_SHIFT</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DSPFW3 register is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* activate cxsr */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">)</span> <span class="o">|</span> <span class="n">PINEVIEW_SELF_REFRESH_EN</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Self-refresh is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pineview_disable_cxsr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Self-refresh is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">g4x_compute_wm0</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">plane</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">display_latency_ns</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">cursor_latency_ns</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="o">*</span><span class="n">plane_wm</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="o">*</span><span class="n">cursor_wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">hdisplay</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line_time_us</span><span class="p">,</span> <span class="n">line_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="n">tlb_miss</span><span class="p">;</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">cursor_wm</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>
		<span class="o">*</span><span class="n">plane_wm</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">htotal</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">hdisplay</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">pixel_size</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Use the small buffer method to calculate plane watermark */</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="p">((</span><span class="n">clock</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">display_latency_ns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tlb_miss</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="o">*</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">cacheline_size</span> <span class="o">-</span> <span class="n">hdisplay</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_miss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">entries</span> <span class="o">+=</span> <span class="n">tlb_miss</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">plane_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">plane_wm</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">plane_wm</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">;</span>

	<span class="cm">/* Use the large buffer method to calculate cursor watermark */</span>
	<span class="n">line_time_us</span> <span class="o">=</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="p">);</span>
	<span class="n">line_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor_latency_ns</span> <span class="o">/</span> <span class="n">line_time_us</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">line_count</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">pixel_size</span><span class="p">;</span>
	<span class="n">tlb_miss</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="o">*</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">cacheline_size</span> <span class="o">-</span> <span class="n">hdisplay</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_miss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">entries</span> <span class="o">+=</span> <span class="n">tlb_miss</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cursor_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cursor_wm</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">cursor_wm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cursor</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check the wm result.</span>
<span class="cm"> *</span>
<span class="cm"> * If any calculated watermark values is larger than the maximum value that</span>
<span class="cm"> * can be programmed into the associated watermark register, that watermark</span>
<span class="cm"> * must be disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">g4x_check_srwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">display_wm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cursor_wm</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;SR watermark: display plane %d, cursor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">display_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display_wm</span> <span class="o">&gt;</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;display watermark is too large(%d/%ld), disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">display_wm</span><span class="p">,</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_wm</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;cursor watermark is too large(%d/%ld), disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">cursor_wm</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">display_wm</span> <span class="o">||</span> <span class="n">cursor_wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;SR latency is 0, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">g4x_compute_srwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">plane</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">latency_ns</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">display_wm</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cursor_wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdisplay</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_time_us</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">line_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">small</span><span class="p">,</span> <span class="n">large</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latency_ns</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">display_wm</span> <span class="o">=</span> <span class="o">*</span><span class="n">cursor_wm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="n">hdisplay</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">htotal</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">pixel_size</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">line_time_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">line_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">latency_ns</span> <span class="o">/</span> <span class="n">line_time_us</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">line_size</span> <span class="o">=</span> <span class="n">hdisplay</span> <span class="o">*</span> <span class="n">pixel_size</span><span class="p">;</span>

	<span class="cm">/* Use the minimum of the small and large buffer method for primary */</span>
	<span class="n">small</span> <span class="o">=</span> <span class="p">((</span><span class="n">clock</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">latency_ns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">large</span> <span class="o">=</span> <span class="n">line_count</span> <span class="o">*</span> <span class="n">line_size</span><span class="p">;</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="n">large</span><span class="p">),</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">display_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>

	<span class="cm">/* calculate the self-refresh watermark for display cursor */</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">line_count</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cursor_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">g4x_check_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			      <span class="o">*</span><span class="n">display_wm</span><span class="p">,</span> <span class="o">*</span><span class="n">cursor_wm</span><span class="p">,</span>
			      <span class="n">display</span><span class="p">,</span> <span class="n">cursor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">vlv_compute_drain_latency</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">plane</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">plane_prec_mult</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">plane_dl</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">cursor_prec_mult</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="o">*</span><span class="n">cursor_dl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clock</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>	<span class="cm">/* VESA DOT Clock */</span>
	<span class="n">pixel_size</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* BPP */</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">plane_prec_mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">DRAIN_LATENCY_PRECISION_32</span> <span class="o">:</span> <span class="n">DRAIN_LATENCY_PRECISION_16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">plane_dl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">plane_prec_mult</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">clock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
						     <span class="n">pixel_size</span><span class="p">);</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* BPP is always 4 for cursor */</span>
	<span class="o">*</span><span class="n">cursor_prec_mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">DRAIN_LATENCY_PRECISION_32</span> <span class="o">:</span> <span class="n">DRAIN_LATENCY_PRECISION_16</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cursor_dl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">cursor_prec_mult</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">clock</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update drain latency registers of memory arbiter</span>
<span class="cm"> *</span>
<span class="cm"> * Valleyview SoC has a new memory arbiter and needs drain latency registers</span>
<span class="cm"> * to be programmed. Each plane has a drain latency multiplier and a drain</span>
<span class="cm"> * latency value.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlv_update_drain_latency</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">planea_prec</span><span class="p">,</span> <span class="n">planea_dl</span><span class="p">,</span> <span class="n">planeb_prec</span><span class="p">,</span> <span class="n">planeb_dl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cursora_prec</span><span class="p">,</span> <span class="n">cursora_dl</span><span class="p">,</span> <span class="n">cursorb_prec</span><span class="p">,</span> <span class="n">cursorb_dl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane_prec_mult</span><span class="p">,</span> <span class="n">cursor_prec_mult</span><span class="p">;</span> <span class="cm">/* Precision multiplier is</span>
<span class="cm">							either 16 or 32 */</span>

	<span class="cm">/* For plane A, Cursor A */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlv_compute_drain_latency</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane_prec_mult</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">planea_dl</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">cursor_prec_mult</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursora_dl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cursora_prec</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor_prec_mult</span> <span class="o">==</span> <span class="n">DRAIN_LATENCY_PRECISION_32</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DDL_CURSORA_PRECISION_32</span> <span class="o">:</span> <span class="n">DDL_CURSORA_PRECISION_16</span><span class="p">;</span>
		<span class="n">planea_prec</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_prec_mult</span> <span class="o">==</span> <span class="n">DRAIN_LATENCY_PRECISION_32</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DDL_PLANEA_PRECISION_32</span> <span class="o">:</span> <span class="n">DDL_PLANEA_PRECISION_16</span><span class="p">;</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_DDL1</span><span class="p">,</span> <span class="n">cursora_prec</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">cursora_dl</span> <span class="o">&lt;&lt;</span> <span class="n">DDL_CURSORA_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">planea_prec</span> <span class="o">|</span> <span class="n">planea_dl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For plane B, Cursor B */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlv_compute_drain_latency</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane_prec_mult</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">planeb_dl</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">cursor_prec_mult</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursorb_dl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cursorb_prec</span> <span class="o">=</span> <span class="p">(</span><span class="n">cursor_prec_mult</span> <span class="o">==</span> <span class="n">DRAIN_LATENCY_PRECISION_32</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DDL_CURSORB_PRECISION_32</span> <span class="o">:</span> <span class="n">DDL_CURSORB_PRECISION_16</span><span class="p">;</span>
		<span class="n">planeb_prec</span> <span class="o">=</span> <span class="p">(</span><span class="n">plane_prec_mult</span> <span class="o">==</span> <span class="n">DRAIN_LATENCY_PRECISION_32</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">DDL_PLANEB_PRECISION_32</span> <span class="o">:</span> <span class="n">DDL_PLANEB_PRECISION_16</span><span class="p">;</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_DDL2</span><span class="p">,</span> <span class="n">cursorb_prec</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">cursorb_dl</span> <span class="o">&lt;&lt;</span> <span class="n">DDL_CURSORB_SHIFT</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">planeb_prec</span> <span class="o">|</span> <span class="n">planeb_dl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define single_plane_enabled(mask) is_power_of_2(mask)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">valleyview_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sr_latency_ns</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">planea_wm</span><span class="p">,</span> <span class="n">planeb_wm</span><span class="p">,</span> <span class="n">cursora_wm</span><span class="p">,</span> <span class="n">cursorb_wm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane_sr</span><span class="p">,</span> <span class="n">cursor_sr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vlv_update_drain_latency</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">valleyview_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">valleyview_cursor_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">planea_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursora_wm</span><span class="p">))</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">valleyview_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">valleyview_cursor_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">planeb_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursorb_wm</span><span class="p">))</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">plane_sr</span> <span class="o">=</span> <span class="n">cursor_sr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single_plane_enabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">g4x_compute_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ffs</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">sr_latency_ns</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">valleyview_wm_info</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">valleyview_cursor_wm_info</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">plane_sr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_sr</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF_VLV</span><span class="p">,</span> <span class="n">FW_CSPWRDWNEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF_VLV</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF_VLV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FW_CSPWRDWNEN</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Setting FIFO watermarks - A: plane=%d, cursor=%d, B: plane=%d, cursor=%d, SR: plane=%d, cursor=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">planea_wm</span><span class="p">,</span> <span class="n">cursora_wm</span><span class="p">,</span>
		      <span class="n">planeb_wm</span><span class="p">,</span> <span class="n">cursorb_wm</span><span class="p">,</span>
		      <span class="n">plane_sr</span><span class="p">,</span> <span class="n">cursor_sr</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">plane_sr</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">cursorb_wm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSORB_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">planeb_wm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_PLANEB_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">planea_wm</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DSPFW_CURSORA_MASK</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">cursora_wm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSORA_SHIFT</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cursor_sr</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSOR_SR_SHIFT</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">g4x_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sr_latency_ns</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">planea_wm</span><span class="p">,</span> <span class="n">planeb_wm</span><span class="p">,</span> <span class="n">cursora_wm</span><span class="p">,</span> <span class="n">cursorb_wm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane_sr</span><span class="p">,</span> <span class="n">cursor_sr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">g4x_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">g4x_cursor_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">planea_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursora_wm</span><span class="p">))</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">g4x_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">g4x_cursor_wm_info</span><span class="p">,</span> <span class="n">latency_ns</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">planeb_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursorb_wm</span><span class="p">))</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">plane_sr</span> <span class="o">=</span> <span class="n">cursor_sr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single_plane_enabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">g4x_compute_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ffs</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">sr_latency_ns</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">g4x_wm_info</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">g4x_cursor_wm_info</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">plane_sr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_sr</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span> <span class="n">FW_BLC_SELF_EN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FW_BLC_SELF_EN</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Setting FIFO watermarks - A: plane=%d, cursor=%d, B: plane=%d, cursor=%d, SR: plane=%d, cursor=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">planea_wm</span><span class="p">,</span> <span class="n">cursora_wm</span><span class="p">,</span>
		      <span class="n">planeb_wm</span><span class="p">,</span> <span class="n">cursorb_wm</span><span class="p">,</span>
		      <span class="n">plane_sr</span><span class="p">,</span> <span class="n">cursor_sr</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">plane_sr</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">cursorb_wm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSORB_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">planeb_wm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_PLANEB_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">planea_wm</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DSPFW_CURSORA_MASK</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">cursora_wm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSORA_SHIFT</span><span class="p">));</span>
	<span class="cm">/* HPLL off in SR has some issues on G4x... disable it */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DSPFW_HPLL_SR_EN</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">cursor_sr</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSOR_SR_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i965_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">srwm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cursor_sr</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* Calc sr entries for one plane configs */</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">single_enabled_crtc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* self-refresh has much higher latency */</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sr_latency_ns</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">htotal</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">htotal</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">hdisplay</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_time_us</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>

		<span class="n">line_time_us</span> <span class="o">=</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="p">);</span>

		<span class="cm">/* Use ns/us then divide to preserve precision */</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sr_latency_ns</span> <span class="o">/</span> <span class="n">line_time_us</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">pixel_size</span> <span class="o">*</span> <span class="n">hdisplay</span><span class="p">;</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">I915_FIFO_LINE_SIZE</span><span class="p">);</span>
		<span class="n">srwm</span> <span class="o">=</span> <span class="n">I965_FIFO_SIZE</span> <span class="o">-</span> <span class="n">entries</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srwm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">srwm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">srwm</span> <span class="o">&amp;=</span> <span class="mh">0x1ff</span><span class="p">;</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;self-refresh entries: %d, wm: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">entries</span><span class="p">,</span> <span class="n">srwm</span><span class="p">);</span>

		<span class="n">entries</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sr_latency_ns</span> <span class="o">/</span> <span class="n">line_time_us</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">pixel_size</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span>
					  <span class="n">i965_cursor_wm_info</span><span class="p">.</span><span class="n">cacheline_size</span><span class="p">);</span>
		<span class="n">cursor_sr</span> <span class="o">=</span> <span class="n">i965_cursor_wm_info</span><span class="p">.</span><span class="n">fifo_size</span> <span class="o">-</span>
			<span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="n">i965_cursor_wm_info</span><span class="p">.</span><span class="n">guard_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cursor_sr</span> <span class="o">&gt;</span> <span class="n">i965_cursor_wm_info</span><span class="p">.</span><span class="n">max_wm</span><span class="p">)</span>
			<span class="n">cursor_sr</span> <span class="o">=</span> <span class="n">i965_cursor_wm_info</span><span class="p">.</span><span class="n">max_wm</span><span class="p">;</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;self-refresh watermark: display plane %d &quot;</span>
			      <span class="s">&quot;cursor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">srwm</span><span class="p">,</span> <span class="n">cursor_sr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span> <span class="n">FW_BLC_SELF_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Turn off self refresh if both pipes are enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">)</span>
				   <span class="o">&amp;</span> <span class="o">~</span><span class="n">FW_BLC_SELF_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Setting FIFO watermarks - A: 8, B: 8, C: 8, SR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">srwm</span><span class="p">);</span>

	<span class="cm">/* 965 has limitations... */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW1</span><span class="p">,</span> <span class="p">(</span><span class="n">srwm</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW2</span><span class="p">,</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="cm">/* update cursor SR watermark */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">,</span> <span class="p">(</span><span class="n">cursor_sr</span> <span class="o">&lt;&lt;</span> <span class="n">DSPFW_CURSOR_SR_SHIFT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">wm_info</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fwater_lo</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fwater_hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cwm</span><span class="p">,</span> <span class="n">srwm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fifo_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">planea_wm</span><span class="p">,</span> <span class="n">planeb_wm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="o">*</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">wm_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i945_wm_info</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">wm_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i915_wm_info</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wm_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i855_wm_info</span><span class="p">;</span>

	<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">planea_wm</span> <span class="o">=</span> <span class="n">intel_calculate_wm</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">,</span>
					       <span class="n">wm_info</span><span class="p">,</span> <span class="n">fifo_size</span><span class="p">,</span>
					       <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
					       <span class="n">latency_ns</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">planea_wm</span> <span class="o">=</span> <span class="n">fifo_size</span> <span class="o">-</span> <span class="n">wm_info</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>

	<span class="n">fifo_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">planeb_wm</span> <span class="o">=</span> <span class="n">intel_calculate_wm</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">,</span>
					       <span class="n">wm_info</span><span class="p">,</span> <span class="n">fifo_size</span><span class="p">,</span>
					       <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
					       <span class="n">latency_ns</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">enabled</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">enabled</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">planeb_wm</span> <span class="o">=</span> <span class="n">fifo_size</span> <span class="o">-</span> <span class="n">wm_info</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO watermarks - A: %d, B: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">planea_wm</span><span class="p">,</span> <span class="n">planeb_wm</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Overlay gets an aggressive default since video jitter is bad.</span>
<span class="cm">	 */</span>
	<span class="n">cwm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Play safe and disable self-refresh before adjusting watermarks. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span> <span class="n">FW_BLC_SELF_EN_MASK</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INSTPM_SELF_EN</span><span class="p">);</span>

	<span class="cm">/* Calc sr entries for one plane configs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_FW_BLC</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* self-refresh has much higher latency */</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sr_latency_ns</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">clock</span> <span class="o">=</span> <span class="n">enabled</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">htotal</span> <span class="o">=</span> <span class="n">enabled</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">htotal</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">hdisplay</span> <span class="o">=</span> <span class="n">enabled</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">enabled</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_time_us</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>

		<span class="n">line_time_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="p">;</span>

		<span class="cm">/* Use ns/us then divide to preserve precision */</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="p">(((</span><span class="n">sr_latency_ns</span> <span class="o">/</span> <span class="n">line_time_us</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span>
			<span class="n">pixel_size</span> <span class="o">*</span> <span class="n">hdisplay</span><span class="p">;</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">wm_info</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;self-refresh entries: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
		<span class="n">srwm</span> <span class="o">=</span> <span class="n">wm_info</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">-</span> <span class="n">entries</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srwm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">srwm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span>
				   <span class="n">FW_BLC_SELF_FIFO_MASK</span> <span class="o">|</span> <span class="p">(</span><span class="n">srwm</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span> <span class="n">srwm</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Setting FIFO watermarks - A: %d, B: %d, C: %d, SR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">planea_wm</span><span class="p">,</span> <span class="n">planeb_wm</span><span class="p">,</span> <span class="n">cwm</span><span class="p">,</span> <span class="n">srwm</span><span class="p">);</span>

	<span class="n">fwater_lo</span> <span class="o">=</span> <span class="p">((</span><span class="n">planeb_wm</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">planea_wm</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">fwater_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">cwm</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

	<span class="cm">/* Set request length to 8 cachelines per fetch */</span>
	<span class="n">fwater_lo</span> <span class="o">=</span> <span class="n">fwater_lo</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">fwater_hi</span> <span class="o">=</span> <span class="n">fwater_hi</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC</span><span class="p">,</span> <span class="n">fwater_lo</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC2</span><span class="p">,</span> <span class="n">fwater_hi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_FW_BLC</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">,</span>
					   <span class="n">FW_BLC_SELF_EN_MASK</span> <span class="o">|</span> <span class="n">FW_BLC_SELF_EN</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">)</span> <span class="o">|</span> <span class="n">INSTPM_SELF_EN</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;memory self refresh enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;memory self refresh disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i830_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fwater_lo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">planea_wm</span><span class="p">;</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">single_enabled_crtc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">planea_wm</span> <span class="o">=</span> <span class="n">intel_calculate_wm</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i830_wm_info</span><span class="p">,</span>
				       <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				       <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
				       <span class="n">latency_ns</span><span class="p">);</span>
	<span class="n">fwater_lo</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FW_BLC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff</span><span class="p">;</span>
	<span class="n">fwater_lo</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">planea_wm</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Setting FIFO watermarks - A: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">planea_wm</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FW_BLC</span><span class="p">,</span> <span class="n">fwater_lo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ILK_LP0_PLANE_LATENCY		700</span>
<span class="cp">#define ILK_LP0_CURSOR_LATENCY		1300</span>

<span class="cm">/*</span>
<span class="cm"> * Check the wm result.</span>
<span class="cm"> *</span>
<span class="cm"> * If any calculated watermark values is larger than the maximum value that</span>
<span class="cm"> * can be programmed into the associated watermark register, that watermark</span>
<span class="cm"> * must be disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ironlake_check_srwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">fbc_wm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">display_wm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cursor_wm</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">cursor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;watermark %d: display plane %d, fbc lines %d,&quot;</span>
		      <span class="s">&quot; cursor %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">display_wm</span><span class="p">,</span> <span class="n">fbc_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbc_wm</span> <span class="o">&gt;</span> <span class="n">SNB_FBC_MAX_SRWM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;fbc watermark(%d) is too large(%d), disabling wm%d+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">fbc_wm</span><span class="p">,</span> <span class="n">SNB_FBC_MAX_SRWM</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

		<span class="cm">/* fbc has it&#39;s own way to disable FBC WM */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DISP_ARB_CTL</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DISP_ARB_CTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DISP_FBC_WM_DIS</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">display_wm</span> <span class="o">&gt;</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;display watermark(%d) is too large(%d), disabling wm%d+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">display_wm</span><span class="p">,</span> <span class="n">SNB_DISPLAY_MAX_SRWM</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_wm</span> <span class="o">&gt;</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;cursor watermark(%d) is too large(%d), disabling wm%d+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">cursor_wm</span><span class="p">,</span> <span class="n">SNB_CURSOR_MAX_SRWM</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fbc_wm</span> <span class="o">||</span> <span class="n">display_wm</span> <span class="o">||</span> <span class="n">cursor_wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;latency %d is 0, disabling wm%d+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute watermark values of WM[1-3],</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ironlake_compute_srwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">latency_ns</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">cursor</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="o">*</span><span class="n">fbc_wm</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">display_wm</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cursor_wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_time_us</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdisplay</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">line_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">small</span><span class="p">,</span> <span class="n">large</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latency_ns</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fbc_wm</span> <span class="o">=</span> <span class="o">*</span><span class="n">display_wm</span> <span class="o">=</span> <span class="o">*</span><span class="n">cursor_wm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="n">hdisplay</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">htotal</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">pixel_size</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">line_time_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">htotal</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">line_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">latency_ns</span> <span class="o">/</span> <span class="n">line_time_us</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">line_size</span> <span class="o">=</span> <span class="n">hdisplay</span> <span class="o">*</span> <span class="n">pixel_size</span><span class="p">;</span>

	<span class="cm">/* Use the minimum of the small and large buffer method for primary */</span>
	<span class="n">small</span> <span class="o">=</span> <span class="p">((</span><span class="n">clock</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">latency_ns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">large</span> <span class="o">=</span> <span class="n">line_count</span> <span class="o">*</span> <span class="n">line_size</span><span class="p">;</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="n">large</span><span class="p">),</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">display_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Spec says:</span>
<span class="cm">	 * FBC WM = ((Final Primary WM * 64) / number of bytes per line) + 2</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">fbc_wm</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="o">*</span><span class="n">display_wm</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="n">line_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* calculate the self-refresh watermark for display cursor */</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">line_count</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">*</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">cursor_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">cursor</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ironlake_check_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">fbc_wm</span><span class="p">,</span> <span class="o">*</span><span class="n">display_wm</span><span class="p">,</span> <span class="o">*</span><span class="n">cursor_wm</span><span class="p">,</span>
				   <span class="n">display</span><span class="p">,</span> <span class="n">cursor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fbc_wm</span><span class="p">,</span> <span class="n">plane_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ironlake_display_wm_info</span><span class="p">,</span>
			    <span class="n">ILK_LP0_PLANE_LATENCY</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ironlake_cursor_wm_info</span><span class="p">,</span>
			    <span class="n">ILK_LP0_CURSOR_LATENCY</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM0_PIPEA_ILK</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM0_PIPE_PLANE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">cursor_wm</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO watermarks For pipe A -&quot;</span>
			      <span class="s">&quot; plane %d, &quot;</span> <span class="s">&quot;cursor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ironlake_display_wm_info</span><span class="p">,</span>
			    <span class="n">ILK_LP0_PLANE_LATENCY</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">ironlake_cursor_wm_info</span><span class="p">,</span>
			    <span class="n">ILK_LP0_CURSOR_LATENCY</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM0_PIPEB_ILK</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM0_PIPE_PLANE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">cursor_wm</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO watermarks For pipe B -&quot;</span>
			      <span class="s">&quot; plane %d, cursor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate and update the self-refresh watermark only when one</span>
<span class="cm">	 * display plane is used.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">single_plane_enabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* WM1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_compute_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span>
				   <span class="n">ILK_READ_WM1_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ironlake_display_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ironlake_cursor_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fbc_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span>
		   <span class="n">WM1_LP_SR_EN</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">ILK_READ_WM1_LATENCY</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_LATENCY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">fbc_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_FBC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">cursor_wm</span><span class="p">);</span>

	<span class="cm">/* WM2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_compute_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span>
				   <span class="n">ILK_READ_WM2_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ironlake_display_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">ironlake_cursor_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fbc_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span>
		   <span class="n">WM2_LP_EN</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">ILK_READ_WM2_LATENCY</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_LATENCY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">fbc_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_FBC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">cursor_wm</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * WM3 is unsupported on ILK, probably because we don&#39;t have latency</span>
<span class="cm">	 * data for that power state</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sandybridge_update_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">latency</span> <span class="o">=</span> <span class="n">SNB_READ_WM0_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* In unit 0.1us */</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fbc_wm</span><span class="p">,</span> <span class="n">plane_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sandybridge_display_wm_info</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sandybridge_cursor_wm_info</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">WM0_PIPEA_ILK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WM0_PIPE_PLANE_MASK</span> <span class="o">|</span> <span class="n">WM0_PIPE_CURSOR_MASK</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM0_PIPEA_ILK</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM0_PIPE_PLANE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">cursor_wm</span><span class="p">));</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO watermarks For pipe A -&quot;</span>
			      <span class="s">&quot; plane %d, &quot;</span> <span class="s">&quot;cursor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sandybridge_display_wm_info</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sandybridge_cursor_wm_info</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">WM0_PIPEB_ILK</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WM0_PIPE_PLANE_MASK</span> <span class="o">|</span> <span class="n">WM0_PIPE_CURSOR_MASK</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM0_PIPEB_ILK</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM0_PIPE_PLANE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">cursor_wm</span><span class="p">));</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO watermarks For pipe B -&quot;</span>
			      <span class="s">&quot; plane %d, cursor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">g4x_compute_wm0</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sandybridge_display_wm_info</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">sandybridge_cursor_wm_info</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">WM0_PIPEC_IVB</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WM0_PIPE_PLANE_MASK</span> <span class="o">|</span> <span class="n">WM0_PIPE_CURSOR_MASK</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM0_PIPEC_IVB</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span>
			   <span class="p">((</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM0_PIPE_PLANE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">cursor_wm</span><span class="p">));</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FIFO watermarks For pipe C -&quot;</span>
			      <span class="s">&quot; plane %d, cursor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_wm</span><span class="p">,</span> <span class="n">cursor_wm</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate and update the self-refresh watermark only when one</span>
<span class="cm">	 * display plane is used.</span>
<span class="cm">	 *</span>
<span class="cm">	 * SNB support 3 levels of watermark.</span>
<span class="cm">	 *</span>
<span class="cm">	 * WM1/WM2/WM2 watermarks have to be enabled in the ascending order,</span>
<span class="cm">	 * and disabled in the descending order</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">single_plane_enabled</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sprite_scaling_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* WM1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_compute_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span>
				   <span class="n">SNB_READ_WM1_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">sandybridge_display_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">sandybridge_cursor_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fbc_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span>
		   <span class="n">WM1_LP_SR_EN</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">SNB_READ_WM1_LATENCY</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_LATENCY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">fbc_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_FBC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">cursor_wm</span><span class="p">);</span>

	<span class="cm">/* WM2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_compute_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span>
				   <span class="n">SNB_READ_WM2_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">sandybridge_display_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">sandybridge_cursor_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fbc_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span>
		   <span class="n">WM2_LP_EN</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">SNB_READ_WM2_LATENCY</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_LATENCY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">fbc_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_FBC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">cursor_wm</span><span class="p">);</span>

	<span class="cm">/* WM3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_compute_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span>
				   <span class="n">SNB_READ_WM3_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">sandybridge_display_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">sandybridge_cursor_srwm_info</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">fbc_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane_wm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cursor_wm</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3_LP_ILK</span><span class="p">,</span>
		   <span class="n">WM3_LP_EN</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">SNB_READ_WM3_LATENCY</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_LATENCY_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">fbc_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_FBC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">plane_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM1_LP_SR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">cursor_wm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">haswell_update_linetime_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPE_WM_LINETIME</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPE_WM_LINETIME_MASK</span><span class="p">;</span>

	<span class="cm">/* The WM are computed with base on how long it takes to fill a single</span>
<span class="cm">	 * row at the given clock rate, multiplied by 8.</span>
<span class="cm">	 * */</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPE_WM_LINETIME_TIME</span><span class="p">(</span>
		<span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* IPS watermarks are only used by pipe A, and are ignored by</span>
<span class="cm">	 * pipes B and C.  They are calculated similarly to the common</span>
<span class="cm">	 * linetime values, except that we are using CD clock frequency</span>
<span class="cm">	 * in MHz instead of pixel rate for the division.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This is a placeholder for the IPS watermark calculation code.</span>
<span class="cm">	 */</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_WM_LINETIME</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sandybridge_compute_sprite_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">,</span>
			      <span class="kt">uint32_t</span> <span class="n">sprite_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_size</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">display_latency_ns</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sprite_wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="n">tlb_miss</span><span class="p">;</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sprite_wm</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>

	<span class="cm">/* Use the small buffer method to calculate the sprite watermark */</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="p">((</span><span class="n">clock</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">display_latency_ns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">tlb_miss</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">fifo_size</span><span class="o">*</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">cacheline_size</span> <span class="o">-</span>
		<span class="n">sprite_width</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlb_miss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">entries</span> <span class="o">+=</span> <span class="n">tlb_miss</span><span class="p">;</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sprite_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">sprite_wm</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">display</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">sprite_wm</span> <span class="o">=</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">max_wm</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">sandybridge_compute_sprite_srwm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">,</span>
				<span class="kt">uint32_t</span> <span class="n">sprite_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_size</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_watermark_params</span> <span class="o">*</span><span class="n">display</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">latency_ns</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">sprite_wm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">line_time_us</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line_count</span><span class="p">,</span> <span class="n">line_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">small</span><span class="p">,</span> <span class="n">large</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">latency_ns</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sprite_wm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sprite_wm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">line_time_us</span> <span class="o">=</span> <span class="p">(</span><span class="n">sprite_width</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">line_time_us</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sprite_wm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">line_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">latency_ns</span> <span class="o">/</span> <span class="n">line_time_us</span> <span class="o">+</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">line_size</span> <span class="o">=</span> <span class="n">sprite_width</span> <span class="o">*</span> <span class="n">pixel_size</span><span class="p">;</span>

	<span class="cm">/* Use the minimum of the small and large buffer method for primary */</span>
	<span class="n">small</span> <span class="o">=</span> <span class="p">((</span><span class="n">clock</span> <span class="o">*</span> <span class="n">pixel_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">latency_ns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">large</span> <span class="o">=</span> <span class="n">line_count</span> <span class="o">*</span> <span class="n">line_size</span><span class="p">;</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">small</span><span class="p">,</span> <span class="n">large</span><span class="p">),</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">cacheline_size</span><span class="p">);</span>
	<span class="o">*</span><span class="n">sprite_wm</span> <span class="o">=</span> <span class="n">entries</span> <span class="o">+</span> <span class="n">display</span><span class="o">-&gt;</span><span class="n">guard_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">*</span><span class="n">sprite_wm</span> <span class="o">&gt;</span> <span class="mh">0x3ff</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sandybridge_update_sprite_wm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
					 <span class="kt">uint32_t</span> <span class="n">sprite_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">latency</span> <span class="o">=</span> <span class="n">SNB_READ_WM0_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* In unit 0.1us */</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sprite_wm</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">WM0_PIPEA_ILK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">WM0_PIPEB_ILK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="n">WM0_PIPEC_IVB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* bad pipe */</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sandybridge_compute_sprite_wm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">sprite_width</span><span class="p">,</span> <span class="n">pixel_size</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">sandybridge_display_wm_info</span><span class="p">,</span>
					    <span class="n">latency</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sprite_wm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;failed to compute sprite wm for pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WM0_PIPE_SPRITE_MASK</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="n">sprite_wm</span> <span class="o">&lt;&lt;</span> <span class="n">WM0_PIPE_SPRITE_SHIFT</span><span class="p">));</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;sprite watermarks For pipe %d - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">sprite_wm</span><span class="p">);</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">sandybridge_compute_sprite_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">sprite_width</span><span class="p">,</span>
					      <span class="n">pixel_size</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sandybridge_display_srwm_info</span><span class="p">,</span>
					      <span class="n">SNB_READ_WM1_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sprite_wm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;failed to compute sprite lp1 wm on pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1S_LP_ILK</span><span class="p">,</span> <span class="n">sprite_wm</span><span class="p">);</span>

	<span class="cm">/* Only IVB has two more LP watermarks for sprite */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sandybridge_compute_sprite_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">sprite_width</span><span class="p">,</span>
					      <span class="n">pixel_size</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sandybridge_display_srwm_info</span><span class="p">,</span>
					      <span class="n">SNB_READ_WM2_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sprite_wm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;failed to compute sprite lp2 wm on pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2S_LP_IVB</span><span class="p">,</span> <span class="n">sprite_wm</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sandybridge_compute_sprite_srwm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">sprite_width</span><span class="p">,</span>
					      <span class="n">pixel_size</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sandybridge_display_srwm_info</span><span class="p">,</span>
					      <span class="n">SNB_READ_WM3_LATENCY</span><span class="p">()</span> <span class="o">*</span> <span class="mi">500</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">sprite_wm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;failed to compute sprite lp3 wm on pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3S_LP_IVB</span><span class="p">,</span> <span class="n">sprite_wm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_update_watermarks - update FIFO watermark values based on current modes</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate watermark values for the various WM regs based on current mode</span>
<span class="cm"> * and plane configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * There are several cases to deal with here:</span>
<span class="cm"> *   - normal (i.e. non-self-refresh)</span>
<span class="cm"> *   - self-refresh (SR) mode</span>
<span class="cm"> *   - lines are large relative to FIFO size (buffer can hold up to 2)</span>
<span class="cm"> *   - lines are small relative to FIFO size (buffer can hold more than 2</span>
<span class="cm"> *     lines), so need to account for TLB latency</span>
<span class="cm"> *</span>
<span class="cm"> *   The normal calculation is:</span>
<span class="cm"> *     watermark = dotclock * bytes per pixel * latency</span>
<span class="cm"> *   where latency is platform &amp; configuration dependent (we assume pessimal</span>
<span class="cm"> *   values here).</span>
<span class="cm"> *</span>
<span class="cm"> *   The SR calculation is:</span>
<span class="cm"> *     watermark = (trunc(latency/line time)+1) * surface width *</span>
<span class="cm"> *       bytes per pixel</span>
<span class="cm"> *   where</span>
<span class="cm"> *     line time = htotal / dotclock</span>
<span class="cm"> *     surface width = hdisplay for normal plane and 64 for cursor</span>
<span class="cm"> *   and latency is assumed to be high, as above.</span>
<span class="cm"> *</span>
<span class="cm"> * The final value programmed to the register should always be rounded up,</span>
<span class="cm"> * and include an extra 2 entries to account for clock crossings.</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t use the sprite, so we can ignore that.  And on Crestline we have</span>
<span class="cm"> * to set the non-SR watermarks to 8.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_update_watermarks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_update_linetime_watermarks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_linetime_wm</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_linetime_wm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_update_sprite_watermarks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
				    <span class="kt">uint32_t</span> <span class="n">sprite_width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_sprite_wm</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_sprite_wm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">sprite_width</span><span class="p">,</span>
						   <span class="n">pixel_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span>
<span class="nf">intel_alloc_context_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">));</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">i915_gem_alloc_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;failed to alloc power context, RC6 disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to pin power context: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unref</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to set-domain on power context: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unpin</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ctx</span><span class="p">;</span>

<span class="nl">err_unpin:</span>
	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="nl">err_unref:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ironlake_set_drps</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rgvswctl</span><span class="p">;</span>

	<span class="n">rgvswctl</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rgvswctl</span> <span class="o">&amp;</span> <span class="n">MEMCTL_CMD_STS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;gpu busy, RCS change rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* still busy with another command */</span>
	<span class="p">}</span>

	<span class="n">rgvswctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">MEMCTL_CMD_CHFREQ</span> <span class="o">&lt;&lt;</span> <span class="n">MEMCTL_CMD_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">MEMCTL_FREQ_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">MEMCTL_SFCAVM</span><span class="p">;</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">,</span> <span class="n">rgvswctl</span><span class="p">);</span>
	<span class="n">POSTING_READ16</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">);</span>

	<span class="n">rgvswctl</span> <span class="o">|=</span> <span class="n">MEMCTL_CMD_STS</span><span class="p">;</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">,</span> <span class="n">rgvswctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ironlake_enable_drps</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rgvmodectl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">MEMMODECTL</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fstart</span><span class="p">,</span> <span class="n">vstart</span><span class="p">;</span>

	<span class="cm">/* Enable temp reporting */</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">PMMISC</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PMMISC</span><span class="p">)</span> <span class="o">|</span> <span class="n">MCPPCE_EN</span><span class="p">);</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">TSC1</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TSC1</span><span class="p">)</span> <span class="o">|</span> <span class="n">TSE</span><span class="p">);</span>

	<span class="cm">/* 100ms RC evaluation intervals */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RCUPEI</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RCDNEI</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>

	<span class="cm">/* Set max/min thresholds to 90ms and 80ms respectively */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RCBMAXAVG</span><span class="p">,</span> <span class="mi">90000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RCBMINAVG</span><span class="p">,</span> <span class="mi">80000</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">MEMIHYST</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Set up min, max, and cur for interrupt handling */</span>
	<span class="n">fmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_FMAX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MEMMODE_FMAX_SHIFT</span><span class="p">;</span>
	<span class="n">fmin</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_FMIN_MASK</span><span class="p">);</span>
	<span class="n">fstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_FSTART_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">MEMMODE_FSTART_SHIFT</span><span class="p">;</span>

	<span class="n">vstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PXVFREQ_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">fstart</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PXVFREQ_PX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">PXVFREQ_PX_SHIFT</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">fmax</span><span class="p">;</span> <span class="cm">/* IPS callback will increase this */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fstart</span> <span class="o">=</span> <span class="n">fstart</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">=</span> <span class="n">fstart</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">=</span> <span class="n">fstart</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;fmax: %d, fmin: %d, fstart: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">fmax</span><span class="p">,</span> <span class="n">fmin</span><span class="p">,</span> <span class="n">fstart</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">MEMINTREN</span><span class="p">,</span> <span class="n">MEMINT_CX_SUPR_EN</span> <span class="o">|</span> <span class="n">MEMINT_EVAL_CHG_EN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interrupts will be enabled in ironlake_irq_postinstall</span>
<span class="cm">	 */</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VIDSTART</span><span class="p">,</span> <span class="n">vstart</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">VIDSTART</span><span class="p">);</span>

	<span class="n">rgvmodectl</span> <span class="o">|=</span> <span class="n">MEMMODE_SWMODE_EN</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">MEMMODECTL</span><span class="p">,</span> <span class="n">rgvmodectl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MEMCTL_CMD_STS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;stuck trying to change perf mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ironlake_set_drps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fstart</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x112e4</span><span class="p">)</span> <span class="o">+</span> <span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x112e8</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x112e0</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_time1</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count2</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x112f4</span><span class="p">);</span>
	<span class="n">getrawmonotonic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_time2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ironlake_disable_drps</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rgvswctl</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">);</span>

	<span class="cm">/* Ack interrupts, disable EFC interrupt */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">MEMINTREN</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">MEMINTREN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MEMINT_EVAL_CHG_EN</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">MEMINTRSTS</span><span class="p">,</span> <span class="n">MEMINT_EVAL_CHG</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DE_PCU_EVENT</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">,</span> <span class="n">DE_PCU_EVENT</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">)</span> <span class="o">|</span> <span class="n">DE_PCU_EVENT</span><span class="p">);</span>

	<span class="cm">/* Go back to the starting frequency */</span>
	<span class="n">ironlake_set_drps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fstart</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">rgvswctl</span> <span class="o">|=</span> <span class="n">MEMCTL_CMD_STS</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">,</span> <span class="n">rgvswctl</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gen6_set_rps</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">limits</span><span class="p">;</span>

	<span class="n">limits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limits</span> <span class="o">|=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limits</span> <span class="o">|=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RPNSWREQ</span><span class="p">,</span>
		   <span class="n">GEN6_FREQUENCY</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">GEN6_OFFSET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">GEN6_AGGRESSIVE_TURBO</span><span class="p">);</span>

	<span class="cm">/* Make sure we continue to get interrupts</span>
<span class="cm">	 * until we hit the minimum or maximum frequencies.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_INTERRUPT_LIMITS</span><span class="p">,</span> <span class="n">limits</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gen6_disable_rps</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RPNSWREQ</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMINTRMSK</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Complete PM interrupt masking here doesn&#39;t race with the rps work</span>
<span class="cm">	 * item again unmasking PM interrupts because that is using a different</span>
<span class="cm">	 * register (PMIMR) to mask PM interrupts. The only risk is in leaving</span>
<span class="cm">	 * stale bits in PMIIR and PMIMR which gen6_enable_rps will clean up. */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pm_iir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intel_enable_rc6</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Respect the kernel parameter if it is set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i915_enable_rc6</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i915_enable_rc6</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable RC6 on Ironlake</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Sorry Haswell, no RC6 for you for now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable rc6 on Sandybridge</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Sandybridge: deep RC6 disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">INTEL_RC6_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;RC6 and deep RC6 enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">INTEL_RC6_ENABLE</span> <span class="o">|</span> <span class="n">INTEL_RC6p_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gen6_enable_rps</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rp_state_cap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gt_perf_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pcu_mbox</span><span class="p">,</span> <span class="n">rc6_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gtfifodbg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc6_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Here begins a magic sequence of register writes to enable</span>
<span class="cm">	 * auto-downclocking.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Perhaps there might be some value in exposing these to</span>
<span class="cm">	 * userspace...</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* Clear the DBG now so we don&#39;t confuse earlier errors */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">gtfifodbg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTFIFODBG</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;GT fifo had a previous error %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gtfifodbg</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTFIFODBG</span><span class="p">,</span> <span class="n">gtfifodbg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gen6_gt_force_wake_get</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">rp_state_cap</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_STATE_CAP</span><span class="p">);</span>
	<span class="n">gt_perf_status</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_GT_PERF_STATUS</span><span class="p">);</span>

	<span class="cm">/* In units of 100MHz */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">=</span> <span class="n">rp_state_cap</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp_state_cap</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* disable the counters and set deterministic thresholds */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC1_WAKE_RATE_LIMIT</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC6_WAKE_RATE_LIMIT</span><span class="p">,</span> <span class="mi">40</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC6pp_WAKE_RATE_LIMIT</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC_EVALUATION_INTERVAL</span><span class="p">,</span> <span class="mi">125000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC_IDLE_HYSTERSIS</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>

	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RING_MAX_IDLE</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC_SLEEP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC1e_THRESHOLD</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC6_THRESHOLD</span><span class="p">,</span> <span class="mi">50000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC6p_THRESHOLD</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC6pp_THRESHOLD</span><span class="p">,</span> <span class="mi">64000</span><span class="p">);</span> <span class="cm">/* unused */</span>

	<span class="n">rc6_mode</span> <span class="o">=</span> <span class="n">intel_enable_rc6</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc6_mode</span> <span class="o">&amp;</span> <span class="n">INTEL_RC6_ENABLE</span><span class="p">)</span>
		<span class="n">rc6_mask</span> <span class="o">|=</span> <span class="n">GEN6_RC_CTL_RC6_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc6_mode</span> <span class="o">&amp;</span> <span class="n">INTEL_RC6p_ENABLE</span><span class="p">)</span>
		<span class="n">rc6_mask</span> <span class="o">|=</span> <span class="n">GEN6_RC_CTL_RC6p_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc6_mode</span> <span class="o">&amp;</span> <span class="n">INTEL_RC6pp_ENABLE</span><span class="p">)</span>
		<span class="n">rc6_mask</span> <span class="o">|=</span> <span class="n">GEN6_RC_CTL_RC6pp_ENABLE</span><span class="p">;</span>

	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Enabling RC6 states: RC6 %s, RC6p %s, RC6pp %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">rc6_mode</span> <span class="o">&amp;</span> <span class="n">INTEL_RC6_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">rc6_mode</span> <span class="o">&amp;</span> <span class="n">INTEL_RC6p_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">rc6_mode</span> <span class="o">&amp;</span> <span class="n">INTEL_RC6pp_ENABLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC_CONTROL</span><span class="p">,</span>
		   <span class="n">rc6_mask</span> <span class="o">|</span>
		   <span class="n">GEN6_RC_CTL_EI_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">GEN6_RC_CTL_HW_ENABLE</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RPNSWREQ</span><span class="p">,</span>
		   <span class="n">GEN6_FREQUENCY</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">GEN6_OFFSET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">GEN6_AGGRESSIVE_TURBO</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RC_VIDEO_FREQ</span><span class="p">,</span>
		   <span class="n">GEN6_FREQUENCY</span><span class="p">(</span><span class="mi">12</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_DOWN_TIMEOUT</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_INTERRUPT_LIMITS</span><span class="p">,</span>
		   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span>
		   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_UP_THRESHOLD</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_DOWN_THRESHOLD</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_UP_EI</span><span class="p">,</span> <span class="mi">100000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_DOWN_EI</span><span class="p">,</span> <span class="mi">5000000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_IDLE_HYSTERSIS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_CONTROL</span><span class="p">,</span>
		   <span class="n">GEN6_RP_MEDIA_TURBO</span> <span class="o">|</span>
		   <span class="n">GEN6_RP_MEDIA_HW_NORMAL_MODE</span> <span class="o">|</span>
		   <span class="n">GEN6_RP_MEDIA_IS_GFX</span> <span class="o">|</span>
		   <span class="n">GEN6_RP_ENABLE</span> <span class="o">|</span>
		   <span class="n">GEN6_RP_UP_BUSY_AVG</span> <span class="o">|</span>
		   <span class="n">GEN6_RP_DOWN_IDLE_CONT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GEN6_PCODE_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="mi">500</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for pcode mailbox to become idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PCODE_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">,</span>
		   <span class="n">GEN6_PCODE_READY</span> <span class="o">|</span>
		   <span class="n">GEN6_PCODE_WRITE_MIN_FREQ_TABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GEN6_PCODE_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="mi">500</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for pcode mailbox to finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Check for overclock support */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GEN6_PCODE_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="mi">500</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for pcode mailbox to become idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">,</span> <span class="n">GEN6_READ_OC_PARAMS</span><span class="p">);</span>
	<span class="n">pcu_mbox</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_DATA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GEN6_PCODE_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
		     <span class="mi">500</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for pcode mailbox to finish</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcu_mbox</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* OC supported */</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">=</span> <span class="n">pcu_mbox</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;overclocking supported, adjusting frequency max to %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcu_mbox</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gen6_set_rps</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">gt_perf_status</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* requires MSI enabled */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIER</span><span class="p">,</span>
		   <span class="n">GEN6_PM_MBOX_EVENT</span> <span class="o">|</span>
		   <span class="n">GEN6_PM_THERMAL_EVENT</span> <span class="o">|</span>
		   <span class="n">GEN6_PM_RP_DOWN_TIMEOUT</span> <span class="o">|</span>
		   <span class="n">GEN6_PM_RP_UP_THRESHOLD</span> <span class="o">|</span>
		   <span class="n">GEN6_PM_RP_DOWN_THRESHOLD</span> <span class="o">|</span>
		   <span class="n">GEN6_PM_RP_UP_EI_EXPIRED</span> <span class="o">|</span>
		   <span class="n">GEN6_PM_RP_DOWN_EI_EXPIRED</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pm_iir</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">);</span>
	<span class="cm">/* enable all PM interrupts */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMINTRMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">gen6_gt_force_wake_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gen6_update_ring_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">min_freq</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpu_freq</span><span class="p">,</span> <span class="n">ia_freq</span><span class="p">,</span> <span class="n">max_ia_freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scaling_factor</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span>

	<span class="n">max_ia_freq</span> <span class="o">=</span> <span class="n">cpufreq_quick_get_max</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Default to measured freq if none found, PCU will ensure we don&#39;t go</span>
<span class="cm">	 * over</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_ia_freq</span><span class="p">)</span>
		<span class="n">max_ia_freq</span> <span class="o">=</span> <span class="n">tsc_khz</span><span class="p">;</span>

	<span class="cm">/* Convert from kHz to MHz */</span>
	<span class="n">max_ia_freq</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For each potential GPU frequency, load a ring frequency we&#39;d like</span>
<span class="cm">	 * to use for memory access.  We do this by specifying the IA frequency</span>
<span class="cm">	 * the PCU should use as a reference to determine the ring frequency.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">gpu_freq</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">;</span> <span class="n">gpu_freq</span> <span class="o">&gt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">;</span>
	     <span class="n">gpu_freq</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">-</span> <span class="n">gpu_freq</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * For GPU frequencies less than 750MHz, just use the lowest</span>
<span class="cm">		 * ring freq.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpu_freq</span> <span class="o">&lt;</span> <span class="n">min_freq</span><span class="p">)</span>
			<span class="n">ia_freq</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ia_freq</span> <span class="o">=</span> <span class="n">max_ia_freq</span> <span class="o">-</span> <span class="p">((</span><span class="n">diff</span> <span class="o">*</span> <span class="n">scaling_factor</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ia_freq</span> <span class="o">=</span> <span class="n">DIV_ROUND_CLOSEST</span><span class="p">(</span><span class="n">ia_freq</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PCODE_DATA</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">ia_freq</span> <span class="o">&lt;&lt;</span> <span class="n">GEN6_PCODE_FREQ_IA_RATIO_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">gpu_freq</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">,</span> <span class="n">GEN6_PCODE_READY</span> <span class="o">|</span>
			   <span class="n">GEN6_PCODE_WRITE_MIN_FREQ_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">GEN6_PCODE_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;pcode write of freq table timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_teardown_rc6</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span><span class="p">);</span>
		<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span><span class="p">);</span>
		<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ironlake_disable_rc6</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PWRCTXA</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Wake the GPU, prevent RC6, then restore RSTDBYCTL */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">RCX_SW_EXIT</span><span class="p">);</span>
		<span class="n">wait_for</span><span class="p">(((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RSX_STATUS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">RSX_STATUS_ON</span><span class="p">),</span>
			 <span class="mi">50</span><span class="p">);</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PWRCTXA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PWRCTXA</span><span class="p">);</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RCX_SW_EXIT</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ironlake_teardown_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ironlake_setup_rc6</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span> <span class="o">=</span> <span class="n">intel_alloc_context_page</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span> <span class="o">=</span> <span class="n">intel_alloc_context_page</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ironlake_teardown_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ironlake_enable_rc6</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* rc6 disabled by default due to repeated reports of hanging during</span>
<span class="cm">	 * boot and resume.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_enable_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ironlake_setup_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * GPU can automatically power down the render unit if given a page</span>
<span class="cm">	 * to save state.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ironlake_teardown_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_SUSPEND_FLUSH</span> <span class="o">|</span> <span class="n">MI_SUSPEND_FLUSH_EN</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_SET_CONTEXT</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">|</span>
			<span class="n">MI_MM_SPACE_GTT</span> <span class="o">|</span>
			<span class="n">MI_SAVE_EXT_STATE_EN</span> <span class="o">|</span>
			<span class="n">MI_RESTORE_EXT_STATE_EN</span> <span class="o">|</span>
			<span class="n">MI_RESTORE_INHIBIT</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_SUSPEND_FLUSH</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_NOOP</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_FLUSH</span><span class="p">);</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the command parser to advance past MI_SET_CONTEXT. The HW</span>
<span class="cm">	 * does an implicit flush, combined with MI_FLUSH above, it should be</span>
<span class="cm">	 * safe to assume that renderctx is valid</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_wait_ring_idle</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to enable ironlake power power savings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ironlake_teardown_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PWRCTXA</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">|</span> <span class="n">PWRCTX_EN</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RCX_SW_EXIT</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">intel_pxfreq</span><span class="p">(</span><span class="n">u32</span> <span class="n">vidfreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="p">(</span><span class="n">vidfreq</span> <span class="o">&amp;</span> <span class="mh">0x3f0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">post</span> <span class="o">=</span> <span class="p">(</span><span class="n">vidfreq</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pre</span> <span class="o">=</span> <span class="p">(</span><span class="n">vidfreq</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pre</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">freq</span> <span class="o">=</span> <span class="p">((</span><span class="n">div</span> <span class="o">*</span> <span class="mi">133333</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">post</span><span class="p">)</span> <span class="o">*</span> <span class="n">pre</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cparams</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span> <span class="n">cparams</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1333</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">28664</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1066</span><span class="p">,</span> <span class="mi">294</span><span class="p">,</span> <span class="mi">24460</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">294</span><span class="p">,</span> <span class="mi">25192</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1333</span><span class="p">,</span> <span class="mi">276</span><span class="p">,</span> <span class="mi">27605</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1066</span><span class="p">,</span> <span class="mi">276</span><span class="p">,</span> <span class="mi">27605</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">23784</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">i915_chipset_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">total_count</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count1</span><span class="p">,</span> <span class="n">count2</span><span class="p">,</span> <span class="n">count3</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">),</span> <span class="n">diff1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">diff1</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_time1</span><span class="p">;</span>

	<span class="cm">/* Prevent division-by-zero if we are asking too fast.</span>
<span class="cm">	 * Also, we don&#39;t get interesting results if we are polling</span>
<span class="cm">	 * faster than once in 10ms, so just return the saved value</span>
<span class="cm">	 * in such cases.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diff1</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset_power</span><span class="p">;</span>

	<span class="n">count1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DMIEC</span><span class="p">);</span>
	<span class="n">count2</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DDREC</span><span class="p">);</span>
	<span class="n">count3</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CSIEC</span><span class="p">);</span>

	<span class="n">total_count</span> <span class="o">=</span> <span class="n">count1</span> <span class="o">+</span> <span class="n">count2</span> <span class="o">+</span> <span class="n">count3</span><span class="p">;</span>

	<span class="cm">/* FIXME: handle per-counter overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_count</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count1</span><span class="p">;</span>
		<span class="n">diff</span> <span class="o">+=</span> <span class="n">total_count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="n">total_count</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cparams</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cparams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">c_m</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cparams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">t</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">r_t</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">cparams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">m</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">cparams</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diff</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diff1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count1</span> <span class="o">=</span> <span class="n">total_count</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_time1</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">chipset_power</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">i915_mch_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">m</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tsfs</span><span class="p">;</span>

	<span class="n">tsfs</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">TSFS</span><span class="p">);</span>

	<span class="n">m</span> <span class="o">=</span> <span class="p">((</span><span class="n">tsfs</span> <span class="o">&amp;</span> <span class="n">TSFS_SLOPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TSFS_SLOPE_SHIFT</span><span class="p">);</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">I915_READ8</span><span class="p">(</span><span class="n">TR1</span><span class="p">);</span>

	<span class="n">b</span> <span class="o">=</span> <span class="n">tsfs</span> <span class="o">&amp;</span> <span class="n">TSFS_INTR_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">127</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">pvid_to_extvid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pxvid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v_table</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">vd</span><span class="p">;</span> <span class="cm">/* in .1 mil */</span>
		<span class="n">u16</span> <span class="n">vm</span><span class="p">;</span> <span class="cm">/* in .1 mil */</span>
	<span class="p">}</span> <span class="n">v_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">375</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">875</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">1125</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4125</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4250</span><span class="p">,</span> <span class="mi">3125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4375</span><span class="p">,</span> <span class="mi">3250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4500</span><span class="p">,</span> <span class="mi">3375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4625</span><span class="p">,</span> <span class="mi">3500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4750</span><span class="p">,</span> <span class="mi">3625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">4875</span><span class="p">,</span> <span class="mi">3750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">3875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5125</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5250</span><span class="p">,</span> <span class="mi">4125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5375</span><span class="p">,</span> <span class="mi">4250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5500</span><span class="p">,</span> <span class="mi">4375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5625</span><span class="p">,</span> <span class="mi">4500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5750</span><span class="p">,</span> <span class="mi">4625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">5875</span><span class="p">,</span> <span class="mi">4750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6000</span><span class="p">,</span> <span class="mi">4875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6125</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6250</span><span class="p">,</span> <span class="mi">5125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6375</span><span class="p">,</span> <span class="mi">5250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6500</span><span class="p">,</span> <span class="mi">5375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6625</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6750</span><span class="p">,</span> <span class="mi">5625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">6875</span><span class="p">,</span> <span class="mi">5750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7000</span><span class="p">,</span> <span class="mi">5875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7125</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7250</span><span class="p">,</span> <span class="mi">6125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7375</span><span class="p">,</span> <span class="mi">6250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7500</span><span class="p">,</span> <span class="mi">6375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7625</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7750</span><span class="p">,</span> <span class="mi">6625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">7875</span><span class="p">,</span> <span class="mi">6750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">6875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8125</span><span class="p">,</span> <span class="mi">7000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8250</span><span class="p">,</span> <span class="mi">7125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8375</span><span class="p">,</span> <span class="mi">7250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8500</span><span class="p">,</span> <span class="mi">7375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8625</span><span class="p">,</span> <span class="mi">7500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8750</span><span class="p">,</span> <span class="mi">7625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">8875</span><span class="p">,</span> <span class="mi">7750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9000</span><span class="p">,</span> <span class="mi">7875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9125</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9250</span><span class="p">,</span> <span class="mi">8125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9375</span><span class="p">,</span> <span class="mi">8250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9500</span><span class="p">,</span> <span class="mi">8375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9625</span><span class="p">,</span> <span class="mi">8500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9750</span><span class="p">,</span> <span class="mi">8625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">9875</span><span class="p">,</span> <span class="mi">8750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">8875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10125</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10250</span><span class="p">,</span> <span class="mi">9125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10375</span><span class="p">,</span> <span class="mi">9250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10500</span><span class="p">,</span> <span class="mi">9375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10625</span><span class="p">,</span> <span class="mi">9500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10750</span><span class="p">,</span> <span class="mi">9625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">10875</span><span class="p">,</span> <span class="mi">9750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11000</span><span class="p">,</span> <span class="mi">9875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11125</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11250</span><span class="p">,</span> <span class="mi">10125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11375</span><span class="p">,</span> <span class="mi">10250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11500</span><span class="p">,</span> <span class="mi">10375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11625</span><span class="p">,</span> <span class="mi">10500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11750</span><span class="p">,</span> <span class="mi">10625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">11875</span><span class="p">,</span> <span class="mi">10750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">10875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12125</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12250</span><span class="p">,</span> <span class="mi">11125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12375</span><span class="p">,</span> <span class="mi">11250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12500</span><span class="p">,</span> <span class="mi">11375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12625</span><span class="p">,</span> <span class="mi">11500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12750</span><span class="p">,</span> <span class="mi">11625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">12875</span><span class="p">,</span> <span class="mi">11750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13000</span><span class="p">,</span> <span class="mi">11875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13125</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13250</span><span class="p">,</span> <span class="mi">12125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13375</span><span class="p">,</span> <span class="mi">12250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13500</span><span class="p">,</span> <span class="mi">12375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13625</span><span class="p">,</span> <span class="mi">12500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13750</span><span class="p">,</span> <span class="mi">12625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">13875</span><span class="p">,</span> <span class="mi">12750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14000</span><span class="p">,</span> <span class="mi">12875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14125</span><span class="p">,</span> <span class="mi">13000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14250</span><span class="p">,</span> <span class="mi">13125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14375</span><span class="p">,</span> <span class="mi">13250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14500</span><span class="p">,</span> <span class="mi">13375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14625</span><span class="p">,</span> <span class="mi">13500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14750</span><span class="p">,</span> <span class="mi">13625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">14875</span><span class="p">,</span> <span class="mi">13750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15000</span><span class="p">,</span> <span class="mi">13875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15125</span><span class="p">,</span> <span class="mi">14000</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15250</span><span class="p">,</span> <span class="mi">14125</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15375</span><span class="p">,</span> <span class="mi">14250</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15500</span><span class="p">,</span> <span class="mi">14375</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15625</span><span class="p">,</span> <span class="mi">14500</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15750</span><span class="p">,</span> <span class="mi">14625</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">15875</span><span class="p">,</span> <span class="mi">14750</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">14875</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">16125</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_mobile</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v_table</span><span class="p">[</span><span class="n">pxvid</span><span class="p">].</span><span class="n">vm</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">v_table</span><span class="p">[</span><span class="n">pxvid</span><span class="p">].</span><span class="n">vd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_update_gfx_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">now</span><span class="p">,</span> <span class="n">diff1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">diff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">diffms</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">getrawmonotonic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
	<span class="n">diff1</span> <span class="o">=</span> <span class="n">timespec_sub</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_time2</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t divide by 0 */</span>
	<span class="n">diffms</span> <span class="o">=</span> <span class="n">diff1</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">diff1</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diffms</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GFXEC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0UL</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count2</span><span class="p">;</span>
		<span class="n">diff</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">diff</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_count2</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_time2</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

	<span class="cm">/* More magic constants... */</span>
	<span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">*</span> <span class="mi">1181</span><span class="p">;</span>
	<span class="n">diff</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">diffms</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gfx_power</span> <span class="o">=</span> <span class="n">diff</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">i915_gfx_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">state1</span><span class="p">,</span> <span class="n">corr2</span><span class="p">,</span> <span class="n">state2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pxvid</span><span class="p">,</span> <span class="n">ext_v</span><span class="p">;</span>

	<span class="n">pxvid</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PXVFREQ_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">pxvid</span> <span class="o">=</span> <span class="p">(</span><span class="n">pxvid</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">ext_v</span> <span class="o">=</span> <span class="n">pvid_to_extvid</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pxvid</span><span class="p">);</span>

	<span class="n">state1</span> <span class="o">=</span> <span class="n">ext_v</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">i915_mch_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/* Revel in the empirically derived constants */</span>

	<span class="cm">/* Correction factor in 1/100000 units */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">80</span><span class="p">)</span>
		<span class="n">corr</span> <span class="o">=</span> <span class="p">((</span><span class="n">t</span> <span class="o">*</span> <span class="mi">2349</span><span class="p">)</span> <span class="o">+</span> <span class="mi">135940</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">corr</span> <span class="o">=</span> <span class="p">((</span><span class="n">t</span> <span class="o">*</span> <span class="mi">964</span><span class="p">)</span> <span class="o">+</span> <span class="mi">29317</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* &lt; 50 */</span>
		<span class="n">corr</span> <span class="o">=</span> <span class="p">((</span><span class="n">t</span> <span class="o">*</span> <span class="mi">301</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1004</span><span class="p">);</span>

	<span class="n">corr</span> <span class="o">=</span> <span class="n">corr</span> <span class="o">*</span> <span class="p">((</span><span class="mi">150142</span> <span class="o">*</span> <span class="n">state1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span> <span class="o">-</span> <span class="mi">78642</span><span class="p">);</span>
	<span class="n">corr</span> <span class="o">/=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="n">corr2</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr</span> <span class="o">*</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">corr</span><span class="p">);</span>

	<span class="n">state2</span> <span class="o">=</span> <span class="p">(</span><span class="n">corr2</span> <span class="o">*</span> <span class="n">state1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">state2</span> <span class="o">/=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* convert to mW */</span>

	<span class="n">i915_update_gfx_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gfx_power</span> <span class="o">+</span> <span class="n">state2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Global for IPS driver to get at the current i915 device */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">i915_mch_dev</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Lock protecting IPS related data structures</span>
<span class="cm"> *   - i915_mch_dev</span>
<span class="cm"> *   - dev_priv-&gt;max_delay</span>
<span class="cm"> *   - dev_priv-&gt;min_delay</span>
<span class="cm"> *   - dev_priv-&gt;fmax</span>
<span class="cm"> *   - dev_priv-&gt;gpu_busy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">mchdev_lock</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * i915_read_mch_val - return value for IPS use</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate and return a value for the IPS driver to use when deciding whether</span>
<span class="cm"> * we have thermal and power headroom to increase CPU or GPU power budget.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">i915_read_mch_val</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">chipset_val</span><span class="p">,</span> <span class="n">graphics_val</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_mch_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">i915_mch_dev</span><span class="p">;</span>

	<span class="n">chipset_val</span> <span class="o">=</span> <span class="n">i915_chipset_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">graphics_val</span> <span class="o">=</span> <span class="n">i915_gfx_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">chipset_val</span> <span class="o">+</span> <span class="n">graphics_val</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">i915_read_mch_val</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gpu_raise - raise GPU frequency limit</span>
<span class="cm"> *</span>
<span class="cm"> * Raise the limit; IPS indicates we have thermal headroom.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">i915_gpu_raise</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_mch_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">i915_mch_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fmax</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="o">--</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">i915_gpu_raise</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gpu_lower - lower GPU frequency limit</span>
<span class="cm"> *</span>
<span class="cm"> * IPS indicates we&#39;re close to a thermal limit, so throttle back the GPU</span>
<span class="cm"> * frequency maximum.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">i915_gpu_lower</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_mch_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">i915_mch_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="o">++</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">i915_gpu_lower</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gpu_busy - indicate GPU business to IPS</span>
<span class="cm"> *</span>
<span class="cm"> * Tell the IPS driver whether or not the GPU is busy.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">i915_gpu_busy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_mch_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">i915_mch_dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">i915_gpu_busy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * i915_gpu_turbo_disable - disable graphics turbo</span>
<span class="cm"> *</span>
<span class="cm"> * Disable graphics turbo by resetting the max frequency and setting the</span>
<span class="cm"> * current frequency to the default.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">i915_gpu_turbo_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_mch_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">i915_mch_dev</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fstart</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_set_drps</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fstart</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">i915_gpu_turbo_disable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Tells the intel_ips driver that the i915 driver is now loaded, if</span>
<span class="cm"> * IPS got loaded first.</span>
<span class="cm"> *</span>
<span class="cm"> * This awkward dance is so that neither module has to depend on the</span>
<span class="cm"> * other in order for IPS to do the appropriate communication of</span>
<span class="cm"> * GPU turbo limits to i915.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ips_ping_for_i915_load</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">link</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">ips_link_to_i915_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link</span><span class="p">();</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">ips_link_to_i915_driver</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_gpu_ips_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
	<span class="n">i915_mch_dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mchdev_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>

	<span class="n">ips_ping_for_i915_load</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_gpu_ips_teardown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
	<span class="n">i915_mch_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mchdev_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_init_emon</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lcfuse</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pxw</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Disable to program */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ECR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">ECR</span><span class="p">);</span>

	<span class="cm">/* Program energy weights for various events */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEW</span><span class="p">,</span> <span class="mh">0x15040d00</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CSIEW0</span><span class="p">,</span> <span class="mh">0x007f0000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CSIEW1</span><span class="p">,</span> <span class="mh">0x1e220004</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CSIEW2</span><span class="p">,</span> <span class="mh">0x04000004</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PEW</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEW</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Program P-state weights to account for frequency power adjustment */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pxvidfreq</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PXVFREQ_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">intel_pxfreq</span><span class="p">(</span><span class="n">pxvidfreq</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vid</span> <span class="o">=</span> <span class="p">(</span><span class="n">pxvidfreq</span> <span class="o">&amp;</span> <span class="n">PXVFREQ_PX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PXVFREQ_PX_SHIFT</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">vid</span> <span class="o">*</span> <span class="n">vid</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">*=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">*=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">127</span><span class="o">*</span><span class="mi">127</span><span class="o">*</span><span class="mi">900</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad pxval: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pxw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Render standby states get 0 weight */</span>
	<span class="n">pxw</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pxw</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">pxw</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pxw</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">pxw</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pxw</span><span class="p">[(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PXW</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Adjust magic regs to magic values (more experimental results) */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGW0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGW1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG0</span><span class="p">,</span> <span class="mh">0x00007f00</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG1</span><span class="p">,</span> <span class="mh">0x0000000e</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG2</span><span class="p">,</span> <span class="mh">0x000e0000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG3</span><span class="p">,</span> <span class="mh">0x68000300</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG4</span><span class="p">,</span> <span class="mh">0x42000000</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG5</span><span class="p">,</span> <span class="mh">0x00140031</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EG7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PXWL</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable PMON + select events */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ECR</span><span class="p">,</span> <span class="mh">0x80000019</span><span class="p">);</span>

	<span class="n">lcfuse</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">LCFUSE02</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lcfuse</span> <span class="o">&amp;</span> <span class="n">LCFUSE_HIV_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dspclk_gate</span> <span class="o">=</span> <span class="n">VRHUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>

	<span class="cm">/* Required for FBC */</span>
	<span class="n">dspclk_gate</span> <span class="o">|=</span> <span class="n">DPFCUNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		<span class="n">DPFCRUNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		<span class="n">DPFDUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>
	<span class="cm">/* Required for CxSR */</span>
	<span class="n">dspclk_gate</span> <span class="o">|=</span> <span class="n">DPARBUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_3DCGDIS0</span><span class="p">,</span>
		   <span class="n">MARIUNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">SVSMUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_3DCGDIS1</span><span class="p">,</span>
		   <span class="n">VFMUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">dspclk_gate</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * According to the spec the following bits should be set in</span>
<span class="cm">	 * order to enable memory self-refresh</span>
<span class="cm">	 * The bit 22/21 of 0x42004</span>
<span class="cm">	 * The bit 5 of 0x42020</span>
<span class="cm">	 * The bit 15 of 0x45000</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">ILK_DPARB_GATE</span> <span class="o">|</span> <span class="n">ILK_VSDPFD_FULL</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">ILK_DPARB_CLK_GATE</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DISP_ARB_CTL</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DISP_ARB_CTL</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">DISP_FBC_WM_DIS</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Based on the document from hardware guys the following bits</span>
<span class="cm">	 * should be set unconditionally in order to enable FBC.</span>
<span class="cm">	 * The bit 22 of 0x42000</span>
<span class="cm">	 * The bit 22 of 0x42004</span>
<span class="cm">	 * The bit 7,8,9 of 0x42020.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IRONLAKE_M</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN1</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN1</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">ILK_FBCQ_DIS</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">ILK_DPARB_GATE</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">ILK_DPFC_DIS1</span> <span class="o">|</span>
			   <span class="n">ILK_DPFC_DIS2</span> <span class="o">|</span>
			   <span class="n">ILK_CLK_FBC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">ILK_ELPIN_409_SELECT</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">_3D_CHICKEN2</span><span class="p">,</span>
		   <span class="n">_3D_CHICKEN2_WM_READ_PIPELINED</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		   <span class="n">_3D_CHICKEN2_WM_READ_PIPELINED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen6_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dspclk_gate</span> <span class="o">=</span> <span class="n">VRHUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">dspclk_gate</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">ILK_ELPIN_409_SELECT</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CACHE_MODE_0</span><span class="p">,</span>
		   <span class="n">_MASKED_BIT_DISABLE</span><span class="p">(</span><span class="n">CM0_STC_EVICT_DISABLE_LRA_SNB</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_UCGCTL1</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_UCGCTL1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">GEN6_BLBUNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">GEN6_CSUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>

	<span class="cm">/* According to the BSpec vol1g, bit 12 (RCPBUNIT) clock</span>
<span class="cm">	 * gating disable must be set.  Failure to set it results in</span>
<span class="cm">	 * flickering pixels due to Z write ordering failures after</span>
<span class="cm">	 * some amount of runtime in the Mesa &quot;fire&quot; demo, and Unigine</span>
<span class="cm">	 * Sanctuary and Tropics, and apparently anything else with</span>
<span class="cm">	 * alpha test or pixel discard.</span>
<span class="cm">	 *</span>
<span class="cm">	 * According to the spec, bit 11 (RCCUNIT) must also be set,</span>
<span class="cm">	 * but we didn&#39;t debug actual testcases to find it out.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_UCGCTL2</span><span class="p">,</span>
		   <span class="n">GEN6_RCPBUNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">GEN6_RCCUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>

	<span class="cm">/* Bspec says we need to always set all mask bits. */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">_3D_CHICKEN</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xFFFF</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">_3D_CHICKEN_SF_DISABLE_FASTCLIP_CULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * According to the spec the following bits should be</span>
<span class="cm">	 * set in order to enable memory self-refresh and fbc:</span>
<span class="cm">	 * The bit21 and bit22 of 0x42000</span>
<span class="cm">	 * The bit21 and bit22 of 0x42004</span>
<span class="cm">	 * The bit5 and bit7 of 0x42020</span>
<span class="cm">	 * The bit14 of 0x70180</span>
<span class="cm">	 * The bit14 of 0x71180</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN1</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">ILK_FBCQ_DIS</span> <span class="o">|</span> <span class="n">ILK_PABSTRETCH_DIS</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN2</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">ILK_DPARB_GATE</span> <span class="o">|</span> <span class="n">ILK_VSDPFD_FULL</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">ILK_DPARB_CLK_GATE</span>  <span class="o">|</span>
		   <span class="n">ILK_DPFD_CLK_GATE</span><span class="p">);</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">|</span>
			   <span class="n">DISPPLANE_TRICKLE_FEED_DISABLE</span><span class="p">);</span>
		<span class="n">intel_flush_display_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen7_setup_fixed_func_scheduler</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN7_FF_THREAD_MODE</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GEN7_FF_SCHED_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">GEN7_FF_TS_SCHED_HW</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">GEN7_FF_VS_SCHED_HW</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">GEN7_FF_DS_SCHED_HW</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_FF_THREAD_MODE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivybridge_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dspclk_gate</span> <span class="o">=</span> <span class="n">VRHUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">dspclk_gate</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* According to the spec, bit 13 (RCZUNIT) must be set on IVB.</span>
<span class="cm">	 * This implements the WaDisableRCZUnitClockGating workaround.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_UCGCTL2</span><span class="p">,</span> <span class="n">GEN6_RCZUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">,</span> <span class="n">IVB_VRHUNIT_CLK_GATE</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IVB_CHICKEN3</span><span class="p">,</span>
		   <span class="n">CHICKEN3_DGMG_REQ_OUT_FIX_DISABLE</span> <span class="o">|</span>
		   <span class="n">CHICKEN3_DGMG_DONE_FIX_DISABLE</span><span class="p">);</span>

	<span class="cm">/* Apply the WaDisableRHWOOptimizationForRenderHang workaround. */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_COMMON_SLICE_CHICKEN1</span><span class="p">,</span>
		   <span class="n">GEN7_CSC1_RHWO_OPT_DISABLE_IN_RCC</span><span class="p">);</span>

	<span class="cm">/* WaApplyL3ControlAndL3ChickenMode requires those two on Ivy Bridge */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_L3CNTLREG1</span><span class="p">,</span>
			<span class="n">GEN7_WA_FOR_GEN7_L3_CONTROL</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_L3_CHICKEN_MODE_REGISTER</span><span class="p">,</span>
			<span class="n">GEN7_WA_L3_CHICKEN_MODE</span><span class="p">);</span>

	<span class="cm">/* This is required by WaCatErrorRejectionIssue */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_SQ_CHICKEN_MBCUNIT_CONFIG</span><span class="p">,</span>
			<span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN7_SQ_CHICKEN_MBCUNIT_CONFIG</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">GEN7_SQ_CHICKEN_MBCUNIT_SQINTMOB</span><span class="p">);</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">|</span>
			   <span class="n">DISPPLANE_TRICKLE_FEED_DISABLE</span><span class="p">);</span>
		<span class="n">intel_flush_display_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gen7_setup_fixed_func_scheduler</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/* WaDisable4x2SubspanOptimization */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CACHE_MODE_1</span><span class="p">,</span>
		   <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">PIXEL_SUBSPAN_COLLECT_OPT_DISABLE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">valleyview_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dspclk_gate</span> <span class="o">=</span> <span class="n">VRHUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">dspclk_gate</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM3_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM2_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* According to the spec, bit 13 (RCZUNIT) must be set on IVB.</span>
<span class="cm">	 * This implements the WaDisableRCZUnitClockGating workaround.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_UCGCTL2</span><span class="p">,</span> <span class="n">GEN6_RCZUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ILK_DSPCLK_GATE</span><span class="p">,</span> <span class="n">IVB_VRHUNIT_CLK_GATE</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IVB_CHICKEN3</span><span class="p">,</span>
		   <span class="n">CHICKEN3_DGMG_REQ_OUT_FIX_DISABLE</span> <span class="o">|</span>
		   <span class="n">CHICKEN3_DGMG_DONE_FIX_DISABLE</span><span class="p">);</span>

	<span class="cm">/* Apply the WaDisableRHWOOptimizationForRenderHang workaround. */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_COMMON_SLICE_CHICKEN1</span><span class="p">,</span>
		   <span class="n">GEN7_CSC1_RHWO_OPT_DISABLE_IN_RCC</span><span class="p">);</span>

	<span class="cm">/* WaApplyL3ControlAndL3ChickenMode requires those two on Ivy Bridge */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_L3CNTLREG1</span><span class="p">,</span> <span class="n">GEN7_WA_FOR_GEN7_L3_CONTROL</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_L3_CHICKEN_MODE_REGISTER</span><span class="p">,</span> <span class="n">GEN7_WA_L3_CHICKEN_MODE</span><span class="p">);</span>

	<span class="cm">/* This is required by WaCatErrorRejectionIssue */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN7_SQ_CHICKEN_MBCUNIT_CONFIG</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN7_SQ_CHICKEN_MBCUNIT_CONFIG</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">GEN7_SQ_CHICKEN_MBCUNIT_SQINTMOB</span><span class="p">);</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">|</span>
			   <span class="n">DISPPLANE_TRICKLE_FEED_DISABLE</span><span class="p">);</span>
		<span class="n">intel_flush_display_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CACHE_MODE_1</span><span class="p">,</span>
		   <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">PIXEL_SUBSPAN_COLLECT_OPT_DISABLE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">g4x_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dspclk_gate</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RENCLK_GATE_D1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RENCLK_GATE_D2</span><span class="p">,</span> <span class="n">VF_UNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">GS_UNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">CL_UNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RAMCLK_GATE_D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dspclk_gate</span> <span class="o">=</span> <span class="n">VRHUNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		<span class="n">OVRUNIT_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		<span class="n">OVCUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GM45</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dspclk_gate</span> <span class="o">|=</span> <span class="n">DSSUNIT_CLOCK_GATE_DISABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">dspclk_gate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crestline_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RENCLK_GATE_D1</span><span class="p">,</span> <span class="n">I965_RCC_CLOCK_GATE_DISABLE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RENCLK_GATE_D2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCLK_GATE_D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RAMCLK_GATE_D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">DEUC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">broadwater_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RENCLK_GATE_D1</span><span class="p">,</span> <span class="n">I965_RCZ_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">I965_RCC_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">I965_RCPB_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">I965_ISC_CLOCK_GATE_DISABLE</span> <span class="o">|</span>
		   <span class="n">I965_FBC_CLOCK_GATE_DISABLE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RENCLK_GATE_D2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen3_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dstate</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">D_STATE</span><span class="p">);</span>

	<span class="n">dstate</span> <span class="o">|=</span> <span class="n">DSTATE_PLL_D3_OFF</span> <span class="o">|</span> <span class="n">DSTATE_GFX_CLOCK_GATING</span> <span class="o">|</span>
		<span class="n">DSTATE_DOT_CLOCK_GATING</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">D_STATE</span><span class="p">,</span> <span class="n">dstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ECOSKPD</span><span class="p">,</span> <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">ECO_GATING_CX_ONLY</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i85x_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RENCLK_GATE_D1</span><span class="p">,</span> <span class="n">SV_CLOCK_GATE_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i830_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">OVRUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ibx_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On Ibex Peak and Cougar Point, we need to disable clock</span>
<span class="cm">	 * gating for the panel power sequencer or it will fail to</span>
<span class="cm">	 * start up when no ports are active.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SOUTH_DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">PCH_DPLSUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpt_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On Ibex Peak and Cougar Point, we need to disable clock</span>
<span class="cm">	 * gating for the panel power sequencer or it will fail to</span>
<span class="cm">	 * start up when no ports are active.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SOUTH_DSPCLK_GATE_D</span><span class="p">,</span> <span class="n">PCH_DPLSUNIT_CLOCK_GATE_DISABLE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SOUTH_CHICKEN2</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SOUTH_CHICKEN2</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">DPLS_EDP_PPS_FIX_DIS</span><span class="p">);</span>
	<span class="cm">/* Without this, mode sets may fail silently on FDI */</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_CHICKEN2</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">TRANS_AUTOTRAIN_GEN_STALL_DIS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_init_clock_gating</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_pch_clock_gating</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_pch_clock_gating</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen6_sanitize_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">limits</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">gen6_gt_force_wake_get</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">limits</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_INTERRUPT_LIMITS</span><span class="p">);</span>
	<span class="cm">/* Make sure we continue to get interrupts</span>
<span class="cm">	 * until we hit the minimum or maximum frequencies.</span>
<span class="cm">	 */</span>
	<span class="n">limits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3f</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="mh">0x3f</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">)</span>
		<span class="n">limits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">)</span>
		<span class="n">limits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">limits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note that the known failure case is to read back 0. */</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Power management discrepancy: GEN6_RP_INTERRUPT_LIMITS &quot;</span>
				 <span class="s">&quot;expected %08x, was %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">old</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_RP_INTERRUPT_LIMITS</span><span class="p">,</span> <span class="n">limits</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gen6_gt_force_wake_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_sanitize_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">sanitize_pm</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">sanitize_pm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Starting with Haswell, we have different power wells for</span>
<span class="cm"> * different parts of the GPU. This attempts to enable them all.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_init_power_wells</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">power_wells</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">HSW_PWR_WELL_CTL1</span><span class="p">,</span>
		<span class="n">HSW_PWR_WELL_CTL2</span><span class="p">,</span>
		<span class="n">HSW_PWR_WELL_CTL4</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">power_wells</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">well</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">power_wells</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">well</span> <span class="o">&amp;</span> <span class="n">HSW_PWR_WELL_STATE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">power_wells</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">well</span> <span class="o">&amp;</span> <span class="n">HSW_PWR_WELL_ENABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">power_wells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">HSW_PWR_WELL_STATE</span><span class="p">),</span> <span class="mi">20</span><span class="p">))</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Error enabling power well %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">power_wells</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set up chip specific power management-related functions */</span>
<span class="kt">void</span> <span class="nf">intel_init_pm</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_FBC</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fbc_enabled</span> <span class="o">=</span> <span class="n">ironlake_fbc_enabled</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">enable_fbc</span> <span class="o">=</span> <span class="n">ironlake_enable_fbc</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">disable_fbc</span> <span class="o">=</span> <span class="n">ironlake_disable_fbc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GM45</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fbc_enabled</span> <span class="o">=</span> <span class="n">g4x_fbc_enabled</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">enable_fbc</span> <span class="o">=</span> <span class="n">g4x_enable_fbc</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">disable_fbc</span> <span class="o">=</span> <span class="n">g4x_disable_fbc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fbc_enabled</span> <span class="o">=</span> <span class="n">i8xx_fbc_enabled</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">enable_fbc</span> <span class="o">=</span> <span class="n">i8xx_enable_fbc</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">disable_fbc</span> <span class="o">=</span> <span class="n">i8xx_disable_fbc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* 855GM needs testing */</span>
	<span class="p">}</span>

	<span class="cm">/* For cxsr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">i915_pineview_get_mem_freq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">i915_ironlake_get_mem_freq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* For FIFO watermark updates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_get</span> <span class="o">=</span> <span class="n">__gen6_gt_force_wake_get</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_put</span> <span class="o">=</span> <span class="n">__gen6_gt_force_wake_put</span><span class="p">;</span>

		<span class="cm">/* IVB configs may use multi-threaded forcewake */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span>	<span class="n">ecobus</span><span class="p">;</span>

			<span class="cm">/* A small trick here - if the bios hasn&#39;t configured MT forcewake,</span>
<span class="cm">			 * and if the device is in RC6, then force_wake_mt_get will not wake</span>
<span class="cm">			 * the device and the ECOBUS read will return zero. Which will be</span>
<span class="cm">			 * (correctly) interpreted by the test below as MT forcewake being</span>
<span class="cm">			 * disabled.</span>
<span class="cm">			 */</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
			<span class="n">__gen6_gt_force_wake_mt_get</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
			<span class="n">ecobus</span> <span class="o">=</span> <span class="n">I915_READ_NOTRACE</span><span class="p">(</span><span class="n">ECOBUS</span><span class="p">);</span>
			<span class="n">__gen6_gt_force_wake_mt_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ecobus</span> <span class="o">&amp;</span> <span class="n">FORCEWAKE_MT_ENABLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Using MT version of forcewake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_get</span> <span class="o">=</span>
					<span class="n">__gen6_gt_force_wake_mt_get</span><span class="p">;</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_put</span> <span class="o">=</span>
					<span class="n">__gen6_gt_force_wake_mt_put</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_pch_clock_gating</span> <span class="o">=</span> <span class="n">ibx_init_clock_gating</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_pch_clock_gating</span> <span class="o">=</span> <span class="n">cpt_init_clock_gating</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">MLTR_ILK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ILK_SRLT_MASK</span><span class="p">)</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">ironlake_update_wm</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Failed to get proper latency. &quot;</span>
					      <span class="s">&quot;Disable CxSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">ironlake_init_clock_gating</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SNB_READ_WM0_LATENCY</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">sandybridge_update_wm</span><span class="p">;</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_sprite_wm</span> <span class="o">=</span> <span class="n">sandybridge_update_sprite_wm</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Failed to read display plane latency. &quot;</span>
					      <span class="s">&quot;Disable CxSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">gen6_init_clock_gating</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">sanitize_pm</span> <span class="o">=</span> <span class="n">gen6_sanitize_pm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* FIXME: detect B0+ stepping and use auto training */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SNB_READ_WM0_LATENCY</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">sandybridge_update_wm</span><span class="p">;</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_sprite_wm</span> <span class="o">=</span> <span class="n">sandybridge_update_sprite_wm</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Failed to read display plane latency. &quot;</span>
					      <span class="s">&quot;Disable CxSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">ivybridge_init_clock_gating</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">sanitize_pm</span> <span class="o">=</span> <span class="n">gen6_sanitize_pm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SNB_READ_WM0_LATENCY</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">sandybridge_update_wm</span><span class="p">;</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_sprite_wm</span> <span class="o">=</span> <span class="n">sandybridge_update_sprite_wm</span><span class="p">;</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_linetime_wm</span> <span class="o">=</span> <span class="n">haswell_update_linetime_wm</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Failed to read display plane latency. &quot;</span>
					      <span class="s">&quot;Disable CxSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">ivybridge_init_clock_gating</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">sanitize_pm</span> <span class="o">=</span> <span class="n">gen6_sanitize_pm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">valleyview_update_wm</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span>
			<span class="n">valleyview_init_clock_gating</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_get</span> <span class="o">=</span> <span class="n">vlv_force_wake_get</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_put</span> <span class="o">=</span> <span class="n">vlv_force_wake_put</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_get_cxsr_latency</span><span class="p">(</span><span class="n">IS_PINEVIEW_G</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
					    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">is_ddr3</span><span class="p">,</span>
					    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span><span class="p">,</span>
					    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;failed to find known CxSR latency &quot;</span>
				 <span class="s">&quot;(found ddr%s fsb freq %d, mem freq %d), &quot;</span>
				 <span class="s">&quot;disabling CxSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">is_ddr3</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;3&quot;</span> <span class="o">:</span> <span class="s">&quot;2&quot;</span><span class="p">,</span>
				 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fsb_freq</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mem_freq</span><span class="p">);</span>
			<span class="cm">/* Disable CxSR and never update its watermark again */</span>
			<span class="n">pineview_disable_cxsr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">pineview_update_wm</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">gen3_init_clock_gating</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">g4x_update_wm</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">g4x_init_clock_gating</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN4</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">i965_update_wm</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">crestline_init_clock_gating</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_BROADWATER</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">broadwater_init_clock_gating</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN3</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">i9xx_update_wm</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span> <span class="o">=</span> <span class="n">i9xx_get_fifo_size</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">gen3_init_clock_gating</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I865G</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">i830_update_wm</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">i85x_init_clock_gating</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span> <span class="o">=</span> <span class="n">i830_get_fifo_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I85X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">i9xx_update_wm</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span> <span class="o">=</span> <span class="n">i85x_get_fifo_size</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">i85x_init_clock_gating</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="n">i830_update_wm</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">init_clock_gating</span> <span class="o">=</span> <span class="n">i830_init_clock_gating</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_845G</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span> <span class="o">=</span> <span class="n">i845_get_fifo_size</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_fifo_size</span> <span class="o">=</span> <span class="n">i830_get_fifo_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We attempt to init the necessary power wells early in the initialization</span>
<span class="cm">	 * time, so the subsystems that expect power to be enabled can work.</span>
<span class="cm">	 */</span>
	<span class="n">intel_init_power_wells</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
