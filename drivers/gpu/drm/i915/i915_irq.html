<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › i915_irq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>i915_irq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* i915_irq.c -- IRQ support for the I915 -*- linux-c -*-</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright 2003 Tungsten Graphics, Inc., Cedar Park, Texas.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the</span>
<span class="cm"> * &quot;Software&quot;), to deal in the Software without restriction, including</span>
<span class="cm"> * without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="cm"> * distribute, sub license, and/or sell copies of the Software, and to</span>
<span class="cm"> * permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the</span>
<span class="cm"> * next paragraph) shall be included in all copies or substantial portions</span>
<span class="cm"> * of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm"> * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT.</span>
<span class="cm"> * IN NO EVENT SHALL TUNGSTEN GRAPHICS AND/OR ITS SUPPLIERS BE LIABLE FOR</span>
<span class="cm"> * ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span>
<span class="cm"> * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>
<span class="cm"> * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/sysrq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;i915_trace.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>

<span class="cm">/* For display hotplug interrupt */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ironlake_enable_display_irq</span><span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ironlake_disable_display_irq</span><span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_enable_pipestat</span><span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="cm">/* Enable the interrupt, clear any pending status */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_disable_pipestat</span><span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_enable_asle - enable ASLE interrupt for OpRegion</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_enable_asle</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="cm">/* FIXME: opregion/asle for VLV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ironlake_enable_display_irq</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">DE_GSE</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">i915_enable_pipestat</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="n">PIPE_LEGACY_BLC_EVENT_ENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">i915_enable_pipestat</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">PIPE_LEGACY_BLC_EVENT_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_pipe_enabled - check if a pipe is enabled</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @pipe: pipe to check</span>
<span class="cm"> *</span>
<span class="cm"> * Reading certain registers when the pipe is disabled can hang the chip.</span>
<span class="cm"> * Use this routine to make sure the PLL is running and the pipe is active</span>
<span class="cm"> * before reading such registers if unsure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i915_pipe_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PIPECONF_ENABLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called from drm generic code, passed a &#39;crtc&#39;, which</span>
<span class="cm"> * we use as a pipe index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">i915_get_vblank_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">high_frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">low_frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">high1</span><span class="p">,</span> <span class="n">high2</span><span class="p">,</span> <span class="n">low</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;trying to get vblank count for disabled &quot;</span>
				<span class="s">&quot;pipe %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">high_frame</span> <span class="o">=</span> <span class="n">PIPEFRAME</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">low_frame</span> <span class="o">=</span> <span class="n">PIPEFRAMEPIXEL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * High &amp; low register fields aren&#39;t synchronized, so make sure</span>
<span class="cm">	 * we get a low value that&#39;s stable across two reads of the high</span>
<span class="cm">	 * register.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">high1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">high_frame</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PIPE_FRAME_HIGH_MASK</span><span class="p">;</span>
		<span class="n">low</span>   <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">low_frame</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="n">PIPE_FRAME_LOW_MASK</span><span class="p">;</span>
		<span class="n">high2</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">high_frame</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PIPE_FRAME_HIGH_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">high1</span> <span class="o">!=</span> <span class="n">high2</span><span class="p">);</span>

	<span class="n">high1</span> <span class="o">&gt;&gt;=</span> <span class="n">PIPE_FRAME_HIGH_SHIFT</span><span class="p">;</span>
	<span class="n">low</span> <span class="o">&gt;&gt;=</span> <span class="n">PIPE_FRAME_LOW_SHIFT</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">high1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">gm45_get_vblank_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPE_FRMCOUNT_GM45</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;trying to get vblank count for disabled &quot;</span>
				 <span class="s">&quot;pipe %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_get_crtc_scanoutpos</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">vpos</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hpos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vbl_start</span><span class="p">,</span> <span class="n">vbl_end</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">vtotal</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">in_vbl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;trying to get scanoutpos for disabled &quot;</span>
				 <span class="s">&quot;pipe %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get vtotal. */</span>
	<span class="n">vtotal</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">VTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No obvious pixelcount register. Only query vertical</span>
<span class="cm">		 * scanout position from Display scan line register.</span>
<span class="cm">		 */</span>
		<span class="n">position</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPEDSL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

		<span class="cm">/* Decode into vertical scanout position. Don&#39;t have</span>
<span class="cm">		 * horizontal scanout position.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">vpos</span> <span class="o">=</span> <span class="n">position</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">hpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Have access to pixelcount since start of frame.</span>
<span class="cm">		 * We can split this into vertical and horizontal</span>
<span class="cm">		 * scanout position.</span>
<span class="cm">		 */</span>
		<span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPEFRAMEPIXEL</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PIPE_PIXEL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PIPE_PIXEL_SHIFT</span><span class="p">;</span>

		<span class="n">htotal</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">HTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>
		<span class="o">*</span><span class="n">vpos</span> <span class="o">=</span> <span class="n">position</span> <span class="o">/</span> <span class="n">htotal</span><span class="p">;</span>
		<span class="o">*</span><span class="n">hpos</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="p">(</span><span class="o">*</span><span class="n">vpos</span> <span class="o">*</span> <span class="n">htotal</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Query vblank area. */</span>
	<span class="n">vbl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="cm">/* Test position against vblank region. */</span>
	<span class="n">vbl_start</span> <span class="o">=</span> <span class="n">vbl</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
	<span class="n">vbl_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">vbl</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">vpos</span> <span class="o">&lt;</span> <span class="n">vbl_start</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">vpos</span> <span class="o">&gt;</span> <span class="n">vbl_end</span><span class="p">))</span>
		<span class="n">in_vbl</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Inside &quot;upper part&quot; of vblank area? Apply corrective offset: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_vbl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">vpos</span> <span class="o">&gt;=</span> <span class="n">vbl_start</span><span class="p">))</span>
		<span class="o">*</span><span class="n">vpos</span> <span class="o">=</span> <span class="o">*</span><span class="n">vpos</span> <span class="o">-</span> <span class="n">vtotal</span><span class="p">;</span>

	<span class="cm">/* Readouts valid? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vbl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">DRM_SCANOUTPOS_VALID</span> <span class="o">|</span> <span class="n">DRM_SCANOUTPOS_ACCURATE</span><span class="p">;</span>

	<span class="cm">/* In vblank? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_vbl</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">DRM_SCANOUTPOS_INVBL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_get_vblank_timestamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">max_error</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">vblank_time</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">&gt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get drm_crtc to timestamp: */</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_get_crtc_for_pipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Invalid crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;crtc %d is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Helper routine in DRM core does all the work: */</span>
	<span class="k">return</span> <span class="n">drm_calc_vbltimestamp_from_scanoutpos</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">max_error</span><span class="p">,</span>
						     <span class="n">vblank_time</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
						     <span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle hotplug events outside the interrupt handler proper.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_hotplug_work_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">drm_i915_private_t</span><span class="p">,</span>
						    <span class="n">hotplug_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;running encoder hotplug functions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">hot_plug</span><span class="p">)</span>
			<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">hot_plug</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Just fire off a uevent and let userspace tell us what to do */</span>
	<span class="n">drm_helper_hpd_irq_event</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_handle_rps_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">busy_up</span><span class="p">,</span> <span class="n">busy_down</span><span class="p">,</span> <span class="n">max_avg</span><span class="p">,</span> <span class="n">min_avg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span><span class="p">;</span>

	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">MEMINTRSTS</span><span class="p">,</span> <span class="n">MEMINT_EVAL_CHG</span><span class="p">);</span>
	<span class="n">busy_up</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RCPREVBSYTUPAVG</span><span class="p">);</span>
	<span class="n">busy_down</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RCPREVBSYTDNAVG</span><span class="p">);</span>
	<span class="n">max_avg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RCBMAXAVG</span><span class="p">);</span>
	<span class="n">min_avg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RCBMINAVG</span><span class="p">);</span>

	<span class="cm">/* Handle RCS change request from hw */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">busy_up</span> <span class="o">&gt;</span> <span class="n">max_avg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">!=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">)</span>
			<span class="n">new_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_delay</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">)</span>
			<span class="n">new_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">busy_down</span> <span class="o">&lt;</span> <span class="n">min_avg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">!=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">)</span>
			<span class="n">new_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_delay</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">)</span>
			<span class="n">new_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ironlake_set_drps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">new_delay</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">=</span> <span class="n">new_delay</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">notify_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">trace_i915_gem_request_complete</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">));</span>

	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i915_enable_hangcheck</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_timer</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">DRM_I915_HANGCHECK_PERIOD</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen6_pm_rps_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">drm_i915_private_t</span><span class="p">,</span>
						    <span class="n">rps_work</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pm_iir</span><span class="p">,</span> <span class="n">pm_imr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_delay</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">);</span>
	<span class="n">pm_iir</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pm_iir</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pm_iir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pm_imr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIMR</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pm_iir</span> <span class="o">&amp;</span> <span class="n">GEN6_PM_DEFERRED_EVENTS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_iir</span> <span class="o">&amp;</span> <span class="n">GEN6_PM_RP_UP_THRESHOLD</span><span class="p">)</span>
		<span class="n">new_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_delay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cur_delay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">gen6_set_rps</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">new_delay</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snb_gt_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">gt_iir</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GEN6_RENDER_USER_INTERRUPT</span> <span class="o">|</span>
		      <span class="n">GEN6_RENDER_PIPE_CONTROL_NOTIFY_INTERRUPT</span><span class="p">))</span>
		<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span> <span class="o">&amp;</span> <span class="n">GEN6_BSD_USER_INTERRUPT</span><span class="p">)</span>
		<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">VCS</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span> <span class="o">&amp;</span> <span class="n">GEN6_BLITTER_USER_INTERRUPT</span><span class="p">)</span>
		<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">BCS</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GT_GEN6_BLT_CS_ERROR_INTERRUPT</span> <span class="o">|</span>
		      <span class="n">GT_GEN6_BSD_CS_ERROR_INTERRUPT</span> <span class="o">|</span>
		      <span class="n">GT_RENDER_CS_ERROR_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;GT error interrupt 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>
		<span class="n">i915_handle_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen6_queue_rps_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">pm_iir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * IIR bits should never already be set because IMR should</span>
<span class="cm">	 * prevent an interrupt from being shown in IIR. The warning</span>
<span class="cm">	 * displays a case where we&#39;ve unsafely cleared</span>
<span class="cm">	 * dev_priv-&gt;pm_iir. Although missing an interrupt of the same</span>
<span class="cm">	 * type is not a problem, it displays a problem in the logic.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The mask bit in IMR is cleared by rps_work.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pm_iir</span> <span class="o">|=</span> <span class="n">pm_iir</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pm_iir</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">GEN6_PMIMR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">valleyview_irq_handler</span><span class="p">(</span><span class="n">DRM_IRQ_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iir</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="n">I915_MAX_PIPES</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">vblank_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vblank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">blc_event</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">);</span>

	<span class="n">vblank_status</span> <span class="o">=</span> <span class="n">PIPE_START_VBLANK_INTERRUPT_STATUS</span> <span class="o">|</span>
		<span class="n">PIPE_VBLANK_INTERRUPT_STATUS</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">);</span>
		<span class="n">gt_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">);</span>
		<span class="n">pm_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pm_iir</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">iir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="n">snb_gt_irq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Clear the PIPE*STAT regs before the IIR</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000ffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_FIFO_UNDERRUN_STATUS</span><span class="p">)</span>
					<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;pipe %c underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

		<span class="cm">/* Consume port.  Then clear IIR or we&#39;ll miss events */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">hotplug_status</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">);</span>

			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;hotplug event received, stat 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">hotplug_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_status</span> <span class="o">&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span><span class="p">)</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_work</span><span class="p">);</span>

			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">hotplug_status</span><span class="p">);</span>
			<span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">);</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PIPE_A_VBLANK_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">vblank</span><span class="o">++</span><span class="p">;</span>
			<span class="n">intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PIPE_B_VBLANK_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">vblank</span><span class="o">++</span><span class="p">;</span>
			<span class="n">intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_LEGACY_BLC_EVENT_STATUS</span><span class="p">)</span>
			<span class="n">blc_event</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pm_iir</span> <span class="o">&amp;</span> <span class="n">GEN6_PM_DEFERRED_EVENTS</span><span class="p">)</span>
			<span class="n">gen6_queue_rps_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">);</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">,</span> <span class="n">iir</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ibx_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pch_iir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_POWER_MASK</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH audio power change on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_POWER_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				 <span class="n">SDE_AUDIO_POWER_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_GMBUS</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH GMBUS interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_HDCP_MASK</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH HDCP audio interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_TRANS_MASK</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH transcoder audio interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_POISON</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;PCH poison interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_FDI_MASK</span><span class="p">)</span>
		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;  pipe %c FDI IIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
					 <span class="n">I915_READ</span><span class="p">(</span><span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDE_TRANSB_CRC_DONE</span> <span class="o">|</span> <span class="n">SDE_TRANSA_CRC_DONE</span><span class="p">))</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH transcoder CRC done interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SDE_TRANSB_CRC_ERR</span> <span class="o">|</span> <span class="n">SDE_TRANSA_CRC_ERR</span><span class="p">))</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH transcoder CRC error interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_TRANSB_FIFO_UNDER</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH transcoder B underrun interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_TRANSA_FIFO_UNDER</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH transcoder A underrun interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpt_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pch_iir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_POWER_MASK_CPT</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH audio power change on port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_POWER_MASK_CPT</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				 <span class="n">SDE_AUDIO_POWER_SHIFT_CPT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUX_MASK_CPT</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;AUX channel interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_GMBUS_CPT</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;PCH GMBUS interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_CP_REQ_CPT</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Audio CP request interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_AUDIO_CP_CHG_CPT</span><span class="p">)</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Audio CP change interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_FDI_MASK_CPT</span><span class="p">)</span>
		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;  pipe %c FDI IIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
					 <span class="n">I915_READ</span><span class="p">(</span><span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ivybridge_irq_handler</span><span class="p">(</span><span class="n">DRM_IRQ_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">de_iir</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">,</span> <span class="n">de_ier</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">);</span>

	<span class="cm">/* disable master interrupt before clearing iir  */</span>
	<span class="n">de_ier</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="n">de_ier</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DE_MASTER_IRQ_CONTROL</span><span class="p">);</span>

	<span class="n">gt_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snb_gt_irq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">de_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_GSE_IVB</span><span class="p">)</span>
			<span class="n">intel_opregion_gse_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DE_PLANEA_FLIP_DONE_IVB</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">intel_finish_page_flip_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DE_PIPEA_VBLANK_IVB</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">i</span><span class="p">)))</span>
				<span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* check event from PCH */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_PCH_EVENT_IVB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">pch_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">SDE_HOTPLUG_MASK_CPT</span><span class="p">)</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_work</span><span class="p">);</span>
			<span class="n">cpt_irq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pch_iir</span><span class="p">);</span>

			<span class="cm">/* clear PCH hotplug event before clear CPU irq */</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">,</span> <span class="n">pch_iir</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">,</span> <span class="n">de_iir</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_iir</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm_iir</span> <span class="o">&amp;</span> <span class="n">GEN6_PM_DEFERRED_EVENTS</span><span class="p">)</span>
			<span class="n">gen6_queue_rps_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="n">de_ier</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ilk_gt_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">gt_iir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GT_USER_INTERRUPT</span> <span class="o">|</span> <span class="n">GT_PIPE_NOTIFY</span><span class="p">))</span>
		<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gt_iir</span> <span class="o">&amp;</span> <span class="n">GT_BSD_USER_INTERRUPT</span><span class="p">)</span>
		<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">VCS</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ironlake_irq_handler</span><span class="p">(</span><span class="n">DRM_IRQ_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">de_iir</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">,</span> <span class="n">de_ier</span><span class="p">,</span> <span class="n">pch_iir</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotplug_mask</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">);</span>

	<span class="cm">/* disable master interrupt before clearing iir  */</span>
	<span class="n">de_ier</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="n">de_ier</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DE_MASTER_IRQ_CONTROL</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>

	<span class="n">de_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">);</span>
	<span class="n">gt_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">);</span>
	<span class="n">pch_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">);</span>
	<span class="n">pm_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">gt_iir</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pch_iir</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">pm_iir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="n">SDE_HOTPLUG_MASK_CPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="n">SDE_HOTPLUG_MASK</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ilk_gt_irq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snb_gt_irq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_GSE</span><span class="p">)</span>
		<span class="n">intel_opregion_gse_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_PLANEA_FLIP_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">intel_finish_page_flip_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_PLANEB_FLIP_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">intel_finish_page_flip_plane</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_PIPEA_VBLANK</span><span class="p">)</span>
		<span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_PIPEB_VBLANK</span><span class="p">)</span>
		<span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* check event from PCH */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_PCH_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pch_iir</span> <span class="o">&amp;</span> <span class="n">hotplug_mask</span><span class="p">)</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">cpt_irq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pch_iir</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ibx_irq_handler</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pch_iir</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">de_iir</span> <span class="o">&amp;</span> <span class="n">DE_PCU_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">MEMINTRSTS</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">MEMINTRSTS</span><span class="p">));</span>
		<span class="n">i915_handle_rps_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pm_iir</span> <span class="o">&amp;</span> <span class="n">GEN6_PM_DEFERRED_EVENTS</span><span class="p">)</span>
		<span class="n">gen6_queue_rps_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">);</span>

	<span class="cm">/* should clear PCH hotplug event before clear CPU irq */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">,</span> <span class="n">pch_iir</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">gt_iir</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">,</span> <span class="n">de_iir</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">,</span> <span class="n">pm_iir</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="n">de_ier</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_error_work_func - do process context error handling work</span>
<span class="cm"> * @work: work struct</span>
<span class="cm"> *</span>
<span class="cm"> * Fire an error uevent so userspace can see that a hang or error</span>
<span class="cm"> * was detected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_error_work_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">drm_i915_private_t</span><span class="p">,</span>
						    <span class="n">error_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">error_event</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ERROR=1&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reset_event</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;RESET=1&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">reset_done_event</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ERROR=0&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="n">kobject_uevent_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">kdev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">error_event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;resetting chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kobject_uevent_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">kdev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">reset_event</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">kobject_uevent_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">kdev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">,</span> <span class="n">reset_done_event</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_completion</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_i915_error_object</span> <span class="o">*</span>
<span class="nf">i915_error_object_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_error_object</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">page_count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reloc_offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">page_count</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dst</span><span class="p">)</span> <span class="o">+</span> <span class="n">page_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">reloc_offset</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">page_count</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unwind</span><span class="p">;</span>

		<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reloc_offset</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mappable_end</span> <span class="o">&amp;&amp;</span>
		    <span class="n">src</span><span class="o">-&gt;</span><span class="n">has_global_gtt_mapping</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

			<span class="cm">/* Simply ignore tiling or any overlapping fence.</span>
<span class="cm">			 * It&#39;s part of the error state, and this hopefully</span>
<span class="cm">			 * captures what the GPU read.</span>
<span class="cm">			 */</span>

			<span class="n">s</span> <span class="o">=</span> <span class="n">io_mapping_map_atomic_wc</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span><span class="p">,</span>
						     <span class="n">reloc_offset</span><span class="p">);</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="n">io_mapping_unmap_atomic</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

			<span class="n">drm_clflush_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

			<span class="n">s</span> <span class="o">=</span> <span class="n">kmap_atomic</span><span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">]);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="n">kunmap_atomic</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

			<span class="n">drm_clflush_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

		<span class="n">reloc_offset</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">page_count</span><span class="p">;</span>
	<span class="n">dst</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>

<span class="nl">unwind:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">page</span><span class="o">--</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_error_object_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_error_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">i915_error_state_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">error_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">error_ref</span><span class="p">,</span>
							  <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="p">),</span> <span class="n">ref</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_error_object_free</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">batchbuffer</span><span class="p">);</span>
		<span class="n">i915_error_object_free</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ringbuffer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requests</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">capture_bo</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_error_buffer</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">read_domains</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">write_domain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">pinned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="o">-&gt;</span><span class="n">pinned</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">user_pin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span><span class="o">-&gt;</span><span class="n">pinned</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">tiling</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">purgeable</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">!=</span> <span class="n">I915_MADV_WILLNEED</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">?</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span><span class="o">-&gt;</span><span class="n">cache_level</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">capture_active_bo</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_error_buffer</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">mm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">capture_bo</span><span class="p">(</span><span class="n">err</span><span class="o">++</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">capture_pinned_bo</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_error_buffer</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">gtt_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">capture_bo</span><span class="p">(</span><span class="n">err</span><span class="o">++</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_record_fences</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Fences */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">7</span>:
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ64</span><span class="p">(</span><span class="n">FENCE_REG_SANDYBRIDGE_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ64</span><span class="p">(</span><span class="n">FENCE_REG_965_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_G33</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">error</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FENCE_REG_945_8</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FENCE_REG_830_0</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_i915_error_object</span> <span class="o">*</span>
<span class="nf">i915_error_first_batchbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">seqno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">seqno</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">,</span> <span class="n">mm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">!=</span> <span class="n">ring</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i915_seqno_passed</span><span class="p">(</span><span class="n">seqno</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span> <span class="o">&amp;</span> <span class="n">I915_GEM_DOMAIN_COMMAND</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* We need to copy these to an anonymous buffer as the simplest</span>
<span class="cm">		 * method to avoid being overwritten by userspace.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">i915_error_object_create</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_record_ring_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">fault_reg</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_FAULT_REG</span><span class="p">(</span><span class="n">ring</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">semaphore_mboxes</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_SYNC_0</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">semaphore_mboxes</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			<span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_SYNC_1</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">faddr</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_DMA_FADD</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ipeir</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_IPEIR</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ipehr</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_IPEHR</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">instdone</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_INSTDONE</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">instps</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_INSTPS</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">RCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">instdone1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE1</span><span class="p">);</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">bbaddr</span> <span class="o">=</span> <span class="n">I915_READ64</span><span class="p">(</span><span class="n">BB_ADDR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">faddr</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DMA_FADD_I8XX</span><span class="p">);</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ipeir</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEIR</span><span class="p">);</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ipehr</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEHR</span><span class="p">);</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">instdone</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">error</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">instpm</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_INSTPM</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">));</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">acthd</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">intel_ring_get_active_head</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ_HEAD</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ_TAIL</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="n">error</span><span class="o">-&gt;</span><span class="n">cpu_ring_head</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">cpu_ring_tail</span><span class="p">[</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_gem_record_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_record_ring_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">batchbuffer</span> <span class="o">=</span>
			<span class="n">i915_error_first_batchbuffer</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>

		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ringbuffer</span> <span class="o">=</span>
			<span class="n">i915_error_object_create</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_requests</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requests</span> <span class="o">=</span>
			<span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_error_request</span><span class="p">),</span>
				<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requests</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_requests</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_i915_error_request</span> <span class="o">*</span><span class="n">erq</span><span class="p">;</span>

			<span class="n">erq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requests</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">];</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">emitted_jiffies</span><span class="p">;</span>
			<span class="n">erq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_capture_error_state - capture an error record for later analysis</span>
<span class="cm"> * @dev: drm device</span>
<span class="cm"> *</span>
<span class="cm"> * Should be called when an error is detected (either a hang or an error</span>
<span class="cm"> * interrupt) to capture error state from the time of the error.  Fills</span>
<span class="cm"> * out a structure which becomes available in debugfs for user level tools</span>
<span class="cm"> * to pick up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_capture_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">first_error</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Account for pipe specific data like PIPE*STAT */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;out of memory, not capturing error state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;capturing error event; look for more information in /debug/dri/%d/i915_error_state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">eir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">EIR</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">pgtbl_er</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">)</span> <span class="o">|</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">)</span> <span class="o">|</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ERROR_GEN6</span><span class="p">);</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">done_reg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DONE_REG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i915_gem_record_fences</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
	<span class="n">i915_gem_record_rings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="cm">/* Record buffers on the active and pinned lists. */</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">,</span> <span class="n">mm_list</span><span class="p">)</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo_count</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">,</span> <span class="n">gtt_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span><span class="p">)</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo_count</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo_count</span><span class="p">;</span>

	<span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">,</span>
					   <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span><span class="p">)</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo</span> <span class="o">=</span>
				<span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span> <span class="o">+</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span><span class="p">)</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo_count</span> <span class="o">=</span>
			<span class="n">capture_active_bo</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span><span class="p">,</span>
					  <span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo_count</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo</span><span class="p">)</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo_count</span> <span class="o">=</span>
			<span class="n">capture_pinned_bo</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo</span><span class="p">,</span>
					  <span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo_count</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">);</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>

	<span class="n">error</span><span class="o">-&gt;</span><span class="n">overlay</span> <span class="o">=</span> <span class="n">intel_overlay_capture_error_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">display</span> <span class="o">=</span> <span class="n">intel_display_capture_error_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">first_error</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">first_error</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">i915_error_state_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_destroy_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">first_error</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">first_error</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">i915_error_state_free</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define i915_capture_error_state(x)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_report_and_clear_eir</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">EIR</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;render error detected, EIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eir</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GM45_ERROR_MEM_PRIV</span> <span class="o">|</span> <span class="n">GM45_ERROR_CP_PRIV</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ipeir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">);</span>

			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  IPEIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  IPEHR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEHR_I965</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTDONE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE_I965</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTPS: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTPS</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTDONE1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE1</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  ACTHD: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ACTHD_I965</span><span class="p">));</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">,</span> <span class="n">ipeir</span><span class="p">);</span>
			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eir</span> <span class="o">&amp;</span> <span class="n">GM45_ERROR_PAGE_TABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">pgtbl_err</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;page table error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  PGTBL_ER: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pgtbl_err</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">,</span> <span class="n">pgtbl_err</span><span class="p">);</span>
			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eir</span> <span class="o">&amp;</span> <span class="n">I915_ERROR_PAGE_TABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">pgtbl_err</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;page table error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  PGTBL_ER: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pgtbl_err</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">,</span> <span class="n">pgtbl_err</span><span class="p">);</span>
			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PGTBL_ER</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eir</span> <span class="o">&amp;</span> <span class="n">I915_ERROR_MEMORY_REFRESH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;memory refresh error:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;pipe %c stat: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
		<span class="cm">/* pipestat has already been acked */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eir</span> <span class="o">&amp;</span> <span class="n">I915_ERROR_INSTRUCTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;instruction error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTPM: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ipeir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEIR</span><span class="p">);</span>

			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  IPEIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEIR</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  IPEHR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEHR</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTDONE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  ACTHD: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ACTHD</span><span class="p">));</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IPEIR</span><span class="p">,</span> <span class="n">ipeir</span><span class="p">);</span>
			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">IPEIR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">ipeir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">);</span>

			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  IPEIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  IPEHR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IPEHR_I965</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTDONE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE_I965</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTPS: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTPS</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  INSTDONE1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE1</span><span class="p">));</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;  ACTHD: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ACTHD_I965</span><span class="p">));</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">,</span> <span class="n">ipeir</span><span class="p">);</span>
			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">IPEIR_I965</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EIR</span><span class="p">,</span> <span class="n">eir</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">EIR</span><span class="p">);</span>
	<span class="n">eir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">EIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eir</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * some errors might have become stuck,</span>
<span class="cm">		 * mask them.</span>
<span class="cm">		 */</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;EIR stuck: 0x%08x, masking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eir</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EMR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">EMR</span><span class="p">)</span> <span class="o">|</span> <span class="n">eir</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_handle_error - handle an error interrupt</span>
<span class="cm"> * @dev: drm device</span>
<span class="cm"> *</span>
<span class="cm"> * Do some basic checking of regsiter state at error interrupt time and</span>
<span class="cm"> * dump it to the syslog.  Also call i915_capture_error_state() to make</span>
<span class="cm"> * sure we get a record and make it available in debugfs.  Fire a uevent</span>
<span class="cm"> * so userspace knows something bad happened (should trigger collection</span>
<span class="cm"> * of a ring dump etc.).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i915_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wedged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i915_capture_error_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">i915_report_and_clear_eir</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wedged</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_completion</span><span class="p">);</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Wakeup waiting processes so they don&#39;t hang</span>
<span class="cm">		 */</span>
		<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
			<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_pageflip_stall_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_unpin_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">stall_detected</span><span class="p">;</span>

	<span class="cm">/* Ignore early vblank irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">work</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">||</span> <span class="o">!</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">enable_stall_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Either the pending flip IRQ arrived, or we&#39;re too early. Don&#39;t check */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Potential stall - if we see that the flip has happened, assume a missed interrupt */</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">pending_flip_obj</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dspsurf</span> <span class="o">=</span> <span class="n">DSPSURF</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
		<span class="n">stall_detected</span> <span class="o">=</span> <span class="n">I915_HI_DISPBASE</span><span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">dspsurf</span><span class="p">))</span> <span class="o">==</span>
					<span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dspaddr</span> <span class="o">=</span> <span class="n">DSPADDR</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
		<span class="n">stall_detected</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dspaddr</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span>
							<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
							<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stall_detected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Pageflip stall detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Called from drm generic code, passed &#39;crtc&#39; which</span>
<span class="cm"> * we use as a pipe index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_enable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">i915_enable_pipestat</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				     <span class="n">PIPE_START_VBLANK_INTERRUPT_ENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">i915_enable_pipestat</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
				     <span class="n">PIPE_VBLANK_INTERRUPT_ENABLE</span><span class="p">);</span>

	<span class="cm">/* maintain vblank delivery even in deep C-states */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">,</span> <span class="n">_MASKED_BIT_DISABLE</span><span class="p">(</span><span class="n">INSTPM_AGPBUSY_DIS</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ironlake_enable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">ironlake_enable_display_irq</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				    <span class="n">DE_PIPEA_VBLANK</span> <span class="o">:</span> <span class="n">DE_PIPEB_VBLANK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivybridge_enable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">ironlake_enable_display_irq</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
				    <span class="n">DE_PIPEA_VBLANK_IVB</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">pipe</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">valleyview_enable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpfl</span><span class="p">,</span> <span class="n">imr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_pipe_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">dpfl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_DPFLIPSTAT</span><span class="p">);</span>
	<span class="n">imr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpfl</span> <span class="o">|=</span> <span class="n">PIPEA_VBLANK_INT_EN</span><span class="p">;</span>
		<span class="n">imr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_DISPLAY_PIPE_A_VBLANK_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpfl</span> <span class="o">|=</span> <span class="n">PIPEA_VBLANK_INT_EN</span><span class="p">;</span>
		<span class="n">imr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_DISPLAY_PIPE_B_VBLANK_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_DPFLIPSTAT</span><span class="p">,</span> <span class="n">dpfl</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">,</span> <span class="n">imr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called from drm generic code, passed &#39;crtc&#39; which</span>
<span class="cm"> * we use as a pipe index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_disable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">,</span> <span class="n">_MASKED_BIT_ENABLE</span><span class="p">(</span><span class="n">INSTPM_AGPBUSY_DIS</span><span class="p">));</span>

	<span class="n">i915_disable_pipestat</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span>
			      <span class="n">PIPE_VBLANK_INTERRUPT_ENABLE</span> <span class="o">|</span>
			      <span class="n">PIPE_START_VBLANK_INTERRUPT_ENABLE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_disable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">ironlake_disable_display_irq</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				     <span class="n">DE_PIPEA_VBLANK</span> <span class="o">:</span> <span class="n">DE_PIPEB_VBLANK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivybridge_disable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">ironlake_disable_display_irq</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
				     <span class="n">DE_PIPEA_VBLANK_IVB</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">valleyview_disable_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpfl</span><span class="p">,</span> <span class="n">imr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">dpfl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_DPFLIPSTAT</span><span class="p">);</span>
	<span class="n">imr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpfl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPEA_VBLANK_INT_EN</span><span class="p">;</span>
		<span class="n">imr</span> <span class="o">|=</span> <span class="n">I915_DISPLAY_PIPE_A_VBLANK_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpfl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPEB_VBLANK_INT_EN</span><span class="p">;</span>
		<span class="n">imr</span> <span class="o">|=</span> <span class="n">I915_DISPLAY_PIPE_B_VBLANK_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">,</span> <span class="n">imr</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_DPFLIPSTAT</span><span class="p">,</span> <span class="n">dpfl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">ring_last_seqno</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_i915_gem_request</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">i915_hangcheck_ring_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">request_list</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">i915_seqno_passed</span><span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">),</span> <span class="n">ring_last_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Issue a wake-up to catch stuck h/w. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Hangcheck timer elapsed... %s idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">);</span>
			<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">kick_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">I915_READ_CTL</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">RING_WAIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Kicking stuck wait on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">I915_WRITE_CTL</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">i915_hangcheck_hung</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">hung</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Hangcheck timer elapsed... GPU hung</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">i915_handle_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* Is the chip hanging on a WAIT_FOR_EVENT?</span>
<span class="cm">			 * If so we can simply poke the RB_WAIT bit</span>
<span class="cm">			 * and break the hang. This should work on</span>
<span class="cm">			 * all but the second generation chipsets.</span>
<span class="cm">			 */</span>
			<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">hung</span> <span class="o">&amp;=</span> <span class="o">!</span><span class="n">kick_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">hung</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This is called when the chip hasn&#39;t reported back with completed</span>
<span class="cm"> * batchbuffers in a long time. The first time this is called we simply record</span>
<span class="cm"> * ACTHD. If ACTHD hasn&#39;t changed by the time the hangcheck timer elapses</span>
<span class="cm"> * again, we assume the chip is wedged and try to fix it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i915_hangcheck_elapsed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">acthd</span><span class="p">[</span><span class="n">I915_NUM_RINGS</span><span class="p">],</span> <span class="n">instdone</span><span class="p">,</span> <span class="n">instdone1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">err</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">idle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_enable_hangcheck</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">acthd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acthd</span><span class="p">));</span>
	<span class="n">idle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">idle</span> <span class="o">&amp;=</span> <span class="n">i915_hangcheck_ring_idle</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	    <span class="n">acthd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">intel_ring_get_active_head</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If all work is done then ACTHD clearly hasn&#39;t advanced. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i915_hangcheck_hung</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">instdone</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE</span><span class="p">);</span>
		<span class="n">instdone1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">instdone</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE_I965</span><span class="p">);</span>
		<span class="n">instdone1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTDONE1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_acthd</span><span class="p">,</span> <span class="n">acthd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acthd</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_instdone</span> <span class="o">==</span> <span class="n">instdone</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_instdone1</span> <span class="o">==</span> <span class="n">instdone1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i915_hangcheck_hung</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_acthd</span><span class="p">,</span> <span class="n">acthd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acthd</span><span class="p">));</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_instdone</span> <span class="o">=</span> <span class="n">instdone</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">last_instdone1</span> <span class="o">=</span> <span class="n">instdone1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">repeat:</span>
	<span class="cm">/* Reset timer case chip hangs without another request being added */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">DRM_I915_HANGCHECK_PERIOD</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* drm_dma.h hooks</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_irq_preinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xeffe</span><span class="p">);</span>

	<span class="cm">/* XXX hotplug from PCH */</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>

	<span class="cm">/* and GT */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">);</span>

	<span class="cm">/* south display irq */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">valleyview_irq_preinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* VLV magic */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RING_IMR</span><span class="p">(</span><span class="n">RENDER_RING_BASE</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RING_IMR</span><span class="p">(</span><span class="n">GEN6_BSD_RING_BASE</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">RING_IMR</span><span class="p">(</span><span class="n">BLT_RING_BASE</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* and GT */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPINVGTT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">));</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable digital hotplug on the PCH, and configure the DP short pulse</span>
<span class="cm"> * duration to 2ms (which is the minimum in the Display Port spec)</span>
<span class="cm"> *</span>
<span class="cm"> * This register is the same on all known PCH chips.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_enable_pch_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">hotplug</span><span class="p">;</span>

	<span class="n">hotplug</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PORT_HOTPLUG</span><span class="p">);</span>
	<span class="n">hotplug</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORTD_PULSE_DURATION_MASK</span><span class="o">|</span><span class="n">PORTC_PULSE_DURATION_MASK</span><span class="o">|</span><span class="n">PORTB_PULSE_DURATION_MASK</span><span class="p">);</span>
	<span class="n">hotplug</span> <span class="o">|=</span> <span class="n">PORTD_HOTPLUG_ENABLE</span> <span class="o">|</span> <span class="n">PORTD_PULSE_DURATION_2ms</span><span class="p">;</span>
	<span class="n">hotplug</span> <span class="o">|=</span> <span class="n">PORTC_HOTPLUG_ENABLE</span> <span class="o">|</span> <span class="n">PORTC_PULSE_DURATION_2ms</span><span class="p">;</span>
	<span class="n">hotplug</span> <span class="o">|=</span> <span class="n">PORTB_HOTPLUG_ENABLE</span> <span class="o">|</span> <span class="n">PORTB_PULSE_DURATION_2ms</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PORT_HOTPLUG</span><span class="p">,</span> <span class="n">hotplug</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ironlake_irq_postinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="cm">/* enable kind of interrupts always enabled */</span>
	<span class="n">u32</span> <span class="n">display_mask</span> <span class="o">=</span> <span class="n">DE_MASTER_IRQ_CONTROL</span> <span class="o">|</span> <span class="n">DE_GSE</span> <span class="o">|</span> <span class="n">DE_PCH_EVENT</span> <span class="o">|</span>
			   <span class="n">DE_PLANEA_FLIP_DONE</span> <span class="o">|</span> <span class="n">DE_PLANEB_FLIP_DONE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">render_irqs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotplug_mask</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">display_mask</span><span class="p">;</span>

	<span class="cm">/* should always can generate irq */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="n">display_mask</span> <span class="o">|</span> <span class="n">DE_PIPEA_VBLANK</span> <span class="o">|</span> <span class="n">DE_PIPEB_VBLANK</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_irq_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">render_irqs</span> <span class="o">=</span>
			<span class="n">GT_USER_INTERRUPT</span> <span class="o">|</span>
			<span class="n">GEN6_BSD_USER_INTERRUPT</span> <span class="o">|</span>
			<span class="n">GEN6_BLITTER_USER_INTERRUPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">render_irqs</span> <span class="o">=</span>
			<span class="n">GT_USER_INTERRUPT</span> <span class="o">|</span>
			<span class="n">GT_PIPE_NOTIFY</span> <span class="o">|</span>
			<span class="n">GT_BSD_USER_INTERRUPT</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIER</span><span class="p">,</span> <span class="n">render_irqs</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDE_CRT_HOTPLUG_CPT</span> <span class="o">|</span>
				<span class="n">SDE_PORTB_HOTPLUG_CPT</span> <span class="o">|</span>
				<span class="n">SDE_PORTC_HOTPLUG_CPT</span> <span class="o">|</span>
				<span class="n">SDE_PORTD_HOTPLUG_CPT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDE_CRT_HOTPLUG</span> <span class="o">|</span>
				<span class="n">SDE_PORTB_HOTPLUG</span> <span class="o">|</span>
				<span class="n">SDE_PORTC_HOTPLUG</span> <span class="o">|</span>
				<span class="n">SDE_PORTD_HOTPLUG</span> <span class="o">|</span>
				<span class="n">SDE_AUX_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">hotplug_mask</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_irq_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">,</span> <span class="n">hotplug_mask</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">);</span>

	<span class="n">ironlake_enable_pch_hotplug</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IRONLAKE_M</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Clear &amp; enable PCU event interrupts */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">,</span> <span class="n">DE_PCU_EVENT</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">)</span> <span class="o">|</span> <span class="n">DE_PCU_EVENT</span><span class="p">);</span>
		<span class="n">ironlake_enable_display_irq</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">DE_PCU_EVENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivybridge_irq_postinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="cm">/* enable kind of interrupts always enabled */</span>
	<span class="n">u32</span> <span class="n">display_mask</span> <span class="o">=</span>
		<span class="n">DE_MASTER_IRQ_CONTROL</span> <span class="o">|</span> <span class="n">DE_GSE_IVB</span> <span class="o">|</span> <span class="n">DE_PCH_EVENT_IVB</span> <span class="o">|</span>
		<span class="n">DE_PLANEC_FLIP_DONE_IVB</span> <span class="o">|</span>
		<span class="n">DE_PLANEB_FLIP_DONE_IVB</span> <span class="o">|</span>
		<span class="n">DE_PLANEA_FLIP_DONE_IVB</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">render_irqs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotplug_mask</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">display_mask</span><span class="p">;</span>

	<span class="cm">/* should always can generate irq */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span>
		   <span class="n">display_mask</span> <span class="o">|</span>
		   <span class="n">DE_PIPEC_VBLANK_IVB</span> <span class="o">|</span>
		   <span class="n">DE_PIPEB_VBLANK_IVB</span> <span class="o">|</span>
		   <span class="n">DE_PIPEA_VBLANK_IVB</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_irq_mask</span><span class="p">);</span>

	<span class="n">render_irqs</span> <span class="o">=</span> <span class="n">GT_USER_INTERRUPT</span> <span class="o">|</span> <span class="n">GEN6_BSD_USER_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GEN6_BLITTER_USER_INTERRUPT</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIER</span><span class="p">,</span> <span class="n">render_irqs</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">);</span>

	<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">SDE_CRT_HOTPLUG_CPT</span> <span class="o">|</span>
			<span class="n">SDE_PORTB_HOTPLUG_CPT</span> <span class="o">|</span>
			<span class="n">SDE_PORTC_HOTPLUG_CPT</span> <span class="o">|</span>
			<span class="n">SDE_PORTD_HOTPLUG_CPT</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">hotplug_mask</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_irq_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">,</span> <span class="n">hotplug_mask</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">);</span>

	<span class="n">ironlake_enable_pch_hotplug</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">valleyview_irq_postinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">render_irqs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">enable_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotplug_en</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">msid</span><span class="p">;</span>

	<span class="n">enable_mask</span> <span class="o">=</span> <span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">;</span>
	<span class="n">enable_mask</span> <span class="o">|=</span> <span class="n">I915_DISPLAY_PIPE_A_VBLANK_INTERRUPT</span> <span class="o">|</span>
		<span class="n">I915_DISPLAY_PIPE_B_VBLANK_INTERRUPT</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">enable_mask</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Hack for broken MSIs on VLV */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xfee00000</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msid</span><span class="p">);</span>
	<span class="n">msid</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* mask out delivery bits */</span>
	<span class="n">msid</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="n">msid</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">,</span> <span class="n">enable_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">render_irqs</span> <span class="o">=</span> <span class="n">GT_GEN6_BLT_FLUSHDW_NOTIFY_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GT_GEN6_BLT_CS_ERROR_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GT_GEN6_BLT_USER_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GT_GEN6_BSD_USER_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GT_GEN6_BSD_CS_ERROR_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GT_GEN7_L3_PARITY_ERROR_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GT_PIPE_NOTIFY</span> <span class="o">|</span>
		<span class="n">GT_RENDER_CS_ERROR_INTERRUPT</span> <span class="o">|</span>
		<span class="n">GT_SYNC_STATUS</span> <span class="o">|</span>
		<span class="n">GT_USER_INTERRUPT</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">render_irqs</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIER</span><span class="p">,</span> <span class="n">render_irqs</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">);</span>

	<span class="cm">/* ack &amp; enable invalid PTE error interrupts */</span>
<span class="cp">#if 0</span><span class="c"> /* FIXME: add support to irq handler for checking these bits */</span>
<span class="c">	I915_WRITE(DPINVGTT, DPINVGTT_STATUS_MASK);</span>
<span class="c">	I915_WRITE(DPINVGTT, DPINVGTT_EN_MASK);</span>
<span class="cp">#endif</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_MASTER_IER</span><span class="p">,</span> <span class="n">MASTER_INTERRUPT_ENABLE</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> /* FIXME: check register definitions; some have moved */</span>
<span class="c">	/* Note HDMI and DP share bits */</span>
<span class="c">	if (dev_priv-&gt;hotplug_supported_mask &amp; HDMIB_HOTPLUG_INT_STATUS)</span>
<span class="c">		hotplug_en |= HDMIB_HOTPLUG_INT_EN;</span>
<span class="c">	if (dev_priv-&gt;hotplug_supported_mask &amp; HDMIC_HOTPLUG_INT_STATUS)</span>
<span class="c">		hotplug_en |= HDMIC_HOTPLUG_INT_EN;</span>
<span class="c">	if (dev_priv-&gt;hotplug_supported_mask &amp; HDMID_HOTPLUG_INT_STATUS)</span>
<span class="c">		hotplug_en |= HDMID_HOTPLUG_INT_EN;</span>
<span class="c">	if (dev_priv-&gt;hotplug_supported_mask &amp; SDVOC_HOTPLUG_INT_STATUS)</span>
<span class="c">		hotplug_en |= SDVOC_HOTPLUG_INT_EN;</span>
<span class="c">	if (dev_priv-&gt;hotplug_supported_mask &amp; SDVOB_HOTPLUG_INT_STATUS)</span>
<span class="c">		hotplug_en |= SDVOB_HOTPLUG_INT_EN;</span>
<span class="c">	if (dev_priv-&gt;hotplug_supported_mask &amp; CRT_HOTPLUG_INT_STATUS) {</span>
<span class="c">		hotplug_en |= CRT_HOTPLUG_INT_EN;</span>
<span class="c">		hotplug_en |= CRT_HOTPLUG_VOLTAGE_COMPARE_50;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="n">hotplug_en</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">valleyview_irq_uninstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">));</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_irq_uninstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_irq_preinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ16</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i8xx_irq_postinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">EMR</span><span class="p">,</span>
		     <span class="o">~</span><span class="p">(</span><span class="n">I915_ERROR_PAGE_TABLE</span> <span class="o">|</span> <span class="n">I915_ERROR_MEMORY_REFRESH</span><span class="p">));</span>

	<span class="cm">/* Unmask the interrupts that we always want on. */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span>
		<span class="o">~</span><span class="p">(</span><span class="n">I915_DISPLAY_PIPE_A_EVENT_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_DISPLAY_PIPE_B_EVENT_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span><span class="p">);</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>

	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span>
		     <span class="n">I915_DISPLAY_PIPE_A_EVENT_INTERRUPT</span> <span class="o">|</span>
		     <span class="n">I915_DISPLAY_PIPE_B_EVENT_INTERRUPT</span> <span class="o">|</span>
		     <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span> <span class="o">|</span>
		     <span class="n">I915_USER_INTERRUPT</span><span class="p">);</span>
	<span class="n">POSTING_READ16</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">i8xx_irq_handler</span><span class="p">(</span><span class="n">DRM_IRQ_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">iir</span><span class="p">,</span> <span class="n">new_iir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_received</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flip_mask</span> <span class="o">=</span>
		<span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
		<span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">);</span>

	<span class="n">iir</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">flip_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Can&#39;t rely on pipestat interrupt bit in iir as it might</span>
<span class="cm">		 * have been cleared after the pipestat interrupt was received.</span>
<span class="cm">		 * It doesn&#39;t set the bit in iir again, but it still produces</span>
<span class="cm">		 * interrupts (for non-MSI).</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span><span class="p">)</span>
			<span class="n">i915_handle_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Clear the PIPE*STAT regs before the IIR</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000ffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_FIFO_UNDERRUN_STATUS</span><span class="p">)</span>
					<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;pipe %c underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
				<span class="n">irq_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

		<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">iir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">flip_mask</span><span class="p">);</span>
		<span class="n">new_iir</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span> <span class="cm">/* Flush posted writes */</span>

		<span class="n">i915_update_dri1_breadcrumb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_USER_INTERRUPT</span><span class="p">)</span>
			<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_VBLANK_INTERRUPT_STATUS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">flip_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_VBLANK_INTERRUPT_STATUS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">flip_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">iir</span> <span class="o">=</span> <span class="n">new_iir</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_irq_uninstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear enable bits; then clear status bits */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">IIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_irq_preinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xeffe</span><span class="p">);</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_irq_postinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">enable_mask</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EMR</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">I915_ERROR_PAGE_TABLE</span> <span class="o">|</span> <span class="n">I915_ERROR_MEMORY_REFRESH</span><span class="p">));</span>

	<span class="cm">/* Unmask the interrupts that we always want on. */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span>
		<span class="o">~</span><span class="p">(</span><span class="n">I915_ASLE_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_DISPLAY_PIPE_A_EVENT_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_DISPLAY_PIPE_B_EVENT_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
		  <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span><span class="p">);</span>

	<span class="n">enable_mask</span> <span class="o">=</span>
		<span class="n">I915_ASLE_INTERRUPT</span> <span class="o">|</span>
		<span class="n">I915_DISPLAY_PIPE_A_EVENT_INTERRUPT</span> <span class="o">|</span>
		<span class="n">I915_DISPLAY_PIPE_B_EVENT_INTERRUPT</span> <span class="o">|</span>
		<span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span> <span class="o">|</span>
		<span class="n">I915_USER_INTERRUPT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable in IER... */</span>
		<span class="n">enable_mask</span> <span class="o">|=</span> <span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">;</span>
		<span class="cm">/* and unmask in IMR */</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="n">enable_mask</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">hotplug_en</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">HDMIB_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">HDMIB_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">HDMIC_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">HDMIC_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">HDMID_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">HDMID_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">SDVOC_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">SDVOC_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">SDVOB_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">SDVOB_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">CRT_HOTPLUG_INT_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">CRT_HOTPLUG_INT_EN</span><span class="p">;</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">CRT_HOTPLUG_VOLTAGE_COMPARE_50</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Ignore TV since it&#39;s buggy */</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="n">hotplug_en</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_opregion_enable_asle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">i915_irq_handler</span><span class="p">(</span><span class="n">DRM_IRQ_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iir</span><span class="p">,</span> <span class="n">new_iir</span><span class="p">,</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="n">I915_MAX_PIPES</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flip_mask</span> <span class="o">=</span>
		<span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
		<span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flip</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span><span class="p">,</span>
		<span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">);</span>

	<span class="n">iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">irq_received</span> <span class="o">=</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">flip_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">blc_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Can&#39;t rely on pipestat interrupt bit in iir as it might</span>
<span class="cm">		 * have been cleared after the pipestat interrupt was received.</span>
<span class="cm">		 * It doesn&#39;t set the bit in iir again, but it still produces</span>
<span class="cm">		 * interrupts (for non-MSI).</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span><span class="p">)</span>
			<span class="n">i915_handle_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

			<span class="cm">/* Clear the PIPE*STAT regs before the IIR */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000ffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_FIFO_UNDERRUN_STATUS</span><span class="p">)</span>
					<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;pipe %c underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
				<span class="n">irq_received</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_received</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Consume port.  Then clear IIR or we&#39;ll miss events */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">hotplug_status</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">);</span>

			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;hotplug event received, stat 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">hotplug_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_status</span> <span class="o">&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span><span class="p">)</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_work</span><span class="p">);</span>

			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">hotplug_status</span><span class="p">);</span>
			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">iir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">flip_mask</span><span class="p">);</span>
		<span class="n">new_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span> <span class="cm">/* Flush posted writes */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_USER_INTERRUPT</span><span class="p">)</span>
			<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">]);</span>

		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_MOBILE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">plane</span> <span class="o">=</span> <span class="o">!</span><span class="n">plane</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_VBLANK_INTERRUPT_STATUS</span> <span class="o">&amp;&amp;</span>
			    <span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">flip</span><span class="p">[</span><span class="n">plane</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
					<span class="n">intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
					<span class="n">flip_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flip</span><span class="p">[</span><span class="n">plane</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_LEGACY_BLC_EVENT_STATUS</span><span class="p">)</span>
				<span class="n">blc_event</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blc_event</span> <span class="o">||</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_ASLE_INTERRUPT</span><span class="p">))</span>
			<span class="n">intel_opregion_asle_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* With MSI, interrupts are only generated when iir</span>
<span class="cm">		 * transitions from zero to nonzero.  If another bit got</span>
<span class="cm">		 * set while we were handling the existing iir bits, then</span>
<span class="cm">		 * we would never get another interrupt.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is fine on non-MSI as well, as if we hit this path</span>
<span class="cm">		 * we avoid exiting the interrupt handler only to generate</span>
<span class="cm">		 * another one.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note that for MSI this could cause a stray interrupt report</span>
<span class="cm">		 * if an interrupt landed in the time between writing IIR and</span>
<span class="cm">		 * the posting read.  This should be rare enough to never</span>
<span class="cm">		 * trigger the 99% of 100,000 interrupts test for disabling</span>
<span class="cm">		 * stray interrupts.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="n">iir</span> <span class="o">=</span> <span class="n">new_iir</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">flip_mask</span><span class="p">);</span>

	<span class="n">i915_update_dri1_breadcrumb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_irq_uninstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE16</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear enable bits; then clear status bits */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i965_irq_preinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xeffe</span><span class="p">);</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i965_irq_postinstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">enable_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">error_mask</span><span class="p">;</span>

	<span class="cm">/* Unmask the interrupts that we always want on. */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">I915_ASLE_INTERRUPT</span> <span class="o">|</span>
			       <span class="n">I915_DISPLAY_PIPE_A_EVENT_INTERRUPT</span> <span class="o">|</span>
			       <span class="n">I915_DISPLAY_PIPE_B_EVENT_INTERRUPT</span> <span class="o">|</span>
			       <span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
			       <span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span> <span class="o">|</span>
			       <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span><span class="p">);</span>

	<span class="n">enable_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">;</span>
	<span class="n">enable_mask</span> <span class="o">|=</span> <span class="n">I915_USER_INTERRUPT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">enable_mask</span> <span class="o">|=</span> <span class="n">I915_BSD_USER_INTERRUPT</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipestat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable in IER... */</span>
		<span class="n">enable_mask</span> <span class="o">|=</span> <span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">;</span>
		<span class="cm">/* and unmask in IMR */</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable some error detection, note the instruction error mask</span>
<span class="cm">	 * bit is reserved, so we leave it masked.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">GM45_ERROR_PAGE_TABLE</span> <span class="o">|</span>
			       <span class="n">GM45_ERROR_MEM_PRIV</span> <span class="o">|</span>
			       <span class="n">GM45_ERROR_CP_PRIV</span> <span class="o">|</span>
			       <span class="n">I915_ERROR_MEMORY_REFRESH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">error_mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">I915_ERROR_PAGE_TABLE</span> <span class="o">|</span>
			       <span class="n">I915_ERROR_MEMORY_REFRESH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">EMR</span><span class="p">,</span> <span class="n">error_mask</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="n">enable_mask</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">IER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">hotplug_en</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">);</span>

		<span class="cm">/* Note HDMI and DP share bits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">HDMIB_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">HDMIB_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">HDMIC_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">HDMIC_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">HDMID_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">HDMID_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">SDVOC_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">SDVOC_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">SDVOB_HOTPLUG_INT_STATUS</span><span class="p">)</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">SDVOB_HOTPLUG_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">&amp;</span> <span class="n">CRT_HOTPLUG_INT_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">CRT_HOTPLUG_INT_EN</span><span class="p">;</span>

			<span class="cm">/* Programming the CRT detection parameters tends</span>
<span class="cm">			   to generate a spurious hotplug event about three</span>
<span class="cm">			   seconds later.  So just do it once.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">CRT_HOTPLUG_ACTIVATION_PERIOD_64</span><span class="p">;</span>
			<span class="n">hotplug_en</span> <span class="o">|=</span> <span class="n">CRT_HOTPLUG_VOLTAGE_COMPARE_50</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Ignore TV since it&#39;s buggy */</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="n">hotplug_en</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_opregion_enable_asle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">i965_irq_handler</span><span class="p">(</span><span class="n">DRM_IRQ_ARGS</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iir</span><span class="p">,</span> <span class="n">new_iir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="n">I915_MAX_PIPES</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_received</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">);</span>

	<span class="n">iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">blc_event</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">irq_received</span> <span class="o">=</span> <span class="n">iir</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Can&#39;t rely on pipestat interrupt bit in iir as it might</span>
<span class="cm">		 * have been cleared after the pipestat interrupt was received.</span>
<span class="cm">		 * It doesn&#39;t set the bit in iir again, but it still produces</span>
<span class="cm">		 * interrupts (for non-MSI).</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_RENDER_COMMAND_PARSER_ERROR_INTERRUPT</span><span class="p">)</span>
			<span class="n">i915_handle_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Clear the PIPE*STAT regs before the IIR</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x8000ffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_FIFO_UNDERRUN_STATUS</span><span class="p">)</span>
					<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;pipe %c underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							 <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]);</span>
				<span class="n">irq_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_received</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

		<span class="cm">/* Consume port.  Then clear IIR or we&#39;ll miss events */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PORT_INTERRUPT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">hotplug_status</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">);</span>

			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;hotplug event received, stat 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">hotplug_status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hotplug_status</span> <span class="o">&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span><span class="p">)</span>
				<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_work</span><span class="p">);</span>

			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">hotplug_status</span><span class="p">);</span>
			<span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">iir</span><span class="p">);</span>
		<span class="n">new_iir</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IIR</span><span class="p">);</span> <span class="cm">/* Flush posted writes */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_USER_INTERRUPT</span><span class="p">)</span>
			<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_BSD_USER_INTERRUPT</span><span class="p">)</span>
			<span class="n">notify_ring</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">VCS</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PLANE_A_FLIP_PENDING_INTERRUPT</span><span class="p">)</span>
			<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_DISPLAY_PLANE_B_FLIP_PENDING_INTERRUPT</span><span class="p">)</span>
			<span class="n">intel_prepare_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_START_VBLANK_INTERRUPT_STATUS</span> <span class="o">&amp;&amp;</span>
			    <span class="n">drm_handle_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">i915_pageflip_stall_check</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
				<span class="n">intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pipe_stats</span><span class="p">[</span><span class="n">pipe</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">PIPE_LEGACY_BLC_EVENT_STATUS</span><span class="p">)</span>
				<span class="n">blc_event</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">blc_event</span> <span class="o">||</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="n">I915_ASLE_INTERRUPT</span><span class="p">))</span>
			<span class="n">intel_opregion_asle_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* With MSI, interrupts are only generated when iir</span>
<span class="cm">		 * transitions from zero to nonzero.  If another bit got</span>
<span class="cm">		 * set while we were handling the existing iir bits, then</span>
<span class="cm">		 * we would never get another interrupt.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is fine on non-MSI as well, as if we hit this path</span>
<span class="cm">		 * we avoid exiting the interrupt handler only to generate</span>
<span class="cm">		 * another one.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note that for MSI this could cause a stray interrupt report</span>
<span class="cm">		 * if an interrupt landed in the time between writing IIR and</span>
<span class="cm">		 * the posting read.  This should be rare enough to never</span>
<span class="cm">		 * trigger the 99% of 100,000 interrupts test for disabling</span>
<span class="cm">		 * stray interrupts.</span>
<span class="cm">		 */</span>
		<span class="n">iir</span> <span class="o">=</span> <span class="n">new_iir</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_update_dri1_breadcrumb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i965_irq_uninstall</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_HAS_HOTPLUG</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWSTAM</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IMR</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IER</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x8000ffff</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">IIR</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">IIR</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_irq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_work</span><span class="p">,</span> <span class="n">i915_hotplug_work_func</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_work</span><span class="p">,</span> <span class="n">i915_error_work_func</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_work</span><span class="p">,</span> <span class="n">gen6_pm_rps_work</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_vblank_counter</span> <span class="o">=</span> <span class="n">i915_get_vblank_counter</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_vblank_count</span> <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">;</span> <span class="cm">/* only 24 bits of frame count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_vblank_count</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span> <span class="cm">/* full 32 bit counter */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_vblank_counter</span> <span class="o">=</span> <span class="n">gm45_get_vblank_counter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_vblank_timestamp</span> <span class="o">=</span> <span class="n">i915_get_vblank_timestamp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_vblank_timestamp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">get_scanout_position</span> <span class="o">=</span> <span class="n">i915_get_crtc_scanoutpos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">valleyview_irq_handler</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_preinstall</span> <span class="o">=</span> <span class="n">valleyview_irq_preinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_postinstall</span> <span class="o">=</span> <span class="n">valleyview_irq_postinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_uninstall</span> <span class="o">=</span> <span class="n">valleyview_irq_uninstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">enable_vblank</span> <span class="o">=</span> <span class="n">valleyview_enable_vblank</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable_vblank</span> <span class="o">=</span> <span class="n">valleyview_disable_vblank</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Share pre &amp; uninstall handlers with ILK/SNB */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">ivybridge_irq_handler</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_preinstall</span> <span class="o">=</span> <span class="n">ironlake_irq_preinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_postinstall</span> <span class="o">=</span> <span class="n">ivybridge_irq_postinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_uninstall</span> <span class="o">=</span> <span class="n">ironlake_irq_uninstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">enable_vblank</span> <span class="o">=</span> <span class="n">ivybridge_enable_vblank</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable_vblank</span> <span class="o">=</span> <span class="n">ivybridge_disable_vblank</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Share interrupts handling with IVB */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">ivybridge_irq_handler</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_preinstall</span> <span class="o">=</span> <span class="n">ironlake_irq_preinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_postinstall</span> <span class="o">=</span> <span class="n">ivybridge_irq_postinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_uninstall</span> <span class="o">=</span> <span class="n">ironlake_irq_uninstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">enable_vblank</span> <span class="o">=</span> <span class="n">ivybridge_enable_vblank</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable_vblank</span> <span class="o">=</span> <span class="n">ivybridge_disable_vblank</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">ironlake_irq_handler</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_preinstall</span> <span class="o">=</span> <span class="n">ironlake_irq_preinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_postinstall</span> <span class="o">=</span> <span class="n">ironlake_irq_postinstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_uninstall</span> <span class="o">=</span> <span class="n">ironlake_irq_uninstall</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">enable_vblank</span> <span class="o">=</span> <span class="n">ironlake_enable_vblank</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable_vblank</span> <span class="o">=</span> <span class="n">ironlake_disable_vblank</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_preinstall</span> <span class="o">=</span> <span class="n">i8xx_irq_preinstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_postinstall</span> <span class="o">=</span> <span class="n">i8xx_irq_postinstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">i8xx_irq_handler</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_uninstall</span> <span class="o">=</span> <span class="n">i8xx_irq_uninstall</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* IIR &quot;flip pending&quot; means done if this bit is set */</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ECOSKPD</span><span class="p">,</span> <span class="n">_MASKED_BIT_DISABLE</span><span class="p">(</span><span class="n">ECO_FLIP_DONE</span><span class="p">));</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_preinstall</span> <span class="o">=</span> <span class="n">i915_irq_preinstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_postinstall</span> <span class="o">=</span> <span class="n">i915_irq_postinstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_uninstall</span> <span class="o">=</span> <span class="n">i915_irq_uninstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">i915_irq_handler</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_preinstall</span> <span class="o">=</span> <span class="n">i965_irq_preinstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_postinstall</span> <span class="o">=</span> <span class="n">i965_irq_postinstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_uninstall</span> <span class="o">=</span> <span class="n">i965_irq_uninstall</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">irq_handler</span> <span class="o">=</span> <span class="n">i965_irq_handler</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">enable_vblank</span> <span class="o">=</span> <span class="n">i915_enable_vblank</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">disable_vblank</span> <span class="o">=</span> <span class="n">i915_disable_vblank</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
