<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › intel_display.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>intel_display.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2006-2007 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vgaarb.h&gt;</span>
<span class="cp">#include &lt;drm/drm_edid.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;i915_trace.h&quot;</span>
<span class="cp">#include &quot;drm_dp_helper.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>
<span class="cp">#include &lt;linux/dma_remapping.h&gt;</span>

<span class="cp">#define HAS_eDP (intel_pipe_has_type(crtc, INTEL_OUTPUT_EDP))</span>

<span class="n">bool</span> <span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">intel_increase_pllclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="cm">/* given values */</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">;</span>
	<span class="cm">/* derived values */</span>
	<span class="kt">int</span>	<span class="n">dot</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">vco</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">p</span><span class="p">;</span>
<span class="p">}</span> <span class="n">intel_clock_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span> <span class="n">intel_range_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">dot_limit</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">p2_slow</span><span class="p">,</span> <span class="n">p2_fast</span><span class="p">;</span>
<span class="p">}</span> <span class="n">intel_p2_t</span><span class="p">;</span>

<span class="cp">#define INTEL_P2_NUM		      2</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">intel_limit</span> <span class="n">intel_limit_t</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">intel_limit</span> <span class="p">{</span>
	<span class="n">intel_range_t</span>   <span class="n">dot</span><span class="p">,</span> <span class="n">vco</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">p1</span><span class="p">;</span>
	<span class="n">intel_p2_t</span>	    <span class="n">p2</span><span class="p">;</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span> <span class="n">find_pll</span><span class="p">)(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="p">,</span>
			<span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* FDI */</span>
<span class="cp">#define IRONLAKE_FDI_FREQ		2700000 </span><span class="cm">/* in kHz for mode-&gt;clock */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">bool</span>
<span class="n">intel_find_best_PLL</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
		    <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="n">intel_g4x_find_best_PLL</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
			<span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="n">intel_find_pll_g4x_dp</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
		      <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="n">intel_find_pll_ironlake_dp</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
			   <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="cm">/* units of 100MHz */</span>
<span class="n">intel_fdi_link_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">FDI_PLL_BIOS_0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FDI_PLL_FB_CLOCK_MASK</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">27</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_i8xx_dvo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">930000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1400000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">140</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">26</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">128</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">33</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">165000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_i8xx_lvds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">930000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1400000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">140</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">26</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">16</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">128</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">165000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_i9xx_sdvo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">400000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1400000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2800000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">120</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_i9xx_lvds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">400000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1400000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2800000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">120</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">98</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">112000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_g4x_sdvo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">270000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1750000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3500000</span><span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">138</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">23</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">30</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">270000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">10</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_g4x_hdmi</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">22000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">400000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1750000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3500000</span><span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">138</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">23</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">165000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_g4x_single_channel_lvds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">115000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1750000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3500000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">138</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">23</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">112</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">14</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_g4x_dual_channel_lvds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">80000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">224000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1750000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3500000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">138</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">23</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">42</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">7</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_g4x_display_port</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">161670</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">227000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1750000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3500000</span><span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">97</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">108</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mh">0x12</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mh">0x06</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_pll_g4x_dp</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_pineview_sdvo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">400000</span><span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1700000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3500000</span> <span class="p">},</span>
	<span class="cm">/* Pineview&#39;s Ncounter is a ring counter */</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span> <span class="p">},</span>
	<span class="cm">/* Pineview only has one combined m divider, which we treat as m2. */</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">254</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">200000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_pineview_lvds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">400000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1700000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3500000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">256</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">254</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">112</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">112000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Ironlake / Sandybridge</span>
<span class="cm"> *</span>
<span class="cm"> * We calculate clock using (register_value + 2) for N/M1/M2, so here</span>
<span class="cm"> * the range value for them is (actual_value - 2).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_ironlake_dac</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1760000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3510000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">127</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">225000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_ironlake_single_lvds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1760000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3510000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">118</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">112</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">225000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_ironlake_dual_lvds</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1760000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3510000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">127</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">56</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">225000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* LVDS 100mhz refclk limits. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_ironlake_single_lvds_100m</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1760000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3510000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">126</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">112</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">225000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_ironlake_dual_lvds_100m</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1760000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3510000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">79</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">126</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">42</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">225000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_g4x_find_best_PLL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="n">intel_limits_ironlake_display_port</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">350000</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1760000</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">3510000</span><span class="p">},</span>
	<span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">81</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">90</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">22</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">dot_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">p2_slow</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">p2_fast</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">.</span><span class="n">find_pll</span> <span class="o">=</span> <span class="n">intel_find_pll_ironlake_dp</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">u32</span> <span class="nf">intel_dpio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_atomic_us</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DPIO_PKT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPIO_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;DPIO idle wait timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPIO_REG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPIO_PKT</span><span class="p">,</span> <span class="n">DPIO_RID</span> <span class="o">|</span> <span class="n">DPIO_OP_READ</span> <span class="o">|</span> <span class="n">DPIO_PORTID</span> <span class="o">|</span>
		   <span class="n">DPIO_BYTE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_atomic_us</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DPIO_PKT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DPIO_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;DPIO read wait timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DPIO_DATA</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlv_init_dpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* Reset the DPIO config */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPIO_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DPIO_CTL</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPIO_CTL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DPIO_CTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_dual_link_lvds_callback</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Forcing lvds to dual link mode on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">intel_dual_link_lvds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">intel_dual_link_lvds_callback</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Apple MacBook Pro (Core i5/i7 Series)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Apple Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MacBookPro8,2&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminating entry */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_dual_link_lvds</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* use the module option value if specified */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i915_lvds_channel_mode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i915_lvds_channel_mode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">intel_dual_link_lvds</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_val</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_val</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* BIOS should set the proper LVDS register value at boot, but</span>
<span class="cm">		 * in reality, it doesn&#39;t set the value when the lid is closed;</span>
<span class="cm">		 * we need to check &quot;the value to be set&quot; in VBT when LVDS</span>
<span class="cm">		 * register is uninitialized.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LVDS_DETECTED</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bios_lvds_val</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_val</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">LVDS_CLKB_POWER_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="nf">intel_ironlake_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">refclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_dual_link_lvds</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">PCH_LVDS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* LVDS dual channel */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">refclk</span> <span class="o">==</span> <span class="mi">100000</span><span class="p">)</span>
				<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_ironlake_dual_lvds_100m</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_ironlake_dual_lvds</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">refclk</span> <span class="o">==</span> <span class="mi">100000</span><span class="p">)</span>
				<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_ironlake_single_lvds_100m</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_ironlake_single_lvds</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">HAS_eDP</span><span class="p">)</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_ironlake_display_port</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_ironlake_dac</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="nf">intel_g4x_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_dual_link_lvds</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">LVDS</span><span class="p">))</span>
			<span class="cm">/* LVDS with dual channel */</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_g4x_dual_channel_lvds</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* LVDS with dual channel */</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_g4x_single_channel_lvds</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_HDMI</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_ANALOG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_g4x_hdmi</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_SDVO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_g4x_sdvo</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_g4x_display_port</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* The option is for other outputs */</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_i9xx_sdvo</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="nf">intel_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">intel_ironlake_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">refclk</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">intel_g4x_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_pineview_lvds</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_pineview_sdvo</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_i9xx_lvds</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_i9xx_sdvo</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_i8xx_lvds</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_limits_i8xx_dvo</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* m1 is reserved as 0 in Pineview, n is a ring counter */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pineview_clock</span><span class="p">(</span><span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">=</span> <span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pineview_clock</span><span class="p">(</span><span class="n">refclk</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">;</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">=</span> <span class="n">refclk</span> <span class="o">*</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">/</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Returns whether any output on the specified pipe is of the specified type</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">intel_pipe_has_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span> <span class="o">&amp;&amp;</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define INTELPllInvalid(s)   do { </span><span class="cm">/* DRM_DEBUG(s); */</span><span class="cp"> return false; } while (0)</span>
<span class="cm">/**</span>
<span class="cm"> * Returns whether the given set of divisors are valid for a given refclk with</span>
<span class="cm"> * the given connectors.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_PLL_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span>  <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span>  <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span>  <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;p1 out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span>   <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">min</span>   <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">max</span>   <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;p out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span>  <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">min</span>  <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">max</span>  <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m2 out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span>  <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">min</span>  <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">max</span>  <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m1 out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">&lt;=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m1 &lt;= m2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span>   <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">min</span>   <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">max</span>   <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;m out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span>   <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">min</span>   <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">max</span>   <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;n out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">vco</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;vco out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* XXX: We may need to be checking &quot;Dot clock&quot; depending on the multiplier,</span>
<span class="cm">	 * connector, etc., rather than just a single range.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">.</span><span class="n">min</span> <span class="o">||</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">.</span><span class="n">max</span> <span class="o">&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">dot</span><span class="p">)</span>
		<span class="n">INTELPllInvalid</span><span class="p">(</span><span class="s">&quot;dot out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_find_best_PLL</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
		    <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For LVDS, if the panel is on, just rely on its current</span>
<span class="cm">		 * settings for dual-channel.  We haven&#39;t figured out how to</span>
<span class="cm">		 * reliably set up different single/dual channel state, if we</span>
<span class="cm">		 * even can.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_dual_link_lvds</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">LVDS</span><span class="p">))</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">dot_limit</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">best_clock</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
	     <span class="n">clock</span><span class="p">.</span><span class="n">m1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
		     <span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">max</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* m1 is always 0 in Pineview */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">&gt;=</span> <span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			     <span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">max</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
					<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">this_err</span><span class="p">;</span>

					<span class="n">intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_PLL_is_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">clock</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">match_clock</span> <span class="o">&amp;&amp;</span>
					    <span class="n">clock</span><span class="p">.</span><span class="n">p</span> <span class="o">!=</span> <span class="n">match_clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="n">this_err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">dot</span> <span class="o">-</span> <span class="n">target</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">this_err</span> <span class="o">&lt;</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">best_clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
						<span class="n">err</span> <span class="o">=</span> <span class="n">this_err</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_g4x_find_best_PLL</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
			<span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_n</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span><span class="p">;</span>
	<span class="cm">/* approximately equals target * 0.00585 */</span>
	<span class="kt">int</span> <span class="n">err_most</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">target</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">lvds_reg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">lvds_reg</span> <span class="o">=</span> <span class="n">PCH_LVDS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lvds_reg</span> <span class="o">=</span> <span class="n">LVDS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">lvds_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_CLKB_POWER_MASK</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">dot_limit</span><span class="p">)</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_slow</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">.</span><span class="n">p2_fast</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">best_clock</span><span class="p">));</span>
	<span class="n">max_n</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
	<span class="cm">/* based on hardware requirement, prefer smaller n to precision */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="n">max_n</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* based on hardware requirement, prefere larger m1,m2 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
		     <span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m1</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			     <span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">m2</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
				     <span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">clock</span><span class="p">.</span><span class="n">p1</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">this_err</span><span class="p">;</span>

					<span class="n">intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_PLL_is_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">clock</span><span class="p">))</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">match_clock</span> <span class="o">&amp;&amp;</span>
					    <span class="n">clock</span><span class="p">.</span><span class="n">p</span> <span class="o">!=</span> <span class="n">match_clock</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="n">this_err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">dot</span> <span class="o">-</span> <span class="n">target</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">this_err</span> <span class="o">&lt;</span> <span class="n">err_most</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">best_clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
						<span class="n">err_most</span> <span class="o">=</span> <span class="n">this_err</span><span class="p">;</span>
						<span class="n">max_n</span> <span class="o">=</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
						<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_find_pll_ironlake_dp</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
			   <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">intel_clock_t</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DisplayPort has only two frequencies, 162MHz and 270MHz */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_find_pll_g4x_dp</span><span class="p">(</span><span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">match_clock</span><span class="p">,</span>
		      <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">best_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">*</span> <span class="n">clock</span><span class="p">.</span><span class="n">p2</span><span class="p">);</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">dot</span> <span class="o">=</span> <span class="mi">96000</span> <span class="o">*</span> <span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">/</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">clock</span><span class="p">.</span><span class="n">p</span><span class="p">;</span>
	<span class="n">clock</span><span class="p">.</span><span class="n">vco</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">best_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">intel_clock_t</span><span class="p">));</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_wait_for_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frame_reg</span> <span class="o">=</span> <span class="n">PIPEFRAME</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">frame_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">(</span><span class="n">I915_READ_NOTRACE</span><span class="p">(</span><span class="n">frame_reg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">frame</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;vblank wait timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_wait_for_vblank - wait for vblank on a given pipe</span>
<span class="cm"> * @dev: drm device</span>
<span class="cm"> * @pipe: pipe to wait for</span>
<span class="cm"> *</span>
<span class="cm"> * Wait for vblank to occur on a given pipe.  Needed for various bits of</span>
<span class="cm"> * mode setting code.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_wait_for_vblank</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipestat_reg</span> <span class="o">=</span> <span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ironlake_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear existing vblank status. Note this will clear any other</span>
<span class="cm">	 * sticky status fields as well.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This races with i915_driver_irq_handler() with the result</span>
<span class="cm">	 * that either function could miss a vblank event.  Here it is not</span>
<span class="cm">	 * fatal, as we will either wait upon the next vblank interrupt or</span>
<span class="cm">	 * timeout.  Generally speaking intel_wait_for_vblank() is only</span>
<span class="cm">	 * called during modeset at which time the GPU should be idle and</span>
<span class="cm">	 * should *not* be performing page flips and thus not waiting on</span>
<span class="cm">	 * vblanks...</span>
<span class="cm">	 * Currently, the result of us stealing a vblank from the irq</span>
<span class="cm">	 * handler is that a single frame will be skipped during swapbuffers.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">pipestat_reg</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">pipestat_reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">PIPE_VBLANK_INTERRUPT_STATUS</span><span class="p">);</span>

	<span class="cm">/* Wait for vblank interrupt bit to set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">pipestat_reg</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">PIPE_VBLANK_INTERRUPT_STATUS</span><span class="p">,</span>
		     <span class="mi">50</span><span class="p">))</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;vblank wait timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * intel_wait_for_pipe_off - wait for pipe to turn off</span>
<span class="cm"> * @dev: drm device</span>
<span class="cm"> * @pipe: pipe to wait for</span>
<span class="cm"> *</span>
<span class="cm"> * After disabling a pipe, we can&#39;t wait for vblank in the usual way,</span>
<span class="cm"> * spinning on the vblank interrupt status bit, since we won&#39;t actually</span>
<span class="cm"> * see an interrupt when the pipe is disabled.</span>
<span class="cm"> *</span>
<span class="cm"> * On Gen4 and above:</span>
<span class="cm"> *   wait for the pipe register state bit to turn off</span>
<span class="cm"> *</span>
<span class="cm"> * Otherwise:</span>
<span class="cm"> *   wait for the display line value to settle (it usually</span>
<span class="cm"> *   ends up stopping at the start of the next frame).</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_wait_for_pipe_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>

		<span class="cm">/* Wait for the Pipe State to go off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I965_PIPECONF_ACTIVE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="mi">100</span><span class="p">))</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;pipe_off wait timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">last_line</span><span class="p">,</span> <span class="n">line_mask</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">PIPEDSL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">line_mask</span> <span class="o">=</span> <span class="n">DSL_LINEMASK_GEN2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">line_mask</span> <span class="o">=</span> <span class="n">DSL_LINEMASK_GEN3</span><span class="p">;</span>

		<span class="cm">/* Wait for the display line to settle */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">last_line</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">line_mask</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">line_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">last_line</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="n">time_after</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;pipe_off wait timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">state_string</span><span class="p">(</span><span class="n">bool</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">enabled</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Only for pre-ILK configs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_state</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">cur_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">,</span>
	     <span class="s">&quot;PLL state assertion failure (expected %s, current %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">cur_state</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#define assert_pll_enabled(d, p) assert_pll(d, p, true)</span>
<span class="cp">#define assert_pll_disabled(d, p) assert_pll(d, p, false)</span>

<span class="cm">/* For ILK+ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_pch_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">intel_pch_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_LPT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;LPT detected: skipping PCH PLL test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span> <span class="p">(</span><span class="o">!</span><span class="n">pll</span><span class="p">,</span>
		  <span class="s">&quot;asserting PCH PLL %s with no PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>
	<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">cur_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">,</span>
	     <span class="s">&quot;PCH PLL state for reg %x assertion failure (expected %s, current %s), val=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">cur_state</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Make sure the selected PLL is correctly attached to the transcoder */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">&amp;&amp;</span> <span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pch_dpll</span><span class="p">;</span>

		<span class="n">pch_dpll</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DPLL_SEL</span><span class="p">);</span>
		<span class="n">cur_state</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span> <span class="o">==</span> <span class="n">_PCH_DPLL_B</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WARN</span><span class="p">(((</span><span class="n">pch_dpll</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cur_state</span><span class="p">,</span>
			  <span class="s">&quot;PLL[%d] not attached to this transcoder %d: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cur_state</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pch_dpll</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
			<span class="n">WARN</span><span class="p">(</span><span class="n">cur_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">,</span>
			     <span class="s">&quot;PLL[%d] not %s on this transcoder %d: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span> <span class="o">==</span> <span class="n">_PCH_DPLL_B</span><span class="p">,</span>
			     <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span>
			     <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span>
			     <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#define assert_pch_pll_enabled(d, p, c) assert_pch_pll(d, p, c, true)</span>
<span class="cp">#define assert_pch_pll_disabled(d, p, c) assert_pch_pll(d, p, c, false)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_fdi_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* On Haswell, DDI is used instead of FDI_TX_CTL */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">DDI_FUNC_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PIPE_DDI_FUNC_ENABLE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">FDI_TX_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">cur_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">,</span>
	     <span class="s">&quot;FDI TX state assertion failure (expected %s, current %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">cur_state</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#define assert_fdi_tx_enabled(d, p) assert_fdi_tx(d, p, true)</span>
<span class="cp">#define assert_fdi_tx_disabled(d, p) assert_fdi_tx(d, p, false)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_fdi_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to enable FDI_RX on Haswell pipe &gt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">FDI_RX_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">cur_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">,</span>
	     <span class="s">&quot;FDI RX state assertion failure (expected %s, current %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">cur_state</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#define assert_fdi_rx_enabled(d, p) assert_fdi_rx(d, p, true)</span>
<span class="cp">#define assert_fdi_rx_disabled(d, p) assert_fdi_rx(d, p, false)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_fdi_tx_pll_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* ILK FDI PLL is always enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* On Haswell, DDI ports are responsible for the FDI PLL setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">FDI_TX_PLL_ENABLE</span><span class="p">),</span> <span class="s">&quot;FDI TX PLL assertion failure, should be active but is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_fdi_rx_pll_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to enable FDI on Haswell with pipe &gt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">FDI_RX_PLL_ENABLE</span><span class="p">),</span> <span class="s">&quot;FDI RX PLL assertion failure, should be active but is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_panel_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pp_reg</span><span class="p">,</span> <span class="n">lvds_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">pipe</span> <span class="n">panel_pipe</span> <span class="o">=</span> <span class="n">PIPE_A</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">locked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pp_reg</span> <span class="o">=</span> <span class="n">PCH_PP_CONTROL</span><span class="p">;</span>
		<span class="n">lvds_reg</span> <span class="o">=</span> <span class="n">PCH_LVDS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pp_reg</span> <span class="o">=</span> <span class="n">PP_CONTROL</span><span class="p">;</span>
		<span class="n">lvds_reg</span> <span class="o">=</span> <span class="n">LVDS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">pp_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PANEL_POWER_ON</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PANEL_UNLOCK_REGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">PANEL_UNLOCK_REGS</span><span class="p">))</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">lvds_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_PIPEB_SELECT</span><span class="p">)</span>
		<span class="n">panel_pipe</span> <span class="o">=</span> <span class="n">PIPE_B</span><span class="p">;</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">panel_pipe</span> <span class="o">==</span> <span class="n">pipe</span> <span class="o">&amp;&amp;</span> <span class="n">locked</span><span class="p">,</span>
	     <span class="s">&quot;panel assertion failure, pipe %c regs locked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">assert_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
		 <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_state</span><span class="p">;</span>

	<span class="cm">/* if we need the pipe A quirk it must be always on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_A</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">QUIRK_PIPEA_FORCE</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PIPECONF_ENABLE</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">cur_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">,</span>
	     <span class="s">&quot;pipe %c assertion failure (expected %s, current %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">cur_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">plane</span> <span class="n">plane</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_state</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">cur_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">cur_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">,</span>
	     <span class="s">&quot;plane %c assertion failure (expected %s, current %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">plane_name</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state_string</span><span class="p">(</span><span class="n">cur_state</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define assert_plane_enabled(d, p) assert_plane(d, p, true)</span>
<span class="cp">#define assert_plane_disabled(d, p) assert_plane(d, p, false)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_planes_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_pipe</span><span class="p">;</span>

	<span class="cm">/* Planes are fixed to pipes on ILK+ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">WARN</span><span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">),</span>
		     <span class="s">&quot;plane %c assertion failure, should be disabled but not</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">plane_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Need to check both planes against the pipe */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">cur_pipe</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPPLANE_SEL_PIPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">DISPPLANE_SEL_PIPE_SHIFT</span><span class="p">;</span>
		<span class="n">WARN</span><span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pipe</span> <span class="o">==</span> <span class="n">cur_pipe</span><span class="p">,</span>
		     <span class="s">&quot;plane %c assertion failure, should be off on pipe %c but is still active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">plane_name</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_pch_refclk_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_LPT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;LPT does not has PCH refclk, skipping check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">);</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DREF_SSC_SOURCE_MASK</span> <span class="o">|</span> <span class="n">DREF_NONSPREAD_SOURCE_MASK</span> <span class="o">|</span>
			    <span class="n">DREF_SUPERSPREAD_SOURCE_MASK</span><span class="p">));</span>
	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">enabled</span><span class="p">,</span> <span class="s">&quot;PCH refclk assertion failure, should be active but is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_transcoder_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">TRANSCONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TRANS_ENABLE</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">enabled</span><span class="p">,</span>
	     <span class="s">&quot;transcoder assertion failed, should be off on pipe %c but is still active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">dp_pipe_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_sel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DP_PORT_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span>	<span class="n">trans_dp_ctl_reg</span> <span class="o">=</span> <span class="n">TRANS_DP_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">u32</span>	<span class="n">trans_dp_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">trans_dp_ctl_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">trans_dp_ctl</span> <span class="o">&amp;</span> <span class="n">TRANS_DP_PORT_SEL_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">port_sel</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DP_PIPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hdmi_pipe_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_TRANS_SEL_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PORT_TRANS_SEL_CPT</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TRANSCODER_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TRANSCODER</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">lvds_pipe_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_TRANS_SEL_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PORT_TRANS_SEL_CPT</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">LVDS_PIPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LVDS_PIPE</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">adpa_pipe_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ADPA_DAC_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PORT_TRANS_SEL_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PORT_TRANS_SEL_CPT</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ADPA_PIPE_SELECT_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ADPA_PIPE_SELECT</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_pch_dp_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">dp_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">port_sel</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
	     <span class="s">&quot;PCH DP (0x%08x) enabled on transcoder %c, should be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">reg</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_pch_hdmi_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">hdmi_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">pipe</span><span class="p">),</span>
	     <span class="s">&quot;PCH HDMI (0x%08x) enabled on transcoder %c, should be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">reg</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">assert_pch_ports_disabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">assert_pch_dp_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">PCH_DP_B</span><span class="p">,</span> <span class="n">TRANS_DP_PORT_SEL_B</span><span class="p">);</span>
	<span class="n">assert_pch_dp_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">PCH_DP_C</span><span class="p">,</span> <span class="n">TRANS_DP_PORT_SEL_C</span><span class="p">);</span>
	<span class="n">assert_pch_dp_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">PCH_DP_D</span><span class="p">,</span> <span class="n">TRANS_DP_PORT_SEL_D</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PCH_ADPA</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">adpa_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">pipe</span><span class="p">),</span>
	     <span class="s">&quot;PCH VGA enabled on transcoder %c, should be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PCH_LVDS</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">lvds_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">pipe</span><span class="p">),</span>
	     <span class="s">&quot;PCH LVDS enabled on transcoder %c, should be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="n">assert_pch_hdmi_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">HDMIB</span><span class="p">);</span>
	<span class="n">assert_pch_hdmi_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">HDMIC</span><span class="p">);</span>
	<span class="n">assert_pch_hdmi_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">HDMID</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_enable_pll - enable a PLL</span>
<span class="cm"> * @dev_priv: i915 private structure</span>
<span class="cm"> * @pipe: pipe PLL to enable</span>
<span class="cm"> *</span>
<span class="cm"> * Enable @pipe&#39;s PLL so we can start pumping pixels from a plane.  Check to</span>
<span class="cm"> * make sure the PLL reg is writable first though, since the panel write</span>
<span class="cm"> * protect mechanism may be enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * Note!  This is for pre-ILK only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_enable_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* No really, not for ILK+ */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* PLL is protected by panel, make sure we can write it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MOBILE</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_I830</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">assert_panel_unlocked</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>

	<span class="cm">/* We do this three times for luck */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span> <span class="cm">/* wait for warmup */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span> <span class="cm">/* wait for warmup */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span> <span class="cm">/* wait for warmup */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_disable_pll - disable a PLL</span>
<span class="cm"> * @dev_priv: i915 private structure</span>
<span class="cm"> * @pipe: pipe PLL to disable</span>
<span class="cm"> *</span>
<span class="cm"> * Disable the PLL for @pipe, making sure the pipe is off first.</span>
<span class="cm"> *</span>
<span class="cm"> * Note!  This is for pre-ILK only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_disable_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t disable pipe A or pipe A PLLs if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_A</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">QUIRK_PIPEA_FORCE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Make sure the pipe isn&#39;t still relying on us */</span>
	<span class="n">assert_pipe_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SBI access */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_sbi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">SBI_CTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBI_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
				<span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SBI to become ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SBI_ADDR</span><span class="p">,</span>
			<span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SBI_DATA</span><span class="p">,</span>
			<span class="n">value</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SBI_CTL_STAT</span><span class="p">,</span>
			<span class="n">SBI_BUSY</span> <span class="o">|</span>
			<span class="n">SBI_CTL_OP_CRWR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">SBI_CTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SBI_READY</span> <span class="o">|</span> <span class="n">SBI_RESPONSE_SUCCESS</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
				<span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SBI to complete write transaction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">intel_sbi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">SBI_CTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBI_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
				<span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SBI to become ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SBI_ADDR</span><span class="p">,</span>
			<span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SBI_CTL_STAT</span><span class="p">,</span>
			<span class="n">SBI_BUSY</span> <span class="o">|</span>
			<span class="n">SBI_CTL_OP_CRRD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">SBI_CTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SBI_READY</span> <span class="o">|</span> <span class="n">SBI_RESPONSE_SUCCESS</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
				<span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;timeout waiting for SBI to complete read transaction</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SBI_DATA</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_enable_pch_pll - enable PCH PLL</span>
<span class="cm"> * @dev_priv: i915 private structure</span>
<span class="cm"> * @pipe: pipe PLL to enable</span>
<span class="cm"> *</span>
<span class="cm"> * The PCH PLL needs to be enabled before the PCH transcoder, since it</span>
<span class="cm"> * drives the transcoder clock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_enable_pch_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_pch_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* PCH PLLs only available on ILK, SNB and IVB */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">pll</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;enable PCH PLL %x (active %d, on? %d)for crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">,</span>
		      <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* PCH refclock must be enabled first */</span>
	<span class="n">assert_pch_refclk_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">++</span> <span class="o">&amp;&amp;</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">assert_pch_pll_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;enabling PCH PLL %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_disable_pch_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_pch_pll</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* PCH only available on ILK+ */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	       <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disable PCH PLL %x (active %d, on? %d) for crtc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">on</span><span class="p">,</span>
		      <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">assert_pch_pll_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">assert_pch_pll_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pll</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disabling PCH PLL %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>

	<span class="cm">/* Make sure transcoder isn&#39;t still depending on us */</span>
	<span class="n">assert_transcoder_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_enable_transcoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">pipeconf_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>

	<span class="cm">/* PCH only available on ILK+ */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Make sure PCH DPLL is enabled */</span>
	<span class="n">assert_pch_pll_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
			       <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="p">,</span>
			       <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">));</span>

	<span class="cm">/* FDI must be feeding us bits for PCH ports */</span>
	<span class="n">assert_fdi_tx_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">assert_fdi_rx_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Attempting to enable transcoder on Haswell with pipe &gt; 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">TRANSCONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">pipeconf_val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * make the BPC in transcoder be consistent with</span>
<span class="cm">		 * that in pipeconf reg.</span>
<span class="cm">		 */</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPE_BPC_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">pipeconf_val</span> <span class="o">&amp;</span> <span class="n">PIPE_BPC_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANS_INTERLACE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pipeconf_val</span> <span class="o">&amp;</span> <span class="n">PIPECONF_INTERLACE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">PIPECONF_INTERLACED_ILK</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_SDVO</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TRANS_LEGACY_INTERLACED_ILK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">TRANS_INTERLACED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TRANS_PROGRESSIVE</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">TRANS_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TRANS_STATE_ENABLE</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to enable transcoder %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_disable_transcoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* FDI relies on the transcoder */</span>
	<span class="n">assert_fdi_tx_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">assert_fdi_rx_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* Ports must be off as well */</span>
	<span class="n">assert_pch_ports_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">TRANSCONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRANS_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/* wait for PCH transcoder off, transcoder state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TRANS_STATE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to disable transcoder %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_enable_pipe - enable a pipe, asserting requirements</span>
<span class="cm"> * @dev_priv: i915 private structure</span>
<span class="cm"> * @pipe: pipe to enable</span>
<span class="cm"> * @pch_port: on ILK+, is this pipe driving a PCH port or not</span>
<span class="cm"> *</span>
<span class="cm"> * Enable @pipe, making sure that various hardware specific requirements</span>
<span class="cm"> * are met, if applicable, e.g. PLL enabled, LVDS pairs enabled, etc.</span>
<span class="cm"> *</span>
<span class="cm"> * @pipe should be %PIPE_A or %PIPE_B.</span>
<span class="cm"> *</span>
<span class="cm"> * Will wait until the pipe is actually running (i.e. first vblank) before</span>
<span class="cm"> * returning.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_enable_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">pch_port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A pipe without a PLL won&#39;t actually be able to drive bits from</span>
<span class="cm">	 * a plane.  On ILK+ the pipe PLLs are integrated, so we don&#39;t</span>
<span class="cm">	 * need the check.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">assert_pll_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pch_port</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if driving the PCH, we need FDI enabled */</span>
			<span class="n">assert_fdi_rx_pll_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
			<span class="n">assert_fdi_tx_pll_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* FIXME: assert CPU port conditions for SNB+ */</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PIPECONF_ENABLE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">PIPECONF_ENABLE</span><span class="p">);</span>
	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_disable_pipe - disable a pipe, asserting requirements</span>
<span class="cm"> * @dev_priv: i915 private structure</span>
<span class="cm"> * @pipe: pipe to disable</span>
<span class="cm"> *</span>
<span class="cm"> * Disable @pipe, making sure that various hardware specific requirements</span>
<span class="cm"> * are met, if applicable, e.g. plane disabled, panel fitter off, etc.</span>
<span class="cm"> *</span>
<span class="cm"> * @pipe should be %PIPE_A or %PIPE_B.</span>
<span class="cm"> *</span>
<span class="cm"> * Will wait until the pipe has shut down before returning.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_disable_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure planes won&#39;t keep trying to pump pixels to us,</span>
<span class="cm">	 * or we might hang the display.</span>
<span class="cm">	 */</span>
	<span class="n">assert_planes_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t disable pipe A or pipe A PLLs if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="n">PIPE_A</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">QUIRK_PIPEA_FORCE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PIPECONF_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIPECONF_ENABLE</span><span class="p">);</span>
	<span class="n">intel_wait_for_pipe_off</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Plane regs are double buffered, going from enabled-&gt;disabled needs a</span>
<span class="cm"> * trigger in order to latch.  The display address reg provides this.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_flush_display_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">plane</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPADDR</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPADDR</span><span class="p">(</span><span class="n">plane</span><span class="p">)));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPSURF</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPSURF</span><span class="p">(</span><span class="n">plane</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_enable_plane - enable a display plane on a given pipe</span>
<span class="cm"> * @dev_priv: i915 private structure</span>
<span class="cm"> * @plane: plane to enable</span>
<span class="cm"> * @pipe: pipe being fed</span>
<span class="cm"> *</span>
<span class="cm"> * Enable @plane on @pipe, making sure that @pipe is running first.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_enable_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">plane</span> <span class="n">plane</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* If the pipe isn&#39;t enabled, we can&#39;t pump pixels and may hang */</span>
	<span class="n">assert_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
	<span class="n">intel_flush_display_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_disable_plane - disable a display plane</span>
<span class="cm"> * @dev_priv: i915 private structure</span>
<span class="cm"> * @plane: plane to disable</span>
<span class="cm"> * @pipe: pipe consuming the data</span>
<span class="cm"> *</span>
<span class="cm"> * Disable @plane; should be an independent operation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_disable_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">plane</span> <span class="n">plane</span><span class="p">,</span> <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">);</span>
	<span class="n">intel_flush_display_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_pch_dp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">port_sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dp_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">port_sel</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Disabling pch dp %x on pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DP_PORT_EN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_pch_hdmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdmi_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Disabling pch HDMI %x on pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">reg</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Disable any ports connected to this transcoder */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_disable_pch_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
				    <span class="k">enum</span> <span class="n">pipe</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">PANEL_UNLOCK_REGS</span><span class="p">);</span>

	<span class="n">disable_pch_dp</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">PCH_DP_B</span><span class="p">,</span> <span class="n">TRANS_DP_PORT_SEL_B</span><span class="p">);</span>
	<span class="n">disable_pch_dp</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">PCH_DP_C</span><span class="p">,</span> <span class="n">TRANS_DP_PORT_SEL_C</span><span class="p">);</span>
	<span class="n">disable_pch_dp</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">PCH_DP_D</span><span class="p">,</span> <span class="n">TRANS_DP_PORT_SEL_D</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PCH_ADPA</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adpa_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ADPA_DAC_ENABLE</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">PCH_LVDS</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvds_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disable lvds on pipe %d val 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LVDS_PORT_EN</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">disable_pch_hdmi</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">HDMIB</span><span class="p">);</span>
	<span class="n">disable_pch_hdmi</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">HDMIC</span><span class="p">);</span>
	<span class="n">disable_pch_hdmi</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">HDMID</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">intel_pin_and_fence_fb_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">pipelined</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alignment</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_TILING_NONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_BROADWATER</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">alignment</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">alignment</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">alignment</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_TILING_X</span>:
		<span class="cm">/* pin() will align the object as required by fence */</span>
		<span class="n">alignment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_TILING_Y</span>:
		<span class="cm">/* FIXME: Is this true? */</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Y tiled not allowed for scan out buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin_to_display_plane</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">pipelined</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_interruptible</span><span class="p">;</span>

	<span class="cm">/* Install a fence for tiled scan-out. Pre-i965 always needs a</span>
<span class="cm">	 * fence, whereas 965+ only requires a fence if using</span>
<span class="cm">	 * framebuffer compression.  For simplicity, we always install</span>
<span class="cm">	 * a fence as the cost is not that onerous.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_get_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unpin</span><span class="p">;</span>

	<span class="n">i915_gem_object_pin_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unpin:</span>
	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">err_interruptible:</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_unpin_fb_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i915_gem_object_unpin_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i9xx_update_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Start</span><span class="p">,</span> <span class="n">Offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plane</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Can&#39;t update plane %d in SAREA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* Mask out pixel format bits in case we change it */</span>
	<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PIXFORMAT_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_8BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_15_16BPP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown color depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">!=</span> <span class="n">I915_TILING_NONE</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_TILED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_TILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="n">Start</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
	<span class="n">Offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Writing base %08lX %08lX %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">Start</span><span class="p">,</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPSTRIDE</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_MODIFY_DISPBASE</span><span class="p">(</span><span class="n">DSPSURF</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">Start</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPTILEOFF</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPADDR</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">Offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPADDR</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">Start</span> <span class="o">+</span> <span class="n">Offset</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ironlake_update_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Start</span><span class="p">,</span> <span class="n">Offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">plane</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Can&#39;t update plane %d in SAREA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* Mask out pixel format bits in case we change it */</span>
	<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_PIXFORMAT_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_8BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_16BPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_NO_ALPHA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">30</span><span class="p">)</span>
			<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_32BPP_30BIT_NO_ALPHA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Unknown color depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">!=</span> <span class="n">I915_TILING_NONE</span><span class="p">)</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_TILED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_TILED</span><span class="p">;</span>

	<span class="cm">/* must disable */</span>
	<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_TRICKLE_FEED_DISABLE</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">);</span>

	<span class="n">Start</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
	<span class="n">Offset</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Writing base %08lX %08lX %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">Start</span><span class="p">,</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPSTRIDE</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">I915_MODIFY_DISPBASE</span><span class="p">(</span><span class="n">DSPSURF</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">Start</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPTILEOFF</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPADDR</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">Offset</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Assume fb object is pinned &amp; idle &amp; fenced and just update base pointers */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_pipe_set_base_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="k">enum</span> <span class="n">mode_set_atomic</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">disable_fbc</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_increase_pllclock</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_plane</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_finish_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">old_fb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">was_interruptible</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pending_flip_queue</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pending_flip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Big Hammer, we also need to ensure that any pending</span>
<span class="cm">	 * MI_WAIT_FOR_EVENT inside a user batch buffer on the</span>
<span class="cm">	 * current scanout is retired before unpinning the old</span>
<span class="cm">	 * framebuffer.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This should only fail upon a hung GPU, in which case we</span>
<span class="cm">	 * can safely continue.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_finish_gpu</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="n">was_interruptible</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_pipe_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* no fb bound */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;No FB bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;no plane for crtc: plane %d, num_pipes %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">,</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pin_and_fence_fb_obj</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;pin &amp; fence failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_fb</span><span class="p">)</span>
		<span class="n">intel_finish_fb</span><span class="p">(</span><span class="n">old_fb</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_plane</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to update base address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">old_fb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_update_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeB_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeB_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeA_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeA_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_set_pll_edp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpa_ctl</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;eDP PLL enable for clock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
	<span class="n">dpa_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DP_A</span><span class="p">);</span>
	<span class="n">dpa_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_PLL_FREQ_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">dpa_ctl</span> <span class="o">|=</span> <span class="n">DP_PLL_FREQ_160MHZ</span><span class="p">;</span>
		<span class="cm">/* workaround for 160Mhz:</span>
<span class="cm">		   1) program 0x4600c bits 15:0 = 0x8124</span>
<span class="cm">		   2) program 0x46010 bit 0 = 1</span>
<span class="cm">		   3) program 0x46034 bit 24 = 1</span>
<span class="cm">		   4) program 0x64000 bit 14 = 1</span>
<span class="cm">		   */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x4600c</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="mh">0xffff0000</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="mh">0x4600c</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mh">0x8124</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x46010</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="mh">0x46010</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x46034</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="mh">0x46034</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dpa_ctl</span> <span class="o">|=</span> <span class="n">DP_PLL_FREQ_270MHZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DP_A</span><span class="p">,</span> <span class="n">dpa_ctl</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DP_A</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_fdi_normal_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* enable normal train */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE_IVB</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_NONE_IVB</span> <span class="o">|</span> <span class="n">FDI_TX_ENHANCE_FRAME_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_NONE</span> <span class="o">|</span> <span class="n">FDI_TX_ENHANCE_FRAME_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_PATTERN_MASK_CPT</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_NORMAL_CPT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_ENHANCE_FRAME_ENABLE</span><span class="p">);</span>

	<span class="cm">/* wait one idle pattern time */</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* IVB wants error correction enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">FDI_FS_ERRC_ENABLE</span> <span class="o">|</span>
			   <span class="n">FDI_FE_ERRC_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpt_phase_pointer_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">FDI_PHASE_SYNC_OVR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> <span class="cm">/* once to unlock... */</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">FDI_PHASE_SYNC_EN</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> <span class="cm">/* then again to enable */</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The FDI link training functions for ILK/Ibexpeak. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_fdi_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">tries</span><span class="p">;</span>

	<span class="cm">/* FDI needs bits from pipe &amp; plane first */</span>
	<span class="n">assert_pipe_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">assert_plane_enabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>

	<span class="cm">/* Train 1: umask FDI RX Interrupt symbol_lock and bit_lock bit</span>
<span class="cm">	   for train result */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IMR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_RX_BIT_LOCK</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* enable CPU FDI TX and PCH FDI RX */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">fdi_lanes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_TX_ENABLE</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_ENABLE</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* Ironlake workaround, enable clock pointer after FDI enable*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FDI_RX_CHICKEN</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">FDI_RX_PHASE_SYNC_POINTER_OVR</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FDI_RX_CHICKEN</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">FDI_RX_PHASE_SYNC_POINTER_OVR</span> <span class="o">|</span>
			   <span class="n">FDI_RX_PHASE_SYNC_POINTER_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">tries</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI_RX_IIR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FDI_RX_BIT_LOCK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train 1 done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_BIT_LOCK</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;FDI train 1 fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Train 2 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_2</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_2</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">tries</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI_RX_IIR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train 2 done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;FDI train 2 fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">snb_b_fdi_train_param</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">FDI_LINK_TRAIN_400MV_0DB_SNB_B</span><span class="p">,</span>
	<span class="n">FDI_LINK_TRAIN_400MV_6DB_SNB_B</span><span class="p">,</span>
	<span class="n">FDI_LINK_TRAIN_600MV_3_5DB_SNB_B</span><span class="p">,</span>
	<span class="n">FDI_LINK_TRAIN_800MV_0DB_SNB_B</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The FDI link training functions for SNB/Cougarpoint. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gen6_fdi_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">retry</span><span class="p">;</span>

	<span class="cm">/* Train 1: umask FDI RX Interrupt symbol_lock and bit_lock bit</span>
<span class="cm">	   for train result */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IMR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_RX_BIT_LOCK</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* enable CPU FDI TX and PCH FDI RX */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">fdi_lanes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
	<span class="cm">/* SNB-B */</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_400MV_0DB_SNB_B</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_TX_ENABLE</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_PATTERN_MASK_CPT</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1_CPT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_ENABLE</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">cpt_phase_pointer_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">snb_b_fdi_train_param</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI_RX_IIR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FDI_RX_BIT_LOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_BIT_LOCK</span><span class="p">);</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train 1 done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;FDI train 1 fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Train 2 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
		<span class="cm">/* SNB-B */</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_400MV_0DB_SNB_B</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_PATTERN_MASK_CPT</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_2_CPT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">snb_b_fdi_train_param</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI_RX_IIR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">);</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train 2 done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;FDI train 2 fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Manual link training for Ivy Bridge A0 parts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivb_manual_fdi_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Train 1: umask FDI RX Interrupt symbol_lock and bit_lock bit</span>
<span class="cm">	   for train result */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IMR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_RX_BIT_LOCK</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* enable CPU FDI TX and PCH FDI RX */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">fdi_lanes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FDI_LINK_TRAIN_AUTO</span> <span class="o">|</span> <span class="n">FDI_LINK_TRAIN_NONE_IVB</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1_IVB</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_400MV_0DB_SNB_B</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_COMPOSITE_SYNC</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_TX_ENABLE</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_AUTO</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_PATTERN_MASK_CPT</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1_CPT</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_COMPOSITE_SYNC</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_ENABLE</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">cpt_phase_pointer_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">snb_b_fdi_train_param</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI_RX_IIR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FDI_RX_BIT_LOCK</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FDI_RX_BIT_LOCK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_BIT_LOCK</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train 1 done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;FDI train 1 fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Train 2 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE_IVB</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_2_IVB</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_400MV_0DB_SNB_B</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_PATTERN_MASK_CPT</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_2_CPT</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_VOL_EMP_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">snb_b_fdi_train_param</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_IIR</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI_RX_IIR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_SYMBOL_LOCK</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train 2 done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;FDI train 2 fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;FDI train done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_fdi_pll_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Write the TU size bits so error detection works */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FDI_RX_TUSIZE1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPE_DATA_M1</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">TU_SIZE_MASK</span><span class="p">);</span>

	<span class="cm">/* enable PCH FDI RX PLL, wait warmup plus DMI latency */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">fdi_lanes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PIPE_BPC_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_RX_PLL_ENABLE</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* Switch from Rawclk to PCDclk */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_PCDCLK</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* On Haswell, the PLL configuration for ports and pipes is handled</span>
<span class="cm">	 * separately, as part of DDI setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable CPU FDI TX PLL, always on for Ironlake */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FDI_TX_PLL_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">FDI_TX_PLL_ENABLE</span><span class="p">);</span>

			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpt_phase_pointer_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FDI_PHASE_SYNC_EN</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> <span class="cm">/* once to disable... */</span>
	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FDI_PHASE_SYNC_OVR</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> <span class="cm">/* then again to lock */</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">SOUTH_CHICKEN1</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_fdi_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* disable CPU FDI tx and PCH FDI rx */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FDI_TX_ENABLE</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PIPE_BPC_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FDI_RX_ENABLE</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Ironlake workaround, disable clock pointer after downing FDI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FDI_RX_CHICKEN</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">FDI_RX_PHASE_SYNC_POINTER_OVR</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FDI_RX_CHICKEN</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">FDI_RX_CHICKEN</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="o">&amp;</span>
				     <span class="o">~</span><span class="n">FDI_RX_PHASE_SYNC_POINTER_EN</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cpt_phase_pointer_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* still set train pattern 1 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_PATTERN_MASK_CPT</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1_CPT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FDI_LINK_TRAIN_NONE</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">FDI_LINK_TRAIN_PATTERN_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* BPC in FDI rx is consistent with that in PIPECONF */</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PIPE_BPC_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_wait_for_pending_flips</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">intel_finish_fb</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_crtc_driving_pch</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there&#39;s a non-PCH eDP on this crtc, it must be DP_A, and that</span>
<span class="cm">	 * must be driven by its own crtc; no sharing is possible.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* On Haswell, LPT PCH handles the VGA connection via FDI, and Haswell</span>
<span class="cm">		 * CPU handles all others */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* It is still unclear how this will work on PPT, so throw up a warning */</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">HAS_PCH_LPT</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DRM_MODE_ENCODER_DAC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Haswell detected DAC encoder, assuming is PCH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Haswell detected encoder %d, assuming is CPU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_EDP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_encoder_is_pch_edp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Program iCLKIP clock to the desired frequency */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lpt_program_iclkip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">divsel</span><span class="p">,</span> <span class="n">phaseinc</span><span class="p">,</span> <span class="n">auxdiv</span><span class="p">,</span> <span class="n">phasedir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* It is necessary to ungate the pixclk gate prior to programming</span>
<span class="cm">	 * the divisors, and gate it back when it is done.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIXCLK_GATE</span><span class="p">,</span> <span class="n">PIXCLK_GATE_GATE</span><span class="p">);</span>

	<span class="cm">/* Disable SSCCTL */</span>
	<span class="n">intel_sbi_write</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">SBI_SSCCTL6</span><span class="p">,</span>
				<span class="n">intel_sbi_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">SBI_SSCCTL6</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">SBI_SSCCTL_DISABLE</span><span class="p">);</span>

	<span class="cm">/* 20MHz is a corner case which is out of range for the 7-bit divisor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span> <span class="o">==</span> <span class="mi">20000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">auxdiv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">divsel</span> <span class="o">=</span> <span class="mh">0x41</span><span class="p">;</span>
		<span class="n">phaseinc</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The iCLK virtual clock root frequency is in MHz,</span>
<span class="cm">		 * but the crtc-&gt;mode.clock in in KHz. To get the divisors,</span>
<span class="cm">		 * it is necessary to divide one by another, so we</span>
<span class="cm">		 * convert the virtual clock precision to KHz here for higher</span>
<span class="cm">		 * precision.</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="n">iclk_virtual_root_freq</span> <span class="o">=</span> <span class="mi">172800</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">iclk_pi_range</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">desired_divisor</span><span class="p">,</span> <span class="n">msb_divisor_value</span><span class="p">,</span> <span class="n">pi_value</span><span class="p">;</span>

		<span class="n">desired_divisor</span> <span class="o">=</span> <span class="p">(</span><span class="n">iclk_virtual_root_freq</span> <span class="o">/</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">);</span>
		<span class="n">msb_divisor_value</span> <span class="o">=</span> <span class="n">desired_divisor</span> <span class="o">/</span> <span class="n">iclk_pi_range</span><span class="p">;</span>
		<span class="n">pi_value</span> <span class="o">=</span> <span class="n">desired_divisor</span> <span class="o">%</span> <span class="n">iclk_pi_range</span><span class="p">;</span>

		<span class="n">auxdiv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">divsel</span> <span class="o">=</span> <span class="n">msb_divisor_value</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">phaseinc</span> <span class="o">=</span> <span class="n">pi_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This should not happen with any sane values */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">SBI_SSCDIVINTPHASE_DIVSEL</span><span class="p">(</span><span class="n">divsel</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="n">SBI_SSCDIVINTPHASE_DIVSEL_MASK</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">SBI_SSCDIVINTPHASE_DIR</span><span class="p">(</span><span class="n">phasedir</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="n">SBI_SSCDIVINTPHASE_INCVAL_MASK</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;iCLKIP clock: found settings for %dKHz refresh rate: auxdiv=%x, divsel=%x, phasedir=%x, phaseinc=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">clock</span><span class="p">,</span>
			<span class="n">auxdiv</span><span class="p">,</span>
			<span class="n">divsel</span><span class="p">,</span>
			<span class="n">phasedir</span><span class="p">,</span>
			<span class="n">phaseinc</span><span class="p">);</span>

	<span class="cm">/* Program SSCDIVINTPHASE6 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">intel_sbi_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">SBI_SSCDIVINTPHASE6</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SBI_SSCDIVINTPHASE_DIVSEL_MASK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">SBI_SSCDIVINTPHASE_DIVSEL</span><span class="p">(</span><span class="n">divsel</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SBI_SSCDIVINTPHASE_INCVAL_MASK</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">SBI_SSCDIVINTPHASE_INCVAL</span><span class="p">(</span><span class="n">phaseinc</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">SBI_SSCDIVINTPHASE_DIR</span><span class="p">(</span><span class="n">phasedir</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">SBI_SSCDIVINTPHASE_PROPAGATE</span><span class="p">;</span>

	<span class="n">intel_sbi_write</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
			<span class="n">SBI_SSCDIVINTPHASE6</span><span class="p">,</span>
			<span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Program SSCAUXDIV */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">intel_sbi_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">SBI_SSCAUXDIV6</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SBI_SSCAUXDIV_FINALDIV2SEL</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">SBI_SSCAUXDIV_FINALDIV2SEL</span><span class="p">(</span><span class="n">auxdiv</span><span class="p">);</span>
	<span class="n">intel_sbi_write</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
			<span class="n">SBI_SSCAUXDIV6</span><span class="p">,</span>
			<span class="n">temp</span><span class="p">);</span>


	<span class="cm">/* Enable modulator and associated divider */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">intel_sbi_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">SBI_SSCCTL6</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SBI_SSCCTL_DISABLE</span><span class="p">;</span>
	<span class="n">intel_sbi_write</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
			<span class="n">SBI_SSCCTL6</span><span class="p">,</span>
			<span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Wait for initialization time */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">24</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIXCLK_GATE</span><span class="p">,</span> <span class="n">PIXCLK_GATE_UNGATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enable PCH resources required for PCH ports:</span>
<span class="cm"> *   - PCH PLLs</span>
<span class="cm"> *   - FDI training &amp; RX/TX</span>
<span class="cm"> *   - update transcoder timings</span>
<span class="cm"> *   - DP transcoding bits</span>
<span class="cm"> *   - transcoder</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_pch_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">assert_transcoder_disabled</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* For PCH output, training FDI link */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fdi_link_train</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">intel_enable_pch_pll</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_LPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;LPT detected: programming iCLKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lpt_program_iclkip</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">sel</span><span class="p">;</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DPLL_SEL</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANSA_DPLL_ENABLE</span><span class="p">;</span>
			<span class="n">sel</span> <span class="o">=</span> <span class="n">TRANSA_DPLLB_SEL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANSB_DPLL_ENABLE</span><span class="p">;</span>
			<span class="n">sel</span> <span class="o">=</span> <span class="n">TRANSB_DPLLB_SEL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANSC_DPLL_ENABLE</span><span class="p">;</span>
			<span class="n">sel</span> <span class="o">=</span> <span class="n">TRANSC_DPLLB_SEL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span> <span class="o">==</span> <span class="n">_PCH_DPLL_B</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">sel</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">sel</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DPLL_SEL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set transcoder timing, panel must allow it */</span>
	<span class="n">assert_panel_unlocked</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_HTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_HBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_HSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>  <span class="n">I915_READ</span><span class="p">(</span><span class="n">HSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_VTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_VBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_VSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>  <span class="n">I915_READ</span><span class="p">(</span><span class="n">VSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANS_VSYNCSHIFT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>  <span class="n">I915_READ</span><span class="p">(</span><span class="n">VSYNCSHIFT</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_fdi_normal_train</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* For PCH DP, enable TRANS_DP_CTL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_EDP</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">bpc</span> <span class="o">=</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PIPE_BPC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">TRANS_DP_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TRANS_DP_PORT_SEL_MASK</span> <span class="o">|</span>
			  <span class="n">TRANS_DP_SYNC_MASK</span> <span class="o">|</span>
			  <span class="n">TRANS_DP_BPC_MASK</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TRANS_DP_OUTPUT_ENABLE</span> <span class="o">|</span>
			 <span class="n">TRANS_DP_ENH_FRAMING</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">bpc</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* same format but at 11:9 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PHSYNC</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANS_DP_HSYNC_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANS_DP_VSYNC_ACTIVE_HIGH</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">intel_trans_dp_port_sel</span><span class="p">(</span><span class="n">crtc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCH_DP_B</span>:
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANS_DP_PORT_SEL_B</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCH_DP_C</span>:
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANS_DP_PORT_SEL_C</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCH_DP_D</span>:
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANS_DP_PORT_SEL_D</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Wrong PCH DP port return. Guess port B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANS_DP_PORT_SEL_B</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_enable_transcoder</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_put_pch_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_pch_pll</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;bad PCH PLL refcount</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">--</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_pch_pll</span> <span class="o">*</span><span class="nf">intel_get_pch_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dpll</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_pch_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pll</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRTC:%d reusing existing PCH PLL %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">prepare</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Ironlake PCH has a fixed PLL-&gt;PCH pipe mapping. */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
		<span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_plls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRTC:%d using pre-allocated PCH PLL %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pch_pll</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_plls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* Only want to check enabled timings first */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">==</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fp</span> <span class="o">==</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">fp0_reg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRTC:%d sharing existing PCH PLL %x (refcount %d, ative %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
				      <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Ok no matching timings, maybe there&#39;s a free one? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pch_pll</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_plls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRTC:%d allocated PCH PLL %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span> <span class="o">=</span> <span class="n">pll</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="o">++</span><span class="p">;</span>
	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;using pll %d for pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
<span class="nl">prepare:</span> <span class="cm">/* separate function? */</span>
	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;switching PLL %x off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>

	<span class="cm">/* Wait for the clocks to stabilize before rewriting the regs */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">fp0_reg</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pll</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_cpt_verify_modeset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dslreg</span> <span class="o">=</span> <span class="n">PIPEDSL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">tc2reg</span> <span class="o">=</span> <span class="n">TRANS_CHICKEN2</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dslreg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">dslreg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Without this, mode sets may fail silently on FDI */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">tc2reg</span><span class="p">,</span> <span class="n">TRANS_AUTOTRAIN_GEN_STALL_DIS</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">tc2reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">dslreg</span><span class="p">)</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;mode set failed: pipe %d stuck</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_crtc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_pch_port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">intel_update_watermarks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_LVDS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_LVDS</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">LVDS_PORT_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">is_pch_port</span> <span class="o">=</span> <span class="n">intel_crtc_driving_pch</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pch_port</span><span class="p">)</span>
		<span class="n">ironlake_fdi_pll_enable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ironlake_fdi_disable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* Enable panel fitting for LVDS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_pf_size</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">||</span> <span class="n">HAS_eDP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Force use of hard-coded filter coefficients</span>
<span class="cm">		 * as some pre-programmed values are broken,</span>
<span class="cm">		 * e.g. x201.</span>
<span class="cm">		 */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PF_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">PF_ENABLE</span> <span class="o">|</span> <span class="n">PF_FILTER_MED_3x3</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PF_WIN_POS</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_pf_pos</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PF_WIN_SZ</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_pf_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * On ILK+ LUT must be loaded before the pipe is running but with</span>
<span class="cm">	 * clocks enabled</span>
<span class="cm">	 */</span>
	<span class="n">intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">intel_enable_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">is_pch_port</span><span class="p">);</span>
	<span class="n">intel_enable_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_pch_port</span><span class="p">)</span>
		<span class="n">ironlake_pch_enable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">intel_update_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_crtc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">intel_crtc_wait_for_pending_flips</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">drm_vblank_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">intel_disable_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_plane</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)</span>
		<span class="n">intel_disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_disable_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="cm">/* Disable PF */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PF_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PF_WIN_SZ</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ironlake_fdi_disable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* This is a horrible layering violation; we should be doing this in</span>
<span class="cm">	 * the connector/encoder -&gt;prepare instead, but we don&#39;t always have</span>
<span class="cm">	 * enough information there about the config to know whether it will</span>
<span class="cm">	 * actually be necessary or just cause undesired flicker.</span>
<span class="cm">	 */</span>
	<span class="n">intel_disable_pch_ports</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">intel_disable_transcoder</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* disable TRANS_DP_CTL */</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">TRANS_DP_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TRANS_DP_OUTPUT_ENABLE</span> <span class="o">|</span> <span class="n">TRANS_DP_PORT_SEL_MASK</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">TRANS_DP_PORT_SEL_NONE</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

		<span class="cm">/* disable DPLL_SEL */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DPLL_SEL</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TRANSA_DPLL_ENABLE</span> <span class="o">|</span> <span class="n">TRANSA_DPLLB_SEL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TRANSB_DPLL_ENABLE</span> <span class="o">|</span> <span class="n">TRANSB_DPLLB_SEL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* C shares PLL A or B */</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TRANSC_DPLL_ENABLE</span> <span class="o">|</span> <span class="n">TRANSC_DPLLB_SEL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span> <span class="cm">/* wtf */</span>
		<span class="p">}</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DPLL_SEL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable PCH DPLL */</span>
	<span class="n">intel_disable_pch_pll</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">);</span>

	<span class="cm">/* Switch from PCDclk to Rawclk */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FDI_PCDCLK</span><span class="p">);</span>

	<span class="cm">/* Disable CPU FDI TX PLL */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_TX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FDI_TX_PLL_ENABLE</span><span class="p">);</span>

	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">FDI_RX_CTL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FDI_RX_PLL_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Wait for the clocks to turn off. */</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">intel_update_watermarks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">intel_update_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>

	<span class="cm">/* XXX: When our outputs are all unaware of DPMS modes other than off</span>
<span class="cm">	 * and on, we should map those modes to DRM_MODE_DPMS_OFF in the CRTC.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;crtc %d/%d dpms on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
		<span class="n">ironlake_crtc_enable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;crtc %d/%d dpms off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
		<span class="n">ironlake_crtc_disable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_crtc_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">intel_put_pch_pll</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_dpms_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">intel_overlay_switch_off</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">interruptible</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Let userspace switch the overlay on again. In most cases userspace</span>
<span class="cm">	 * has to recompute where to put it anyway.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_crtc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">intel_update_watermarks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_enable_pll</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">intel_enable_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">intel_enable_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">intel_update_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Give the overlay scaler a chance to enable if it&#39;s on this pipe */</span>
	<span class="n">intel_crtc_dpms_overlay</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_crtc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Give the overlay scaler a chance to disable if it&#39;s on this pipe */</span>
	<span class="n">intel_crtc_wait_for_pending_flips</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">drm_vblank_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">intel_crtc_dpms_overlay</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cfb_plane</span> <span class="o">==</span> <span class="n">plane</span><span class="p">)</span>
		<span class="n">intel_disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_disable_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">intel_disable_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">intel_disable_pll</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">intel_update_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_update_watermarks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX: When our outputs are all unaware of DPMS modes other than off</span>
<span class="cm">	 * and on, we should map those modes to DRM_MODE_DPMS_OFF in the CRTC.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="n">i9xx_crtc_enable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="n">i9xx_crtc_disable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_crtc_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets the power management mode of the pipe and plane.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">enabled</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeA_w</span> <span class="o">=</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeA_h</span> <span class="o">=</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeB_w</span> <span class="o">=</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pipeB_h</span> <span class="o">=</span> <span class="n">enabled</span> <span class="o">?</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Can&#39;t update pipe %c in SAREA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">off</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">assert_plane_disabled</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">,</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">assert_pipe_disabled</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">,</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Prepare for a mode set.</span>
<span class="cm"> *</span>
<span class="cm"> * Note we could be a lot smarter here.  We need to figure out which outputs</span>
<span class="cm"> * will be enabled, which disabled (in short, how the config will changes)</span>
<span class="cm"> * and perform the minimum necessary steps to accomplish that, e.g. updating</span>
<span class="cm"> * watermarks, FBC configuration, making sure PLLs are programmed correctly,</span>
<span class="cm"> * panel fitting is in the proper state, etc.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i9xx_crtc_disable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i9xx_crtc_enable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ironlake_crtc_disable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ironlake_crtc_enable</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_encoder_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="cm">/* lvds has its own version of prepare see intel_lvds_prepare */</span>
	<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_encoder_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* lvds has its own version of commit see intel_lvds_commit */</span>
	<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_cpt_verify_modeset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_encoder_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span> <span class="o">=</span> <span class="n">to_intel_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="n">drm_encoder_cleanup</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">intel_encoder</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_crtc_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FDI link clock is fixed at 2.7G */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">&gt;</span> <span class="n">IRONLAKE_FDI_FREQ</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All interlaced capable intel hw wants timings in frames. Note though</span>
<span class="cm">	 * that intel_lvds_mode_fixup does some funny tricks with the crtc</span>
<span class="cm">	 * timings, so we need to be careful not to clobber these.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">private_flags</span> <span class="o">&amp;</span> <span class="n">INTEL_MODE_CRTC_TIMINGS_SET</span><span class="p">))</span>
		<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">valleyview_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">400000</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i945_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">400000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">333000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i9xx_misc_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">200000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915gm_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">gcfgc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">GCFGC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gcfgc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gcfgc</span> <span class="o">&amp;</span> <span class="n">GC_LOW_FREQUENCY_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">133000</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">gcfgc</span> <span class="o">&amp;</span> <span class="n">GC_DISPLAY_CLOCK_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GC_DISPLAY_CLOCK_333_MHZ</span>:
			<span class="k">return</span> <span class="mi">333000</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">GC_DISPLAY_CLOCK_190_200_MHZ</span>:
			<span class="k">return</span> <span class="mi">190000</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i865_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">266000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i855_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">hpllcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Assume that the hardware is in the high speed state.  This</span>
<span class="cm">	 * should be the default.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hpllcc</span> <span class="o">&amp;</span> <span class="n">GC_CLOCK_CONTROL_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GC_CLOCK_133_200</span>:
	<span class="k">case</span> <span class="n">GC_CLOCK_100_200</span>:
		<span class="k">return</span> <span class="mi">200000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GC_CLOCK_166_250</span>:
		<span class="k">return</span> <span class="mi">250000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GC_CLOCK_100_133</span>:
		<span class="k">return</span> <span class="mi">133000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Shouldn&#39;t happen */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i830_get_display_clock_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">133000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">fdi_m_n</span> <span class="p">{</span>
	<span class="n">u32</span>        <span class="n">tu</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">gmch_m</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">gmch_n</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">link_m</span><span class="p">;</span>
	<span class="n">u32</span>        <span class="n">link_n</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fdi_reduce_ratio</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">den</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mh">0xffffff</span> <span class="o">||</span> <span class="o">*</span><span class="n">den</span> <span class="o">&gt;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">num</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">den</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ironlake_compute_m_n</span><span class="p">(</span><span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nlanes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixel_clock</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">link_clock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fdi_m_n</span> <span class="o">*</span><span class="n">m_n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">tu</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="cm">/* default size */</span>

	<span class="cm">/* BUG_ON(pixel_clock &gt; INT_MAX / 36); */</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_m</span> <span class="o">=</span> <span class="n">bits_per_pixel</span> <span class="o">*</span> <span class="n">pixel_clock</span><span class="p">;</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_n</span> <span class="o">=</span> <span class="n">link_clock</span> <span class="o">*</span> <span class="n">nlanes</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fdi_reduce_ratio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_n</span><span class="p">);</span>

	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_m</span> <span class="o">=</span> <span class="n">pixel_clock</span><span class="p">;</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_n</span> <span class="o">=</span> <span class="n">link_clock</span><span class="p">;</span>
	<span class="n">fdi_reduce_ratio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">intel_panel_use_ssc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i915_panel_use_ssc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i915_panel_use_ssc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_use_ssc</span>
		<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">QUIRK_LVDS_SSC_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_choose_pipe_bpp_dither - figure out what color depth the pipe should send</span>
<span class="cm"> * @crtc: CRTC structure</span>
<span class="cm"> * @mode: requested mode</span>
<span class="cm"> *</span>
<span class="cm"> * A pipe may be connected to one or more outputs.  Based on the depth of the</span>
<span class="cm"> * attached framebuffer, choose a good color depth to use on the pipe.</span>
<span class="cm"> *</span>
<span class="cm"> * If possible, match the pipe depth to the fb depth.  In some cases, this</span>
<span class="cm"> * isn&#39;t ideal, because the connected output supports a lesser or restricted</span>
<span class="cm"> * set of depths.  Resolve that here:</span>
<span class="cm"> *    LVDS typically supports only 6bpc, so clamp down in that case</span>
<span class="cm"> *    HDMI supports only 8bpc or 12bpc, so clamp to 8bpc with dither for 10bpc</span>
<span class="cm"> *    Displays may support a restricted set as well, check EDID and clamp as</span>
<span class="cm"> *      appropriate.</span>
<span class="cm"> *    DP may want to dither down to 6bpc to fit larger modes</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Dithering requirement (i.e. false if display bpc and pipe bpc match,</span>
<span class="cm"> * true if they don&#39;t match).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_choose_pipe_bpp_dither</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pipe_bpp</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">display_bpc</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span> <span class="n">bpc</span><span class="p">;</span>

	<span class="cm">/* Walk the encoders &amp; connectors on this crtc, get min bpc */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span> <span class="o">=</span> <span class="n">to_intel_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lvds_bpc</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_A3_POWER_MASK</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">LVDS_A3_POWER_UP</span><span class="p">)</span>
				<span class="n">lvds_bpc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">lvds_bpc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lvds_bpc</span> <span class="o">&lt;</span> <span class="n">display_bpc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;clamping display bpc (was %d) to LVDS (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">display_bpc</span><span class="p">,</span> <span class="n">lvds_bpc</span><span class="p">);</span>
				<span class="n">display_bpc</span> <span class="o">=</span> <span class="n">lvds_bpc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_EDP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Use VBT settings if we have an eDP panel */</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">edp_bpc</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">edp</span><span class="p">.</span><span class="n">bpp</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">edp_bpc</span> <span class="o">&lt;</span> <span class="n">display_bpc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;clamping display bpc (was %d) to eDP (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">display_bpc</span><span class="p">,</span> <span class="n">edp_bpc</span><span class="p">);</span>
				<span class="n">display_bpc</span> <span class="o">=</span> <span class="n">edp_bpc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Not one of the known troublemakers, check the EDID */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span>
				    <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">!=</span> <span class="n">encoder</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Don&#39;t use an invalid EDID bpc value */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">bpc</span> <span class="o">&amp;&amp;</span>
			    <span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">bpc</span> <span class="o">&lt;</span> <span class="n">display_bpc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;clamping display bpc (was %d) to EDID reported max of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">display_bpc</span><span class="p">,</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">bpc</span><span class="p">);</span>
				<span class="n">display_bpc</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">bpc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * HDMI is either 12 or 8, so if the display lets 10bpc sneak</span>
<span class="cm">		 * through, clamp it down.  (Note: &gt;12bpc will be caught below.)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_HDMI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">display_bpc</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">display_bpc</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;forcing bpc to 12 for HDMI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">display_bpc</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;forcing bpc to 8 for HDMI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">display_bpc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">private_flags</span> <span class="o">&amp;</span> <span class="n">INTEL_MODE_DP_FORCE_6BPC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Dithering DP to 6bpc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">display_bpc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could just drive the pipe at the highest bpc all the time and</span>
<span class="cm">	 * enable dithering as needed, but that costs bandwidth.  So choose</span>
<span class="cm">	 * the minimum value that expresses the full color range of the fb but</span>
<span class="cm">	 * also stays within the max display bpc discovered above.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">bpc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* since we go through a colormap */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">bpc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* min is 18bpp */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">bpc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">30</span>:
		<span class="n">bpc</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48</span>:
		<span class="n">bpc</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;unsupported depth, assuming 24 bits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bpc</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mi">8</span><span class="p">,</span> <span class="n">display_bpc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">display_bpc</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">display_bpc</span><span class="p">,</span> <span class="n">bpc</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;setting pipe bpc to %d (max display bpc %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">bpc</span><span class="p">,</span> <span class="n">display_bpc</span><span class="p">);</span>

	<span class="o">*</span><span class="n">pipe_bpp</span> <span class="o">=</span> <span class="n">display_bpc</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">display_bpc</span> <span class="o">!=</span> <span class="n">bpc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i9xx_get_refclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_connectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refclk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num_connectors</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">refclk</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_ssc_freq</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;using SSC reference clock of %d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">refclk</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">refclk</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">refclk</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">refclk</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_adjust_sdvo_tv_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
				      <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* SDVO TV has fixed PLL values depend on its clock range,</span>
<span class="cm">	   this mirrors vbios setting. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">100000</span>
	    <span class="o">&amp;&amp;</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="mi">140500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">140500</span>
		   <span class="o">&amp;&amp;</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_update_pll_dividers</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				     <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span>
				     <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">reduced_clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fp</span><span class="p">,</span> <span class="n">fp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reduced_clock</span><span class="p">)</span>
			<span class="n">fp2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">reduced_clock</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
				<span class="n">reduced_clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">reduced_clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reduced_clock</span><span class="p">)</span>
			<span class="n">fp2</span> <span class="o">=</span> <span class="n">reduced_clock</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">reduced_clock</span><span class="o">-&gt;</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
				<span class="n">reduced_clock</span><span class="o">-&gt;</span><span class="n">m2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FP0</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lowfreq_avail</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">reduced_clock</span> <span class="o">&amp;&amp;</span> <span class="n">i915_powersave</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FP1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">fp2</span><span class="p">);</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lowfreq_avail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">FP1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_update_lvds</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_PORT_EN</span> <span class="o">|</span> <span class="n">LVDS_A0A2_CLKA_POWER_UP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_PIPEB_SELECT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_PIPEB_SELECT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* set the corresponsding LVDS_BORDER bit */</span>
	<span class="n">temp</span> <span class="o">|=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_border_bits</span><span class="p">;</span>
	<span class="cm">/* Set the B0-B3 data pairs corresponding to whether we&#39;re going to</span>
<span class="cm">	 * set the DPLLs for dual-channel mode or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">);</span>

	<span class="cm">/* It would be nice to set 24 vs 18-bit mode (LVDS_A3_POWER_UP)</span>
<span class="cm">	 * appropriately here, but we need to look more thoroughly into how</span>
<span class="cm">	 * panels behave in the two modes.</span>
<span class="cm">	 */</span>
	<span class="cm">/* set the dithering flag on LVDS as needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_dither</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_ENABLE_DITHER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_ENABLE_DITHER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_HSYNC_POLARITY</span> <span class="o">|</span> <span class="n">LVDS_VSYNC_POLARITY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_HSYNC_POLARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_VSYNC_POLARITY</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">LVDS</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_update_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			    <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span> <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">reduced_clock</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">num_connectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_sdvo</span><span class="p">;</span>

	<span class="n">is_sdvo</span> <span class="o">=</span> <span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_SDVO</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_HDMI</span><span class="p">);</span>

	<span class="n">dpll</span> <span class="o">=</span> <span class="n">DPLL_VGA_MODE_DIS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_MODE_LVDS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_MODE_DAC_SERIAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pixel_multiplier</span> <span class="o">=</span> <span class="n">intel_mode_get_pixel_multiplier</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixel_multiplier</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_G33</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pixel_multiplier</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SDVO_MULTIPLIER_SHIFT_HIRES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DVO_HIGH_SPEED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span><span class="p">))</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DVO_HIGH_SPEED</span><span class="p">;</span>

	<span class="cm">/* compute bitmask from p1 value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT_PINEVIEW</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">reduced_clock</span><span class="p">)</span>
			<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">reduced_clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_FPA1_P1_POST_DIV_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DAC_SERIAL_P2_CLOCK_DIV_5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_LVDS_P2_CLOCK_DIV_7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DAC_SERIAL_P2_CLOCK_DIV_10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_LVDS_P2_CLOCK_DIV_14</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="n">PLL_LOAD_PULSE_PHASE_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span> <span class="o">&amp;&amp;</span> <span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_TVOUT</span><span class="p">))</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_REF_INPUT_TVCLKINBC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_TVOUT</span><span class="p">))</span>
		<span class="cm">/* XXX: just matching BIOS for now */</span>
		<span class="cm">/*	dpll |= PLL_REF_INPUT_TVCLKINBC; */</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num_connectors</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLLB_REF_INPUT_SPREADSPECTRUMIN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_REF_INPUT_DREFCLK</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* The LVDS pin pair needs to be on before the DPLLs are enabled.</span>
<span class="cm">	 * This is an exception to the general rule that mode_set doesn&#39;t turn</span>
<span class="cm">	 * things on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span>
		<span class="n">intel_update_lvds</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span><span class="p">))</span>
		<span class="n">intel_dp_set_m_n</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dpll</span><span class="p">);</span>

	<span class="cm">/* Wait for the clocks to stabilize. */</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">intel_mode_get_pixel_multiplier</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_MD_UDI_MULTIPLIER_SHIFT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPLL_MD</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The pixel multiplier can only be updated once the</span>
<span class="cm">		 * DPLL is enabled and the clocks are stable.</span>
<span class="cm">		 *</span>
<span class="cm">		 * So write it again.</span>
<span class="cm">		 */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dpll</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i8xx_update_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			    <span class="n">intel_clock_t</span> <span class="o">*</span><span class="n">clock</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">num_connectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">=</span> <span class="n">DPLL_VGA_MODE_DIS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_P1_DIVIDE_BY_TWO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_P2_DIVIDE_BY_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_TVOUT</span><span class="p">))</span>
		<span class="cm">/* XXX: just matching BIOS for now */</span>
		<span class="cm">/*	dpll |= PLL_REF_INPUT_TVCLKINBC; */</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num_connectors</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLLB_REF_INPUT_SPREADSPECTRUMIN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_REF_INPUT_DREFCLK</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_VCO_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DPLL_VCO_ENABLE</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dpll</span><span class="p">);</span>

	<span class="cm">/* Wait for the clocks to stabilize. */</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* The LVDS pin pair needs to be on before the DPLLs are enabled.</span>
<span class="cm">	 * This is an exception to the general rule that mode_set doesn&#39;t turn</span>
<span class="cm">	 * things on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_LVDS</span><span class="p">))</span>
		<span class="n">intel_update_lvds</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="cm">/* The pixel multiplier can only be updated once the</span>
<span class="cm">	 * DPLL is enabled and the clocks are stable.</span>
<span class="cm">	 *</span>
<span class="cm">	 * So write it again.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">dpll</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i9xx_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">num_connectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intel_clock_t</span> <span class="n">clock</span><span class="p">,</span> <span class="n">reduced_clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dspcntr</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">,</span> <span class="n">vsyncshift</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ok</span><span class="p">,</span> <span class="n">has_reduced_clock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_tv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_dp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_LVDS</span>:
			<span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_SDVO</span>:
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_HDMI</span>:
			<span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">needs_tv_clock</span><span class="p">)</span>
				<span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_TVOUT</span>:
			<span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span>:
			<span class="n">is_dp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">num_connectors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">refclk</span> <span class="o">=</span> <span class="n">i9xx_get_refclk</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">num_connectors</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Returns a set of divisors for the desired target clock with the given</span>
<span class="cm">	 * refclk, or FALSE.  The returned values represent the clock equation:</span>
<span class="cm">	 * reflck * (5 * (m1 + 2) + (m2 + 2)) / (n + 2) / p1 / p2.</span>
<span class="cm">	 */</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="n">intel_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">refclk</span><span class="p">);</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">find_pll</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find PLL settings for mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that the cursor is valid for the new mode before changing... */</span>
	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_downclock_avail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ensure we match the reduced clock&#39;s P to the target clock.</span>
<span class="cm">		 * If the clocks don&#39;t match, we can&#39;t switch the display clock</span>
<span class="cm">		 * by using the FP0/FP1. In such case we will disable the LVDS</span>
<span class="cm">		 * downclock feature.</span>
<span class="cm">		*/</span>
		<span class="n">has_reduced_clock</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">find_pll</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span>
						    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_downclock</span><span class="p">,</span>
						    <span class="n">refclk</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">reduced_clock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span> <span class="o">&amp;&amp;</span> <span class="n">is_tv</span><span class="p">)</span>
		<span class="n">i9xx_adjust_sdvo_tv_clock</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>

	<span class="n">i9xx_update_pll_dividers</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span> <span class="n">has_reduced_clock</span> <span class="o">?</span>
				 <span class="o">&amp;</span><span class="n">reduced_clock</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">i8xx_update_pll</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span> <span class="n">num_connectors</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">i9xx_update_pll</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span>
				<span class="n">has_reduced_clock</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">reduced_clock</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">num_connectors</span><span class="p">);</span>

	<span class="cm">/* setup pipeconf */</span>
	<span class="n">pipeconf</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="cm">/* Set up the display plane register */</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">DISPPLANE_GAMMA_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dspcntr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPPLANE_SEL_PIPE_MASK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dspcntr</span> <span class="o">|=</span> <span class="n">DISPPLANE_SEL_PIPE_B</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable pixel doubling when the dot clock is &gt; 90% of the (display)</span>
<span class="cm">		 * core speed.</span>
<span class="cm">		 *</span>
<span class="cm">		 * XXX: No double-wide on 915GM pipe B. Is that the only reason for the</span>
<span class="cm">		 * pipe == 0 check?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;</span>
		    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_DOUBLE_WIDE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_DOUBLE_WIDE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* default to 8bpc */</span>
	<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PIPECONF_BPP_MASK</span> <span class="o">|</span> <span class="n">PIPECONF_DITHER_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">private_flags</span> <span class="o">&amp;</span> <span class="n">INTEL_MODE_DP_FORCE_6BPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_BPP_6</span> <span class="o">|</span>
				    <span class="n">PIPECONF_DITHER_EN</span> <span class="o">|</span>
				    <span class="n">PIPECONF_DITHER_TYPE_SP</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Mode for pipe %c:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span> <span class="o">:</span> <span class="sc">&#39;B&#39;</span><span class="p">);</span>
	<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PIPE_CXSR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lowfreq_avail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;enabling CxSR downclocking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_CXSR_DOWNCLOCK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disabling CxSR downclocking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_CXSR_DOWNCLOCK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_INTERLACE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_INTERLACE_W_FIELD_INDICATION</span><span class="p">;</span>
		<span class="cm">/* the chip adds 2 halflines automatically */</span>
		<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vsyncshift</span> <span class="o">=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span>
			     <span class="o">-</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_PROGRESSIVE</span><span class="p">;</span>
		<span class="n">vsyncshift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN3</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VSYNCSHIFT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">vsyncshift</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* pipesrc and dspsize control the size that is scaled from,</span>
<span class="cm">	 * which should always be the user&#39;s requested size.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPSIZE</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span>
		   <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPPOS</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESRC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">pipeconf</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">intel_enable_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">dspcntr</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pipe_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>

	<span class="n">intel_update_watermarks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize reference clocks when the driver loads</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ironlake_init_pch_refclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_cpu_edp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_pch_edp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_panel</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_ck505</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">can_ssc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* We need to take the global config into account */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span>
			    <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_LVDS</span>:
			<span class="n">has_panel</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">has_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_EDP</span>:
			<span class="n">has_panel</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_encoder_is_pch_edp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span>
				<span class="n">has_pch_edp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">has_cpu_edp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">has_ck505</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display_clock_mode</span><span class="p">;</span>
		<span class="n">can_ssc</span> <span class="o">=</span> <span class="n">has_ck505</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">has_ck505</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">can_ssc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;has_panel %d has_lvds %d has_pch_edp %d has_cpu_edp %d has_ck505 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">has_panel</span><span class="p">,</span> <span class="n">has_lvds</span><span class="p">,</span> <span class="n">has_pch_edp</span><span class="p">,</span> <span class="n">has_cpu_edp</span><span class="p">,</span>
		      <span class="n">has_ck505</span><span class="p">);</span>

	<span class="cm">/* Ironlake: try to setup display ref clock before DPLL</span>
<span class="cm">	 * enabling. This is only under driver&#39;s control after</span>
<span class="cm">	 * PCH B stepping, previous chipset stepping should be</span>
<span class="cm">	 * ignoring this setting.</span>
<span class="cm">	 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">);</span>
	<span class="cm">/* Always enable nonspread source */</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DREF_NONSPREAD_SOURCE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_ck505</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_NONSPREAD_CK505_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_NONSPREAD_SOURCE_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_panel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DREF_SSC_SOURCE_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_SSC_SOURCE_ENABLE</span><span class="p">;</span>

		<span class="cm">/* SSC must be turned on before enabling the CPU output  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">can_ssc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Using SSC on panel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_SSC1_ENABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DREF_SSC1_ENABLE</span><span class="p">;</span>

		<span class="cm">/* Get SSC going before enabling the outputs */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DREF_CPU_SOURCE_OUTPUT_MASK</span><span class="p">;</span>

		<span class="cm">/* Enable CPU source on CPU attached eDP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_cpu_edp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">can_ssc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Using SSC on eDP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_CPU_SOURCE_OUTPUT_DOWNSPREAD</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_CPU_SOURCE_OUTPUT_NONSPREAD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_CPU_SOURCE_OUTPUT_DISABLE</span><span class="p">;</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Disabling SSC entirely</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DREF_CPU_SOURCE_OUTPUT_MASK</span><span class="p">;</span>

		<span class="cm">/* Turn off CPU output */</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_CPU_SOURCE_OUTPUT_DISABLE</span><span class="p">;</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

		<span class="cm">/* Turn off the SSC source */</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DREF_SSC_SOURCE_MASK</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">DREF_SSC_SOURCE_DISABLE</span><span class="p">;</span>

		<span class="cm">/* Turn off SSC1 */</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">DREF_SSC1_ENABLE</span><span class="p">;</span>

		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_DREF_CONTROL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ironlake_get_refclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">edp_encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_connectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_LVDS</span>:
			<span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_EDP</span>:
			<span class="n">edp_encoder</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">num_connectors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span> <span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num_connectors</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;using SSC reference clock of %d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_ssc_freq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_ssc_freq</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">120000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ironlake_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refclk</span><span class="p">,</span> <span class="n">num_connectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intel_clock_t</span> <span class="n">clock</span><span class="p">,</span> <span class="n">reduced_clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span><span class="p">,</span> <span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dspcntr</span><span class="p">,</span> <span class="n">pipeconf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ok</span><span class="p">,</span> <span class="n">has_reduced_clock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_crt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_tv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_dp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="o">*</span><span class="n">edp_encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">intel_limit_t</span> <span class="o">*</span><span class="n">limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fdi_m_n</span> <span class="n">m_n</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">target_clock</span><span class="p">,</span> <span class="n">pixel_multiplier</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">link_bw</span><span class="p">,</span> <span class="n">factor</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe_bpp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dither</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_cpu_edp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">is_pch_edp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_LVDS</span>:
			<span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_SDVO</span>:
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_HDMI</span>:
			<span class="n">is_sdvo</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">needs_tv_clock</span><span class="p">)</span>
				<span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_TVOUT</span>:
			<span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_ANALOG</span>:
			<span class="n">is_crt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span>:
			<span class="n">is_dp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INTEL_OUTPUT_EDP</span>:
			<span class="n">is_dp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_encoder_is_pch_edp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">))</span>
				<span class="n">is_pch_edp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">is_cpu_edp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">edp_encoder</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">num_connectors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">refclk</span> <span class="o">=</span> <span class="n">ironlake_get_refclk</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Returns a set of divisors for the desired target clock with the given</span>
<span class="cm">	 * refclk, or FALSE.  The returned values represent the clock equation:</span>
<span class="cm">	 * reflck * (5 * (m1 + 2) + (m2 + 2)) / (n + 2) / p1 / p2.</span>
<span class="cm">	 */</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="n">intel_limit</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">refclk</span><span class="p">);</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">find_pll</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">refclk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t find PLL settings for mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that the cursor is valid for the new mode before changing... */</span>
	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_downclock_avail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ensure we match the reduced clock&#39;s P to the target clock.</span>
<span class="cm">		 * If the clocks don&#39;t match, we can&#39;t switch the display clock</span>
<span class="cm">		 * by using the FP0/FP1. In such case we will disable the LVDS</span>
<span class="cm">		 * downclock feature.</span>
<span class="cm">		*/</span>
		<span class="n">has_reduced_clock</span> <span class="o">=</span> <span class="n">limit</span><span class="o">-&gt;</span><span class="n">find_pll</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span>
						    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_downclock</span><span class="p">,</span>
						    <span class="n">refclk</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">clock</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">reduced_clock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* SDVO TV has fixed PLL values depend on its clock range,</span>
<span class="cm">	   this mirrors vbios setting. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span> <span class="o">&amp;&amp;</span> <span class="n">is_tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">100000</span>
		    <span class="o">&amp;&amp;</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="mi">140500</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">140500</span>
			   <span class="o">&amp;&amp;</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;=</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* FDI link */</span>
	<span class="n">pixel_multiplier</span> <span class="o">=</span> <span class="n">intel_mode_get_pixel_multiplier</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* CPU eDP doesn&#39;t require FDI link, so just set DP M/N</span>
<span class="cm">	   according to current link config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_cpu_edp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">target_clock</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="n">intel_edp_link_config</span><span class="p">(</span><span class="n">edp_encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lane</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link_bw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* [e]DP over FDI requires target mode clock</span>
<span class="cm">		   instead of link clock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span><span class="p">)</span>
			<span class="n">target_clock</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">target_clock</span> <span class="o">=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>

		<span class="cm">/* FDI is a binary signal running at ~2.7GHz, encoding</span>
<span class="cm">		 * each output octet as 10 bits. The actual frequency</span>
<span class="cm">		 * is stored as a divider into a 100MHz clock, and the</span>
<span class="cm">		 * mode pixel clock is stored in units of 1KHz.</span>
<span class="cm">		 * Hence the bw of each lane in terms of the mode signal</span>
<span class="cm">		 * is:</span>
<span class="cm">		 */</span>
		<span class="n">link_bw</span> <span class="o">=</span> <span class="n">intel_fdi_link_freq</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">*</span> <span class="n">MHz</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="n">KHz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine panel color depth */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPE_BPC_MASK</span><span class="p">;</span>
	<span class="n">dither</span> <span class="o">=</span> <span class="n">intel_choose_pipe_bpp_dither</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pipe_bpp</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pipe_bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPE_6BPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPE_8BPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">30</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPE_10BPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">36</span>:
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPE_12BPC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;intel_choose_pipe_bpp returned invalid value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pipe_bpp</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">PIPE_8BPC</span><span class="p">;</span>
		<span class="n">pipe_bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">pipe_bpp</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lane</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Account for spread spectrum to avoid</span>
<span class="cm">		 * oversubscribing the link. Max center spread</span>
<span class="cm">		 * is 2.5%; use 5% for safety&#39;s sake.</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="n">bps</span> <span class="o">=</span> <span class="n">target_clock</span> <span class="o">*</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">*</span> <span class="mi">21</span> <span class="o">/</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">lane</span> <span class="o">=</span> <span class="n">bps</span> <span class="o">/</span> <span class="p">(</span><span class="n">link_bw</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">fdi_lanes</span> <span class="o">=</span> <span class="n">lane</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixel_multiplier</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">link_bw</span> <span class="o">*=</span> <span class="n">pixel_multiplier</span><span class="p">;</span>
	<span class="n">ironlake_compute_m_n</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">,</span> <span class="n">lane</span><span class="p">,</span> <span class="n">target_clock</span><span class="p">,</span> <span class="n">link_bw</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">m_n</span><span class="p">);</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">clock</span><span class="p">.</span><span class="n">m2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_reduced_clock</span><span class="p">)</span>
		<span class="n">fp2</span> <span class="o">=</span> <span class="n">reduced_clock</span><span class="p">.</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">reduced_clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">reduced_clock</span><span class="p">.</span><span class="n">m2</span><span class="p">;</span>

	<span class="cm">/* Enable autotuning of the PLL clock (if permissible) */</span>
	<span class="n">factor</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_ssc_freq</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_CLKB_POWER_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">)</span>
			<span class="n">factor</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span> <span class="o">&amp;&amp;</span> <span class="n">is_tv</span><span class="p">)</span>
		<span class="n">factor</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">m</span> <span class="o">&lt;</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">clock</span><span class="p">.</span><span class="n">n</span><span class="p">)</span>
		<span class="n">fp</span> <span class="o">|=</span> <span class="n">FP_CB_TUNE</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_MODE_LVDS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_MODE_DAC_SERIAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pixel_multiplier</span> <span class="o">=</span> <span class="n">intel_mode_get_pixel_multiplier</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixel_multiplier</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pixel_multiplier</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PLL_REF_SDVO_HDMI_MULTIPLIER_SHIFT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DVO_HIGH_SPEED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DVO_HIGH_SPEED</span><span class="p">;</span>

	<span class="cm">/* compute bitmask from p1 value */</span>
	<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">;</span>
	<span class="cm">/* also FPA1 */</span>
	<span class="n">dpll</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="n">DPLL_FPA1_P1_POST_DIV_SHIFT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DAC_SERIAL_P2_CLOCK_DIV_5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_LVDS_P2_CLOCK_DIV_7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLL_DAC_SERIAL_P2_CLOCK_DIV_10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DPLLB_LVDS_P2_CLOCK_DIV_14</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_sdvo</span> <span class="o">&amp;&amp;</span> <span class="n">is_tv</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_REF_INPUT_TVCLKINBC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_tv</span><span class="p">)</span>
		<span class="cm">/* XXX: just matching BIOS for now */</span>
		<span class="cm">/*	dpll |= PLL_REF_INPUT_TVCLKINBC; */</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span> <span class="n">intel_panel_use_ssc</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num_connectors</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLLB_REF_INPUT_SPREADSPECTRUMIN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">PLL_REF_INPUT_DREFCLK</span><span class="p">;</span>

	<span class="cm">/* setup pipeconf */</span>
	<span class="n">pipeconf</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="cm">/* Set up the display plane register */</span>
	<span class="n">dspcntr</span> <span class="o">=</span> <span class="n">DISPPLANE_GAMMA_ENABLE</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Mode for pipe %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* CPU eDP is the only output that doesn&#39;t need a PCH PLL of its own on</span>
<span class="cm">	 * pre-Haswell/LPT generation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_LPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;LPT detected: no PLL for pipe %d necessary</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_pch_pll</span> <span class="o">*</span><span class="n">pll</span><span class="p">;</span>

		<span class="n">pll</span> <span class="o">=</span> <span class="n">intel_get_pch_pll</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">,</span> <span class="n">dpll</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;failed to find PLL for pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">pipe</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">intel_put_pch_pll</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">);</span>

	<span class="cm">/* The LVDS pin pair needs to be on before the DPLLs are enabled.</span>
<span class="cm">	 * This is an exception to the general rule that mode_set doesn&#39;t turn</span>
<span class="cm">	 * things on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_LVDS</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_PORT_EN</span> <span class="o">|</span> <span class="n">LVDS_A0A2_CLKA_POWER_UP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_TRANS_SEL_MASK</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">PORT_TRANS_SEL_CPT</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_PIPEB_SELECT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LVDS_PIPEB_SELECT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set the corresponsding LVDS_BORDER bit */</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_border_bits</span><span class="p">;</span>
		<span class="cm">/* Set the B0-B3 data pairs corresponding to whether we&#39;re going to</span>
<span class="cm">		 * set the DPLLs for dual-channel mode or not.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_B0B3_POWER_UP</span> <span class="o">|</span> <span class="n">LVDS_CLKB_POWER_UP</span><span class="p">);</span>

		<span class="cm">/* It would be nice to set 24 vs 18-bit mode (LVDS_A3_POWER_UP)</span>
<span class="cm">		 * appropriately here, but we need to look more thoroughly into how</span>
<span class="cm">		 * panels behave in the two modes.</span>
<span class="cm">		 */</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">LVDS_HSYNC_POLARITY</span> <span class="o">|</span> <span class="n">LVDS_VSYNC_POLARITY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_HSYNC_POLARITY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">LVDS_VSYNC_POLARITY</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_LVDS</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_DITHER_EN</span><span class="p">;</span>
	<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_DITHER_TYPE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_dither</span><span class="p">)</span> <span class="o">||</span> <span class="n">dither</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_DITHER_EN</span><span class="p">;</span>
		<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_DITHER_TYPE_SP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_dp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_dp_set_m_n</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* For non-DP output, clear any trans DP clock recovery setting.*/</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDATA_M1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDATA_N1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDPLINK_M1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDPLINK_N1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>

		<span class="cm">/* Wait for the clocks to stabilize. */</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>

		<span class="cm">/* The pixel multiplier can only be updated once the</span>
<span class="cm">		 * DPLL is enabled and the clocks are stable.</span>
<span class="cm">		 *</span>
<span class="cm">		 * So write it again.</span>
<span class="cm">		 */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="o">-&gt;</span><span class="n">pll_reg</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lowfreq_avail</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span> <span class="n">has_reduced_clock</span> <span class="o">&amp;&amp;</span> <span class="n">i915_powersave</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="o">-&gt;</span><span class="n">fp1_reg</span><span class="p">,</span> <span class="n">fp2</span><span class="p">);</span>
			<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lowfreq_avail</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PIPE_CXSR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;enabling CxSR downclocking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_CXSR_DOWNCLOCK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pch_pll</span><span class="o">-&gt;</span><span class="n">fp1_reg</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PIPE_CXSR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;disabling CxSR downclocking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_CXSR_DOWNCLOCK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pipeconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIPECONF_INTERLACE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_INTERLACED_ILK</span><span class="p">;</span>
		<span class="cm">/* the chip adds 2 halflines automatically */</span>
		<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VSYNCSHIFT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span>
			   <span class="o">-</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pipeconf</span> <span class="o">|=</span> <span class="n">PIPECONF_PROGRESSIVE</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VSYNCSHIFT</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_htotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_hsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vtotal</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VBLANK</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vblank_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">VSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_start</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">crtc_vsync_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* pipesrc controls the size that is scaled from, which should</span>
<span class="cm">	 * always be the user&#39;s requested size.</span>
<span class="cm">	 */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPESRC</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
		   <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_DATA_M1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">TU_SIZE</span><span class="p">(</span><span class="n">m_n</span><span class="p">.</span><span class="n">tu</span><span class="p">)</span> <span class="o">|</span> <span class="n">m_n</span><span class="p">.</span><span class="n">gmch_m</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_DATA_N1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">gmch_n</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_LINK_M1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">link_m</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_LINK_N1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">link_n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_cpu_edp</span><span class="p">)</span>
		<span class="n">ironlake_set_pll_edp</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">pipeconf</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">),</span> <span class="n">dspcntr</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pipe_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>

	<span class="n">intel_update_watermarks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_update_linetime_watermarks</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">drm_vblank_pre_modeset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">crtc_mode_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">,</span>
					      <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>
	<span class="n">drm_vblank_post_modeset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_eld_uptodate</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">reg_eldv</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">bits_eldv</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">reg_elda</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">bits_elda</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">reg_edid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">eld</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">eld</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg_eldv</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">&amp;=</span> <span class="n">bits_eldv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eld</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg_elda</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits_elda</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg_elda</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eld</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">reg_edid</span><span class="p">)</span> <span class="o">!=</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">eld</span> <span class="o">+</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">g4x_write_eld</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">eld</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">eld</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">eldv</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">G4X_AUD_VID_DID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">INTEL_AUDIO_DEVBLC</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="n">INTEL_AUDIO_DEVCL</span><span class="p">)</span>
		<span class="n">eldv</span> <span class="o">=</span> <span class="n">G4X_ELDV_DEVCL_DEVBLC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">eldv</span> <span class="o">=</span> <span class="n">G4X_ELDV_DEVCTG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_eld_uptodate</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
			       <span class="n">G4X_AUD_CNTL_ST</span><span class="p">,</span> <span class="n">eldv</span><span class="p">,</span>
			       <span class="n">G4X_AUD_CNTL_ST</span><span class="p">,</span> <span class="n">G4X_ELD_ADDR</span><span class="p">,</span>
			       <span class="n">G4X_HDMIW_HDMIEDID</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">G4X_AUD_CNTL_ST</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">eldv</span> <span class="o">|</span> <span class="n">G4X_ELD_ADDR</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>		<span class="cm">/* ELD buffer size */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">G4X_AUD_CNTL_ST</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eld</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">,</span> <span class="n">eld</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;ELD size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">G4X_HDMIW_HDMIEDID</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">eld</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">G4X_AUD_CNTL_ST</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="n">eldv</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">G4X_AUD_CNTL_ST</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_write_eld</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">eld</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">eld</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">eldv</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdmiw_hdmiedid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aud_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aud_cntl_st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aud_cntrl_st2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_IBX</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdmiw_hdmiedid</span> <span class="o">=</span> <span class="n">IBX_HDMIW_HDMIEDID_A</span><span class="p">;</span>
		<span class="n">aud_config</span> <span class="o">=</span> <span class="n">IBX_AUD_CONFIG_A</span><span class="p">;</span>
		<span class="n">aud_cntl_st</span> <span class="o">=</span> <span class="n">IBX_AUD_CNTL_ST_A</span><span class="p">;</span>
		<span class="n">aud_cntrl_st2</span> <span class="o">=</span> <span class="n">IBX_AUD_CNTL_ST2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdmiw_hdmiedid</span> <span class="o">=</span> <span class="n">CPT_HDMIW_HDMIEDID_A</span><span class="p">;</span>
		<span class="n">aud_config</span> <span class="o">=</span> <span class="n">CPT_AUD_CONFIG_A</span><span class="p">;</span>
		<span class="n">aud_cntl_st</span> <span class="o">=</span> <span class="n">CPT_AUD_CNTL_ST_A</span><span class="p">;</span>
		<span class="n">aud_cntrl_st2</span> <span class="o">=</span> <span class="n">CPT_AUD_CNTRL_ST2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">hdmiw_hdmiedid</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">aud_cntl_st</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">aud_config</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;ELD on pipe %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">aud_cntl_st</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>		<span class="cm">/* DIP_Port_Select, 0x1 = PortB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Audio directed to unknown port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* operate blindly on all ports */</span>
		<span class="n">eldv</span> <span class="o">=</span> <span class="n">IBX_ELD_VALIDB</span><span class="p">;</span>
		<span class="n">eldv</span> <span class="o">|=</span> <span class="n">IBX_ELD_VALIDB</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">eldv</span> <span class="o">|=</span> <span class="n">IBX_ELD_VALIDB</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;ELD on port %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">eldv</span> <span class="o">=</span> <span class="n">IBX_ELD_VALIDB</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_pipe_has_type</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;ELD: DisplayPort detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">eld</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Conn_Type, 0x1 = DisplayPort */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">aud_config</span><span class="p">,</span> <span class="n">AUD_CONFIG_N_VALUE_INDEX</span><span class="p">);</span> <span class="cm">/* 0x1 = DP */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">aud_config</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_eld_uptodate</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
			       <span class="n">aud_cntrl_st2</span><span class="p">,</span> <span class="n">eldv</span><span class="p">,</span>
			       <span class="n">aud_cntl_st</span><span class="p">,</span> <span class="n">IBX_ELD_ADDRESS</span><span class="p">,</span>
			       <span class="n">hdmiw_hdmiedid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">aud_cntrl_st2</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">eldv</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">aud_cntrl_st2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eld</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">aud_cntl_st</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IBX_ELD_ADDRESS</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">aud_cntl_st</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">,</span> <span class="n">eld</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">21</span><span class="p">);</span>	<span class="cm">/* 84 bytes of hw ELD buffer */</span>
	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;ELD size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">hdmiw_hdmiedid</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">eld</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">aud_cntrl_st2</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">|=</span> <span class="n">eldv</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">aud_cntrl_st2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_write_eld</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">connector</span> <span class="o">=</span> <span class="n">drm_select_eld</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;ELD on [CONNECTOR:%d:%s], [ENCODER:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			 <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
			 <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			 <span class="n">drm_get_encoder_name</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">));</span>

	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">eld</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">drm_av_sync_delay</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">write_eld</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">write_eld</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Loads the palette/gamma unit for the CRTC with the prepared values */</span>
<span class="kt">void</span> <span class="nf">intel_crtc_load_lut</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">palreg</span> <span class="o">=</span> <span class="n">PALETTE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* The clocks have to be on to load the palette. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* use legacy palette for Ironlake */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">palreg</span> <span class="o">=</span> <span class="n">LGC_PALETTE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">palreg</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i845_update_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">visible</span> <span class="o">=</span> <span class="n">base</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cntl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_visible</span> <span class="o">==</span> <span class="n">visible</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cntl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">_CURACNTR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">visible</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* On these chipsets we can only modify the base whilst</span>
<span class="cm">		 * the cursor is disabled.</span>
<span class="cm">		 */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">_CURABASE</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

		<span class="n">cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CURSOR_FORMAT_MASK</span><span class="p">);</span>
		<span class="cm">/* XXX width must be 64, stride 256 =&gt; 0x00 &lt;&lt; 28 */</span>
		<span class="n">cntl</span> <span class="o">|=</span> <span class="n">CURSOR_ENABLE</span> <span class="o">|</span>
			<span class="n">CURSOR_GAMMA_ENABLE</span> <span class="o">|</span>
			<span class="n">CURSOR_FORMAT_ARGB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CURSOR_ENABLE</span> <span class="o">|</span> <span class="n">CURSOR_GAMMA_ENABLE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">_CURACNTR</span><span class="p">,</span> <span class="n">cntl</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_visible</span> <span class="o">=</span> <span class="n">visible</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i9xx_update_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">visible</span> <span class="o">=</span> <span class="n">base</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_visible</span> <span class="o">!=</span> <span class="n">visible</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">cntl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CURCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CURSOR_MODE</span> <span class="o">|</span> <span class="n">MCURSOR_PIPE_SELECT</span><span class="p">);</span>
			<span class="n">cntl</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_64_ARGB_AX</span> <span class="o">|</span> <span class="n">MCURSOR_GAMMA_ENABLE</span><span class="p">;</span>
			<span class="n">cntl</span> <span class="o">|=</span> <span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span> <span class="cm">/* Connect to correct pipe */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CURSOR_MODE</span> <span class="o">|</span> <span class="n">MCURSOR_GAMMA_ENABLE</span><span class="p">);</span>
			<span class="n">cntl</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_DISABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CURCNTR</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">cntl</span><span class="p">);</span>

		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_visible</span> <span class="o">=</span> <span class="n">visible</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* and commit changes on next vblank */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CURBASE</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivb_update_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">visible</span> <span class="o">=</span> <span class="n">base</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_visible</span> <span class="o">!=</span> <span class="n">visible</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">cntl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CURCNTR_IVB</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CURSOR_MODE</span><span class="p">;</span>
			<span class="n">cntl</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_64_ARGB_AX</span> <span class="o">|</span> <span class="n">MCURSOR_GAMMA_ENABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cntl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CURSOR_MODE</span> <span class="o">|</span> <span class="n">MCURSOR_GAMMA_ENABLE</span><span class="p">);</span>
			<span class="n">cntl</span> <span class="o">|=</span> <span class="n">CURSOR_MODE_DISABLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CURCNTR_IVB</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">cntl</span><span class="p">);</span>

		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_visible</span> <span class="o">=</span> <span class="n">visible</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* and commit changes on next vblank */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CURBASE_IVB</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* If no-part of the cursor is visible on the framebuffer, then the GPU may hang... */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_update_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				     <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">base</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">visible</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pos</span> <span class="o">|=</span> <span class="n">CURSOR_POS_SIGN</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_X_SHIFT</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">|=</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_X_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_height</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pos</span> <span class="o">|=</span> <span class="n">CURSOR_POS_SIGN</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_Y_SHIFT</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">|=</span> <span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="n">CURSOR_Y_SHIFT</span><span class="p">;</span>

	<span class="n">visible</span> <span class="o">=</span> <span class="n">base</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">visible</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_visible</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CURPOS_IVB</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">pos</span><span class="p">);</span>
		<span class="n">ivb_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CURPOS</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_845G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I865G</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">i845_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">i9xx_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_crtc_cursor_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">handle</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">width</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* if we want to turn off the cursor ignore width and height */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;cursor off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Currently we only support 64x64 cursors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">!=</span> <span class="mi">64</span> <span class="o">||</span> <span class="n">height</span> <span class="o">!=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;we currently only support 64x64 cursors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer is to small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we only need to pin inside GTT if cursor is non-phy */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cursor_needs_physical</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;cursor cannot be tiled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_locked</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin_to_display_plane</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to move cursor bo into the GTT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_locked</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_put_fence</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to release fence for cursor&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_unpin</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">align</span> <span class="o">=</span> <span class="n">IS_I830</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">:</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_attach_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span>
						  <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">I915_GEM_PHYS_CURSOR_0</span> <span class="o">:</span> <span class="n">I915_GEM_PHYS_CURSOR_1</span><span class="p">,</span>
						  <span class="n">align</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to attach phys object</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_locked</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">CURSIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">width</span><span class="p">);</span>

 <span class="nl">finish:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_bo</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cursor_needs_physical</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_bo</span> <span class="o">!=</span> <span class="n">obj</span><span class="p">)</span>
				<span class="n">i915_gem_detach_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_bo</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_bo</span><span class="p">);</span>
		<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_bo</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>

	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail_unpin:</span>
	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">fail_locked:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_crtc_cursor_move</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">cursor_y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>

	<span class="n">intel_crtc_update_cursor</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Sets the color ramps on behalf of RandR */</span>
<span class="kt">void</span> <span class="nf">intel_crtc_fb_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="n">green</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_crtc_fb_gamma_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="o">*</span><span class="n">red</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">green</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">blue</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">start</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">start</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Get a pipe with a simple mode set on it for doing load-based monitor</span>
<span class="cm"> * detection.</span>
<span class="cm"> *</span>
<span class="cm"> * It will be up to the load-detect code to adjust the pipe as appropriate for</span>
<span class="cm"> * its requirements.  The pipe will be connected to no other encoders.</span>
<span class="cm"> *</span>
<span class="cm"> * Currently this code will only succeed if there is a pipe with no encoders</span>
<span class="cm"> * configured for it.  In the future, it could choose to temporarily disable</span>
<span class="cm"> * some outputs to free up a pipe for its use.</span>
<span class="cm"> *</span>
<span class="cm"> * \return crtc, or NULL if no pipes are available.</span>
<span class="cm"> */</span>

<span class="cm">/* VESA 640x480x72Hz mode to set on the pipe */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="n">load_detect_mode</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;640x480&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DEFAULT</span><span class="p">,</span> <span class="mi">31500</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">664</span><span class="p">,</span>
		 <span class="mi">704</span><span class="p">,</span> <span class="mi">832</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">489</span><span class="p">,</span> <span class="mi">491</span><span class="p">,</span> <span class="mi">520</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DRM_MODE_FLAG_NHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span>
<span class="nf">intel_framebuffer_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">mode_cmd</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">intel_fb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_framebuffer_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_fb</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">intel_fb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">intel_framebuffer_pitch_for_width</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">intel_framebuffer_size_for_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pitch</span> <span class="o">=</span> <span class="n">intel_framebuffer_pitch_for_width</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">pitch</span> <span class="o">*</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span>
<span class="nf">intel_framebuffer_create_for_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="n">mode_cmd</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">i915_gem_alloc_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">intel_framebuffer_size_for_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">bpp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">intel_framebuffer_pitch_for_width</span><span class="p">(</span><span class="n">mode_cmd</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
								<span class="n">bpp</span><span class="p">);</span>
	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">pixel_format</span> <span class="o">=</span> <span class="n">drm_mode_legacy_fb_format</span><span class="p">(</span><span class="n">bpp</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">intel_framebuffer_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_cmd</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span>
<span class="nf">mode_fits_in_fbdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ifb</span><span class="p">.</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="o">-&gt;</span><span class="n">ifb</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">intel_framebuffer_pitch_for_width</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">,</span>
							       <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fb</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">intel_get_load_detect_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">intel_load_detect_pipe</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">possible_crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s], [ENCODER:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
		      <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_encoder_name</span><span class="p">(</span><span class="n">encoder</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Algorithm gets a little messy:</span>
<span class="cm">	 *</span>
<span class="cm">	 *   - if the connector already has an assigned crtc, use it (but make</span>
<span class="cm">	 *     sure it&#39;s on first)</span>
<span class="cm">	 *</span>
<span class="cm">	 *   - try to find the first unused crtc that can drive this connector,</span>
<span class="cm">	 *     and use that if we find one</span>
<span class="cm">	 */</span>

	<span class="cm">/* See if we already have a CRTC for this connector */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>

		<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span><span class="p">;</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">load_detect_temp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Make sure the crtc and connector are running */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">!=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span><span class="p">;</span>

			<span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>

			<span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find an unused one (if possible) */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">possible_crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">possible_crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crtc</span> <span class="o">=</span> <span class="n">possible_crtc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we didn&#39;t find an unused CRTC, don&#39;t use any.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;no pipe available for load-detect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">;</span>

	<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">old</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span><span class="p">;</span>
	<span class="n">old</span><span class="o">-&gt;</span><span class="n">load_detect_temp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">load_detect_mode</span><span class="p">;</span>

	<span class="n">old_fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>

	<span class="cm">/* We need a framebuffer large enough to accommodate all accesses</span>
<span class="cm">	 * that the plane may generate whilst we perform load detection.</span>
<span class="cm">	 * We can not rely on the fbcon either being present (we get called</span>
<span class="cm">	 * during its initialisation to detect all boot displays, or it may</span>
<span class="cm">	 * not even exist) or that it is large enough to satisfy the</span>
<span class="cm">	 * requested mode.</span>
<span class="cm">	 */</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">mode_fits_in_fbdev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;creating tmp fb for load-detection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">intel_framebuffer_create_for_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;reusing fbdev for load-detection framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;failed to allocate framebuffer for load-detection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">old_fb</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;failed to set mode on load-detect pipe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span><span class="p">)</span>
			<span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">old_fb</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* let the connector get through one full cycle before testing */</span>
	<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_release_load_detect_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">intel_load_detect_pipe</span> <span class="o">*</span><span class="n">old</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s], [ENCODER:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
		      <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_encoder_name</span><span class="p">(</span><span class="n">encoder</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">load_detect_temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">drm_helper_disable_unused_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span><span class="p">)</span>
			<span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">release_fb</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Switch crtc and encoder back off if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">!=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">dpms_mode</span><span class="p">);</span>
		<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">dpms_mode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Returns the clock of the currently programmed mode of the given pipe. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_crtc_clock_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpll</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">fp</span><span class="p">;</span>
	<span class="n">intel_clock_t</span> <span class="n">clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FP0</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FP1</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="n">clock</span><span class="p">.</span><span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_M1_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M1_DIV_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">((</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_N_PINEVIEW_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIV_SHIFT</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_M2_PINEVIEW_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIV_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_N_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_N_DIV_SHIFT</span><span class="p">;</span>
		<span class="n">clock</span><span class="p">.</span><span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;</span> <span class="n">FP_M2_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">FP_M2_DIV_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_MASK_PINEVIEW</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT_PINEVIEW</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			       <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_MODE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DPLLB_MODE_DAC_SERIAL</span>:
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_DAC_SERIAL_P2_CLOCK_DIV_5</span> <span class="o">?</span>
				<span class="mi">5</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DPLLB_MODE_LVDS</span>:
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLLB_LVDS_P2_CLOCK_DIV_7</span> <span class="o">?</span>
				<span class="mi">7</span> <span class="o">:</span> <span class="mi">14</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown DPLL mode %08x in programmed &quot;</span>
				  <span class="s">&quot;mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_MODE_MASK</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* XXX: Handle the 100Mhz refclk */</span>
		<span class="n">intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">96000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">is_lvds</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">LVDS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LVDS_PORT_EN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_MASK_I830_LVDS</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				       <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">);</span>
			<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_REF_INPUT_MASK</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">PLLB_REF_INPUT_SPREADSPECTRUMIN</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* XXX: might not be 66MHz */</span>
				<span class="n">intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">66000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_P1_DIVIDE_BY_TWO</span><span class="p">)</span>
				<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">clock</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="p">((</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DPLL_FPA01_P1_POST_DIV_MASK_I830</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					    <span class="n">DPLL_FPA01_P1_POST_DIV_SHIFT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">PLL_P2_DIVIDE_BY_4</span><span class="p">)</span>
				<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">clock</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">intel_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* XXX: It would be nice to validate the clocks, but we can&#39;t reuse</span>
<span class="cm">	 * i830PllIsValid() because it relies on the xf86_config connector</span>
<span class="cm">	 * configuration being accurate, which it isn&#39;t necessarily.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">clock</span><span class="p">.</span><span class="n">dot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Returns the currently programmed mode of the given pipe. */</span>
<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="nf">intel_crtc_mode_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">htot</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">hsync</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">vtot</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VTOTAL</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">vsync</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VSYNC</span><span class="p">(</span><span class="n">pipe</span><span class="p">));</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">intel_crtc_clock_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">htot</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="p">((</span><span class="n">htot</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">hsync</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">hsync</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="p">(</span><span class="n">vtot</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="p">((</span><span class="n">vtot</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">vsync</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="p">((</span><span class="n">vsync</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">drm_mode_set_name</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define GPU_IDLE_TIMEOUT 500 </span><span class="cm">/* ms */</span><span class="cp"></span>

<span class="cm">/* When this timer fires, we&#39;ve been idle for awhile */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_gpu_idle_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Still processing requests, so just re-arm the timer. */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">GPU_IDLE_TIMEOUT</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define CRTC_IDLE_TIMEOUT 1000 </span><span class="cm">/* ms */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_idle_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">;</span>

	<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_fb</span> <span class="o">&amp;&amp;</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The framebuffer is still being accessed by the GPU. */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CRTC_IDLE_TIMEOUT</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_increase_pllclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dpll_reg</span> <span class="o">=</span> <span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dpll</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_downclock_avail</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dpll</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_PIPE_CXSR</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;upclocking LVDS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">assert_panel_unlocked</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

		<span class="n">dpll</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
		<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

		<span class="n">dpll</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;failed to upclock LVDS!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Schedule downclock */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
		  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CRTC_IDLE_TIMEOUT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_decrease_pllclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lvds_downclock_avail</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since this is called by a timer, we should never get here in</span>
<span class="cm">	 * the manual case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_PIPE_CXSR</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lowfreq_avail</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dpll_reg</span> <span class="o">=</span> <span class="n">DPLL</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">dpll</span><span class="p">;</span>

		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;downclocking LVDS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">assert_panel_unlocked</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>

		<span class="n">dpll</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">);</span>
		<span class="n">dpll</span> <span class="o">|=</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">,</span> <span class="n">dpll</span><span class="p">);</span>
		<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="n">dpll</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">dpll_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dpll</span> <span class="o">&amp;</span> <span class="n">DISPLAY_RATE_SELECT_FPA1</span><span class="p">))</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;failed to downclock LVDS!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_idle_update - adjust clocks for idleness</span>
<span class="cm"> * @work: work struct</span>
<span class="cm"> *</span>
<span class="cm"> * Either the GPU or display (or both) went idle.  Check the busy status</span>
<span class="cm"> * here and adjust the CRTC and GPU clocks as necessary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_idle_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">drm_i915_private_t</span><span class="p">,</span>
						    <span class="n">idle_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i915_powersave</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">i915_update_gfx_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Skip inactive CRTCs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span>
			<span class="n">intel_decrease_pllclock</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_mark_busy - mark the GPU and possibly the display busy</span>
<span class="cm"> * @dev: drm device</span>
<span class="cm"> * @obj: object we&#39;re operating on</span>
<span class="cm"> *</span>
<span class="cm"> * Callers can use this function to indicate that the GPU is busy processing</span>
<span class="cm"> * commands.  If @obj matches one of the CRTC objects (i.e. it&#39;s a scanout</span>
<span class="cm"> * buffer), we&#39;ll also mark the display as busy, so we know to increase its</span>
<span class="cm"> * clock frequency.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">intel_mark_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sanitize_pm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
			  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">GPU_IDLE_TIMEOUT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">==</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Non-busy -&gt; busy, upclock */</span>
				<span class="n">intel_increase_pllclock</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
				<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Busy -&gt; busy, put off timer */</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
					  <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CRTC_IDLE_TIMEOUT</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_unpin_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">work</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drm_crtc_cleanup</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">intel_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_unpin_work_fn</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">__work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_unpin_work</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">__work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_unpin_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">pending_flip_obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">intel_update_fbc</span><span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_intel_finish_page_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_unpin_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_pending_vblank_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tnow</span><span class="p">,</span> <span class="n">tvbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Ignore early vblank irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnow</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">work</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">drm_vblank_count_and_time</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvbl</span><span class="p">);</span>

		<span class="cm">/* Called before vblank count and timestamps have</span>
<span class="cm">		 * been updated for the vblank interval of flip</span>
<span class="cm">		 * completion? Need to increment vblank count and</span>
<span class="cm">		 * add one videorefresh duration to returned timestamp</span>
<span class="cm">		 * to account for this. We assume this happened if we</span>
<span class="cm">		 * get called over 0.9 frame durations after the last</span>
<span class="cm">		 * timestamped vblank.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This calculation can not be used with vrefresh rates</span>
<span class="cm">		 * below 5Hz (10Hz to be on the safe side) without</span>
<span class="cm">		 * promoting to 64 integers.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="n">timeval_to_ns</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tnow</span><span class="p">)</span> <span class="o">-</span> <span class="n">timeval_to_ns</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tvbl</span><span class="p">))</span> <span class="o">&gt;</span>
		    <span class="mi">9</span> <span class="o">*</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">framedur_ns</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">sequence</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tvbl</span> <span class="o">=</span> <span class="n">ns_to_timeval</span><span class="p">(</span><span class="n">timeval_to_ns</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tvbl</span><span class="p">)</span> <span class="o">+</span>
					     <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">framedur_ns</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">tvbl</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">tvbl</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">link</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">event_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drm_vblank_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="p">;</span>

	<span class="n">atomic_clear_mask</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pending_flip</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pending_flip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pending_flip_queue</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="n">trace_i915_flip_complete</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">pending_flip_obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_finish_page_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>

	<span class="n">do_intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_finish_page_flip_plane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">[</span><span class="n">plane</span><span class="p">];</span>

	<span class="n">do_intel_finish_page_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_prepare_page_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span>
		<span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">[</span><span class="n">plane</span><span class="p">]);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">++</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Prepared flip multiple times</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;preparing flip with no unpin work?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_gen2_queue_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flip_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pin_and_fence_fb_obj</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Offset into the new buffer for cases of shared fbs between CRTCs */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unpin</span><span class="p">;</span>

	<span class="cm">/* Can&#39;t queue multiple flips, so wait for the previous</span>
<span class="cm">	 * one to finish before executing the next.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">)</span>
		<span class="n">flip_mask</span> <span class="o">=</span> <span class="n">MI_WAIT_FOR_PLANE_B_FLIP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flip_mask</span> <span class="o">=</span> <span class="n">MI_WAIT_FOR_PLANE_A_FLIP</span><span class="p">;</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_WAIT_FOR_EVENT</span> <span class="o">|</span> <span class="n">flip_mask</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_NOOP</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_DISPLAY_FLIP</span> <span class="o">|</span>
			<span class="n">MI_DISPLAY_FLIP_PLANE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">));</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* aux display base address, unused */</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unpin:</span>
	<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_gen3_queue_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flip_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pin_and_fence_fb_obj</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Offset into the new buffer for cases of shared fbs between CRTCs */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unpin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">)</span>
		<span class="n">flip_mask</span> <span class="o">=</span> <span class="n">MI_WAIT_FOR_PLANE_B_FLIP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flip_mask</span> <span class="o">=</span> <span class="n">MI_WAIT_FOR_PLANE_A_FLIP</span><span class="p">;</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_WAIT_FOR_EVENT</span> <span class="o">|</span> <span class="n">flip_mask</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_NOOP</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_DISPLAY_FLIP_I915</span> <span class="o">|</span>
			<span class="n">MI_DISPLAY_FLIP_PLANE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">));</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_NOOP</span><span class="p">);</span>

	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unpin:</span>
	<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_gen4_queue_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">pf</span><span class="p">,</span> <span class="n">pipesrc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pin_and_fence_fb_obj</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unpin</span><span class="p">;</span>

	<span class="cm">/* i965+ uses the linear or tiled offsets from the</span>
<span class="cm">	 * Display Registers (which do not change across a page-flip)</span>
<span class="cm">	 * so we need only reprogram the base address.</span>
<span class="cm">	 */</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_DISPLAY_FLIP</span> <span class="o">|</span>
			<span class="n">MI_DISPLAY_FLIP_PLANE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">));</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">|</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">);</span>

	<span class="cm">/* XXX Enabling the panel-fitter across page-flip is so far</span>
<span class="cm">	 * untested on non-native modes, so ignore it for now.</span>
<span class="cm">	 * pf = I915_READ(pipe == 0 ? PFA_CTL_1 : PFB_CTL_1) &amp; PF_ENABLE;</span>
<span class="cm">	 */</span>
	<span class="n">pf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pipesrc</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESRC</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0fff0fff</span><span class="p">;</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">pf</span> <span class="o">|</span> <span class="n">pipesrc</span><span class="p">);</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unpin:</span>
	<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_gen6_queue_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">pf</span><span class="p">,</span> <span class="n">pipesrc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pin_and_fence_fb_obj</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unpin</span><span class="p">;</span>

	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_DISPLAY_FLIP</span> <span class="o">|</span>
			<span class="n">MI_DISPLAY_FLIP_PLANE</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">));</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">);</span>

	<span class="cm">/* Contrary to the suggestions in the documentation,</span>
<span class="cm">	 * &quot;Enable Panel Fitter&quot; does not seem to be required when page</span>
<span class="cm">	 * flipping with a non-native mode, and worse causes a normal</span>
<span class="cm">	 * modeset to fail.</span>
<span class="cm">	 * pf = I915_READ(PF_CTL(intel_crtc-&gt;pipe)) &amp; PF_ENABLE;</span>
<span class="cm">	 */</span>
	<span class="n">pf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pipesrc</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESRC</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0fff0fff</span><span class="p">;</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">pf</span> <span class="o">|</span> <span class="n">pipesrc</span><span class="p">);</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unpin:</span>
	<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * On gen7 we currently use the blit ring because (in early silicon at least)</span>
<span class="cm"> * the render ring doesn&#39;t give us interrpts for page flip completion, which</span>
<span class="cm"> * means clients will hang after the first flip is queued.  Fortunately the</span>
<span class="cm"> * blit ring generates interrupts properly, so use it instead.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_gen7_queue_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">BCS</span><span class="p">];</span>
	<span class="kt">uint32_t</span> <span class="n">plane_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_pin_and_fence_fb_obj</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">ring</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PLANE_A</span>:
		<span class="n">plane_bit</span> <span class="o">=</span> <span class="n">MI_DISPLAY_FLIP_IVB_PLANE_A</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE_B</span>:
		<span class="n">plane_bit</span> <span class="o">=</span> <span class="n">MI_DISPLAY_FLIP_IVB_PLANE_B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PLANE_C</span>:
		<span class="n">plane_bit</span> <span class="o">=</span> <span class="n">MI_DISPLAY_FLIP_IVB_PLANE_C</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;unknown plane in flip command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unpin</span><span class="p">;</span>

	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_DISPLAY_FLIP_I915</span> <span class="o">|</span> <span class="n">plane_bit</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">));</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">));</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="p">(</span><span class="n">MI_NOOP</span><span class="p">));</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unpin:</span>
	<span class="n">intel_unpin_fb_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_default_queue_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_crtc_page_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_pending_vblank_event</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_unpin_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">work</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">work</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">work</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">intel_unpin_work_fn</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_vblank_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_work</span><span class="p">;</span>

	<span class="cm">/* We borrow the event spin lock for protecting unpin_work */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
		<span class="n">drm_vblank_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;flip queue: crtc already busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span> <span class="o">=</span> <span class="n">work</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* Reference the objects for the scheduled work. */</span>
	<span class="n">drm_gem_object_reference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">drm_gem_object_reference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>

	<span class="n">work</span><span class="o">-&gt;</span><span class="n">pending_flip_obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>

	<span class="n">work</span><span class="o">-&gt;</span><span class="n">enable_stall_check</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Block clients from rendering to the new back buffer until</span>
<span class="cm">	 * the flip occurs and the object is no longer visible.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="o">-&gt;</span><span class="n">pending_flip</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">queue_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_pending</span><span class="p">;</span>

	<span class="n">intel_disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_mark_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">trace_i915_flip_request</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup_pending:</span>
	<span class="n">atomic_sub</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="o">-&gt;</span><span class="n">pending_flip</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">drm_vblank_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
<span class="nl">free_work:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sanitize_modesetting</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Clear any frame start delays used for debugging left by the BIOS */</span>
	<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">PIPECONF</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PIPECONF_FRAME_START_DELAY_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Who knows what state these registers were left in by the BIOS or</span>
<span class="cm">	 * grub?</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we leave the registers in a conflicting state (e.g. with the</span>
<span class="cm">	 * display plane reading from the other pipe than the one we intend</span>
<span class="cm">	 * to use) then when we attempt to teardown the active mode, we will</span>
<span class="cm">	 * not disable the pipes and planes in the correct order -- leaving</span>
<span class="cm">	 * a plane reading from a disabled pipe and possibly leading to</span>
<span class="cm">	 * undefined behaviour.</span>
<span class="cm">	 */</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">DSPCNTR</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPLAY_PLANE_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DISPPLANE_SEL_PIPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">pipe</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* This display plane is active and attached to the other CPU pipe. */</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="o">!</span><span class="n">pipe</span><span class="p">;</span>

	<span class="cm">/* Disable the plane and wait for it to stop reading from the pipe. */</span>
	<span class="n">intel_disable_plane</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="n">intel_disable_pipe</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* Reset flags back to the &#39;unknown&#39; status so that they</span>
<span class="cm">	 * will be correctly set on the initial modeset.</span>
<span class="cm">	 */</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* We need to fix up any BIOS configuration that conflicts with</span>
<span class="cm">	 * our expectations.</span>
<span class="cm">	 */</span>
	<span class="n">intel_sanitize_modesetting</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="n">intel_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">intel_crtc_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">intel_crtc_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">intel_crtc_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base</span> <span class="o">=</span> <span class="n">intel_pipe_set_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base_atomic</span> <span class="o">=</span> <span class="n">intel_pipe_set_base_atomic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_lut</span> <span class="o">=</span> <span class="n">intel_crtc_load_lut</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable</span> <span class="o">=</span> <span class="n">intel_crtc_disable</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_funcs</span> <span class="n">intel_crtc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">intel_crtc_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_set</span> <span class="o">=</span> <span class="n">intel_crtc_cursor_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cursor_move</span> <span class="o">=</span> <span class="n">intel_crtc_cursor_move</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gamma_set</span> <span class="o">=</span> <span class="n">intel_crtc_gamma_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_config</span> <span class="o">=</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_crtc_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page_flip</span> <span class="o">=</span> <span class="n">intel_crtc_page_flip</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_pch_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pch_pll</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;No PCH PLLs on this hardware, skipping initialisation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pch_pll</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_plls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pll_reg</span> <span class="o">=</span> <span class="n">_PCH_DPLL</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_plls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp0_reg</span> <span class="o">=</span> <span class="n">_PCH_FP0</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pch_plls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fp1_reg</span> <span class="o">=</span> <span class="n">_PCH_FP1</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_crtc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_crtc</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">INTELFB_CONN_LIMIT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">drm_crtc_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_crtc_funcs</span><span class="p">);</span>

	<span class="n">drm_mode_crtc_set_gamma_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Swap pipes &amp; planes for FBC on pre-965 */</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_MOBILE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_GEN3</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;swapping pipes &amp; planes for FBC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span> <span class="o">=</span> <span class="o">!</span><span class="n">pipe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">pipe</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">[</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">plane_to_crtc_mapping</span><span class="p">[</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="n">intel_crtc_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* force the pipe off on setup_init_config */</span>
	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span> <span class="cm">/* default for pre-Ironlake */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_helper_funcs</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">ironlake_crtc_prepare</span><span class="p">;</span>
		<span class="n">intel_helper_funcs</span><span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">ironlake_crtc_commit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">intel_helper_funcs</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">i9xx_crtc_prepare</span><span class="p">;</span>
		<span class="n">intel_helper_funcs</span><span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">i9xx_crtc_commit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_crtc_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_helper_funcs</span><span class="p">);</span>

	<span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">intel_crtc_idle_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">intel_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intel_get_pipe_from_crtc_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_get_pipe_from_crtc_id</span> <span class="o">*</span><span class="n">pipe_from_crtc_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">drmmode_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">drmmode_obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pipe_from_crtc_id</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span>
			<span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drmmode_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;no such CRTC id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">drmmode_obj</span><span class="p">));</span>
	<span class="n">pipe_from_crtc_id</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_encoder_clones</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type_mask</span> <span class="o">&amp;</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">clone_mask</span><span class="p">)</span>
			<span class="n">index_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">index_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">has_edp_a</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_MOBILE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DP_A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_DETECTED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">ILK_DISPLAY_CHICKEN_FUSES</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ILK_eDP_A_DISABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_setup_outputs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dpd_is_edp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_lvds</span><span class="p">;</span>

	<span class="n">has_lvds</span> <span class="o">=</span> <span class="n">intel_lvds_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_lvds</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* disable the panel fitter on everything but LVDS */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dpd_is_edp</span> <span class="o">=</span> <span class="n">intel_dpd_is_edp</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">has_edp_a</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DP_A</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpd_is_edp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DP_D</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_DETECTED</span><span class="p">))</span>
			<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCH_DP_D</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_crt_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

		<span class="cm">/* Haswell uses DDI functions to detect digital outputs */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DDI_BUF_CTL_A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DDI_INIT_DISPLAY_DETECTED</span><span class="p">;</span>
		<span class="cm">/* DDI A only supports eDP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="n">intel_ddi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PORT_A</span><span class="p">);</span>

		<span class="cm">/* DDI B, C and D detection is indicated by the SFUSE_STRAP</span>
<span class="cm">		 * register */</span>
		<span class="n">found</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SFUSE_STRAP</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;</span> <span class="n">SFUSE_STRAP_DDIB_DETECTED</span><span class="p">)</span>
			<span class="n">intel_ddi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PORT_B</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;</span> <span class="n">SFUSE_STRAP_DDIC_DETECTED</span><span class="p">)</span>
			<span class="n">intel_ddi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PORT_C</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&amp;</span> <span class="n">SFUSE_STRAP_DDID_DETECTED</span><span class="p">)</span>
			<span class="n">intel_ddi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PORT_D</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">HDMIB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_DETECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PCH SDVOB multiplex with HDMIB */</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">intel_sdvo_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCH_SDVOB</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
				<span class="n">intel_hdmi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HDMIB</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DP_B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_DETECTED</span><span class="p">))</span>
				<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCH_DP_B</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">HDMIC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_DETECTED</span><span class="p">)</span>
			<span class="n">intel_hdmi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HDMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpd_is_edp</span> <span class="o">&amp;&amp;</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HDMID</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PORT_DETECTED</span><span class="p">)</span>
			<span class="n">intel_hdmi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HDMID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DP_C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_DETECTED</span><span class="p">)</span>
			<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCH_DP_C</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpd_is_edp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_DP_D</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_DETECTED</span><span class="p">))</span>
			<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCH_DP_D</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SUPPORTS_DIGITAL_OUTPUTS</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">SDVOB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDVO_DETECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;probing SDVOB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">intel_sdvo_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDVOB</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="n">SUPPORTS_INTEGRATED_HDMI</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;probing HDMI on SDVOB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">intel_hdmi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDVOB</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="n">SUPPORTS_INTEGRATED_DP</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;probing DP_B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DP_B</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Before G4X SDVOC doesn&#39;t have its own detect register */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">SDVOB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDVO_DETECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;probing SDVOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="n">intel_sdvo_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDVOC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">SDVOC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SDVO_DETECTED</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">SUPPORTS_INTEGRATED_HDMI</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;probing HDMI on SDVOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">intel_hdmi_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDVOC</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SUPPORTS_INTEGRATED_DP</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;probing DP_C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DP_C</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">SUPPORTS_INTEGRATED_DP</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">DP_D</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_DETECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;probing DP_D</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">intel_dp_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DP_D</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_dvo_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SUPPORTS_TV</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_tv_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc_mask</span><span class="p">;</span>
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">possible_clones</span> <span class="o">=</span>
			<span class="n">intel_encoder_clones</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">clone_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable all the possible outputs/crtcs before entering KMS mode */</span>
	<span class="n">drm_helper_disable_unused_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ironlake_init_pch_refclk</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_user_framebuffer_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="n">drm_framebuffer_cleanup</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">intel_fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_user_framebuffer_create_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">drm_gem_handle_create</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_framebuffer_funcs</span> <span class="n">intel_fb_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_user_framebuffer_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_handle</span> <span class="o">=</span> <span class="n">intel_user_framebuffer_create_handle</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">intel_framebuffer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">intel_fb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">mode_cmd</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span> <span class="o">==</span> <span class="n">I915_TILING_Y</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">63</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB332</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB565</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB2101010</span>:
		<span class="cm">/* RGB formats are common across chipsets */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUYV</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_UYVY</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVYU</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_VYUY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;unsupported pixel format %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_framebuffer_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_fb_funcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;framebuffer init failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_helper_mode_fill_fb_struct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="p">);</span>
	<span class="n">intel_fb</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span>
<span class="nf">intel_user_framebuffer_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">mode_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filp</span><span class="p">,</span>
						<span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">intel_framebuffer_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_mode_config_funcs</span> <span class="n">intel_mode_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fb_create</span> <span class="o">=</span> <span class="n">intel_user_framebuffer_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_poll_changed</span> <span class="o">=</span> <span class="n">intel_fb_output_poll_changed</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Set up chip specific display functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_init_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* We always want a DPMS function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">ironlake_crtc_dpms</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">crtc_mode_set</span> <span class="o">=</span> <span class="n">ironlake_crtc_mode_set</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">ironlake_crtc_off</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_plane</span> <span class="o">=</span> <span class="n">ironlake_update_plane</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">i9xx_crtc_dpms</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">crtc_mode_set</span> <span class="o">=</span> <span class="n">i9xx_crtc_mode_set</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">off</span> <span class="o">=</span> <span class="n">i9xx_crtc_off</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_plane</span> <span class="o">=</span> <span class="n">i9xx_update_plane</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Returns the core display clock speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">valleyview_get_display_clock_speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">IS_G33</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_PINEVIEW_M</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">i945_get_display_clock_speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I915G</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">i915_get_display_clock_speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_845G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_PINEVIEW_M</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">i9xx_misc_get_display_clock_speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">i915gm_get_display_clock_speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I865G</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">i865_get_display_clock_speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I85X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">i855_get_display_clock_speed</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* 852, 830 */</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">get_display_clock_speed</span> <span class="o">=</span>
			<span class="n">i830_get_display_clock_speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fdi_link_train</span> <span class="o">=</span> <span class="n">ironlake_fdi_link_train</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">write_eld</span> <span class="o">=</span> <span class="n">ironlake_write_eld</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fdi_link_train</span> <span class="o">=</span> <span class="n">gen6_fdi_link_train</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">write_eld</span> <span class="o">=</span> <span class="n">ironlake_write_eld</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* FIXME: detect B0+ stepping and use auto training */</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fdi_link_train</span> <span class="o">=</span> <span class="n">ivb_manual_fdi_link_train</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">write_eld</span> <span class="o">=</span> <span class="n">ironlake_write_eld</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">fdi_link_train</span> <span class="o">=</span> <span class="n">hsw_fdi_link_train</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">write_eld</span> <span class="o">=</span> <span class="n">ironlake_write_eld</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">update_wm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_get</span> <span class="o">=</span> <span class="n">vlv_force_wake_get</span><span class="p">;</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">force_wake_put</span> <span class="o">=</span> <span class="n">vlv_force_wake_put</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">write_eld</span> <span class="o">=</span> <span class="n">g4x_write_eld</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Default just returns -ENODEV to indicate unsupported */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">queue_flip</span> <span class="o">=</span> <span class="n">intel_default_queue_flip</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">queue_flip</span> <span class="o">=</span> <span class="n">intel_gen2_queue_flip</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">queue_flip</span> <span class="o">=</span> <span class="n">intel_gen3_queue_flip</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">queue_flip</span> <span class="o">=</span> <span class="n">intel_gen4_queue_flip</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">queue_flip</span> <span class="o">=</span> <span class="n">intel_gen6_queue_flip</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">.</span><span class="n">queue_flip</span> <span class="o">=</span> <span class="n">intel_gen7_queue_flip</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some BIOSes insist on assuming the GPU&#39;s pipe A is enabled at suspend,</span>
<span class="cm"> * resume, or other times.  This quirk makes sure that&#39;s the case for</span>
<span class="cm"> * affected systems.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">quirk_pipea_force</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">QUIRK_PIPEA_FORCE</span><span class="p">;</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;applying pipe a force quirk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Some machines (Lenovo U160) do not work with SSC on LVDS for some reason</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">quirk_ssc_force_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">QUIRK_LVDS_SSC_DISABLE</span><span class="p">;</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;applying lvds SSC disable quirk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A machine (e.g. Acer Aspire 5734Z) may need to invert the panel backlight</span>
<span class="cm"> * brightness value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">quirk_invert_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">QUIRK_INVERT_BRIGHTNESS</span><span class="p">;</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;applying inverted panel brightness quirk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">intel_quirk</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">subsystem_vendor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">subsystem_device</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_quirk</span> <span class="n">intel_quirks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* HP Mini needs pipe A force quirk (LP: #322104) */</span>
	<span class="p">{</span> <span class="mh">0x27ae</span><span class="p">,</span> <span class="mh">0x103c</span><span class="p">,</span> <span class="mh">0x361a</span><span class="p">,</span> <span class="n">quirk_pipea_force</span> <span class="p">},</span>

	<span class="cm">/* Thinkpad R31 needs pipe A force quirk */</span>
	<span class="p">{</span> <span class="mh">0x3577</span><span class="p">,</span> <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x0505</span><span class="p">,</span> <span class="n">quirk_pipea_force</span> <span class="p">},</span>
	<span class="cm">/* Toshiba Protege R-205, S-209 needs pipe A force quirk */</span>
	<span class="p">{</span> <span class="mh">0x2592</span><span class="p">,</span> <span class="mh">0x1179</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">quirk_pipea_force</span> <span class="p">},</span>

	<span class="cm">/* ThinkPad X30 needs pipe A force quirk (LP: #304614) */</span>
	<span class="p">{</span> <span class="mh">0x3577</span><span class="p">,</span>  <span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x0513</span><span class="p">,</span> <span class="n">quirk_pipea_force</span> <span class="p">},</span>
	<span class="cm">/* ThinkPad X40 needs pipe A force quirk */</span>

	<span class="cm">/* ThinkPad T60 needs pipe A force quirk (bug #16494) */</span>
	<span class="p">{</span> <span class="mh">0x2782</span><span class="p">,</span> <span class="mh">0x17aa</span><span class="p">,</span> <span class="mh">0x201a</span><span class="p">,</span> <span class="n">quirk_pipea_force</span> <span class="p">},</span>

	<span class="cm">/* 855 &amp; before need to leave pipe A &amp; dpll A up */</span>
	<span class="p">{</span> <span class="mh">0x3582</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">quirk_pipea_force</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x2562</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">quirk_pipea_force</span> <span class="p">},</span>

	<span class="cm">/* Lenovo U160 cannot use SSC on LVDS */</span>
	<span class="p">{</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x17aa</span><span class="p">,</span> <span class="mh">0x3920</span><span class="p">,</span> <span class="n">quirk_ssc_force_disable</span> <span class="p">},</span>

	<span class="cm">/* Sony Vaio Y cannot use SSC on LVDS */</span>
	<span class="p">{</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x104d</span><span class="p">,</span> <span class="mh">0x9076</span><span class="p">,</span> <span class="n">quirk_ssc_force_disable</span> <span class="p">},</span>

	<span class="cm">/* Acer Aspire 5734Z must invert backlight brightness */</span>
	<span class="p">{</span> <span class="mh">0x2a42</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0459</span><span class="p">,</span> <span class="n">quirk_invert_brightness</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_init_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intel_quirks</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_quirk</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_quirks</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">||</span>
		     <span class="n">q</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_ANY_ID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">||</span>
		     <span class="n">q</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="n">PCI_ANY_ID</span><span class="p">))</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">hook</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Disable the VGA plane that we never use */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_disable_vga</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sr1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vga_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">vga_reg</span> <span class="o">=</span> <span class="n">CPU_VGACNTRL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vga_reg</span> <span class="o">=</span> <span class="n">VGACNTRL</span><span class="p">;</span>

	<span class="n">vga_get_uninterruptible</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VGA_RSRC_LEGACY_IO</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">SR01</span><span class="p">,</span> <span class="n">VGA_SR_INDEX</span><span class="p">);</span>
	<span class="n">sr1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VGA_SR_DATA</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">sr1</span> <span class="o">|</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="n">VGA_SR_DATA</span><span class="p">);</span>
	<span class="n">vga_put</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VGA_RSRC_LEGACY_IO</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">vga_reg</span><span class="p">,</span> <span class="n">VGA_DISP_DISABLE</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">vga_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_modeset_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">intel_init_clock_gating</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IRONLAKE_M</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ironlake_enable_drps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ironlake_enable_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">intel_init_emon</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gen6_enable_rps</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">gen6_update_ring_freq</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_modeset_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">drm_mode_config_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">min_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">min_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">preferred_depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">prefer_shadow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">funcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_mode_funcs</span><span class="p">;</span>

	<span class="n">intel_init_quirks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_init_pm</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_prepare_ddi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_init_display</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN3</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">fb_base</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;%d display pipe%s available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_crtc_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_plane_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;plane %d init failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_pch_pll_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Just disable it once at startup */</span>
	<span class="n">i915_disable_vga</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_setup_outputs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_work</span><span class="p">,</span> <span class="n">intel_idle_update</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">,</span> <span class="n">intel_gpu_idle_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_modeset_gem_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">intel_modeset_init_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">intel_setup_overlay</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_modeset_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span><span class="p">;</span>

	<span class="n">drm_kms_helper_poll_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">intel_unregister_dsm_handler</span><span class="p">();</span>


	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Skip inactive CRTCs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="n">intel_increase_pllclock</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_disable_fbc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IRONLAKE_M</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ironlake_disable_drps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">gen6_disable_rps</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IRONLAKE_M</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ironlake_disable_rc6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">vlv_init_dpio</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* Disable the irq before mode object teardown, for the irq might</span>
<span class="cm">	 * enqueue unpin/hotplug work. */</span>
	<span class="n">drm_irq_uninstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_work</span><span class="p">);</span>

	<span class="cm">/* flush any delayed tasks or pending work */</span>
	<span class="n">flush_scheduled_work</span><span class="p">();</span>

	<span class="cm">/* Shut off idle work before the crtcs get freed. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">idle_work</span><span class="p">);</span>

	<span class="n">drm_mode_config_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return which encoder is currently attached for connector.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="nf">intel_best_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_connector_attach_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">;</span>
	<span class="n">drm_mode_connector_attach_encoder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set vga decode state - true == enable VGA decode</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">intel_modeset_vga_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gmch_ctrl</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">INTEL_GMCH_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gmch_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">gmch_ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INTEL_GMCH_VGA_DISABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gmch_ctrl</span> <span class="o">|=</span> <span class="n">INTEL_GMCH_VGA_DISABLE</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">INTEL_GMCH_CTRL</span><span class="p">,</span> <span class="n">gmch_ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">struct</span> <span class="n">intel_display_error_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_cursor_error_state</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">position</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cursor</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">intel_pipe_error_state</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">conf</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">source</span><span class="p">;</span>

		<span class="n">u32</span> <span class="n">htotal</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">hblank</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">hsync</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">vtotal</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">vblank</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">vsync</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">pipe</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">intel_plane_error_state</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">stride</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">surface</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">tile_offset</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">plane</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">intel_display_error_state</span> <span class="o">*</span>
<span class="nf">intel_display_capture_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_display_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CURCNTR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CURPOS</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CURBASE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPCNTR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stride</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPSTRIDE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPSIZE</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPPOS</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPADDR</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">surface</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPSURF</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
			<span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tile_offset</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPTILEOFF</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">conf</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">source</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESRC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HTOTAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hblank</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HBLANK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hsync</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">HSYNC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VTOTAL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vblank</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VBLANK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vsync</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">VSYNC</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">intel_display_print_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">intel_display_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Pipe [%d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  CONF: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">conf</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  SRC: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">source</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  HTOTAL: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">htotal</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  HBLANK: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hblank</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  HSYNC: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hsync</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  VTOTAL: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vtotal</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  VBLANK: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vblank</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  VSYNC: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vsync</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Plane [%d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  CNTR: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  STRIDE: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stride</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  SIZE: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  POS: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  ADDR: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  SURF: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">surface</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  TILEOFF: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tile_offset</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Cursor [%d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  CNTR: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  POS: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  BASE: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
