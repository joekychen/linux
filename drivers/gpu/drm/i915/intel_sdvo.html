<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › intel_sdvo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>intel_sdvo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2006 Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> * Copyright © 2006-2007 Intel Corporation</span>
<span class="cm"> *   Jesse Barnes &lt;jesse.barnes@intel.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER</span>
<span class="cm"> * DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_crtc.h&quot;</span>
<span class="cp">#include &quot;drm_edid.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;intel_sdvo_regs.h&quot;</span>

<span class="cp">#define SDVO_TMDS_MASK (SDVO_OUTPUT_TMDS0 | SDVO_OUTPUT_TMDS1)</span>
<span class="cp">#define SDVO_RGB_MASK  (SDVO_OUTPUT_RGB0 | SDVO_OUTPUT_RGB1)</span>
<span class="cp">#define SDVO_LVDS_MASK (SDVO_OUTPUT_LVDS0 | SDVO_OUTPUT_LVDS1)</span>
<span class="cp">#define SDVO_TV_MASK   (SDVO_OUTPUT_CVBS0 | SDVO_OUTPUT_SVID0 | SDVO_OUTPUT_YPRPB0)</span>

<span class="cp">#define SDVO_OUTPUT_MASK (SDVO_TMDS_MASK | SDVO_RGB_MASK | SDVO_LVDS_MASK |\</span>
<span class="cp">			SDVO_TV_MASK)</span>

<span class="cp">#define IS_TV(c)	(c-&gt;output_flag &amp; SDVO_TV_MASK)</span>
<span class="cp">#define IS_TMDS(c)	(c-&gt;output_flag &amp; SDVO_TMDS_MASK)</span>
<span class="cp">#define IS_LVDS(c)	(c-&gt;output_flag &amp; SDVO_LVDS_MASK)</span>
<span class="cp">#define IS_TV_OR_LVDS(c) (c-&gt;output_flag &amp; (SDVO_TV_MASK | SDVO_LVDS_MASK))</span>
<span class="cp">#define IS_DIGITAL(c) (c-&gt;output_flag &amp; (SDVO_TMDS_MASK | SDVO_LVDS_MASK))</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tv_format_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NTSC_M&quot;</span>   <span class="p">,</span> <span class="s">&quot;NTSC_J&quot;</span>  <span class="p">,</span> <span class="s">&quot;NTSC_443&quot;</span><span class="p">,</span>
	<span class="s">&quot;PAL_B&quot;</span>    <span class="p">,</span> <span class="s">&quot;PAL_D&quot;</span>   <span class="p">,</span> <span class="s">&quot;PAL_G&quot;</span>   <span class="p">,</span>
	<span class="s">&quot;PAL_H&quot;</span>    <span class="p">,</span> <span class="s">&quot;PAL_I&quot;</span>   <span class="p">,</span> <span class="s">&quot;PAL_M&quot;</span>   <span class="p">,</span>
	<span class="s">&quot;PAL_N&quot;</span>    <span class="p">,</span> <span class="s">&quot;PAL_NC&quot;</span>  <span class="p">,</span> <span class="s">&quot;PAL_60&quot;</span>  <span class="p">,</span>
	<span class="s">&quot;SECAM_B&quot;</span>  <span class="p">,</span> <span class="s">&quot;SECAM_D&quot;</span> <span class="p">,</span> <span class="s">&quot;SECAM_G&quot;</span> <span class="p">,</span>
	<span class="s">&quot;SECAM_K&quot;</span>  <span class="p">,</span> <span class="s">&quot;SECAM_K1&quot;</span><span class="p">,</span> <span class="s">&quot;SECAM_L&quot;</span> <span class="p">,</span>
	<span class="s">&quot;SECAM_60&quot;</span>
<span class="p">};</span>

<span class="cp">#define TV_FORMAT_NUM  (sizeof(tv_format_names) / sizeof(*tv_format_names))</span>

<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="n">base</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slave_addr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">ddc</span><span class="p">;</span>

	<span class="cm">/* Register for the SDVO device: SDVOB or SDVOC */</span>
	<span class="kt">uint32_t</span> <span class="n">sdvo_reg</span><span class="p">;</span>

	<span class="cm">/* Active outputs controlled by this SDVO output */</span>
	<span class="kt">uint16_t</span> <span class="n">controlled_output</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Capabilities of the SDVO device returned by</span>
<span class="cm">	 * i830_sdvo_get_capabilities()</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_caps</span> <span class="n">caps</span><span class="p">;</span>

	<span class="cm">/* Pixel clock limitations reported by the SDVO device, in kHz */</span>
	<span class="kt">int</span> <span class="n">pixel_clock_min</span><span class="p">,</span> <span class="n">pixel_clock_max</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	* For multiple function SDVO device,</span>
<span class="cm">	* this is for current attached outputs.</span>
<span class="cm">	*/</span>
	<span class="kt">uint16_t</span> <span class="n">attached_output</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hotplug activation bits for this device</span>
<span class="cm">	 */</span>
	<span class="kt">uint8_t</span> <span class="n">hotplug_active</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/**</span>
<span class="cm">	 * This is used to select the color range of RBG outputs in HDMI mode.</span>
<span class="cm">	 * It is only valid when using TMDS encoding and 8 bit per color mode.</span>
<span class="cm">	 */</span>
	<span class="kt">uint32_t</span> <span class="n">color_range</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * This is set if we&#39;re going to treat the device as TV-out.</span>
<span class="cm">	 *</span>
<span class="cm">	 * While we have these nice friendly flags for output types that ought</span>
<span class="cm">	 * to decide this for us, the S-Video output on our HDMI+S-Video card</span>
<span class="cm">	 * shows up as RGB1 (VGA).</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">is_tv</span><span class="p">;</span>

	<span class="cm">/* On different gens SDVOB is at different places. */</span>
	<span class="n">bool</span> <span class="n">is_sdvob</span><span class="p">;</span>

	<span class="cm">/* This is for current tv format name */</span>
	<span class="kt">int</span> <span class="n">tv_format_index</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * This is set if we treat the device as HDMI, instead of DVI.</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">is_hdmi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_hdmi_monitor</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_hdmi_audio</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * This is set if we detect output of sdvo device as LVDS and</span>
<span class="cm">	 * have a valid fixed mode to use with the panel.</span>
<span class="cm">	 */</span>
	<span class="n">bool</span> <span class="n">is_lvds</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * This is sdvo fixed pannel mode pointer</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">sdvo_lvds_fixed_mode</span><span class="p">;</span>

	<span class="cm">/* DDC bus used by this SDVO encoder */</span>
	<span class="kt">uint8_t</span> <span class="n">ddc_bus</span><span class="p">;</span>

	<span class="cm">/* Input timings for adjusted_mode */</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="n">input_dtd</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_connector</span> <span class="n">base</span><span class="p">;</span>

	<span class="cm">/* Mark the type of connector */</span>
	<span class="kt">uint16_t</span> <span class="n">output_flag</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">hdmi_force_audio</span> <span class="n">force_audio</span><span class="p">;</span>

	<span class="cm">/* This contains all current supported TV format */</span>
	<span class="n">u8</span> <span class="n">tv_format_supported</span><span class="p">[</span><span class="n">TV_FORMAT_NUM</span><span class="p">];</span>
	<span class="kt">int</span>   <span class="n">format_supported_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">tv_format</span><span class="p">;</span>

	<span class="cm">/* add the property for the SDVO-TV */</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">left</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">right</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">bottom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">hpos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">vpos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">contrast</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">saturation</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">hue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">sharpness</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">flicker_filter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">flicker_filter_adaptive</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">flicker_filter_2d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">tv_chroma_filter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">tv_luma_filter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">dot_crawl</span><span class="p">;</span>

	<span class="cm">/* add the property for the SDVO-TV/LVDS */</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">brightness</span><span class="p">;</span>

	<span class="cm">/* Add variable to record current setting for the above property */</span>
	<span class="n">u32</span>	<span class="n">left_margin</span><span class="p">,</span> <span class="n">right_margin</span><span class="p">,</span> <span class="n">top_margin</span><span class="p">,</span> <span class="n">bottom_margin</span><span class="p">;</span>

	<span class="cm">/* this is to get the range of margin.*/</span>
	<span class="n">u32</span>	<span class="n">max_hscan</span><span class="p">,</span>  <span class="n">max_vscan</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">max_hpos</span><span class="p">,</span> <span class="n">cur_hpos</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">max_vpos</span><span class="p">,</span> <span class="n">cur_vpos</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_brightness</span><span class="p">,</span> <span class="n">max_brightness</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_contrast</span><span class="p">,</span>	<span class="n">max_contrast</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_saturation</span><span class="p">,</span> <span class="n">max_saturation</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_hue</span><span class="p">,</span>	<span class="n">max_hue</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_sharpness</span><span class="p">,</span>	<span class="n">max_sharpness</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_flicker_filter</span><span class="p">,</span>		<span class="n">max_flicker_filter</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_flicker_filter_adaptive</span><span class="p">,</span>	<span class="n">max_flicker_filter_adaptive</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_flicker_filter_2d</span><span class="p">,</span>		<span class="n">max_flicker_filter_2d</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_tv_chroma_filter</span><span class="p">,</span>	<span class="n">max_tv_chroma_filter</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_tv_luma_filter</span><span class="p">,</span>	<span class="n">max_tv_luma_filter</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">cur_dot_crawl</span><span class="p">,</span>	<span class="n">max_dot_crawl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="nf">to_intel_sdvo</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="nf">intel_attached_sdvo</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
			    <span class="k">struct</span> <span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="nf">to_intel_sdvo_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_intel_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span> <span class="k">struct</span> <span class="n">intel_sdvo_connector</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="n">intel_sdvo_output_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="n">intel_sdvo_tv_create_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="n">intel_sdvo_create_enhance_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Writes the SDVOB or SDVOC with the given value, but always writes both</span>
<span class="cm"> * SDVOB and SDVOC to work around apparent hardware issues (according to</span>
<span class="cm"> * comments in the BIOS).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_write_sdvox</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bval</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">cval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span> <span class="o">==</span> <span class="n">PCH_SDVOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span> <span class="o">==</span> <span class="n">SDVOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cval</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDVOC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bval</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDVOB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Write the registers twice for luck. Sometimes,</span>
<span class="cm">	 * writing them only once doesn&#39;t appear to &#39;stick&#39;.</span>
<span class="cm">	 * The BIOS does this too. Yay, magic</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDVOB</span><span class="p">,</span> <span class="n">bval</span><span class="p">);</span>
		<span class="n">I915_READ</span><span class="p">(</span><span class="n">SDVOB</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">SDVOC</span><span class="p">,</span> <span class="n">cval</span><span class="p">);</span>
		<span class="n">I915_READ</span><span class="p">(</span><span class="n">SDVOC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ch</span><span class="p">,</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;i2c transfer returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SDVO_CMD_NAME_ENTRY(cmd) {cmd, #cmd}</span>
<span class="cm">/** Mapping of command numbers to names, for debug output */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">_sdvo_cmd_name</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">sdvo_cmd_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_RESET</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_DEVICE_CAPS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_FIRMWARE_REV</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_TRAINED_INPUTS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_ACTIVE_OUTPUTS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_ACTIVE_OUTPUTS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_IN_OUT_MAP</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_IN_OUT_MAP</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_ATTACHED_DISPLAYS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HOT_PLUG_SUPPORT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_ACTIVE_HOT_PLUG</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_ACTIVE_HOT_PLUG</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_INTERRUPT_EVENT_SOURCE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_TARGET_INPUT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_TARGET_OUTPUT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_INPUT_TIMINGS_PART1</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_INPUT_TIMINGS_PART2</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_INPUT_TIMINGS_PART1</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_INPUT_TIMINGS_PART2</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_INPUT_TIMINGS_PART1</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_OUTPUT_TIMINGS_PART1</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_OUTPUT_TIMINGS_PART2</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_OUTPUT_TIMINGS_PART1</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_OUTPUT_TIMINGS_PART2</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_CREATE_PREFERRED_INPUT_TIMING</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_PREFERRED_INPUT_TIMING_PART1</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_PREFERRED_INPUT_TIMING_PART2</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_INPUT_PIXEL_CLOCK_RANGE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_OUTPUT_PIXEL_CLOCK_RANGE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SUPPORTED_CLOCK_RATE_MULTS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_CLOCK_RATE_MULT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_CLOCK_RATE_MULT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SUPPORTED_TV_FORMATS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_TV_FORMAT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_TV_FORMAT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SUPPORTED_POWER_STATES</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_POWER_STATE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_ENCODER_POWER_STATE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_DISPLAY_POWER_STATE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_CONTROL_BUS_SWITCH</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SDTV_RESOLUTION_SUPPORT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SCALED_HDTV_RESOLUTION_SUPPORT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SUPPORTED_ENHANCEMENTS</span><span class="p">),</span>

	<span class="cm">/* Add the op code for SDVO enhancements */</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_HPOS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HPOS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_HPOS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_VPOS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_VPOS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_VPOS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_SATURATION</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SATURATION</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_SATURATION</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_HUE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HUE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_HUE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_CONTRAST</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_CONTRAST</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_CONTRAST</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_BRIGHTNESS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_BRIGHTNESS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_BRIGHTNESS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_OVERSCAN_H</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_OVERSCAN_H</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_OVERSCAN_H</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_OVERSCAN_V</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_OVERSCAN_V</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_OVERSCAN_V</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_FLICKER_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_FLICKER_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_FLICKER_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_FLICKER_FILTER_ADAPTIVE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_FLICKER_FILTER_ADAPTIVE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_FLICKER_FILTER_ADAPTIVE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_FLICKER_FILTER_2D</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_FLICKER_FILTER_2D</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_FLICKER_FILTER_2D</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_SHARPNESS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SHARPNESS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_SHARPNESS</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_DOT_CRAWL</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_DOT_CRAWL</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_TV_CHROMA_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_TV_CHROMA_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_TV_CHROMA_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_MAX_TV_LUMA_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_TV_LUMA_FILTER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_TV_LUMA_FILTER</span><span class="p">),</span>

	<span class="cm">/* HDMI op code */</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_SUPP_ENCODE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_ENCODE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_ENCODE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_PIXEL_REPLI</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_PIXEL_REPLI</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_COLORIMETRY_CAP</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_COLORIMETRY</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_COLORIMETRY</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_AUDIO_ENCRYPT_PREFER</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_AUDIO_STAT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_AUDIO_STAT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HBUF_INDEX</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_HBUF_INDEX</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HBUF_INFO</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HBUF_AV_SPLIT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_HBUF_AV_SPLIT</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HBUF_TXRATE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_HBUF_TXRATE</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_SET_HBUF_DATA</span><span class="p">),</span>
	<span class="n">SDVO_CMD_NAME_ENTRY</span><span class="p">(</span><span class="n">SDVO_CMD_GET_HBUF_DATA</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define SDVO_NAME(svdo) ((svdo)-&gt;is_sdvob ? &quot;SDVOB&quot; : &quot;SDVOC&quot;)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_debug_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="n">args_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;%s: W: %02X &quot;</span><span class="p">,</span>
				<span class="n">SDVO_NAME</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;%02X &quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;   &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdvo_cmd_names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">sdvo_cmd_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;(%s)&quot;</span><span class="p">,</span> <span class="n">sdvo_cmd_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdvo_cmd_names</span><span class="p">))</span>
		<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;(%02X)&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd_status_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Power on&quot;</span><span class="p">,</span>
	<span class="s">&quot;Success&quot;</span><span class="p">,</span>
	<span class="s">&quot;Not supported&quot;</span><span class="p">,</span>
	<span class="s">&quot;Invalid arg&quot;</span><span class="p">,</span>
	<span class="s">&quot;Pending&quot;</span><span class="p">,</span>
	<span class="s">&quot;Target not specified&quot;</span><span class="p">,</span>
	<span class="s">&quot;Scaling not supported&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_write_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span>
				 <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span> <span class="n">args_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">kzalloc</span><span class="p">(</span><span class="n">args_len</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">msgs</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">args_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">msgs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msgs</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_sdvo_debug_write</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">args_len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SDVO_I2C_ARG_0</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SDVO_I2C_OPCODE</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* the following two are to read the response */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">SDVO_I2C_CMD_STATUS</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;I2c transfer returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* failure in I2C transfer */</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;I2c transfer returned %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">msgs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_read_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="kt">int</span> <span class="n">response_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;%s: R: &quot;</span><span class="p">,</span> <span class="n">SDVO_NAME</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * The documentation states that all commands will be</span>
<span class="cm">	 * processed within 15µs, and that we need only poll</span>
<span class="cm">	 * the status byte a maximum of 3 times in order for the</span>
<span class="cm">	 * command to be complete.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Check 5 times in case the hardware failed to read the docs.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_read_byte</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_I2C_CMD_STATUS</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">log_fail</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SDVO_CMD_STATUS_PENDING</span> <span class="o">&amp;&amp;</span> <span class="n">retry</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_read_byte</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">SDVO_I2C_CMD_STATUS</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">log_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="n">SDVO_CMD_STATUS_SCALING_NOT_SUPP</span><span class="p">)</span>
		<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;(%s)&quot;</span><span class="p">,</span> <span class="n">cmd_status_names</span><span class="p">[</span><span class="n">status</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;(??? %d)&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SDVO_CMD_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">log_fail</span><span class="p">;</span>

	<span class="cm">/* Read the command response */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">response_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_read_byte</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">SDVO_I2C_RETURN_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">)[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">goto</span> <span class="n">log_fail</span><span class="p">;</span>
		<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot; %02X&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">log_fail:</span>
	<span class="n">DRM_LOG_KMS</span><span class="p">(</span><span class="s">&quot;... failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_sdvo_get_pixel_multiplier</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">100000</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">50000</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_control_bus_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					      <span class="n">u8</span> <span class="n">ddc_bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This must be the immediately preceding write before the i2c xfer */</span>
	<span class="k">return</span> <span class="n">intel_sdvo_write_cmd</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_SET_CONTROL_BUS_SWITCH</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ddc_bus</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_write_cmd</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">intel_sdvo_read_response</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_get_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_write_cmd</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">intel_sdvo_read_response</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_target_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_set_target_input_args</span> <span class="n">targets</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_SET_TARGET_INPUT</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">targets</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">targets</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return whether each input is trained.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is making an assumption about the layout of the response,</span>
<span class="cm"> * which should be checked against the docs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_get_trained_inputs</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">input_1</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">input_2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_get_trained_inputs_response</span> <span class="n">response</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_GET_TRAINED_INPUTS</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">response</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">response</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="o">*</span><span class="n">input_1</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">input0_trained</span><span class="p">;</span>
	<span class="o">*</span><span class="n">input_2</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">input1_trained</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_active_outputs</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">u16</span> <span class="n">outputs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_SET_ACTIVE_OUTPUTS</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">outputs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">outputs</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_encoder_power_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">state</span> <span class="o">=</span> <span class="n">SDVO_ENCODER_STATE_ON</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">SDVO_ENCODER_STATE_ON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">SDVO_ENCODER_STATE_STANDBY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">SDVO_ENCODER_STATE_SUSPEND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">SDVO_ENCODER_STATE_OFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_SET_ENCODER_POWER_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_get_input_pixel_clock_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="o">*</span><span class="n">clock_min</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="o">*</span><span class="n">clock_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_pixel_clock_range</span> <span class="n">clocks</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">clocks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_CMD_GET_INPUT_PIXEL_CLOCK_RANGE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">clocks</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clocks</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Convert the values from units of 10 kHz to kHz. */</span>
	<span class="o">*</span><span class="n">clock_min</span> <span class="o">=</span> <span class="n">clocks</span><span class="p">.</span><span class="n">min</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="o">*</span><span class="n">clock_max</span> <span class="o">=</span> <span class="n">clocks</span><span class="p">.</span><span class="n">max</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_target_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="n">outputs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_SET_TARGET_OUTPUT</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">outputs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">outputs</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="o">*</span><span class="n">dtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_input_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="o">*</span><span class="n">dtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_timing</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				     <span class="n">SDVO_CMD_SET_INPUT_TIMINGS_PART1</span><span class="p">,</span> <span class="n">dtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_output_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="o">*</span><span class="n">dtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_timing</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				     <span class="n">SDVO_CMD_SET_OUTPUT_TIMINGS_PART1</span><span class="p">,</span> <span class="n">dtd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_create_preferred_input_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					 <span class="kt">uint16_t</span> <span class="n">clock</span><span class="p">,</span>
					 <span class="kt">uint16_t</span> <span class="n">width</span><span class="p">,</span>
					 <span class="kt">uint16_t</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_preferred_input_timing_args</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
	<span class="n">args</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">interlace</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">!=</span> <span class="n">width</span> <span class="o">||</span>
	    <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">!=</span> <span class="n">height</span><span class="p">))</span>
		<span class="n">args</span><span class="p">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_CREATE_PREFERRED_INPUT_TIMING</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_get_preferred_input_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="o">*</span><span class="n">dtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_GET_PREFERRED_INPUT_TIMING_PART1</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_GET_PREFERRED_INPUT_TIMING_PART2</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_clock_rate_mult</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_SET_CLOCK_RATE_MULT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_get_dtd_from_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="o">*</span><span class="n">dtd</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">h_blank_len</span><span class="p">,</span> <span class="n">h_sync_len</span><span class="p">,</span> <span class="n">v_blank_len</span><span class="p">,</span> <span class="n">v_sync_len</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">h_sync_offset</span><span class="p">,</span> <span class="n">v_sync_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode_clock</span><span class="p">;</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>

	<span class="cm">/* do some mode translations */</span>
	<span class="n">h_blank_len</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">h_sync_len</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span><span class="p">;</span>

	<span class="n">v_blank_len</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
	<span class="n">v_sync_len</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span><span class="p">;</span>

	<span class="n">h_sync_offset</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">v_sync_offset</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>

	<span class="n">mode_clock</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">mode_clock</span> <span class="o">/=</span> <span class="n">intel_mode_get_pixel_multiplier</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mode_clock</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="n">mode_clock</span><span class="p">;</span>

	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">h_active</span> <span class="o">=</span> <span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">h_blank</span> <span class="o">=</span> <span class="n">h_blank_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">h_high</span> <span class="o">=</span> <span class="p">(((</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">h_blank_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">v_active</span> <span class="o">=</span> <span class="n">height</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">v_blank</span> <span class="o">=</span> <span class="n">v_blank_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">v_high</span> <span class="o">=</span> <span class="p">(((</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">v_blank_len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">h_sync_off</span> <span class="o">=</span> <span class="n">h_sync_offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">h_sync_width</span> <span class="o">=</span> <span class="n">h_sync_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">v_sync_off_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_sync_offset</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">v_sync_len</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">sync_off_width_high</span> <span class="o">=</span> <span class="p">((</span><span class="n">h_sync_offset</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">h_sync_len</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">v_sync_offset</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">v_sync_len</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">dtd_flags</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span>
		<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">dtd_flags</span> <span class="o">|=</span> <span class="n">DTD_FLAG_INTERLACE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PHSYNC</span><span class="p">)</span>
		<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">dtd_flags</span> <span class="o">|=</span> <span class="n">DTD_FLAG_HSYNC_POSITIVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span>
		<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">dtd_flags</span> <span class="o">|=</span> <span class="n">DTD_FLAG_VSYNC_POSITIVE</span><span class="p">;</span>

	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">sdvo_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">v_sync_off_high</span> <span class="o">=</span> <span class="n">v_sync_offset</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_get_mode_from_dtd</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span> <span class="n">mode</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="o">*</span><span class="n">dtd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">h_active</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">+=</span> <span class="p">((</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">h_high</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">+</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">h_sync_off</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">sync_off_width_high</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">+</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">h_sync_width</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">sync_off_width_high</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">+</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">h_blank</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">h_high</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">v_active</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">+=</span> <span class="p">((</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">v_high</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">v_sync_off_width</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">sync_off_width_high</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">+=</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">v_sync_off_high</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">v_sync_off_width</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">sync_off_width_high</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">+</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">v_blank</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">v_high</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part1</span><span class="p">.</span><span class="n">clock</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">dtd_flags</span> <span class="o">&amp;</span> <span class="n">DTD_FLAG_INTERLACE</span><span class="p">)</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">dtd_flags</span> <span class="o">&amp;</span> <span class="n">DTD_FLAG_HSYNC_POSITIVE</span><span class="p">)</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_PHSYNC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtd</span><span class="o">-&gt;</span><span class="n">part2</span><span class="p">.</span><span class="n">dtd_flags</span> <span class="o">&amp;</span> <span class="n">DTD_FLAG_VSYNC_POSITIVE</span><span class="p">)</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_check_supp_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_encode</span> <span class="n">encode</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">encode</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_CMD_GET_SUPP_ENCODE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">encode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">encode</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="kt">uint8_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_SET_ENCODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_colorimetry</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
				       <span class="kt">uint8_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_SET_COLORIMETRY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void intel_sdvo_dump_hdmi_buf(struct intel_sdvo *intel_sdvo)</span>
<span class="c">{</span>
<span class="c">	int i, j;</span>
<span class="c">	uint8_t set_buf_index[2];</span>
<span class="c">	uint8_t av_split;</span>
<span class="c">	uint8_t buf_size;</span>
<span class="c">	uint8_t buf[48];</span>
<span class="c">	uint8_t *pos;</span>

<span class="c">	intel_sdvo_get_value(encoder, SDVO_CMD_GET_HBUF_AV_SPLIT, &amp;av_split, 1);</span>

<span class="c">	for (i = 0; i &lt;= av_split; i++) {</span>
<span class="c">		set_buf_index[0] = i; set_buf_index[1] = 0;</span>
<span class="c">		intel_sdvo_write_cmd(encoder, SDVO_CMD_SET_HBUF_INDEX,</span>
<span class="c">				     set_buf_index, 2);</span>
<span class="c">		intel_sdvo_write_cmd(encoder, SDVO_CMD_GET_HBUF_INFO, NULL, 0);</span>
<span class="c">		intel_sdvo_read_response(encoder, &amp;buf_size, 1);</span>

<span class="c">		pos = buf;</span>
<span class="c">		for (j = 0; j &lt;= buf_size; j += 8) {</span>
<span class="c">			intel_sdvo_write_cmd(encoder, SDVO_CMD_GET_HBUF_DATA,</span>
<span class="c">					     NULL, 0);</span>
<span class="c">			intel_sdvo_read_response(encoder, pos, 8);</span>
<span class="c">			pos += 8;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_avi_infoframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dip_infoframe</span> <span class="n">avi_if</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DIP_TYPE_AVI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ver</span> <span class="o">=</span> <span class="n">DIP_VERSION_AVI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">DIP_LEN_AVI</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">uint8_t</span> <span class="n">tx_rate</span> <span class="o">=</span> <span class="n">SDVO_HBUF_TX_VSYNC</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">set_buf_index</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">uint8_t</span> <span class="n">sdvo_data</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">avi_if</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">avi</span><span class="p">)];</span>
	<span class="kt">uint64_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span><span class="n">sdvo_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">intel_dip_infoframe_csum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avi_if</span><span class="p">);</span>

	<span class="cm">/* sdvo spec says that the ecc is handled by the hw, and it looks like</span>
<span class="cm">	 * we must not send the ecc field, either. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sdvo_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">avi_if</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">sdvo_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">avi_if</span><span class="p">.</span><span class="n">checksum</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdvo_data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">avi_if</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">avi_if</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">avi</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_CMD_SET_HBUF_INDEX</span><span class="p">,</span>
				  <span class="n">set_buf_index</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sdvo_data</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">SDVO_CMD_SET_HBUF_DATA</span><span class="p">,</span>
					  <span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_SET_HBUF_TXRATE</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">tx_rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_set_tv_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_tv_format</span> <span class="n">format</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">format_map</span><span class="p">;</span>

	<span class="n">format_map</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">tv_format_index</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_map</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format_map</span><span class="p">)));</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">SDVO_CMD_SET_TV_FORMAT</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_set_output_timings_from_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="n">output_dtd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_target_output</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">attached_output</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_sdvo_get_dtd_from_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">output_dtd</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_output_timing</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_dtd</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_set_input_timings_for_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Reset the input timing to the screen. Assume always input 0. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_target_input</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_create_preferred_input_timing</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
						      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
						      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">,</span>
						      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_preferred_input_timing</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">input_dtd</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_sdvo_get_mode_from_dtd</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">input_dtd</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">to_intel_sdvo</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">multiplier</span><span class="p">;</span>

	<span class="cm">/* We need to construct preferred input timings based on our</span>
<span class="cm">	 * output timings.  To do that, we have to set the output</span>
<span class="cm">	 * timings, even though this isn&#39;t really the right place in</span>
<span class="cm">	 * the sequence to do it. Oh well.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_tv</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_output_timings_from_mode</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">intel_sdvo_set_input_timings_for_mode</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
							     <span class="n">mode</span><span class="p">,</span>
							     <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_output_timings_from_mode</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
							     <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">intel_sdvo_set_input_timings_for_mode</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
							     <span class="n">mode</span><span class="p">,</span>
							     <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Make the CRTC code factor in the SDVO pixel multiplier.  The</span>
<span class="cm">	 * SDVO device will factor out the multiplier during mode_set.</span>
<span class="cm">	 */</span>
	<span class="n">multiplier</span> <span class="o">=</span> <span class="n">intel_sdvo_get_pixel_multiplier</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="n">intel_mode_set_pixel_multiplier</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">to_intel_sdvo</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sdvox</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_in_out_map</span> <span class="n">in_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_dtd</span> <span class="n">input_dtd</span><span class="p">,</span> <span class="n">output_dtd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixel_multiplier</span> <span class="o">=</span> <span class="n">intel_mode_get_pixel_multiplier</span><span class="p">(</span><span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* First, set the input mapping for the first input to our controlled</span>
<span class="cm">	 * output. This is only correct if we&#39;re a single-input device, in</span>
<span class="cm">	 * which case the first input is the output from the appropriate SDVO</span>
<span class="cm">	 * channel on the motherboard.  In a two-input device, the first input</span>
<span class="cm">	 * will be SDVOB and the second SDVOC.</span>
<span class="cm">	 */</span>
	<span class="n">in_out</span><span class="p">.</span><span class="n">in0</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">attached_output</span><span class="p">;</span>
	<span class="n">in_out</span><span class="p">.</span><span class="n">in1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
			     <span class="n">SDVO_CMD_SET_IN_OUT_MAP</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">in_out</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in_out</span><span class="p">));</span>

	<span class="cm">/* Set the output timings to the screen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_target_output</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">attached_output</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* lvds has a special fixed output timing. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span><span class="p">)</span>
		<span class="n">intel_sdvo_get_dtd_from_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">output_dtd</span><span class="p">,</span>
					     <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">intel_sdvo_get_dtd_from_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">output_dtd</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">intel_sdvo_set_output_timing</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output_dtd</span><span class="p">);</span>

	<span class="cm">/* Set the input timing to the screen. Assume always input 0. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_target_input</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_monitor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo_set_encode</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_ENCODE_HDMI</span><span class="p">);</span>
		<span class="n">intel_sdvo_set_colorimetry</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					   <span class="n">SDVO_COLORIMETRY_RGB256</span><span class="p">);</span>
		<span class="n">intel_sdvo_set_avi_infoframe</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">intel_sdvo_set_encode</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_ENCODE_DVI</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_tv</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">intel_sdvo_set_tv_format</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We have tried to get input timing in mode_fixup, and filled into</span>
<span class="cm">	 * adjusted_mode.</span>
<span class="cm">	 */</span>
	<span class="n">intel_sdvo_get_dtd_from_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input_dtd</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">intel_sdvo_set_input_timing</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input_dtd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pixel_multiplier</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">rate</span> <span class="o">=</span> <span class="n">SDVO_CLOCK_RATE_MULT_1X</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">rate</span> <span class="o">=</span> <span class="n">SDVO_CLOCK_RATE_MULT_2X</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">rate</span> <span class="o">=</span> <span class="n">SDVO_CLOCK_RATE_MULT_4X</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_clock_rate_mult</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">rate</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Set the SDVO control regs. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The real mode polarity is set by the SDVO commands, using</span>
<span class="cm">		 * struct intel_sdvo_dtd. */</span>
		<span class="n">sdvox</span> <span class="o">=</span> <span class="n">SDVO_VSYNC_ACTIVE_HIGH</span> <span class="o">|</span> <span class="n">SDVO_HSYNC_ACTIVE_HIGH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_hdmi</span><span class="p">)</span>
			<span class="n">sdvox</span> <span class="o">|=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">color_range</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">sdvox</span> <span class="o">|=</span> <span class="n">SDVO_BORDER_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sdvox</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SDVOB</span>:
			<span class="n">sdvox</span> <span class="o">&amp;=</span> <span class="n">SDVOB_PRESERVE_MASK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDVOC</span>:
			<span class="n">sdvox</span> <span class="o">&amp;=</span> <span class="n">SDVOC_PRESERVE_MASK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sdvox</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">9</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">|</span> <span class="n">SDVO_BORDER_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_PCH_TYPE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PCH_CPT</span><span class="p">)</span>
		<span class="n">sdvox</span> <span class="o">|=</span> <span class="n">TRANSCODER_CPT</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sdvox</span> <span class="o">|=</span> <span class="n">TRANSCODER</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_audio</span><span class="p">)</span>
		<span class="n">sdvox</span> <span class="o">|=</span> <span class="n">SDVO_AUDIO_ENABLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* done in crtc_mode_set as the dpll_md reg must be written early */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_G33</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* done in crtc_mode_set as it lives inside the dpll register */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sdvox</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pixel_multiplier</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">SDVO_PORT_MULTIPLY_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input_dtd</span><span class="p">.</span><span class="n">part2</span><span class="p">.</span><span class="n">sdvo_flags</span> <span class="o">&amp;</span> <span class="n">SDVO_NEED_TO_STALL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">sdvox</span> <span class="o">|=</span> <span class="n">SDVO_STALL_SELECT</span><span class="p">;</span>
	<span class="n">intel_sdvo_write_sdvox</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">sdvox</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">to_intel_sdvo</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo_set_active_outputs</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">intel_sdvo_set_encoder_power_state</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">SDVO_ENABLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">intel_sdvo_write_sdvox</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SDVO_ENABLE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">input1</span><span class="p">,</span> <span class="n">input2</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">SDVO_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">intel_sdvo_write_sdvox</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="n">SDVO_ENABLE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">intel_sdvo_get_trained_inputs</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input2</span><span class="p">);</span>
		<span class="cm">/* Warn if the device reported failure to sync.</span>
<span class="cm">		 * A lot of SDVO devices fail to notify of sync, but it&#39;s</span>
<span class="cm">		 * a given it the status is a success, we succeeded.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SDVO_CMD_STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">input1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;First %s output reported failure to &quot;</span>
					<span class="s">&quot;sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SDVO_NAME</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">intel_sdvo_set_encoder_power_state</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">intel_sdvo_set_active_outputs</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">attached_output</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_sdvo_mode_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_NO_DBLESCAN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">pixel_clock_min</span> <span class="o">&gt;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_CLOCK_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">pixel_clock_max</span> <span class="o">&lt;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_CLOCK_HIGH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">MODE_PANEL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">&gt;</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">MODE_PANEL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">MODE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_get_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_sdvo_caps</span> <span class="o">*</span><span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">caps</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_CMD_GET_DEVICE_CAPS</span><span class="p">,</span>
				  <span class="n">caps</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">caps</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;SDVO capabilities:</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  vendor_id: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  device_id: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  device_rev_id: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  sdvo_version_major: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  sdvo_version_minor: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  sdvo_inputs_mask: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  smooth_scaling: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  sharp_scaling: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  up_scaling: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  down_scaling: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  stall_support: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;  output_flags: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">device_rev_id</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">sdvo_version_major</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">sdvo_version_minor</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">sdvo_inputs_mask</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">smooth_scaling</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">sharp_scaling</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">up_scaling</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">down_scaling</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">stall_support</span><span class="p">,</span>
		      <span class="n">caps</span><span class="o">-&gt;</span><span class="n">output_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_sdvo_supports_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">response</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* HW Erratum: SDVO Hotplug is broken on all i945G chips, there&#39;s noise</span>
<span class="cm">	 * on the line. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_GET_HOT_PLUG_SUPPORT</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">response</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_enable_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">to_intel_sdvo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">intel_sdvo_write_cmd</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_SET_ACTIVE_HOT_PLUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">hotplug_active</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_multifunc_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Is there more than one type of output? */</span>
	<span class="k">return</span> <span class="n">hweight16</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">output_flags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span>
<span class="nf">intel_sdvo_get_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drm_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Mac mini hack -- use the same DDC as the analog connector */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span>
<span class="nf">intel_sdvo_get_analog_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">drm_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
			    <span class="n">intel_gmbus_get_adapter</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span>
						    <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">crt_ddc_pin</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">intel_sdvo_tmds_sink_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">drm_connector_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>

	<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">intel_sdvo_multifunc_encoder</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">ddc</span><span class="p">,</span> <span class="n">saved_ddc</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">ddc_bus</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t use the 1 as the argument of DDC bus switch to get</span>
<span class="cm">		 * the EDID. It is used for SDVO SPD ROM.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ddc</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">ddc_bus</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ddc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ddc</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">ddc_bus</span> <span class="o">=</span> <span class="n">ddc</span><span class="p">;</span>
			<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we found the EDID on the other bus,</span>
<span class="cm">		 * assume that is the correct DDC bus.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">ddc_bus</span> <span class="o">=</span> <span class="n">saved_ddc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When there is no edid and no monitor is connected with VGA</span>
<span class="cm">	 * port, try to use the CRT ddc to read the EDID for DVI-connector.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_analog_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">connector_status_unknown</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DDC bus is shared, match EDID to connector type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">&amp;</span> <span class="n">DRM_EDID_INPUT_DIGITAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">connector_status_connected</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_hdmi</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_monitor</span> <span class="o">=</span> <span class="n">drm_detect_hdmi_monitor</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
				<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_audio</span> <span class="o">=</span> <span class="n">drm_detect_monitor_audio</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">raw_edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">to_intel_sdvo_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">force_audio</span> <span class="o">!=</span> <span class="n">HDMI_AUDIO_AUTO</span><span class="p">)</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_audio</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">force_audio</span> <span class="o">==</span> <span class="n">HDMI_AUDIO_ON</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_connector_matches_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">sdvo</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">monitor_is_digital</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">edid</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">&amp;</span> <span class="n">DRM_EDID_INPUT_DIGITAL</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">connector_is_digital</span> <span class="o">=</span> <span class="o">!!</span><span class="n">IS_DIGITAL</span><span class="p">(</span><span class="n">sdvo</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;connector_is_digital? %d, monitor_is_digital? %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">connector_is_digital</span><span class="p">,</span> <span class="n">monitor_is_digital</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">connector_is_digital</span> <span class="o">==</span> <span class="n">monitor_is_digital</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">intel_sdvo_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">response</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">to_intel_sdvo_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">drm_connector_status</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_write_cmd</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_CMD_GET_ATTACHED_DISPLAYS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>

	<span class="cm">/* add 30ms delay when the output type might be TV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">output_flags</span> <span class="o">&amp;</span> <span class="n">SDVO_TV_MASK</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_read_response</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;SDVO response %d %d [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">response</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">response</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>
		      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">attached_output</span> <span class="o">=</span> <span class="n">response</span><span class="p">;</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_monitor</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">&amp;</span> <span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_TMDS</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_sdvo_tmds_sink_detect</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>

		<span class="cm">/* if we have an edid check it matches the connection */</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_analog_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector_matches_edid</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">,</span>
							      <span class="n">edid</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">connector_status_connected</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>

			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">raw_edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* May update encoder flag for like clock for SDVO TV, etc.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">connector_status_connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_tv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">needs_tv_clock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&amp;</span> <span class="n">SDVO_TV_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">needs_tv_clock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&amp;</span> <span class="n">SDVO_LVDS_MASK</span><span class="p">)</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_get_ddc_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>

	<span class="cm">/* set the bus switch and get the modes */</span>
	<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mac mini hack.  On this device, the DVI-I connector shares one DDC</span>
<span class="cm">	 * link between analog and digital outputs. So, if the regular SDVO</span>
<span class="cm">	 * DDC fails, check to see if the analog output is disconnected, in</span>
<span class="cm">	 * which case we&#39;ll look there for the digital DDC data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_analog_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector_matches_edid</span><span class="p">(</span><span class="n">to_intel_sdvo_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
						      <span class="n">edid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drm_mode_connector_update_edid_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">edid</span><span class="p">);</span>
			<span class="n">drm_add_edid_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">edid</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">raw_edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set of SDVO TV modes.</span>
<span class="cm"> * Note!  This is in reply order (see loop in get_tv_modes).</span>
<span class="cm"> * XXX: all 60Hz refresh?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="n">sdvo_tv_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;320x200&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">5815</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">321</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span>
		   <span class="mi">416</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">233</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;320x240&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">6814</span><span class="p">,</span> <span class="mi">320</span><span class="p">,</span> <span class="mi">321</span><span class="p">,</span> <span class="mi">384</span><span class="p">,</span>
		   <span class="mi">416</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">272</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;400x300&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">9910</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">464</span><span class="p">,</span>
		   <span class="mi">496</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">332</span><span class="p">,</span> <span class="mi">333</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;640x350&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">16913</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">641</span><span class="p">,</span> <span class="mi">704</span><span class="p">,</span>
		   <span class="mi">736</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">351</span><span class="p">,</span> <span class="mi">382</span><span class="p">,</span> <span class="mi">383</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;640x400&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">19121</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">641</span><span class="p">,</span> <span class="mi">704</span><span class="p">,</span>
		   <span class="mi">736</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">432</span><span class="p">,</span> <span class="mi">433</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;640x480&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">22654</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">641</span><span class="p">,</span> <span class="mi">704</span><span class="p">,</span>
		   <span class="mi">736</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">481</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">513</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;704x480&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">24624</span><span class="p">,</span> <span class="mi">704</span><span class="p">,</span> <span class="mi">705</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>
		   <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">481</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">513</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;704x576&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">29232</span><span class="p">,</span> <span class="mi">704</span><span class="p">,</span> <span class="mi">705</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>
		   <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">577</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">609</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;720x350&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">18751</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">721</span><span class="p">,</span> <span class="mi">784</span><span class="p">,</span>
		   <span class="mi">816</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">351</span><span class="p">,</span> <span class="mi">382</span><span class="p">,</span> <span class="mi">383</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;720x400&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">21199</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">721</span><span class="p">,</span> <span class="mi">784</span><span class="p">,</span>
		   <span class="mi">816</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">432</span><span class="p">,</span> <span class="mi">433</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;720x480&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">25116</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">721</span><span class="p">,</span> <span class="mi">784</span><span class="p">,</span>
		   <span class="mi">816</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">481</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">513</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;720x540&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">28054</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">721</span><span class="p">,</span> <span class="mi">784</span><span class="p">,</span>
		   <span class="mi">816</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">540</span><span class="p">,</span> <span class="mi">541</span><span class="p">,</span> <span class="mi">572</span><span class="p">,</span> <span class="mi">573</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;720x576&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">29816</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">721</span><span class="p">,</span> <span class="mi">784</span><span class="p">,</span>
		   <span class="mi">816</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">577</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">609</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;768x576&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">31570</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">769</span><span class="p">,</span> <span class="mi">832</span><span class="p">,</span>
		   <span class="mi">864</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">576</span><span class="p">,</span> <span class="mi">577</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="mi">609</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;800x600&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">34030</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">801</span><span class="p">,</span> <span class="mi">864</span><span class="p">,</span>
		   <span class="mi">896</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">601</span><span class="p">,</span> <span class="mi">632</span><span class="p">,</span> <span class="mi">633</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;832x624&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">36581</span><span class="p">,</span> <span class="mi">832</span><span class="p">,</span> <span class="mi">833</span><span class="p">,</span> <span class="mi">896</span><span class="p">,</span>
		   <span class="mi">928</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">624</span><span class="p">,</span> <span class="mi">625</span><span class="p">,</span> <span class="mi">656</span><span class="p">,</span> <span class="mi">657</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;920x766&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">48707</span><span class="p">,</span> <span class="mi">920</span><span class="p">,</span> <span class="mi">921</span><span class="p">,</span> <span class="mi">984</span><span class="p">,</span>
		   <span class="mi">1016</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">766</span><span class="p">,</span> <span class="mi">767</span><span class="p">,</span> <span class="mi">798</span><span class="p">,</span> <span class="mi">799</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;1024x768&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">53827</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1025</span><span class="p">,</span> <span class="mi">1088</span><span class="p">,</span>
		   <span class="mi">1120</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">769</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">801</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;1280x1024&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">87265</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1281</span><span class="p">,</span> <span class="mi">1344</span><span class="p">,</span>
		   <span class="mi">1376</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1025</span><span class="p">,</span> <span class="mi">1056</span><span class="p">,</span> <span class="mi">1057</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		   <span class="n">DRM_MODE_FLAG_PHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_get_tv_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_sdtv_resolution_request</span> <span class="n">tv_res</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">format_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Read the list of supported input resolutions for the selected TV</span>
<span class="cm">	 * format.</span>
<span class="cm">	 */</span>
	<span class="n">format_map</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">tv_format_index</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_map</span><span class="p">,</span>
	       <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">format_map</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_sdtv_resolution_request</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_target_output</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">attached_output</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tv_res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_write_cmd</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_CMD_GET_SDTV_RESOLUTION_SUPPORT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">tv_res</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tv_res</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_read_response</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reply</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sdvo_tv_modes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">nmode</span><span class="p">;</span>
			<span class="n">nmode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">sdvo_tv_modes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nmode</span><span class="p">)</span>
				<span class="n">drm_mode_probed_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">nmode</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_get_lvds_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">newmode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Attempt to get the mode list from DDC.</span>
<span class="cm">	 * Assume that the preferred modes are</span>
<span class="cm">	 * arranged in priority order.</span>
<span class="cm">	 */</span>
	<span class="n">intel_ddc_get_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

	<span class="cm">/* Fetch modes from VBT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_vbt_mode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newmode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_vbt_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newmode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Guarantee the mode is preferred */</span>
			<span class="n">newmode</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">DRM_MODE_TYPE_PREFERRED</span> <span class="o">|</span>
					 <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">);</span>
			<span class="n">drm_mode_probed_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">newmode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">newmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newmode</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span> <span class="o">=</span>
				<span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">newmode</span><span class="p">);</span>

			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_sdvo_get_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">to_intel_sdvo_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_TV</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">))</span>
		<span class="n">intel_sdvo_get_tv_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_LVDS</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">))</span>
		<span class="n">intel_sdvo_get_lvds_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">intel_sdvo_get_ddc_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_sdvo_destroy_enhance_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">to_intel_sdvo_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">hpos</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">hpos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">vpos</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">vpos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">sharpness</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">sharpness</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">flicker_filter</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">flicker_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">flicker_filter_2d</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">flicker_filter_2d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">flicker_filter_adaptive</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">flicker_filter_adaptive</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_luma_filter</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_luma_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_chroma_filter</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_chroma_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">dot_crawl</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">dot_crawl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">to_intel_sdvo_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">)</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">);</span>

	<span class="n">intel_sdvo_destroy_enhance_property</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">drm_sysfs_connector_remove</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">drm_connector_cleanup</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_detect_hdmi_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_hdmi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_sdvo_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">edid</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">&amp;</span> <span class="n">DRM_EDID_INPUT_DIGITAL</span><span class="p">)</span>
		<span class="n">has_audio</span> <span class="o">=</span> <span class="n">drm_detect_monitor_audio</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">has_audio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_sdvo_set_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
			<span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">intel_attached_sdvo</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">to_intel_sdvo_connector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">temp_value</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">force_audio_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">has_audio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">force_audio</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">force_audio</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HDMI_AUDIO_AUTO</span><span class="p">)</span>
			<span class="n">has_audio</span> <span class="o">=</span> <span class="n">intel_sdvo_detect_hdmi_audio</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">has_audio</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HDMI_AUDIO_ON</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">has_audio</span> <span class="o">==</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_audio</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">has_hdmi_audio</span> <span class="o">=</span> <span class="n">has_audio</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">broadcast_rgb_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="o">!!</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">color_range</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">color_range</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">SDVO_COLOR_RANGE_16_235</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#define CHECK_PROPERTY(name, NAME) \</span>
<span class="cp">	if (intel_sdvo_connector-&gt;name == property) { \</span>
<span class="cp">		if (intel_sdvo_connector-&gt;cur_##name == temp_value) return 0; \</span>
<span class="cp">		if (intel_sdvo_connector-&gt;max_##name &lt; temp_value) return -EINVAL; \</span>
<span class="cp">		cmd = SDVO_CMD_SET_##NAME; \</span>
<span class="cp">		intel_sdvo_connector-&gt;cur_##name = temp_value; \</span>
<span class="cp">		goto set_value; \</span>
<span class="cp">	}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">TV_FORMAT_NUM</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">tv_format_index</span> <span class="o">==</span>
		    <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format_supported</span><span class="p">[</span><span class="n">val</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">tv_format_index</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format_supported</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_TV_OR_LVDS</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp_value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">==</span> <span class="n">property</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
							 <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">==</span> <span class="n">temp_value</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">temp_value</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">max_hscan</span> <span class="o">-</span>
				<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SDVO_CMD_SET_OVERSCAN_H</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">==</span> <span class="n">property</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
							 <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">==</span> <span class="n">temp_value</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">temp_value</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">max_hscan</span> <span class="o">-</span>
				<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SDVO_CMD_SET_OVERSCAN_H</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">==</span> <span class="n">property</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
							 <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span> <span class="o">==</span> <span class="n">temp_value</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">temp_value</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">max_vscan</span> <span class="o">-</span>
				<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SDVO_CMD_SET_OVERSCAN_V</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">==</span> <span class="n">property</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
							 <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom_margin</span> <span class="o">==</span> <span class="n">temp_value</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="n">temp_value</span><span class="p">;</span>
			<span class="n">temp_value</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">max_vscan</span> <span class="o">-</span>
				<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">SDVO_CMD_SET_OVERSCAN_V</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">set_value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">HPOS</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">VPOS</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">saturation</span><span class="p">,</span> <span class="n">SATURATION</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">CONTRAST</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">HUE</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="n">BRIGHTNESS</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span> <span class="n">SHARPNESS</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">flicker_filter</span><span class="p">,</span> <span class="n">FLICKER_FILTER</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">flicker_filter_2d</span><span class="p">,</span> <span class="n">FLICKER_FILTER_2D</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">flicker_filter_adaptive</span><span class="p">,</span> <span class="n">FLICKER_FILTER_ADAPTIVE</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">tv_chroma_filter</span><span class="p">,</span> <span class="n">TV_CHROMA_FILTER</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">tv_luma_filter</span><span class="p">,</span> <span class="n">TV_LUMA_FILTER</span><span class="p">)</span>
		<span class="n">CHECK_PROPERTY</span><span class="p">(</span><span class="n">dot_crawl</span><span class="p">,</span> <span class="n">DOT_CRAWL</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* unknown property */</span>

<span class="nl">set_value:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_value</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>


<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>
		<span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span>
					 <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#undef CHECK_PROPERTY</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">intel_sdvo_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">intel_sdvo_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">intel_sdvo_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">intel_encoder_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">intel_sdvo_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">intel_encoder_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_connector_funcs</span> <span class="n">intel_sdvo_connector_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">drm_helper_connector_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">intel_sdvo_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_modes</span> <span class="o">=</span> <span class="n">drm_helper_probe_single_connector_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_property</span> <span class="o">=</span> <span class="n">intel_sdvo_set_property</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_sdvo_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_connector_helper_funcs</span> <span class="n">intel_sdvo_connector_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_modes</span> <span class="o">=</span> <span class="n">intel_sdvo_get_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_valid</span> <span class="o">=</span> <span class="n">intel_sdvo_mode_valid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">best_encoder</span> <span class="o">=</span> <span class="n">intel_best_encoder</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_sdvo_enc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">to_intel_sdvo</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_lvds_fixed_mode</span><span class="p">);</span>

	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">);</span>
	<span class="n">intel_encoder_destroy</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_funcs</span> <span class="n">intel_sdvo_enc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_sdvo_enc_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_sdvo_guess_ddc_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_bits</span><span class="p">;</span>

	<span class="cm">/* Make a mask of outputs less than or equal to our own priority in the</span>
<span class="cm">	 * list.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SDVO_OUTPUT_LVDS1</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_LVDS1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SDVO_OUTPUT_LVDS0</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_LVDS0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SDVO_OUTPUT_TMDS1</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_TMDS1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SDVO_OUTPUT_TMDS0</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_TMDS0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SDVO_OUTPUT_RGB1</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_RGB1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SDVO_OUTPUT_RGB0</span>:
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_RGB0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Count bits to find what number we are in the priority list. */</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">output_flags</span><span class="p">;</span>
	<span class="n">num_bits</span> <span class="o">=</span> <span class="n">hweight16</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="cm">/* If more than 3 outputs, default to DDC bus 3 for now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_bits</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">num_bits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* Corresponds to SDVO_CONTROL_BUS_DDCx */</span>
	<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc_bus</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">num_bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Choose the appropriate DDC bus for control bus switch command for this</span>
<span class="cm"> * SDVO output based on the controlled output.</span>
<span class="cm"> *</span>
<span class="cm"> * DDC bus number assignment is in a priority order of RGB outputs, then TMDS</span>
<span class="cm"> * outputs, then LVDS outputs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_sdvo_select_ddc_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdvo_device_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">is_sdvob</span><span class="p">)</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc_bus</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">ddc_pin</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">intel_sdvo_guess_ddc_bus</span><span class="p">(</span><span class="n">sdvo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_sdvo_select_i2c_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdvo_device_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">is_sdvob</span><span class="p">)</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">pin</span> <span class="o">=</span> <span class="n">GMBUS_PORT_DPB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">pin</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">i2c_pin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_gmbus_is_port_valid</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">intel_gmbus_get_adapter</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
		<span class="n">intel_gmbus_set_speed</span><span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">GMBUS_RATE_1MHZ</span><span class="p">);</span>
		<span class="n">intel_gmbus_force_bit</span><span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span> <span class="o">=</span> <span class="n">intel_gmbus_get_adapter</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">GMBUS_PORT_DPB</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_is_hdmi_connector</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_sdvo_check_supp_encode</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">intel_sdvo_get_slave_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdvo_device_mapping</span> <span class="o">*</span><span class="n">my_mapping</span><span class="p">,</span> <span class="o">*</span><span class="n">other_mapping</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">is_sdvob</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">my_mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">other_mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">my_mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">other_mapping</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">sdvo_mappings</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* If the BIOS described our SDVO device, take advantage of it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">my_mapping</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">my_mapping</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">;</span>

	<span class="cm">/* If the BIOS only described a different SDVO device, use the</span>
<span class="cm">	 * address that it isn&#39;t using.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other_mapping</span><span class="o">-&gt;</span><span class="n">slave_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">other_mapping</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">==</span> <span class="mh">0x70</span><span class="p">)</span>
			<span class="k">return</span> <span class="mh">0x72</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No SDVO device info is found for another DVO port,</span>
<span class="cm">	 * so use mapping assumption we had before BIOS parsing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">is_sdvob</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mh">0x72</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_sdvo_connector_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_connector_init</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">intel_sdvo_connector_funcs</span><span class="p">,</span>
			   <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">connector_type</span><span class="p">);</span>

	<span class="n">drm_connector_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">intel_sdvo_connector_helper_funcs</span><span class="p">);</span>

	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">interlace_allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">doublescan_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">display_info</span><span class="p">.</span><span class="n">subpixel_order</span> <span class="o">=</span> <span class="n">SubPixelHorizontalRGB</span><span class="p">;</span>

	<span class="n">intel_connector_attach_encoder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">drm_sysfs_connector_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_sdvo_add_hdmi_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">intel_attach_force_audio_property</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">IS_MOBILE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_attach_broadcast_rgb_property</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_dvi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span> <span class="o">=</span> <span class="n">to_intel_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">intel_connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">;</span>

	<span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_TMDS0</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">=</span> <span class="n">SDVO_OUTPUT_TMDS0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_TMDS1</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">=</span> <span class="n">SDVO_OUTPUT_TMDS1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_supports_hotplug</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">=</span> <span class="n">DRM_CONNECTOR_POLL_HPD</span><span class="p">;</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">hotplug_active</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">device</span><span class="p">;</span>
		<span class="cm">/* Some SDVO devices have one-shot hotplug interrupts.</span>
<span class="cm">		 * Ensure that they get re-enabled when an interrupt happens.</span>
<span class="cm">		 */</span>
		<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">hot_plug</span> <span class="o">=</span> <span class="n">intel_sdvo_enable_hotplug</span><span class="p">;</span>
		<span class="n">intel_sdvo_enable_hotplug</span><span class="p">(</span><span class="n">intel_encoder</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">=</span> <span class="n">DRM_CONNECTOR_POLL_CONNECT</span> <span class="o">|</span> <span class="n">DRM_CONNECTOR_POLL_DISCONNECT</span><span class="p">;</span>
	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_type</span> <span class="o">=</span> <span class="n">DRM_MODE_ENCODER_TMDS</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_is_hdmi_connector</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">;</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_hdmi</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_SDVO_NON_TV_CLONE_BIT</span><span class="p">)</span> <span class="o">|</span>
				       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_ANALOG_CLONE_BIT</span><span class="p">));</span>

	<span class="n">intel_sdvo_connector_init</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_hdmi</span><span class="p">)</span>
		<span class="n">intel_sdvo_add_hdmi_properties</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_tv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">intel_connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">;</span>

	<span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_type</span> <span class="o">=</span> <span class="n">DRM_MODE_ENCODER_TVDAC</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">;</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">|=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_tv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">needs_tv_clock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_SDVO_TV_CLONE_BIT</span><span class="p">;</span>

	<span class="n">intel_sdvo_connector_init</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_tv_create_property</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_create_enhance_property</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">intel_sdvo_destroy</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_analog_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">intel_connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">;</span>

	<span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">=</span> <span class="n">DRM_CONNECTOR_POLL_CONNECT</span><span class="p">;</span>
	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_type</span> <span class="o">=</span> <span class="n">DRM_MODE_ENCODER_DAC</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_RGB0</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">=</span> <span class="n">SDVO_OUTPUT_RGB0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_RGB1</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">=</span> <span class="n">SDVO_OUTPUT_RGB1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_SDVO_NON_TV_CLONE_BIT</span><span class="p">)</span> <span class="o">|</span>
				       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_ANALOG_CLONE_BIT</span><span class="p">));</span>

	<span class="n">intel_sdvo_connector_init</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">,</span>
				  <span class="n">intel_sdvo</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_lvds_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">intel_connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">;</span>

	<span class="n">intel_sdvo_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_type</span> <span class="o">=</span> <span class="n">DRM_MODE_ENCODER_LVDS</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_LVDS0</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">=</span> <span class="n">SDVO_OUTPUT_LVDS0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">|=</span> <span class="n">SDVO_OUTPUT_LVDS1</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">output_flag</span> <span class="o">=</span> <span class="n">SDVO_OUTPUT_LVDS1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_ANALOG_CLONE_BIT</span><span class="p">)</span> <span class="o">|</span>
				       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_SDVO_LVDS_CLONE_BIT</span><span class="p">));</span>

	<span class="n">intel_sdvo_connector_init</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_create_enhance_property</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">intel_sdvo_destroy</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_output_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_tv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">needs_tv_clock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_lvds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* SDVO requires XXX1 function may not exist unless it has XXX0 function.*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_OUTPUT_TMDS0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_dvi_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_TMDS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SDVO_TMDS_MASK</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_dvi_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* TV has no XXX1 function block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_OUTPUT_SVID0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_tv_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_OUTPUT_SVID0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_OUTPUT_CVBS0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_tv_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_OUTPUT_CVBS0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_OUTPUT_YPRPB0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_tv_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_OUTPUT_YPRPB0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_OUTPUT_RGB0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_analog_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_RGB_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SDVO_RGB_MASK</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_analog_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_OUTPUT_LVDS0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_lvds_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_LVDS_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SDVO_LVDS_MASK</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_lvds_init</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDVO_OUTPUT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">controlled_output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">output_flags</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;%s: Unknown SDVO output type (0x%02x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">SDVO_NAME</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">),</span>
			      <span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">crtc_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_tv_create_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo_tv_format</span> <span class="n">format</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">format_map</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_target_output</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				  <span class="n">SDVO_CMD_GET_SUPPORTED_TV_FORMATS</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">)))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">format_map</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format_map</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">format_supported_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TV_FORMAT_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">format_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format_supported</span><span class="p">[</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">format_supported_num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>


	<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format</span> <span class="o">=</span>
			<span class="n">drm_property_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRM_MODE_PROP_ENUM</span><span class="p">,</span>
					    <span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">format_supported_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">format_supported_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">drm_property_add_enum</span><span class="p">(</span>
				<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">tv_format_names</span><span class="p">[</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format_supported</span><span class="p">[</span><span class="n">i</span><span class="p">]]);</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">tv_format_index</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format_supported</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
				      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">tv_format</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#define ENHANCEMENT(name, NAME) do { \</span>
<span class="cp">	if (enhancements.name) { \</span>
<span class="cp">		if (!intel_sdvo_get_value(intel_sdvo, SDVO_CMD_GET_MAX_##NAME, &amp;data_value, 4) || \</span>
<span class="cp">		    !intel_sdvo_get_value(intel_sdvo, SDVO_CMD_GET_##NAME, &amp;response, 2)) \</span>
<span class="cp">			return false; \</span>
<span class="cp">		intel_sdvo_connector-&gt;max_##name = data_value[0]; \</span>
<span class="cp">		intel_sdvo_connector-&gt;cur_##name = response; \</span>
<span class="cp">		intel_sdvo_connector-&gt;name = \</span>
<span class="cp">			drm_property_create_range(dev, 0, #name, 0, data_value[0]); \</span>
<span class="cp">		if (!intel_sdvo_connector-&gt;name) return false; \</span>
<span class="cp">		drm_connector_attach_property(connector, \</span>
<span class="cp">					      intel_sdvo_connector-&gt;name, \</span>
<span class="cp">					      intel_sdvo_connector-&gt;cur_##name); \</span>
<span class="cp">		DRM_DEBUG_KMS(#name &quot;: max %d, default %d, current %d\n&quot;, \</span>
<span class="cp">			      data_value[0], data_value[1], response); \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_create_enhance_property_tv</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">intel_sdvo_enhancements_reply</span> <span class="n">enhancements</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">response</span><span class="p">,</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* when horizontal overscan is supported, Add the left/right  property */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enhancements</span><span class="p">.</span><span class="n">overscan_h</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">SDVO_CMD_GET_MAX_OVERSCAN_H</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">data_value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">SDVO_CMD_GET_OVERSCAN_H</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">response</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">max_hscan</span> <span class="o">=</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">response</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span>
			<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;left_margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">);</span>

		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span>
			<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;right_margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">right_margin</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;h_overscan: max %d, &quot;</span>
			      <span class="s">&quot;default %d, current %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">response</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enhancements</span><span class="p">.</span><span class="n">overscan_v</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">SDVO_CMD_GET_MAX_OVERSCAN_V</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">data_value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
					  <span class="n">SDVO_CMD_GET_OVERSCAN_V</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">response</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">max_vscan</span> <span class="o">=</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span> <span class="o">=</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">response</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span>
			<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="s">&quot;top_margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">top_margin</span><span class="p">);</span>

		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">=</span>
			<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="s">&quot;bottom_margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">bottom_margin</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;v_overscan: max %d, &quot;</span>
			      <span class="s">&quot;default %d, current %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">data_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">response</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">hpos</span><span class="p">,</span> <span class="n">HPOS</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">vpos</span><span class="p">,</span> <span class="n">VPOS</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">saturation</span><span class="p">,</span> <span class="n">SATURATION</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">CONTRAST</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">HUE</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">sharpness</span><span class="p">,</span> <span class="n">SHARPNESS</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="n">BRIGHTNESS</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">flicker_filter</span><span class="p">,</span> <span class="n">FLICKER_FILTER</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">flicker_filter_adaptive</span><span class="p">,</span> <span class="n">FLICKER_FILTER_ADAPTIVE</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">flicker_filter_2d</span><span class="p">,</span> <span class="n">FLICKER_FILTER_2D</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">tv_chroma_filter</span><span class="p">,</span> <span class="n">TV_CHROMA_FILTER</span><span class="p">);</span>
	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">tv_luma_filter</span><span class="p">,</span> <span class="n">TV_LUMA_FILTER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enhancements</span><span class="p">.</span><span class="n">dot_crawl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_GET_DOT_CRAWL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">max_dot_crawl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">cur_dot_crawl</span> <span class="o">=</span> <span class="n">response</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">dot_crawl</span> <span class="o">=</span>
			<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dot_crawl&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">dot_crawl</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">dot_crawl</span><span class="p">,</span>
					      <span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">cur_dot_crawl</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;dot crawl: current %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_create_enhance_property_lvds</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">intel_sdvo_enhancements_reply</span> <span class="n">enhancements</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">response</span><span class="p">,</span> <span class="n">data_value</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">ENHANCEMENT</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="n">BRIGHTNESS</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#undef ENHANCEMENT</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">intel_sdvo_create_enhance_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">intel_sdvo_connector</span> <span class="o">*</span><span class="n">intel_sdvo_connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_sdvo_enhancements_reply</span> <span class="n">reply</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">response</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">enhancements</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">enhancements</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">enhancements</span><span class="p">.</span><span class="n">response</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
			     <span class="n">SDVO_CMD_GET_SUPPORTED_ENHANCEMENTS</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">enhancements</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">enhancements</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enhancements</span><span class="p">.</span><span class="n">response</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;No enhancement is supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_TV</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">intel_sdvo_create_enhance_property_tv</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="p">,</span> <span class="n">enhancements</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_LVDS</span><span class="p">(</span><span class="n">intel_sdvo_connector</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">intel_sdvo_create_enhance_property_lvds</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">intel_sdvo_connector</span><span class="p">,</span> <span class="n">enhancements</span><span class="p">.</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_sdvo_ddc_proxy_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_control_bus_switch</span><span class="p">(</span><span class="n">sdvo</span><span class="p">,</span> <span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc_bus</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">algo</span><span class="o">-&gt;</span><span class="n">master_xfer</span><span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">intel_sdvo_ddc_proxy_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="o">-&gt;</span><span class="n">algo</span><span class="o">-&gt;</span><span class="n">functionality</span><span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">i2c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">intel_sdvo_ddc_proxy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>	<span class="o">=</span> <span class="n">intel_sdvo_ddc_proxy_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span>	<span class="o">=</span> <span class="n">intel_sdvo_ddc_proxy_func</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_sdvo_init_ddc_proxy</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">sdvo</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">I2C_CLASS_DDC</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">,</span> <span class="s">&quot;SDVO DDC proxy&quot;</span><span class="p">);</span>
	<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="n">sdvo</span><span class="p">;</span>
	<span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">.</span><span class="n">algo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo_ddc_proxy</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">intel_sdvo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sdvo_reg</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_sdvob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_sdvo</span> <span class="o">*</span><span class="n">intel_sdvo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">intel_sdvo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_sdvo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">sdvo_reg</span> <span class="o">=</span> <span class="n">sdvo_reg</span><span class="p">;</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_sdvob</span> <span class="o">=</span> <span class="n">is_sdvob</span><span class="p">;</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">slave_addr</span> <span class="o">=</span> <span class="n">intel_sdvo_get_slave_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intel_sdvo_select_i2c_bus</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">sdvo_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_init_ddc_proxy</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* encoder type will be decided later */</span>
	<span class="n">intel_encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">INTEL_OUTPUT_SDVO</span><span class="p">;</span>
	<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_sdvo_enc_funcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Read the regs to test if we can talk to the device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_read_byte</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;No SDVO device found on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">SDVO_NAME</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">is_sdvob</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">|=</span> <span class="n">SDVOB_HOTPLUG_INT_STATUS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">|=</span> <span class="n">SDVOC_HOTPLUG_INT_STATUS</span><span class="p">;</span>

	<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_sdvo_helper_funcs</span><span class="p">);</span>

	<span class="cm">/* In default case sdvo lvds is false */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_capabilities</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set up hotplug command - note paranoia about contents of reply.</span>
<span class="cm">	 * We assume that the hardware is in a sane state, and only touch</span>
<span class="cm">	 * the bits we think we understand.</span>
<span class="cm">	 */</span>
	<span class="n">intel_sdvo_get_value</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">SDVO_CMD_GET_ACTIVE_HOT_PLUG</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">hotplug_active</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">hotplug_active</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_sdvo_output_setup</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
				    <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">output_flags</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;SDVO output failed to setup on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">SDVO_NAME</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_sdvo_select_ddc_bus</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="p">,</span> <span class="n">sdvo_reg</span><span class="p">);</span>

	<span class="cm">/* Set the input timing to the screen. Assume always input 0. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_set_target_input</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_sdvo_get_input_pixel_clock_range</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">pixel_clock_min</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">pixel_clock_max</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;%s device VID/DID: %02X:%02X.%02X, &quot;</span>
			<span class="s">&quot;clock range %dMHz - %dMHz, &quot;</span>
			<span class="s">&quot;input 1: %c, input 2: %c, &quot;</span>
			<span class="s">&quot;output 1: %c, output 2: %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">SDVO_NAME</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">),</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">device_rev_id</span><span class="p">,</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">pixel_clock_min</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">pixel_clock_max</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
			<span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">sdvo_inputs_mask</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">sdvo_inputs_mask</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span>
			<span class="cm">/* check currently supported outputs */</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">output_flags</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">SDVO_OUTPUT_TMDS0</span> <span class="o">|</span> <span class="n">SDVO_OUTPUT_RGB0</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span>
			<span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">output_flags</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">SDVO_OUTPUT_TMDS1</span> <span class="o">|</span> <span class="n">SDVO_OUTPUT_RGB1</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">drm_encoder_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_sdvo</span><span class="o">-&gt;</span><span class="n">ddc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">intel_sdvo</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
