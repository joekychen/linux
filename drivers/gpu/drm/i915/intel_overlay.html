<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › intel_overlay.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>intel_overlay.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2009</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm"> * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm"> * SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Daniel Vetter &lt;daniel@ffwll.ch&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Derived from Xorg ddx, xf86-video-intel, src/i830_video.c</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;i915_reg.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>

<span class="cm">/* Limits for overlay size. According to intel doc, the real limits are:</span>
<span class="cm"> * Y width: 4095, UV width (planar): 2047, Y height: 2047,</span>
<span class="cm"> * UV width (planar): * 1023. But the xorg thinks 2048 for height and width. Use</span>
<span class="cm"> * the mininum of both.  */</span>
<span class="cp">#define IMAGE_MAX_WIDTH		2048</span>
<span class="cp">#define IMAGE_MAX_HEIGHT	2046 </span><span class="cm">/* 2 * 1023 */</span><span class="cp"></span>
<span class="cm">/* on 830 and 845 these large limits result in the card hanging */</span>
<span class="cp">#define IMAGE_MAX_WIDTH_LEGACY	1024</span>
<span class="cp">#define IMAGE_MAX_HEIGHT_LEGACY	1088</span>

<span class="cm">/* overlay register definitions */</span>
<span class="cm">/* OCMD register */</span>
<span class="cp">#define OCMD_TILED_SURFACE	(0x1&lt;&lt;19)</span>
<span class="cp">#define OCMD_MIRROR_MASK	(0x3&lt;&lt;17)</span>
<span class="cp">#define OCMD_MIRROR_MODE	(0x3&lt;&lt;17)</span>
<span class="cp">#define OCMD_MIRROR_HORIZONTAL	(0x1&lt;&lt;17)</span>
<span class="cp">#define OCMD_MIRROR_VERTICAL	(0x2&lt;&lt;17)</span>
<span class="cp">#define OCMD_MIRROR_BOTH	(0x3&lt;&lt;17)</span>
<span class="cp">#define OCMD_BYTEORDER_MASK	(0x3&lt;&lt;14) </span><span class="cm">/* zero for YUYV or FOURCC YUY2 */</span><span class="cp"></span>
<span class="cp">#define OCMD_UV_SWAP		(0x1&lt;&lt;14) </span><span class="cm">/* YVYU */</span><span class="cp"></span>
<span class="cp">#define OCMD_Y_SWAP		(0x2&lt;&lt;14) </span><span class="cm">/* UYVY or FOURCC UYVY */</span><span class="cp"></span>
<span class="cp">#define OCMD_Y_AND_UV_SWAP	(0x3&lt;&lt;14) </span><span class="cm">/* VYUY */</span><span class="cp"></span>
<span class="cp">#define OCMD_SOURCE_FORMAT_MASK (0xf&lt;&lt;10)</span>
<span class="cp">#define OCMD_RGB_888		(0x1&lt;&lt;10) </span><span class="cm">/* not in i965 Intel docs */</span><span class="cp"></span>
<span class="cp">#define OCMD_RGB_555		(0x2&lt;&lt;10) </span><span class="cm">/* not in i965 Intel docs */</span><span class="cp"></span>
<span class="cp">#define OCMD_RGB_565		(0x3&lt;&lt;10) </span><span class="cm">/* not in i965 Intel docs */</span><span class="cp"></span>
<span class="cp">#define OCMD_YUV_422_PACKED	(0x8&lt;&lt;10)</span>
<span class="cp">#define OCMD_YUV_411_PACKED	(0x9&lt;&lt;10) </span><span class="cm">/* not in i965 Intel docs */</span><span class="cp"></span>
<span class="cp">#define OCMD_YUV_420_PLANAR	(0xc&lt;&lt;10)</span>
<span class="cp">#define OCMD_YUV_422_PLANAR	(0xd&lt;&lt;10)</span>
<span class="cp">#define OCMD_YUV_410_PLANAR	(0xe&lt;&lt;10) </span><span class="cm">/* also 411 */</span><span class="cp"></span>
<span class="cp">#define OCMD_TVSYNCFLIP_PARITY	(0x1&lt;&lt;9)</span>
<span class="cp">#define OCMD_TVSYNCFLIP_ENABLE	(0x1&lt;&lt;7)</span>
<span class="cp">#define OCMD_BUF_TYPE_MASK	(0x1&lt;&lt;5)</span>
<span class="cp">#define OCMD_BUF_TYPE_FRAME	(0x0&lt;&lt;5)</span>
<span class="cp">#define OCMD_BUF_TYPE_FIELD	(0x1&lt;&lt;5)</span>
<span class="cp">#define OCMD_TEST_MODE		(0x1&lt;&lt;4)</span>
<span class="cp">#define OCMD_BUFFER_SELECT	(0x3&lt;&lt;2)</span>
<span class="cp">#define OCMD_BUFFER0		(0x0&lt;&lt;2)</span>
<span class="cp">#define OCMD_BUFFER1		(0x1&lt;&lt;2)</span>
<span class="cp">#define OCMD_FIELD_SELECT	(0x1&lt;&lt;2)</span>
<span class="cp">#define OCMD_FIELD0		(0x0&lt;&lt;1)</span>
<span class="cp">#define OCMD_FIELD1		(0x1&lt;&lt;1)</span>
<span class="cp">#define OCMD_ENABLE		(0x1&lt;&lt;0)</span>

<span class="cm">/* OCONFIG register */</span>
<span class="cp">#define OCONF_PIPE_MASK		(0x1&lt;&lt;18)</span>
<span class="cp">#define OCONF_PIPE_A		(0x0&lt;&lt;18)</span>
<span class="cp">#define OCONF_PIPE_B		(0x1&lt;&lt;18)</span>
<span class="cp">#define OCONF_GAMMA2_ENABLE	(0x1&lt;&lt;16)</span>
<span class="cp">#define OCONF_CSC_MODE_BT601	(0x0&lt;&lt;5)</span>
<span class="cp">#define OCONF_CSC_MODE_BT709	(0x1&lt;&lt;5)</span>
<span class="cp">#define OCONF_CSC_BYPASS	(0x1&lt;&lt;4)</span>
<span class="cp">#define OCONF_CC_OUT_8BIT	(0x1&lt;&lt;3)</span>
<span class="cp">#define OCONF_TEST_MODE		(0x1&lt;&lt;2)</span>
<span class="cp">#define OCONF_THREE_LINE_BUFFER	(0x1&lt;&lt;0)</span>
<span class="cp">#define OCONF_TWO_LINE_BUFFER	(0x0&lt;&lt;0)</span>

<span class="cm">/* DCLRKM (dst-key) register */</span>
<span class="cp">#define DST_KEY_ENABLE		(0x1&lt;&lt;31)</span>
<span class="cp">#define CLK_RGB24_MASK		0x0</span>
<span class="cp">#define CLK_RGB16_MASK		0x070307</span>
<span class="cp">#define CLK_RGB15_MASK		0x070707</span>
<span class="cp">#define CLK_RGB8I_MASK		0xffffff</span>

<span class="cp">#define RGB16_TO_COLORKEY(c) \</span>
<span class="cp">	(((c &amp; 0xF800) &lt;&lt; 8) | ((c &amp; 0x07E0) &lt;&lt; 5) | ((c &amp; 0x001F) &lt;&lt; 3))</span>
<span class="cp">#define RGB15_TO_COLORKEY(c) \</span>
<span class="cp">	(((c &amp; 0x7c00) &lt;&lt; 9) | ((c &amp; 0x03E0) &lt;&lt; 6) | ((c &amp; 0x001F) &lt;&lt; 3))</span>

<span class="cm">/* overlay flip addr flag */</span>
<span class="cp">#define OFC_UPDATE		0x1</span>

<span class="cm">/* polyphase filter coefficients */</span>
<span class="cp">#define N_HORIZ_Y_TAPS          5</span>
<span class="cp">#define N_VERT_Y_TAPS           3</span>
<span class="cp">#define N_HORIZ_UV_TAPS         3</span>
<span class="cp">#define N_VERT_UV_TAPS          3</span>
<span class="cp">#define N_PHASES                17</span>
<span class="cp">#define MAX_TAPS                5</span>

<span class="cm">/* memory bufferd overlay registers */</span>
<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">OBUF_0Y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OBUF_1Y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OBUF_0U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OBUF_0V</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OBUF_1U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OBUF_1V</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OSTRIDE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">YRGB_VPH</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">UV_VPH</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">HORZ_PH</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">INIT_PHS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">DWINPOS</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">DWINSZ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SWIDTH</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SWIDTHSW</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SHEIGHT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">YRGBSCALE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">UVSCALE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OCLRC0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OCLRC1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">DCLRKV</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">DCLRKM</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SCLRKVH</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SCLRKVL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">SCLRKEN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OCONFIG</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OCMD</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">RESERVED1</span><span class="p">;</span> <span class="cm">/* 0x6C */</span>
	<span class="n">u32</span> <span class="n">OSTART_0Y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OSTART_1Y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OSTART_0U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OSTART_0V</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OSTART_1U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OSTART_1V</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OTILEOFF_0Y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OTILEOFF_1Y</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OTILEOFF_0U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OTILEOFF_0V</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OTILEOFF_1U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">OTILEOFF_1V</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">FASTHSCALE</span><span class="p">;</span> <span class="cm">/* 0xA0 */</span>
	<span class="n">u32</span> <span class="n">UVSCALEV</span><span class="p">;</span> <span class="cm">/* 0xA4 */</span>
	<span class="n">u32</span> <span class="n">RESERVEDC</span><span class="p">[(</span><span class="mh">0x200</span> <span class="o">-</span> <span class="mh">0xA8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span> <span class="cm">/* 0xA8 - 0x1FC */</span>
	<span class="n">u16</span> <span class="n">Y_VCOEFS</span><span class="p">[</span><span class="n">N_VERT_Y_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span> <span class="cm">/* 0x200 */</span>
	<span class="n">u16</span> <span class="n">RESERVEDD</span><span class="p">[</span><span class="mh">0x100</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">N_VERT_Y_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">Y_HCOEFS</span><span class="p">[</span><span class="n">N_HORIZ_Y_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span> <span class="cm">/* 0x300 */</span>
	<span class="n">u16</span> <span class="n">RESERVEDE</span><span class="p">[</span><span class="mh">0x200</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">N_HORIZ_Y_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">UV_VCOEFS</span><span class="p">[</span><span class="n">N_VERT_UV_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span> <span class="cm">/* 0x500 */</span>
	<span class="n">u16</span> <span class="n">RESERVEDF</span><span class="p">[</span><span class="mh">0x100</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">N_VERT_UV_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">UV_HCOEFS</span><span class="p">[</span><span class="n">N_HORIZ_UV_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span> <span class="cm">/* 0x600 */</span>
	<span class="n">u16</span> <span class="n">RESERVEDG</span><span class="p">[</span><span class="mh">0x100</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">N_HORIZ_UV_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">intel_overlay</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">vid_bo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">old_vid_bo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pfit_active</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pfit_vscale_ratio</span><span class="p">;</span> <span class="cm">/* shifted-point number, (1&lt;&lt;12) == 1.0 */</span>
	<span class="n">u32</span> <span class="n">color_key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">brightness</span><span class="p">,</span> <span class="n">contrast</span><span class="p">,</span> <span class="n">saturation</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_xscale</span><span class="p">,</span> <span class="n">old_yscale</span><span class="p">;</span>
	<span class="cm">/* register access */</span>
	<span class="n">u32</span> <span class="n">flip_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">reg_bo</span><span class="p">;</span>
	<span class="cm">/* flip handling */</span>
	<span class="kt">uint32_t</span> <span class="n">last_flip_req</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">flip_tail</span><span class="p">)(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span>
<span class="nf">intel_overlay_map_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OVERLAY_NEEDS_PHYSICAL</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="n">io_mapping_map_wc</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span><span class="p">,</span>
					 <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_overlay_unmap_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OVERLAY_NEEDS_PHYSICAL</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">io_mapping_unmap</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_overlay_do_wait_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">tail</span><span class="p">)(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_add_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_wait_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">i915_gem_retire_requests</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Workaround for i830 bug where pipe a must be enable to change control regs */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">i830_activate_pipe_a</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="n">vesa_640x480</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DRM_MODE</span><span class="p">(</span><span class="s">&quot;640x480&quot;</span><span class="p">,</span> <span class="n">DRM_MODE_TYPE_DRIVER</span><span class="p">,</span> <span class="mi">25175</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">656</span><span class="p">,</span>
			 <span class="mi">752</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">480</span><span class="p">,</span> <span class="mi">489</span><span class="p">,</span> <span class="mi">492</span><span class="p">,</span> <span class="mi">525</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">DRM_MODE_FLAG_NHSYNC</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_NVSYNC</span><span class="p">)</span>
	<span class="p">},</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">==</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* most i8xx have pipe a forced on, so don&#39;t trust dpms mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">_PIPEACONF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PIPECONF_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Enabling pipe A in order to enable overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vesa_640x480</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
				       <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
				       <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">fb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i830_deactivate_pipe_a</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pipe_to_crtc_mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>

	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* overlay needs to be disable in OCMD reg */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_overlay_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe_a_quirk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I830</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe_a_quirk</span> <span class="o">=</span> <span class="n">i830_activate_pipe_a</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_a_quirk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pipe_a_quirk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_OVERLAY_FLIP</span> <span class="o">|</span> <span class="n">MI_OVERLAY_ON</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_addr</span> <span class="o">|</span> <span class="n">OFC_UPDATE</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_WAIT_FOR_EVENT</span> <span class="o">|</span> <span class="n">MI_WAIT_FOR_OVERLAY_FLIP</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_NOOP</span><span class="p">);</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_do_wait_request</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe_a_quirk</span><span class="p">)</span>
		<span class="n">i830_deactivate_pipe_a</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* overlay needs to be enabled in OCMD reg */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_overlay_continue</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">load_polyphase_filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flip_addr</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">load_polyphase_filter</span><span class="p">)</span>
		<span class="n">flip_addr</span> <span class="o">|=</span> <span class="n">OFC_UPDATE</span><span class="p">;</span>

	<span class="cm">/* check for underruns */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DOVSTA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">))</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;overlay underrun, DOVSTA: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_OVERLAY_FLIP</span> <span class="o">|</span> <span class="n">MI_OVERLAY_CONTINUE</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">flip_addr</span><span class="p">);</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_add_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_overlay_release_old_vid_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_vid_bo</span><span class="p">;</span>

	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_vid_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_overlay_off_tail</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">vid_bo</span><span class="p">;</span>

	<span class="cm">/* never have the overlay hw on without showing a frame */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">vid_bo</span><span class="p">);</span>

	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">vid_bo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">overlay</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* overlay needs to be disabled in OCMD reg */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_overlay_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">flip_addr</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* According to intel docs the overlay hw may hang (when switching</span>
<span class="cm">	 * off) without loading the filter coeffs. It is however unclear whether</span>
<span class="cm">	 * this applies to the disabling of the overlay or to the switching off</span>
<span class="cm">	 * of the hw. Do it in both cases */</span>
	<span class="n">flip_addr</span> <span class="o">|=</span> <span class="n">OFC_UPDATE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* wait for overlay to go idle */</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_OVERLAY_FLIP</span> <span class="o">|</span> <span class="n">MI_OVERLAY_CONTINUE</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">flip_addr</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_WAIT_FOR_EVENT</span> <span class="o">|</span> <span class="n">MI_WAIT_FOR_OVERLAY_FLIP</span><span class="p">);</span>
	<span class="cm">/* turn overlay off */</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_OVERLAY_FLIP</span> <span class="o">|</span> <span class="n">MI_OVERLAY_OFF</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">flip_addr</span><span class="p">);</span>
	<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_WAIT_FOR_EVENT</span> <span class="o">|</span> <span class="n">MI_WAIT_FOR_OVERLAY_FLIP</span><span class="p">);</span>
	<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">intel_overlay_do_wait_request</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
					     <span class="n">intel_overlay_off_tail</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* recover from an interruption due to a signal</span>
<span class="cm"> * We have to be careful not to repeat work forever an make forward progess. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_overlay_recover_from_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_wait_request</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">i915_gem_retire_requests</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_tail</span><span class="p">)</span>
		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_tail</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">last_flip_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait for pending overlay flip and release old frame.</span>
<span class="cm"> * Needs to be called before the overlay register are changed</span>
<span class="cm"> * via intel_overlay_(un)map_regs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_overlay_release_old_vid</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Only wait if there is actually an old frame to release to</span>
<span class="cm">	 * guarantee forward progress.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_vid_bo</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">ISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_PLANE_FLIP_PENDING_INTERRUPT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>

		<span class="cm">/* synchronous slowpath */</span>
		<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ring_begin</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_WAIT_FOR_EVENT</span> <span class="o">|</span> <span class="n">MI_WAIT_FOR_OVERLAY_FLIP</span><span class="p">);</span>
		<span class="n">intel_ring_emit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">MI_NOOP</span><span class="p">);</span>
		<span class="n">intel_ring_advance</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_do_wait_request</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
						    <span class="n">intel_overlay_release_old_vid_tail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_overlay_release_old_vid_tail</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">put_image_params</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">format</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">dst_x</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">dst_y</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">dst_w</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">dst_h</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">src_w</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">src_scan_h</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">src_scan_w</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">src_h</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">stride_Y</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">stride_UV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset_Y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset_U</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset_V</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packed_depth_bytes</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_DEPTH_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV422</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV411</span>:
		<span class="cm">/* return 6; not implemented */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">packed_width_bytes</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">,</span> <span class="kt">short</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_DEPTH_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV422</span>:
		<span class="k">return</span> <span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uv_hsubsampling</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_DEPTH_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV422</span>:
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV420</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV411</span>:
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV410</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uv_vsubsampling</span><span class="p">(</span><span class="n">u32</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_DEPTH_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV420</span>:
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV410</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV422</span>:
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV411</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">calc_swidthsw</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">y_static_hcoeffs</span><span class="p">[</span><span class="n">N_HORIZ_Y_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0xb4a0</span><span class="p">,</span> <span class="mh">0x1930</span><span class="p">,</span> <span class="mh">0x1920</span><span class="p">,</span> <span class="mh">0xb4a0</span><span class="p">,</span>
	<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0xb500</span><span class="p">,</span> <span class="mh">0x19d0</span><span class="p">,</span> <span class="mh">0x1880</span><span class="p">,</span> <span class="mh">0xb440</span><span class="p">,</span>
	<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0xb540</span><span class="p">,</span> <span class="mh">0x1a88</span><span class="p">,</span> <span class="mh">0x2f80</span><span class="p">,</span> <span class="mh">0xb3e0</span><span class="p">,</span>
	<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0xb580</span><span class="p">,</span> <span class="mh">0x1b30</span><span class="p">,</span> <span class="mh">0x2e20</span><span class="p">,</span> <span class="mh">0xb380</span><span class="p">,</span>
	<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0xb5c0</span><span class="p">,</span> <span class="mh">0x1bd8</span><span class="p">,</span> <span class="mh">0x2cc0</span><span class="p">,</span> <span class="mh">0xb320</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb5e0</span><span class="p">,</span> <span class="mh">0x1c60</span><span class="p">,</span> <span class="mh">0x2b80</span><span class="p">,</span> <span class="mh">0xb2c0</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb5e0</span><span class="p">,</span> <span class="mh">0x1cf8</span><span class="p">,</span> <span class="mh">0x2a20</span><span class="p">,</span> <span class="mh">0xb260</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb5e0</span><span class="p">,</span> <span class="mh">0x1d80</span><span class="p">,</span> <span class="mh">0x28e0</span><span class="p">,</span> <span class="mh">0xb200</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb5c0</span><span class="p">,</span> <span class="mh">0x1e08</span><span class="p">,</span> <span class="mh">0x3f40</span><span class="p">,</span> <span class="mh">0xb1c0</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb580</span><span class="p">,</span> <span class="mh">0x1e78</span><span class="p">,</span> <span class="mh">0x3ce0</span><span class="p">,</span> <span class="mh">0xb160</span><span class="p">,</span>
	<span class="mh">0x3040</span><span class="p">,</span> <span class="mh">0xb520</span><span class="p">,</span> <span class="mh">0x1ed8</span><span class="p">,</span> <span class="mh">0x3aa0</span><span class="p">,</span> <span class="mh">0xb120</span><span class="p">,</span>
	<span class="mh">0x3040</span><span class="p">,</span> <span class="mh">0xb4a0</span><span class="p">,</span> <span class="mh">0x1f30</span><span class="p">,</span> <span class="mh">0x3880</span><span class="p">,</span> <span class="mh">0xb0e0</span><span class="p">,</span>
	<span class="mh">0x3040</span><span class="p">,</span> <span class="mh">0xb400</span><span class="p">,</span> <span class="mh">0x1f78</span><span class="p">,</span> <span class="mh">0x3680</span><span class="p">,</span> <span class="mh">0xb0a0</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb340</span><span class="p">,</span> <span class="mh">0x1fb8</span><span class="p">,</span> <span class="mh">0x34a0</span><span class="p">,</span> <span class="mh">0xb060</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb240</span><span class="p">,</span> <span class="mh">0x1fe0</span><span class="p">,</span> <span class="mh">0x32e0</span><span class="p">,</span> <span class="mh">0xb040</span><span class="p">,</span>
	<span class="mh">0x3020</span><span class="p">,</span> <span class="mh">0xb140</span><span class="p">,</span> <span class="mh">0x1ff8</span><span class="p">,</span> <span class="mh">0x3160</span><span class="p">,</span> <span class="mh">0xb020</span><span class="p">,</span>
	<span class="mh">0xb000</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0xb000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">uv_static_hcoeffs</span><span class="p">[</span><span class="n">N_HORIZ_UV_TAPS</span> <span class="o">*</span> <span class="n">N_PHASES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x1800</span><span class="p">,</span> <span class="mh">0x1800</span><span class="p">,</span> <span class="mh">0xb000</span><span class="p">,</span> <span class="mh">0x18d0</span><span class="p">,</span> <span class="mh">0x2e60</span><span class="p">,</span>
	<span class="mh">0xb000</span><span class="p">,</span> <span class="mh">0x1990</span><span class="p">,</span> <span class="mh">0x2ce0</span><span class="p">,</span> <span class="mh">0xb020</span><span class="p">,</span> <span class="mh">0x1a68</span><span class="p">,</span> <span class="mh">0x2b40</span><span class="p">,</span>
	<span class="mh">0xb040</span><span class="p">,</span> <span class="mh">0x1b20</span><span class="p">,</span> <span class="mh">0x29e0</span><span class="p">,</span> <span class="mh">0xb060</span><span class="p">,</span> <span class="mh">0x1bd8</span><span class="p">,</span> <span class="mh">0x2880</span><span class="p">,</span>
	<span class="mh">0xb080</span><span class="p">,</span> <span class="mh">0x1c88</span><span class="p">,</span> <span class="mh">0x3e60</span><span class="p">,</span> <span class="mh">0xb0a0</span><span class="p">,</span> <span class="mh">0x1d28</span><span class="p">,</span> <span class="mh">0x3c00</span><span class="p">,</span>
	<span class="mh">0xb0c0</span><span class="p">,</span> <span class="mh">0x1db8</span><span class="p">,</span> <span class="mh">0x39e0</span><span class="p">,</span> <span class="mh">0xb0e0</span><span class="p">,</span> <span class="mh">0x1e40</span><span class="p">,</span> <span class="mh">0x37e0</span><span class="p">,</span>
	<span class="mh">0xb100</span><span class="p">,</span> <span class="mh">0x1eb8</span><span class="p">,</span> <span class="mh">0x3620</span><span class="p">,</span> <span class="mh">0xb100</span><span class="p">,</span> <span class="mh">0x1f18</span><span class="p">,</span> <span class="mh">0x34a0</span><span class="p">,</span>
	<span class="mh">0xb100</span><span class="p">,</span> <span class="mh">0x1f68</span><span class="p">,</span> <span class="mh">0x3360</span><span class="p">,</span> <span class="mh">0xb0e0</span><span class="p">,</span> <span class="mh">0x1fa8</span><span class="p">,</span> <span class="mh">0x3240</span><span class="p">,</span>
	<span class="mh">0xb0c0</span><span class="p">,</span> <span class="mh">0x1fe0</span><span class="p">,</span> <span class="mh">0x3140</span><span class="p">,</span> <span class="mh">0xb060</span><span class="p">,</span> <span class="mh">0x1ff0</span><span class="p">,</span> <span class="mh">0x30a0</span><span class="p">,</span>
	<span class="mh">0x3000</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">,</span> <span class="mh">0x3000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_polyphase_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Y_HCOEFS</span><span class="p">,</span> <span class="n">y_static_hcoeffs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">y_static_hcoeffs</span><span class="p">));</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">UV_HCOEFS</span><span class="p">,</span> <span class="n">uv_static_hcoeffs</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">uv_static_hcoeffs</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">update_scaling_factors</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">put_image_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* fixed point with a 12 bit shift */</span>
	<span class="n">u32</span> <span class="n">xscale</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">xscale_UV</span><span class="p">,</span> <span class="n">yscale_UV</span><span class="p">;</span>
<span class="cp">#define FP_SHIFT 12</span>
<span class="cp">#define FRACT_MASK 0xfff</span>
	<span class="n">bool</span> <span class="n">scale_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uv_hscale</span> <span class="o">=</span> <span class="n">uv_hsubsampling</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">uv_vscale</span> <span class="o">=</span> <span class="n">uv_vsubsampling</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_w</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">xscale</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">src_scan_w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FP_SHIFT</span><span class="p">)</span>
			<span class="o">/</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_w</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">xscale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FP_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_h</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">yscale</span> <span class="o">=</span> <span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">src_scan_h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">FP_SHIFT</span><span class="p">)</span>
			<span class="o">/</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_h</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">yscale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FP_SHIFT</span><span class="p">;</span>

	<span class="cm">/*if (params-&gt;format &amp; I915_OVERLAY_YUV_PLANAR) {*/</span>
	<span class="n">xscale_UV</span> <span class="o">=</span> <span class="n">xscale</span><span class="o">/</span><span class="n">uv_hscale</span><span class="p">;</span>
	<span class="n">yscale_UV</span> <span class="o">=</span> <span class="n">yscale</span><span class="o">/</span><span class="n">uv_vscale</span><span class="p">;</span>
	<span class="cm">/* make the Y scale to UV scale ratio an exact multiply */</span>
	<span class="n">xscale</span> <span class="o">=</span> <span class="n">xscale_UV</span> <span class="o">*</span> <span class="n">uv_hscale</span><span class="p">;</span>
	<span class="n">yscale</span> <span class="o">=</span> <span class="n">yscale_UV</span> <span class="o">*</span> <span class="n">uv_vscale</span><span class="p">;</span>
	<span class="cm">/*} else {</span>
<span class="cm">	  xscale_UV = 0;</span>
<span class="cm">	  yscale_UV = 0;</span>
<span class="cm">	  }*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xscale</span> <span class="o">!=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_xscale</span> <span class="o">||</span> <span class="n">yscale</span> <span class="o">!=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_yscale</span><span class="p">)</span>
		<span class="n">scale_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_xscale</span> <span class="o">=</span> <span class="n">xscale</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_yscale</span> <span class="o">=</span> <span class="n">yscale</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">yscale</span> <span class="o">&amp;</span> <span class="n">FRACT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">xscale</span> <span class="o">&gt;&gt;</span> <span class="n">FP_SHIFT</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">xscale</span> <span class="o">&amp;</span> <span class="n">FRACT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
		 <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">YRGBSCALE</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">yscale_UV</span> <span class="o">&amp;</span> <span class="n">FRACT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">xscale_UV</span> <span class="o">&gt;&gt;</span> <span class="n">FP_SHIFT</span><span class="p">)</span>  <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">xscale_UV</span> <span class="o">&amp;</span> <span class="n">FRACT_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
		 <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">UVSCALE</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">((((</span><span class="n">yscale</span>    <span class="o">&gt;&gt;</span> <span class="n">FP_SHIFT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">((</span><span class="n">yscale_UV</span> <span class="o">&gt;&gt;</span> <span class="n">FP_SHIFT</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)),</span>
		 <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">UVSCALEV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scale_changed</span><span class="p">)</span>
		<span class="n">update_polyphase_filter</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scale_changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_colorkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">key</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">color_key</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKV</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">CLK_RGB8I_MASK</span> <span class="o">|</span> <span class="n">DST_KEY_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">RGB15_TO_COLORKEY</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKV</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">CLK_RGB15_MASK</span> <span class="o">|</span> <span class="n">DST_KEY_ENABLE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKM</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">RGB16_TO_COLORKEY</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKV</span><span class="p">);</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">CLK_RGB16_MASK</span> <span class="o">|</span> <span class="n">DST_KEY_ENABLE</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKM</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">24</span>:
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKV</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">CLK_RGB24_MASK</span> <span class="o">|</span> <span class="n">DST_KEY_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DCLRKM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">overlay_cmd_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">put_image_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">OCMD_ENABLE</span> <span class="o">|</span> <span class="n">OCMD_BUF_TYPE_FRAME</span> <span class="o">|</span> <span class="n">OCMD_BUFFER0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_YUV_PLANAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_DEPTH_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_YUV422</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_YUV_422_PLANAR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_YUV420</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_YUV_420_PLANAR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_YUV411</span>:
		<span class="k">case</span> <span class="n">I915_OVERLAY_YUV410</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_YUV_410_PLANAR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* YUV packed */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_DEPTH_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_YUV422</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_YUV_422_PACKED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_YUV411</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_YUV_411_PACKED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_SWAP_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_NO_SWAP</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_UV_SWAP</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_UV_SWAP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_Y_SWAP</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_Y_SWAP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">I915_OVERLAY_Y_AND_UV_SWAP</span>:
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">OCMD_Y_AND_UV_SWAP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_overlay_do_put_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">new_bo</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">put_image_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">tmp_width</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">scale_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">swidth</span><span class="p">,</span> <span class="n">swidthsw</span><span class="p">,</span> <span class="n">sheight</span><span class="p">,</span> <span class="n">ostride</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_release_old_vid</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin_to_display_plane</span><span class="p">(</span><span class="n">new_bo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_put_fence</span><span class="p">(</span><span class="n">new_bo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">oconfig</span><span class="p">;</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="n">intel_overlay_map_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">oconfig</span> <span class="o">=</span> <span class="n">OCONF_CC_OUT_8BIT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN4</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">oconfig</span> <span class="o">|=</span> <span class="n">OCONF_CSC_MODE_BT709</span><span class="p">;</span>
		<span class="n">oconfig</span> <span class="o">|=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span>
			<span class="n">OCONF_PIPE_A</span> <span class="o">:</span> <span class="n">OCONF_PIPE_B</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">oconfig</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OCONFIG</span><span class="p">);</span>
		<span class="n">intel_overlay_unmap_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_on</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">intel_overlay_map_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_y</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DWINPOS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_w</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DWINSZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_YUV_PACKED</span><span class="p">)</span>
		<span class="n">tmp_width</span> <span class="o">=</span> <span class="n">packed_width_bytes</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp_width</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="p">;</span>

	<span class="n">swidth</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="p">;</span>
	<span class="n">swidthsw</span> <span class="o">=</span> <span class="n">calc_swidthsw</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_Y</span><span class="p">,</span> <span class="n">tmp_width</span><span class="p">);</span>
	<span class="n">sheight</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_h</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_Y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OBUF_0Y</span><span class="p">);</span>
	<span class="n">ostride</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">stride_Y</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_YUV_PLANAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">uv_hscale</span> <span class="o">=</span> <span class="n">uv_hsubsampling</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">uv_vscale</span> <span class="o">=</span> <span class="n">uv_vsubsampling</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">tmp_U</span><span class="p">,</span> <span class="n">tmp_V</span><span class="p">;</span>
		<span class="n">swidth</span> <span class="o">|=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="o">/</span><span class="n">uv_hscale</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tmp_U</span> <span class="o">=</span> <span class="n">calc_swidthsw</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_U</span><span class="p">,</span>
				      <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="o">/</span><span class="n">uv_hscale</span><span class="p">);</span>
		<span class="n">tmp_V</span> <span class="o">=</span> <span class="n">calc_swidthsw</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_V</span><span class="p">,</span>
				      <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="o">/</span><span class="n">uv_hscale</span><span class="p">);</span>
		<span class="n">swidthsw</span> <span class="o">|=</span> <span class="n">max_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">tmp_U</span><span class="p">,</span> <span class="n">tmp_V</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sheight</span> <span class="o">|=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">src_h</span><span class="o">/</span><span class="n">uv_vscale</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_U</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OBUF_0U</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">gtt_offset</span> <span class="o">+</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_V</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OBUF_0V</span><span class="p">);</span>
		<span class="n">ostride</span> <span class="o">|=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">stride_UV</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">swidth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">SWIDTH</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">swidthsw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">SWIDTHSW</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">sheight</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">SHEIGHT</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">ostride</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OSTRIDE</span><span class="p">);</span>

	<span class="n">scale_changed</span> <span class="o">=</span> <span class="n">update_scaling_factors</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>

	<span class="n">update_colorkey</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">overlay_cmd_reg</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OCMD</span><span class="p">);</span>

	<span class="n">intel_overlay_unmap_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_continue</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">scale_changed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unpin</span><span class="p">;</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">old_vid_bo</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">vid_bo</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">vid_bo</span> <span class="o">=</span> <span class="n">new_bo</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unpin:</span>
	<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">new_bo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intel_overlay_switch_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_recover_from_interrupt</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_release_old_vid</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">intel_overlay_map_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OCMD</span><span class="p">);</span>
	<span class="n">intel_overlay_unmap_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_off</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">intel_overlay_off_tail</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_overlay_possible_on_crtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* can&#39;t use the overlay with double wide pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPECONF</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PIPECONF_DOUBLE_WIDE</span> <span class="o">|</span> <span class="n">PIPECONF_ENABLE</span><span class="p">))</span> <span class="o">!=</span> <span class="n">PIPECONF_ENABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_pfit_vscale_ratio</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pfit_control</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ratio</span><span class="p">;</span>

	<span class="cm">/* XXX: This is not the same logic as in the xorg driver, but more in</span>
<span class="cm">	 * line with the intel documentation for the i965</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* on i965 use the PGM reg to read out the autoscaler values */</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PFIT_PGM_RATIOS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PFIT_VERT_SCALE_SHIFT_965</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pfit_control</span> <span class="o">&amp;</span> <span class="n">VERT_AUTO_SCALE</span><span class="p">)</span>
			<span class="n">ratio</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PFIT_AUTO_RATIOS</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ratio</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PFIT_PGM_RATIOS</span><span class="p">);</span>
		<span class="n">ratio</span> <span class="o">&gt;&gt;=</span> <span class="n">PFIT_VERT_SCALE_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">pfit_vscale_ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_overlay_dst</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_intel_overlay_put_image</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_x</span> <span class="o">&lt;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_x</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_width</span> <span class="o">&lt;=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_y</span> <span class="o">&lt;</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_y</span> <span class="o">+</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_height</span> <span class="o">&lt;=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_overlay_scaling</span><span class="p">(</span><span class="k">struct</span> <span class="n">put_image_params</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* downscaling limit is 8.0 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_scan_h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_h</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_scan_w</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">dst_w</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_overlay_src</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_intel_overlay_put_image</span> <span class="o">*</span><span class="n">rec</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">new_bo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">uv_hscale</span> <span class="o">=</span> <span class="n">uv_hsubsampling</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">uv_vscale</span> <span class="o">=</span> <span class="n">uv_vsubsampling</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">stride_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* check src dimensions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_845G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I830</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_height</span> <span class="o">&gt;</span> <span class="n">IMAGE_MAX_HEIGHT_LEGACY</span> <span class="o">||</span>
		    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_width</span>  <span class="o">&gt;</span> <span class="n">IMAGE_MAX_WIDTH_LEGACY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_height</span> <span class="o">&gt;</span> <span class="n">IMAGE_MAX_HEIGHT</span> <span class="o">||</span>
		    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_width</span>  <span class="o">&gt;</span> <span class="n">IMAGE_MAX_WIDTH</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* better safe than sorry, use 4 as the maximal subsampling ratio */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_height</span> <span class="o">&lt;</span> <span class="n">N_VERT_Y_TAPS</span><span class="o">*</span><span class="mi">4</span> <span class="o">||</span>
	    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_width</span>  <span class="o">&lt;</span> <span class="n">N_HORIZ_Y_TAPS</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* check alignment constraints */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_RGB</span>:
		<span class="cm">/* not implemented */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV_PACKED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uv_vscale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">depth</span> <span class="o">=</span> <span class="n">packed_depth_bytes</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">depth</span><span class="p">;</span>

		<span class="cm">/* ignore UV planes */</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_UV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">offset_U</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rec</span><span class="o">-&gt;</span><span class="n">offset_V</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* check pixel alignment */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">offset_Y</span> <span class="o">%</span> <span class="n">depth</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV_PLANAR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uv_vscale</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">uv_hscale</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* no offset restrictions for planar formats */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_width</span> <span class="o">%</span> <span class="n">uv_hscale</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* stride checking */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I830</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_845G</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">stride_mask</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">stride_mask</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span> <span class="o">&amp;</span> <span class="n">stride_mask</span> <span class="o">||</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_UV</span> <span class="o">&amp;</span> <span class="n">stride_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN4</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_TYPE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">I915_OVERLAY_YUV_PLANAR</span> <span class="o">?</span>
		<span class="mi">4096</span> <span class="o">:</span> <span class="mi">8192</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span> <span class="o">&gt;</span> <span class="n">tmp</span> <span class="o">||</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_UV</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* check buffer dimensions */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_OVERLAY_RGB</span>:
	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV_PACKED</span>:
		<span class="cm">/* always 4 Y values per depth pixels */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packed_width_bytes</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span><span class="o">*</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">offset_Y</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I915_OVERLAY_YUV_PLANAR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_width</span> <span class="o">&gt;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="o">/</span><span class="n">uv_hscale</span> <span class="o">&gt;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_UV</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span> <span class="o">*</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">offset_Y</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">stride_UV</span> <span class="o">*</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">src_height</span> <span class="o">/</span> <span class="n">uv_vscale</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">offset_U</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">||</span>
		    <span class="n">rec</span><span class="o">-&gt;</span><span class="n">offset_V</span> <span class="o">+</span> <span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Return the pipe currently connected to the panel fitter,</span>
<span class="cm"> * or -1 if the panel fitter is not present or not in use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_panel_fitter_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">pfit_control</span><span class="p">;</span>

	<span class="cm">/* i830 doesn&#39;t have a panel fitter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I830</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pfit_control</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PFIT_CONTROL</span><span class="p">);</span>

	<span class="cm">/* See if the panel fitter is in use */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pfit_control</span> <span class="o">&amp;</span> <span class="n">PFIT_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* 965 can place panel fitter on either pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN4</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">pfit_control</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="cm">/* older chips can only use pipe 1 */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intel_overlay_put_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_intel_overlay_put_image</span> <span class="o">*</span><span class="n">put_image_rec</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">drmmode_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">new_bo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">put_image_params</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* No need to check for DRIVER_MODESET - we don&#39;t set it up then. */</span>
	<span class="n">overlay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;userspace bug: no overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_switch_off</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">params</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">put_image_params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">drmmode_obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span>
					   <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drmmode_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">drmmode_obj</span><span class="p">));</span>

	<span class="n">new_bo</span> <span class="o">=</span> <span class="n">to_intel_bo</span><span class="p">(</span><span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span>
						   <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">bo_handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;buffer used for overlay image can not be tiled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_recover_from_interrupt</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_switch_off</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_overlay_possible_on_crtc</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">;</span>

		<span class="cm">/* line too wide, i.e. one-line-mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">&amp;&amp;</span>
		    <span class="n">intel_panel_fitter_pipe</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">pfit_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">update_pfit_vscale_ratio</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">pfit_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_overlay_dst</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">put_image_rec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">pfit_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_y</span> <span class="o">=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)</span><span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">dst_y</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span>
				 <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">pfit_vscale_ratio</span><span class="p">);</span>
		<span class="cm">/* shifting right rounds downwards, so add 1 */</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_h</span> <span class="o">=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)</span><span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">dst_height</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span>
				 <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">pfit_vscale_ratio</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_y</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">dst_y</span><span class="p">;</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_h</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">dst_height</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_x</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">dst_x</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">dst_w</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">dst_width</span><span class="p">;</span>

	<span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">src_width</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">src_h</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">src_height</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">src_scan_w</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">src_scan_width</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">src_scan_h</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">src_scan_height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">src_scan_h</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_h</span> <span class="o">||</span>
	    <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_scan_w</span> <span class="o">&gt;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_overlay_src</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">put_image_rec</span><span class="p">,</span> <span class="n">new_bo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I915_OVERLAY_FLAGS_MASK</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">stride_Y</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">stride_Y</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">stride_UV</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">stride_UV</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_Y</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">offset_Y</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_U</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">offset_U</span><span class="p">;</span>
	<span class="n">params</span><span class="o">-&gt;</span><span class="n">offset_V</span> <span class="o">=</span> <span class="n">put_image_rec</span><span class="o">-&gt;</span><span class="n">offset_V</span><span class="p">;</span>

	<span class="cm">/* Check scaling after src size to prevent a divide-by-zero. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">check_overlay_scaling</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_overlay_do_put_image</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">new_bo</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_reg_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span>
		  <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OCLRC0</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">OCLRC1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_gamma_bounds</span><span class="p">(</span><span class="n">u32</span> <span class="n">gamma1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gamma2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gamma1</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span> <span class="o">||</span> <span class="n">gamma2</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">gamma1</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">gamma2</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_gamma5_errata</span><span class="p">(</span><span class="n">u32</span> <span class="n">gamma5</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">gamma5</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_gamma</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_intel_overlay_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_gamma_bounds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">check_gamma_bounds</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma0</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">check_gamma_bounds</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma1</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">check_gamma_bounds</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma2</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma3</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">check_gamma_bounds</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma3</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma4</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">check_gamma_bounds</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma4</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma5</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">check_gamma_bounds</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma5</span><span class="p">,</span> <span class="mh">0x00ffffff</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_gamma5_errata</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma5</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">intel_overlay_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_intel_overlay_attrs</span> <span class="o">*</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* No need to check for DRIVER_MODESET - we don&#39;t set it up then. */</span>
	<span class="n">overlay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG</span><span class="p">(</span><span class="s">&quot;userspace bug: no overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_UPDATE_ATTRS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">color_key</span>  <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">color_key</span><span class="p">;</span>
		<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">;</span>
		<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">contrast</span>   <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">;</span>
		<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma0</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">OGAMC0</span><span class="p">);</span>
			<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">OGAMC1</span><span class="p">);</span>
			<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma2</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">OGAMC2</span><span class="p">);</span>
			<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma3</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">OGAMC3</span><span class="p">);</span>
			<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma4</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">OGAMC4</span><span class="p">);</span>
			<span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma5</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">OGAMC5</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">128</span> <span class="o">||</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">&gt;</span> <span class="mi">1023</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">color_key</span>  <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">color_key</span><span class="p">;</span>
		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">;</span>
		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">contrast</span>   <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">;</span>
		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">;</span>

		<span class="n">regs</span> <span class="o">=</span> <span class="n">intel_overlay_map_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">update_reg_attrs</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

		<span class="n">intel_overlay_unmap_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I915_OVERLAY_UPDATE_GAMMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">check_gamma</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGAMC0</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma0</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGAMC1</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma1</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGAMC2</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma2</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGAMC3</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma3</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGAMC4</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma4</span><span class="p">);</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">OGAMC5</span><span class="p">,</span> <span class="n">attrs</span><span class="o">-&gt;</span><span class="n">gamma5</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_setup_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">reg_bo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_OVERLAY</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">overlay</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">reg_bo</span> <span class="o">=</span> <span class="n">i915_gem_alloc_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg_bo</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span> <span class="o">=</span> <span class="n">reg_bo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OVERLAY_NEEDS_PHYSICAL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_attach_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg_bo</span><span class="p">,</span>
						  <span class="n">I915_GEM_PHYS_OVERLAY_REGS</span><span class="p">,</span>
						  <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to attach phys overlay regs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_bo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_addr</span> <span class="o">=</span> <span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_pin</span><span class="p">(</span><span class="n">reg_bo</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to pin overlay register bo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_free_bo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">flip_addr</span> <span class="o">=</span> <span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_object_set_to_gtt_domain</span><span class="p">(</span><span class="n">reg_bo</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to move overlay register bo into the GTT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_unpin_bo</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* init all values */</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">color_key</span> <span class="o">=</span> <span class="mh">0x0101fe</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="o">-</span><span class="mi">19</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>
	<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">=</span> <span class="mi">146</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">intel_overlay_map_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unpin_bo</span><span class="p">;</span>

	<span class="n">memset_io</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">overlay_registers</span><span class="p">));</span>
	<span class="n">update_polyphase_filter</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">update_reg_attrs</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">intel_overlay_unmap_regs</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span> <span class="o">=</span> <span class="n">overlay</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;initialized overlay support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_unpin_bo:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OVERLAY_NEEDS_PHYSICAL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">i915_gem_object_unpin</span><span class="p">(</span><span class="n">reg_bo</span><span class="p">);</span>
<span class="nl">out_free_bo:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">intel_cleanup_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* The bo&#39;s should be free&#39;d by the generic code already.</span>
<span class="cm">	 * Furthermore modesetting teardown happens beforehand so the</span>
<span class="cm">	 * hardware should be off already */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DEBUG_FS</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>

<span class="k">struct</span> <span class="n">intel_overlay_error_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dovsta</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">isr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span>
<span class="nf">intel_overlay_map_regs_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OVERLAY_NEEDS_PHYSICAL</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="cm">/* Cast to make sparse happy, but it&#39;s wc memory anyway, so</span>
<span class="cm">		 * equivalent to the wc io mapping on X86. */</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">regs</span> <span class="o">=</span> <span class="n">io_mapping_map_atomic_wc</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span><span class="p">,</span>
						<span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">regs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_overlay_unmap_regs_atomic</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">OVERLAY_NEEDS_PHYSICAL</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">io_mapping_unmap_atomic</span><span class="p">(</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">intel_overlay_error_state</span> <span class="o">*</span>
<span class="nf">intel_overlay_capture_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_overlay</span> <span class="o">*</span><span class="n">overlay</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_overlay_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">overlay_registers</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overlay</span> <span class="o">||</span> <span class="o">!</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">error</span><span class="o">-&gt;</span><span class="n">dovsta</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DOVSTA</span><span class="p">);</span>
	<span class="n">error</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">OVERLAY_NEEDS_PHYSICAL</span><span class="p">(</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="kt">long</span><span class="p">)</span><span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">phys_obj</span><span class="o">-&gt;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">error</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">overlay</span><span class="o">-&gt;</span><span class="n">reg_bo</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">intel_overlay_map_regs_atomic</span><span class="p">(</span><span class="n">overlay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">regs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">overlay_registers</span><span class="p">));</span>
	<span class="n">intel_overlay_unmap_regs_atomic</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">regs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">intel_overlay_print_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_overlay_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Overlay, status: 0x%08x, interrupt: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">error</span><span class="o">-&gt;</span><span class="n">dovsta</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  Register file at 0x%08lx:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">error</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

<span class="cp">#define P(x) seq_printf(m, &quot;    &quot; #x &quot;:	0x%08x\n&quot;, error-&gt;regs.x)</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OBUF_0Y</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OBUF_1Y</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OBUF_0U</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OBUF_0V</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OBUF_1U</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OBUF_1V</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OSTRIDE</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">YRGB_VPH</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">UV_VPH</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">HORZ_PH</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">INIT_PHS</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">DWINPOS</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">DWINSZ</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">SWIDTH</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">SWIDTHSW</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">SHEIGHT</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">YRGBSCALE</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">UVSCALE</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OCLRC0</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OCLRC1</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">DCLRKV</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">DCLRKM</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">SCLRKVH</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">SCLRKVL</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">SCLRKEN</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OCONFIG</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OCMD</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OSTART_0Y</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OSTART_1Y</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OSTART_0U</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OSTART_0V</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OSTART_1U</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OSTART_1V</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OTILEOFF_0Y</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OTILEOFF_1Y</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OTILEOFF_0U</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OTILEOFF_0V</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OTILEOFF_1U</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">OTILEOFF_1V</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">FASTHSCALE</span><span class="p">);</span>
	<span class="n">P</span><span class="p">(</span><span class="n">UVSCALEV</span><span class="p">);</span>
<span class="cp">#undef P</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
