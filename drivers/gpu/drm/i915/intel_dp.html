<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › intel_dp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>intel_dp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2008 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Keith Packard &lt;keithp@keithp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_crtc.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>
<span class="cp">#include &quot;drm_edid.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;drm_dp_helper.h&quot;</span>

<span class="cp">#define DP_RECEIVER_CAP_SIZE	0xf</span>
<span class="cp">#define DP_LINK_STATUS_SIZE	6</span>
<span class="cp">#define DP_LINK_CHECK_TIMEOUT	(10 * 1000)</span>

<span class="cp">#define DP_LINK_CONFIGURATION_SIZE	9</span>

<span class="k">struct</span> <span class="n">intel_dp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">output_reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">DP</span><span class="p">;</span>
	<span class="kt">uint8_t</span>  <span class="n">link_configuration</span><span class="p">[</span><span class="n">DP_LINK_CONFIGURATION_SIZE</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">has_audio</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">hdmi_force_audio</span> <span class="n">force_audio</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">color_range</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dpms_mode</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">link_bw</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">lane_count</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">dpcd</span><span class="p">[</span><span class="n">DP_RECEIVER_CAP_SIZE</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_algo_dp_aux_data</span> <span class="n">algo</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_pch_edp</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">train_set</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">panel_power_up_delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">panel_power_down_delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">panel_power_cycle_delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">backlight_on_delay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">backlight_off_delay</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">panel_fixed_mode</span><span class="p">;</span>  <span class="cm">/* for eDP */</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">panel_vdd_work</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">want_panel_vdd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span> <span class="cm">/* cached EDID for eDP */</span>
	<span class="kt">int</span> <span class="n">edid_mode_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * is_edp - is the given port attached to an eDP panel (either CPU or PCH)</span>
<span class="cm"> * @intel_dp: DP struct</span>
<span class="cm"> *</span>
<span class="cm"> * If a CPU or PCH DP output is attached to an eDP panel, this function</span>
<span class="cm"> * will return true, and false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_edp</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_EDP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_pch_edp - is the port on the PCH and attached to an eDP panel?</span>
<span class="cm"> * @intel_dp: DP struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the given DP struct corresponds to a PCH DP port attached</span>
<span class="cm"> * to an eDP panel, false otherwise.  Helpful for determining whether we</span>
<span class="cm"> * may need FDI resources for a given DP output or not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_pch_edp</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">is_pch_edp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_cpu_edp - is the port on the CPU and attached to an eDP panel?</span>
<span class="cm"> * @intel_dp: DP struct</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the given DP struct corresponds to a CPU eDP port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_cpu_edp</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_pch_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="nf">enc_to_intel_dp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_dp</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="nf">intel_attached_dp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">intel_attached_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
			    <span class="k">struct</span> <span class="n">intel_dp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * intel_encoder_is_pch_edp - is the given encoder a PCH attached eDP?</span>
<span class="cm"> * @encoder: DRM encoder</span>
<span class="cm"> *</span>
<span class="cm"> * Return true if @encoder corresponds to a PCH attached eDP panel.  Needed</span>
<span class="cm"> * by intel_display.c.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">intel_encoder_is_pch_edp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoder</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">is_pch_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">intel_dp_start_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">intel_dp_complete_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">intel_dp_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">intel_edp_link_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="o">*</span><span class="n">lane_num</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">intel_encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_dp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="o">*</span><span class="n">lane_num</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_bw</span> <span class="o">==</span> <span class="n">DP_LINK_BW_1_62</span><span class="p">)</span>
		<span class="o">*</span><span class="n">link_bw</span> <span class="o">=</span> <span class="mi">162000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_bw</span> <span class="o">==</span> <span class="n">DP_LINK_BW_2_7</span><span class="p">)</span>
		<span class="o">*</span><span class="n">link_bw</span> <span class="o">=</span> <span class="mi">270000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_max_lane_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_lane_count</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_MAX_LANE_COUNT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">max_lane_count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="k">case</span> <span class="mi">2</span>: <span class="k">case</span> <span class="mi">4</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">max_lane_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_lane_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_max_link_bw</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_link_bw</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_MAX_LINK_RATE</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">max_link_bw</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DP_LINK_BW_1_62</span>:
	<span class="k">case</span> <span class="n">DP_LINK_BW_2_7</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">max_link_bw</span> <span class="o">=</span> <span class="n">DP_LINK_BW_1_62</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_link_bw</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_link_clock</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">link_bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link_bw</span> <span class="o">==</span> <span class="n">DP_LINK_BW_2_7</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">270000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">162000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The units on the numbers in the next two are... bizarre.  Examples will</span>
<span class="cm"> * make it clearer; this one parallels an example in the eDP spec.</span>
<span class="cm"> *</span>
<span class="cm"> * intel_dp_max_data_rate for one lane of 2.7GHz evaluates as:</span>
<span class="cm"> *</span>
<span class="cm"> *     270000 * 1 * 8 / 10 == 216000</span>
<span class="cm"> *</span>
<span class="cm"> * The actual data capacity of that configuration is 2.16Gbit/s, so the</span>
<span class="cm"> * units are decakilobits.  -&gt;clock in a drm_display_mode is in kilohertz -</span>
<span class="cm"> * or equivalently, kilopixels per second - so for 1680x1050R it&#39;d be</span>
<span class="cm"> * 119000.  At 18bpp that&#39;s 2142000 kilobits per second.</span>
<span class="cm"> *</span>
<span class="cm"> * Thus the strange-looking division by 10 in intel_dp_link_required, to</span>
<span class="cm"> * get the result in decakilobits instead of kilobits.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_link_required</span><span class="p">(</span><span class="kt">int</span> <span class="n">pixel_clock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">pixel_clock</span> <span class="o">*</span> <span class="n">bpp</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_max_data_rate</span><span class="p">(</span><span class="kt">int</span> <span class="n">max_link_clock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_lanes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">max_link_clock</span> <span class="o">*</span> <span class="n">max_lanes</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_adjust_dithering</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_link_clock</span> <span class="o">=</span> <span class="n">intel_dp_link_clock</span><span class="p">(</span><span class="n">intel_dp_max_link_bw</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">max_lanes</span> <span class="o">=</span> <span class="n">intel_dp_max_lane_count</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_rate</span><span class="p">,</span> <span class="n">mode_rate</span><span class="p">;</span>

	<span class="n">mode_rate</span> <span class="o">=</span> <span class="n">intel_dp_link_required</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">max_rate</span> <span class="o">=</span> <span class="n">intel_dp_max_data_rate</span><span class="p">(</span><span class="n">max_link_clock</span><span class="p">,</span> <span class="n">max_lanes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_rate</span> <span class="o">&gt;</span> <span class="n">max_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode_rate</span> <span class="o">=</span> <span class="n">intel_dp_link_required</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="mi">18</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode_rate</span> <span class="o">&gt;</span> <span class="n">max_rate</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="p">)</span>
			<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">private_flags</span>
				<span class="o">|=</span> <span class="n">INTEL_MODE_DP_FORCE_6BPC</span><span class="p">;</span>

		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_mode_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">intel_attached_dp</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">MODE_PANEL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">&gt;</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">MODE_PANEL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_adjust_dithering</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MODE_CLOCK_HIGH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_CLOCK_LOW</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLCLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MODE_H_ILLEGAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">MODE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">pack_aux</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src_bytes</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">src_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">src_bytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unpack_aux</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">src</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dst_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dst_bytes</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">dst_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dst_bytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="p">((</span><span class="mi">3</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* hrawclock is 1/4 the FSB frequency */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_hrawclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">clkcfg</span><span class="p">;</span>

	<span class="n">clkcfg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">CLKCFG</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">clkcfg</span> <span class="o">&amp;</span> <span class="n">CLKCFG_FSB_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_400</span>:
		<span class="k">return</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_533</span>:
		<span class="k">return</span> <span class="mi">133</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_667</span>:
		<span class="k">return</span> <span class="mi">166</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_800</span>:
		<span class="k">return</span> <span class="mi">200</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_1067</span>:
		<span class="k">return</span> <span class="mi">266</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_1333</span>:
		<span class="k">return</span> <span class="mi">333</span><span class="p">;</span>
	<span class="cm">/* these two are just a guess; one of them might be right */</span>
	<span class="k">case</span> <span class="n">CLKCFG_FSB_1600</span>:
	<span class="k">case</span> <span class="n">CLKCFG_FSB_1600_ALT</span>:
		<span class="k">return</span> <span class="mi">400</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">133</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ironlake_edp_have_panel_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PP_ON</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ironlake_edp_have_panel_vdd</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EDP_FORCE_VDD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_check_edp</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_edp_have_panel_power</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ironlake_edp_have_panel_vdd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;eDP powered off while attempting aux channel communication.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Status 0x%08x Control 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_STATUS</span><span class="p">),</span>
			      <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_aux_ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">send</span><span class="p">,</span> <span class="kt">int</span> <span class="n">send_bytes</span><span class="p">,</span>
		<span class="kt">uint8_t</span> <span class="o">*</span><span class="n">recv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recv_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">output_reg</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ch_ctl</span> <span class="o">=</span> <span class="n">output_reg</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ch_data</span> <span class="o">=</span> <span class="n">ch_ctl</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recv_bytes</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">aux_clock_divider</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">try</span><span class="p">,</span> <span class="n">precharge</span><span class="p">;</span>

	<span class="n">intel_dp_check_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="cm">/* The clock divider is based off the hrawclk,</span>
<span class="cm">	 * and would like to run at 2MHz. So, take the</span>
<span class="cm">	 * hrawclk value and divide by 2 and use that</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that PCH attached eDP panels should use a 125MHz input</span>
<span class="cm">	 * clock divider.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">aux_clock_divider</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="cm">/* SNB &amp; IVB eDP input clock at 400Mhz */</span>
		<span class="k">else</span>
			<span class="n">aux_clock_divider</span> <span class="o">=</span> <span class="mi">225</span><span class="p">;</span> <span class="cm">/* eDP input clock at 450Mhz */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">aux_clock_divider</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span> <span class="cm">/* IRL input clock fixed at 125Mhz */</span>
	<span class="k">else</span>
		<span class="n">aux_clock_divider</span> <span class="o">=</span> <span class="n">intel_hrawclk</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">precharge</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">precharge</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* Try to wait for any previous AUX channel activity */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">try</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">try</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ch_ctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DP_AUX_CH_CTL_SEND_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">try</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;dp_aux_ch not started status 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">I915_READ</span><span class="p">(</span><span class="n">ch_ctl</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Must try at least 3 times according to DP spec */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">try</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">try</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Load the send data into the aux channel data registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">send_bytes</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ch_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				   <span class="n">pack_aux</span><span class="p">(</span><span class="n">send</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">send_bytes</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>

		<span class="cm">/* Send the command and wait for it to complete */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ch_ctl</span><span class="p">,</span>
			   <span class="n">DP_AUX_CH_CTL_SEND_BUSY</span> <span class="o">|</span>
			   <span class="n">DP_AUX_CH_CTL_TIME_OUT_400us</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">send_bytes</span> <span class="o">&lt;&lt;</span> <span class="n">DP_AUX_CH_CTL_MESSAGE_SIZE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">precharge</span> <span class="o">&lt;&lt;</span> <span class="n">DP_AUX_CH_CTL_PRECHARGE_2US_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="p">(</span><span class="n">aux_clock_divider</span> <span class="o">&lt;&lt;</span> <span class="n">DP_AUX_CH_CTL_BIT_CLOCK_2X_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">DP_AUX_CH_CTL_DONE</span> <span class="o">|</span>
			   <span class="n">DP_AUX_CH_CTL_TIME_OUT_ERROR</span> <span class="o">|</span>
			   <span class="n">DP_AUX_CH_CTL_RECEIVE_ERROR</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">ch_ctl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DP_AUX_CH_CTL_SEND_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Clear done status and any errors */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">ch_ctl</span><span class="p">,</span>
			   <span class="n">status</span> <span class="o">|</span>
			   <span class="n">DP_AUX_CH_CTL_DONE</span> <span class="o">|</span>
			   <span class="n">DP_AUX_CH_CTL_TIME_OUT_ERROR</span> <span class="o">|</span>
			   <span class="n">DP_AUX_CH_CTL_RECEIVE_ERROR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DP_AUX_CH_CTL_TIME_OUT_ERROR</span> <span class="o">|</span>
			      <span class="n">DP_AUX_CH_CTL_RECEIVE_ERROR</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DP_AUX_CH_CTL_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DP_AUX_CH_CTL_DONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;dp_aux_ch not done status 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for timeout or receive error.</span>
<span class="cm">	 * Timeouts occur when the sink is not connected</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DP_AUX_CH_CTL_RECEIVE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;dp_aux_ch receive error status 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Timeouts occur when the device isn&#39;t connected, so they&#39;re</span>
<span class="cm">	 * &quot;normal&quot; -- don&#39;t fill the kernel log with these */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DP_AUX_CH_CTL_TIME_OUT_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;dp_aux_ch timeout status 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Unload any bytes sent back from the other side */</span>
	<span class="n">recv_bytes</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DP_AUX_CH_CTL_MESSAGE_SIZE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		      <span class="n">DP_AUX_CH_CTL_MESSAGE_SIZE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recv_bytes</span> <span class="o">&gt;</span> <span class="n">recv_size</span><span class="p">)</span>
		<span class="n">recv_bytes</span> <span class="o">=</span> <span class="n">recv_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">recv_bytes</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">unpack_aux</span><span class="p">(</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">ch_data</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
			   <span class="n">recv</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">recv_bytes</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">recv_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write data to the aux channel in native mode */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_aux_native_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
			  <span class="kt">uint16_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">send</span><span class="p">,</span> <span class="kt">int</span> <span class="n">send_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">msg</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">msg_bytes</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="n">ack</span><span class="p">;</span>

	<span class="n">intel_dp_check_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">send_bytes</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AUX_NATIVE_WRITE</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">send_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">send</span><span class="p">,</span> <span class="n">send_bytes</span><span class="p">);</span>
	<span class="n">msg_bytes</span> <span class="o">=</span> <span class="n">send_bytes</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_ch</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">AUX_NATIVE_REPLY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AUX_NATIVE_REPLY_ACK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">AUX_NATIVE_REPLY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AUX_NATIVE_REPLY_DEFER</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">send_bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write a single byte to the aux channel in native mode */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_aux_native_write_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
			    <span class="kt">uint16_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_dp_aux_native_write</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* read bytes from a native aux channel */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_aux_native_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
			 <span class="kt">uint16_t</span> <span class="n">address</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">recv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recv_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">msg_bytes</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">reply</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">reply_bytes</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">ack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">intel_dp_check_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AUX_NATIVE_READ</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">recv_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">msg_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">reply_bytes</span> <span class="o">=</span> <span class="n">recv_bytes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_ch</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg_bytes</span><span class="p">,</span>
				      <span class="n">reply</span><span class="p">,</span> <span class="n">reply_bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">AUX_NATIVE_REPLY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AUX_NATIVE_REPLY_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">recv</span><span class="p">,</span> <span class="n">reply</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ret</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ack</span> <span class="o">&amp;</span> <span class="n">AUX_NATIVE_REPLY_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">AUX_NATIVE_REPLY_DEFER</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_i2c_aux_ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
		    <span class="kt">uint8_t</span> <span class="n">write_byte</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">read_byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_algo_dp_aux_data</span> <span class="o">*</span><span class="n">algo_data</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">intel_dp</span><span class="p">,</span>
						<span class="n">adapter</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">address</span> <span class="o">=</span> <span class="n">algo_data</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">msg</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">uint8_t</span> <span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">msg_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reply_bytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">intel_dp_check_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="cm">/* Set up the command byte */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_I2C_READ</span><span class="p">)</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AUX_I2C_READ</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AUX_I2C_WRITE</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">MODE_I2C_STOP</span><span class="p">))</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">AUX_I2C_MOT</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MODE_I2C_WRITE</span>:
		<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">write_byte</span><span class="p">;</span>
		<span class="n">msg_bytes</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">reply_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_I2C_READ</span>:
		<span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msg_bytes</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">reply_bytes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">msg_bytes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">reply_bytes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retry</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">retry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_ch</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
				      <span class="n">msg</span><span class="p">,</span> <span class="n">msg_bytes</span><span class="p">,</span>
				      <span class="n">reply</span><span class="p">,</span> <span class="n">reply_bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;aux_ch failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AUX_NATIVE_REPLY_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUX_NATIVE_REPLY_ACK</span>:
			<span class="cm">/* I2C-over-AUX Reply field is only valid</span>
<span class="cm">			 * when paired with AUX ACK.</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUX_NATIVE_REPLY_NACK</span>:
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;aux_ch native nack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUX_NATIVE_REPLY_DEFER</span>:
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;aux_ch invalid native reply 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AUX_I2C_REPLY_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUX_I2C_REPLY_ACK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_I2C_READ</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">read_byte</span> <span class="o">=</span> <span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">reply_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUX_I2C_REPLY_NACK</span>:
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;aux_i2c nack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUX_I2C_REPLY_DEFER</span>:
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;aux_i2c defer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;aux_i2c invalid reply 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;too many retries, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sync</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_i2c_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">intel_connector</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;i2c_init %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">.</span><span class="n">aux_ch</span> <span class="o">=</span> <span class="n">intel_dp_i2c_aux_ch</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">));</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">I2C_CLASS_DDC</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">algo_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">algo</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">kdev</span><span class="p">;</span>

	<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_dp_aux_add_bus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">lane_count</span><span class="p">,</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_lane_count</span> <span class="o">=</span> <span class="n">intel_dp_max_lane_count</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_clock</span> <span class="o">=</span> <span class="n">intel_dp_max_link_bw</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)</span> <span class="o">==</span> <span class="n">DP_LINK_BW_2_7</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span> <span class="n">mode_rate</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">bws</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">DP_LINK_BW_1_62</span><span class="p">,</span> <span class="n">DP_LINK_BW_2_7</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_fixed_panel_mode</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
		<span class="n">intel_pch_panel_fitting</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRM_MODE_SCALE_FULLSCREEN</span><span class="p">,</span>
					<span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * the mode-&gt;clock is used to calculate the Data&amp;Link M/N</span>
<span class="cm">		 * of the pipe. For the eDP the fixed clock should be used.</span>
<span class="cm">		 */</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLCLK</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DP link computation with max lane count %i &quot;</span>
		      <span class="s">&quot;max bw %02x pixel clock %iKHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">max_lane_count</span><span class="p">,</span> <span class="n">bws</span><span class="p">[</span><span class="n">max_clock</span><span class="p">],</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_adjust_dithering</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bpp</span> <span class="o">=</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">private_flags</span> <span class="o">&amp;</span> <span class="n">INTEL_MODE_DP_FORCE_6BPC</span> <span class="o">?</span> <span class="mi">18</span> <span class="o">:</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">mode_rate</span> <span class="o">=</span> <span class="n">intel_dp_link_required</span><span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lane_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">lane_count</span> <span class="o">&lt;=</span> <span class="n">max_lane_count</span><span class="p">;</span> <span class="n">lane_count</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">clock</span> <span class="o">&lt;=</span> <span class="n">max_clock</span><span class="p">;</span> <span class="n">clock</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">link_avail</span> <span class="o">=</span> <span class="n">intel_dp_max_data_rate</span><span class="p">(</span><span class="n">intel_dp_link_clock</span><span class="p">(</span><span class="n">bws</span><span class="p">[</span><span class="n">clock</span><span class="p">]),</span> <span class="n">lane_count</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mode_rate</span> <span class="o">&lt;=</span> <span class="n">link_avail</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_bw</span> <span class="o">=</span> <span class="n">bws</span><span class="p">[</span><span class="n">clock</span><span class="p">];</span>
				<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span> <span class="o">=</span> <span class="n">lane_count</span><span class="p">;</span>
				<span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">intel_dp_link_clock</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_bw</span><span class="p">);</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DP link bw %02x lane &quot;</span>
						<span class="s">&quot;count %d clock %d bpp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_bw</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">,</span>
				       <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">bpp</span><span class="p">);</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DP link bw required %i available %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">mode_rate</span><span class="p">,</span> <span class="n">link_avail</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">intel_dp_m_n</span> <span class="p">{</span>
	<span class="kt">uint32_t</span>	<span class="n">tu</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">gmch_m</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">gmch_n</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">link_m</span><span class="p">;</span>
	<span class="kt">uint32_t</span>	<span class="n">link_n</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_reduce_ratio</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">den</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mh">0xffffff</span> <span class="o">||</span> <span class="o">*</span><span class="n">den</span> <span class="o">&gt;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">num</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">den</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_compute_m_n</span><span class="p">(</span><span class="kt">int</span> <span class="n">bpp</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">nlanes</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">pixel_clock</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">link_clock</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">intel_dp_m_n</span> <span class="o">*</span><span class="n">m_n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">tu</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_clock</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_n</span> <span class="o">=</span> <span class="n">link_clock</span> <span class="o">*</span> <span class="n">nlanes</span><span class="p">;</span>
	<span class="n">intel_reduce_ratio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">gmch_n</span><span class="p">);</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_m</span> <span class="o">=</span> <span class="n">pixel_clock</span><span class="p">;</span>
	<span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_n</span> <span class="o">=</span> <span class="n">link_clock</span><span class="p">;</span>
	<span class="n">intel_reduce_ratio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_n</span><span class="o">-&gt;</span><span class="n">link_n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">intel_dp_set_m_n</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">lane_count</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_dp_m_n</span> <span class="n">m_n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the lane count in the intel_encoder private</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span> <span class="o">||</span>
		    <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_EDP</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">lane_count</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute the GMCH and Link ratios. The &#39;3&#39; here is</span>
<span class="cm">	 * the number of bytes_per_pixel post-LUT, which we always</span>
<span class="cm">	 * set up for 8-bits of R/G/B, or 3 bytes total.</span>
<span class="cm">	 */</span>
	<span class="n">intel_dp_compute_m_n</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">,</span> <span class="n">lane_count</span><span class="p">,</span>
			     <span class="n">mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDATA_M1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="p">((</span><span class="n">m_n</span><span class="p">.</span><span class="n">tu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PIPE_GMCH_DATA_M_TU_SIZE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">m_n</span><span class="p">.</span><span class="n">gmch_m</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDATA_N1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">gmch_n</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDPLINK_M1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">link_m</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">TRANSDPLINK_N1</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">link_n</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_GMCH_DATA_M</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
			   <span class="p">((</span><span class="n">m_n</span><span class="p">.</span><span class="n">tu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">PIPE_GMCH_DATA_M_TU_SIZE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			   <span class="n">m_n</span><span class="p">.</span><span class="n">gmch_m</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_GMCH_DATA_N</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">gmch_n</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_DP_LINK_M</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">link_m</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PIPE_DP_LINK_N</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span> <span class="n">m_n</span><span class="p">.</span><span class="n">link_n</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ironlake_edp_pll_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ironlake_edp_pll_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* Turn on the eDP PLL if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_pch_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
			<span class="n">ironlake_edp_pll_on</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ironlake_edp_pll_off</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * There are four kinds of DP registers:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 	IBX PCH</span>
<span class="cm">	 * 	SNB CPU</span>
<span class="cm">	 *	IVB CPU</span>
<span class="cm">	 * 	CPT PCH</span>
<span class="cm">	 *</span>
<span class="cm">	 * IBX PCH and CPU are the same for almost everything,</span>
<span class="cm">	 * except that the CPU DP PLL is configured in this</span>
<span class="cm">	 * register</span>
<span class="cm">	 *</span>
<span class="cm">	 * CPT PCH is quite different, having many bits moved</span>
<span class="cm">	 * to the TRANS_DP_CTL register instead. That</span>
<span class="cm">	 * configuration happens (oddly) in ironlake_pch_enable</span>
<span class="cm">	 */</span>

	<span class="cm">/* Preserve the BIOS-computed detected bit. This is</span>
<span class="cm">	 * supposed to be read-only.</span>
<span class="cm">	 */</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_DETECTED</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span>  <span class="n">DP_VOLTAGE_0_4</span> <span class="o">|</span> <span class="n">DP_PRE_EMPHASIS_0</span><span class="p">;</span>

	<span class="cm">/* Handle DP bits in common between all three register formats */</span>

	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_VOLTAGE_0_4</span> <span class="o">|</span> <span class="n">DP_PRE_EMPHASIS_0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PORT_WIDTH_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PORT_WIDTH_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PORT_WIDTH_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">has_audio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Enabling DP audio on pipe %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">pipe_name</span><span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">));</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_AUDIO_OUTPUT_ENABLE</span><span class="p">;</span>
		<span class="n">intel_write_eld</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DP_LINK_CONFIGURATION_SIZE</span><span class="p">);</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_bw</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">DP_SET_ANSI_8B10B</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check for DPCD version &gt; 1.1 and enhanced framing support</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_DPCD_REV</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x11</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_MAX_LANE_COUNT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DP_ENHANCED_FRAME_CAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">DP_LANE_COUNT_ENHANCED_FRAME_EN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Split out the IBX/CPU vs CPT settings */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PHSYNC</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_SYNC_HS_HIGH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_SYNC_VS_HIGH</span><span class="p">;</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_LINK_TRAIN_OFF_CPT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DP_LANE_COUNT_ENHANCED_FRAME_EN</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_ENHANCED_FRAMING</span><span class="p">;</span>

		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">;</span>

		<span class="cm">/* don&#39;t miss out required setting for eDP */</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PLL_ENABLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PLL_FREQ_160MHZ</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PLL_FREQ_270MHZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">color_range</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PHSYNC</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_SYNC_HS_HIGH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_PVSYNC</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_SYNC_VS_HIGH</span><span class="p">;</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_LINK_TRAIN_OFF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DP_LANE_COUNT_ENHANCED_FRAME_EN</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_ENHANCED_FRAMING</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PIPEB_SELECT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* don&#39;t miss out required setting for eDP */</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PLL_ENABLE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adjusted_mode</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span>
				<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PLL_FREQ_160MHZ</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PLL_FREQ_270MHZ</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_LINK_TRAIN_OFF_CPT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define IDLE_ON_MASK		(PP_ON | 0 	  | PP_SEQUENCE_MASK | 0                     | PP_SEQUENCE_STATE_MASK)</span>
<span class="cp">#define IDLE_ON_VALUE   	(PP_ON | 0 	  | PP_SEQUENCE_NONE | 0                     | PP_SEQUENCE_STATE_ON_IDLE)</span>

<span class="cp">#define IDLE_OFF_MASK		(PP_ON | 0        | PP_SEQUENCE_MASK | 0                     | PP_SEQUENCE_STATE_MASK)</span>
<span class="cp">#define IDLE_OFF_VALUE		(0     | 0        | PP_SEQUENCE_NONE | 0                     | PP_SEQUENCE_STATE_OFF_IDLE)</span>

<span class="cp">#define IDLE_CYCLE_MASK		(PP_ON | 0        | PP_SEQUENCE_MASK | PP_CYCLE_DELAY_ACTIVE | PP_SEQUENCE_STATE_MASK)</span>
<span class="cp">#define IDLE_CYCLE_VALUE	(0     | 0        | PP_SEQUENCE_NONE | 0                     | PP_SEQUENCE_STATE_OFF_IDLE)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_wait_panel_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;mask %08x value %08x status %08x control %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
		      <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_STATUS</span><span class="p">),</span>
		      <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Panel status timeout: status %08x control %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_STATUS</span><span class="p">),</span>
			  <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_wait_panel_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Wait for panel power on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ironlake_wait_panel_status</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">IDLE_ON_MASK</span><span class="p">,</span> <span class="n">IDLE_ON_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_wait_panel_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Wait for panel power off time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ironlake_wait_panel_status</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">IDLE_OFF_MASK</span><span class="p">,</span> <span class="n">IDLE_OFF_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_wait_panel_power_cycle</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Wait for panel power cycle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ironlake_wait_panel_status</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">IDLE_CYCLE_MASK</span><span class="p">,</span> <span class="n">IDLE_CYCLE_VALUE</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Read the current pp_control value, unlocking the register if it</span>
<span class="cm"> * is locked</span>
<span class="cm"> */</span>

<span class="k">static</span>  <span class="n">u32</span> <span class="nf">ironlake_get_pp_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">control</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>

	<span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PANEL_UNLOCK_MASK</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">PANEL_UNLOCK_REGS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">control</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Turn eDP VDD on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">want_panel_vdd</span><span class="p">,</span>
	     <span class="s">&quot;eDP VDD already requested on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">want_panel_vdd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ironlake_edp_have_panel_vdd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;eDP VDD already on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_edp_have_panel_power</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="n">ironlake_wait_panel_power_cycle</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">ironlake_get_pp_control</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">|=</span> <span class="n">EDP_FORCE_VDD</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;PCH_PP_STATUS: 0x%08x PCH_PP_CONTROL: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_STATUS</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the panel wasn&#39;t on, delay before accessing aux channel</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ironlake_edp_have_panel_power</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;eDP was not running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_up_delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_panel_vdd_off_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">want_panel_vdd</span> <span class="o">&amp;&amp;</span> <span class="n">ironlake_edp_have_panel_vdd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">ironlake_get_pp_control</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">pp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EDP_FORCE_VDD</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>

		<span class="cm">/* Make sure sequencer is idle before allowing subsequent activity */</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;PCH_PP_STATUS: 0x%08x PCH_PP_CONTROL: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_STATUS</span><span class="p">),</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">));</span>

		<span class="n">msleep</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_down_delay</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_panel_vdd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">__work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">to_delayed_work</span><span class="p">(</span><span class="n">__work</span><span class="p">),</span>
						 <span class="k">struct</span> <span class="n">intel_dp</span><span class="p">,</span> <span class="n">panel_vdd_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ironlake_panel_vdd_off_sync</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">bool</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Turn eDP VDD off %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">want_panel_vdd</span><span class="p">);</span>
	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">want_panel_vdd</span><span class="p">,</span> <span class="s">&quot;eDP VDD not forced on&quot;</span><span class="p">);</span>

	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">want_panel_vdd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ironlake_panel_vdd_off_sync</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Queue the timer to fire a long</span>
<span class="cm">		 * time from now (relative to the power down delay)</span>
<span class="cm">		 * to keep the panel power up across a sequence of operations</span>
<span class="cm">		 */</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_vdd_work</span><span class="p">,</span>
				      <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_cycle_delay</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_panel_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Turn eDP power on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ironlake_edp_have_panel_power</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;eDP power already on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ironlake_wait_panel_power_cycle</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">ironlake_get_pp_control</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ILK workaround: disable reset around power sequence */</span>
		<span class="n">pp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PANEL_POWER_RESET</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pp</span> <span class="o">|=</span> <span class="n">POWER_TARGET_ON</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pp</span> <span class="o">|=</span> <span class="n">PANEL_POWER_RESET</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>

	<span class="n">ironlake_wait_panel_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pp</span> <span class="o">|=</span> <span class="n">PANEL_POWER_RESET</span><span class="p">;</span> <span class="cm">/* restore panel reset bit */</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_panel_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Turn eDP power off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">want_panel_vdd</span><span class="p">,</span> <span class="s">&quot;Need VDD to turn off panel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">ironlake_get_pp_control</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">POWER_TARGET_ON</span> <span class="o">|</span> <span class="n">PANEL_POWER_RESET</span> <span class="o">|</span> <span class="n">EDP_BLC_ENABLE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>

	<span class="n">ironlake_wait_panel_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_backlight_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we enable the backlight right away following a panel power</span>
<span class="cm">	 * on, we may see slight flicker as the panel syncs with the eDP</span>
<span class="cm">	 * link.  So delay a bit to make sure the image is solid before</span>
<span class="cm">	 * allowing it to appear.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">backlight_on_delay</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">ironlake_get_pp_control</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">|=</span> <span class="n">EDP_BLC_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_backlight_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">ironlake_get_pp_control</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EDP_BLC_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">PCH_PP_CONTROL</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">backlight_off_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_pll_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpa_ctl</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dpa_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DP_A</span><span class="p">);</span>
	<span class="n">dpa_ctl</span> <span class="o">|=</span> <span class="n">DP_PLL_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DP_A</span><span class="p">,</span> <span class="n">dpa_ctl</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DP_A</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ironlake_edp_pll_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dpa_ctl</span><span class="p">;</span>

	<span class="n">dpa_ctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DP_A</span><span class="p">);</span>
	<span class="n">dpa_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_PLL_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">DP_A</span><span class="p">,</span> <span class="n">dpa_ctl</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">DP_A</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* If the sink supports it, try to set the power state appropriately */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_dp_sink_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Should have a valid DPCD by this point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_DPCD_REV</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0x11</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_native_write_1</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">DP_SET_POWER</span><span class="p">,</span>
						  <span class="n">DP_SET_POWER_D3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;failed to write sink power state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * When turning on, we need to retry for 1ms to give the sink</span>
<span class="cm">		 * time to wake up.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_native_write_1</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
							  <span class="n">DP_SET_POWER</span><span class="p">,</span>
							  <span class="n">DP_SET_POWER_D0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_dp_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>


	<span class="cm">/* Make sure the panel is off before trying to change the mode. But also</span>
<span class="cm">	 * ensure that we have vdd while we switch off the panel. */</span>
	<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">ironlake_edp_backlight_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">ironlake_edp_panel_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="n">intel_dp_sink_dpms</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
	<span class="n">intel_dp_link_down</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_dp_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">intel_dp_sink_dpms</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
	<span class="n">intel_dp_start_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">ironlake_edp_panel_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">intel_dp_complete_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="n">ironlake_edp_backlight_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_cpt_verify_modeset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dp_reg</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Switching the panel off requires vdd. */</span>
		<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">ironlake_edp_backlight_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">ironlake_edp_panel_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

		<span class="n">intel_dp_sink_dpms</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">intel_dp_link_down</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
			<span class="n">ironlake_edp_pll_off</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
			<span class="n">ironlake_edp_pll_on</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

		<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">intel_dp_sink_dpms</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dp_reg</span> <span class="o">&amp;</span> <span class="n">DP_PORT_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">intel_dp_start_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
			<span class="n">ironlake_edp_panel_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
			<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">intel_dp_complete_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ironlake_edp_backlight_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Native read with retry for link status and receiver capability reads for</span>
<span class="cm"> * cases where the sink may still be asleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_aux_native_read_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">address</span><span class="p">,</span>
			       <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">recv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recv_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sinks are *supposed* to come up within 1ms from an off state,</span>
<span class="cm">	 * but we&#39;re also supposed to retry 3 times per the spec.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_native_read</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">recv</span><span class="p">,</span>
					       <span class="n">recv_bytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">recv_bytes</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fetch AUX CH registers 0x202 - 0x207 which contain</span>
<span class="cm"> * link status information</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_get_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">intel_dp_aux_native_read_retry</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
					      <span class="n">DP_LANE0_1_STATUS</span><span class="p">,</span>
					      <span class="n">link_status</span><span class="p">,</span>
					      <span class="n">DP_LINK_STATUS_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">intel_dp_link_status</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">],</span>
		     <span class="kt">int</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">link_status</span><span class="p">[</span><span class="n">r</span> <span class="o">-</span> <span class="n">DP_LANE0_1_STATUS</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">intel_get_adjust_request_voltage</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">adjust_request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				 <span class="kt">int</span> <span class="n">lane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	    <span class="n">s</span> <span class="o">=</span> <span class="p">((</span><span class="n">lane</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			 <span class="n">DP_ADJUST_VOLTAGE_SWING_LANE1_SHIFT</span> <span class="o">:</span>
			 <span class="n">DP_ADJUST_VOLTAGE_SWING_LANE0_SHIFT</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">l</span> <span class="o">=</span> <span class="n">adjust_request</span><span class="p">[</span><span class="n">lane</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">intel_get_adjust_request_pre_emphasis</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">adjust_request</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				      <span class="kt">int</span> <span class="n">lane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	    <span class="n">s</span> <span class="o">=</span> <span class="p">((</span><span class="n">lane</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			 <span class="n">DP_ADJUST_PRE_EMPHASIS_LANE1_SHIFT</span> <span class="o">:</span>
			 <span class="n">DP_ADJUST_PRE_EMPHASIS_LANE0_SHIFT</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">l</span> <span class="o">=</span> <span class="n">adjust_request</span><span class="p">[</span><span class="n">lane</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_SHIFT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static char	*voltage_names[] = {</span>
<span class="c">	&quot;0.4V&quot;, &quot;0.6V&quot;, &quot;0.8V&quot;, &quot;1.2V&quot;</span>
<span class="c">};</span>
<span class="c">static char	*pre_emph_names[] = {</span>
<span class="c">	&quot;0dB&quot;, &quot;3.5dB&quot;, &quot;6dB&quot;, &quot;9.5dB&quot;</span>
<span class="c">};</span>
<span class="c">static char	*link_train_names[] = {</span>
<span class="c">	&quot;pattern 1&quot;, &quot;pattern 2&quot;, &quot;idle&quot;, &quot;off&quot;</span>
<span class="c">};</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * These are source-specific values; current Intel hardware supports</span>
<span class="cm"> * a maximum voltage of 800mV and a maximum pre-emphasis of 6dB</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">intel_dp_voltage_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_1200</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">intel_dp_pre_emphasis_max</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">voltage_swing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">voltage_swing</span> <span class="o">&amp;</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span>:
			<span class="k">return</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_6</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span>:
		<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span>:
			<span class="k">return</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">voltage_swing</span> <span class="o">&amp;</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span>:
			<span class="k">return</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_6</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span>:
			<span class="k">return</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_6</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span>:
			<span class="k">return</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_1200</span>:
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_get_adjust_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lane</span><span class="p">;</span>
	<span class="kt">uint8_t</span>	<span class="o">*</span><span class="n">adjust_request</span> <span class="o">=</span> <span class="n">link_status</span> <span class="o">+</span> <span class="p">(</span><span class="n">DP_ADJUST_REQUEST_LANE0_1</span> <span class="o">-</span> <span class="n">DP_LANE0_1_STATUS</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">voltage_max</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">preemph_max</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lane</span> <span class="o">&lt;</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">;</span> <span class="n">lane</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">this_v</span> <span class="o">=</span> <span class="n">intel_get_adjust_request_voltage</span><span class="p">(</span><span class="n">adjust_request</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>
		<span class="kt">uint8_t</span> <span class="n">this_p</span> <span class="o">=</span> <span class="n">intel_get_adjust_request_pre_emphasis</span><span class="p">(</span><span class="n">adjust_request</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this_v</span> <span class="o">&gt;</span> <span class="n">v</span><span class="p">)</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">this_v</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_p</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">this_p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">voltage_max</span> <span class="o">=</span> <span class="n">intel_dp_voltage_max</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">voltage_max</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">voltage_max</span> <span class="o">|</span> <span class="n">DP_TRAIN_MAX_SWING_REACHED</span><span class="p">;</span>

	<span class="n">preemph_max</span> <span class="o">=</span> <span class="n">intel_dp_pre_emphasis_max</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">preemph_max</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">preemph_max</span> <span class="o">|</span> <span class="n">DP_TRAIN_MAX_PRE_EMPHASIS_REACHED</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lane</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">lane</span><span class="o">++</span><span class="p">)</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="n">lane</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="o">|</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">intel_dp_signal_levels</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">train_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span>	<span class="n">signal_levels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">train_set</span> <span class="o">&amp;</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span>:
	<span class="nl">default:</span>
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_VOLTAGE_0_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span>:
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_VOLTAGE_0_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span>:
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_VOLTAGE_0_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_1200</span>:
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_VOLTAGE_1_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">train_set</span> <span class="o">&amp;</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
	<span class="nl">default:</span>
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_PRE_EMPHASIS_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span>:
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_PRE_EMPHASIS_3_5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_6</span>:
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_PRE_EMPHASIS_6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_9_5</span>:
		<span class="n">signal_levels</span> <span class="o">|=</span> <span class="n">DP_PRE_EMPHASIS_9_5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">signal_levels</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Gen6&#39;s DP voltage swing and pre-emphasis control */</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">intel_gen6_edp_signal_levels</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">train_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">signal_levels</span> <span class="o">=</span> <span class="n">train_set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DP_TRAIN_VOLTAGE_SWING_MASK</span> <span class="o">|</span>
					 <span class="n">DP_TRAIN_PRE_EMPHASIS_MASK</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">signal_levels</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_400_600MV_0DB_SNB_B</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_400MV_3_5DB_SNB_B</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_6</span>:
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_6</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_400_600MV_6DB_SNB_B</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span>:
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_600_800MV_3_5DB_SNB_B</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_1200</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_800_1200MV_0DB_SNB_B</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unsupported voltage swing/pre-emphasis level:&quot;</span>
			      <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signal_levels</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_400_600MV_0DB_SNB_B</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Gen7&#39;s DP voltage swing and pre-emphasis control */</span>
<span class="k">static</span> <span class="kt">uint32_t</span>
<span class="nf">intel_gen7_edp_signal_levels</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">train_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">signal_levels</span> <span class="o">=</span> <span class="n">train_set</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DP_TRAIN_VOLTAGE_SWING_MASK</span> <span class="o">|</span>
					 <span class="n">DP_TRAIN_PRE_EMPHASIS_MASK</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">signal_levels</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_400MV_0DB_IVB</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_400MV_3_5DB_IVB</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_400</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_6</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_400MV_6DB_IVB</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_600MV_0DB_IVB</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_600</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_600MV_3_5DB_IVB</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_0</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_800MV_0DB_IVB</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_800</span> <span class="o">|</span> <span class="n">DP_TRAIN_PRE_EMPHASIS_3_5</span>:
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_800MV_3_5DB_IVB</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unsupported voltage swing/pre-emphasis level:&quot;</span>
			      <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signal_levels</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">EDP_LINK_TRAIN_500MV_0DB_IVB</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint8_t</span>
<span class="nf">intel_get_lane_status</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">],</span>
		      <span class="kt">int</span> <span class="n">lane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">lane</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">l</span> <span class="o">=</span> <span class="n">link_status</span><span class="p">[</span><span class="n">lane</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check for clock recovery is done on all channels */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_clock_recovery_ok</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">],</span> <span class="kt">int</span> <span class="n">lane_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lane</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">lane_status</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lane</span> <span class="o">&lt;</span> <span class="n">lane_count</span><span class="p">;</span> <span class="n">lane</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lane_status</span> <span class="o">=</span> <span class="n">intel_get_lane_status</span><span class="p">(</span><span class="n">link_status</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lane_status</span> <span class="o">&amp;</span> <span class="n">DP_LANE_CR_DONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check to see if channel eq is done on all channels */</span>
<span class="cp">#define CHANNEL_EQ_BITS (DP_LANE_CR_DONE|\</span>
<span class="cp">			 DP_LANE_CHANNEL_EQ_DONE|\</span>
<span class="cp">			 DP_LANE_SYMBOL_LOCKED)</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_channel_eq_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">lane_align</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">lane_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lane</span><span class="p">;</span>

	<span class="n">lane_align</span> <span class="o">=</span> <span class="n">intel_dp_link_status</span><span class="p">(</span><span class="n">link_status</span><span class="p">,</span>
					  <span class="n">DP_LANE_ALIGN_STATUS_UPDATED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lane_align</span> <span class="o">&amp;</span> <span class="n">DP_INTERLANE_ALIGN_DONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lane</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">lane</span> <span class="o">&lt;</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">;</span> <span class="n">lane</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lane_status</span> <span class="o">=</span> <span class="n">intel_get_lane_status</span><span class="p">(</span><span class="n">link_status</span><span class="p">,</span> <span class="n">lane</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lane_status</span> <span class="o">&amp;</span> <span class="n">CHANNEL_EQ_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CHANNEL_EQ_BITS</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_set_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span>
			<span class="kt">uint32_t</span> <span class="n">dp_reg_value</span><span class="p">,</span>
			<span class="kt">uint8_t</span> <span class="n">dp_train_pat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">dp_reg_value</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>

	<span class="n">intel_dp_aux_native_write_1</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
				    <span class="n">DP_TRAINING_PATTERN_SET</span><span class="p">,</span>
				    <span class="n">dp_train_pat</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_native_write</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
					<span class="n">DP_TRAINING_LANE0_SET</span><span class="p">,</span>
					<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">,</span>
					<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enable corresponding port and start training pattern 1 */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_start_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">intel_crtc</span> <span class="o">=</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">voltage</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">clock_recovery</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">voltage_tries</span><span class="p">,</span> <span class="n">loop_tries</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">DP</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On CPT we have to enable the port in training pattern 1, which</span>
<span class="cm">	 * will happen below in intel_dp_set_link_train.  Otherwise, enable</span>
<span class="cm">	 * the port and wait for it to become active.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>
		<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Write the link configuration data */</span>
	<span class="n">intel_dp_aux_native_write</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">DP_LINK_BW_SET</span><span class="p">,</span>
				  <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">link_configuration</span><span class="p">,</span>
				  <span class="n">DP_LINK_CONFIGURATION_SIZE</span><span class="p">);</span>

	<span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_PORT_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)))</span>
		<span class="n">DP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_LINK_TRAIN_MASK_CPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">DP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_LINK_TRAIN_MASK</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">voltage</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">voltage_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loop_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clock_recovery</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* Use intel_dp-&gt;train_set[0] to set the voltage and pre emphasis values */</span>
		<span class="kt">uint8_t</span>	    <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">];</span>
		<span class="kt">uint32_t</span>    <span class="n">signal_levels</span><span class="p">;</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">signal_levels</span> <span class="o">=</span> <span class="n">intel_gen7_edp_signal_levels</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">DP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DP</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EDP_LINK_TRAIN_VOL_EMP_MASK_IVB</span><span class="p">)</span> <span class="o">|</span> <span class="n">signal_levels</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">signal_levels</span> <span class="o">=</span> <span class="n">intel_gen6_edp_signal_levels</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">DP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DP</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EDP_LINK_TRAIN_VOL_EMP_MASK_SNB</span><span class="p">)</span> <span class="o">|</span> <span class="n">signal_levels</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">signal_levels</span> <span class="o">=</span> <span class="n">intel_dp_signal_levels</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;training pattern 1 signal levels %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signal_levels</span><span class="p">);</span>
			<span class="n">DP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DP</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DP_VOLTAGE_MASK</span><span class="o">|</span><span class="n">DP_PRE_EMPHASIS_MASK</span><span class="p">))</span> <span class="o">|</span> <span class="n">signal_levels</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)))</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_PAT_1_CPT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_PAT_1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_set_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
					     <span class="n">DP_TRAINING_PATTERN_1</span> <span class="o">|</span>
					     <span class="n">DP_LINK_SCRAMBLING_DISABLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Set training pattern 1 */</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_get_link_status</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">link_status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to get link status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_clock_recovery_ok</span><span class="p">(</span><span class="n">link_status</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;clock recovery OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">clock_recovery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check to see if we&#39;ve tried the max voltage */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DP_TRAIN_MAX_SWING_REACHED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">loop_tries</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop_tries</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;too many full retries, give up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">voltage_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check to see if we&#39;ve tried the same voltage 5 times */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">voltage</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">voltage_tries</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voltage_tries</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;too many voltage retries, give up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">voltage_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">voltage</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DP_TRAIN_VOLTAGE_SWING_MASK</span><span class="p">;</span>

		<span class="cm">/* Compute new intel_dp-&gt;train_set as requested by target */</span>
		<span class="n">intel_get_adjust_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">link_status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span> <span class="o">=</span> <span class="n">DP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_complete_link_train</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">channel_eq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span><span class="p">,</span> <span class="n">cr_tries</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">DP</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span><span class="p">;</span>

	<span class="cm">/* channel equalization */</span>
	<span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cr_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">channel_eq</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* Use intel_dp-&gt;train_set[0] to set the voltage and pre emphasis values */</span>
		<span class="kt">uint32_t</span>    <span class="n">signal_levels</span><span class="p">;</span>
		<span class="kt">uint8_t</span>	    <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cr_tries</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to train DP, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">intel_dp_link_down</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">signal_levels</span> <span class="o">=</span> <span class="n">intel_gen7_edp_signal_levels</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">DP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DP</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EDP_LINK_TRAIN_VOL_EMP_MASK_IVB</span><span class="p">)</span> <span class="o">|</span> <span class="n">signal_levels</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">signal_levels</span> <span class="o">=</span> <span class="n">intel_gen6_edp_signal_levels</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">DP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DP</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EDP_LINK_TRAIN_VOL_EMP_MASK_SNB</span><span class="p">)</span> <span class="o">|</span> <span class="n">signal_levels</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">signal_levels</span> <span class="o">=</span> <span class="n">intel_dp_signal_levels</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">train_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">DP</span> <span class="o">=</span> <span class="p">(</span><span class="n">DP</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">DP_VOLTAGE_MASK</span><span class="o">|</span><span class="n">DP_PRE_EMPHASIS_MASK</span><span class="p">))</span> <span class="o">|</span> <span class="n">signal_levels</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)))</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_PAT_2_CPT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_PAT_2</span><span class="p">;</span>

		<span class="cm">/* channel eq pattern */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_set_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
					     <span class="n">DP_TRAINING_PATTERN_2</span> <span class="o">|</span>
					     <span class="n">DP_LINK_SCRAMBLING_DISABLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_get_link_status</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">link_status</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Make sure clock is still ok */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_clock_recovery_ok</span><span class="p">(</span><span class="n">link_status</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">lane_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">intel_dp_start_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
			<span class="n">cr_tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intel_channel_eq_ok</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">link_status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">channel_eq</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Try 5 times, then try clock recovery if that fails */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intel_dp_link_down</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
			<span class="n">intel_dp_start_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
			<span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cr_tries</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Compute new intel_dp-&gt;train_set as requested by target */</span>
		<span class="n">intel_get_adjust_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">link_status</span><span class="p">);</span>
		<span class="o">++</span><span class="n">tries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)))</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_OFF_CPT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_OFF</span><span class="p">;</span>

	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>
	<span class="n">intel_dp_aux_native_write_1</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
				    <span class="n">DP_TRAINING_PATTERN_SET</span><span class="p">,</span> <span class="n">DP_TRAINING_PATTERN_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_link_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">DP</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">DP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_PORT_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_PLL_ENABLE</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">DP</span><span class="p">);</span>
		<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_LINK_TRAIN_MASK_CPT</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_PAT_IDLE_CPT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_LINK_TRAIN_MASK</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">DP</span> <span class="o">|</span> <span class="n">DP_LINK_TRAIN_PAT_IDLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">17</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_cpu_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)))</span>
			<span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_LINK_TRAIN_OFF_CPT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">DP</span> <span class="o">|=</span> <span class="n">DP_LINK_TRAIN_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_PCH_CPT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">I915_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DP_PIPEB_SELECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>

		<span class="cm">/* Hardware workaround: leaving our transcoder select</span>
<span class="cm">		 * set to transcoder B while it&#39;s off will prevent the</span>
<span class="cm">		 * corresponding HDMI output on transcoder A.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Combine this with another hardware workaround:</span>
<span class="cm">		 * transcoder select bit can only be cleared while the</span>
<span class="cm">		 * port is enabled.</span>
<span class="cm">		 */</span>
		<span class="n">DP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_PIPEB_SELECT</span><span class="p">;</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">DP</span><span class="p">);</span>

		<span class="cm">/* Changes to enable or select take place the vblank</span>
<span class="cm">		 * after being written.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We can arrive here never having been attached</span>
<span class="cm">			 * to a CRTC, for instance, due to inheriting</span>
<span class="cm">			 * random state from the BIOS.</span>
<span class="cm">			 *</span>
<span class="cm">			 * If the pipe is not running, play safe and</span>
<span class="cm">			 * wait for the clocks to stabilise before</span>
<span class="cm">			 * continuing.</span>
<span class="cm">			 */</span>
			<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">intel_wait_for_vblank</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">to_intel_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DP</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DP_AUDIO_OUTPUT_ENABLE</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">,</span> <span class="n">DP</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DP_PORT_EN</span><span class="p">);</span>
	<span class="n">POSTING_READ</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_down_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_get_dpcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp_aux_native_read_retry</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="mh">0x000</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_DPCD_REV</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_probe_oui</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_DOWN_STREAM_PORT_COUNT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DP_OUI_SUPPORT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp_aux_native_read_retry</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">DP_SINK_OUI</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Sink OUI: %02hx%02hx%02hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp_aux_native_read_retry</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">DP_BRANCH_OUI</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Branch OUI: %02hx%02hx%02hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_get_sink_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sink_irq_vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_aux_native_read_retry</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
					     <span class="n">DP_DEVICE_SERVICE_IRQ_VECTOR</span><span class="p">,</span>
					     <span class="n">sink_irq_vector</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_handle_test_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* NAK by default */</span>
	<span class="n">intel_dp_aux_native_write_1</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">DP_TEST_RESPONSE</span><span class="p">,</span> <span class="n">DP_TEST_ACK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * According to DP spec</span>
<span class="cm"> * 5.1.2:</span>
<span class="cm"> *  1. Read DPCD</span>
<span class="cm"> *  2. Configure link according to Receiver Capabilities</span>
<span class="cm"> *  3. Use Link Training from 2.5.3.3 and 3.5.1.3</span>
<span class="cm"> *  4. Check link status on receipt of hot-plug interrupt</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_check_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sink_irq_vector</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link_status</span><span class="p">[</span><span class="n">DP_LINK_STATUS_SIZE</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">!=</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Try to read receiver status if the link appears to be up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_get_link_status</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">link_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_dp_link_down</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now read the DPCD to see if it&#39;s actually running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp_get_dpcd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_dp_link_down</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to read the source of the interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_DPCD_REV</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x11</span> <span class="o">&amp;&amp;</span>
	    <span class="n">intel_dp_get_sink_irq</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sink_irq_vector</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Clear interrupt source */</span>
		<span class="n">intel_dp_aux_native_write_1</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span>
					    <span class="n">DP_DEVICE_SERVICE_IRQ_VECTOR</span><span class="p">,</span>
					    <span class="n">sink_irq_vector</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sink_irq_vector</span> <span class="o">&amp;</span> <span class="n">DP_AUTOMATED_TEST_REQUEST</span><span class="p">)</span>
			<span class="n">intel_dp_handle_test_request</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sink_irq_vector</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DP_CP_IRQ</span> <span class="o">|</span> <span class="n">DP_SINK_SPECIFIC_IRQ</span><span class="p">))</span>
			<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;CP or sink specific irq unhandled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_channel_eq_ok</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">link_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;%s: channel EQ not ok, retraining</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">drm_get_encoder_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">));</span>
		<span class="n">intel_dp_start_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">intel_dp_complete_link_train</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">intel_dp_detect_dpcd</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp_get_dpcd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">ironlake_dp_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">drm_connector_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Can&#39;t disconnect eDP, but you can close the lid... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">intel_panel_detect</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_unknown</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">connector_status_connected</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">intel_dp_detect_dpcd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">g4x_dp_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DP_B</span>:
		<span class="n">bit</span> <span class="o">=</span> <span class="n">DPB_HOTPLUG_INT_STATUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_C</span>:
		<span class="n">bit</span> <span class="o">=</span> <span class="n">DPC_HOTPLUG_INT_STATUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DP_D</span>:
		<span class="n">bit</span> <span class="o">=</span> <span class="n">DPD_HOTPLUG_INT_STATUS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">connector_status_unknown</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">intel_dp_detect_dpcd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span>
<span class="nf">intel_dp_get_edid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">intel_attached_dp</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edid</span>	<span class="o">*</span><span class="n">edid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span><span class="o">-&gt;</span><span class="n">extensions</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">EDID_LENGTH</span><span class="p">;</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edid</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">edid</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">edid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">edid</span> <span class="o">=</span> <span class="n">drm_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">edid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_get_edid_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">intel_attached_dp</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drm_mode_connector_update_edid_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
							<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_add_edid_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">);</span>
		<span class="n">drm_edid_to_eld</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">);</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">raw_edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid_mode_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_ddc_get_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Uses CRT_HOTPLUG_EN and CRT_HOTPLUG_STAT to detect DP connection.</span>
<span class="cm"> *</span>
<span class="cm"> * \return true if DP port is connected.</span>
<span class="cm"> * \return false if DP port is disconnected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span>
<span class="nf">intel_dp_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">intel_attached_dp</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drm_connector_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">has_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ironlake_dp_detect</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">g4x_dp_detect</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;DPCD: %02hx%02hx%02hx%02hx%02hx%02hx%02hx%02hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		      <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		      <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">connector_status_connected</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">intel_dp_probe_oui</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">force_audio</span> <span class="o">!=</span> <span class="n">HDMI_AUDIO_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">has_audio</span> <span class="o">=</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">force_audio</span> <span class="o">==</span> <span class="n">HDMI_AUDIO_ON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_dp_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">has_audio</span> <span class="o">=</span> <span class="n">drm_detect_monitor_audio</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">raw_edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel_dp_get_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">intel_attached_dp</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* We should parse the EDID data and find out if it has an audio sink</span>
<span class="cm">	 */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_get_edid_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">newmode</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">newmode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">newmode</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">=</span>
						<span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">newmode</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if eDP has no EDID, try to use fixed panel mode from VBT */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* initialize panel mode from VBT if available for eDP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lfp_lvds_vbt_mode</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span> <span class="o">=</span>
				<span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">lfp_lvds_vbt_mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span>
					<span class="n">DRM_MODE_TYPE_PREFERRED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_fixed_mode</span><span class="p">);</span>
			<span class="n">drm_mode_probed_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">intel_dp_detect_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">intel_attached_dp</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_audio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">edid</span> <span class="o">=</span> <span class="n">intel_dp_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">has_audio</span> <span class="o">=</span> <span class="n">drm_detect_monitor_audio</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>

		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">raw_edid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">edid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">has_audio</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_dp_set_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
		      <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">intel_attached_dp</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">force_audio_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">has_audio</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">force_audio</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">force_audio</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HDMI_AUDIO_AUTO</span><span class="p">)</span>
			<span class="n">has_audio</span> <span class="o">=</span> <span class="n">intel_dp_detect_audio</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">has_audio</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">HDMI_AUDIO_ON</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">has_audio</span> <span class="o">==</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">has_audio</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">has_audio</span> <span class="o">=</span> <span class="n">has_audio</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">broadcast_rgb_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="o">!!</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">color_range</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">color_range</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">DP_COLOR_RANGE_16_235</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">crtc</span><span class="p">;</span>
		<span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
					 <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span>
					 <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_dpd_is_edp</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_panel_destroy_backlight</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">drm_sysfs_connector_remove</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">drm_connector_cleanup</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">intel_dp_encoder_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">drm_encoder_cleanup</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span><span class="p">);</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_vdd_work</span><span class="p">);</span>
		<span class="n">ironlake_panel_vdd_off_sync</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">intel_dp_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">intel_dp_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">intel_dp_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">intel_dp_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">intel_dp_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">intel_dp_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_connector_funcs</span> <span class="n">intel_dp_connector_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">drm_helper_connector_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">intel_dp_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_modes</span> <span class="o">=</span> <span class="n">drm_helper_probe_single_connector_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_property</span> <span class="o">=</span> <span class="n">intel_dp_set_property</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_dp_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_connector_helper_funcs</span> <span class="n">intel_dp_connector_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_modes</span> <span class="o">=</span> <span class="n">intel_dp_get_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_valid</span> <span class="o">=</span> <span class="n">intel_dp_mode_valid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">best_encoder</span> <span class="o">=</span> <span class="n">intel_best_encoder</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_funcs</span> <span class="n">intel_dp_enc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">intel_dp_encoder_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_hot_plug</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">intel_encoder</span><span class="p">,</span> <span class="k">struct</span> <span class="n">intel_dp</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="n">intel_dp_check_link_status</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return which DP Port should be selected for Transcoder DP control */</span>
<span class="kt">int</span>
<span class="nf">intel_trans_dp_port_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">mode_config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_config</span><span class="o">-&gt;</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">intel_dp</span> <span class="o">=</span> <span class="n">enc_to_intel_dp</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span> <span class="o">||</span>
		    <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">INTEL_OUTPUT_EDP</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check the VBT to see whether the eDP is on DP-D port */</span>
<span class="n">bool</span> <span class="nf">intel_dpd_is_edp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">child_device_config</span> <span class="o">*</span><span class="n">p_child</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev_num</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p_child</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p_child</span><span class="o">-&gt;</span><span class="n">dvo_port</span> <span class="o">==</span> <span class="n">PORT_IDPD</span> <span class="o">&amp;&amp;</span>
		    <span class="n">p_child</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_TYPE_eDP</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_dp_add_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">intel_attach_force_audio_property</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">intel_attach_broadcast_rgb_property</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">intel_dp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">output_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_dp</span> <span class="o">*</span><span class="n">intel_dp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_encoder</span> <span class="o">*</span><span class="n">intel_encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_connector</span> <span class="o">*</span><span class="n">intel_connector</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">intel_dp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_dp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_dp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">output_reg</span> <span class="o">=</span> <span class="n">output_reg</span><span class="p">;</span>
	<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpms_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">intel_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intel_connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">intel_encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">output_reg</span> <span class="o">==</span> <span class="n">PCH_DP_D</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intel_dpd_is_edp</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">is_pch_edp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output_reg</span> <span class="o">==</span> <span class="n">DP_A</span> <span class="o">||</span> <span class="n">is_pch_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_eDP</span><span class="p">;</span>
		<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">INTEL_OUTPUT_EDP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">DRM_MODE_CONNECTOR_DisplayPort</span><span class="p">;</span>
		<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">INTEL_OUTPUT_DISPLAYPORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">drm_connector_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp_connector_funcs</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">drm_connector_helper_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp_connector_helper_funcs</span><span class="p">);</span>

	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">=</span> <span class="n">DRM_CONNECTOR_POLL_HPD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">output_reg</span> <span class="o">==</span> <span class="n">DP_B</span> <span class="o">||</span> <span class="n">output_reg</span> <span class="o">==</span> <span class="n">PCH_DP_B</span><span class="p">)</span>
		<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_DP_B_CLONE_BIT</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">output_reg</span> <span class="o">==</span> <span class="n">DP_C</span> <span class="o">||</span> <span class="n">output_reg</span> <span class="o">==</span> <span class="n">PCH_DP_C</span><span class="p">)</span>
		<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_DP_C_CLONE_BIT</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">output_reg</span> <span class="o">==</span> <span class="n">DP_D</span> <span class="o">||</span> <span class="n">output_reg</span> <span class="o">==</span> <span class="n">PCH_DP_D</span><span class="p">)</span>
		<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_DP_D_CLONE_BIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">clone_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">INTEL_EDP_CLONE_BIT</span><span class="p">);</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_vdd_work</span><span class="p">,</span>
				  <span class="n">ironlake_panel_vdd_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">crtc_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">interlace_allowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">doublescan_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp_enc_funcs</span><span class="p">,</span>
			 <span class="n">DRM_MODE_ENCODER_TMDS</span><span class="p">);</span>
	<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp_helper_funcs</span><span class="p">);</span>

	<span class="n">intel_connector_attach_encoder</span><span class="p">(</span><span class="n">intel_connector</span><span class="p">,</span> <span class="n">intel_encoder</span><span class="p">);</span>
	<span class="n">drm_sysfs_connector_add</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="cm">/* Set up the DDC bus. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">output_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DP_A</span>:
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DPDDC-A&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DP_B</span>:
		<span class="k">case</span> <span class="n">PCH_DP_B</span>:
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">|=</span>
				<span class="n">HDMIB_HOTPLUG_INT_STATUS</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DPDDC-B&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DP_C</span>:
		<span class="k">case</span> <span class="n">PCH_DP_C</span>:
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">|=</span>
				<span class="n">HDMIC_HOTPLUG_INT_STATUS</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DPDDC-C&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DP_D</span>:
		<span class="k">case</span> <span class="n">PCH_DP_D</span>:
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hotplug_supported_mask</span> <span class="o">|=</span>
				<span class="n">HDMID_HOTPLUG_INT_STATUS</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DPDDC-D&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_dp_i2c_init</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">intel_connector</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Cache some DPCD data in the eDP case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">edp_power_seq</span>	<span class="n">cur</span><span class="p">,</span> <span class="n">vbt</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">pp_on</span><span class="p">,</span> <span class="n">pp_off</span><span class="p">,</span> <span class="n">pp_div</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>

		<span class="n">pp_on</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_ON_DELAYS</span><span class="p">);</span>
		<span class="n">pp_off</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_OFF_DELAYS</span><span class="p">);</span>
		<span class="n">pp_div</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PCH_PP_DIVISOR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp_on</span> <span class="o">||</span> <span class="o">!</span><span class="n">pp_off</span> <span class="o">||</span> <span class="o">!</span><span class="n">pp_div</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;bad panel power sequencing delays, disabling panel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">intel_dp_encoder_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
			<span class="n">intel_dp_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Pull timing values out of registers */</span>
		<span class="n">cur</span><span class="p">.</span><span class="n">t1_t3</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp_on</span> <span class="o">&amp;</span> <span class="n">PANEL_POWER_UP_DELAY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PANEL_POWER_UP_DELAY_SHIFT</span><span class="p">;</span>

		<span class="n">cur</span><span class="p">.</span><span class="n">t8</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp_on</span> <span class="o">&amp;</span> <span class="n">PANEL_LIGHT_ON_DELAY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PANEL_LIGHT_ON_DELAY_SHIFT</span><span class="p">;</span>

		<span class="n">cur</span><span class="p">.</span><span class="n">t9</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp_off</span> <span class="o">&amp;</span> <span class="n">PANEL_LIGHT_OFF_DELAY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PANEL_LIGHT_OFF_DELAY_SHIFT</span><span class="p">;</span>

		<span class="n">cur</span><span class="p">.</span><span class="n">t10</span> <span class="o">=</span> <span class="p">(</span><span class="n">pp_off</span> <span class="o">&amp;</span> <span class="n">PANEL_POWER_DOWN_DELAY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">PANEL_POWER_DOWN_DELAY_SHIFT</span><span class="p">;</span>

		<span class="n">cur</span><span class="p">.</span><span class="n">t11_t12</span> <span class="o">=</span> <span class="p">((</span><span class="n">pp_div</span> <span class="o">&amp;</span> <span class="n">PANEL_POWER_CYCLE_DELAY_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			       <span class="n">PANEL_POWER_CYCLE_DELAY_SHIFT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;cur t1_t3 %d t8 %d t9 %d t10 %d t11_t12 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">cur</span><span class="p">.</span><span class="n">t1_t3</span><span class="p">,</span> <span class="n">cur</span><span class="p">.</span><span class="n">t8</span><span class="p">,</span> <span class="n">cur</span><span class="p">.</span><span class="n">t9</span><span class="p">,</span> <span class="n">cur</span><span class="p">.</span><span class="n">t10</span><span class="p">,</span> <span class="n">cur</span><span class="p">.</span><span class="n">t11_t12</span><span class="p">);</span>

		<span class="n">vbt</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">edp</span><span class="p">.</span><span class="n">pps</span><span class="p">;</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;vbt t1_t3 %d t8 %d t9 %d t10 %d t11_t12 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">vbt</span><span class="p">.</span><span class="n">t1_t3</span><span class="p">,</span> <span class="n">vbt</span><span class="p">.</span><span class="n">t8</span><span class="p">,</span> <span class="n">vbt</span><span class="p">.</span><span class="n">t9</span><span class="p">,</span> <span class="n">vbt</span><span class="p">.</span><span class="n">t10</span><span class="p">,</span> <span class="n">vbt</span><span class="p">.</span><span class="n">t11_t12</span><span class="p">);</span>

<span class="cp">#define get_delay(field)	((max(cur.field, vbt.field) + 9) / 10)</span>

		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_up_delay</span> <span class="o">=</span> <span class="n">get_delay</span><span class="p">(</span><span class="n">t1_t3</span><span class="p">);</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">backlight_on_delay</span> <span class="o">=</span> <span class="n">get_delay</span><span class="p">(</span><span class="n">t8</span><span class="p">);</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">backlight_off_delay</span> <span class="o">=</span> <span class="n">get_delay</span><span class="p">(</span><span class="n">t9</span><span class="p">);</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_down_delay</span> <span class="o">=</span> <span class="n">get_delay</span><span class="p">(</span><span class="n">t10</span><span class="p">);</span>
		<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_cycle_delay</span> <span class="o">=</span> <span class="n">get_delay</span><span class="p">(</span><span class="n">t11_t12</span><span class="p">);</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;panel power up delay %d, power down delay %d, power cycle delay %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_up_delay</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_down_delay</span><span class="p">,</span>
			      <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">panel_power_cycle_delay</span><span class="p">);</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;backlight on delay %d, off delay %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">backlight_on_delay</span><span class="p">,</span> <span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">backlight_off_delay</span><span class="p">);</span>

		<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_dp_get_dpcd</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_DPCD_REV</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x11</span><span class="p">)</span>
				<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_aux_handshake</span> <span class="o">=</span>
					<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">dpcd</span><span class="p">[</span><span class="n">DP_MAX_DOWNSPREAD</span><span class="p">]</span> <span class="o">&amp;</span>
					<span class="n">DP_NO_AUX_HANDSHAKE_LINK_TRAINING</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* if this fails, presume the device is a ghost */</span>
			<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;failed to retrieve link info, disabling eDP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">intel_dp_encoder_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
			<span class="n">intel_dp_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intel_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ironlake_edp_panel_vdd_on</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">);</span>
		<span class="n">edid</span> <span class="o">=</span> <span class="n">drm_get_edid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_mode_connector_update_edid_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
								<span class="n">edid</span><span class="p">);</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid_mode_count</span> <span class="o">=</span>
				<span class="n">drm_add_edid_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">edid</span><span class="p">);</span>
			<span class="n">drm_edid_to_eld</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">edid</span><span class="p">);</span>
			<span class="n">intel_dp</span><span class="o">-&gt;</span><span class="n">edid</span> <span class="o">=</span> <span class="n">edid</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ironlake_edp_panel_vdd_off</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_encoder</span><span class="o">-&gt;</span><span class="n">hot_plug</span> <span class="o">=</span> <span class="n">intel_dp_hot_plug</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_edp</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">int_edp_connector</span> <span class="o">=</span> <span class="n">connector</span><span class="p">;</span>
		<span class="n">intel_panel_setup_backlight</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">intel_dp_add_properties</span><span class="p">(</span><span class="n">intel_dp</span><span class="p">,</span> <span class="n">connector</span><span class="p">);</span>

	<span class="cm">/* For G4X desktop chip, PEG_BAND_GAP_DATA 3:0 must first be written</span>
<span class="cm">	 * 0xd.  Failure to do so will result in spurious interrupts being</span>
<span class="cm">	 * generated on the port when a cable is not attached.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_GM45</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PEG_BAND_GAP_DATA</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">PEG_BAND_GAP_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
