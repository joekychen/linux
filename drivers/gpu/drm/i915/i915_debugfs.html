<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › i915_debugfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>i915_debugfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright © 2008 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the &quot;Software&quot;),</span>
<span class="cm"> * to deal in the Software without restriction, including without limitation</span>
<span class="cm"> * the rights to use, copy, modify, merge, publish, distribute, sublicense,</span>
<span class="cm"> * and/or sell copies of the Software, and to permit persons to whom the</span>
<span class="cm"> * Software is furnished to do so, subject to the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the next</span>
<span class="cm"> * paragraph) shall be included in all copies or substantial portions of the</span>
<span class="cm"> * Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL</span>
<span class="cm"> * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="cm"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span>
<span class="cm"> * IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *    Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> *    Keith Packard &lt;keithp@keithp.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &quot;intel_ringbuffer.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>

<span class="cp">#define DRM_I915_RING_DEBUG 1</span>


<span class="cp">#if defined(CONFIG_DEBUG_FS)</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ACTIVE_LIST</span><span class="p">,</span>
	<span class="n">FLUSHING_LIST</span><span class="p">,</span>
	<span class="n">INACTIVE_LIST</span><span class="p">,</span>
	<span class="n">PINNED_LIST</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">yesno</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">intel_device_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;gen: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;pch: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">INTEL_PCH_TYPE</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="cp">#define B(x) seq_printf(m, #x &quot;: %s\n&quot;, yesno(info-&gt;x))</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_mobile</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_i85x</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_i915g</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_i945gm</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_g33</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">need_gfx_hws</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_g4x</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_pineview</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_broadwater</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">is_crestline</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">has_fbc</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">has_pipe_cxsr</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">has_hotplug</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">cursor_needs_physical</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">has_overlay</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">overlay_needs_physical</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">supports_tv</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">has_bsd_ring</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">has_blt_ring</span><span class="p">);</span>
	<span class="n">B</span><span class="p">(</span><span class="n">has_llc</span><span class="p">);</span>
<span class="cp">#undef B</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_pin_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">user_pin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;P&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;p&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_tiling_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">tiling_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">I915_TILING_NONE</span>: <span class="k">return</span> <span class="s">&quot; &quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_TILING_X</span>: <span class="k">return</span> <span class="s">&quot;X&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_TILING_Y</span>: <span class="k">return</span> <span class="s">&quot;Y&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">cache_level_str</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_CACHE_NONE</span>: <span class="k">return</span> <span class="s">&quot; uncached&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_CACHE_LLC</span>: <span class="k">return</span> <span class="s">&quot; snooped (LLC)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_CACHE_LLC_MLC</span>: <span class="k">return</span> <span class="s">&quot; snooped (LLC+MLC)&quot;</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">describe_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%p: %s%s %8zdKiB %04x %04x %d %d%s%s%s&quot;</span><span class="p">,</span>
		   <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
		   <span class="n">get_pin_flag</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
		   <span class="n">get_tiling_flag</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span>
		   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span>
		   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">read_domains</span><span class="p">,</span>
		   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">write_domain</span><span class="p">,</span>
		   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_rendering_seqno</span><span class="p">,</span>
		   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">last_fenced_seqno</span><span class="p">,</span>
		   <span class="n">cache_level_str</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">cache_level</span><span class="p">),</span>
		   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">?</span> <span class="s">&quot; dirty&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">madv</span> <span class="o">==</span> <span class="n">I915_MADV_DONTNEED</span> <span class="o">?</span> <span class="s">&quot; purgeable&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (name: %d)&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">!=</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (fence: %d)&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (gtt offset: %08x, size: %08x)&quot;</span><span class="p">,</span>
			   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_mappable</span> <span class="o">||</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">fault_mappable</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_mappable</span><span class="p">)</span>
			<span class="o">*</span><span class="n">t</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fault_mappable</span><span class="p">)</span>
			<span class="o">*</span><span class="n">t</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (%s mappable)&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (%s)&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_object_list_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">uintptr_t</span> <span class="n">list</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">info_ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">total_obj_size</span><span class="p">,</span> <span class="n">total_gtt_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACTIVE_LIST</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Active:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INACTIVE_LIST</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Inactive:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FLUSHING_LIST</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Flushing:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">total_obj_size</span> <span class="o">=</span> <span class="n">total_gtt_size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">mm_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="n">describe_obj</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">total_obj_size</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="n">total_gtt_size</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Total %d objects, %zu bytes, %zu GTT size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">count</span><span class="p">,</span> <span class="n">total_obj_size</span><span class="p">,</span> <span class="n">total_gtt_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define count_objects(list, member) do { \</span>
<span class="cp">	list_for_each_entry(obj, list, member) { \</span>
<span class="cp">		size += obj-&gt;gtt_space-&gt;size; \</span>
<span class="cp">		++count; \</span>
<span class="cp">		if (obj-&gt;map_and_fenceable) { \</span>
<span class="cp">			mappable_size += obj-&gt;gtt_space-&gt;size; \</span>
<span class="cp">			++mappable_count; \</span>
<span class="cp">		} \</span>
<span class="cp">	} \</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_object_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="n">mappable_count</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%u objects, %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">object_count</span><span class="p">,</span>
		   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">object_memory</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mappable_size</span> <span class="o">=</span> <span class="n">mappable_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">count_objects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">,</span> <span class="n">gtt_list</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%u [%u] objects, %zu [%zu] bytes in gtt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">count</span><span class="p">,</span> <span class="n">mappable_count</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mappable_size</span> <span class="o">=</span> <span class="n">mappable_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">count_objects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">active_list</span><span class="p">,</span> <span class="n">mm_list</span><span class="p">);</span>
	<span class="n">count_objects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">flushing_list</span><span class="p">,</span> <span class="n">mm_list</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  %u [%u] active objects, %zu [%zu] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">count</span><span class="p">,</span> <span class="n">mappable_count</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mappable_size</span> <span class="o">=</span> <span class="n">mappable_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">count_objects</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_list</span><span class="p">,</span> <span class="n">mm_list</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  %u [%u] inactive objects, %zu [%zu] bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">count</span><span class="p">,</span> <span class="n">mappable_count</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="n">mappable_size</span> <span class="o">=</span> <span class="n">mappable_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">,</span> <span class="n">gtt_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">fault_mappable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">size</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="o">++</span><span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_mappable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mappable_size</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="o">++</span><span class="n">mappable_count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%u pinned mappable objects, %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">mappable_count</span><span class="p">,</span> <span class="n">mappable_size</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%u fault mappable objects, %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">count</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%zu [%zu] gtt total</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_total</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">mappable_gtt_total</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_gtt_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">uintptr_t</span> <span class="n">list</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">info_ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">total_obj_size</span><span class="p">,</span> <span class="n">total_gtt_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">total_obj_size</span> <span class="o">=</span> <span class="n">total_gtt_size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_list</span><span class="p">,</span> <span class="n">gtt_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="n">PINNED_LIST</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">pin_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;   &quot;</span><span class="p">);</span>
		<span class="n">describe_obj</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">total_obj_size</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
		<span class="n">total_gtt_size</span> <span class="o">+=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_space</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Total %d objects, %zu bytes, %zu GTT size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">count</span><span class="p">,</span> <span class="n">total_obj_size</span><span class="p">,</span> <span class="n">total_gtt_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_pageflip_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">pipe_name</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">plane</span> <span class="o">=</span> <span class="n">plane_name</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">plane</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">intel_unpin_work</span> <span class="o">*</span><span class="n">work</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">work</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">unpin_work</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;No flip due on pipe %c (plane %c)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pipe</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Flip queued on pipe %c (plane %c)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">pipe</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Flip pending (waiting for vsync) on pipe %c (plane %c)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">pipe</span><span class="p">,</span> <span class="n">plane</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">enable_stall_check</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Stall check enabled, &quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Stall check waiting for page flip ioctl, &quot;</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d prepares</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">old_fb_obj</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Old framebuffer gtt_offset 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">work</span><span class="o">-&gt;</span><span class="n">pending_flip_obj</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">work</span><span class="o">-&gt;</span><span class="n">pending_flip_obj</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">)</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;New framebuffer gtt_offset 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_request_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_gem_request</span> <span class="o">*</span><span class="n">gem_request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">].</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render requests:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gem_request</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">RCS</span><span class="p">].</span><span class="n">request_list</span><span class="p">,</span>
				    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    %d @ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">gem_request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">gem_request</span><span class="o">-&gt;</span><span class="n">emitted_jiffies</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">VCS</span><span class="p">].</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;BSD requests:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gem_request</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">VCS</span><span class="p">].</span><span class="n">request_list</span><span class="p">,</span>
				    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    %d @ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">gem_request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">gem_request</span><span class="o">-&gt;</span><span class="n">emitted_jiffies</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">BCS</span><span class="p">].</span><span class="n">request_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;BLT requests:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">gem_request</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">BCS</span><span class="p">].</span><span class="n">request_list</span><span class="p">,</span>
				    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;    %d @ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">gem_request</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">gem_request</span><span class="o">-&gt;</span><span class="n">emitted_jiffies</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;No requests</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_ring_seqno_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Current sequence (%s): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">get_seqno</span><span class="p">(</span><span class="n">ring</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_seqno_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I915_NUM_RINGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">i915_ring_seqno_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_interrupt_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pipe</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Display IER:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IER</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Display IIR:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IIR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Display IIR_RW:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IIR_RW</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Display IMR:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_IMR</span><span class="p">));</span>
		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Pipe %c stat:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
				   <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Master IER:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_MASTER_IER</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render IER:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render IIR:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render IMR:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PM IER:</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIER</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PM IIR:</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIIR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PM IMR:</span><span class="se">\t\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PMIMR</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Port hotplug:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">PORT_HOTPLUG_EN</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPFLIPSTAT:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">VLV_DPFLIPSTAT</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPINVGTT:</span><span class="se">\t</span><span class="s">%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DPINVGTT</span><span class="p">));</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Interrupt enable:    %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">IER</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Interrupt identity:  %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">IIR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Interrupt mask:      %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">IMR</span><span class="p">));</span>
		<span class="n">for_each_pipe</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Pipe %c stat:         %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pipe_name</span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span>
				   <span class="n">I915_READ</span><span class="p">(</span><span class="n">PIPESTAT</span><span class="p">(</span><span class="n">pipe</span><span class="p">)));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;North Display Interrupt enable:		%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIER</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;North Display Interrupt identity:	%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIIR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;North Display Interrupt mask:		%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DEIMR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;South Display Interrupt enable:		%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIER</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;South Display Interrupt identity:	%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIIR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;South Display Interrupt mask:		%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">SDEIMR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Graphics Interrupt enable:		%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIER</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Graphics Interrupt identity:		%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIIR</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Graphics Interrupt mask:		%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GTIMR</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Interrupts received: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_received</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I915_NUM_RINGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Graphics Interrupt mask (%s):	%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">I915_READ_IMR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="n">i915_ring_seqno_info</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_fence_regs_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Reserved fences = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_reg_start</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Total fences = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_gem_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_regs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">obj</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Fenced object[%2d] = &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;unused&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">describe_obj</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_hws_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hws</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">info_ent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">];</span>
	<span class="n">hws</span> <span class="o">=</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">page_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hws</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4096</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;0x%08x: 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
			   <span class="n">hws</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hws</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">hws</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">],</span> <span class="n">hws</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ring_str</span><span class="p">(</span><span class="kt">int</span> <span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RCS</span>: <span class="k">return</span> <span class="s">&quot;render&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VCS</span>: <span class="k">return</span> <span class="s">&quot;bsd&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BCS</span>: <span class="k">return</span> <span class="s">&quot;blt&quot;</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pin_flag</span><span class="p">(</span><span class="kt">int</span> <span class="n">pinned</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pinned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot; P&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pinned</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot; p&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">tiling_flag</span><span class="p">(</span><span class="kt">int</span> <span class="n">tiling</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tiling</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="n">I915_TILING_NONE</span>: <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_TILING_X</span>: <span class="k">return</span> <span class="s">&quot; X&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_TILING_Y</span>: <span class="k">return</span> <span class="s">&quot; Y&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dirty_flag</span><span class="p">(</span><span class="kt">int</span> <span class="n">dirty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dirty</span> <span class="o">?</span> <span class="s">&quot; dirty&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">purgeable_flag</span><span class="p">(</span><span class="kt">int</span> <span class="n">purgeable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">purgeable</span> <span class="o">?</span> <span class="s">&quot; purgeable&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_error_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_i915_error_buffer</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s [%d]:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  %08x %8u %04x %04x %08x%s%s%s%s%s%s%s&quot;</span><span class="p">,</span>
			   <span class="n">err</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">,</span>
			   <span class="n">err</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			   <span class="n">err</span><span class="o">-&gt;</span><span class="n">read_domains</span><span class="p">,</span>
			   <span class="n">err</span><span class="o">-&gt;</span><span class="n">write_domain</span><span class="p">,</span>
			   <span class="n">err</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">,</span>
			   <span class="n">pin_flag</span><span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">pinned</span><span class="p">),</span>
			   <span class="n">tiling_flag</span><span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">tiling</span><span class="p">),</span>
			   <span class="n">dirty_flag</span><span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">),</span>
			   <span class="n">purgeable_flag</span><span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">purgeable</span><span class="p">),</span>
			   <span class="n">err</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="n">ring_str</span><span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">),</span>
			   <span class="n">cache_level_str</span><span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">cache_level</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (name: %d)&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="o">-&gt;</span><span class="n">fence_reg</span> <span class="o">!=</span> <span class="n">I915_FENCE_REG_NONE</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (fence: %d)&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">-&gt;</span><span class="n">fence_reg</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_ring_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">ring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ring</span> <span class="o">&gt;=</span> <span class="n">I915_NUM_RINGS</span><span class="p">);</span> <span class="cm">/* shut up confused gcc */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s command stream:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring_str</span><span class="p">(</span><span class="n">ring</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  HEAD: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  TAIL: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  ACTHD: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">acthd</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  IPEIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">ipeir</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  IPEHR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">ipehr</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  INSTDONE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">instdone</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span> <span class="o">==</span> <span class="n">RCS</span> <span class="o">&amp;&amp;</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  INSTDONE1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">instdone1</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  BBADDR: 0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">bbaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  INSTPS: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">instps</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  INSTPM: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">instpm</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  FADDR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">faddr</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  FAULT_REG: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">fault_reg</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  SYNC_0: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">error</span><span class="o">-&gt;</span><span class="n">semaphore_mboxes</span><span class="p">[</span><span class="n">ring</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  SYNC_1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">error</span><span class="o">-&gt;</span><span class="n">semaphore_mboxes</span><span class="p">[</span><span class="n">ring</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  seqno: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  waiting: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yesno</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">[</span><span class="n">ring</span><span class="p">]));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  ring-&gt;head: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">cpu_ring_head</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  ring-&gt;tail: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">cpu_ring_tail</span><span class="p">[</span><span class="n">ring</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">i915_error_state_file_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_error_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i915_error_state_file_priv</span> <span class="o">*</span><span class="n">error_priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_error_state</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">elt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;no error state collected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Time: %ld s %ld us</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span>
		   <span class="n">error</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PCI ID: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_device</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;EIR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">eir</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;IER: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PGTBL_ER: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">pgtbl_er</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  fence[%d] = %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">fence</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ERROR: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DONE_REG: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">done_reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_ring</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">dev_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="n">i915_ring_error_state</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span><span class="p">)</span>
		<span class="n">print_error_buffers</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Active&quot;</span><span class="p">,</span>
				    <span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo</span><span class="p">,</span>
				    <span class="n">error</span><span class="o">-&gt;</span><span class="n">active_bo_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo</span><span class="p">)</span>
		<span class="n">print_error_buffers</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Pinned&quot;</span><span class="p">,</span>
				    <span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo</span><span class="p">,</span>
				    <span class="n">error</span><span class="o">-&gt;</span><span class="n">pinned_bo_count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_i915_error_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">obj</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">batchbuffer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s --- gtt_offset = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">elt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">elt</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">elt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%08x :  %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">][</span><span class="n">elt</span><span class="p">]);</span>
					<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_requests</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s --- %d requests</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_requests</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num_requests</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;  seqno 0x%08x, emitted %ld, tail 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requests</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">seqno</span><span class="p">,</span>
					   <span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requests</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">jiffies</span><span class="p">,</span>
					   <span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">requests</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">tail</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">obj</span> <span class="o">=</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ringbuffer</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s --- ringbuffer = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
				   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">gtt_offset</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">page_count</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">elt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">elt</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">elt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%08x :  %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">offset</span><span class="p">,</span>
						   <span class="n">obj</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">page</span><span class="p">][</span><span class="n">elt</span><span class="p">]);</span>
					<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">)</span>
		<span class="n">intel_overlay_print_error_state</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">overlay</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">)</span>
		<span class="n">intel_display_print_error_state</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">error</span><span class="o">-&gt;</span><span class="n">display</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_error_state_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		       <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span>
		       <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i915_error_state_file_priv</span> <span class="o">*</span><span class="n">error_priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Resetting error state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">i915_destroy_error_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_error_state_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i915_error_state_file_priv</span> <span class="o">*</span><span class="n">error_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">error_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">error_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">first_error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">i915_error_state</span><span class="p">,</span> <span class="n">error_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_error_state_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i915_error_state_file_priv</span> <span class="o">*</span><span class="n">error_priv</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_priv</span><span class="o">-&gt;</span><span class="n">error</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">i915_error_state_free</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">error_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">single_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">i915_error_state_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">i915_error_state_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">i915_error_state_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">i915_error_state_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_rstdby_delays</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">crstanddelay</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">crstanddelay</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">CRSTANDVID</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;w/ctx: %d, w/o ctx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">crstanddelay</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="p">(</span><span class="n">crstanddelay</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_cur_delayinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">rgvswctl</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">MEMSWCTL</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">rgvstat</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">MEMSTAT_ILK</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Requested P-state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rgvswctl</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Requested VID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rgvswctl</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Current VID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rgvstat</span> <span class="o">&amp;</span> <span class="n">MEMSTAT_VID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			   <span class="n">MEMSTAT_VID_SHIFT</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Current P-state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">rgvstat</span> <span class="o">&amp;</span> <span class="n">MEMSTAT_PSTATE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MEMSTAT_PSTATE_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">gt_perf_status</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_GT_PERF_STATUS</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">rp_state_limits</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_STATE_LIMITS</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">rp_state_cap</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_STATE_CAP</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">rpstat</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rpupei</span><span class="p">,</span> <span class="n">rpcurup</span><span class="p">,</span> <span class="n">rpprevup</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rpdownei</span><span class="p">,</span> <span class="n">rpcurdown</span><span class="p">,</span> <span class="n">rpprevdown</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">max_freq</span><span class="p">;</span>

		<span class="cm">/* RPSTAT1 is in the GT power well */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">gen6_gt_force_wake_get</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

		<span class="n">rpstat</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RPSTAT1</span><span class="p">);</span>
		<span class="n">rpupei</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_CUR_UP_EI</span><span class="p">);</span>
		<span class="n">rpcurup</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_CUR_UP</span><span class="p">);</span>
		<span class="n">rpprevup</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_PREV_UP</span><span class="p">);</span>
		<span class="n">rpdownei</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_CUR_DOWN_EI</span><span class="p">);</span>
		<span class="n">rpcurdown</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_CUR_DOWN</span><span class="p">);</span>
		<span class="n">rpprevdown</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_PREV_DOWN</span><span class="p">);</span>

		<span class="n">gen6_gt_force_wake_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GT_PERF_STATUS: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gt_perf_status</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RPSTAT1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpstat</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render p-state ratio: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">gt_perf_status</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render p-state VID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">gt_perf_status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render p-state limit: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rp_state_limits</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;CAGF: %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">rpstat</span> <span class="o">&amp;</span> <span class="n">GEN6_CAGF_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
						<span class="n">GEN6_CAGF_SHIFT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RP CUR UP EI: %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpupei</span> <span class="o">&amp;</span>
			   <span class="n">GEN6_CURICONT_MASK</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RP CUR UP: %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpcurup</span> <span class="o">&amp;</span>
			   <span class="n">GEN6_CURBSYTAVG_MASK</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RP PREV UP: %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpprevup</span> <span class="o">&amp;</span>
			   <span class="n">GEN6_CURBSYTAVG_MASK</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RP CUR DOWN EI: %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpdownei</span> <span class="o">&amp;</span>
			   <span class="n">GEN6_CURIAVG_MASK</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RP CUR DOWN: %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpcurdown</span> <span class="o">&amp;</span>
			   <span class="n">GEN6_CURBSYTAVG_MASK</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RP PREV DOWN: %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rpprevdown</span> <span class="o">&amp;</span>
			   <span class="n">GEN6_CURBSYTAVG_MASK</span><span class="p">);</span>

		<span class="n">max_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp_state_cap</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Lowest (RPN) frequency: %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">max_freq</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>

		<span class="n">max_freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">rp_state_cap</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Nominal (RP1) frequency: %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">max_freq</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>

		<span class="n">max_freq</span> <span class="o">=</span> <span class="n">rp_state_cap</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Max non-overclocked (RP0) frequency: %dMHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">max_freq</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;no P-state info available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_delayfreq_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delayfreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delayfreq</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">PXVFREQ_BASE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;P%02dVIDFREQ: 0x%08x (VID: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">delayfreq</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">delayfreq</span> <span class="o">&amp;</span> <span class="n">PXVFREQ_PX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PXVFREQ_PX_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">MAP_TO_MV</span><span class="p">(</span><span class="kt">int</span> <span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1250</span> <span class="o">-</span> <span class="p">(</span><span class="n">map</span> <span class="o">*</span> <span class="mi">25</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_inttoext_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inttoext</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inttoext</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INTTOEXT_BASE_ILK</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;INTTOEXT%02d: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inttoext</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ironlake_drpc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rgvmodectl</span><span class="p">,</span> <span class="n">rstdbyctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">crstandvid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rgvmodectl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">MEMMODECTL</span><span class="p">);</span>
	<span class="n">rstdbyctl</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RSTDBYCTL</span><span class="p">);</span>
	<span class="n">crstandvid</span> <span class="o">=</span> <span class="n">I915_READ16</span><span class="p">(</span><span class="n">CRSTANDVID</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;HD boost: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_BOOST_EN</span><span class="p">)</span> <span class="o">?</span>
		   <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Boost freq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_BOOST_FREQ_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		   <span class="n">MEMMODE_BOOST_FREQ_SHIFT</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;HW control enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_HWIDLE_EN</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;SW control enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_SWMODE_EN</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Gated voltage change: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_RCLK_GATE</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Starting frequency: P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_FSTART_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MEMMODE_FSTART_SHIFT</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Max P-state: P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_FMAX_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MEMMODE_FMAX_SHIFT</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Min P-state: P%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rgvmodectl</span> <span class="o">&amp;</span> <span class="n">MEMMODE_FMIN_MASK</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RS1 VID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">crstandvid</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RS2 VID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">crstandvid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Render standby enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">rstdbyctl</span> <span class="o">&amp;</span> <span class="n">RCX_SW_EXIT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;no&quot;</span> <span class="o">:</span> <span class="s">&quot;yes&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Current RS state: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rstdbyctl</span> <span class="o">&amp;</span> <span class="n">RSX_STATUS_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RSX_STATUS_ON</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RSX_STATUS_RC1</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RSX_STATUS_RC1E</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC1E</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RSX_STATUS_RS1</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RS1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RSX_STATUS_RS2</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RS2 (RC6)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RSX_STATUS_RS3</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC3 (RC6+)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gen6_drpc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rpmodectl1</span><span class="p">,</span> <span class="n">gt_core_status</span><span class="p">,</span> <span class="n">rcctl1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">forcewake_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_lock</span><span class="p">);</span>
	<span class="n">forcewake_count</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">forcewake_count</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">forcewake_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC information inaccurate because somebody &quot;</span>
			      <span class="s">&quot;holds a forcewake reference </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* NB: we cannot use forcewake, else we read the wrong values */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">I915_READ_NOTRACE</span><span class="p">(</span><span class="n">FORCEWAKE_ACK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC information accurate: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yesno</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">51</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">gt_core_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">GEN6_GT_CORE_STATUS</span><span class="p">);</span>
	<span class="n">trace_i915_reg_rw</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">GEN6_GT_CORE_STATUS</span><span class="p">,</span> <span class="n">gt_core_status</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">rpmodectl1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RP_CONTROL</span><span class="p">);</span>
	<span class="n">rcctl1</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_RC_CONTROL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Video Turbo Mode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">(</span><span class="n">rpmodectl1</span> <span class="o">&amp;</span> <span class="n">GEN6_RP_MEDIA_TURBO</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;HW control enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">(</span><span class="n">rpmodectl1</span> <span class="o">&amp;</span> <span class="n">GEN6_RP_ENABLE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;SW control enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">((</span><span class="n">rpmodectl1</span> <span class="o">&amp;</span> <span class="n">GEN6_RP_MEDIA_MODE_MASK</span><span class="p">)</span> <span class="o">==</span>
			  <span class="n">GEN6_RP_MEDIA_SW_MODE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC1e Enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">(</span><span class="n">rcctl1</span> <span class="o">&amp;</span> <span class="n">GEN6_RC_CTL_RC1e_ENABLE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC6 Enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">(</span><span class="n">rcctl1</span> <span class="o">&amp;</span> <span class="n">GEN6_RC_CTL_RC6_ENABLE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Deep RC6 Enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">(</span><span class="n">rcctl1</span> <span class="o">&amp;</span> <span class="n">GEN6_RC_CTL_RC6p_ENABLE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Deepest RC6 Enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">(</span><span class="n">rcctl1</span> <span class="o">&amp;</span> <span class="n">GEN6_RC_CTL_RC6pp_ENABLE</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Current RC state: &quot;</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">gt_core_status</span> <span class="o">&amp;</span> <span class="n">GEN6_RCn_MASK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">GEN6_RC0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">gt_core_status</span> <span class="o">&amp;</span> <span class="n">GEN6_CORE_CPD_STATE_MASK</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Core Power Down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GEN6_RC3</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GEN6_RC6</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GEN6_RC7</span>:
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC7</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Core Power Down: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yesno</span><span class="p">(</span><span class="n">gt_core_status</span> <span class="o">&amp;</span> <span class="n">GEN6_CORE_CPD_STATE_MASK</span><span class="p">));</span>

	<span class="cm">/* Not exactly sure what this is */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC6 </span><span class="se">\&quot;</span><span class="s">Locked to RPn</span><span class="se">\&quot;</span><span class="s"> residency since boot: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_GT_GFX_RC6_LOCKED</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC6 residency since boot: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_GT_GFX_RC6</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC6+ residency since boot: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_GT_GFX_RC6p</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;RC6++ residency since boot: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_GT_GFX_RC6pp</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_drpc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">gen6_drpc_info</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">ironlake_drpc_info</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_fbc_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I915_HAS_FBC</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;FBC unsupported on this chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_fbc_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;FBC enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;FBC disabled: &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">no_fbc_reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FBC_NO_OUTPUT</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;no outputs&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBC_STOLEN_TOO_SMALL</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;not enough stolen memory&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBC_UNSUPPORTED_MODE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;mode not supported&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBC_MODE_TOO_LARGE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;mode too large&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBC_BAD_PLANE</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;FBC unsupported on plane&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBC_NOT_TILED</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;scanout buffer not tiled&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBC_MULTIPLE_PIPES</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;multiple pipes are enabled&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FBC_MODULE_PARAM</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;disabled per module param (default off)&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;unknown reason&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_sr_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sr_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HAS_PCH_SPLIT</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">sr_enabled</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">WM1_LP_ILK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WM1_LP_SR_EN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">sr_enabled</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">FW_BLC_SELF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FW_BLC_SELF_EN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">sr_enabled</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">INSTPM</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">INSTPM_SELF_EN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_PINEVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">sr_enabled</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DSPFW3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PINEVIEW_SELF_REFRESH_EN</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;self-refresh: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sr_enabled</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_emon_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">temp</span><span class="p">,</span> <span class="n">chipset</span><span class="p">,</span> <span class="n">gfx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">i915_mch_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">chipset</span> <span class="o">=</span> <span class="n">i915_chipset_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">gfx</span> <span class="o">=</span> <span class="n">i915_gfx_val</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GMCH temp: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Chipset power: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chipset</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GFX power: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gfx</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Total power: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chipset</span> <span class="o">+</span> <span class="n">gfx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_ring_freq_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpu_freq</span><span class="p">,</span> <span class="n">ia_freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;unsupported on this chipset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GPU freq (MHz)</span><span class="se">\t</span><span class="s">Effective CPU freq (MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">gpu_freq</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">min_delay</span><span class="p">;</span> <span class="n">gpu_freq</span> <span class="o">&lt;=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span><span class="p">;</span>
	     <span class="n">gpu_freq</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PCODE_DATA</span><span class="p">,</span> <span class="n">gpu_freq</span><span class="p">);</span>
		<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">,</span> <span class="n">GEN6_PCODE_READY</span> <span class="o">|</span>
			   <span class="n">GEN6_PCODE_READ_MIN_FREQ_TABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">((</span><span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_MAILBOX</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="n">GEN6_PCODE_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;pcode read of freq table timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ia_freq</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_PCODE_DATA</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gpu_freq</span> <span class="o">*</span> <span class="mi">50</span><span class="p">,</span> <span class="n">ia_freq</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gfxec</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GFXEC: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">I915_READ</span><span class="p">(</span><span class="mh">0x112f4</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_opregion</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_opregion</span> <span class="o">*</span><span class="n">opregion</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">opregion</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">OPREGION_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opregion</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">opregion</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span> <span class="n">OPREGION_SIZE</span><span class="p">);</span>
		<span class="n">seq_write</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">OPREGION_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gem_framebuffer_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_fbdev</span> <span class="o">*</span><span class="n">ifbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ifbdev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">to_intel_framebuffer</span><span class="p">(</span><span class="n">ifbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fb</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;fbcon size: %d x %d, depth %d, %d bpp, obj &quot;</span><span class="p">,</span>
		   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
		   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">depth</span><span class="p">,</span>
		   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">describe_obj</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">fb_list</span><span class="p">,</span> <span class="n">base</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="n">ifbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;user size: %d x %d, depth %d, %d bpp, obj &quot;</span><span class="p">,</span>
			   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">depth</span><span class="p">,</span>
			   <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="n">describe_obj</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_context_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;power context &quot;</span><span class="p">);</span>
		<span class="n">describe_obj</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">pwrctx</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;render context &quot;</span><span class="p">);</span>
		<span class="n">describe_obj</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">renderctx</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_gen6_forcewake_count_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">forcewake_count</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_lock</span><span class="p">);</span>
	<span class="n">forcewake_count</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">forcewake_count</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_lock</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;forcewake count = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">forcewake_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">swizzle_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">swizzle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">swizzle</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_NONE</span>:
		<span class="k">return</span> <span class="s">&quot;none&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_9</span>:
		<span class="k">return</span> <span class="s">&quot;bit9&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_9_10</span>:
		<span class="k">return</span> <span class="s">&quot;bit9/bit10&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_9_11</span>:
		<span class="k">return</span> <span class="s">&quot;bit9/bit11&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_9_10_11</span>:
		<span class="k">return</span> <span class="s">&quot;bit9/bit10/bit11&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_9_17</span>:
		<span class="k">return</span> <span class="s">&quot;bit9/bit17&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_9_10_17</span>:
		<span class="k">return</span> <span class="s">&quot;bit9/bit10/bit17&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_BIT_6_SWIZZLE_UNKNOWN</span>:
		<span class="k">return</span> <span class="s">&quot;unkown&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;bug&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_swizzle_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;bit6 swizzle for X-tiling = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">swizzle_string</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">bit_6_swizzle_x</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;bit6 swizzle for Y-tiling = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">swizzle_string</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">bit_6_swizzle_y</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN3</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN4</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DDC = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DCC</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;C0DRB3 = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ16</span><span class="p">(</span><span class="n">C0DRB3</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;C1DRB3 = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ16</span><span class="p">(</span><span class="n">C1DRB3</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN6</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN7</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;MAD_DIMM_C0 = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">MAD_DIMM_C0</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;MAD_DIMM_C1 = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">MAD_DIMM_C1</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;MAD_DIMM_C2 = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">MAD_DIMM_C2</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;TILECTL = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">TILECTL</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ARB_MODE = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">ARB_MODE</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DISP_ARB_CTL = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">I915_READ</span><span class="p">(</span><span class="n">DISP_ARB_CTL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_ppgtt_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GFX_MODE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GFX_MODE</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I915_NUM_RINGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GFX_MODE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_MODE_GEN7</span><span class="p">(</span><span class="n">ring</span><span class="p">)));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PP_DIR_BASE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_PP_DIR_BASE</span><span class="p">(</span><span class="n">ring</span><span class="p">)));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PP_DIR_BASE_READ: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_PP_DIR_BASE_READ</span><span class="p">(</span><span class="n">ring</span><span class="p">)));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;PP_DIR_DCLV: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">RING_PP_DIR_DCLV</span><span class="p">(</span><span class="n">ring</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i915_hw_ppgtt</span> <span class="o">*</span><span class="n">ppgtt</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;aliasing PPGTT:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;pd gtt offset: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ppgtt</span><span class="o">-&gt;</span><span class="n">pd_offset</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;ECOCHK: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GAM_ECOCHK</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_dpio_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_VALLEYVIEW</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_CTL: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">DPIO_CTL</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_DIV_A: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_DIV_A</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_DIV_B: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_DIV_B</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_REFSFR_A: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_REFSFR_A</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_REFSFR_B: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_REFSFR_B</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_CORE_CLK_A: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_CORE_CLK_A</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_CORE_CLK_B: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_CORE_CLK_B</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_LFP_COEFF_A: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_LFP_COEFF_A</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_LFP_COEFF_B: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">_DPIO_LFP_COEFF_B</span><span class="p">));</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DPIO_FASTCLK_DISABLE: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">intel_dpio_read</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">DPIO_FASTCLK_DISABLE</span><span class="p">));</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_wedged_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		 <span class="kt">size_t</span> <span class="n">max</span><span class="p">,</span>
		 <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
		       <span class="s">&quot;wedged :  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">wedged</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_wedged_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span>
		  <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;Manually setting wedged to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">i915_handle_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">i915_wedged_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">i915_wedged_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">i915_wedged_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_ring_stop_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">max</span><span class="p">,</span>
		    <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
		       <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stop_rings</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_ring_stop_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		     <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span>
		     <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Stopping rings 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">stop_rings</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">i915_ring_stop_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">i915_ring_stop_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">i915_ring_stop_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_max_freq_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="n">max</span><span class="p">,</span>
		   <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
		       <span class="s">&quot;max freq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_max_freq_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span>
		  <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Manually setting max freq to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Turbo will still be enabled, but won&#39;t go above the set value.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">max_delay</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span>

	<span class="n">gen6_set_rps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">50</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">i915_max_freq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">i915_max_freq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">i915_max_freq_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_cache_sharing_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		   <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="n">max</span><span class="p">,</span>
		   <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">snpcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">snpcr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_MBCUNIT_SNPCR</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
		       <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">snpcr</span> <span class="o">&amp;</span> <span class="n">GEN6_MBC_SNPCR_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		       <span class="n">GEN6_MBC_SNPCR_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">i915_cache_sharing_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">,</span>
		  <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">snpcr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Manually setting uncore sharing to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* Update the cache sharing policy here as well */</span>
	<span class="n">snpcr</span> <span class="o">=</span> <span class="n">I915_READ</span><span class="p">(</span><span class="n">GEN6_MBCUNIT_SNPCR</span><span class="p">);</span>
	<span class="n">snpcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GEN6_MBC_SNPCR_MASK</span><span class="p">;</span>
	<span class="n">snpcr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">GEN6_MBC_SNPCR_SHIFT</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">GEN6_MBCUNIT_SNPCR</span><span class="p">,</span> <span class="n">snpcr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">i915_cache_sharing_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">i915_cache_sharing_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">i915_cache_sharing_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* As the drm_debugfs_init() routines are called before dev-&gt;dev_private is</span>
<span class="cm"> * allocated we need to hook into the minor for release. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">drm_add_fake_info_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_minor</span> <span class="o">*</span><span class="n">minor</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_info_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>

	<span class="n">node</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_info_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">node</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">dent</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>
	<span class="n">node</span><span class="o">-&gt;</span><span class="n">info_ent</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_forcewake_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">gen6_gt_force_wake_get</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_forcewake_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s bad that we can potentially hang userspace if struct_mutex gets</span>
<span class="cm">	 * forever stuck.  However, if we cannot acquire this lock it means that</span>
<span class="cm">	 * almost certainly the driver has hung, is not unload-able. Therefore</span>
<span class="cm">	 * hanging here is probably a minor inconvenience not to be seen my</span>
<span class="cm">	 * almost every user.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">gen6_gt_force_wake_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">i915_forcewake_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">i915_forcewake_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">i915_forcewake_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_forcewake_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_minor</span> <span class="o">*</span><span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;i915_forcewake_user&quot;</span><span class="p">,</span>
				  <span class="n">S_IRUSR</span><span class="p">,</span>
				  <span class="n">root</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">i915_forcewake_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drm_add_fake_info_node</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i915_forcewake_fops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_debugfs_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_minor</span> <span class="o">*</span><span class="n">minor</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
				  <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				  <span class="n">root</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				  <span class="n">fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">drm_add_fake_info_node</span><span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">ent</span><span class="p">,</span> <span class="n">fops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_info_list</span> <span class="n">i915_debugfs_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;i915_capabilities&quot;</span><span class="p">,</span> <span class="n">i915_capabilities</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_objects&quot;</span><span class="p">,</span> <span class="n">i915_gem_object_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_gtt&quot;</span><span class="p">,</span> <span class="n">i915_gem_gtt_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_pinned&quot;</span><span class="p">,</span> <span class="n">i915_gem_gtt_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">PINNED_LIST</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_active&quot;</span><span class="p">,</span> <span class="n">i915_gem_object_list_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">ACTIVE_LIST</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_flushing&quot;</span><span class="p">,</span> <span class="n">i915_gem_object_list_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">FLUSHING_LIST</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_inactive&quot;</span><span class="p">,</span> <span class="n">i915_gem_object_list_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">INACTIVE_LIST</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_pageflip&quot;</span><span class="p">,</span> <span class="n">i915_gem_pageflip_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_request&quot;</span><span class="p">,</span> <span class="n">i915_gem_request_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_seqno&quot;</span><span class="p">,</span> <span class="n">i915_gem_seqno_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_fence_regs&quot;</span><span class="p">,</span> <span class="n">i915_gem_fence_regs_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_interrupt&quot;</span><span class="p">,</span> <span class="n">i915_interrupt_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_hws&quot;</span><span class="p">,</span> <span class="n">i915_hws_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">RCS</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_hws_blt&quot;</span><span class="p">,</span> <span class="n">i915_hws_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">BCS</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_hws_bsd&quot;</span><span class="p">,</span> <span class="n">i915_hws_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">VCS</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_rstdby_delays&quot;</span><span class="p">,</span> <span class="n">i915_rstdby_delays</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_cur_delayinfo&quot;</span><span class="p">,</span> <span class="n">i915_cur_delayinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_delayfreq_table&quot;</span><span class="p">,</span> <span class="n">i915_delayfreq_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_inttoext_table&quot;</span><span class="p">,</span> <span class="n">i915_inttoext_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_drpc_info&quot;</span><span class="p">,</span> <span class="n">i915_drpc_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_emon_status&quot;</span><span class="p">,</span> <span class="n">i915_emon_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_ring_freq_table&quot;</span><span class="p">,</span> <span class="n">i915_ring_freq_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gfxec&quot;</span><span class="p">,</span> <span class="n">i915_gfxec</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_fbc_status&quot;</span><span class="p">,</span> <span class="n">i915_fbc_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_sr_status&quot;</span><span class="p">,</span> <span class="n">i915_sr_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_opregion&quot;</span><span class="p">,</span> <span class="n">i915_opregion</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gem_framebuffer&quot;</span><span class="p">,</span> <span class="n">i915_gem_framebuffer_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_context_status&quot;</span><span class="p">,</span> <span class="n">i915_context_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_gen6_forcewake_count&quot;</span><span class="p">,</span> <span class="n">i915_gen6_forcewake_count_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_swizzle_info&quot;</span><span class="p">,</span> <span class="n">i915_swizzle_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_ppgtt_info&quot;</span><span class="p">,</span> <span class="n">i915_ppgtt_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;i915_dpio&quot;</span><span class="p">,</span> <span class="n">i915_dpio_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>
<span class="cp">#define I915_DEBUGFS_ENTRIES ARRAY_SIZE(i915_debugfs_list)</span>

<span class="kt">int</span> <span class="nf">i915_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_minor</span> <span class="o">*</span><span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_debugfs_create</span><span class="p">(</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
				  <span class="s">&quot;i915_wedged&quot;</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">i915_wedged_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_forcewake_create</span><span class="p">(</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_debugfs_create</span><span class="p">(</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
				  <span class="s">&quot;i915_max_freq&quot;</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">i915_max_freq_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_debugfs_create</span><span class="p">(</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
				  <span class="s">&quot;i915_cache_sharing&quot;</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">i915_cache_sharing_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_debugfs_create</span><span class="p">(</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
				  <span class="s">&quot;i915_ring_stop&quot;</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">i915_ring_stop_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_debugfs_create</span><span class="p">(</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span>
				  <span class="s">&quot;i915_error_state&quot;</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">i915_error_state_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">drm_debugfs_create_files</span><span class="p">(</span><span class="n">i915_debugfs_list</span><span class="p">,</span>
					<span class="n">I915_DEBUGFS_ENTRIES</span><span class="p">,</span>
					<span class="n">minor</span><span class="o">-&gt;</span><span class="n">debugfs_root</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_minor</span> <span class="o">*</span><span class="n">minor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_debugfs_remove_files</span><span class="p">(</span><span class="n">i915_debugfs_list</span><span class="p">,</span>
				 <span class="n">I915_DEBUGFS_ENTRIES</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="n">drm_debugfs_remove_files</span><span class="p">((</span><span class="k">struct</span> <span class="n">drm_info_list</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i915_forcewake_fops</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="n">drm_debugfs_remove_files</span><span class="p">((</span><span class="k">struct</span> <span class="n">drm_info_list</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i915_wedged_fops</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="n">drm_debugfs_remove_files</span><span class="p">((</span><span class="k">struct</span> <span class="n">drm_info_list</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i915_max_freq_fops</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="n">drm_debugfs_remove_files</span><span class="p">((</span><span class="k">struct</span> <span class="n">drm_info_list</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i915_cache_sharing_fops</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="n">drm_debugfs_remove_files</span><span class="p">((</span><span class="k">struct</span> <span class="n">drm_info_list</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i915_ring_stop_fops</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
	<span class="n">drm_debugfs_remove_files</span><span class="p">((</span><span class="k">struct</span> <span class="n">drm_info_list</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i915_error_state_fops</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
