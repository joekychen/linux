<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › i915 › i915_dma.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>i915_dma.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* i915_dma.c -- DMA support for the I915 -*- linux-c -*-</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright 2003 Tungsten Graphics, Inc., Cedar Park, Texas.</span>
<span class="cm"> * All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission is hereby granted, free of charge, to any person obtaining a</span>
<span class="cm"> * copy of this software and associated documentation files (the</span>
<span class="cm"> * &quot;Software&quot;), to deal in the Software without restriction, including</span>
<span class="cm"> * without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="cm"> * distribute, sub license, and/or sell copies of the Software, and to</span>
<span class="cm"> * permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> * the following conditions:</span>
<span class="cm"> *</span>
<span class="cm"> * The above copyright notice and this permission notice (including the</span>
<span class="cm"> * next paragraph) shall be included in all copies or substantial portions</span>
<span class="cm"> * of the Software.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS</span>
<span class="cm"> * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT.</span>
<span class="cm"> * IN NO EVENT SHALL TUNGSTEN GRAPHICS AND/OR ITS SUPPLIERS BE LIABLE FOR</span>
<span class="cm"> * ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span>
<span class="cm"> * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>
<span class="cm"> * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>
<span class="cp">#include &quot;drm_fb_helper.h&quot;</span>
<span class="cp">#include &quot;intel_drv.h&quot;</span>
<span class="cp">#include &quot;i915_drm.h&quot;</span>
<span class="cp">#include &quot;i915_drv.h&quot;</span>
<span class="cp">#include &quot;i915_trace.h&quot;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/vgaarb.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/vga_switcheroo.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;acpi/video.h&gt;</span>
<span class="cp">#include &lt;asm/pat.h&gt;</span>

<span class="cp">#define LP_RING(d) (&amp;((struct drm_i915_private *)(d))-&gt;ring[RCS])</span>

<span class="cp">#define BEGIN_LP_RING(n) \</span>
<span class="cp">	intel_ring_begin(LP_RING(dev_priv), (n))</span>

<span class="cp">#define OUT_RING(x) \</span>
<span class="cp">	intel_ring_emit(LP_RING(dev_priv), x)</span>

<span class="cp">#define ADVANCE_LP_RING() \</span>
<span class="cp">	intel_ring_advance(LP_RING(dev_priv))</span>

<span class="cm">/**</span>
<span class="cm"> * Lock test for when it&#39;s just for synchronization of ring access.</span>
<span class="cm"> *</span>
<span class="cm"> * In that case, we don&#39;t need to do it when GEM is initialized as nobody else</span>
<span class="cm"> * has access to the ring.</span>
<span class="cm"> */</span>
<span class="cp">#define RING_LOCK_TEST_WITH_RETURN(dev, file) do {			\</span>
<span class="cp">	if (LP_RING(dev-&gt;dev_private)-&gt;obj == NULL)			\</span>
<span class="cp">		LOCK_TEST_WITH_RETURN(dev, file);			\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">intel_read_legacy_status_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I915_NEED_GFX_HWS</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">gfx_hws_cpu_addr</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">intel_read_status_page</span><span class="p">(</span><span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define READ_HWSP(dev_priv, reg) intel_read_legacy_status_page(dev_priv, reg)</span>
<span class="cp">#define READ_BREADCRUMB(dev_priv) READ_HWSP(dev_priv, I915_BREADCRUMB_INDEX)</span>
<span class="cp">#define I915_BREADCRUMB_INDEX		0x21</span>

<span class="kt">void</span> <span class="nf">i915_update_dri1_breadcrumb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
			<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_dispatch</span> <span class="o">=</span>
				<span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_write_hws_pga</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWS_PGA</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sets up the hardware status page for devices that need a physical address</span>
<span class="cm"> * in the register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_init_phys_hws</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* Program Hardware Status Page */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span> <span class="o">=</span>
		<span class="n">drm_pci_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Can not allocate hardware status page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset_io</span><span class="p">((</span><span class="kt">void</span> <span class="n">__force</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">,</span>
		  <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">i915_write_hws_pga</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Enabled hardware status page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Frees the hardware status page, whether it&#39;s a physical address or a virtual</span>
<span class="cm"> * address set up by the X Server.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_free_hws</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_pci_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">status_page_dmah</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">gfx_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">gfx_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">gfx_hws_cpu_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Need to rewrite hardware status page */</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWS_PGA</span><span class="p">,</span> <span class="mh">0x1ffff000</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_kernel_lost_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should never lose context on the ring with modesetting</span>
<span class="cm">	 * as we don&#39;t expose it to userspace</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">I915_READ_HEAD</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HEAD_ADDR</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">I915_READ_TAIL</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TAIL_ADDR</span><span class="p">;</span>
	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">-</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">space</span> <span class="o">+=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&amp;&amp;</span> <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">perf_boxes</span> <span class="o">|=</span> <span class="n">I915_BOX_RING_EMPTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_dma_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Make sure interrupts are disabled here because the uninstall ioctl</span>
<span class="cm">	 * may not have been called from userspace and after dev_private</span>
<span class="cm">	 * is freed, it&#39;s too late.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_enabled</span><span class="p">)</span>
		<span class="n">drm_irq_uninstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">I915_NUM_RINGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">intel_cleanup_ring_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* Clear the HWS virtual address at teardown */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I915_NEED_GFX_HWS</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">i915_free_hws</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">drm_i915_init_t</span> <span class="o">*</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span> <span class="o">=</span> <span class="n">drm_getsarea</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_sarea_t</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">+</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">sarea_priv_offset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;sarea not found assuming DRI2 userspace</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i915_dma_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Client tried to initialize ringbuffer in &quot;</span>
				  <span class="s">&quot;GEM mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_render_ring_init_dri</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_start</span><span class="p">,</span>
						 <span class="n">init</span><span class="o">-&gt;</span><span class="n">ring_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i915_dma_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">cpp</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">cpp</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span> <span class="o">=</span> <span class="n">init</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pf_current_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allow hardware batchbuffers unless told otherwise.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">allow_batchbuffer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_dma_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">virtual_start</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;can not ioremap virtual address for&quot;</span>
			  <span class="s">&quot; ring buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Program Hardware Status Page */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">page_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Can not find hardware status page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;hw status page @ %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">page_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">gfx_addr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">intel_ring_setup_status_page</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">i915_write_hws_pga</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Enabled hardware status page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_dma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_init_t</span> <span class="o">*</span><span class="n">init</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">init</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_INIT_DMA</span>:
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">i915_initialize</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_CLEANUP_DMA</span>:
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">i915_dma_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_RESUME_DMA</span>:
		<span class="n">retcode</span> <span class="o">=</span> <span class="n">i915_dma_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">retcode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retcode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Implement basically the same security restrictions as hardware does</span>
<span class="cm"> * for MI_BATCH_NON_SECURE.  These can be made stricter at any time.</span>
<span class="cm"> *</span>
<span class="cm"> * Most of the calculations below involve calculating the size of a</span>
<span class="cm"> * particular instruction.  It&#39;s important to get the size right as</span>
<span class="cm"> * that tells us where the next instruction to check is.  Any illegal</span>
<span class="cm"> * instruction detected will be given a size of zero, which is a</span>
<span class="cm"> * signal to abort the rest of the buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_cmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x0</span>:
		<span class="k">switch</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* MI_NOOP */</span>
		<span class="k">case</span> <span class="mh">0x4</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* MI_FLUSH */</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* disallow everything else */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* reserved */</span>
	<span class="k">case</span> <span class="mh">0x2</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* 2d commands */</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x18</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1c</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1d</span>:
			<span class="k">switch</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x3</span>:
				<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x4</span>:
				<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="mh">0x1e</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1f</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* inline vertices */</span>
				<span class="k">return</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x1ffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">))</span>	<span class="cm">/* indirect random */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* unknown length, too hard */</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* indirect sequential */</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_emit_cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dwords</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dwords</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwords</span><span class="p">;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">validate_cmd</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">+</span> <span class="n">sz</span> <span class="o">&gt;</span> <span class="n">dwords</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">sz</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">BEGIN_LP_RING</span><span class="p">((</span><span class="n">dwords</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;~</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dwords</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwords</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">i915_emit_box</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">box</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="n">DR1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DR4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">&lt;=</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">||</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">&lt;=</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">||</span>
	    <span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Bad box %d,%d..%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">,</span> <span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">GFX_OP_DRAWRECT_INFO_I965</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">DR4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">GFX_OP_DRAWRECT_INFO</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">DR1</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">x2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">box</span><span class="o">-&gt;</span><span class="n">y2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">DR4</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* XXX: Emitting the counter should really be moved to part of the IRQ</span>
<span class="cm"> * emit. For now, do it in both places:</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_emit_breadcrumb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFFUL</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_enqueue</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_STORE_DWORD_INDEX</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">I915_BREADCRUMB_INDEX</span> <span class="o">&lt;&lt;</span> <span class="n">MI_STORE_DWORD_INDEX_SHIFT</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_dispatch_cmdbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				   <span class="n">drm_i915_cmdbuffer_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">cliprects</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">cmdbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sz</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;alignment&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_kernel_lost_context</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">nbox</span> <span class="o">?</span> <span class="n">nbox</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_emit_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cliprects</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					    <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">DR1</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">DR4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_emit_cmds</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sz</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_emit_breadcrumb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_dispatch_batchbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
				     <span class="n">drm_i915_batchbuffer_t</span> <span class="o">*</span> <span class="n">batch</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">cliprects</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbox</span> <span class="o">=</span> <span class="n">batch</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">|</span> <span class="n">batch</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;alignment&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_kernel_lost_context</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">nbox</span> <span class="o">?</span> <span class="n">nbox</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbox</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_emit_box</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cliprects</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					    <span class="n">batch</span><span class="o">-&gt;</span><span class="n">DR1</span><span class="p">,</span> <span class="n">batch</span><span class="o">-&gt;</span><span class="n">DR4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_I830</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_845G</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_BATCH_BUFFER_START</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="n">MI_BATCH_NON_SECURE_I965</span><span class="p">);</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_BATCH_BUFFER_START</span> <span class="o">|</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
				<span class="n">OUT_RING</span><span class="p">(</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">|</span> <span class="n">MI_BATCH_NON_SECURE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_BATCH_BUFFER</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">|</span> <span class="n">MI_BATCH_NON_SECURE</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">batch</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">IS_G4X</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_FLUSH</span> <span class="o">|</span> <span class="n">MI_NO_WRITE_FLUSH</span> <span class="o">|</span> <span class="n">MI_INVALIDATE_ISP</span><span class="p">);</span>
			<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_NOOP</span><span class="p">);</span>
			<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i915_emit_breadcrumb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_dispatch_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;%s: page=%d pfCurrentPage=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">current_page</span><span class="p">,</span>
			 <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pf_current_page</span><span class="p">);</span>

	<span class="n">i915_kernel_lost_context</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_FLUSH</span> <span class="o">|</span> <span class="n">MI_READ_FLUSH</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">CMD_OP_DISPLAYBUFFER_INFO</span> <span class="o">|</span> <span class="n">ASYNC_FLIP</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">back_offset</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">front_offset</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">current_page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_WAIT_FOR_EVENT</span> <span class="o">|</span> <span class="n">MI_WAIT_FOR_PLANE_A_FLIP</span><span class="p">);</span>
	<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>

	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_enqueue</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_STORE_DWORD_INDEX</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">I915_BREADCRUMB_INDEX</span> <span class="o">&lt;&lt;</span> <span class="n">MI_STORE_DWORD_INDEX_SHIFT</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">pf_current_page</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">current_page</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_quiescent</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">LP_RING</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">);</span>

	<span class="n">i915_kernel_lost_context</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">intel_wait_ring_idle</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_flush_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">RING_LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_quiescent</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_batchbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_i915_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_sarea_t</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_i915_batchbuffer_t</span> <span class="o">*</span><span class="n">batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">cliprects</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">allow_batchbuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Batchbuffer ioctl disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;i915 batchbuffer, start %x used %d cliprects %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">batch</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">batch</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="n">batch</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">);</span>

	<span class="n">RING_LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">num_cliprects</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cliprects</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">batch</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_clip_rect</span><span class="p">),</span>
				    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cliprects</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">cliprects</span><span class="p">,</span> <span class="n">batch</span><span class="o">-&gt;</span><span class="n">cliprects</span><span class="p">,</span>
				     <span class="n">batch</span><span class="o">-&gt;</span><span class="n">num_cliprects</span> <span class="o">*</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_clip_rect</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_dispatch_batchbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">cliprects</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_dispatch</span> <span class="o">=</span> <span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

<span class="nl">fail_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cliprects</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_cmdbuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="n">drm_i915_sarea_t</span> <span class="o">*</span><span class="n">sarea_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_sarea_t</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">;</span>
	<span class="n">drm_i915_cmdbuffer_t</span> <span class="o">*</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">cliprects</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">batch_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;i915 cmdbuffer, buf %p sz %d cliprects %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">sz</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">RING_LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">num_cliprects</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">batch_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">batch_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_batch_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cliprects</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">num_cliprects</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_clip_rect</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cliprects</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_batch_free</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">cliprects</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">cliprects</span><span class="p">,</span>
				     <span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">num_cliprects</span> <span class="o">*</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_clip_rect</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_clip_free</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_dispatch_cmdbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmdbuf</span><span class="p">,</span> <span class="n">cliprects</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;i915_dispatch_cmdbuffer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_clip_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_dispatch</span> <span class="o">=</span> <span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

<span class="nl">fail_clip_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cliprects</span><span class="p">);</span>
<span class="nl">fail_batch_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">batch_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_emit_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">i915_kernel_lost_context</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mh">0x7FFFFFFFUL</span><span class="p">)</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_enqueue</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">BEGIN_LP_RING</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_STORE_DWORD_INDEX</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">I915_BREADCRUMB_INDEX</span> <span class="o">&lt;&lt;</span> <span class="n">MI_STORE_DWORD_INDEX_SHIFT</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">);</span>
		<span class="n">OUT_RING</span><span class="p">(</span><span class="n">MI_USER_INTERRUPT</span><span class="p">);</span>
		<span class="n">ADVANCE_LP_RING</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_wait_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="p">(</span><span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">primary</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;irq_nr=%d breadcrumb=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_nr</span><span class="p">,</span>
		  <span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">irq_nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
			<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">last_dispatch</span> <span class="o">=</span> <span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="p">)</span>
		<span class="n">master_priv</span><span class="o">-&gt;</span><span class="n">sarea_priv</span><span class="o">-&gt;</span><span class="n">perf_boxes</span> <span class="o">|=</span> <span class="n">I915_BOX_WAIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_get</span><span class="p">(</span><span class="n">ring</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_WAIT_ON</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_queue</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">DRM_HZ</span><span class="p">,</span>
			    <span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">irq_nr</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">irq_put</span><span class="p">(</span><span class="n">ring</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wait_for</span><span class="p">(</span><span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">irq_nr</span><span class="p">,</span> <span class="mi">3000</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;EBUSY -- rec: %d emitted: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Needs the lock as it touches the ring.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_irq_emit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_i915_irq_emit_t</span> <span class="o">*</span><span class="n">emit</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span> <span class="o">||</span> <span class="o">!</span><span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">virtual_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RING_LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i915_emit_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="n">emit</span><span class="o">-&gt;</span><span class="n">irq_seq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;copy_to_user</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Doesn&#39;t need the hardware lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_irq_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_i915_irq_wait_t</span> <span class="o">*</span><span class="n">irqwait</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i915_wait_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">irqwait</span><span class="o">-&gt;</span><span class="n">irq_seq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_vblank_pipe_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_i915_vblank_pipe_t</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">DRM_I915_VBLANK_PIPE_A</span> <span class="o">|</span> <span class="n">DRM_I915_VBLANK_PIPE_B</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Schedule buffer swap at given vertical blank.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_vblank_swap</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The delayed swap mechanism was fundamentally racy, and has been</span>
<span class="cm">	 * removed.  The model was that the client requested a delayed flip/swap</span>
<span class="cm">	 * from the kernel, then waited for vblank before continuing to perform</span>
<span class="cm">	 * rendering.  The problem was that the kernel might wake the client</span>
<span class="cm">	 * up before it dispatched the vblank swap (since the lock has to be</span>
<span class="cm">	 * held while touching the ringbuffer), in which case the client would</span>
<span class="cm">	 * clear and start the next frame before the swap occurred, and</span>
<span class="cm">	 * flicker would occur in addition to likely missing the vblank.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In the absence of this ioctl, userland falls back to a correct path</span>
<span class="cm">	 * of waiting for a vblank, then dispatching the swap on its own.</span>
<span class="cm">	 * Context switching to userland and back is plenty fast enough for</span>
<span class="cm">	 * meeting the requirements of vblank swapping.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_flip_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">RING_LOCK_TEST_WITH_RETURN</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_dispatch_flip</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_getparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_i915_getparam_t</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_PARAM_IRQ_ACTIVE</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_ALLOW_BATCHBUFFER</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">allow_batchbuffer</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_LAST_DISPATCH</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">READ_BREADCRUMB</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_CHIPSET_ID</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_device</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_GEM</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_NUM_FENCES_AVAIL</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span> <span class="o">-</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_reg_start</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_OVERLAY</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">overlay</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_PAGEFLIPPING</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_EXECBUF2</span>:
		<span class="cm">/* depends on GEM */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_BSD</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">intel_ring_initialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">VCS</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_BLT</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">intel_ring_initialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">BCS</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_RELAXED_FENCING</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_COHERENT_RINGS</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_EXEC_CONSTANTS</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_RELAXED_DELTA</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_GEN7_SOL_RESET</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_LLC</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">HAS_LLC</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_PARAM_HAS_ALIASING_PPGTT</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">aliasing_ppgtt</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;Unknown parameter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DRM_COPY_TO_USER</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;DRM_COPY_TO_USER failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_setparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_i915_setparam_t</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I915_SETPARAM_USE_MI_BATCHBUFFER_START</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_SETPARAM_TEX_LRU_LOG_GRANULARITY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_SETPARAM_ALLOW_BATCHBUFFER</span>:
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">allow_batchbuffer</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I915_SETPARAM_NUM_USED_FENCES</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_fence_regs</span> <span class="o">||</span>
		    <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Userspace can use first N regs */</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">fence_reg_start</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;unknown parameter %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">param</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_set_status_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">drm_i915_hws_addr_t</span> <span class="o">*</span><span class="n">hws</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_ring_buffer</span> <span class="o">*</span><span class="n">ring</span> <span class="o">=</span> <span class="n">LP_RING</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I915_NEED_GFX_HWS</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;called with no initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;tried to set status page when mode setting active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;set status page addr 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">hws</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">gfx_addr</span> <span class="o">=</span> <span class="n">hws</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1ffff</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">gfx_hws_cpu_addr</span> <span class="o">=</span> <span class="n">ioremap_wc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">hws</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
						     <span class="mi">4096</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">gfx_hws_cpu_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i915_dma_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">gfx_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;can not ioremap virtual address for&quot;</span>
				<span class="s">&quot; G33 hw status page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset_io</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dri1</span><span class="p">.</span><span class="n">gfx_hws_cpu_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">I915_WRITE</span><span class="p">(</span><span class="n">HWS_PGA</span><span class="p">,</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">gfx_addr</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;load hws HWS_PGA with gfx mem 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">gfx_addr</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;load hws at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">status_page</span><span class="p">.</span><span class="n">page_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_get_bridge_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span> <span class="o">=</span> <span class="n">pci_get_bus_and_slot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bridge device not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MCHBAR_I915 0x44</span>
<span class="cp">#define MCHBAR_I965 0x48</span>
<span class="cp">#define MCHBAR_SIZE (4*4096)</span>

<span class="cp">#define DEVEN_REG 0x54</span>
<span class="cp">#define   DEVEN_MCHBAR_EN (1 &lt;&lt; 28)</span>

<span class="cm">/* Allocate space for the MCH regs if needed, return nonzero on error */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">intel_alloc_mchbar_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">?</span> <span class="n">MCHBAR_I965</span> <span class="o">:</span> <span class="n">MCHBAR_I915</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_lo</span><span class="p">,</span> <span class="n">temp_hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mchbar_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_hi</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp_lo</span><span class="p">);</span>
	<span class="n">mchbar_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">temp_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">temp_lo</span><span class="p">;</span>

	<span class="cm">/* If ACPI doesn&#39;t have it, assume we need to allocate it ourselves */</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mchbar_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pnp_range_reserved</span><span class="p">(</span><span class="n">mchbar_addr</span><span class="p">,</span> <span class="n">mchbar_addr</span> <span class="o">+</span> <span class="n">MCHBAR_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Get some space for it */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i915 MCHBAR&quot;</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_bus_alloc_resource</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">,</span>
				     <span class="n">MCHBAR_SIZE</span><span class="p">,</span> <span class="n">MCHBAR_SIZE</span><span class="p">,</span>
				     <span class="n">PCIBIOS_MIN_MEM</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="n">pcibios_align_resource</span><span class="p">,</span>
				     <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;failed bus alloc: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
				       <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">.</span><span class="n">start</span><span class="p">));</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="n">lower_32_bits</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">.</span><span class="n">start</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Setup MCHBAR if possible, return true if we should disable it again */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_setup_mchbar</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mchbar_reg</span> <span class="o">=</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">?</span> <span class="n">MCHBAR_I965</span> <span class="o">:</span> <span class="n">MCHBAR_I915</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mchbar_need_disable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I915G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">DEVEN_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DEVEN_MCHBAR_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">mchbar_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If it&#39;s already enabled, don&#39;t have to do anything */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intel_alloc_mchbar_resource</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mchbar_need_disable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Space is allocated or reserved, so enable it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_I915G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">DEVEN_REG</span><span class="p">,</span>
				       <span class="n">temp</span> <span class="o">|</span> <span class="n">DEVEN_MCHBAR_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">mchbar_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">mchbar_reg</span><span class="p">,</span> <span class="n">temp</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_teardown_mchbar</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mchbar_reg</span> <span class="o">=</span> <span class="n">INTEL_INFO</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">?</span> <span class="n">MCHBAR_I965</span> <span class="o">:</span> <span class="n">MCHBAR_I915</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mchbar_need_disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_I915G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_I915GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">DEVEN_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DEVEN_MCHBAR_EN</span><span class="p">;</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">DEVEN_REG</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">mchbar_reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">,</span> <span class="n">mchbar_reg</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
		<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mch_res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* true = enable decode, false = disable decoder */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">i915_vga_set_decode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">intel_modeset_vga_set_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">VGA_RSRC_LEGACY_IO</span> <span class="o">|</span> <span class="n">VGA_RSRC_LEGACY_MEM</span> <span class="o">|</span>
		       <span class="n">VGA_RSRC_NORMAL_IO</span> <span class="o">|</span> <span class="n">VGA_RSRC_NORMAL_MEM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">VGA_RSRC_NORMAL_IO</span> <span class="o">|</span> <span class="n">VGA_RSRC_NORMAL_MEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_switcheroo_set_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">vga_switcheroo_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pm_message_t</span> <span class="n">pmm</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">PM_EVENT_SUSPEND</span> <span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">VGA_SWITCHEROO_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;switched on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">switch_power_state</span> <span class="o">=</span> <span class="n">DRM_SWITCH_POWER_CHANGING</span><span class="p">;</span>
		<span class="cm">/* i915 resume handler doesn&#39;t set to D0 */</span>
		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
		<span class="n">i915_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">switch_power_state</span> <span class="o">=</span> <span class="n">DRM_SWITCH_POWER_ON</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;switched off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">switch_power_state</span> <span class="o">=</span> <span class="n">DRM_SWITCH_POWER_CHANGING</span><span class="p">;</span>
		<span class="n">i915_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pmm</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">switch_power_state</span> <span class="o">=</span> <span class="n">DRM_SWITCH_POWER_OFF</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">i915_switcheroo_can_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">can_switch</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">count_lock</span><span class="p">);</span>
	<span class="n">can_switch</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">count_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">can_switch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vga_switcheroo_client_ops</span> <span class="n">i915_switcheroo_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_gpu_state</span> <span class="o">=</span> <span class="n">i915_switcheroo_set_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reprobe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">can_switch</span> <span class="o">=</span> <span class="n">i915_switcheroo_can_switch</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i915_load_modeset_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_parse_bios</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;failed to find VBIOS tables</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If we have &gt; 1 VGA cards, then we need to arbitrate access</span>
<span class="cm">	 * to the common VGA resources.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If we are a secondary display controller (!PCI_DISPLAY_CLASS_VGA),</span>
<span class="cm">	 * then we do not take part in VGA arbitration and the</span>
<span class="cm">	 * vga_client_register() fails with -ENODEV.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vga_client_register</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">i915_vga_set_decode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">intel_register_dsm_handler</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vga_switcheroo_register_client</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i915_switcheroo_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_vga_client</span><span class="p">;</span>

	<span class="cm">/* Initialise stolen first so that we may reserve preallocated</span>
<span class="cm">	 * objects for the BIOS to KMS transition.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_init_stolen</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_vga_switcheroo</span><span class="p">;</span>

	<span class="n">intel_modeset_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gem_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_gem_stolen</span><span class="p">;</span>

	<span class="n">intel_modeset_gem_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_irq_install</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_gem</span><span class="p">;</span>

	<span class="cm">/* Always safe in the mode setting case. */</span>
	<span class="cm">/* FIXME: do pre/post-mode set stuff in core KMS code */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vblank_disable_allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">intel_fbdev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup_irq</span><span class="p">;</span>

	<span class="n">drm_kms_helper_poll_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* We&#39;re off and running w/KMS */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">cleanup_irq:</span>
	<span class="n">drm_irq_uninstall</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">cleanup_gem:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">i915_gem_cleanup_ringbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">i915_gem_cleanup_aliasing_ppgtt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">cleanup_gem_stolen:</span>
	<span class="n">i915_gem_cleanup_stolen</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">cleanup_vga_switcheroo:</span>
	<span class="n">vga_switcheroo_unregister_client</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">cleanup_vga_client:</span>
	<span class="n">vga_client_register</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_master_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span><span class="p">;</span>

	<span class="n">master_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">master_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="n">master_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_master_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_master_private</span> <span class="o">*</span><span class="n">master_priv</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master_priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">master_priv</span><span class="p">);</span>

	<span class="n">master</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">i915_mtrr_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_X86_PAT)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_has_pat</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set up a WC MTRR for non-PAT systems.  This is more common than</span>
<span class="cm">	 * one would think, because the kernel disables PAT on first</span>
<span class="cm">	 * generation Core chips because WC PAT gets overridden by a UC</span>
<span class="cm">	 * MTRR if present.  Even if a UC MTRR isn&#39;t present.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span> <span class="o">=</span> <span class="n">mtrr_add</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_INFO</span><span class="p">(</span><span class="s">&quot;MTRR allocation failed.  Graphics &quot;</span>
			 <span class="s">&quot;performance may suffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i915_kick_out_firmware_fb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">apertures_struct</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">primary</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">alloc_apertures</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">base</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">gtt_mappable_entries</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">primary</span> <span class="o">=</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">PCI_ROM_RESOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_ROM_SHADOW</span><span class="p">;</span>

	<span class="n">remove_conflicting_framebuffers</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;inteldrmfb&quot;</span><span class="p">,</span> <span class="n">primary</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_driver_load - setup chip and create an initial config</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @flags: startup flags</span>
<span class="cm"> *</span>
<span class="cm"> * The driver load routine has to do several things:</span>
<span class="cm"> *   - drive output discovery via intel_modeset_init()</span>
<span class="cm"> *   - initialize the memory manager</span>
<span class="cm"> *   - allocate initial config memory</span>
<span class="cm"> *   - setup the DRM framebuffer with the allocated memory</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i915_driver_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel_device_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mmio_bar</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">aperture_size</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">intel_device_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Refuse to load on gen6+ without kms enabled. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">gen</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>


	<span class="cm">/* i915 has 4 more counters */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">counters</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DRM_STAT_IRQ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DRM_STAT_PRIMARY</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DRM_STAT_SECONDARY</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">types</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">_DRM_STAT_DMA</span><span class="p">;</span>

	<span class="n">dev_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">drm_i915_private_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_priv</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i915_get_bridge_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_priv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span> <span class="o">=</span> <span class="n">intel_gtt_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to initialize GTT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">put_bridge</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_kick_out_firmware_fb</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* overlay on gen2 is broken and can&#39;t address above 1G */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">30</span><span class="p">));</span>

	<span class="cm">/* 965GM sometimes incorrectly writes to hardware status page (HWS)</span>
<span class="cm">	 * using 32bit addressing, overwriting memory if HWS is located</span>
<span class="cm">	 * above 4GB.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The documentation also mentions an issue with undefined</span>
<span class="cm">	 * behaviour if any general state is accessed within a page above 4GB,</span>
<span class="cm">	 * which also needs to be handled carefully.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_BROADWATER</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_CRESTLINE</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dma_set_coherent_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>

	<span class="n">mmio_bar</span> <span class="o">=</span> <span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mmio_bar</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to map registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">put_bridge</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aperture_size</span> <span class="o">=</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt</span><span class="o">-&gt;</span><span class="n">gtt_mappable_entries</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span> <span class="o">=</span>
		<span class="n">io_mapping_create_wc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">aperture_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_rmmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_mtrr_setup</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">aperture_size</span><span class="p">);</span>

	<span class="cm">/* The i915 workqueue is primarily used for batched retirement of</span>
<span class="cm">	 * requests (and thus managing bo) once the task has been completed</span>
<span class="cm">	 * by the GPU. i915_gem_retire_requests() is called directly when we</span>
<span class="cm">	 * need high-priority retirement, such as waiting for an explicit</span>
<span class="cm">	 * bo.</span>
<span class="cm">	 *</span>
<span class="cm">	 * It is also used for periodic low-priority events, such as</span>
<span class="cm">	 * idle-timers and recording error state.</span>
<span class="cm">	 *</span>
<span class="cm">	 * All tasks on the workqueue are expected to acquire the dev mutex</span>
<span class="cm">	 * so there is no point in running more than one instance of the</span>
<span class="cm">	 * workqueue at any time: max_active = 1 and NON_REENTRANT.</span>
<span class="cm">	 */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">alloc_workqueue</span><span class="p">(</span><span class="s">&quot;i915&quot;</span><span class="p">,</span>
				       <span class="n">WQ_UNBOUND</span> <span class="o">|</span> <span class="n">WQ_NON_REENTRANT</span><span class="p">,</span>
				       <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to create our workqueue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_mtrrfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">intel_irq_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Try to make sure MCHBAR is enabled before poking at it */</span>
	<span class="n">intel_setup_mchbar</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_setup_gmbus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_opregion_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Make sure the bios did its job and set up vital registers */</span>
	<span class="n">intel_setup_bios</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">i915_gem_load</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Init HWS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I915_NEED_GFX_HWS</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_init_phys_hws</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_gem_unload</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On the 945G/GM, the chipset reports the MSI capability on the</span>
<span class="cm">	 * integrated graphics even though the support isn&#39;t actually there</span>
<span class="cm">	 * according to the published specs.  It doesn&#39;t appear to function</span>
<span class="cm">	 * correctly in testing on 945G.</span>
<span class="cm">	 * This may be a side effect of MSI having been made available for PEG</span>
<span class="cm">	 * and the registers being closely associated.</span>
<span class="cm">	 *</span>
<span class="cm">	 * According to chipset errata, on the 965GM, MSI interrupts may</span>
<span class="cm">	 * be lost or delayed, but we use them anyways to avoid</span>
<span class="cm">	 * stuck interrupts on some machines.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_I945G</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_I945GM</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">gt_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">rps_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_IVYBRIDGE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_HASWELL</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_MOBILE</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">IS_GEN2</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_vblank_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">num_pipe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_gem_unload</span><span class="p">;</span>

	<span class="cm">/* Start out suspended */</span>
	<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">intel_detect_pch</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_load_modeset_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to init modeset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_gem_unload</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">i915_setup_sysfs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Must be done after probing outputs */</span>
	<span class="n">intel_opregion_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">acpi_video_register</span><span class="p">();</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_timer</span><span class="p">,</span> <span class="n">i915_hangcheck_elapsed</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_GEN5</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">intel_gpu_ips_init</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_gem_unload:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">.</span><span class="n">shrink</span><span class="p">)</span>
		<span class="n">unregister_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">intel_teardown_gmbus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_teardown_mchbar</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
<span class="nl">out_mtrrfree:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">agp_info</span><span class="p">.</span><span class="n">aper_size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">io_mapping_free</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span><span class="p">);</span>
<span class="nl">out_rmmap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">put_bridge:</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">);</span>
<span class="nl">free_priv:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_driver_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_private</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">intel_gpu_ips_teardown</span><span class="p">();</span>

	<span class="n">i915_teardown_sysfs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">.</span><span class="n">shrink</span><span class="p">)</span>
		<span class="n">unregister_shrinker</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">inactive_shrinker</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i915_gpu_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to idle hardware: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">i915_gem_retire_requests</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>

	<span class="cm">/* Cancel the retire work handler, which should be idle now. */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">retire_work</span><span class="p">);</span>

	<span class="n">io_mapping_free</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">agp</span><span class="o">-&gt;</span><span class="n">agp_info</span><span class="p">.</span><span class="n">aper_size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">gtt_mtrr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acpi_video_unregister</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_fbdev_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">intel_modeset_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * free the memory space allocated for the child device</span>
<span class="cm">		 * config parsed from VBT</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev_num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev</span><span class="p">);</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">child_dev_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vga_switcheroo_unregister_client</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">vga_client_register</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free error state after interrupts are fully disabled. */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">hangcheck_timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">error_work</span><span class="p">);</span>
	<span class="n">i915_destroy_error_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">msi_enabled</span><span class="p">)</span>
		<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">intel_opregion_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Flush any outstanding unpin_work. */</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">i915_gem_free_all_phys_object</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">i915_gem_cleanup_ringbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">struct_mutex</span><span class="p">);</span>
		<span class="n">i915_gem_cleanup_aliasing_ppgtt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">i915_gem_cleanup_stolen</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">drm_mm_takedown</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">stolen</span><span class="p">);</span>

		<span class="n">intel_cleanup_overlay</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I915_NEED_GFX_HWS</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">i915_free_hws</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="n">intel_teardown_gmbus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">intel_teardown_mchbar</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">dev_priv</span><span class="o">-&gt;</span><span class="n">bridge_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">i915_driver_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_file_private</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_DRIVER</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">file_priv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">file_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file_priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">request_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i915_driver_lastclose - clean up after all DRM clients have exited</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * Take care of cleaning up after all DRM clients have exited.  In the</span>
<span class="cm"> * mode setting case, we want to restore the kernel&#39;s initial mode (just</span>
<span class="cm"> * in case the last client left us in a bad state).</span>
<span class="cm"> *</span>
<span class="cm"> * Additionally, in the non-mode setting case, we&#39;ll tear down the GTT</span>
<span class="cm"> * and DMA structures, since the kernel won&#39;t be using them, and clea</span>
<span class="cm"> * up any GEM state.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i915_driver_lastclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_i915_private_t</span> <span class="o">*</span><span class="n">dev_priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_priv</span> <span class="o">||</span> <span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">intel_fb_restore_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">vga_switcheroo_process_delayed_switch</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i915_gem_lastclose</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">i915_dma_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_driver_preclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i915_gem_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">i915_driver_postclose</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_i915_file_private</span> <span class="o">*</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">file_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_ioctl_desc</span> <span class="n">i915_ioctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_INIT</span><span class="p">,</span> <span class="n">i915_dma_init</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_FLUSH</span><span class="p">,</span> <span class="n">i915_flush_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_FLIP</span><span class="p">,</span> <span class="n">i915_flip_bufs</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_BATCHBUFFER</span><span class="p">,</span> <span class="n">i915_batchbuffer</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_IRQ_EMIT</span><span class="p">,</span> <span class="n">i915_irq_emit</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_IRQ_WAIT</span><span class="p">,</span> <span class="n">i915_irq_wait</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GETPARAM</span><span class="p">,</span> <span class="n">i915_getparam</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_SETPARAM</span><span class="p">,</span> <span class="n">i915_setparam</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_ALLOC</span><span class="p">,</span> <span class="n">drm_noop</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_FREE</span><span class="p">,</span> <span class="n">drm_noop</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_INIT_HEAP</span><span class="p">,</span> <span class="n">drm_noop</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_CMDBUFFER</span><span class="p">,</span> <span class="n">i915_cmdbuffer</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_DESTROY_HEAP</span><span class="p">,</span>  <span class="n">drm_noop</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_SET_VBLANK_PIPE</span><span class="p">,</span>  <span class="n">drm_noop</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GET_VBLANK_PIPE</span><span class="p">,</span>  <span class="n">i915_vblank_pipe_get</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_VBLANK_SWAP</span><span class="p">,</span> <span class="n">i915_vblank_swap</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_HWS_ADDR</span><span class="p">,</span> <span class="n">i915_set_status_page</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_INIT</span><span class="p">,</span> <span class="n">i915_gem_init_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_EXECBUFFER</span><span class="p">,</span> <span class="n">i915_gem_execbuffer</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_EXECBUFFER2</span><span class="p">,</span> <span class="n">i915_gem_execbuffer2</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_PIN</span><span class="p">,</span> <span class="n">i915_gem_pin_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_UNPIN</span><span class="p">,</span> <span class="n">i915_gem_unpin_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_BUSY</span><span class="p">,</span> <span class="n">i915_gem_busy_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_THROTTLE</span><span class="p">,</span> <span class="n">i915_gem_throttle_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_ENTERVT</span><span class="p">,</span> <span class="n">i915_gem_entervt_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_LEAVEVT</span><span class="p">,</span> <span class="n">i915_gem_leavevt_ioctl</span><span class="p">,</span> <span class="n">DRM_AUTH</span><span class="o">|</span><span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_ROOT_ONLY</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_CREATE</span><span class="p">,</span> <span class="n">i915_gem_create_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_PREAD</span><span class="p">,</span> <span class="n">i915_gem_pread_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_PWRITE</span><span class="p">,</span> <span class="n">i915_gem_pwrite_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_MMAP</span><span class="p">,</span> <span class="n">i915_gem_mmap_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_MMAP_GTT</span><span class="p">,</span> <span class="n">i915_gem_mmap_gtt_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_SET_DOMAIN</span><span class="p">,</span> <span class="n">i915_gem_set_domain_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_SW_FINISH</span><span class="p">,</span> <span class="n">i915_gem_sw_finish_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_SET_TILING</span><span class="p">,</span> <span class="n">i915_gem_set_tiling</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_GET_TILING</span><span class="p">,</span> <span class="n">i915_gem_get_tiling</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_GET_APERTURE</span><span class="p">,</span> <span class="n">i915_gem_get_aperture_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GET_PIPE_FROM_CRTC_ID</span><span class="p">,</span> <span class="n">intel_get_pipe_from_crtc_id</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GEM_MADVISE</span><span class="p">,</span> <span class="n">i915_gem_madvise_ioctl</span><span class="p">,</span> <span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_OVERLAY_PUT_IMAGE</span><span class="p">,</span> <span class="n">intel_overlay_put_image</span><span class="p">,</span> <span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_CONTROL_ALLOW</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_OVERLAY_ATTRS</span><span class="p">,</span> <span class="n">intel_overlay_attrs</span><span class="p">,</span> <span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_CONTROL_ALLOW</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_SET_SPRITE_COLORKEY</span><span class="p">,</span> <span class="n">intel_sprite_set_colorkey</span><span class="p">,</span> <span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_CONTROL_ALLOW</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
	<span class="n">DRM_IOCTL_DEF_DRV</span><span class="p">(</span><span class="n">I915_GET_SPRITE_COLORKEY</span><span class="p">,</span> <span class="n">intel_sprite_get_colorkey</span><span class="p">,</span> <span class="n">DRM_MASTER</span><span class="o">|</span><span class="n">DRM_CONTROL_ALLOW</span><span class="o">|</span><span class="n">DRM_UNLOCKED</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">i915_max_ioctl</span> <span class="o">=</span> <span class="n">DRM_ARRAY_SIZE</span><span class="p">(</span><span class="n">i915_ioctls</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This is really ugly: Because old userspace abused the linux agp interface to</span>
<span class="cm"> * manage the gtt, we need to claim that all intel devices are agp.  For</span>
<span class="cm"> * otherwise the drm core refuses to initialize the agp support code.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i915_driver_device_is_agp</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
