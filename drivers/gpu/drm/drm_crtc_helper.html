<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › drm_crtc_helper.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drm_crtc_helper.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006-2008 Intel Corporation</span>
<span class="cm"> * Copyright (c) 2007 Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * DRM core CRTC related functions</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, distribute, and sell this software and its</span>
<span class="cm"> * documentation for any purpose is hereby granted without fee, provided that</span>
<span class="cm"> * the above copyright notice appear in all copies and that both that copyright</span>
<span class="cm"> * notice and this permission notice appear in supporting documentation, and</span>
<span class="cm"> * that the name of the copyright holders not be used in advertising or</span>
<span class="cm"> * publicity pertaining to distribution of the software without specific,</span>
<span class="cm"> * written prior permission.  The copyright holders make no representations</span>
<span class="cm"> * about the suitability of this software for any purpose.  It is provided &quot;as</span>
<span class="cm"> * is&quot; without express or implied warranty.</span>
<span class="cm"> *</span>
<span class="cm"> * THE COPYRIGHT HOLDERS DISCLAIM ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,</span>
<span class="cm"> * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO</span>
<span class="cm"> * EVENT SHALL THE COPYRIGHT HOLDERS BE LIABLE FOR ANY SPECIAL, INDIRECT OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,</span>
<span class="cm"> * DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER</span>
<span class="cm"> * TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE</span>
<span class="cm"> * OF THIS SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *      Keith Packard</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> *      Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> *      Jesse Barnes &lt;jesse.barnes@intel.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm_crtc.h&quot;</span>
<span class="cp">#include &quot;drm_fourcc.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>
<span class="cp">#include &quot;drm_fb_helper.h&quot;</span>
<span class="cp">#include &quot;drm_edid.h&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">drm_kms_helper_poll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">poll</span><span class="p">,</span> <span class="n">drm_kms_helper_poll</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_mode_validate_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="p">(</span><span class="n">DRM_MODE_FLAG_DBLSCAN</span> <span class="o">|</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">))</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MODE_NO_INTERLACE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">))</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MODE_NO_DBLESCAN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_helper_probe_single_connector_modes - get complete set of display modes</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @maxX: max width for modes</span>
<span class="cm"> * @maxY: max height for modes</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on @dev&#39;s mode_config layout, scan all the connectors and try to detect</span>
<span class="cm"> * modes on them.  Modes will first be added to the connector&#39;s probed_modes</span>
<span class="cm"> * list, then culled (based on validity and the @maxX, @maxY parameters) and</span>
<span class="cm"> * put into the normal modes list.</span>
<span class="cm"> *</span>
<span class="cm"> * Intended to be used either at bootup time or when major configuration</span>
<span class="cm"> * changes have occurred.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: take into account monitor limits</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Number of modes found on @connector.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_helper_probe_single_connector_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
					    <span class="kt">uint32_t</span> <span class="n">maxX</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">maxY</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector_helper_funcs</span> <span class="o">*</span><span class="n">connector_funcs</span> <span class="o">=</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">));</span>
	<span class="cm">/* set all modes to the unverified state */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MODE_UNVERIFIED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">force</span> <span class="o">==</span> <span class="n">DRM_FORCE_ON</span><span class="p">)</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">connector_status_connected</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">connector_status_disconnected</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">)</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">force</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">detect</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">drm_kms_helper_poll_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_disconnected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s] disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">));</span>
		<span class="n">drm_mode_connector_update_edid_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">prune</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DRM_LOAD_EDID_FIRMWARE</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">drm_load_edid_firmware</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">connector_funcs</span><span class="o">-&gt;</span><span class="n">get_modes</span><span class="p">)(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_connected</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">drm_add_modes_noedid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">prune</span><span class="p">;</span>

	<span class="n">drm_mode_connector_list_update</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maxX</span> <span class="o">&amp;&amp;</span> <span class="n">maxY</span><span class="p">)</span>
		<span class="n">drm_mode_validate_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">maxX</span><span class="p">,</span>
				       <span class="n">maxY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">interlace_allowed</span><span class="p">)</span>
		<span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_INTERLACE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">doublescan_allowed</span><span class="p">)</span>
		<span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_FLAG_DBLSCAN</span><span class="p">;</span>
	<span class="n">drm_mode_validate_flag</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode_flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">MODE_OK</span><span class="p">)</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">connector_funcs</span><span class="o">-&gt;</span><span class="n">mode_valid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
								   <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">prune:</span>
	<span class="n">drm_mode_prune_invalid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">drm_mode_sort</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">);</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s] probed modes :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			<span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">));</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span><span class="o">-&gt;</span><span class="n">vrefresh</span> <span class="o">=</span> <span class="n">drm_mode_vrefresh</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

		<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">CRTC_INTERLACE_HALVE_V</span><span class="p">);</span>
		<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_probe_single_connector_modes</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_helper_encoder_in_use - check if a given encoder is in use</span>
<span class="cm"> * @encoder: encoder to check</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Walk @encoders&#39;s DRM device&#39;s mode_config and see if it&#39;s in use.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * True if @encoder is part of the mode_config, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">drm_helper_encoder_in_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">==</span> <span class="n">encoder</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_encoder_in_use</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_helper_crtc_in_use - check if a given CRTC is in a mode_config</span>
<span class="cm"> * @crtc: CRTC to check</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Walk @crtc&#39;s DRM device&#39;s mode_config and see if it&#39;s in use.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * True if @crtc is part of the mode_config, false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">drm_helper_crtc_in_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="cm">/* FIXME: Locking around list access? */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span> <span class="o">&amp;&amp;</span> <span class="n">drm_helper_encoder_in_use</span><span class="p">(</span><span class="n">encoder</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_crtc_in_use</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">drm_encoder_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="p">(</span><span class="o">*</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_helper_disable_unused_functions - disable unused objects</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * If an connector or CRTC isn&#39;t part of @dev&#39;s mode_config, it can be disabled</span>
<span class="cm"> * by calling its dpms function, which should power it off.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_helper_disable_unused_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_disconnected</span><span class="p">)</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_helper_encoder_in_use</span><span class="p">(</span><span class="n">encoder</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drm_encoder_disable</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
			<span class="cm">/* disconnector encoder from any connector */</span>
			<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">drm_helper_crtc_in_use</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)(</span><span class="n">crtc</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="p">(</span><span class="o">*</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">);</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_disable_unused_functions</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_encoder_crtc_ok - can a given crtc drive a given encoder?</span>
<span class="cm"> * @encoder: encoder to test</span>
<span class="cm"> * @crtc: crtc to test</span>
<span class="cm"> *</span>
<span class="cm"> * Return false if @encoder can&#39;t be driven by @crtc, true otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">drm_encoder_crtc_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crtc_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">WARN</span><span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="p">,</span> <span class="s">&quot;checking null crtc?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">crtc_mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">&amp;</span> <span class="n">crtc_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check the CRTC we&#39;re going to map each output to vs. its current</span>
<span class="cm"> * CRTC.  If they don&#39;t match, we have to disable the output and the CRTC</span>
<span class="cm"> * since the driver will have to re-route things.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">drm_crtc_prepare_encoders</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="cm">/* Disable unused encoders */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">drm_encoder_disable</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
		<span class="cm">/* Disable encoders whose CRTC is about to change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">get_crtc</span> <span class="o">&amp;&amp;</span>
		    <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">get_crtc</span><span class="p">)(</span><span class="n">encoder</span><span class="p">))</span>
			<span class="n">drm_encoder_disable</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_crtc_set_mode - set a mode</span>
<span class="cm"> * @crtc: CRTC to program</span>
<span class="cm"> * @mode: mode to use</span>
<span class="cm"> * @x: width of mode</span>
<span class="cm"> * @y: height of mode</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Try to set @mode on @crtc.  Give @crtc and its associated connectors a chance</span>
<span class="cm"> * to fixup or reject the mode prior to trying to set it.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * True if the mode was set successfully, or false otherwise.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span> <span class="n">saved_mode</span><span class="p">,</span> <span class="n">saved_hwmode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">saved_x</span><span class="p">,</span> <span class="n">saved_y</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">drm_helper_crtc_in_use</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">adjusted_mode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adjusted_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">saved_hwmode</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">hwmode</span><span class="p">;</span>
	<span class="n">saved_mode</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">saved_x</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">saved_y</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>

	<span class="cm">/* Update crtc values up front so the driver can rely on them for mode</span>
<span class="cm">	 * setting.</span>
<span class="cm">	 */</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>

	<span class="cm">/* Pass our mode to the connectors and the CRTC to give them a chance to</span>
<span class="cm">	 * adjust it according to limitations or connector properties, and also</span>
<span class="cm">	 * a chance to reject the mode entirely.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">mode_fixup</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
						      <span class="n">adjusted_mode</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Encoder fixup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_fixup</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRTC fixup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CRTC:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* Prepare the encoders and CRTCs before setting the mode. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="cm">/* Disable the encoders as the first thing we do. */</span>
		<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drm_crtc_prepare_encoders</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* Set up the DPLL and any encoders state that needs to adjust or depend</span>
<span class="cm">	 * on the DPLL.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">!</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
	    <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[ENCODER:%d:%s] set [MODE:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_encoder_name</span><span class="p">(</span><span class="n">encoder</span><span class="p">),</span>
			<span class="n">mode</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">mode_set</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now enable the clocks, plane, pipe, and connectors that we set up. */</span>
	<span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* Store real post-adjustment hardware mode. */</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">hwmode</span> <span class="o">=</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">;</span>

	<span class="cm">/* Calculate and store various constants which</span>
<span class="cm">	 * are later needed by vblank and swap-completion</span>
<span class="cm">	 * timestamping. They are derived from true hwmode.</span>
<span class="cm">	 */</span>
	<span class="n">drm_calc_timestamping_constants</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="cm">/* FIXME: add subpixel order */</span>
<span class="nl">done:</span>
	<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adjusted_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">hwmode</span> <span class="o">=</span> <span class="n">saved_hwmode</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">saved_mode</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">saved_x</span><span class="p">;</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">saved_y</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_crtc_helper_set_mode</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">drm_crtc_helper_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="cm">/* Decouple all encoders and their attached connectors from this crtc */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">!=</span> <span class="n">encoder</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drm_helper_disable_unused_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_crtc_helper_set_config - set a new config from userspace</span>
<span class="cm"> * @crtc: CRTC to setup</span>
<span class="cm"> * @crtc_info: user provided configuration</span>
<span class="cm"> * @new_mode: new mode to set</span>
<span class="cm"> * @connector_set: set of connectors for the new config</span>
<span class="cm"> * @fb: new framebuffer</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Setup a new configuration, provided by the user in @crtc_info, and enable</span>
<span class="cm"> * it.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero. (FIXME)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_crtc_helper_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">save_crtcs</span><span class="p">,</span> <span class="o">*</span><span class="n">new_crtc</span><span class="p">,</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">save_encoders</span><span class="p">,</span> <span class="o">*</span><span class="n">new_encoder</span><span class="p">,</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* if true do a full mode set */</span>
	<span class="n">bool</span> <span class="n">fb_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* if true and !mode_changed just do a flip */</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">save_connectors</span><span class="p">,</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ro</span><span class="p">,</span> <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="n">save_set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CRTC:%d] [FB:%d] #connectors=%d (x y) (%i %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CRTC:%d] [NOFB]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">drm_crtc_helper_disable</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Allocate space for the backup of all (non-pointer) crtc, encoder and</span>
<span class="cm">	 * connector data. */</span>
	<span class="n">save_crtcs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_crtc</span> <span class="o">*</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save_crtcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">save_encoders</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_encoder</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save_encoders</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">save_crtcs</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">save_connectors</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span> <span class="o">*</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save_connectors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">save_crtcs</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">save_encoders</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy data. Note that driver private data is not affected.</span>
<span class="cm">	 * Should anything bad happen only the expected state is</span>
<span class="cm">	 * restored, not the drivers personal bookkeeping.</span>
<span class="cm">	 */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">save_crtcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">save_encoders</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">save_connectors</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">save_set</span><span class="p">.</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
	<span class="n">save_set</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">save_set</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">save_set</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
	<span class="n">save_set</span><span class="p">.</span><span class="n">fb</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>

	<span class="cm">/* We should be able to check here if the fb has the same properties</span>
<span class="cm">	 * and then just flip_or_move it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we have no fb then treat it as a full mode set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;crtc has no fb, full mode set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span>
			   <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">fb_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">||</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">)</span>
		<span class="n">fb_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">drm_mode_equal</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;modes are different, full mode set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* a) traverse passed in connector list and get encoders for them */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">drm_connector_helper_funcs</span> <span class="o">*</span><span class="n">connector_funcs</span> <span class="o">=</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
		<span class="n">new_encoder</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ro</span> <span class="o">&lt;</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="p">;</span> <span class="n">ro</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">connectors</span><span class="p">[</span><span class="n">ro</span><span class="p">]</span> <span class="o">==</span> <span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_encoder</span> <span class="o">=</span> <span class="n">connector_funcs</span><span class="o">-&gt;</span><span class="n">best_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
				<span class="cm">/* if we can&#39;t get an encoder for a connector</span>
<span class="cm">				   we are setting now - then fail */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_encoder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="cm">/* don&#39;t break so fail path works correct */</span>
					<span class="n">fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_encoder</span> <span class="o">!=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;encoder changed, full mode switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* If the encoder is reused for another connector, then</span>
<span class="cm">			 * the appropriate crtc will be set later.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">)</span>
				<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">new_encoder</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span>
			<span class="n">new_crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">new_crtc</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ro</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ro</span> <span class="o">&lt;</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="p">;</span> <span class="n">ro</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">connectors</span><span class="p">[</span><span class="n">ro</span><span class="p">]</span> <span class="o">==</span> <span class="n">connector</span><span class="p">)</span>
				<span class="n">new_crtc</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure the new CRTC will work with the encoder */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crtc</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">drm_encoder_crtc_ok</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">,</span> <span class="n">new_crtc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crtc</span> <span class="o">!=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;crtc changed, full mode switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">new_crtc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s] to [CRTC:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
				<span class="n">new_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s] to [NOCRTC]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* mode_set_base is not a required function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_changed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base</span><span class="p">)</span>
		<span class="n">mode_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">drm_helper_crtc_in_use</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;attempting to set mode from&quot;</span>
					<span class="s">&quot; userspace</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">drm_mode_debug_printmodeline</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
			<span class="n">old_fb</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
						      <span class="n">set</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span>
						      <span class="n">old_fb</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to set mode on [CRTC:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
				<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">old_fb</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Setting connector DPMS state to on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">[CONNECTOR:%d:%s] set DPMS on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">connectors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
					      <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">connectors</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
				<span class="n">set</span><span class="o">-&gt;</span><span class="n">connectors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">connectors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">drm_helper_disable_unused_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fb_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>

		<span class="n">old_fb</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">mode_set_base</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">,</span>
						<span class="n">set</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">old_fb</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">save_connectors</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_encoders</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_crtcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/* Restore all previous data. */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">save_crtcs</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">save_encoders</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">save_connectors</span><span class="p">[</span><span class="n">count</span><span class="o">++</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Try to restore the config */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode_changed</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="n">save_set</span><span class="p">.</span><span class="n">crtc</span><span class="p">,</span> <span class="n">save_set</span><span class="p">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">save_set</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
				      <span class="n">save_set</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">save_set</span><span class="p">.</span><span class="n">fb</span><span class="p">))</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to restore config after modeset failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">save_connectors</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_encoders</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_crtcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_crtc_helper_set_config</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_helper_choose_encoder_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dpms</span> <span class="o">=</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">==</span> <span class="n">encoder</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">&lt;</span> <span class="n">dpms</span><span class="p">)</span>
				<span class="n">dpms</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dpms</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_helper_choose_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dpms</span> <span class="o">=</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">&amp;&amp;</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">&lt;</span> <span class="n">dpms</span><span class="p">)</span>
				<span class="n">dpms</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dpms</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_helper_connector_dpms</span>
<span class="cm"> * @connector affected connector</span>
<span class="cm"> * @mode DPMS mode</span>
<span class="cm"> *</span>
<span class="cm"> * Calls the low-level connector DPMS function, then</span>
<span class="cm"> * calls appropriate encoder and crtc DPMS functions as well</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_helper_connector_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">encoder</span> <span class="o">?</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_dpms</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">old_dpms</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* from off to on, do crtc then encoder */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="n">old_dpms</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span> <span class="p">(</span><span class="n">crtc</span><span class="p">,</span>
						     <span class="n">drm_helper_choose_crtc_dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span> <span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
							<span class="n">drm_helper_choose_encoder_dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* from on to off, do encoder then crtc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">old_dpms</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span> <span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
							<span class="n">drm_helper_choose_encoder_dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span> <span class="p">(</span><span class="n">crtc</span><span class="p">,</span>
						     <span class="n">drm_helper_choose_crtc_dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_connector_dpms</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_helper_mode_fill_fb_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">mode_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">offsets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">drm_fb_get_bpp_depth</span><span class="p">(</span><span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">pixel_format</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_mode_fill_fb_struct</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_helper_resume_force_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="o">*</span><span class="n">encoder_funcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="o">*</span><span class="n">crtc_funcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_crtc_helper_set_mode</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span>
					       <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to set mode on crtc %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>

		<span class="cm">/* Turn off outputs that were already powered off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drm_helper_choose_crtc_dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">!=</span> <span class="n">crtc</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">encoder_funcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
					<span class="p">(</span><span class="o">*</span><span class="n">encoder_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span> <span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
								<span class="n">drm_helper_choose_encoder_dpms</span><span class="p">(</span><span class="n">encoder</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="n">crtc_funcs</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">helper_private</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">crtc_funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span> <span class="p">(</span><span class="n">crtc</span><span class="p">,</span>
						     <span class="n">drm_helper_choose_crtc_dpms</span><span class="p">(</span><span class="n">crtc</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* disable the unused connectors while restoring the modesetting */</span>
	<span class="n">drm_helper_disable_unused_functions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_resume_force_mode</span><span class="p">);</span>

<span class="cp">#define DRM_OUTPUT_POLL_PERIOD (10*HZ)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">output_poll_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">delayed_work</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">delayed_work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_device</span><span class="p">,</span> <span class="n">mode_config</span><span class="p">.</span><span class="n">output_poll_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">drm_connector_status</span> <span class="n">old_status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">repoll</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_kms_helper_poll</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* if this is HPD or polled don&#39;t check it -</span>
<span class="cm">		   TV out for instance */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DRM_CONNECTOR_POLL_CONNECT</span> <span class="o">|</span> <span class="n">DRM_CONNECTOR_POLL_DISCONNECT</span><span class="p">))</span>
			<span class="n">repoll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">old_status</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="cm">/* if we are connected and don&#39;t want to poll for disconnect</span>
<span class="cm">		   skip it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_status</span> <span class="o">==</span> <span class="n">connector_status_connected</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">&amp;</span> <span class="n">DRM_CONNECTOR_POLL_DISCONNECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span> <span class="o">&amp;</span> <span class="n">DRM_CONNECTOR_POLL_HPD</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">detect</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s] status updated from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			      <span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">),</span>
			      <span class="n">old_status</span><span class="p">,</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_status</span> <span class="o">!=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send a uevent + call fbdev */</span>
		<span class="n">drm_sysfs_hotplug_event</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">output_poll_changed</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">output_poll_changed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">repoll</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_nrt_wq</span><span class="p">,</span> <span class="n">delayed_work</span><span class="p">,</span> <span class="n">DRM_OUTPUT_POLL_PERIOD</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drm_kms_helper_poll_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">poll_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">output_poll_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_kms_helper_poll_disable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_kms_helper_poll_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">poll</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">poll_enabled</span> <span class="o">||</span> <span class="o">!</span><span class="n">drm_kms_helper_poll</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">polled</span><span class="p">)</span>
			<span class="n">poll</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">poll</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_nrt_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">output_poll_work</span><span class="p">,</span> <span class="n">DRM_OUTPUT_POLL_PERIOD</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_kms_helper_poll_enable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_kms_helper_poll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">output_poll_work</span><span class="p">,</span> <span class="n">output_poll_execute</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">poll_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">drm_kms_helper_poll_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_kms_helper_poll_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_kms_helper_poll_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_kms_helper_poll_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_kms_helper_poll_fini</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_helper_hpd_irq_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">poll_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* kill timer and schedule immediate execution, this doesn&#39;t block */</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">output_poll_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_kms_helper_poll</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">system_nrt_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">output_poll_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_helper_hpd_irq_event</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
