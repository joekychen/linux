<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › drm_crtc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>drm_crtc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2006-2008 Intel Corporation</span>
<span class="cm"> * Copyright (c) 2007 Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> * Copyright (c) 2008 Red Hat Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * DRM core CRTC related functions</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, distribute, and sell this software and its</span>
<span class="cm"> * documentation for any purpose is hereby granted without fee, provided that</span>
<span class="cm"> * the above copyright notice appear in all copies and that both that copyright</span>
<span class="cm"> * notice and this permission notice appear in supporting documentation, and</span>
<span class="cm"> * that the name of the copyright holders not be used in advertising or</span>
<span class="cm"> * publicity pertaining to distribution of the software without specific,</span>
<span class="cm"> * written prior permission.  The copyright holders make no representations</span>
<span class="cm"> * about the suitability of this software for any purpose.  It is provided &quot;as</span>
<span class="cm"> * is&quot; without express or implied warranty.</span>
<span class="cm"> *</span>
<span class="cm"> * THE COPYRIGHT HOLDERS DISCLAIM ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,</span>
<span class="cm"> * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO</span>
<span class="cm"> * EVENT SHALL THE COPYRIGHT HOLDERS BE LIABLE FOR ANY SPECIAL, INDIRECT OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE,</span>
<span class="cm"> * DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER</span>
<span class="cm"> * TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE</span>
<span class="cm"> * OF THIS SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *      Keith Packard</span>
<span class="cm"> *	Eric Anholt &lt;eric@anholt.net&gt;</span>
<span class="cm"> *      Dave Airlie &lt;airlied@linux.ie&gt;</span>
<span class="cm"> *      Jesse Barnes &lt;jesse.barnes@intel.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm_crtc.h&quot;</span>
<span class="cp">#include &quot;drm_edid.h&quot;</span>
<span class="cp">#include &quot;drm_fourcc.h&quot;</span>

<span class="cm">/* Avoid boilerplate.  I&#39;m tired of typing. */</span>
<span class="cp">#define DRM_ENUM_NAME_FN(fnname, list)				\</span>
<span class="cp">	char *fnname(int val)					\</span>
<span class="cp">	{							\</span>
<span class="cp">		int i;						\</span>
<span class="cp">		for (i = 0; i &lt; ARRAY_SIZE(list); i++) {	\</span>
<span class="cp">			if (list[i].type == val)		\</span>
<span class="cp">				return list[i].name;		\</span>
<span class="cp">		}						\</span>
<span class="cp">		return &quot;(unknown)&quot;;				\</span>
<span class="cp">	}</span>

<span class="cm">/*</span>
<span class="cm"> * Global properties</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_dpms_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>	<span class="p">{</span> <span class="n">DRM_MODE_DPMS_ON</span><span class="p">,</span> <span class="s">&quot;On&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DPMS_STANDBY</span><span class="p">,</span> <span class="s">&quot;Standby&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span><span class="p">,</span> <span class="s">&quot;Suspend&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DPMS_OFF</span><span class="p">,</span> <span class="s">&quot;Off&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">DRM_ENUM_NAME_FN</span><span class="p">(</span><span class="n">drm_get_dpms_name</span><span class="p">,</span> <span class="n">drm_dpms_enum_list</span><span class="p">)</span>

<span class="cm">/*</span>
<span class="cm"> * Optional properties</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_scaling_mode_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SCALE_NONE</span><span class="p">,</span> <span class="s">&quot;None&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SCALE_FULLSCREEN</span><span class="p">,</span> <span class="s">&quot;Full&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SCALE_CENTER</span><span class="p">,</span> <span class="s">&quot;Center&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SCALE_ASPECT</span><span class="p">,</span> <span class="s">&quot;Full aspect&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_dithering_mode_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DITHERING_OFF</span><span class="p">,</span> <span class="s">&quot;Off&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DITHERING_ON</span><span class="p">,</span> <span class="s">&quot;On&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DITHERING_AUTO</span><span class="p">,</span> <span class="s">&quot;Automatic&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Non-global properties, but &quot;required&quot; for certain connectors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_dvi_i_select_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Automatic</span><span class="p">,</span> <span class="s">&quot;Automatic&quot;</span> <span class="p">},</span> <span class="cm">/* DVI-I and TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_DVID</span><span class="p">,</span>      <span class="s">&quot;DVI-D&quot;</span>     <span class="p">},</span> <span class="cm">/* DVI-I  */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_DVIA</span><span class="p">,</span>      <span class="s">&quot;DVI-A&quot;</span>     <span class="p">},</span> <span class="cm">/* DVI-I  */</span>
<span class="p">};</span>

<span class="n">DRM_ENUM_NAME_FN</span><span class="p">(</span><span class="n">drm_get_dvi_i_select_name</span><span class="p">,</span> <span class="n">drm_dvi_i_select_enum_list</span><span class="p">)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_dvi_i_subconnector_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Unknown</span><span class="p">,</span>   <span class="s">&quot;Unknown&quot;</span>   <span class="p">},</span> <span class="cm">/* DVI-I and TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_DVID</span><span class="p">,</span>      <span class="s">&quot;DVI-D&quot;</span>     <span class="p">},</span> <span class="cm">/* DVI-I  */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_DVIA</span><span class="p">,</span>      <span class="s">&quot;DVI-A&quot;</span>     <span class="p">},</span> <span class="cm">/* DVI-I  */</span>
<span class="p">};</span>

<span class="n">DRM_ENUM_NAME_FN</span><span class="p">(</span><span class="n">drm_get_dvi_i_subconnector_name</span><span class="p">,</span>
		 <span class="n">drm_dvi_i_subconnector_enum_list</span><span class="p">)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_tv_select_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Automatic</span><span class="p">,</span> <span class="s">&quot;Automatic&quot;</span> <span class="p">},</span> <span class="cm">/* DVI-I and TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Composite</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span> <span class="cm">/* TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_SVIDEO</span><span class="p">,</span>    <span class="s">&quot;SVIDEO&quot;</span>    <span class="p">},</span> <span class="cm">/* TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Component</span><span class="p">,</span> <span class="s">&quot;Component&quot;</span> <span class="p">},</span> <span class="cm">/* TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_SCART</span><span class="p">,</span>     <span class="s">&quot;SCART&quot;</span>     <span class="p">},</span> <span class="cm">/* TV-out */</span>
<span class="p">};</span>

<span class="n">DRM_ENUM_NAME_FN</span><span class="p">(</span><span class="n">drm_get_tv_select_name</span><span class="p">,</span> <span class="n">drm_tv_select_enum_list</span><span class="p">)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_tv_subconnector_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Unknown</span><span class="p">,</span>   <span class="s">&quot;Unknown&quot;</span>   <span class="p">},</span> <span class="cm">/* DVI-I and TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Composite</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span> <span class="p">},</span> <span class="cm">/* TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_SVIDEO</span><span class="p">,</span>    <span class="s">&quot;SVIDEO&quot;</span>    <span class="p">},</span> <span class="cm">/* TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_Component</span><span class="p">,</span> <span class="s">&quot;Component&quot;</span> <span class="p">},</span> <span class="cm">/* TV-out */</span>
	<span class="p">{</span> <span class="n">DRM_MODE_SUBCONNECTOR_SCART</span><span class="p">,</span>     <span class="s">&quot;SCART&quot;</span>     <span class="p">},</span> <span class="cm">/* TV-out */</span>
<span class="p">};</span>

<span class="n">DRM_ENUM_NAME_FN</span><span class="p">(</span><span class="n">drm_get_tv_subconnector_name</span><span class="p">,</span>
		 <span class="n">drm_tv_subconnector_enum_list</span><span class="p">)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_dirty_info_enum_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DIRTY_OFF</span><span class="p">,</span>      <span class="s">&quot;Off&quot;</span>      <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DIRTY_ON</span><span class="p">,</span>       <span class="s">&quot;On&quot;</span>       <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_DIRTY_ANNOTATE</span><span class="p">,</span> <span class="s">&quot;Annotate&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">DRM_ENUM_NAME_FN</span><span class="p">(</span><span class="n">drm_get_dirty_info_name</span><span class="p">,</span>
		 <span class="n">drm_dirty_info_enum_list</span><span class="p">)</span>

<span class="k">struct</span> <span class="n">drm_conn_prop_enum_list</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Connector and encoder types.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_conn_prop_enum_list</span> <span class="n">drm_connector_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_Unknown</span><span class="p">,</span> <span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">,</span> <span class="s">&quot;VGA&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_DVII</span><span class="p">,</span> <span class="s">&quot;DVI-I&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_DVID</span><span class="p">,</span> <span class="s">&quot;DVI-D&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_DVIA</span><span class="p">,</span> <span class="s">&quot;DVI-A&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_Composite</span><span class="p">,</span> <span class="s">&quot;Composite&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_SVIDEO</span><span class="p">,</span> <span class="s">&quot;SVIDEO&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_LVDS</span><span class="p">,</span> <span class="s">&quot;LVDS&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_Component</span><span class="p">,</span> <span class="s">&quot;Component&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_9PinDIN</span><span class="p">,</span> <span class="s">&quot;DIN&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_DisplayPort</span><span class="p">,</span> <span class="s">&quot;DP&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_HDMIA</span><span class="p">,</span> <span class="s">&quot;HDMI-A&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_HDMIB</span><span class="p">,</span> <span class="s">&quot;HDMI-B&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_TV</span><span class="p">,</span> <span class="s">&quot;TV&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_eDP</span><span class="p">,</span> <span class="s">&quot;eDP&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_CONNECTOR_VIRTUAL</span><span class="p">,</span> <span class="s">&quot;Virtual&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="n">drm_encoder_enum_list</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>	<span class="p">{</span> <span class="n">DRM_MODE_ENCODER_NONE</span><span class="p">,</span> <span class="s">&quot;None&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_ENCODER_DAC</span><span class="p">,</span> <span class="s">&quot;DAC&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_ENCODER_TMDS</span><span class="p">,</span> <span class="s">&quot;TMDS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_ENCODER_LVDS</span><span class="p">,</span> <span class="s">&quot;LVDS&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_ENCODER_TVDAC</span><span class="p">,</span> <span class="s">&quot;TV&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">DRM_MODE_ENCODER_VIRTUAL</span><span class="p">,</span> <span class="s">&quot;Virtual&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">drm_get_encoder_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span>
		 <span class="n">drm_encoder_enum_list</span><span class="p">[</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_type</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_get_encoder_name</span><span class="p">);</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">drm_get_connector_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span>
		 <span class="n">drm_connector_enum_list</span><span class="p">[</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_get_connector_name</span><span class="p">);</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">drm_get_connector_status_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">drm_connector_status</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_connected</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;connected&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">connector_status_disconnected</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;disconnected&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_object_get - allocate a new identifier</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @ptr: object pointer, used to generate unique ID</span>
<span class="cm"> * @type: object type</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> *</span>
<span class="cm"> * Create a unique identifier based on @ptr in @dev&#39;s identifier space.  Used</span>
<span class="cm"> * for tracking modes, CRTCs and connectors.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * New unique (relative to other objects in @dev) integer identifier for the</span>
<span class="cm"> * object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_mode_object_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">obj_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">again:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_idr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;Ran out memory getting a mode number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">idr_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_get_new_above</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_idr</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_id</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">idr_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_id</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">obj_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_object_put - free an identifer</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @id: ID to free</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold DRM mode_config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Free @id from @dev&#39;s unique identifier pool.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_mode_object_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">object</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">idr_mutex</span><span class="p">);</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_idr</span><span class="p">,</span> <span class="n">object</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">idr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="nf">drm_mode_object_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="kt">uint32_t</span> <span class="n">id</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">idr_mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_idr</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span> <span class="o">||</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">))</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">idr_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_object_find</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_framebuffer_init - initialize a framebuffer</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates an ID for the framebuffer&#39;s parent mode object, sets its mode</span>
<span class="cm"> * functions &amp; device file and adds it to the master fd list.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_framebuffer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_framebuffer_funcs</span> <span class="o">*</span><span class="n">funcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_FB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_fb</span><span class="o">++</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">fb_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_framebuffer_init</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_framebuffer_cleanup - remove a framebuffer object</span>
<span class="cm"> * @fb: framebuffer to remove</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Scans all the CRTCs in @dev&#39;s mode_config.  If they&#39;re using @fb, removes</span>
<span class="cm"> * it, setting it to NULL.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_framebuffer_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="n">set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* remove from any CRTC */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* should turn off the crtc */</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_set</span><span class="p">));</span>
			<span class="n">set</span><span class="p">.</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
			<span class="n">set</span><span class="p">.</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to reset crtc %p when fb was deleted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">plane_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* should turn off the crtc */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">disable_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to disable plane with busy fb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* disconnect the plane from the fb and crtc: */</span>
			<span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_fb</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_framebuffer_cleanup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_crtc_init - Initialise a new CRTC object</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @crtc: CRTC object to init</span>
<span class="cm"> * @funcs: callbacks for the new CRTC</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode_config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Inits a new object created as base part of an driver crtc object.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_crtc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_funcs</span> <span class="o">*</span><span class="n">funcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_crtc</span><span class="o">++</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_crtc_init</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_crtc_cleanup - Cleans up the core crtc usage.</span>
<span class="cm"> * @crtc: CRTC to cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Cleanup @crtc. Removes from drm modesetting space</span>
<span class="cm"> * does NOT free object, caller does that.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_crtc_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span><span class="p">);</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_crtc</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_crtc_cleanup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_probed_add - add a mode to a connector&#39;s probed mode list</span>
<span class="cm"> * @connector: connector the new mode</span>
<span class="cm"> * @mode: mode data</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Add @mode to @connector&#39;s mode list for later use.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_mode_probed_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_probed_add</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_remove - remove and free a mode</span>
<span class="cm"> * @connector: connector list to modify</span>
<span class="cm"> * @mode: mode to remove</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Remove @mode from @connector&#39;s mode list, then free it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_mode_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_remove</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_connector_init - Init a preallocated connector</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @connector: the connector to init</span>
<span class="cm"> * @funcs: callbacks for this connector</span>
<span class="cm"> * @name: user visible name of the connector</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Initialises a preallocated connector. Connectors should be</span>
<span class="cm"> * subclassed as part of driver connector objects.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, error code on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_connector_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_connector_funcs</span> <span class="o">*</span><span class="n">funcs</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">connector_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CONNECTOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">connector_type</span><span class="p">;</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type_id</span> <span class="o">=</span>
		<span class="o">++</span><span class="n">drm_connector_enum_list</span><span class="p">[</span><span class="n">connector_type</span><span class="p">].</span><span class="n">count</span><span class="p">;</span> <span class="cm">/* TODO */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">user_modes</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">);</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">edid_blob_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector_type</span> <span class="o">!=</span> <span class="n">DRM_MODE_CONNECTOR_VIRTUAL</span><span class="p">)</span>
		<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">edid_property</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">);</span>

	<span class="n">drm_connector_attach_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
				      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dpms_property</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_connector_init</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_connector_cleanup - cleans up an initialised connector</span>
<span class="cm"> * @connector: connector to cleanup</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Cleans up the connector but doesn&#39;t free the object.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_connector_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">probed_modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">drm_mode_remove</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">drm_mode_remove</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">user_modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">drm_mode_remove</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_connector_cleanup</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_connector_unplug_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="cm">/* taking the mode config mutex ends up in a clash with sysfs */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">drm_sysfs_connector_remove</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_connector_unplug_all</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_encoder_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_funcs</span> <span class="o">*</span><span class="n">funcs</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">encoder_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_ENCODER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_type</span> <span class="o">=</span> <span class="n">encoder_type</span><span class="p">;</span>
	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_encoder</span><span class="o">++</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_encoder_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_encoder_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_encoder</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_encoder_cleanup</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_plane_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span>
		   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">possible_crtcs</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_plane_funcs</span> <span class="o">*</span><span class="n">funcs</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">formats</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">format_count</span><span class="p">,</span>
		   <span class="n">bool</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_PLANE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">;</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">funcs</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">;</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_types</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">format_count</span><span class="p">,</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_types</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;out of memory when allocating plane</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_types</span><span class="p">,</span> <span class="n">formats</span><span class="p">,</span> <span class="n">format_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">));</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_count</span> <span class="o">=</span> <span class="n">format_count</span><span class="p">;</span>
	<span class="n">plane</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="n">possible_crtcs</span><span class="p">;</span>

	<span class="cm">/* private planes are not exposed to userspace, but depending on</span>
<span class="cm">	 * display hardware, might be convenient to allow sharing programming</span>
<span class="cm">	 * for the scanout engine with the crtc implementation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">plane_list</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_plane</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_plane_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_plane_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_types</span><span class="p">);</span>
	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="cm">/* if not added to a list, it must be a private plane */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_plane</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_plane_cleanup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_create - create a new display mode</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold DRM mode_config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Create a new drm_display_mode, give it an ID, and return it.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Pointer to new mode on success, NULL on error.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="nf">drm_mode_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">nmode</span><span class="p">;</span>

	<span class="n">nmode</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nmode</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">nmode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nmode</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_create</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_destroy - remove a mode</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @mode: mode to remove</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Free @mode&#39;s unique identifier, then free it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_mode_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_destroy</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_mode_create_standard_connector_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">edid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">dpms</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Standard properties (apply to all connectors)</span>
<span class="cm">	 */</span>
	<span class="n">edid</span> <span class="o">=</span> <span class="n">drm_property_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRM_MODE_PROP_BLOB</span> <span class="o">|</span>
				   <span class="n">DRM_MODE_PROP_IMMUTABLE</span><span class="p">,</span>
				   <span class="s">&quot;EDID&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">edid_property</span> <span class="o">=</span> <span class="n">edid</span><span class="p">;</span>

	<span class="n">dpms</span> <span class="o">=</span> <span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				   <span class="s">&quot;DPMS&quot;</span><span class="p">,</span> <span class="n">drm_dpms_enum_list</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_dpms_enum_list</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dpms_property</span> <span class="o">=</span> <span class="n">dpms</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_create_dvi_i_properties - create DVI-I specific connector properties</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * Called by a driver the first time a DVI-I connector is made.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_create_dvi_i_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">dvi_i_selector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">dvi_i_subconnector</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dvi_i_select_subconnector_property</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dvi_i_selector</span> <span class="o">=</span>
		<span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="s">&quot;select subconnector&quot;</span><span class="p">,</span>
				    <span class="n">drm_dvi_i_select_enum_list</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_dvi_i_select_enum_list</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dvi_i_select_subconnector_property</span> <span class="o">=</span> <span class="n">dvi_i_selector</span><span class="p">;</span>

	<span class="n">dvi_i_subconnector</span> <span class="o">=</span> <span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRM_MODE_PROP_IMMUTABLE</span><span class="p">,</span>
				    <span class="s">&quot;subconnector&quot;</span><span class="p">,</span>
				    <span class="n">drm_dvi_i_subconnector_enum_list</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_dvi_i_subconnector_enum_list</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dvi_i_subconnector_property</span> <span class="o">=</span> <span class="n">dvi_i_subconnector</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_create_dvi_i_properties</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_create_tv_properties - create TV specific connector properties</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @num_modes: number of different TV formats (modes) supported</span>
<span class="cm"> * @modes: array of pointers to strings containing name of each format</span>
<span class="cm"> *</span>
<span class="cm"> * Called by a driver&#39;s TV initialization routine, this function creates</span>
<span class="cm"> * the TV specific connector properties for a given device.  Caller is</span>
<span class="cm"> * responsible for allocating a list of format names and passing them to</span>
<span class="cm"> * this routine.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_create_tv_properties</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_modes</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">modes</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">tv_selector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">tv_subconnector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_select_subconnector_property</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Basic connector properties</span>
<span class="cm">	 */</span>
	<span class="n">tv_selector</span> <span class="o">=</span> <span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="s">&quot;select subconnector&quot;</span><span class="p">,</span>
					  <span class="n">drm_tv_select_enum_list</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_tv_select_enum_list</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_select_subconnector_property</span> <span class="o">=</span> <span class="n">tv_selector</span><span class="p">;</span>

	<span class="n">tv_subconnector</span> <span class="o">=</span>
		<span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRM_MODE_PROP_IMMUTABLE</span><span class="p">,</span>
				    <span class="s">&quot;subconnector&quot;</span><span class="p">,</span>
				    <span class="n">drm_tv_subconnector_enum_list</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_tv_subconnector_enum_list</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_subconnector_property</span> <span class="o">=</span> <span class="n">tv_subconnector</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Other, TV specific properties: margins &amp; TV modes.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_left_margin_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;left margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_right_margin_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;right margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_top_margin_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;top margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_bottom_margin_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;bottom margin&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_mode_property</span> <span class="o">=</span>
		<span class="n">drm_property_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRM_MODE_PROP_ENUM</span><span class="p">,</span>
				    <span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">num_modes</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_modes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">drm_property_add_enum</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_mode_property</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				      <span class="n">i</span><span class="p">,</span> <span class="n">modes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_brightness_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;brightness&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_contrast_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;contrast&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_flicker_reduction_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;flicker reduction&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_overscan_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;overscan&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_saturation_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;saturation&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">tv_hue_property</span> <span class="o">=</span>
		<span class="n">drm_property_create_range</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;hue&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_create_tv_properties</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_create_scaling_mode_property - create scaling mode property</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * Called by a driver the first time it&#39;s needed, must be attached to desired</span>
<span class="cm"> * connectors.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_create_scaling_mode_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">scaling_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">scaling_mode_property</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scaling_mode</span> <span class="o">=</span>
		<span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;scaling mode&quot;</span><span class="p">,</span>
				<span class="n">drm_scaling_mode_enum_list</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_scaling_mode_enum_list</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">scaling_mode_property</span> <span class="o">=</span> <span class="n">scaling_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_create_scaling_mode_property</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_create_dithering_property - create dithering property</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * Called by a driver the first time it&#39;s needed, must be attached to desired</span>
<span class="cm"> * connectors.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_create_dithering_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">dithering_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dithering_mode_property</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dithering_mode</span> <span class="o">=</span>
		<span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dithering&quot;</span><span class="p">,</span>
				<span class="n">drm_dithering_mode_enum_list</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_dithering_mode_enum_list</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dithering_mode_property</span> <span class="o">=</span> <span class="n">dithering_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_create_dithering_property</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_create_dirty_property - create dirty property</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * Called by a driver the first time it&#39;s needed, must be attached to desired</span>
<span class="cm"> * connectors.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_create_dirty_info_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">dirty_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dirty_info_property</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dirty_info</span> <span class="o">=</span>
		<span class="n">drm_property_create_enum</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRM_MODE_PROP_IMMUTABLE</span><span class="p">,</span>
				    <span class="s">&quot;dirty&quot;</span><span class="p">,</span>
				    <span class="n">drm_dirty_info_enum_list</span><span class="p">,</span>
				    <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">drm_dirty_info_enum_list</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dirty_info_property</span> <span class="o">=</span> <span class="n">dirty_info</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_create_dirty_info_property</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_config_init - initialize DRM mode_configuration structure</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * None, should happen single threaded at init time.</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize @dev&#39;s mode_config structure, used for tracking the graphics</span>
<span class="cm"> * configuration of @dev.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_mode_config_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">idr_mutex</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">fb_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">property_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">property_blob_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">plane_list</span><span class="p">);</span>
	<span class="n">idr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_idr</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">drm_mode_create_standard_connector_properties</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Just to be sure */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_fb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_crtc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_encoder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_config_init</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_mode_group_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_mode_group</span> <span class="o">*</span><span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">total_objects</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">total_objects</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_crtc</span><span class="p">;</span>
	<span class="n">total_objects</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_connector</span><span class="p">;</span>
	<span class="n">total_objects</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">num_encoder</span><span class="p">;</span>

	<span class="n">group</span><span class="o">-&gt;</span><span class="n">id_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">total_objects</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">id_list</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">group</span><span class="o">-&gt;</span><span class="n">num_connectors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">group</span><span class="o">-&gt;</span><span class="n">num_encoders</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_group_init_legacy_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">drm_mode_group</span> <span class="o">*</span><span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_group_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">group</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">group</span><span class="o">-&gt;</span><span class="n">id_list</span><span class="p">[</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">group</span><span class="o">-&gt;</span><span class="n">id_list</span><span class="p">[</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span> <span class="o">+</span> <span class="n">group</span><span class="o">-&gt;</span><span class="n">num_encoders</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">group</span><span class="o">-&gt;</span><span class="n">id_list</span><span class="p">[</span><span class="n">group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span> <span class="o">+</span> <span class="n">group</span><span class="o">-&gt;</span><span class="n">num_encoders</span> <span class="o">+</span>
			       <span class="n">group</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_group_init_legacy_group</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_config_cleanup - free up DRM mode_config info</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Free up all the connectors and CRTCs associated with this DRM device, then</span>
<span class="cm"> * free up the framebuffers and associated buffer objects.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: cleanup any dangling user buffer objects too</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_mode_config_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="o">*</span><span class="n">ot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="o">*</span><span class="n">enct</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="o">*</span><span class="n">fbt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">,</span> <span class="o">*</span><span class="n">plt</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">enct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span>
				 <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">ot</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">property_list</span><span class="p">,</span>
				 <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">property</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">fbt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">fb_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">plt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">plane_list</span><span class="p">,</span>
				 <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">idr_remove_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_idr</span><span class="p">);</span>
	<span class="n">idr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_idr</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_config_cleanup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_crtc_convert_to_umode - convert a drm_display_mode into a modeinfo</span>
<span class="cm"> * @out: drm_mode_modeinfo struct to return to the user</span>
<span class="cm"> * @in: drm_display_mode to use</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * None.</span>
<span class="cm"> *</span>
<span class="cm"> * Convert a drm_display_mode into a drm_mode_modeinfo structure to return to</span>
<span class="cm"> * the user.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_crtc_convert_to_umode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_modeinfo</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span>
	     <span class="n">in</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span>
	     <span class="n">in</span><span class="o">-&gt;</span><span class="n">hskew</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span>
	     <span class="n">in</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span>
	     <span class="n">in</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span> <span class="o">||</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vscan</span> <span class="o">&gt;</span> <span class="n">USHRT_MAX</span><span class="p">,</span>
	     <span class="s">&quot;timing values too large for mode info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">out</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hsync_start</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hsync_end</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hskew</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hskew</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vsync_start</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vsync_end</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vscan</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vscan</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vrefresh</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vrefresh</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRM_DISPLAY_MODE_LEN</span><span class="p">);</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">DRM_DISPLAY_MODE_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_crtc_convert_to_umode - convert a modeinfo into a drm_display_mode</span>
<span class="cm"> * @out: drm_display_mode to return to the user</span>
<span class="cm"> * @in: drm_mode_modeinfo to use</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * None.</span>
<span class="cm"> *</span>
<span class="cm"> * Convert a drm_mode_modeinfo into a drm_display_mode structure to return to</span>
<span class="cm"> * the caller.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_crtc_convert_umode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_mode_modeinfo</span> <span class="o">*</span><span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">||</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vrefresh</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">out</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hsync_start</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hsync_end</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">htotal</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">hskew</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">hskew</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vsync_start</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vsync_start</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vsync_end</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vsync_end</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vscan</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vscan</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">vrefresh</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">vrefresh</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRM_DISPLAY_MODE_LEN</span><span class="p">);</span>
	<span class="n">out</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">DRM_DISPLAY_MODE_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_getresources - get graphics configuration</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Construct a set of configuration description structures and return</span>
<span class="cm"> * them to the user, including CRTC, connector and framebuffer configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_getresources</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_card_res</span> <span class="o">*</span><span class="n">card_res</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">lh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connector_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">crtc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encoder_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">fb_id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">crtc_id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">connector_id</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">encoder_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_group</span> <span class="o">*</span><span class="n">mode_group</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the non-control nodes we need to limit the list of resources</span>
<span class="cm">	 * by IDs in the group list for this node</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">)</span>
		<span class="n">fb_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mode_group</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">mode_group</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DRM_MINOR_CONTROL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">list_for_each</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">)</span>
			<span class="n">crtc_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">list_for_each</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">)</span>
			<span class="n">connector_count</span><span class="o">++</span><span class="p">;</span>

		<span class="n">list_for_each</span><span class="p">(</span><span class="n">lh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">)</span>
			<span class="n">encoder_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">crtc_count</span> <span class="o">=</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span><span class="p">;</span>
		<span class="n">connector_count</span> <span class="o">=</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="p">;</span>
		<span class="n">encoder_count</span> <span class="o">=</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_encoders</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span><span class="p">;</span>
	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">min_height</span><span class="p">;</span>
	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span><span class="p">;</span>
	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">min_width</span><span class="p">;</span>

	<span class="cm">/* handle this in 4 parts */</span>
	<span class="cm">/* FBs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_fbs</span> <span class="o">&gt;=</span> <span class="n">fb_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fb_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">fb_id_ptr</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">,</span> <span class="n">filp_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">fb_id</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_fbs</span> <span class="o">=</span> <span class="n">fb_count</span><span class="p">;</span>

	<span class="cm">/* CRTCs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_crtcs</span> <span class="o">&gt;=</span> <span class="n">crtc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crtc_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">crtc_id_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DRM_MINOR_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CRTC:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">crtc_id</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					     <span class="n">crtc_id</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_crtcs</span> <span class="o">=</span> <span class="n">crtc_count</span><span class="p">;</span>

	<span class="cm">/* Encoders */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_encoders</span> <span class="o">&gt;=</span> <span class="n">encoder_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">encoder_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">encoder_id_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DRM_MINOR_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[ENCODER:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
						<span class="n">drm_get_encoder_name</span><span class="p">(</span><span class="n">encoder</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">encoder_id</span> <span class="o">+</span>
					     <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span> <span class="o">+</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_encoders</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					     <span class="n">encoder_id</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_encoders</span> <span class="o">=</span> <span class="n">encoder_count</span><span class="p">;</span>

	<span class="cm">/* Connectors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_connectors</span> <span class="o">&gt;=</span> <span class="n">connector_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">connector_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card_res</span><span class="o">-&gt;</span><span class="n">connector_id_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">DRM_MINOR_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span>
					    <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
					<span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
					     <span class="n">connector_id</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_crtcs</span> <span class="o">+</span>
				<span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_encoders</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">start</span> <span class="o">+</span> <span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">num_connectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">mode_group</span><span class="o">-&gt;</span><span class="n">id_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					     <span class="n">connector_id</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_connectors</span> <span class="o">=</span> <span class="n">connector_count</span><span class="p">;</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRTC[%d] CONNECTORS[%d] ENCODERS[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_crtcs</span><span class="p">,</span>
		  <span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_connectors</span><span class="p">,</span> <span class="n">card_res</span><span class="o">-&gt;</span><span class="n">count_encoders</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_getcrtc - get CRTC configuration</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Construct a CRTC configuration structure to return to the user.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_getcrtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_crtc</span> <span class="o">*</span><span class="n">crtc_resp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
	<span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
		<span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">fb_id</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">fb_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">drm_crtc_convert_to_umode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">mode_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">crtc_resp</span><span class="o">-&gt;</span><span class="n">mode_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_getconnector - get connector configuration</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Construct a connector configuration structure to return to the user.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_getconnector</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_get_connector</span> <span class="o">*</span><span class="n">out_resp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">props_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encoders_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_modeinfo</span> <span class="n">u_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_modeinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mode_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">prop_ptr</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">prop_values</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">encoder_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_modeinfo</span><span class="p">));</span>

	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:?]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">connector_id</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">connector_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_CONNECTOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="n">obj_to_connector</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">props_count</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRM_CONNECTOR_MAX_ENCODER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">encoders_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_modes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">fill_modes</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span><span class="p">,</span>
					     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* delayed so we get modes regardless of pre-fill_modes state */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">mode_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">connector_id</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">connector_type</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type</span><span class="p">;</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">connector_type_id</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">connector_type_id</span><span class="p">;</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">mm_width</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">width_mm</span><span class="p">;</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">mm_height</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">height_mm</span><span class="p">;</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">subpixel</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">display_info</span><span class="p">.</span><span class="n">subpixel_order</span><span class="p">;</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">)</span>
		<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This ioctl is called twice, once to determine how much space is</span>
<span class="cm">	 * needed, and the 2nd time to fill it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_modes</span> <span class="o">&gt;=</span> <span class="n">mode_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mode_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mode_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_modeinfo</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">modes_ptr</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_crtc_convert_to_umode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">mode_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">u_mode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u_mode</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_modes</span> <span class="o">=</span> <span class="n">mode_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_props</span> <span class="o">&gt;=</span> <span class="n">props_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">props_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prop_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">props_ptr</span><span class="p">);</span>
		<span class="n">prop_values</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">prop_values_ptr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">.</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="n">prop_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="n">prop_values</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_props</span> <span class="o">=</span> <span class="n">props_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_encoders</span> <span class="o">&gt;=</span> <span class="n">encoders_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">encoders_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">encoder_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">encoders_ptr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRM_CONNECTOR_MAX_ENCODER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					     <span class="n">encoder_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_encoders</span> <span class="o">=</span> <span class="n">encoders_count</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_getencoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_get_encoder</span> <span class="o">*</span><span class="n">enc_resp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">enc_resp</span><span class="o">-&gt;</span><span class="n">encoder_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_ENCODER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">encoder</span> <span class="o">=</span> <span class="n">obj_to_encoder</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span>
		<span class="n">enc_resp</span><span class="o">-&gt;</span><span class="n">crtc_id</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">enc_resp</span><span class="o">-&gt;</span><span class="n">crtc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">enc_resp</span><span class="o">-&gt;</span><span class="n">encoder_type</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">encoder_type</span><span class="p">;</span>
	<span class="n">enc_resp</span><span class="o">-&gt;</span><span class="n">encoder_id</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">enc_resp</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span><span class="p">;</span>
	<span class="n">enc_resp</span><span class="o">-&gt;</span><span class="n">possible_clones</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_clones</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_getplane_res - get plane info</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @data: ioctl data</span>
<span class="cm"> * @file_priv: DRM file info</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Return an plane count and set of IDs.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_getplane_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_get_plane_res</span> <span class="o">*</span><span class="n">plane_resp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">plane_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This ioctl is called twice, once to determine how much space is</span>
<span class="cm">	 * needed, and the 2nd time to fill it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">num_plane</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">count_planes</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">num_plane</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">plane_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">plane_id_ptr</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">plane_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">plane_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">count_planes</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">num_plane</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_getplane - get plane info</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @data: ioctl data</span>
<span class="cm"> * @file_priv: DRM file info</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Return plane info, including formats supported, gamma size, any</span>
<span class="cm"> * current fb, etc.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_getplane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_get_plane</span> <span class="o">*</span><span class="n">plane_resp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">format_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">plane_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_PLANE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plane</span> <span class="o">=</span> <span class="n">obj_to_plane</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="p">)</span>
		<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">crtc_id</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">crtc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span>
		<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">fb_id</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">fb_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">plane_id</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span><span class="p">;</span>
	<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This ioctl is called twice, once to determine how much space is</span>
<span class="cm">	 * needed, and the 2nd time to fill it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_count</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">count_format_types</span> <span class="o">&gt;=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">format_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">format_type_ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">format_ptr</span><span class="p">,</span>
				 <span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_types</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">plane_resp</span><span class="o">-&gt;</span><span class="n">count_format_types</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_count</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_setplane - set up or tear down an plane</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @data: ioctl data*</span>
<span class="cm"> * @file_prive: DRM file info</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Set plane info, including placement, fb, scaling, and other factors.</span>
<span class="cm"> * Or pass a NULL fb to disable.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_setplane</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_set_plane</span> <span class="o">*</span><span class="n">plane_req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fb_width</span><span class="p">,</span> <span class="n">fb_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, find the plane, crtc, and fb objects.  If not available,</span>
<span class="cm">	 * we don&#39;t bother to call the driver.</span>
<span class="cm">	 */</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">plane_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_PLANE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown plane ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">plane_id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plane</span> <span class="o">=</span> <span class="n">obj_to_plane</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="cm">/* No fb means shut it down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">disable_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">);</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown crtc ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_FB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown framebuffer ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">obj_to_fb</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="cm">/* Check whether this plane supports the fb pixel format. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pixel_format</span> <span class="o">==</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_types</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">format_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid pixel format 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb_width</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">fb_height</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* Make sure source coordinates are inside the fb. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_w</span> <span class="o">&gt;</span> <span class="n">fb_width</span> <span class="o">||</span>
	    <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_x</span> <span class="o">&gt;</span> <span class="n">fb_width</span> <span class="o">-</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_w</span> <span class="o">||</span>
	    <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_h</span> <span class="o">&gt;</span> <span class="n">fb_height</span> <span class="o">||</span>
	    <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_y</span> <span class="o">&gt;</span> <span class="n">fb_height</span> <span class="o">-</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid source coordinates &quot;</span>
			      <span class="s">&quot;%u.%06ux%u.%06u+%u.%06u+%u.%06u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_w</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
			      <span class="p">((</span><span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_w</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15625</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_h</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
			      <span class="p">((</span><span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_h</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15625</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_x</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
			      <span class="p">((</span><span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_x</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15625</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_y</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
			      <span class="p">((</span><span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_y</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15625</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Give drivers some help against integer overflows */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_w</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">||</span>
	    <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_x</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_w</span> <span class="o">||</span>
	    <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_h</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">||</span>
	    <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_y</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int32_t</span><span class="p">)</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_h</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid CRTC coordinates %ux%u+%d+%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_w</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_h</span><span class="p">,</span>
			      <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_x</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_y</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">update_plane</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">crtc</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span>
					 <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_x</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_y</span><span class="p">,</span>
					 <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_w</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">crtc_h</span><span class="p">,</span>
					 <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_x</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_y</span><span class="p">,</span>
					 <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="p">,</span> <span class="n">plane_req</span><span class="o">-&gt;</span><span class="n">src_h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
		<span class="n">plane</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_setcrtc - set CRTC configuration</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Build a new CRTC configuration based on user request.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_setcrtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_crtc</span> <span class="o">*</span><span class="n">crtc_req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">**</span><span class="n">connector_set</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_set</span> <span class="n">set</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">set_connectors_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* For some reason crtc x/y offsets are signed internally. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">||</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span>
				   <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown CRTC ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CRTC:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">mode_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we have a mode we need a framebuffer. */</span>
		<span class="cm">/* If we pass -1, set the mode with the currently bound fb */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">fb_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;CRTC doesn&#39;t have current FB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fb</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">,</span>
						   <span class="n">DRM_MODE_OBJECT_FB</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown FB ID%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fb</span> <span class="o">=</span> <span class="n">obj_to_fb</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mode</span> <span class="o">=</span> <span class="n">drm_mode_create</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_crtc_convert_umode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">drm_mode_set_crtcinfo</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">CRTC_INTERLACE_HALVE_V</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span>
		    <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span>
		    <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">||</span>
		    <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid CRTC viewport %ux%u+%u+%u for fb size %ux%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span><span class="p">,</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">,</span>
				      <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span>
				      <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Count connectors is 0 but mode set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span> <span class="o">||</span> <span class="o">!</span><span class="n">fb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Count connectors is %d but no mode or fb set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">out_id</span><span class="p">;</span>

		<span class="cm">/* Avoid unbounded kernel memory allocation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">num_connector</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">connector_set</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_connectors_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">set_connectors_ptr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">out_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set_connectors_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">out_id</span><span class="p">,</span>
						   <span class="n">DRM_MODE_OBJECT_CONNECTOR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Connector id %d unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">out_id</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">connector</span> <span class="o">=</span> <span class="n">obj_to_connector</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[CONNECTOR:%d:%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
					<span class="n">drm_get_connector_name</span><span class="p">(</span><span class="n">connector</span><span class="p">));</span>

			<span class="n">connector_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">connector</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">set</span><span class="p">.</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">crtc</span><span class="p">;</span>
	<span class="n">set</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">set</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>
	<span class="n">set</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">set</span><span class="p">.</span><span class="n">connectors</span> <span class="o">=</span> <span class="n">connector_set</span><span class="p">;</span>
	<span class="n">set</span><span class="p">.</span><span class="n">num_connectors</span> <span class="o">=</span> <span class="n">crtc_req</span><span class="o">-&gt;</span><span class="n">count_connectors</span><span class="p">;</span>
	<span class="n">set</span><span class="p">.</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">connector_set</span><span class="p">);</span>
	<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_cursor_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_cursor</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Unknown CRTC ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_CURSOR_BO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">cursor_set</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Turns off the cursor if handle is 0 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">cursor_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
					      <span class="n">req</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_CURSOR_MOVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">cursor_move</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">cursor_move</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Original addfb only supported RGB formats, so figure out which one */</span>
<span class="kt">uint32_t</span> <span class="nf">drm_mode_legacy_fb_format</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bpp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">depth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_RGB332</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_XRGB1555</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_RGB565</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_RGB888</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_XRGB8888</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">==</span> <span class="mi">30</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_XRGB2101010</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_ARGB8888</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;bad bpp, assuming x8r8g8b8 pixel format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">DRM_FORMAT_XRGB8888</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fmt</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_legacy_fb_format</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_addfb - add an FB to the graphics configuration</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Add a new FB to the specified CRTC, given a user request.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_addfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_fb_cmd</span> <span class="o">*</span><span class="n">or</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="n">r</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Use new struct with format internally */</span>
	<span class="n">r</span><span class="p">.</span><span class="n">fb_id</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">;</span>
	<span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">r</span><span class="p">.</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">pitch</span><span class="p">;</span>
	<span class="n">r</span><span class="p">.</span><span class="n">pixel_format</span> <span class="o">=</span> <span class="n">drm_mode_legacy_fb_format</span><span class="p">(</span><span class="n">or</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">,</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">);</span>
	<span class="n">r</span><span class="p">.</span><span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">or</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">min_width</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_width</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* TODO check buffer is sufficiently large */</span>
	<span class="cm">/* TODO setup destructor callback */</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">fb_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;could not create framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">or</span><span class="o">-&gt;</span><span class="n">fb_id</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">filp_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[FB:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">format_check</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">format</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pixel_format</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DRM_FORMAT_BIG_ENDIAN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_C8</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB332</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGR233</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBX4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRX4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ABGR4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBA4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRA4444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBX5551</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRX5551</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ABGR1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBA5551</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRA5551</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB565</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGR565</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGR888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBX8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRX8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ABGR8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBA8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRA8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBX1010102</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRX1010102</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ABGR2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBA1010102</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRA1010102</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUYV</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVYU</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_UYVY</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_VYUY</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_AYUV</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV12</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV21</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV16</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV61</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU444</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">framebuffer_check</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">hsub</span><span class="p">,</span> <span class="n">vsub</span><span class="p">,</span> <span class="n">num_planes</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">format_check</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;bad framebuffer format 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hsub</span> <span class="o">=</span> <span class="n">drm_format_horz_chroma_subsampling</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">);</span>
	<span class="n">vsub</span> <span class="o">=</span> <span class="n">drm_format_vert_chroma_subsampling</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">);</span>
	<span class="n">num_planes</span> <span class="o">=</span> <span class="n">drm_format_num_planes</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">%</span> <span class="n">hsub</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;bad framebuffer width %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">%</span> <span class="n">vsub</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;bad framebuffer height %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_planes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">hsub</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handles</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;no buffer object handle for plane %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">drm_format_plane_cpp</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;bad pitch %u for plane %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_addfb2 - add an FB to the graphics configuration</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Add a new FB to the specified CRTC, given a user request with format.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_addfb2</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">min_width</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_width</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;bad framebuffer width %d, should be &gt;= %d &amp;&amp; &lt;= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">min_width</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_width</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;bad framebuffer height %d, should be &gt;= %d &amp;&amp; &lt;= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">min_height</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">max_height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">framebuffer_check</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">fb_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;could not create framebuffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">fb_id</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">filp_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">);</span>
	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;[FB:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_rmfb - remove an FB from the configuration</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Remove the FB specified by the user.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_rmfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fbl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_FB</span><span class="p">);</span>
	<span class="cm">/* TODO check that we really get a framebuffer back. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">obj_to_fb</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">fbl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">,</span> <span class="n">filp_head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span> <span class="o">==</span> <span class="n">fbl</span><span class="p">)</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO release all crtc connected to the framebuffer */</span>
	<span class="cm">/* TODO unhock the destructor from the buffer object */</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">filp_head</span><span class="p">);</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_getfb - get FB info</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Lookup the FB given its ID and return info about it.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_getfb</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_fb_cmd</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_FB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">obj_to_fb</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">create_handle</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_dirtyfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="n">__user</span> <span class="o">*</span><span class="n">clips_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">clips</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_fb_dirty_cmd</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_clips</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_FB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">obj_to_fb</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">num_clips</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">num_clips</span><span class="p">;</span>
	<span class="n">clips_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">clips_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_clips</span> <span class="o">!=</span> <span class="o">!</span><span class="n">clips_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">DRM_MODE_FB_DIRTY_FLAGS</span> <span class="o">&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If userspace annotates copy, clips must come in pairs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_FB_DIRTY_ANNOTATE_COPY</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">num_clips</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_clips</span> <span class="o">&amp;&amp;</span> <span class="n">clips_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num_clips</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num_clips</span> <span class="o">&gt;</span> <span class="n">DRM_MODE_FB_DIRTY_MAX_CLIPS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clips</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">num_clips</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">clips</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clips</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">clips</span><span class="p">,</span> <span class="n">clips_ptr</span><span class="p">,</span>
				     <span class="n">num_clips</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">clips</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_err2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">,</span>
				       <span class="n">clips</span><span class="p">,</span> <span class="n">num_clips</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_err2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">clips</span><span class="p">);</span>
<span class="nl">out_err1:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * drm_fb_release - remove and free the FBs on this file</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Takes mode config lock.</span>
<span class="cm"> *</span>
<span class="cm"> * Destroy all the FBs associated with @filp.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_fb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">minor</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="o">*</span><span class="n">tfb</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">tfb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fbs</span><span class="p">,</span> <span class="n">filp_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">filp_head</span><span class="p">);</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * drm_mode_attachmode - add a mode to the user mode list</span>
<span class="cm"> * @dev: DRM device</span>
<span class="cm"> * @connector: connector to add the mode to</span>
<span class="cm"> * @mode: mode to add</span>
<span class="cm"> *</span>
<span class="cm"> * Add @mode to @connector&#39;s user mode list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_mode_attachmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">user_modes</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_attachmode_crtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">dup_mode</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dup_mode</span> <span class="o">=</span> <span class="n">drm_mode_duplicate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dup_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dup_mode</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">crtc</span> <span class="o">==</span> <span class="n">crtc</span><span class="p">)</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">user_modes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">));</span>

 <span class="nl">out:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dup_mode</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dup_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_attachmode_crtc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_mode_detachmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">match_mode</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">match_mode</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">user_modes</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drm_mode_equal</span><span class="p">(</span><span class="n">match_mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match_mode</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
			<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">match_mode</span><span class="p">);</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_detachmode_crtc</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_mode_detachmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_detachmode_crtc</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_fb_attachmode - Attach a user mode to an connector</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * This attaches a user specified mode to an connector.</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_attachmode_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_mode_cmd</span> <span class="o">*</span><span class="n">mode_cmd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_modeinfo</span> <span class="o">*</span><span class="n">umode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">connector_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CONNECTOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="n">obj_to_connector</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">drm_mode_create</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_crtc_convert_umode</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">umode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">drm_mode_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_mode_attachmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * drm_fb_detachmode - Detach a user specified mode from an connector</span>
<span class="cm"> * @inode: inode from the ioctl</span>
<span class="cm"> * @filp: file * from the ioctl</span>
<span class="cm"> * @cmd: cmd from ioctl</span>
<span class="cm"> * @arg: arg from ioctl</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the user via ioctl.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * Zero on success, errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_mode_detachmode_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_mode_cmd</span> <span class="o">*</span><span class="n">mode_cmd</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_modeinfo</span> <span class="o">*</span><span class="n">umode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">connector_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CONNECTOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">connector</span> <span class="o">=</span> <span class="n">obj_to_connector</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_crtc_convert_umode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="n">umode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_detachmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="nf">drm_property_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">property</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_property</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_values</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="o">*</span><span class="n">num_values</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_PROPERTY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">property</span><span class="o">-&gt;</span><span class="n">num_values</span> <span class="o">=</span> <span class="n">num_values</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">DRM_PROP_NAME_LEN</span><span class="p">);</span>
		<span class="n">property</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">DRM_PROP_NAME_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">property_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">property</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_property_create</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="nf">drm_property_create_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">num_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_PROP_ENUM</span><span class="p">;</span>

	<span class="n">property</span> <span class="o">=</span> <span class="n">drm_property_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num_values</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_values</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_property_add_enum</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				      <span class="n">props</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
				      <span class="n">props</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">property</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">property</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_property_create_enum</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="nf">drm_property_create_bitmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					 <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_prop_enum_list</span> <span class="o">*</span><span class="n">props</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">num_values</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_PROP_BITMASK</span><span class="p">;</span>

	<span class="n">property</span> <span class="o">=</span> <span class="n">drm_property_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num_values</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_values</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_property_add_enum</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				      <span class="n">props</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">,</span>
				      <span class="n">props</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">drm_property_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">property</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">property</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_property_create_bitmask</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="nf">drm_property_create_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					 <span class="kt">uint64_t</span> <span class="n">min</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">DRM_MODE_PROP_RANGE</span><span class="p">;</span>

	<span class="n">property</span> <span class="o">=</span> <span class="n">drm_property_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">property</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_property_create_range</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_property_add_enum</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			  <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property_enum</span> <span class="o">*</span><span class="n">prop_enum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DRM_MODE_PROP_ENUM</span> <span class="o">|</span> <span class="n">DRM_MODE_PROP_BITMASK</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bitmask enum properties have the additional constraint of values</span>
<span class="cm">	 * from 0 to 63</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PROP_BITMASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">prop_enum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">DRM_PROP_NAME_LEN</span><span class="p">);</span>
				<span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">DRM_PROP_NAME_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">prop_enum</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_property_enum</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop_enum</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">DRM_PROP_NAME_LEN</span><span class="p">);</span>
	<span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">DRM_PROP_NAME_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_property_add_enum</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_property_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property_enum</span> <span class="o">*</span><span class="n">prop_enum</span><span class="p">,</span> <span class="o">*</span><span class="n">pt</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">prop_enum</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">prop_enum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">num_values</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">);</span>
	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">property</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_property_destroy</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_connector_attach_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">init_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_object_attach_property</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">init_val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_connector_attach_property</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_connector_property_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drm_object_property_set_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_connector_property_set_value</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_connector_property_get_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">drm_object_property_get_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_connector_property_get_value</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_object_attach_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
				<span class="kt">uint64_t</span> <span class="n">init_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">DRM_OBJECT_MAX_PROPERTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Failed to attach object property (type: 0x%x). Please &quot;</span>
			<span class="s">&quot;increase DRM_OBJECT_MAX_PROPERTY by 1 for each time &quot;</span>
			<span class="s">&quot;you see this message on the same object type.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_val</span><span class="p">;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_object_attach_property</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_object_property_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_object_property_set_value</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_object_property_get_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_object_property_get_value</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_mode_getproperty_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_get_property</span> <span class="o">*</span><span class="n">out_resp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enum_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blob_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property_enum</span> <span class="o">*</span><span class="n">prop_enum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_property_enum</span> <span class="n">__user</span> <span class="o">*</span><span class="n">enum_ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property_blob</span> <span class="o">*</span><span class="n">prop_blob</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">blob_id_ptr</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">values_ptr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">blob_length_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">prop_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_PROPERTY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">property</span> <span class="o">=</span> <span class="n">obj_to_property</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DRM_MODE_PROP_ENUM</span> <span class="o">|</span> <span class="n">DRM_MODE_PROP_BITMASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">prop_enum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
			<span class="n">enum_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PROP_BLOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">prop_blob</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
			<span class="n">blob_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">value_count</span> <span class="o">=</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">num_values</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRM_PROP_NAME_LEN</span><span class="p">);</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">DRM_PROP_NAME_LEN</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_values</span> <span class="o">&gt;=</span> <span class="n">value_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">value_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">values_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">values_ptr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">value_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">values_ptr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_values</span> <span class="o">=</span> <span class="n">value_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DRM_MODE_PROP_ENUM</span> <span class="o">|</span> <span class="n">DRM_MODE_PROP_BITMASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_enum_blobs</span> <span class="o">&gt;=</span> <span class="n">enum_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">enum_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">enum_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_property_enum</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">enum_blob_ptr</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">prop_enum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enum_ptr</span><span class="p">[</span><span class="n">copied</span><span class="p">].</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enum_ptr</span><span class="p">[</span><span class="n">copied</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">prop_enum</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRM_PROP_NAME_LEN</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_enum_blobs</span> <span class="o">=</span> <span class="n">enum_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PROP_BLOB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_enum_blobs</span> <span class="o">&gt;=</span> <span class="n">blob_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">blob_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">blob_id_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">enum_blob_ptr</span><span class="p">;</span>
			<span class="n">blob_length_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">values_ptr</span><span class="p">;</span>

			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">prop_blob</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">enum_blob_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">prop_blob</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">blob_id_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">prop_blob</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">blob_length_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">count_enum_blobs</span> <span class="o">=</span> <span class="n">blob_count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_property_blob</span> <span class="o">*</span><span class="nf">drm_property_create_blob</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
							  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_property_blob</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">blob</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_property_blob</span><span class="p">)</span><span class="o">+</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blob</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_object_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_BLOB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">blob</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">property_blob_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">blob</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drm_property_destroy_blob</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">drm_property_blob</span> <span class="o">*</span><span class="n">blob</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_mode_object_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_getblob_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_get_blob</span> <span class="o">*</span><span class="n">out_resp</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property_blob</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">blob_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">blob_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_BLOB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">blob</span> <span class="o">=</span> <span class="n">obj_to_blob</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blob_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">blob_ptr</span><span class="p">,</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)){</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">out_resp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_connector_update_edid_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">edid</span> <span class="o">*</span><span class="n">edid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">edid_blob_ptr</span><span class="p">)</span>
		<span class="n">drm_property_destroy_blob</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">edid_blob_ptr</span><span class="p">);</span>

	<span class="cm">/* Delete edid, when there is none. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">connector</span><span class="o">-&gt;</span><span class="n">edid_blob_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">edid_property</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">EDID_LENGTH</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">edid</span><span class="o">-&gt;</span><span class="n">extensions</span><span class="p">);</span>
	<span class="n">connector</span><span class="o">-&gt;</span><span class="n">edid_blob_ptr</span> <span class="o">=</span> <span class="n">drm_property_create_blob</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							    <span class="n">size</span><span class="p">,</span> <span class="n">edid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">edid_property</span><span class="p">,</span>
					       <span class="n">connector</span><span class="o">-&gt;</span><span class="n">edid_blob_ptr</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_connector_update_edid_property</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">drm_property_change_is_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
					 <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PROP_IMMUTABLE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PROP_RANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PROP_BITMASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">uint64_t</span> <span class="n">valid_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">num_values</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">valid_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">valid_mask</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">property</span><span class="o">-&gt;</span><span class="n">num_values</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">property</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_connector_property_set_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_connector_set_property</span> <span class="o">*</span><span class="n">conn_set_prop</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_obj_set_property</span> <span class="n">obj_set_prop</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">conn_set_prop</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prop_id</span> <span class="o">=</span> <span class="n">conn_set_prop</span><span class="o">-&gt;</span><span class="n">prop_id</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_id</span> <span class="o">=</span> <span class="n">conn_set_prop</span><span class="o">-&gt;</span><span class="n">connector_id</span><span class="p">,</span>
		<span class="p">.</span><span class="n">obj_type</span> <span class="o">=</span> <span class="n">DRM_MODE_OBJECT_CONNECTOR</span>
	<span class="p">};</span>

	<span class="cm">/* It does all the locking and checking we need */</span>
	<span class="k">return</span> <span class="n">drm_mode_obj_set_property_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">obj_set_prop</span><span class="p">,</span> <span class="n">file_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_mode_connector_set_obj_prop</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
					   <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span> <span class="o">=</span> <span class="n">obj_to_connector</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="cm">/* Do DPMS ourselves */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">dpms_property</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)</span>
			<span class="p">(</span><span class="o">*</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">dpms</span><span class="p">)(</span><span class="n">connector</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* store the property value if successful */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">drm_connector_property_set_value</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_mode_crtc_set_obj_prop</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
				      <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">drm_object_property_set_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drm_mode_plane_set_obj_prop</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">,</span>
				      <span class="kt">uint64_t</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_plane</span> <span class="o">*</span><span class="n">plane</span> <span class="o">=</span> <span class="n">obj_to_plane</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">plane</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="p">(</span><span class="n">plane</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">drm_object_property_set_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_obj_get_properties_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_obj_get_properties</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">props_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">props_ptr</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">__user</span> <span class="o">*</span><span class="n">prop_values_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">obj_id</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">obj_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">props_count</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="cm">/* This ioctl is called twice, once to determine how much space is</span>
<span class="cm">	 * needed, and the 2nd time to fill it. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">count_props</span> <span class="o">&gt;=</span> <span class="n">props_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">props_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">props_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">props_ptr</span><span class="p">);</span>
		<span class="n">prop_values_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
				  <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">prop_values_ptr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">props_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="n">props_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				     <span class="n">prop_values_ptr</span> <span class="o">+</span> <span class="n">copied</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">copied</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">count_props</span> <span class="o">=</span> <span class="n">props_count</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_obj_set_property_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_obj_set_property</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">arg_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">prop_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_property</span> <span class="o">*</span><span class="n">property</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">arg_obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">obj_id</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">obj_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg_obj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg_obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arg_obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg_obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">prop_id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">arg_obj</span><span class="o">-&gt;</span><span class="n">properties</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">prop_obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">prop_id</span><span class="p">,</span>
					<span class="n">DRM_MODE_OBJECT_PROPERTY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop_obj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">property</span> <span class="o">=</span> <span class="n">obj_to_property</span><span class="p">(</span><span class="n">prop_obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_property_change_is_valid</span><span class="p">(</span><span class="n">property</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">arg_obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_OBJECT_CONNECTOR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_connector_set_obj_prop</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span>
						      <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_OBJECT_CRTC</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_crtc_set_obj_prop</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_OBJECT_PLANE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_mode_plane_set_obj_prop</span><span class="p">(</span><span class="n">arg_obj</span><span class="p">,</span> <span class="n">property</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_connector_attach_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRM_CONNECTOR_MAX_ENCODER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_connector_attach_encoder</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">drm_mode_connector_detach_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DRM_CONNECTOR_MAX_ENCODER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">==</span> <span class="n">encoder</span><span class="p">)</span>
				<span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_connector_detach_encoder</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_mode_crtc_set_gamma_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">gamma_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">=</span> <span class="n">gamma_size</span><span class="p">;</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">gamma_size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_crtc_set_gamma_size</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_mode_gamma_set_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_crtc_lut</span> <span class="o">*</span><span class="n">crtc_lut</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">r_base</span><span class="p">,</span> <span class="o">*</span><span class="n">g_base</span><span class="p">,</span> <span class="o">*</span><span class="n">b_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_set</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* memcpy into gamma store */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">!=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
	<span class="n">r_base</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">r_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">g_base</span> <span class="o">=</span> <span class="n">r_base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">g_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b_base</span> <span class="o">=</span> <span class="n">g_base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">b_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">gamma_set</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">r_base</span><span class="p">,</span> <span class="n">g_base</span><span class="p">,</span> <span class="n">b_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_gamma_get_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_crtc_lut</span> <span class="o">*</span><span class="n">crtc_lut</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">r_base</span><span class="p">,</span> <span class="o">*</span><span class="n">g_base</span><span class="p">,</span> <span class="o">*</span><span class="n">b_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drm_core_check_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRIVER_MODESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="cm">/* memcpy into gamma store */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">!=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">gamma_size</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">));</span>
	<span class="n">r_base</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">gamma_store</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">,</span> <span class="n">r_base</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">g_base</span> <span class="o">=</span> <span class="n">r_base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">,</span> <span class="n">g_base</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b_base</span> <span class="o">=</span> <span class="n">g_base</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">crtc_lut</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">,</span> <span class="n">b_base</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_page_flip_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_crtc_page_flip</span> <span class="o">*</span><span class="n">page_flip</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_pending_vblank_event</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_flip</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DRM_MODE_PAGE_FLIP_FLAGS</span> <span class="o">||</span>
	    <span class="n">page_flip</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">page_flip</span><span class="o">-&gt;</span><span class="n">crtc_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_CRTC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">crtc</span> <span class="o">=</span> <span class="n">obj_to_crtc</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The framebuffer is currently unbound, presumably</span>
<span class="cm">		 * due to a hotplug event, that userspace has not</span>
<span class="cm">		 * yet discovered.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">page_flip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">page_flip</span><span class="o">-&gt;</span><span class="n">fb_id</span><span class="p">,</span> <span class="n">DRM_MODE_OBJECT_FB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">obj_to_fb</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span>
	    <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">vdisplay</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span> <span class="o">||</span>
	    <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">vdisplay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;Invalid fb size %ux%u for CRTC viewport %ux%u+%d+%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			      <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">hdisplay</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">.</span><span class="n">vdisplay</span><span class="p">,</span>
			      <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">page_flip</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PAGE_FLIP_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">event_space</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">event_space</span> <span class="o">-=</span> <span class="k">sizeof</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">event_space</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DRM_EVENT_FLIP_COMPLETE</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">user_data</span> <span class="o">=</span> <span class="n">page_flip</span><span class="o">-&gt;</span><span class="n">user_data</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">file_priv</span> <span class="o">=</span> <span class="n">file_priv</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">destroy</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">drm_pending_event</span> <span class="o">*</span><span class="p">))</span> <span class="n">kfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">page_flip</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">page_flip</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRM_MODE_PAGE_FLIP_EVENT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">file_priv</span><span class="o">-&gt;</span><span class="n">event_space</span> <span class="o">+=</span> <span class="k">sizeof</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">drm_mode_config_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">crtc_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
			<span class="n">crtc</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">encoder_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encoder</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
			<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">connector_list</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
			<span class="n">connector</span><span class="o">-&gt;</span><span class="n">funcs</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_mode_config_reset</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">drm_mode_create_dumb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_create_dumb</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dumb_create</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dumb_create</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_mmap_dumb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_map_dumb</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* call driver ioctl to get mmap offset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dumb_map_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dumb_map_offset</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">drm_mode_destroy_dumb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_mode_destroy_dumb</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dumb_destroy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dumb_destroy</span><span class="p">(</span><span class="n">file_priv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Just need to support RGB formats here for compat with code that doesn&#39;t</span>
<span class="cm"> * use pixel formats directly yet.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">drm_fb_get_bpp_depth</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">format</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">depth</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="o">*</span><span class="n">bpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB332</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGR233</span>:
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBX5551</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRX5551</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ABGR1555</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBA5551</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRA5551</span>:
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB565</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGR565</span>:
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGB888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGR888</span>:
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBX8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRX8888</span>:
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_XRGB2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_XBGR2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBX1010102</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRX1010102</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ABGR2101010</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBA1010102</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRA1010102</span>:
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_ARGB8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_ABGR8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_RGBA8888</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_BGRA8888</span>:
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;unsupported pixel format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_fb_get_bpp_depth</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_format_num_planes - get the number of planes for format</span>
<span class="cm"> * @format: pixel format (DRM_FORMAT_*)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * The number of planes used by the specified pixel format.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_format_num_planes</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU444</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV12</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV21</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV16</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV61</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_format_num_planes</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_format_plane_cpp - determine the bytes per pixel value</span>
<span class="cm"> * @format: pixel format (DRM_FORMAT_*)</span>
<span class="cm"> * @plane: plane index</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * The bytes per pixel value for the specified plane.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_format_plane_cpp</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">format</span><span class="p">,</span> <span class="kt">int</span> <span class="n">plane</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plane</span> <span class="o">&gt;=</span> <span class="n">drm_format_num_planes</span><span class="p">(</span><span class="n">format</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUYV</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVYU</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_UYVY</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_VYUY</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV12</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV21</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV16</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV61</span>:
		<span class="k">return</span> <span class="n">plane</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV444</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU444</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">drm_fb_get_bpp_depth</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bpp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bpp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_format_plane_cpp</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_format_horz_chroma_subsampling - get the horizontal chroma subsampling factor</span>
<span class="cm"> * @format: pixel format (DRM_FORMAT_*)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * The horizontal chroma subsampling factor for the</span>
<span class="cm"> * specified pixel format.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_format_horz_chroma_subsampling</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU411</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU410</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUYV</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVYU</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_UYVY</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_VYUY</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV12</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV21</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV16</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV61</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU422</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU420</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_format_horz_chroma_subsampling</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * drm_format_vert_chroma_subsampling - get the vertical chroma subsampling factor</span>
<span class="cm"> * @format: pixel format (DRM_FORMAT_*)</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * The vertical chroma subsampling factor for the</span>
<span class="cm"> * specified pixel format.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">drm_format_vert_chroma_subsampling</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV410</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU410</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_FORMAT_YUV420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_YVU420</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV12</span>:
	<span class="k">case</span> <span class="n">DRM_FORMAT_NV21</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">drm_format_vert_chroma_subsampling</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
