<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › udl › udl_fb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>udl_fb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2012 Red Hat</span>
<span class="cm"> *</span>
<span class="cm"> * based in parts on udlfb.c:</span>
<span class="cm"> * Copyright (C) 2009 Roberto De Ioris &lt;roberto@unbit.it&gt;</span>
<span class="cm"> * Copyright (C) 2009 Jaya Kumar &lt;jayakumar.lkml@gmail.com&gt;</span>
<span class="cm"> * Copyright (C) 2009 Bernie Thompson &lt;bernie@plugable.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License v2. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>

<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_crtc.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>
<span class="cp">#include &quot;udl_drv.h&quot;</span>

<span class="cp">#include &quot;drm_fb_helper.h&quot;</span>

<span class="cp">#define DL_DEFIO_WRITE_DELAY    5 </span><span class="cm">/* fb_deferred_io.delay in jiffies */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fb_defio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Optionally enable experimental fb_defio mmap support */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fb_bpp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">fb_bpp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span> <span class="o">|</span> <span class="n">S_IRGRP</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fb_defio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span> <span class="o">|</span> <span class="n">S_IRGRP</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="n">helper</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_framebuffer</span> <span class="n">ufb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">fbdev_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fb_count</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DL_ALIGN_UP(x, a) ALIGN(x, a)</span>
<span class="cp">#define DL_ALIGN_DOWN(x, a) ALIGN(x-(a-1), a)</span>

<span class="cm">/** Read the red component (0..255) of a 32 bpp colour. */</span>
<span class="cp">#define DLO_RGB_GETRED(col) (uint8_t)((col) &amp; 0xFF)</span>

<span class="cm">/** Read the green component (0..255) of a 32 bpp colour. */</span>
<span class="cp">#define DLO_RGB_GETGRN(col) (uint8_t)(((col) &gt;&gt; 8) &amp; 0xFF)</span>

<span class="cm">/** Read the blue component (0..255) of a 32 bpp colour. */</span>
<span class="cp">#define DLO_RGB_GETBLU(col) (uint8_t)(((col) &gt;&gt; 16) &amp; 0xFF)</span>

<span class="cm">/** Return red/green component of a 16 bpp colour number. */</span>
<span class="cp">#define DLO_RG16(red, grn) (uint8_t)((((red) &amp; 0xF8) | ((grn) &gt;&gt; 5)) &amp; 0xFF)</span>

<span class="cm">/** Return green/blue component of a 16 bpp colour number. */</span>
<span class="cp">#define DLO_GB16(grn, blu) (uint8_t)(((((grn) &amp; 0x1C) &lt;&lt; 3) | ((blu) &gt;&gt; 3)) &amp; 0xFF)</span>

<span class="cm">/** Return 8 bpp colour number from red, green and blue components. */</span>
<span class="cp">#define DLO_RGB8(red, grn, blu) ((((red) &lt;&lt; 5) | (((grn) &amp; 3) &lt;&lt; 3) | ((blu) &amp; 7)) &amp; 0xFF)</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static uint8_t rgb8(uint32_t col)</span>
<span class="c">{</span>
<span class="c">	uint8_t red = DLO_RGB_GETRED(col);</span>
<span class="c">	uint8_t grn = DLO_RGB_GETGRN(col);</span>
<span class="c">	uint8_t blu = DLO_RGB_GETBLU(col);</span>

<span class="c">	return DLO_RGB8(red, grn, blu);</span>
<span class="c">}</span>

<span class="c">static uint16_t rgb16(uint32_t col)</span>
<span class="c">{</span>
<span class="c">	uint8_t red = DLO_RGB_GETRED(col);</span>
<span class="c">	uint8_t grn = DLO_RGB_GETGRN(col);</span>
<span class="c">	uint8_t blu = DLO_RGB_GETBLU(col);</span>

<span class="c">	return (DLO_RG16(red, grn) &lt;&lt; 8) + DLO_GB16(grn, blu);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: fb_defio.c is holding info-&gt;fbdefio.mutex</span>
<span class="cm"> *   Touching ANY framebuffer memory that triggers a page fault</span>
<span class="cm"> *   in fb_defio will cause a deadlock, when it also tries to</span>
<span class="cm"> *   grab the same mutex.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">udlfb_dpy_deferred_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pagelist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_deferred_io</span> <span class="o">*</span><span class="n">fbdefio</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_device</span> <span class="o">*</span><span class="n">udl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">cycles_t</span> <span class="n">start_cycles</span><span class="p">,</span> <span class="n">end_cycles</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_identical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_rendered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb_defio</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">start_cycles</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">();</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">udl_get_urb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="cm">/* walk the written page list and render each to device */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbdefio</span><span class="o">-&gt;</span><span class="n">pagelist</span><span class="p">,</span> <span class="n">lru</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">udl_render_hline</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">),</span>
				  <span class="o">&amp;</span><span class="n">urb</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
				  <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_identical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_sent</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="n">bytes_rendered</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send partial buffer remaining before exiting */</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
		<span class="n">udl_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">bytes_sent</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">udl_urb_completion</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">bytes_sent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">bytes_sent</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">bytes_identical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">bytes_identical</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">bytes_rendered</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">bytes_rendered</span><span class="p">);</span>
	<span class="n">end_cycles</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">();</span>
	<span class="n">atomic_add</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">end_cycles</span> <span class="o">-</span> <span class="n">start_cycles</span><span class="p">)</span>
		    <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)),</span> <span class="cm">/* Kcycles */</span>
		   <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">cpu_kcycles_used</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">udl_handle_damage</span><span class="p">(</span><span class="k">struct</span> <span class="n">udl_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_device</span> <span class="o">*</span><span class="n">udl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">cycles_t</span> <span class="n">start_cycles</span><span class="p">,</span> <span class="n">end_cycles</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_identical</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aligned_x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">active_16</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">vmapping</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">udl_gem_vmap</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to vmap fb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">vmapping</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to vmapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">start_cycles</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">();</span>

	<span class="n">aligned_x</span> <span class="o">=</span> <span class="n">DL_ALIGN_DOWN</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
	<span class="n">width</span> <span class="o">=</span> <span class="n">DL_ALIGN_UP</span><span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">aligned_x</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">));</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">aligned_x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">height</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">udl_get_urb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="o">+</span> <span class="n">height</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">line_offset</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">.</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">byte_offset</span> <span class="o">=</span> <span class="n">line_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">udl_render_hline</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bpp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">urb</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">vmapping</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">byte_offset</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">bpp</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">bytes_identical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes_sent</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send partial buffer remaining before exiting */</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">udl_submit_urb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">bytes_sent</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">udl_urb_completion</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">bytes_sent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">bytes_sent</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">bytes_identical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">bytes_identical</span><span class="p">);</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="n">height</span><span class="o">*</span><span class="n">bpp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">bytes_rendered</span><span class="p">);</span>
	<span class="n">end_cycles</span> <span class="o">=</span> <span class="n">get_cycles</span><span class="p">();</span>
	<span class="n">atomic_add</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">end_cycles</span> <span class="o">-</span> <span class="n">start_cycles</span><span class="p">)</span>
		    <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)),</span> <span class="cm">/* Kcycles */</span>
		   <span class="o">&amp;</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">cpu_kcycles_used</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">udl_fb_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;mmap() framebuffer addr:%lu size:%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">vmalloc_to_pfn</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">PAGE_SHARED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_RESERVED</span><span class="p">;</span>	<span class="cm">/* avoid to swap out this VMA */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udl_fb_fillrect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_fillrect</span> <span class="o">*</span><span class="n">rect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">sys_fillrect</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">rect</span><span class="p">);</span>

	<span class="n">udl_handle_damage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			  <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udl_fb_copyarea</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_copyarea</span> <span class="o">*</span><span class="n">region</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">sys_copyarea</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">region</span><span class="p">);</span>

	<span class="n">udl_handle_damage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">region</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			  <span class="n">region</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udl_fb_imageblit</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fb_image</span> <span class="o">*</span><span class="n">image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">sys_imageblit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">image</span><span class="p">);</span>

	<span class="n">udl_handle_damage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dx</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">dy</span><span class="p">,</span> <span class="n">image</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			  <span class="n">image</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * It&#39;s common for several clients to have framebuffer open simultaneously.</span>
<span class="cm"> * e.g. both fbcon and X. Makes things interesting.</span>
<span class="cm"> * Assumes caller is holding info-&gt;lock (for open and release at least)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udl_fb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">base</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_device</span> <span class="o">*</span><span class="n">udl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>

	<span class="cm">/* If the USB device is gone, we don&#39;t accept new opens */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drm_device_is_unplugged</span><span class="p">(</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">fb_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb_defio</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* enable defio at last moment if not disabled by client */</span>

		<span class="k">struct</span> <span class="n">fb_deferred_io</span> <span class="o">*</span><span class="n">fbdefio</span><span class="p">;</span>

		<span class="n">fbdefio</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_deferred_io</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fbdefio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbdefio</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">=</span> <span class="n">DL_DEFIO_WRITE_DELAY</span><span class="p">;</span>
			<span class="n">fbdefio</span><span class="o">-&gt;</span><span class="n">deferred_io</span> <span class="o">=</span> <span class="n">udlfb_dpy_deferred_io</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span> <span class="o">=</span> <span class="n">fbdefio</span><span class="p">;</span>
		<span class="n">fb_deferred_io_init</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;open /dev/fb%d user=%d fb_info=%p count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">fb_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Assumes caller is holding info-&gt;lock mutex (for open and release at least)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">udl_fb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">fb_count</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">fb_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fb_deferred_io_cleanup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbdefio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_mmap</span> <span class="o">=</span> <span class="n">udl_fb_mmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;released /dev/fb%d user=%d count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">fb_count</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">udlfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">drm_fb_helper_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span> <span class="o">=</span> <span class="n">drm_fb_helper_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span> <span class="o">=</span> <span class="n">udl_fb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span> <span class="o">=</span> <span class="n">udl_fb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">udl_fb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">drm_fb_helper_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span> <span class="o">=</span> <span class="n">drm_fb_helper_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcmap</span> <span class="o">=</span> <span class="n">drm_fb_helper_setcmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_debug_enter</span> <span class="o">=</span> <span class="n">drm_fb_helper_debug_enter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_debug_leave</span> <span class="o">=</span> <span class="n">drm_fb_helper_debug_leave</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_mmap</span> <span class="o">=</span> <span class="n">udl_fb_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_open</span> <span class="o">=</span> <span class="n">udl_fb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_release</span> <span class="o">=</span> <span class="n">udl_fb_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">udl_crtc_fb_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="n">green</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">udl_crtc_fb_gamma_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">red</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">green</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">blue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">udl_user_framebuffer_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">color</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">drm_clip_rect</span> <span class="o">*</span><span class="n">clips</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">num_clips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_framebuffer</span> <span class="o">*</span><span class="n">ufb</span> <span class="o">=</span> <span class="n">to_udl_fb</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ufb</span><span class="o">-&gt;</span><span class="n">active_16</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_clips</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udl_handle_damage</span><span class="p">(</span><span class="n">ufb</span><span class="p">,</span> <span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span><span class="p">,</span> <span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span><span class="p">,</span>
				  <span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x2</span> <span class="o">-</span> <span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x1</span><span class="p">,</span>
				  <span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y2</span> <span class="o">-</span> <span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udl_user_framebuffer_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_framebuffer</span> <span class="o">*</span><span class="n">ufb</span> <span class="o">=</span> <span class="n">to_udl_fb</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ufb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">)</span>
		<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="n">drm_framebuffer_cleanup</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ufb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_framebuffer_funcs</span> <span class="n">udlfb_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">udl_user_framebuffer_destroy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="n">udl_user_framebuffer_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">udl_framebuffer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">udl_framebuffer</span> <span class="o">*</span><span class="n">ufb</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">mode_cmd</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">udl_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ufb</span><span class="o">-&gt;</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_framebuffer_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udlfb_funcs</span><span class="p">);</span>
	<span class="n">drm_helper_mode_fill_fb_struct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">udlfb_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">drm_fb_helper_surface_size</span> <span class="o">*</span><span class="n">sizes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="n">mode_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sizes</span><span class="o">-&gt;</span><span class="n">surface_bpp</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">sizes</span><span class="o">-&gt;</span><span class="n">surface_bpp</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">-&gt;</span><span class="n">surface_width</span><span class="p">;</span>
	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">-&gt;</span><span class="n">surface_height</span><span class="p">;</span>
	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="p">((</span><span class="n">sizes</span><span class="o">-&gt;</span><span class="n">surface_bpp</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">mode_cmd</span><span class="p">.</span><span class="n">pixel_format</span> <span class="o">=</span> <span class="n">drm_mode_legacy_fb_format</span><span class="p">(</span><span class="n">sizes</span><span class="o">-&gt;</span><span class="n">surface_bpp</span><span class="p">,</span>
							  <span class="n">sizes</span><span class="o">-&gt;</span><span class="n">surface_depth</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="p">.</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mode_cmd</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">udl_gem_alloc_object</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">udl_gem_vmap</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to vmap fb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_gfree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">framebuffer_alloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_gfree</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">udl_framebuffer_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode_cmd</span><span class="p">,</span> <span class="n">obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_gfree</span><span class="p">;</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>

	<span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fb</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;udldrmfb&quot;</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">vmapping</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">vmapping</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_DEFAULT</span> <span class="o">|</span> <span class="n">FBINFO_CAN_FORCE_OUTPUT</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udlfb_ops</span><span class="p">;</span>
	<span class="n">drm_fb_helper_fill_fix</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">);</span>
	<span class="n">drm_fb_helper_fill_var</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">,</span> <span class="n">sizes</span><span class="o">-&gt;</span><span class="n">fb_width</span><span class="p">,</span> <span class="n">sizes</span><span class="o">-&gt;</span><span class="n">fb_height</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_gfree</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">DRM_DEBUG_KMS</span><span class="p">(</span><span class="s">&quot;allocated %dx%d vmal %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">fb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		      <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">vmapping</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">out_gfree:</span>
	<span class="n">drm_gem_object_unreference</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">udl_fb_find_or_create_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_fb_helper</span> <span class="o">*</span><span class="n">helper</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">drm_fb_helper_surface_size</span> <span class="o">*</span><span class="n">sizes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="p">)</span><span class="n">helper</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_fb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">udlfb_create</span><span class="p">(</span><span class="n">ufbdev</span><span class="p">,</span> <span class="n">sizes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">new_fb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new_fb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_fb_helper_funcs</span> <span class="n">udl_fb_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gamma_set</span> <span class="o">=</span> <span class="n">udl_crtc_fb_gamma_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">gamma_get</span> <span class="o">=</span> <span class="n">udl_crtc_fb_gamma_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_probe</span> <span class="o">=</span> <span class="n">udl_fb_find_or_create_single</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">udl_fbdev_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fbdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fbdev</span><span class="p">;</span>
		<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
			<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">);</span>
		<span class="n">framebuffer_release</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">drm_fb_helper_fini</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">);</span>
	<span class="n">drm_framebuffer_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
	<span class="n">drm_gem_object_unreference_unlocked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">ufb</span><span class="p">.</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">udl_fbdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_device</span> <span class="o">*</span><span class="n">udl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bpp_sel</span> <span class="o">=</span> <span class="n">fb_bpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ufbdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">udl_fbdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ufbdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">udl</span><span class="o">-&gt;</span><span class="n">fbdev</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="p">;</span>
	<span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">funcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">udl_fb_helper_funcs</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">drm_fb_helper_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">,</span>
				 <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ufbdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">drm_fb_helper_single_add_all_connectors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">);</span>
	<span class="n">drm_fb_helper_initial_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">,</span> <span class="n">bpp_sel</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">udl_fbdev_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_device</span> <span class="o">*</span><span class="n">udl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">udl_fbdev_destroy</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">udl</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">);</span>
	<span class="n">udl</span><span class="o">-&gt;</span><span class="n">fbdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">udl_fbdev_unplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">udl_device</span> <span class="o">*</span><span class="n">udl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_fbdev</span> <span class="o">*</span><span class="n">ufbdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">udl</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ufbdev</span> <span class="o">=</span> <span class="n">udl</span><span class="o">-&gt;</span><span class="n">fbdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fbdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">ufbdev</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">.</span><span class="n">fbdev</span><span class="p">;</span>
		<span class="n">unlink_framebuffer</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span>
<span class="nf">udl_fb_user_fb_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">drm_file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">drm_mode_fb_cmd2</span> <span class="o">*</span><span class="n">mode_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">udl_framebuffer</span> <span class="o">*</span><span class="n">ufb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">drm_gem_object_lookup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;object size not sufficient for fb %d %zu %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mode_cmd</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ufb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ufb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ufb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">udl_framebuffer_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ufb</span><span class="p">,</span> <span class="n">mode_cmd</span><span class="p">,</span> <span class="n">to_udl_bo</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ufb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ufb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
