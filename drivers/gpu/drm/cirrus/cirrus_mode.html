<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › gpu › drm › cirrus › cirrus_mode.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cirrus_mode.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright 2012 Red Hat</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General</span>
<span class="cm"> * Public License version 2. See the file COPYING in the main</span>
<span class="cm"> * directory of this archive for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors: Matthew Garrett</span>
<span class="cm"> *          Dave Airlie</span>
<span class="cm"> *</span>
<span class="cm"> * Portions of this code derived from cirrusfb.c:</span>
<span class="cm"> * drivers/video/cirrusfb.c - driver for Cirrus Logic chipsets</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1999-2001 Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &quot;drmP.h&quot;</span>
<span class="cp">#include &quot;drm.h&quot;</span>
<span class="cp">#include &quot;drm_crtc_helper.h&quot;</span>

<span class="cp">#include &lt;video/cirrus.h&gt;</span>

<span class="cp">#include &quot;cirrus_drv.h&quot;</span>

<span class="cp">#define CIRRUS_LUT_SIZE 256</span>

<span class="cp">#define PALETTE_INDEX 0x8</span>
<span class="cp">#define PALETTE_DATA 0x9</span>

<span class="cm">/*</span>
<span class="cm"> * This file contains setup code for the CRTC.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_crtc_load_lut</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_crtc</span> <span class="o">*</span><span class="n">cirrus_crtc</span> <span class="o">=</span> <span class="n">to_cirrus_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CIRRUS_LUT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* VGA registers */</span>
		<span class="n">WREG8</span><span class="p">(</span><span class="n">PALETTE_INDEX</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">WREG8</span><span class="p">(</span><span class="n">PALETTE_DATA</span><span class="p">,</span> <span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">WREG8</span><span class="p">(</span><span class="n">PALETTE_DATA</span><span class="p">,</span> <span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">WREG8</span><span class="p">(</span><span class="n">PALETTE_DATA</span><span class="p">,</span> <span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The DRM core requires DPMS functions, but they make little sense in our</span>
<span class="cm"> * case and so are just stubs</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_crtc_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sr01</span><span class="p">,</span> <span class="n">gr0e</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_ON</span>:
		<span class="n">sr01</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">gr0e</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_STANDBY</span>:
		<span class="n">sr01</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">gr0e</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_SUSPEND</span>:
		<span class="n">sr01</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">gr0e</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DRM_MODE_DPMS_OFF</span>:
		<span class="n">sr01</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">gr0e</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WREG8</span><span class="p">(</span><span class="n">SEQ_INDEX</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">sr01</span> <span class="o">|=</span> <span class="n">RREG8</span><span class="p">(</span><span class="n">SEQ_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
	<span class="n">WREG_SEQ</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">sr01</span><span class="p">);</span>

	<span class="n">WREG8</span><span class="p">(</span><span class="n">GFX_INDEX</span><span class="p">,</span> <span class="mh">0xe</span><span class="p">);</span>
	<span class="n">gr0e</span> <span class="o">|=</span> <span class="n">RREG8</span><span class="p">(</span><span class="n">GFX_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x06</span><span class="p">;</span>
	<span class="n">WREG_GFX</span><span class="p">(</span><span class="mh">0xe</span><span class="p">,</span> <span class="n">gr0e</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The core passes the desired mode to the CRTC code to see whether any</span>
<span class="cm"> * CRTC-specific modifications need to be made to it. We&#39;re in a position</span>
<span class="cm"> * to just pass that straight through, so this does nothing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">cirrus_crtc_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cirrus_set_start_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">WREG8</span><span class="p">(</span><span class="n">CRT_INDEX</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">RREG8</span><span class="p">(</span><span class="n">CRT_DATA</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xf2</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="mh">0x1b</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">WREG8</span><span class="p">(</span><span class="n">CRT_INDEX</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">RREG8</span><span class="p">(</span><span class="n">CRT_DATA</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="mh">0x1d</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* cirrus is different - we will force move buffers out of VRAM */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrus_crtc_do_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">atomic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_gem_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_framebuffer</span> <span class="o">*</span><span class="n">cirrus_fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_bo</span> <span class="o">*</span><span class="n">bo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">gpu_addr</span><span class="p">;</span>

	<span class="cm">/* push the previous fb to system ram */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic</span> <span class="o">&amp;&amp;</span> <span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cirrus_fb</span> <span class="o">=</span> <span class="n">to_cirrus_framebuffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="n">cirrus_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
		<span class="n">bo</span> <span class="o">=</span> <span class="n">gem_to_cirrus_bo</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cirrus_bo_reserve</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">cirrus_bo_push_sysram</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>
		<span class="n">cirrus_bo_unreserve</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cirrus_fb</span> <span class="o">=</span> <span class="n">to_cirrus_framebuffer</span><span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">obj</span> <span class="o">=</span> <span class="n">cirrus_fb</span><span class="o">-&gt;</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">bo</span> <span class="o">=</span> <span class="n">gem_to_cirrus_bo</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cirrus_bo_reserve</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cirrus_bo_pin</span><span class="p">(</span><span class="n">bo</span><span class="p">,</span> <span class="n">TTM_PL_FLAG_VRAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gpu_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cirrus_bo_unreserve</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">gfbdev</span><span class="o">-&gt;</span><span class="n">gfb</span> <span class="o">==</span> <span class="n">cirrus_fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if pushing console in kmap it */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ttm_bo_kmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">bo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bo</span><span class="o">-&gt;</span><span class="n">bo</span><span class="p">.</span><span class="n">num_pages</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bo</span><span class="o">-&gt;</span><span class="n">kmap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;failed to kmap fbcon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cirrus_bo_unreserve</span><span class="p">(</span><span class="n">bo</span><span class="p">);</span>

	<span class="n">cirrus_set_start_address</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">gpu_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrus_crtc_mode_set_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cirrus_crtc_do_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The meat of this driver. The core passes us a mode and we have to program</span>
<span class="cm"> * it. The modesetting here is the bare minimum required to satisfy the qemu</span>
<span class="cm"> * emulation of this hardware, and running this against a real device is</span>
<span class="cm"> * likely to result in an inadequately programmed mode. We&#39;ve already had</span>
<span class="cm"> * the opportunity to modify the mode, so whatever we receive here should</span>
<span class="cm"> * be something that can be correctly programmed and displayed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrus_crtc_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="k">struct</span> <span class="n">drm_framebuffer</span> <span class="o">*</span><span class="n">old_fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hsyncstart</span><span class="p">,</span> <span class="n">hsyncend</span><span class="p">,</span> <span class="n">htotal</span><span class="p">,</span> <span class="n">hdispend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vtotal</span><span class="p">,</span> <span class="n">vdispend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sr07</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">htotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">htotal</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hsyncend</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_end</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hsyncstart</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hsync_start</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hdispend</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">hdisplay</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">vtotal</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>
	<span class="n">vdispend</span> <span class="o">=</span> <span class="n">mode</span><span class="o">-&gt;</span><span class="n">vdisplay</span><span class="p">;</span>

	<span class="n">vdispend</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vtotal</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">htotal</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">hdispend</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsyncstart</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hsyncend</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_V_SYNC_END</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_H_TOTAL</span><span class="p">,</span> <span class="n">htotal</span><span class="p">);</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_H_DISP</span><span class="p">,</span> <span class="n">hdispend</span><span class="p">);</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_H_SYNC_START</span><span class="p">,</span> <span class="n">hsyncstart</span><span class="p">);</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_H_SYNC_END</span><span class="p">,</span> <span class="n">hsyncend</span><span class="p">);</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_V_TOTAL</span><span class="p">,</span> <span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_V_DISP_END</span><span class="p">,</span> <span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_MAX_SCAN</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Overflow bits for values that don&#39;t fit in the standard registers</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vdispend</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdispend</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_OVERFLOW</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* More overflow bits */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">64</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">htotal</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">CL_CRT1A</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Disable Hercules/CGA compatibility */</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_MODE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="n">WREG8</span><span class="p">(</span><span class="n">SEQ_INDEX</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">sr07</span> <span class="o">=</span> <span class="n">RREG8</span><span class="p">(</span><span class="n">SEQ_DATA</span><span class="p">);</span>
	<span class="n">sr07</span> <span class="o">&amp;=</span> <span class="mh">0xe0</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">sr07</span> <span class="o">|=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">sr07</span> <span class="o">|=</span> <span class="mh">0xc1</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">sr07</span> <span class="o">|=</span> <span class="mh">0x15</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="mh">0xc5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">sr07</span> <span class="o">|=</span> <span class="mh">0x19</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="mh">0xc5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WREG_SEQ</span><span class="p">(</span><span class="mh">0x7</span><span class="p">,</span> <span class="n">sr07</span><span class="p">);</span>

	<span class="cm">/* Program the pitch */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="n">VGA_CRTC_OFFSET</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Enable extended blanking and pitch bits, and enable full memory */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">crtc</span><span class="o">-&gt;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">pitches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">WREG_CRT</span><span class="p">(</span><span class="mh">0x1b</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* Enable high-colour modes */</span>
	<span class="n">WREG_GFX</span><span class="p">(</span><span class="n">VGA_GFX_MODE</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

	<span class="cm">/* And set graphics mode */</span>
	<span class="n">WREG_GFX</span><span class="p">(</span><span class="n">VGA_GFX_MISC</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">WREG_HDR</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">cirrus_crtc_do_set_base</span><span class="p">(</span><span class="n">crtc</span><span class="p">,</span> <span class="n">old_fb</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called before a mode is programmed. A typical use might be to</span>
<span class="cm"> * enable DPMS during the programming to avoid seeing intermediate stages,</span>
<span class="cm"> * but that&#39;s not relevant to us</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_crtc_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called after a mode is programmed. It should reverse anything done</span>
<span class="cm"> * by the prepare function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_crtc_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The core can pass us a set of gamma values to program. We actually only</span>
<span class="cm"> * use this for 8-bit mode so can&#39;t perform smooth fades on deeper modes,</span>
<span class="cm"> * but it&#39;s a requirement that we provide the function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_crtc_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">start</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_crtc</span> <span class="o">*</span><span class="n">cirrus_crtc</span> <span class="o">=</span> <span class="n">to_cirrus_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">CIRRUS_LUT_SIZE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CIRRUS_LUT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">cirrus_crtc_load_lut</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Simple cleanup function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_crtc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_crtc</span> <span class="o">*</span><span class="n">cirrus_crtc</span> <span class="o">=</span> <span class="n">to_cirrus_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">drm_crtc_cleanup</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cirrus_crtc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* These provide the minimum set of functions required to handle a CRTC */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_funcs</span> <span class="n">cirrus_crtc_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">gamma_set</span> <span class="o">=</span> <span class="n">cirrus_crtc_gamma_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_config</span> <span class="o">=</span> <span class="n">drm_crtc_helper_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">cirrus_crtc_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_crtc_helper_funcs</span> <span class="n">cirrus_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">cirrus_crtc_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">cirrus_crtc_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">cirrus_crtc_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set_base</span> <span class="o">=</span> <span class="n">cirrus_crtc_mode_set_base</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">cirrus_crtc_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">cirrus_crtc_commit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_lut</span> <span class="o">=</span> <span class="n">cirrus_crtc_load_lut</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* CRTC setup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_crtc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_crtc</span> <span class="o">*</span><span class="n">cirrus_crtc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cirrus_crtc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrus_crtc</span><span class="p">)</span> <span class="o">+</span>
			      <span class="p">(</span><span class="n">CIRRUSFB_CONN_LIMIT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="p">)),</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cirrus_crtc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">drm_crtc_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cirrus_crtc_funcs</span><span class="p">);</span>

	<span class="n">drm_mode_crtc_set_gamma_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">CIRRUS_LUT_SIZE</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">crtc</span> <span class="o">=</span> <span class="n">cirrus_crtc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CIRRUS_LUT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_crtc_helper_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cirrus_helper_funcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** Sets the color ramps on behalf of fbcon */</span>
<span class="kt">void</span> <span class="nf">cirrus_crtc_fb_gamma_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="n">green</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_crtc</span> <span class="o">*</span><span class="n">cirrus_crtc</span> <span class="o">=</span> <span class="n">to_cirrus_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">red</span><span class="p">;</span>
	<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">green</span><span class="p">;</span>
	<span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">blue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/** Gets the color ramps on behalf of fbcon */</span>
<span class="kt">void</span> <span class="nf">cirrus_crtc_fb_gamma_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_crtc</span> <span class="o">*</span><span class="n">crtc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">red</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">green</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="o">*</span><span class="n">blue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_crtc</span> <span class="o">*</span><span class="n">cirrus_crtc</span> <span class="o">=</span> <span class="n">to_cirrus_crtc</span><span class="p">(</span><span class="n">crtc</span><span class="p">);</span>

	<span class="o">*</span><span class="n">red</span> <span class="o">=</span> <span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_r</span><span class="p">[</span><span class="n">regno</span><span class="p">];</span>
	<span class="o">*</span><span class="n">green</span> <span class="o">=</span> <span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_g</span><span class="p">[</span><span class="n">regno</span><span class="p">];</span>
	<span class="o">*</span><span class="n">blue</span> <span class="o">=</span> <span class="n">cirrus_crtc</span><span class="o">-&gt;</span><span class="n">lut_b</span><span class="p">[</span><span class="n">regno</span><span class="p">];</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">cirrus_encoder_mode_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_encoder_mode_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">adjusted_mode</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_encoder_dpms</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_encoder_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_encoder_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cirrus_encoder_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cirrus_encoder</span> <span class="o">*</span><span class="n">cirrus_encoder</span> <span class="o">=</span> <span class="n">to_cirrus_encoder</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">drm_encoder_cleanup</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cirrus_encoder</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_helper_funcs</span> <span class="n">cirrus_encoder_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">cirrus_encoder_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_fixup</span> <span class="o">=</span> <span class="n">cirrus_encoder_mode_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_set</span> <span class="o">=</span> <span class="n">cirrus_encoder_mode_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">cirrus_encoder_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">commit</span> <span class="o">=</span> <span class="n">cirrus_encoder_commit</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">drm_encoder_funcs</span> <span class="n">cirrus_encoder_encoder_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">cirrus_encoder_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="nf">cirrus_encoder_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_encoder</span> <span class="o">*</span><span class="n">cirrus_encoder</span><span class="p">;</span>

	<span class="n">cirrus_encoder</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrus_encoder</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cirrus_encoder</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">encoder</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cirrus_encoder</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">encoder</span><span class="o">-&gt;</span><span class="n">possible_crtcs</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">drm_encoder_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cirrus_encoder_encoder_funcs</span><span class="p">,</span>
			 <span class="n">DRM_MODE_ENCODER_DAC</span><span class="p">);</span>
	<span class="n">drm_encoder_helper_add</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cirrus_encoder_helper_funcs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">encoder</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cirrus_vga_get_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Just add a static list of modes */</span>
	<span class="n">drm_add_modes_noedid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">);</span>
	<span class="n">drm_add_modes_noedid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">600</span><span class="p">);</span>
	<span class="n">drm_add_modes_noedid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">);</span>
	<span class="n">drm_add_modes_noedid</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cirrus_vga_mode_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">drm_display_mode</span> <span class="o">*</span><span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Any mode we&#39;ve added is valid */</span>
	<span class="k">return</span> <span class="n">MODE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="nf">cirrus_connector_best_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span>
						  <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">enc_id</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">encoder_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">drm_mode_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>

	<span class="cm">/* pick the encoder ids */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enc_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obj</span> <span class="o">=</span>
		    <span class="n">drm_mode_object_find</span><span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">enc_id</span><span class="p">,</span>
					 <span class="n">DRM_MODE_OBJECT_ENCODER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">encoder</span> <span class="o">=</span> <span class="n">obj_to_encoder</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">encoder</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">drm_connector_status</span> <span class="nf">cirrus_vga_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span>
						   <span class="o">*</span><span class="n">connector</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">connector_status_connected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_connector_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">drm_connector_cleanup</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">drm_connector_helper_funcs</span> <span class="n">cirrus_vga_connector_helper_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_modes</span> <span class="o">=</span> <span class="n">cirrus_vga_get_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_valid</span> <span class="o">=</span> <span class="n">cirrus_vga_mode_valid</span><span class="p">,</span>
	<span class="p">.</span><span class="n">best_encoder</span> <span class="o">=</span> <span class="n">cirrus_connector_best_encoder</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">drm_connector_funcs</span> <span class="n">cirrus_vga_connector_funcs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dpms</span> <span class="o">=</span> <span class="n">drm_helper_connector_dpms</span><span class="p">,</span>
	<span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="n">cirrus_vga_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fill_modes</span> <span class="o">=</span> <span class="n">drm_helper_probe_single_connector_modes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">cirrus_connector_destroy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="nf">cirrus_vga_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">drm_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cirrus_connector</span> <span class="o">*</span><span class="n">cirrus_connector</span><span class="p">;</span>

	<span class="n">cirrus_connector</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrus_connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cirrus_connector</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">connector</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cirrus_connector</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>

	<span class="n">drm_connector_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">cirrus_vga_connector_funcs</span><span class="p">,</span> <span class="n">DRM_MODE_CONNECTOR_VGA</span><span class="p">);</span>

	<span class="n">drm_connector_helper_add</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cirrus_vga_connector_helper_funcs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">connector</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">cirrus_modeset_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">drm_encoder</span> <span class="o">*</span><span class="n">encoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drm_connector</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">drm_mode_config_init</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">mode_config_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">CIRRUS_MAX_FB_WIDTH</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">CIRRUS_MAX_FB_HEIGHT</span><span class="p">;</span>

	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">fb_base</span> <span class="o">=</span> <span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">.</span><span class="n">vram_base</span><span class="p">;</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">preferred_depth</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="cm">/* don&#39;t prefer a shadow on virt GPU */</span>
	<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mode_config</span><span class="p">.</span><span class="n">prefer_shadow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cirrus_crtc_init</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">encoder</span> <span class="o">=</span> <span class="n">cirrus_encoder_init</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoder</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;cirrus_encoder_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">connector</span> <span class="o">=</span> <span class="n">cirrus_vga_init</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">connector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;cirrus_vga_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drm_mode_connector_attach_encoder</span><span class="p">(</span><span class="n">connector</span><span class="p">,</span> <span class="n">encoder</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cirrus_fbdev_init</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRM_ERROR</span><span class="p">(</span><span class="s">&quot;cirrus_fbdev_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cirrus_modeset_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">cirrus_device</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cirrus_fbdev_fini</span><span class="p">(</span><span class="n">cdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">mode_config_initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drm_mode_config_cleanup</span><span class="p">(</span><span class="n">cdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">mode_info</span><span class="p">.</span><span class="n">mode_config_initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
