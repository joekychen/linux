<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › power › ab8500_fg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ab8500_fg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson AB 2012</span>
<span class="cm"> *</span>
<span class="cm"> * Main and Back-up battery management driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Backup battery management is required in case of Li-Ion battery and not</span>
<span class="cm"> * for capacitive battery. HREF boards have capacitive battery and hence backup</span>
<span class="cm"> * battery management is not used and the supported code is available in this</span>
<span class="cm"> * driver.</span>
<span class="cm"> *</span>
<span class="cm"> * License Terms: GNU General Public License v2</span>
<span class="cm"> * Author:</span>
<span class="cm"> *	Johan Palsson &lt;johan.palsson@stericsson.com&gt;</span>
<span class="cm"> *	Karl Komierowski &lt;karl.komierowski@stericsson.com&gt;</span>
<span class="cm"> *	Arun R Murthy &lt;arun.murthy@stericsson.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500-bm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500-gpadc.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>

<span class="cp">#define MILLI_TO_MICRO			1000</span>
<span class="cp">#define FG_LSB_IN_MA			1627</span>
<span class="cp">#define QLSB_NANO_AMP_HOURS_X10		1129</span>
<span class="cp">#define INS_CURR_TIMEOUT		(3 * HZ)</span>

<span class="cp">#define SEC_TO_SAMPLE(S)		(S * 4)</span>

<span class="cp">#define NBR_AVG_SAMPLES			20</span>

<span class="cp">#define LOW_BAT_CHECK_INTERVAL		(2 * HZ)</span>

<span class="cp">#define VALID_CAPACITY_SEC		(45 * 60) </span><span class="cm">/* 45 minutes */</span><span class="cp"></span>
<span class="cp">#define BATT_OK_MIN			2360 </span><span class="cm">/* mV */</span><span class="cp"></span>
<span class="cp">#define BATT_OK_INCREMENT		50 </span><span class="cm">/* mV */</span><span class="cp"></span>
<span class="cp">#define BATT_OK_MAX_NR_INCREMENTS	0xE</span>

<span class="cm">/* FG constants */</span>
<span class="cp">#define BATT_OVV			0x01</span>

<span class="cp">#define interpolate(x, x1, y1, x2, y2) \</span>
<span class="cp">	((y1) + ((((y2) - (y1)) * ((x) - (x1))) / ((x2) - (x1))));</span>

<span class="cp">#define to_ab8500_fg_device_info(x) container_of((x), \</span>
<span class="cp">	struct ab8500_fg, fg_psy);</span>

<span class="cm">/**</span>
<span class="cm"> * struct ab8500_fg_interrupts - ab8500 fg interupts</span>
<span class="cm"> * @name:	name of the interrupt</span>
<span class="cm"> * @isr		function pointer to the isr</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_fg_interrupts</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span><span class="p">)(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ab8500_fg_discharge_state</span> <span class="p">{</span>
	<span class="n">AB8500_FG_DISCHARGE_INIT</span><span class="p">,</span>
	<span class="n">AB8500_FG_DISCHARGE_INITMEASURING</span><span class="p">,</span>
	<span class="n">AB8500_FG_DISCHARGE_INIT_RECOVERY</span><span class="p">,</span>
	<span class="n">AB8500_FG_DISCHARGE_RECOVERY</span><span class="p">,</span>
	<span class="n">AB8500_FG_DISCHARGE_READOUT_INIT</span><span class="p">,</span>
	<span class="n">AB8500_FG_DISCHARGE_READOUT</span><span class="p">,</span>
	<span class="n">AB8500_FG_DISCHARGE_WAKEUP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">discharge_state</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;DISCHARGE_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISCHARGE_INITMEASURING&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISCHARGE_INIT_RECOVERY&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISCHARGE_RECOVERY&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISCHARGE_READOUT_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISCHARGE_READOUT&quot;</span><span class="p">,</span>
	<span class="s">&quot;DISCHARGE_WAKEUP&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ab8500_fg_charge_state</span> <span class="p">{</span>
	<span class="n">AB8500_FG_CHARGE_INIT</span><span class="p">,</span>
	<span class="n">AB8500_FG_CHARGE_READOUT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">charge_state</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;CHARGE_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;CHARGE_READOUT&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ab8500_fg_calibration_state</span> <span class="p">{</span>
	<span class="n">AB8500_FG_CALIB_INIT</span><span class="p">,</span>
	<span class="n">AB8500_FG_CALIB_WAIT</span><span class="p">,</span>
	<span class="n">AB8500_FG_CALIB_END</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_fg_avg_cap</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">avg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">samples</span><span class="p">[</span><span class="n">NBR_AVG_SAMPLES</span><span class="p">];</span>
	<span class="n">__kernel_time_t</span> <span class="n">time_stamps</span><span class="p">[</span><span class="n">NBR_AVG_SAMPLES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbr_samples</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_fg_battery_capacity</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_mah_design</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_mah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">permille</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_mah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_percent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">user_mah</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_fg_flags</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">fg_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">conv_done</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">charging</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fully_charged</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">force_full</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">low_bat_delay</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">low_bat</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bat_ovv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">batt_unknown</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">calibrate</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">user_cap</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">batt_id_received</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">inst_curr_result_list</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct ab8500_fg - ab8500 FG device information</span>
<span class="cm"> * @dev:		Pointer to the structure device</span>
<span class="cm"> * @node:		a list of AB8500 FGs, hence prepared for reentrance</span>
<span class="cm"> * @irq			holds the CCEOC interrupt number</span>
<span class="cm"> * @vbat:		Battery voltage in mV</span>
<span class="cm"> * @vbat_nom:		Nominal battery voltage in mV</span>
<span class="cm"> * @inst_curr:		Instantenous battery current in mA</span>
<span class="cm"> * @avg_curr:		Average battery current in mA</span>
<span class="cm"> * @bat_temp		battery temperature</span>
<span class="cm"> * @fg_samples:		Number of samples used in the FG accumulation</span>
<span class="cm"> * @accu_charge:	Accumulated charge from the last conversion</span>
<span class="cm"> * @recovery_cnt:	Counter for recovery mode</span>
<span class="cm"> * @high_curr_cnt:	Counter for high current mode</span>
<span class="cm"> * @init_cnt:		Counter for init mode</span>
<span class="cm"> * @recovery_needed:	Indicate if recovery is needed</span>
<span class="cm"> * @high_curr_mode:	Indicate if we&#39;re in high current mode</span>
<span class="cm"> * @init_capacity:	Indicate if initial capacity measuring should be done</span>
<span class="cm"> * @turn_off_fg:	True if fg was off before current measurement</span>
<span class="cm"> * @calib_state		State during offset calibration</span>
<span class="cm"> * @discharge_state:	Current discharge state</span>
<span class="cm"> * @charge_state:	Current charge state</span>
<span class="cm"> * @ab8500_fg_complete	Completion struct used for the instant current reading</span>
<span class="cm"> * @flags:		Structure for information about events triggered</span>
<span class="cm"> * @bat_cap:		Structure for battery capacity specific parameters</span>
<span class="cm"> * @avg_cap:		Average capacity filter</span>
<span class="cm"> * @parent:		Pointer to the struct ab8500</span>
<span class="cm"> * @gpadc:		Pointer to the struct gpadc</span>
<span class="cm"> * @pdata:		Pointer to the abx500_fg platform data</span>
<span class="cm"> * @bat:		Pointer to the abx500_bm platform data</span>
<span class="cm"> * @fg_psy:		Structure that holds the FG specific battery properties</span>
<span class="cm"> * @fg_wq:		Work queue for running the FG algorithm</span>
<span class="cm"> * @fg_periodic_work:	Work to run the FG algorithm periodically</span>
<span class="cm"> * @fg_low_bat_work:	Work to check low bat condition</span>
<span class="cm"> * @fg_reinit_work	Work used to reset and reinitialise the FG algorithm</span>
<span class="cm"> * @fg_work:		Work to run the FG algorithm instantly</span>
<span class="cm"> * @fg_acc_cur_work:	Work to read the FG accumulator</span>
<span class="cm"> * @fg_check_hw_failure_work:	Work for checking HW state</span>
<span class="cm"> * @cc_lock:		Mutex for locking the CC</span>
<span class="cm"> * @fg_kobject:		Structure of type kobject</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vbat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vbat_nom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inst_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">avg_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bat_temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fg_samples</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">accu_charge</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recovery_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">high_curr_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">init_cnt</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">recovery_needed</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">high_curr_mode</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">init_capacity</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">turn_off_fg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ab8500_fg_calibration_state</span> <span class="n">calib_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ab8500_fg_discharge_state</span> <span class="n">discharge_state</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ab8500_fg_charge_state</span> <span class="n">charge_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">ab8500_fg_complete</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_flags</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_battery_capacity</span> <span class="n">bat_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_avg_cap</span> <span class="n">avg_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_gpadc</span> <span class="o">*</span><span class="n">gpadc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_fg_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_bm_data</span> <span class="o">*</span><span class="n">bat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="n">fg_psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">fg_wq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">fg_periodic_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">fg_low_bat_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">fg_reinit_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">fg_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">fg_acc_cur_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">fg_check_hw_failure_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">cc_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="n">fg_kobject</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ab8500_fg_list</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_get() - returns a reference to the primary AB8500 fuel gauge</span>
<span class="cm"> * (i.e. the first fuel gauge in the instance list)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="nf">ab8500_fg_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">fg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_fg_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fg</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_fg_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">fg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Main battery properties */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">ab8500_fg_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ENERGY_FULL_DESIGN</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ENERGY_FULL</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ENERGY_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CAPACITY_LEVEL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This array maps the raw hex value to lowbat voltage used by the AB8500</span>
<span class="cm"> * Values taken from the UM0836</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ab8500_fg_lowbat_voltage_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2300</span> <span class="p">,</span>
	<span class="mi">2325</span> <span class="p">,</span>
	<span class="mi">2350</span> <span class="p">,</span>
	<span class="mi">2375</span> <span class="p">,</span>
	<span class="mi">2400</span> <span class="p">,</span>
	<span class="mi">2425</span> <span class="p">,</span>
	<span class="mi">2450</span> <span class="p">,</span>
	<span class="mi">2475</span> <span class="p">,</span>
	<span class="mi">2500</span> <span class="p">,</span>
	<span class="mi">2525</span> <span class="p">,</span>
	<span class="mi">2550</span> <span class="p">,</span>
	<span class="mi">2575</span> <span class="p">,</span>
	<span class="mi">2600</span> <span class="p">,</span>
	<span class="mi">2625</span> <span class="p">,</span>
	<span class="mi">2650</span> <span class="p">,</span>
	<span class="mi">2675</span> <span class="p">,</span>
	<span class="mi">2700</span> <span class="p">,</span>
	<span class="mi">2725</span> <span class="p">,</span>
	<span class="mi">2750</span> <span class="p">,</span>
	<span class="mi">2775</span> <span class="p">,</span>
	<span class="mi">2800</span> <span class="p">,</span>
	<span class="mi">2825</span> <span class="p">,</span>
	<span class="mi">2850</span> <span class="p">,</span>
	<span class="mi">2875</span> <span class="p">,</span>
	<span class="mi">2900</span> <span class="p">,</span>
	<span class="mi">2925</span> <span class="p">,</span>
	<span class="mi">2950</span> <span class="p">,</span>
	<span class="mi">2975</span> <span class="p">,</span>
	<span class="mi">3000</span> <span class="p">,</span>
	<span class="mi">3025</span> <span class="p">,</span>
	<span class="mi">3050</span> <span class="p">,</span>
	<span class="mi">3075</span> <span class="p">,</span>
	<span class="mi">3100</span> <span class="p">,</span>
	<span class="mi">3125</span> <span class="p">,</span>
	<span class="mi">3150</span> <span class="p">,</span>
	<span class="mi">3175</span> <span class="p">,</span>
	<span class="mi">3200</span> <span class="p">,</span>
	<span class="mi">3225</span> <span class="p">,</span>
	<span class="mi">3250</span> <span class="p">,</span>
	<span class="mi">3275</span> <span class="p">,</span>
	<span class="mi">3300</span> <span class="p">,</span>
	<span class="mi">3325</span> <span class="p">,</span>
	<span class="mi">3350</span> <span class="p">,</span>
	<span class="mi">3375</span> <span class="p">,</span>
	<span class="mi">3400</span> <span class="p">,</span>
	<span class="mi">3425</span> <span class="p">,</span>
	<span class="mi">3450</span> <span class="p">,</span>
	<span class="mi">3475</span> <span class="p">,</span>
	<span class="mi">3500</span> <span class="p">,</span>
	<span class="mi">3525</span> <span class="p">,</span>
	<span class="mi">3550</span> <span class="p">,</span>
	<span class="mi">3575</span> <span class="p">,</span>
	<span class="mi">3600</span> <span class="p">,</span>
	<span class="mi">3625</span> <span class="p">,</span>
	<span class="mi">3650</span> <span class="p">,</span>
	<span class="mi">3675</span> <span class="p">,</span>
	<span class="mi">3700</span> <span class="p">,</span>
	<span class="mi">3725</span> <span class="p">,</span>
	<span class="mi">3750</span> <span class="p">,</span>
	<span class="mi">3775</span> <span class="p">,</span>
	<span class="mi">3800</span> <span class="p">,</span>
	<span class="mi">3825</span> <span class="p">,</span>
	<span class="mi">3850</span> <span class="p">,</span>
	<span class="mi">3850</span> <span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ab8500_volt_to_regval</span><span class="p">(</span><span class="kt">int</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">&lt;</span> <span class="n">ab8500_fg_lowbat_voltage_map</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_fg_lowbat_voltage_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">&lt;</span> <span class="n">ab8500_fg_lowbat_voltage_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If not captured above, return index of last element */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_fg_lowbat_voltage_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_is_low_curr() - Low or high current mode</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @curr:	the current to base or our decision on</span>
<span class="cm"> *</span>
<span class="cm"> * Low current mode if the current consumption is below a certain threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_is_low_curr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * We want to know if we&#39;re in low current mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">high_curr_threshold</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_add_cap_sample() - Add capacity to average filter</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @sample:	the capacity in mAh to add to the filter</span>
<span class="cm"> *</span>
<span class="cm"> * A capacity is added to the filter and a new mean capacity is calculated and</span>
<span class="cm"> * returned</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_add_cap_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_avg_cap</span> <span class="o">*</span><span class="n">avg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">avg_cap</span><span class="p">;</span>

	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">+=</span> <span class="n">sample</span> <span class="o">-</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">[</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">];</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">[</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">;</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">time_stamps</span><span class="p">[</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">==</span> <span class="n">NBR_AVG_SAMPLES</span><span class="p">)</span>
			<span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">nbr_samples</span> <span class="o">&lt;</span> <span class="n">NBR_AVG_SAMPLES</span><span class="p">)</span>
			<span class="n">avg</span><span class="o">-&gt;</span><span class="n">nbr_samples</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check the time stamp for each sample. If too old,</span>
<span class="cm">		 * replace with latest sample</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">VALID_CAPACITY_SEC</span> <span class="o">&gt;</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">time_stamps</span><span class="p">[</span><span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">]);</span>

	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">avg</span> <span class="o">=</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">/</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">nbr_samples</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">avg</span><span class="o">-&gt;</span><span class="n">avg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_clear_cap_samples() - Clear average filter</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * The capacity filter is is reset to zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_clear_cap_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_avg_cap</span> <span class="o">*</span><span class="n">avg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">avg_cap</span><span class="p">;</span>

	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">nbr_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBR_AVG_SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">time_stamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_fill_cap_sample() - Fill average filter</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @sample:	the capacity in mAh to fill the filter with</span>
<span class="cm"> *</span>
<span class="cm"> * The capacity filter is filled with a capacity in mAh</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_fill_cap_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_avg_cap</span> <span class="o">*</span><span class="n">avg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">avg_cap</span><span class="p">;</span>

	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBR_AVG_SAMPLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">;</span>
		<span class="n">avg</span><span class="o">-&gt;</span><span class="n">time_stamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">nbr_samples</span> <span class="o">=</span> <span class="n">NBR_AVG_SAMPLES</span><span class="p">;</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">sum</span> <span class="o">=</span> <span class="n">sample</span> <span class="o">*</span> <span class="n">NBR_AVG_SAMPLES</span><span class="p">;</span>
	<span class="n">avg</span><span class="o">-&gt;</span><span class="n">avg</span> <span class="o">=</span> <span class="n">sample</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_coulomb_counter() - enable coulomb counter</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @enable:	enable/disable</span>
<span class="cm"> *</span>
<span class="cm"> * Enable/Disable coulomb counter.</span>
<span class="cm"> * On failure returns negative value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* To be able to reprogram the number of samples, we have to</span>
<span class="cm">		 * first stop the CC and then enable it again */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
			<span class="n">AB8500_RTC_CC_CONF_REG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cc_err</span><span class="p">;</span>

		<span class="cm">/* Program the samples */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_NCOV_ACCU</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cc_err</span><span class="p">;</span>

		<span class="cm">/* Start the CC */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
			<span class="n">AB8500_RTC_CC_CONF_REG</span><span class="p">,</span>
			<span class="p">(</span><span class="n">CC_DEEP_SLEEP_ENA</span> <span class="o">|</span> <span class="n">CC_PWR_UP_ENA</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cc_err</span><span class="p">;</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fg_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Clear any pending read requests */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_CTRL_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cc_err</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_NCOV_ACCU_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cc_err</span><span class="p">;</span>

		<span class="cm">/* Stop the CC */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
			<span class="n">AB8500_RTC_CC_CONF_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">cc_err</span><span class="p">;</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fg_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; CC enabled: %d Samples: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">enable</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="nl">cc_err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Enabling coulomb counter failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_inst_curr_start() - start battery instantaneous current</span>
<span class="cm"> * @di:         pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 or error code</span>
<span class="cm"> * Note: This is part &quot;one&quot; and has to be called before</span>
<span class="cm"> * ab8500_fg_inst_curr_finalize()</span>
<span class="cm"> */</span>
 <span class="kt">int</span> <span class="nf">ab8500_fg_inst_curr_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg_val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
		<span class="n">AB8500_RTC_CC_CONF_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg_val</span> <span class="o">&amp;</span> <span class="n">CC_PWR_UP_ENA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Enable FG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">turn_off_fg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/* Program the samples */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_NCOV_ACCU</span><span class="p">,</span>
			<span class="n">SEC_TO_SAMPLE</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="cm">/* Start the CC */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
			<span class="n">AB8500_RTC_CC_CONF_REG</span><span class="p">,</span>
			<span class="p">(</span><span class="n">CC_DEEP_SLEEP_ENA</span> <span class="o">|</span> <span class="n">CC_PWR_UP_ENA</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">turn_off_fg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return and WFI */</span>
	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ab8500_fg_complete</span><span class="p">);</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Note: cc_lock is still locked */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_inst_curr_done() - check if fg conversion is done</span>
<span class="cm"> * @di:         pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if conversion done, 0 if still waiting</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ab8500_fg_inst_curr_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">completion_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ab8500_fg_complete</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_inst_curr_finalize() - battery instantaneous current</span>
<span class="cm"> * @di:         pointer to the ab8500_fg structure</span>
<span class="cm"> * @res:	battery instantenous current(on success)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 or an error code</span>
<span class="cm"> * Note: This is part &quot;two&quot; and has to be called at earliest 250 ms</span>
<span class="cm"> * after ab8500_fg_inst_curr_start()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ab8500_fg_inst_curr_finalize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">completion_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ab8500_fg_complete</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ab8500_fg_complete</span><span class="p">,</span>
			<span class="n">INS_CURR_TIMEOUT</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Finalize time: %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="n">INS_CURR_TIMEOUT</span> <span class="o">-</span> <span class="n">timeout</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;completion timed out [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__LINE__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_CTRL_REG</span><span class="p">,</span>
			<span class="n">READ_REQ</span><span class="p">,</span> <span class="n">READ_REQ</span><span class="p">);</span>

	<span class="cm">/* 100uS between read request and read is needed */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Read CC Sample conversion value Low and high */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span>
		<span class="n">AB8500_GASG_CC_SMPL_CNVL_REG</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">low</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span>
		<span class="n">AB8500_GASG_CC_SMPL_CNVH_REG</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">high</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * negative value for Discharging</span>
<span class="cm">	 * convert 2&#39;s compliment into decimal</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">|</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xFFFFE000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">|</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert to unit value in mA</span>
<span class="cm">	 * Full scale input voltage is</span>
<span class="cm">	 * 66.660mV =&gt; LSB = 66.660mV/(4096*res) = 1.627mA</span>
<span class="cm">	 * Given a 250ms conversion cycle time the LSB corresponds</span>
<span class="cm">	 * to 112.9 nAh. Convert to current by dividing by the conversion</span>
<span class="cm">	 * time in hours (250ms = 1 / (3600 * 4)h)</span>
<span class="cm">	 * 112.9nAh assumes 10mOhm, but fg_res is in 0.1mOhm</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">QLSB_NANO_AMP_HOURS_X10</span> <span class="o">*</span> <span class="mi">36</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">turn_off_fg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Disable FG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* Clear any pending read requests */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_CTRL_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="cm">/* Stop the CC */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_RTC</span><span class="p">,</span>
			<span class="n">AB8500_RTC_CC_CONF_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_inst_curr_blocking() - battery instantaneous current</span>
<span class="cm"> * @di:         pointer to the ab8500_fg structure</span>
<span class="cm"> * @res:	battery instantenous current(on success)</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 else error code</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ab8500_fg_inst_curr_blocking</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_start</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize fg_inst</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_finalize</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to finalize fg_inst</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_acc_cur_work() - average battery current</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Updated the average battery current obtained from the</span>
<span class="cm"> * coulomb counter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_acc_cur_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">low</span><span class="p">,</span> <span class="n">med</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span> <span class="n">fg_acc_cur_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span>
		<span class="n">AB8500_GASG_CC_NCOV_ACCU_CTRL</span><span class="p">,</span> <span class="n">RD_NCONV_ACCU_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span>
		<span class="n">AB8500_GASG_CC_NCOV_ACCU_LOW</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">low</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span>
		<span class="n">AB8500_GASG_CC_NCOV_ACCU_MED</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">med</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span>
		<span class="n">AB8500_GASG_CC_NCOV_ACCU_HIGH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">high</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* Check for sign bit in case of negative value, 2&#39;s compliment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">|</span> <span class="p">(</span><span class="n">med</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xFFE00000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">|</span> <span class="p">(</span><span class="n">med</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert to uAh</span>
<span class="cm">	 * Given a 250ms conversion cycle time the LSB corresponds</span>
<span class="cm">	 * to 112.9 nAh.</span>
<span class="cm">	 * 112.9nAh assumes 10mOhm, but fg_res is in 0.1mOhm</span>
<span class="cm">	 */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">QLSB_NANO_AMP_HOURS_X10</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_res</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert to unit value in mA</span>
<span class="cm">	 * Full scale input voltage is</span>
<span class="cm">	 * 66.660mV =&gt; LSB = 66.660mV/(4096*res) = 1.627mA</span>
<span class="cm">	 * Given a 250ms conversion cycle time the LSB corresponds</span>
<span class="cm">	 * to 112.9 nAh. Convert to current by dividing by the conversion</span>
<span class="cm">	 * time in hours (= samples / (3600 * 4)h)</span>
<span class="cm">	 * 112.9nAh assumes 10mOhm, but fg_res is in 0.1mOhm</span>
<span class="cm">	 */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">avg_curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="n">QLSB_NANO_AMP_HOURS_X10</span> <span class="o">*</span> <span class="mi">36</span><span class="p">)</span> <span class="o">/</span>
		<span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_res</span> <span class="o">*</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">/</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">conv_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_work</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Failed to read or write gas gauge registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_bat_voltage() - get battery voltage</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns battery voltage(on success) else error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_bat_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vbat</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">prev</span><span class="p">;</span>

	<span class="n">vbat</span> <span class="o">=</span> <span class="n">ab8500_gpadc_convert</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span><span class="p">,</span> <span class="n">MAIN_BAT_V</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vbat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s gpadc conversion failed, using previous value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="n">vbat</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">vbat</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_volt_to_capacity() - Voltage based capacity</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @voltage:	The voltage to convert to a capacity</span>
<span class="cm"> *</span>
<span class="cm"> * Returns battery capacity in per mille based on voltage</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_volt_to_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tbl_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_v_to_cap</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">v_to_cap_tbl</span><span class="p">,</span>
	<span class="n">tbl_size</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">n_v_cap_tbl_elements</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">voltage</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">voltage</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">voltage</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">capacity</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">voltage</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">capacity</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Vbat: %d, Cap: %d per mille&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">voltage</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cap</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_uncomp_volt_to_capacity() - Uncompensated voltage based capacity</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns battery capacity based on battery voltage that is not compensated</span>
<span class="cm"> * for the voltage drop due to the load</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_uncomp_volt_to_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">=</span> <span class="n">ab8500_fg_bat_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ab8500_fg_volt_to_capacity</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_battery_resistance() - Returns the battery inner resistance</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns battery inner resistance added with the fuel gauge resistor value</span>
<span class="cm"> * to get the total resistance in the whole link from gnd to bat+ node.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_battery_resistance</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tbl_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">batres_vs_temp</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">batres_tbl</span><span class="p">;</span>
	<span class="n">tbl_size</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">n_batres_tbl_elements</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temp</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">resist</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temp</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resist</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">temp</span><span class="p">,</span>
			<span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">resist</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resist</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">resist</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">resist</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">tbl_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">resist</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Temp: %d battery internal resistance: %d&quot;</span>
	    <span class="s">&quot; fg resistance %d, total: %d (mOhm)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span><span class="p">,</span> <span class="n">resist</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_res</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_res</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="n">resist</span><span class="p">);</span>

	<span class="cm">/* fg_res variable is in 0.1mOhm */</span>
	<span class="n">resist</span> <span class="o">+=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_res</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">resist</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_load_comp_volt_to_capacity() - Load compensated voltage based capacity</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns battery capacity based on battery voltage that is load compensated</span>
<span class="cm"> * for the voltage drop</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_load_comp_volt_to_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vbat_comp</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vbat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ab8500_fg_inst_curr_start</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">vbat</span> <span class="o">+=</span> <span class="n">ab8500_fg_bat_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500_fg_inst_curr_done</span><span class="p">(</span><span class="n">di</span><span class="p">));</span>

	<span class="n">ab8500_fg_inst_curr_finalize</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">=</span> <span class="n">vbat</span> <span class="o">/</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">ab8500_fg_battery_resistance</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="cm">/* Use Ohms law to get the load compensated voltage */</span>
	<span class="n">vbat_comp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">-</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span> <span class="o">*</span> <span class="n">res</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Measured Vbat: %dmV,Compensated Vbat %dmV, &quot;</span>
		<span class="s">&quot;R: %dmOhm, Current: %dmA Vbat Samples: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span><span class="p">,</span> <span class="n">vbat_comp</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ab8500_fg_volt_to_capacity</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">vbat_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_convert_mah_to_permille() - Capacity in mAh to permille</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @cap_mah:	capacity in mAh</span>
<span class="cm"> *</span>
<span class="cm"> * Converts capacity in mAh to capacity in permille</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_convert_mah_to_permille</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cap_mah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">cap_mah</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_convert_permille_to_mah() - Capacity in permille to mAh</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @cap_pm:	capacity in permille</span>
<span class="cm"> *</span>
<span class="cm"> * Converts capacity in permille to capacity in mAh</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_convert_permille_to_mah</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cap_pm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cap_pm</span> <span class="o">*</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_convert_mah_to_uwh() - Capacity in mAh to uWh</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @cap_mah:	capacity in mAh</span>
<span class="cm"> *</span>
<span class="cm"> * Converts capacity in mAh to capacity in uWh</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_convert_mah_to_uwh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cap_mah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">div_res</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">div_rem</span><span class="p">;</span>

	<span class="n">div_res</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">cap_mah</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat_nom</span><span class="p">);</span>
	<span class="n">div_rem</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">div_res</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Make sure to round upwards if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">div_rem</span> <span class="o">&gt;=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">div_res</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">div_res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_calc_cap_charging() - Calculate remaining capacity while charging</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Return the capacity in mAh based on previous calculated capcity and the FG</span>
<span class="cm"> * accumulator register value. The filter is filled with this capacity</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_calc_cap_charging</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s cap_mah %d accu_charge %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span><span class="p">);</span>

	<span class="cm">/* Capacity should not be less than 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">+=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We force capacity to 100% once when the algorithm</span>
<span class="cm">	 * reports that it&#39;s full.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">&gt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span> <span class="o">||</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">force_full</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab8500_fg_fill_cap_sample</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">=</span>
		<span class="n">ab8500_fg_convert_mah_to_permille</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>

	<span class="cm">/* We need to update battery voltage and inst current when charging */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">=</span> <span class="n">ab8500_fg_bat_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_blocking</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_calc_cap_discharge_voltage() - Capacity in discharge with voltage</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @comp:	if voltage should be load compensated before capacity calc</span>
<span class="cm"> *</span>
<span class="cm"> * Return the capacity in mAh based on the battery voltage. The voltage can</span>
<span class="cm"> * either be load compensated or not. This value is added to the filter and a</span>
<span class="cm"> * new mean value is calculated and returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_calc_cap_discharge_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">bool</span> <span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">permille</span><span class="p">,</span> <span class="n">mah</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="p">)</span>
		<span class="n">permille</span> <span class="o">=</span> <span class="n">ab8500_fg_load_comp_volt_to_capacity</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">permille</span> <span class="o">=</span> <span class="n">ab8500_fg_uncomp_volt_to_capacity</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="n">mah</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_permille_to_mah</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">permille</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="n">ab8500_fg_add_cap_sample</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">mah</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">=</span>
		<span class="n">ab8500_fg_convert_mah_to_permille</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_calc_cap_discharge_fg() - Capacity in discharge with FG</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Return the capacity in mAh based on previous calculated capcity and the FG</span>
<span class="cm"> * accumulator register value. This value is added to the filter and a</span>
<span class="cm"> * new mean value is calculated and returned.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_calc_cap_discharge_fg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">permille_volt</span><span class="p">,</span> <span class="n">permille</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s cap_mah %d accu_charge %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span><span class="p">);</span>

	<span class="cm">/* Capacity should not be less than 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">+=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">&gt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check against voltage based capacity. It can not be lower</span>
<span class="cm">	 * than what the uncompensated voltage says</span>
<span class="cm">	 */</span>
	<span class="n">permille</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_mah_to_permille</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>
	<span class="n">permille_volt</span> <span class="o">=</span> <span class="n">ab8500_fg_uncomp_volt_to_capacity</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">permille</span> <span class="o">&lt;</span> <span class="n">permille_volt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">=</span> <span class="n">permille_volt</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_permille_to_mah</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s voltage based: perm %d perm_volt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="n">permille</span><span class="p">,</span>
			<span class="n">permille_volt</span><span class="p">);</span>

		<span class="n">ab8500_fg_fill_cap_sample</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ab8500_fg_fill_cap_sample</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">=</span>
			<span class="n">ab8500_fg_convert_mah_to_permille</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_capacity_level() - Get the battery capacity level</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Get the battery capacity level based on the capacity in percent</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_capacity_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">percent</span><span class="p">;</span>

	<span class="n">percent</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">cap_levels</span><span class="o">-&gt;</span><span class="n">critical</span> <span class="o">||</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">low_bat</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">cap_levels</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_LOW</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">cap_levels</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_NORMAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">percent</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">cap_levels</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_HIGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_FULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_check_capacity_limits() - Check if capacity has changed</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> * @init:	capacity is allowed to go up in init mode</span>
<span class="cm"> *</span>
<span class="cm"> * Check if capacity or capacity limit has changed and notify the system</span>
<span class="cm"> * about it using the power_supply framework</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="n">bool</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">ab8500_fg_capacity_level</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We do not allow reported capacity level to go up</span>
<span class="cm">		 * unless we&#39;re charging or if we&#39;re in init</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">level</span> <span class="o">&gt;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_level</span><span class="p">)</span> <span class="o">||</span> <span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;level changed from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_level</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_level</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;level not allowed to go up &quot;</span>
				<span class="s">&quot;since no charger is connected: %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_level</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have received the LOW_BAT IRQ, set capacity to 0 to initiate</span>
<span class="cm">	 * shutdown</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">low_bat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery low, set capacity to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fully_charged</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We report 100% if algorithm reported fully charged</span>
<span class="cm">		 * unless capacity drops too much</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">force_full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">force_full</span> <span class="o">&amp;&amp;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span> <span class="o">!=</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">maint_thres</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;battery reported full &quot;</span>
				<span class="s">&quot;but capacity dropping: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">;</span>

			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span> <span class="o">!=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We will not report 0% unless we&#39;ve got</span>
<span class="cm">			 * the LOW_BAT IRQ, no matter what the FG</span>
<span class="cm">			 * algorithm says.</span>
<span class="cm">			 */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&gt;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span><span class="p">)</span> <span class="o">||</span> <span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We do not allow reported capacity to go up</span>
<span class="cm">			 * unless we&#39;re charging or if we&#39;re in init</span>
<span class="cm">			 */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;capacity changed from %d to %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">;</span>

			<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;capacity not allowed to go up since &quot;</span>
				<span class="s">&quot;no charger is connected: %d to %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fully_charged</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">force_full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery full, notifying.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">force_full</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_kobject</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;charge_full&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_kobject</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;charge_now&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_charge_state_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ab8500_fg_charge_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Charge state from %d [%s] to %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">,</span>
		<span class="n">charge_state</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">],</span>
		<span class="n">new_state</span><span class="p">,</span>
		<span class="n">charge_state</span><span class="p">[</span><span class="n">new_state</span><span class="p">]);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ab8500_fg_discharge_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disharge state from %d [%s] to %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">discharge_state</span><span class="p">,</span>
		<span class="n">discharge_state</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">discharge_state</span><span class="p">],</span>
		<span class="n">new_state</span><span class="p">,</span>
		<span class="n">discharge_state</span><span class="p">[</span><span class="n">new_state</span><span class="p">]);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">discharge_state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_algorithm_charging() - FG algorithm for when charging</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Battery capacity calculation state machine for when we&#39;re charging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_algorithm_charging</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we change to discharge mode</span>
<span class="cm">	 * we should start with recovery</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">discharge_state</span> <span class="o">!=</span> <span class="n">AB8500_FG_DISCHARGE_INIT_RECOVERY</span><span class="p">)</span>
		<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">AB8500_FG_DISCHARGE_INIT_RECOVERY</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AB8500_FG_CHARGE_INIT</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">=</span> <span class="n">SEC_TO_SAMPLE</span><span class="p">(</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">accu_charging</span><span class="p">);</span>

		<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ab8500_fg_charge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">AB8500_FG_CHARGE_READOUT</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AB8500_FG_CHARGE_READOUT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Read the FG and calculate the new capacity</span>
<span class="cm">		 */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">conv_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Wasn&#39;t the CC IRQ that got us here */</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s CC conv not done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">conv_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

		<span class="n">ab8500_fg_calc_cap_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check capacity limits */</span>
	<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">force_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cap</span><span class="p">;</span>

	<span class="n">ab8500_fg_clear_cap_samples</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">cap</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">user_mah</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Remaining cap %d can&#39;t be bigger than total&quot;</span>
			<span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">);</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ab8500_fg_fill_cap_sample</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">user_mah</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_mah_to_permille</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
	<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_sysfs_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cap</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cap_permille</span><span class="p">;</span>

	<span class="n">cap</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">user_mah</span><span class="p">;</span>

	<span class="n">cap_permille</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_mah_to_permille</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">user_mah</span><span class="p">);</span>

	<span class="n">lower</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">user_cap_limit</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">user_cap_limit</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">lower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* 1000 is permille, -&gt; 100 percent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">upper</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">upper</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Capacity limits:&quot;</span>
		<span class="s">&quot; (Lower: %d User: %d Upper: %d) [user: %d, was: %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">lower</span><span class="p">,</span> <span class="n">cap_permille</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">);</span>

	<span class="cm">/* If within limits, use the saved capacity and exit estimation...*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap_permille</span> <span class="o">&gt;</span> <span class="n">lower</span> <span class="o">&amp;&amp;</span> <span class="n">cap_permille</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OK! Using users cap %d uAh now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="n">force_capacity</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Capacity from user out of limits, ignoring&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_algorithm_discharging() - FG algorithm for when discharging</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Battery capacity calculation state machine for when we&#39;re discharging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_algorithm_discharging</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sleep_time</span><span class="p">;</span>

	<span class="cm">/* If we change to charge mode we should start with init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">AB8500_FG_CHARGE_INIT</span><span class="p">)</span>
		<span class="n">ab8500_fg_charge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">AB8500_FG_CHARGE_INIT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">discharge_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AB8500_FG_DISCHARGE_INIT</span>:
		<span class="cm">/* We use the FG IRQ to work on */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">init_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">=</span> <span class="n">SEC_TO_SAMPLE</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">init_timer</span><span class="p">);</span>
		<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">AB8500_FG_DISCHARGE_INITMEASURING</span><span class="p">);</span>

		<span class="cm">/* Intentional fallthrough */</span>
	<span class="k">case</span> <span class="n">AB8500_FG_DISCHARGE_INITMEASURING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Discard a number of samples during startup.</span>
<span class="cm">		 * After that, use compensated voltage for a few</span>
<span class="cm">		 * samples to get an initial capacity.</span>
<span class="cm">		 * Then go to READOUT</span>
<span class="cm">		 */</span>
		<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">init_timer</span><span class="p">;</span>

		<span class="cm">/* Discard the first [x] seconds */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">init_cnt</span> <span class="o">&gt;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">init_discard_time</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ab8500_fg_calc_cap_discharge_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">init_cnt</span> <span class="o">+=</span> <span class="n">sleep_time</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">init_cnt</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">init_total_time</span><span class="p">)</span>
			<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">AB8500_FG_DISCHARGE_READOUT_INIT</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AB8500_FG_DISCHARGE_INIT_RECOVERY</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_needed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">AB8500_FG_DISCHARGE_RECOVERY</span><span class="p">);</span>

		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">AB8500_FG_DISCHARGE_RECOVERY</span>:
		<span class="n">sleep_time</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">recovery_sleep_timer</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We should check the power consumption</span>
<span class="cm">		 * If low, go to READOUT (after x min) or</span>
<span class="cm">		 * RECOVERY_SLEEP if time left.</span>
<span class="cm">		 * If high, go to READOUT</span>
<span class="cm">		 */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_blocking</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ab8500_fg_is_low_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_cnt</span> <span class="o">&gt;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">recovery_total_time</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">=</span> <span class="n">SEC_TO_SAMPLE</span><span class="p">(</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">accu_high_curr</span><span class="p">);</span>
				<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">AB8500_FG_DISCHARGE_READOUT</span><span class="p">);</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_needed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span>
					<span class="n">sleep_time</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_cnt</span> <span class="o">+=</span> <span class="n">sleep_time</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">=</span> <span class="n">SEC_TO_SAMPLE</span><span class="p">(</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">accu_high_curr</span><span class="p">);</span>
			<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">AB8500_FG_DISCHARGE_READOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AB8500_FG_DISCHARGE_READOUT_INIT</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">=</span> <span class="n">SEC_TO_SAMPLE</span><span class="p">(</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">accu_high_curr</span><span class="p">);</span>
		<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">AB8500_FG_DISCHARGE_READOUT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AB8500_FG_DISCHARGE_READOUT</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_blocking</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ab8500_fg_is_low_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Detect mode change */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_needed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">AB8500_FG_DISCHARGE_RECOVERY</span><span class="p">);</span>

				<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ab8500_fg_calc_cap_discharge_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">conv_done</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Wasn&#39;t the CC IRQ that got us here */</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s CC conv not done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">conv_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

			<span class="cm">/* Detect mode change */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_cnt</span> <span class="o">+=</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">accu_high_curr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_cnt</span> <span class="o">&gt;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">high_curr_time</span><span class="p">)</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_needed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">ab8500_fg_calc_cap_discharge_fg</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AB8500_FG_DISCHARGE_WAKEUP</span>:
		<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_blocking</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

		<span class="n">ab8500_fg_calc_cap_discharge_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">=</span> <span class="n">SEC_TO_SAMPLE</span><span class="p">(</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">accu_high_curr</span><span class="p">);</span>
		<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">AB8500_FG_DISCHARGE_READOUT</span><span class="p">);</span>

		<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_algorithm_calibrate() - Internal columb counter offset calibration</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_algorithm_calibrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">calib_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AB8500_FG_CALIB_INIT</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Calibration ongoing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_CTRL_REG</span><span class="p">,</span>
			<span class="n">CC_INT_CAL_N_AVG_MASK</span><span class="p">,</span> <span class="n">CC_INT_CAL_SAMPLES_8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_CTRL_REG</span><span class="p">,</span>
			<span class="n">CC_INTAVGOFFSET_ENA</span><span class="p">,</span> <span class="n">CC_INTAVGOFFSET_ENA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">calib_state</span> <span class="o">=</span> <span class="n">AB8500_FG_CALIB_WAIT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AB8500_FG_CALIB_END</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_GAS_GAUGE</span><span class="p">,</span> <span class="n">AB8500_GASG_CC_CTRL_REG</span><span class="p">,</span>
			<span class="n">CC_MUXOFFSET</span><span class="p">,</span> <span class="n">CC_MUXOFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">calibrate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Calibration done...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AB8500_FG_CALIB_WAIT</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Calibration WFI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="cm">/* Something went wrong, don&#39;t calibrate then */</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to calibrate the CC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">calibrate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">calib_state</span> <span class="o">=</span> <span class="n">AB8500_FG_CALIB_INIT</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_algorithm() - Entry point for the FG algorithm</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Entry point for the battery capacity calculation state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_algorithm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">calibrate</span><span class="p">)</span>
		<span class="n">ab8500_fg_algorithm_calibrate</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span><span class="p">)</span>
			<span class="n">ab8500_fg_algorithm_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ab8500_fg_algorithm_discharging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;[FG_DATA] %d %d %d %d %d %d %d %d %d &quot;</span>
		<span class="s">&quot;%d %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">permille</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">level</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_level</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">avg_curr</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">accu_charge</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">discharge_state</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">high_curr_mode</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">recovery_needed</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_periodic_work() - Run the FG state machine periodically</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for periodic work</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_periodic_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span>
		<span class="n">fg_periodic_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">init_capacity</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* A dummy read that will return 0 */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_blocking</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="cm">/* Get an initial capacity calculation */</span>
		<span class="n">ab8500_fg_calc_cap_discharge_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">init_capacity</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">user_cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_sysfs_capacity</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span><span class="p">)</span>
				<span class="n">ab8500_fg_charge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">AB8500_FG_CHARGE_INIT</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">AB8500_FG_DISCHARGE_READOUT_INIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">user_cap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ab8500_fg_algorithm</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_check_hw_failure_work() - Check OVV_BAT condition</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for checking the OVV_BAT condition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_check_hw_failure_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_value</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span>
		<span class="n">fg_check_hw_failure_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have had a battery over-voltage situation,</span>
<span class="cm">	 * check ovv-bit to see if it should be reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bat_ovv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_CH_STAT_REG</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">reg_value</span> <span class="o">&amp;</span> <span class="n">BATT_OVV</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BATT_OVV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery recovered from OVV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bat_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Not yet recovered from ovv, reschedule this test */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_check_hw_failure_work</span><span class="p">,</span>
				   <span class="n">round_jiffies</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_low_bat_work() - Check LOW_BAT condition</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for checking the LOW_BAT condition</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_low_bat_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vbat</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span>
		<span class="n">fg_low_bat_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">vbat</span> <span class="o">=</span> <span class="n">ab8500_fg_bat_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="cm">/* Check if LOW_BAT still fulfilled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vbat</span> <span class="o">&lt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">lowbat_threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">low_bat</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery voltage still LOW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need to re-schedule this check to be able to detect</span>
<span class="cm">		 * if the voltage increases again during charging</span>
<span class="cm">		 */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_low_bat_work</span><span class="p">,</span>
			<span class="n">round_jiffies</span><span class="p">(</span><span class="n">LOW_BAT_CHECK_INTERVAL</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">low_bat</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery voltage OK again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This is needed to dispatch LOW_BAT */</span>
	<span class="n">ab8500_fg_check_capacity_limits</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Set this flag to check if LOW_BAT IRQ still occurs */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">low_bat_delay</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_battok_calc - calculate the bit pattern corresponding</span>
<span class="cm"> * to the target voltage.</span>
<span class="cm"> * @di:       pointer to the ab8500_fg structure</span>
<span class="cm"> * @target    target voltage</span>
<span class="cm"> *</span>
<span class="cm"> * Returns bit pattern closest to the target voltage</span>
<span class="cm"> * valid return values are 0-14. (0-BATT_OK_MAX_NR_INCREMENTS)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_battok_calc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&gt;</span> <span class="n">BATT_OK_MIN</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">BATT_OK_INCREMENT</span> <span class="o">*</span> <span class="n">BATT_OK_MAX_NR_INCREMENTS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BATT_OK_MAX_NR_INCREMENTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;</span> <span class="n">BATT_OK_MIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">BATT_OK_MIN</span><span class="p">)</span> <span class="o">/</span> <span class="n">BATT_OK_INCREMENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_battok_init_hw_register - init battok levels</span>
<span class="cm"> * @di:       pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_battok_init_hw_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">selected</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sel0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sel1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cbp_sel0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cbp_sel1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_val</span><span class="p">;</span>

	<span class="n">sel0</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">battok_falling_th_sel0</span><span class="p">;</span>
	<span class="n">sel1</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">battok_raising_th_sel1</span><span class="p">;</span>

	<span class="n">cbp_sel0</span> <span class="o">=</span> <span class="n">ab8500_fg_battok_calc</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">sel0</span><span class="p">);</span>
	<span class="n">cbp_sel1</span> <span class="o">=</span> <span class="n">ab8500_fg_battok_calc</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">sel1</span><span class="p">);</span>

	<span class="n">selected</span> <span class="o">=</span> <span class="n">BATT_OK_MIN</span> <span class="o">+</span> <span class="n">cbp_sel0</span> <span class="o">*</span> <span class="n">BATT_OK_INCREMENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">selected</span> <span class="o">!=</span> <span class="n">sel0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid voltage step:%d, using %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sel0</span><span class="p">,</span> <span class="n">selected</span><span class="p">,</span> <span class="n">cbp_sel0</span><span class="p">);</span>

	<span class="n">selected</span> <span class="o">=</span> <span class="n">BATT_OK_MIN</span> <span class="o">+</span> <span class="n">cbp_sel1</span> <span class="o">*</span> <span class="n">BATT_OK_INCREMENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">selected</span> <span class="o">!=</span> <span class="n">sel1</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Invalid voltage step:%d, using %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sel1</span><span class="p">,</span> <span class="n">selected</span><span class="p">,</span> <span class="n">cbp_sel1</span><span class="p">);</span>

	<span class="n">new_val</span> <span class="o">=</span> <span class="n">cbp_sel0</span> <span class="o">|</span> <span class="p">(</span><span class="n">cbp_sel1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using: %x %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">cbp_sel0</span><span class="p">,</span> <span class="n">cbp_sel1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_BATT_OK_REG</span><span class="p">,</span> <span class="n">new_val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_instant_work() - Run the FG state machine instantly</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for instant work</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_instant_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span> <span class="n">fg_work</span><span class="p">);</span>

	<span class="n">ab8500_fg_algorithm</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_cc_data_end_handler() - isr to get battery avg current.</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_fg_cc_data_end_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ab8500_fg_complete</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_cc_convend_handler() - isr to get battery avg current.</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_fg_cc_int_calib_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">calib_state</span> <span class="o">=</span> <span class="n">AB8500_FG_CALIB_END</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_cc_convend_handler() - isr to get battery avg current.</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_fg_cc_convend_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_acc_cur_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_batt_ovv_handler() - Battery OVV occured</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_fg_batt_ovv_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery OVV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bat_ovv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">);</span>

	<span class="cm">/* Schedule a new HW failure check */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_check_hw_failure_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_lowbatf_handler() - Battery voltage is below LOW threshold</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_fg_lowbatf_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">low_bat_delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery voltage is below LOW threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">low_bat_delay</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Start a timer to check LOW_BAT again after some time</span>
<span class="cm">		 * This is done to avoid shutdown on single voltage dips</span>
<span class="cm">		 */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_low_bat_work</span><span class="p">,</span>
			<span class="n">round_jiffies</span><span class="p">(</span><span class="n">LOW_BAT_CHECK_INTERVAL</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_get_property() - get the fg properties</span>
<span class="cm"> * @psy:	pointer to the power_supply structure</span>
<span class="cm"> * @psp:	pointer to the power_supply_property structure</span>
<span class="cm"> * @val:	pointer to the power_supply_propval union</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when an application tries to get the</span>
<span class="cm"> * fg properties by reading the sysfs files.</span>
<span class="cm"> * voltage_now:		battery voltage</span>
<span class="cm"> * current_now:		battery instant current</span>
<span class="cm"> * current_avg:		battery average current</span>
<span class="cm"> * charge_full_design:	capacity where battery is considered full</span>
<span class="cm"> * charge_now:		battery capacity in nAh</span>
<span class="cm"> * capacity:		capacity in percent</span>
<span class="cm"> * capacity_level:	capacity level</span>
<span class="cm"> *</span>
<span class="cm"> * Returns error code in case of failure else 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_fg_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If battery is identified as unknown and charging of unknown</span>
<span class="cm">	 * batteries is disabled, we always report 100% capacity and</span>
<span class="cm">	 * capacity level UNKNOWN, since we can&#39;t calculate</span>
<span class="cm">	 * remaining capacity</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">bat_ovv</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">BATT_OVV_VALUE</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">inst_curr</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">avg_curr</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ENERGY_FULL_DESIGN</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_mah_to_uwh</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ENERGY_FULL</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_mah_to_uwh</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ENERGY_NOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_unknown_bat</span> <span class="o">&amp;&amp;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_mah_to_uwh</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ab8500_fg_convert_mah_to_uwh</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_unknown_bat</span> <span class="o">&amp;&amp;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_unknown_bat</span> <span class="o">&amp;&amp;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_percent</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY_LEVEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_unknown_bat</span> <span class="o">&amp;&amp;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_UNKNOWN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_level</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_get_ext_psy_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">psy_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">psy</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ext</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_fg_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For all psy where the name of your driver</span>
<span class="cm">	 * appears in any supplied_to</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="n">psy_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psy_found</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Go through all properties for the psy */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_properties</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">prop</span><span class="p">;</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_STATUS</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_STATUS_UNKNOWN</span>:
				<span class="k">case</span> <span class="n">POWER_SUPPLY_STATUS_DISCHARGING</span>:
				<span class="k">case</span> <span class="n">POWER_SUPPLY_STATUS_NOT_CHARGING</span>:
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fully_charged</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_work</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_STATUS_FULL</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fully_charged</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fully_charged</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">force_full</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="cm">/* Save current capacity as maximum */</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">mah</span><span class="p">;</span>
					<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_work</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_STATUS_CHARGING</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fully_charged</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_work</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">};</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">};</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">abx500_battery_type</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>

					<span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">]);</span>

					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

					<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span> <span class="o">=</span>
						<span class="n">MILLI_TO_MICRO</span> <span class="o">*</span>
						<span class="n">b</span><span class="o">-&gt;</span><span class="n">charge_full_design</span><span class="p">;</span>

					<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">;</span>

					<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat_nom</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">nominal_voltage</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
			    <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span><span class="p">)</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_init_hw_registers() - Set up FG related registers</span>
<span class="cm"> * @di:		pointer to the ab8500_fg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Set up battery OVV, low battery voltage registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_init_hw_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Set VBAT OVV threshold */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_BATT_OVV</span><span class="p">,</span>
		<span class="n">BATT_OVV_TH_4P75</span><span class="p">,</span>
		<span class="n">BATT_OVV_TH_4P75</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set BATT_OVV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable VBAT OVV detection */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_BATT_OVV</span><span class="p">,</span>
		<span class="n">BATT_OVV_ENA</span><span class="p">,</span>
		<span class="n">BATT_OVV_ENA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable BATT_OVV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Low Battery Voltage */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_LOW_BAT_REG</span><span class="p">,</span>
		<span class="n">ab8500_volt_to_regval</span><span class="p">(</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">lowbat_threshold</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span>
		<span class="n">LOW_BAT_ENABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Battery OK threshold */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_battok_init_hw_register</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BattOk init write failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_external_power_changed() - callback for power supply changes</span>
<span class="cm"> * @psy:       pointer to the structure power_supply</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the entry point of the pointer external_power_changed</span>
<span class="cm"> * of the structure power_supply.</span>
<span class="cm"> * This function gets executed when there is a change in any external power</span>
<span class="cm"> * supply that this driver needs to be notified of.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_external_power_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_fg_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="n">class_for_each_device</span><span class="p">(</span><span class="n">power_supply_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">,</span> <span class="n">ab8500_fg_get_ext_psy_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abab8500_fg_reinit_work() - work to reset the FG algorithm</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Used to reset the current battery capacity to be able to</span>
<span class="cm"> * retrigger a new voltage base capacity calculation. For</span>
<span class="cm"> * test and verification purpose.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_reinit_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span>
		<span class="n">fg_reinit_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">calibrate</span> <span class="o">==</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Resetting FG state machine to init.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ab8500_fg_clear_cap_samples</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">ab8500_fg_calc_cap_discharge_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ab8500_fg_charge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">AB8500_FG_CHARGE_INIT</span><span class="p">);</span>
		<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">AB8500_FG_DISCHARGE_INIT</span><span class="p">);</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Residual offset calibration ongoing &quot;</span>
			<span class="s">&quot;retrying..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Wait one second until next try*/</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_reinit_work</span><span class="p">,</span>
			<span class="n">round_jiffies</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_fg_reinit() - forces FG algorithm to reinitialize with current values</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to force the FG algorithm to recalculate a new</span>
<span class="cm"> * voltage based battery capacity.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ab8500_fg_reinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">ab8500_fg_get</span><span class="p">();</span>
	<span class="cm">/* User won&#39;t be notified if a null pointer returned. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_reinit_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Exposure to the sysfs interface */</span>

<span class="k">struct</span> <span class="n">ab8500_fg_sysfs_entry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="n">attr</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">store</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">charge_full_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">charge_full_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">charge_full</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charge_full</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ret %zd charge_full %lu&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">charge_full</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">charge_full</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">charge_now_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">charge_now_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">charge_now</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charge_now</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ret %zd charge_now %lu was %d&quot;</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">,</span> <span class="n">charge_now</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">prev_mah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">user_mah</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">charge_now</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">user_cap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ab8500_fg_sysfs_entry</span> <span class="n">charge_full_attr</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">charge_full</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">charge_full_show</span><span class="p">,</span> <span class="n">charge_full_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ab8500_fg_sysfs_entry</span> <span class="n">charge_now_attr</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">charge_now</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">charge_now_show</span><span class="p">,</span> <span class="n">charge_now_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ab8500_fg_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_sysfs_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg_sysfs_entry</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span> <span class="n">fg_kobject</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ab8500_fg_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg_sysfs_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg_sysfs_entry</span><span class="p">,</span> <span class="n">attr</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_fg</span><span class="p">,</span> <span class="n">fg_kobject</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">ab8500_fg_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">ab8500_fg_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">ab8500_fg_store</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">ab8500_fg_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">charge_full_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">charge_now_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">ab8500_fg_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_fg_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">ab8500_fg_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_chargalg_sysfs_exit() - de-init of sysfs entry</span>
<span class="cm"> * @di:                pointer to the struct ab8500_chargalg</span>
<span class="cm"> *</span>
<span class="cm"> * This function removes the entry in sysfs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_fg_sysfs_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_kobject</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_chargalg_sysfs_init() - init of sysfs entry</span>
<span class="cm"> * @di:                pointer to the struct ab8500_chargalg</span>
<span class="cm"> *</span>
<span class="cm"> * This function adds an entry in sysfs.</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_sysfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_kobject</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ab8500_fg_ktype</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;battery&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* Exposure to the sysfs interface &lt;&lt;END&gt;&gt; */</span>

<span class="cp">#if defined(CONFIG_PM)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change state if we&#39;re not charging. If we&#39;re charging we will wake</span>
<span class="cm">	 * up on the FG IRQ</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">AB8500_FG_DISCHARGE_WAKEUP</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_fg_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">flush_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the FG is enabled we will disable it before going to suspend</span>
<span class="cm">	 * only if we&#39;re not charging</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">fg_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">charging</span><span class="p">)</span>
		<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ab8500_fg_suspend      NULL</span>
<span class="cp">#define ab8500_fg_resume       NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ab8500_fg_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="cm">/* Disable coulomb counter */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to disable coulomb counter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">);</span>
	<span class="n">ab8500_fg_sysfs_exit</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="n">flush_scheduled_work</span><span class="p">();</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ab8500 fg driver interrupts and their respective isr */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ab8500_fg_interrupts</span> <span class="n">ab8500_fg_irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;NCONV_ACCU&quot;</span><span class="p">,</span> <span class="n">ab8500_fg_cc_convend_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BATT_OVV&quot;</span><span class="p">,</span> <span class="n">ab8500_fg_batt_ovv_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;LOW_BAT_F&quot;</span><span class="p">,</span> <span class="n">ab8500_fg_lowbatf_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CC_INT_CALIB&quot;</span><span class="p">,</span> <span class="n">ab8500_fg_cc_int_calib_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CCEOC&quot;</span><span class="p">,</span> <span class="n">ab8500_fg_cc_data_end_handler</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ab8500_fg_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_bm_plat_data</span> <span class="o">*</span><span class="n">plat_data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="cm">/* get parent data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span> <span class="o">=</span> <span class="n">ab8500_gpadc_get</span><span class="p">(</span><span class="s">&quot;ab8500-gpadc.0&quot;</span><span class="p">);</span>

	<span class="cm">/* get fg specific platform data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no fg platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get battery specific platform data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no battery platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500_fg&quot;</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">ab8500_fg_props</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_fg_props</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">ab8500_fg_get_property</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">supplied_to</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">num_supplicants</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">.</span><span class="n">external_power_changed</span> <span class="o">=</span> <span class="n">ab8500_fg_external_power_changed</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span> <span class="o">=</span> <span class="n">MILLI_TO_MICRO</span> <span class="o">*</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">charge_full_design</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_cap</span><span class="p">.</span><span class="n">max_mah_design</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat_nom</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">nominal_voltage</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">init_capacity</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ab8500_fg_charge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">AB8500_FG_CHARGE_INIT</span><span class="p">);</span>
	<span class="n">ab8500_fg_discharge_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">AB8500_FG_DISCHARGE_INIT</span><span class="p">);</span>

	<span class="cm">/* Create a work queue for running the FG algorithm */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;ab8500_fg_wq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create work queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init work for running the fg algorithm instantly */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_work</span><span class="p">,</span> <span class="n">ab8500_fg_instant_work</span><span class="p">);</span>

	<span class="cm">/* Init work for getting the battery accumulated current */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_acc_cur_work</span><span class="p">,</span> <span class="n">ab8500_fg_acc_cur_work</span><span class="p">);</span>

	<span class="cm">/* Init work for reinitialising the fg algorithm */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_reinit_work</span><span class="p">,</span>
		<span class="n">ab8500_fg_reinit_work</span><span class="p">);</span>

	<span class="cm">/* Work delayed Queue to run the state machine */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span>
		<span class="n">ab8500_fg_periodic_work</span><span class="p">);</span>

	<span class="cm">/* Work to check low battery condition */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_low_bat_work</span><span class="p">,</span>
		<span class="n">ab8500_fg_low_bat_work</span><span class="p">);</span>

	<span class="cm">/* Init work for HW failure check */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_check_hw_failure_work</span><span class="p">,</span>
		<span class="n">ab8500_fg_check_hw_failure_work</span><span class="p">);</span>

	<span class="cm">/* Initialize OVV, and other registers */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_init_hw_registers</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_inst_curr_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Consider battery unknown until we&#39;re informed otherwise */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">batt_id_received</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Register FG power supply class */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register FG psy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_inst_curr_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_samples</span> <span class="o">=</span> <span class="n">SEC_TO_SAMPLE</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">fg_params</span><span class="o">-&gt;</span><span class="n">init_timer</span><span class="p">);</span>
	<span class="n">ab8500_fg_coulomb_counter</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Initialize completion used to notify completion of inst current */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ab8500_fg_complete</span><span class="p">);</span>

	<span class="cm">/* Register interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_fg_irq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_fg_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ab8500_fg_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isr</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span>
			<span class="n">ab8500_fg_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request %s IRQ %d: %d</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">ab8500_fg_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested %s IRQ %d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ab8500_fg_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;CCEOC&quot;</span><span class="p">);</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_sysfs_init</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calibrate the fg first time */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">calibrate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">calib_state</span> <span class="o">=</span> <span class="n">AB8500_FG_CALIB_INIT</span><span class="p">;</span>

	<span class="cm">/* Use room temp as default value until we get an update from driver. */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">=</span> <span class="mi">210</span><span class="p">;</span>

	<span class="cm">/* Run the FG algorithm */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab8500_fg_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">free_irq:</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_psy</span><span class="p">);</span>

	<span class="cm">/* We also have to free all successfully registered irqs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_fg_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">free_inst_curr_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg_wq</span><span class="p">);</span>
<span class="nl">free_device_info:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ab8500_fg_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ab8500_fg_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ab8500_fg_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ab8500_fg_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ab8500_fg_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-fg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ab8500_fg_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_fg_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ab8500_fg_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_fg_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall_sync</span><span class="p">(</span><span class="n">ab8500_fg_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ab8500_fg_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Johan Palsson, Karl Komierowski&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ab8500-fg&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AB8500 Fuel Gauge driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
