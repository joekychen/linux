<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › power › power_supply_sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>power_supply_sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Sysfs interface for the universal power supply monitor class</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright © 2007  David Woodhouse &lt;dwmw2@infradead.org&gt;</span>
<span class="cm"> *  Copyright © 2007  Anton Vorontsov &lt;cbou@mail.ru&gt;</span>
<span class="cm"> *  Copyright © 2004  Szabolcs Gyurko</span>
<span class="cm"> *  Copyright © 2003  Ian Molton &lt;spyro@f2s.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Modified: 2004, Oct     Szabolcs Gyurko</span>
<span class="cm"> *</span>
<span class="cm"> *  You may use this code as per GPL version 2</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/stat.h&gt;</span>

<span class="cp">#include &quot;power_supply.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * This is because the name &quot;current&quot; breaks the device attr macro.</span>
<span class="cm"> * The &quot;current&quot; word resolves to &quot;(get_current())&quot; so instead of</span>
<span class="cm"> * &quot;current&quot; &quot;(get_current())&quot; appears in the sysfs.</span>
<span class="cm"> *</span>
<span class="cm"> * The source of this definition is the device.h which calls __ATTR</span>
<span class="cm"> * macro in sysfs.h which calls the __stringify macro.</span>
<span class="cm"> *</span>
<span class="cm"> * Only modification that the name is not tried to be resolved</span>
<span class="cm"> * (as a macro let&#39;s say).</span>
<span class="cm"> */</span>

<span class="cp">#define POWER_SUPPLY_ATTR(_name)					\</span>
<span class="cp">{									\</span>
<span class="cp">	.attr = { .name = #_name },					\</span>
<span class="cp">	.show = power_supply_show_property,				\</span>
<span class="cp">	.store = power_supply_store_property,				\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">power_supply_attrs</span><span class="p">[];</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">power_supply_show_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s">&quot;Battery&quot;</span><span class="p">,</span> <span class="s">&quot;UPS&quot;</span><span class="p">,</span> <span class="s">&quot;Mains&quot;</span><span class="p">,</span> <span class="s">&quot;USB&quot;</span><span class="p">,</span>
		<span class="s">&quot;USB_DCP&quot;</span><span class="p">,</span> <span class="s">&quot;USB_CDP&quot;</span><span class="p">,</span> <span class="s">&quot;USB_ACA&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">status_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s">&quot;Charging&quot;</span><span class="p">,</span> <span class="s">&quot;Discharging&quot;</span><span class="p">,</span> <span class="s">&quot;Not charging&quot;</span><span class="p">,</span> <span class="s">&quot;Full&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">charge_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="s">&quot;Trickle&quot;</span><span class="p">,</span> <span class="s">&quot;Fast&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">health_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s">&quot;Good&quot;</span><span class="p">,</span> <span class="s">&quot;Overheat&quot;</span><span class="p">,</span> <span class="s">&quot;Dead&quot;</span><span class="p">,</span> <span class="s">&quot;Over voltage&quot;</span><span class="p">,</span>
		<span class="s">&quot;Unspecified failure&quot;</span><span class="p">,</span> <span class="s">&quot;Cold&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">technology_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s">&quot;NiMH&quot;</span><span class="p">,</span> <span class="s">&quot;Li-ion&quot;</span><span class="p">,</span> <span class="s">&quot;Li-poly&quot;</span><span class="p">,</span> <span class="s">&quot;LiFe&quot;</span><span class="p">,</span> <span class="s">&quot;NiCd&quot;</span><span class="p">,</span>
		<span class="s">&quot;LiMn&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">capacity_level_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s">&quot;Critical&quot;</span><span class="p">,</span> <span class="s">&quot;Low&quot;</span><span class="p">,</span> <span class="s">&quot;Normal&quot;</span><span class="p">,</span> <span class="s">&quot;High&quot;</span><span class="p">,</span> <span class="s">&quot;Full&quot;</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scope_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unknown&quot;</span><span class="p">,</span> <span class="s">&quot;System&quot;</span><span class="p">,</span> <span class="s">&quot;Device&quot;</span>
	<span class="p">};</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">ptrdiff_t</span> <span class="n">off</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">-</span> <span class="n">power_supply_attrs</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_TYPE</span><span class="p">)</span>
		<span class="n">value</span><span class="p">.</span><span class="n">intval</span> <span class="o">=</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">psy</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;driver has no data for `%s&#39; property</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;driver failed to report `%s&#39; property: %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_STATUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status_text</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_TYPE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">charge_type</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_HEALTH</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">health_text</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">technology_text</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY_LEVEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">capacity_level_text</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_TYPE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type_text</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_SCOPE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scope_text</span><span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">]);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">POWER_SUPPLY_PROP_MODEL_NAME</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">strval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">intval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">power_supply_store_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">ptrdiff_t</span> <span class="n">off</span> <span class="o">=</span> <span class="n">attr</span> <span class="o">-</span> <span class="n">power_supply_attrs</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">long_val</span><span class="p">;</span>

	<span class="cm">/* TODO: support other types than int */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">long_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">value</span><span class="p">.</span><span class="n">intval</span> <span class="o">=</span> <span class="n">long_val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">set_property</span><span class="p">(</span><span class="n">psy</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be in the same order as POWER_SUPPLY_PROP_* */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">power_supply_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Properties of type `int&#39; */</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_type</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">health</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">present</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">online</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">technology</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">cycle_count</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">voltage_max</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">voltage_min</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">voltage_max_design</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">voltage_min_design</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">voltage_now</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">voltage_avg</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">voltage_ocv</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">current_max</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">current_now</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">current_avg</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">power_now</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">power_avg</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_full_design</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_empty_design</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_full</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_empty</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_now</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_avg</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">charge_counter</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">energy_full_design</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">energy_empty_design</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">energy_full</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">energy_empty</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">energy_now</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">energy_avg</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">capacity</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">capacity_level</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">temp_ambient</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">time_to_empty_now</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">time_to_empty_avg</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">time_to_full_now</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">time_to_full_avg</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">type</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">scope</span><span class="p">),</span>
	<span class="cm">/* Properties of type `const char *&#39; */</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">model_name</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">),</span>
	<span class="n">POWER_SUPPLY_ATTR</span><span class="p">(</span><span class="n">serial_number</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span>
<span class="n">__power_supply_attrs</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">power_supply_attrs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">power_supply_attr_is_visible</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">attrno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">umode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">S_IROTH</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attrno</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_PROP_TYPE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">num_properties</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">property</span> <span class="o">=</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">property</span> <span class="o">==</span> <span class="n">attrno</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">psy</span><span class="o">-&gt;</span><span class="n">property_is_writeable</span> <span class="o">&amp;&amp;</span>
			    <span class="n">psy</span><span class="o">-&gt;</span><span class="n">property_is_writeable</span><span class="p">(</span><span class="n">psy</span><span class="p">,</span> <span class="n">property</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mode</span> <span class="o">|=</span> <span class="n">S_IWUSR</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">power_supply_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">__power_supply_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_visible</span> <span class="o">=</span> <span class="n">power_supply_attr_is_visible</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="o">*</span><span class="n">power_supply_attr_groups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">power_supply_attr_group</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">power_supply_init_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_type</span> <span class="o">*</span><span class="n">dev_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_type</span><span class="o">-&gt;</span><span class="n">groups</span> <span class="o">=</span> <span class="n">power_supply_attr_groups</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">power_supply_attrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__power_supply_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">power_supply_attrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">attr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">kstruprdup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ret</span><span class="p">,</span> <span class="o">*</span><span class="n">ustr</span><span class="p">;</span>

	<span class="n">ustr</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ustr</span><span class="o">++</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ustr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">power_supply_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">prop_buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">attrname</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;uevent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psy</span> <span class="o">||</span> <span class="o">!</span><span class="n">psy</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No power supply yet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;POWER_SUPPLY_NAME=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;POWER_SUPPLY_NAME=%s&quot;</span><span class="p">,</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">prop_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">num_properties</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>

		<span class="n">attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">power_supply_attrs</span><span class="p">[</span><span class="n">psy</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_show_property</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">prop_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* When a battery is absent, we expect -ENODEV. Don&#39;t abort;</span>
<span class="cm">			   send the uevent with at least the the PRESENT=0 property */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">line</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">prop_buf</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">)</span>
			<span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">attrname</span> <span class="o">=</span> <span class="n">kstruprdup</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">attrname</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;prop %s=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">prop_buf</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;POWER_SUPPLY_%s=%s&quot;</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">prop_buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">attrname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">prop_buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
