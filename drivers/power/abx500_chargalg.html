<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › power › abx500_chargalg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>abx500_chargalg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2012</span>
<span class="cm"> *</span>
<span class="cm"> * Charging algorithm driver for abx500 variants</span>
<span class="cm"> *</span>
<span class="cm"> * License Terms: GNU General Public License v2</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Johan Palsson &lt;johan.palsson@stericsson.com&gt;</span>
<span class="cm"> *	Karl Komierowski &lt;karl.komierowski@stericsson.com&gt;</span>
<span class="cm"> *	Arun R Murthy &lt;arun.murthy@stericsson.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ux500_chargalg.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500-bm.h&gt;</span>

<span class="cm">/* Watchdog kick interval */</span>
<span class="cp">#define CHG_WD_INTERVAL			(6 * HZ)</span>

<span class="cm">/* End-of-charge criteria counter */</span>
<span class="cp">#define EOC_COND_CNT			10</span>

<span class="cm">/* Recharge criteria counter */</span>
<span class="cp">#define RCH_COND_CNT			3</span>

<span class="cp">#define to_abx500_chargalg_device_info(x) container_of((x), \</span>
<span class="cp">	struct abx500_chargalg, chargalg_psy);</span>

<span class="k">enum</span> <span class="n">abx500_chargers</span> <span class="p">{</span>
	<span class="n">NO_CHG</span><span class="p">,</span>
	<span class="n">AC_CHG</span><span class="p">,</span>
	<span class="n">USB_CHG</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">abx500_chargalg_charger_info</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">abx500_chargers</span> <span class="n">conn_chg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">abx500_chargers</span> <span class="n">prev_conn_chg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">abx500_chargers</span> <span class="n">online_chg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">abx500_chargers</span> <span class="n">prev_online_chg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">abx500_chargers</span> <span class="n">charger_type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usb_chg_ok</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ac_chg_ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_volt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac_volt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_vset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_iset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac_vset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac_iset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">abx500_chargalg_suspension_status</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">suspended_change</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ac_suspended</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usb_suspended</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">abx500_chargalg_battery_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">volt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">avg_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inst_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">percent</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">abx500_chargalg_states</span> <span class="p">{</span>
	<span class="n">STATE_HANDHELD_INIT</span><span class="p">,</span>
	<span class="n">STATE_HANDHELD</span><span class="p">,</span>
	<span class="n">STATE_CHG_NOT_OK_INIT</span><span class="p">,</span>
	<span class="n">STATE_CHG_NOT_OK</span><span class="p">,</span>
	<span class="n">STATE_HW_TEMP_PROTECT_INIT</span><span class="p">,</span>
	<span class="n">STATE_HW_TEMP_PROTECT</span><span class="p">,</span>
	<span class="n">STATE_NORMAL_INIT</span><span class="p">,</span>
	<span class="n">STATE_NORMAL</span><span class="p">,</span>
	<span class="n">STATE_WAIT_FOR_RECHARGE_INIT</span><span class="p">,</span>
	<span class="n">STATE_WAIT_FOR_RECHARGE</span><span class="p">,</span>
	<span class="n">STATE_MAINTENANCE_A_INIT</span><span class="p">,</span>
	<span class="n">STATE_MAINTENANCE_A</span><span class="p">,</span>
	<span class="n">STATE_MAINTENANCE_B_INIT</span><span class="p">,</span>
	<span class="n">STATE_MAINTENANCE_B</span><span class="p">,</span>
	<span class="n">STATE_TEMP_UNDEROVER_INIT</span><span class="p">,</span>
	<span class="n">STATE_TEMP_UNDEROVER</span><span class="p">,</span>
	<span class="n">STATE_TEMP_LOWHIGH_INIT</span><span class="p">,</span>
	<span class="n">STATE_TEMP_LOWHIGH</span><span class="p">,</span>
	<span class="n">STATE_SUSPENDED_INIT</span><span class="p">,</span>
	<span class="n">STATE_SUSPENDED</span><span class="p">,</span>
	<span class="n">STATE_OVV_PROTECT_INIT</span><span class="p">,</span>
	<span class="n">STATE_OVV_PROTECT</span><span class="p">,</span>
	<span class="n">STATE_SAFETY_TIMER_EXPIRED_INIT</span><span class="p">,</span>
	<span class="n">STATE_SAFETY_TIMER_EXPIRED</span><span class="p">,</span>
	<span class="n">STATE_BATT_REMOVED_INIT</span><span class="p">,</span>
	<span class="n">STATE_BATT_REMOVED</span><span class="p">,</span>
	<span class="n">STATE_WD_EXPIRED_INIT</span><span class="p">,</span>
	<span class="n">STATE_WD_EXPIRED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">states</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;HANDHELD_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;HANDHELD&quot;</span><span class="p">,</span>
	<span class="s">&quot;CHG_NOT_OK_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;CHG_NOT_OK&quot;</span><span class="p">,</span>
	<span class="s">&quot;HW_TEMP_PROTECT_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;HW_TEMP_PROTECT&quot;</span><span class="p">,</span>
	<span class="s">&quot;NORMAL_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;NORMAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;WAIT_FOR_RECHARGE_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;WAIT_FOR_RECHARGE&quot;</span><span class="p">,</span>
	<span class="s">&quot;MAINTENANCE_A_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;MAINTENANCE_A&quot;</span><span class="p">,</span>
	<span class="s">&quot;MAINTENANCE_B_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;MAINTENANCE_B&quot;</span><span class="p">,</span>
	<span class="s">&quot;TEMP_UNDEROVER_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;TEMP_UNDEROVER&quot;</span><span class="p">,</span>
	<span class="s">&quot;TEMP_LOWHIGH_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;TEMP_LOWHIGH&quot;</span><span class="p">,</span>
	<span class="s">&quot;SUSPENDED_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;SUSPENDED&quot;</span><span class="p">,</span>
	<span class="s">&quot;OVV_PROTECT_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;OVV_PROTECT&quot;</span><span class="p">,</span>
	<span class="s">&quot;SAFETY_TIMER_EXPIRED_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;SAFETY_TIMER_EXPIRED&quot;</span><span class="p">,</span>
	<span class="s">&quot;BATT_REMOVED_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;BATT_REMOVED&quot;</span><span class="p">,</span>
	<span class="s">&quot;WD_EXPIRED_INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;WD_EXPIRED&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">abx500_chargalg_events</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">batt_unknown</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mainextchnotok</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">batt_ovv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">batt_rem</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">btemp_underover</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">btemp_lowhigh</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">main_thermal_prot</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usb_thermal_prot</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">main_ovv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vbus_ovv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usbchargernotok</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">safety_timer_expired</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">maintenance_timer_expired</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ac_wd_expired</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usb_wd_expired</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ac_cv_active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usb_cv_active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vbus_collapsed</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct abx500_charge_curr_maximization - Charger maximization parameters</span>
<span class="cm"> * @original_iset:	the non optimized/maximised charger current</span>
<span class="cm"> * @current_iset:	the charging current used at this moment</span>
<span class="cm"> * @test_delta_i:	the delta between the current we want to charge and the</span>
<span class="cm">			current that is really going into the battery</span>
<span class="cm"> * @condition_cnt:	number of iterations needed before a new charger current</span>
<span class="cm">			is set</span>
<span class="cm"> * @max_current:	maximum charger current</span>
<span class="cm"> * @wait_cnt:		to avoid too fast current step down in case of charger</span>
<span class="cm"> *			voltage collapse, we insert this delay between step</span>
<span class="cm"> *			down</span>
<span class="cm"> * @level:		tells in how many steps the charging current has been</span>
<span class="cm">			increased</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">abx500_charge_curr_maximization</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">original_iset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_iset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">test_delta_i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">condition_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_current</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wait_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">level</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">maxim_ret</span> <span class="p">{</span>
	<span class="n">MAXIM_RET_NOACTION</span><span class="p">,</span>
	<span class="n">MAXIM_RET_CHANGE</span><span class="p">,</span>
	<span class="n">MAXIM_RET_IBAT_TOO_HIGH</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct abx500_chargalg - abx500 Charging algorithm device information</span>
<span class="cm"> * @dev:		pointer to the structure device</span>
<span class="cm"> * @charge_status:	battery operating status</span>
<span class="cm"> * @eoc_cnt:		counter used to determine end-of_charge</span>
<span class="cm"> * @rch_cnt:		counter used to determine start of recharge</span>
<span class="cm"> * @maintenance_chg:	indicate if maintenance charge is active</span>
<span class="cm"> * @t_hyst_norm		temperature hysteresis when the temperature has been</span>
<span class="cm"> *			over or under normal limits</span>
<span class="cm"> * @t_hyst_lowhigh	temperature hysteresis when the temperature has been</span>
<span class="cm"> *			over or under the high or low limits</span>
<span class="cm"> * @charge_state:	current state of the charging algorithm</span>
<span class="cm"> * @ccm			charging current maximization parameters</span>
<span class="cm"> * @chg_info:		information about connected charger types</span>
<span class="cm"> * @batt_data:		data of the battery</span>
<span class="cm"> * @susp_status:	current charger suspension status</span>
<span class="cm"> * @pdata:		pointer to the abx500_chargalg platform data</span>
<span class="cm"> * @bat:		pointer to the abx500_bm platform data</span>
<span class="cm"> * @chargalg_psy:	structure that holds the battery properties exposed by</span>
<span class="cm"> *			the charging algorithm</span>
<span class="cm"> * @events:		structure for information about events triggered</span>
<span class="cm"> * @chargalg_wq:		work queue for running the charging algorithm</span>
<span class="cm"> * @chargalg_periodic_work:	work to run the charging algorithm periodically</span>
<span class="cm"> * @chargalg_wd_work:		work to kick the charger watchdog periodically</span>
<span class="cm"> * @chargalg_work:		work to run the charging algorithm instantly</span>
<span class="cm"> * @safety_timer:		charging safety timer</span>
<span class="cm"> * @maintenance_timer:		maintenance charging timer</span>
<span class="cm"> * @chargalg_kobject:		structure of type kobject</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">charge_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">eoc_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rch_cnt</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">maintenance_chg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t_hyst_norm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t_hyst_lowhigh</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">abx500_chargalg_states</span> <span class="n">charge_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_charge_curr_maximization</span> <span class="n">ccm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg_charger_info</span> <span class="n">chg_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg_battery_data</span> <span class="n">batt_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg_suspension_status</span> <span class="n">susp_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_bm_data</span> <span class="o">*</span><span class="n">bat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="n">chargalg_psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="n">ac_chg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="n">usb_chg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg_events</span> <span class="n">events</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">chargalg_wq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">chargalg_periodic_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">chargalg_wd_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">chargalg_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">safety_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">maintenance_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kobject</span> <span class="n">chargalg_kobject</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Main battery properties */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">abx500_chargalg_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_STATUS</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_HEALTH</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_safety_timer_expired() - Expiration of the safety timer</span>
<span class="cm"> * @data:	pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when the safety timer for the charger</span>
<span class="cm"> * expires</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_safety_timer_expired</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Safety timer expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">safety_timer_expired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Trigger execution of the algorithm instantly */</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_maintenance_timer_expired() - Expiration of</span>
<span class="cm"> * the maintenance timer</span>
<span class="cm"> * @i:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when the maintenence timer</span>
<span class="cm"> * expires</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_maintenance_timer_expired</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Maintenance timer expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">maintenance_timer_expired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Trigger execution of the algorithm instantly */</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_state_to() - Change charge state</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when a charge state change should occur</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_state_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">abx500_chargalg_states</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;State changed: %s (From state: [%d] %s =to=&gt; [%d] %s )</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">==</span> <span class="n">state</span> <span class="o">?</span> <span class="s">&quot;NO&quot;</span> <span class="o">:</span> <span class="s">&quot;YES&quot;</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">,</span>
		<span class="n">states</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">],</span>
		<span class="n">state</span><span class="p">,</span>
		<span class="n">states</span><span class="p">[</span><span class="n">state</span><span class="p">]);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_check_charger_connection() - Check charger connection change</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function will check if there is a change in the charger connection</span>
<span class="cm"> * and change charge state accordingly. AC has precedence over USB.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_check_charger_connection</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">!=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_conn_chg</span> <span class="o">||</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">suspended_change</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Charger state changed or suspension</span>
<span class="cm">		 * has changed since last update</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">ac_suspended</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Charging source is AC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span> <span class="o">!=</span> <span class="n">AC_CHG</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span> <span class="o">=</span> <span class="n">AC_CHG</span><span class="p">;</span>
				<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">usb_suspended</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Charging source is USB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span> <span class="o">=</span> <span class="n">USB_CHG</span><span class="p">;</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">ac_suspended</span> <span class="o">||</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">usb_suspended</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Charging is suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span> <span class="o">=</span> <span class="n">NO_CHG</span><span class="p">;</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_SUSPENDED_INIT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Charging source is OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span> <span class="o">=</span> <span class="n">NO_CHG</span><span class="p">;</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_HANDHELD_INIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_conn_chg</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">suspended_change</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_start_safety_timer() - Start charging safety timer</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * The safety timer is used to avoid overcharging of old or bad batteries.</span>
<span class="cm"> * There are different timers for AC and USB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_start_safety_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_expiration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AC_CHG</span>:
		<span class="n">timer_expiration</span> <span class="o">=</span>
		<span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">main_safety_tmr_h</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_CHG</span>:
		<span class="n">timer_expiration</span> <span class="o">=</span>
		<span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">usb_safety_tmr_h</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown charger to charge from</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">safety_timer_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">timer_expiration</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">))</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">,</span> <span class="n">timer_expiration</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_stop_safety_timer() - Stop charging safety timer</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * The safety timer is stopped whenever the NORMAL state is exited</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_stop_safety_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">safety_timer_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_start_maintenance_timer() - Start charging maintenance timer</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> * @duration:	duration of ther maintenance timer in hours</span>
<span class="cm"> *</span>
<span class="cm"> * The maintenance timer is used to maintain the charge in the battery once</span>
<span class="cm"> * the battery is considered full. These timers are chosen to match the</span>
<span class="cm"> * discharge curve of the battery</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_start_maintenance_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">duration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_expiration</span><span class="p">;</span>

	<span class="cm">/* Convert from hours to jiffies */</span>
	<span class="n">timer_expiration</span> <span class="o">=</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">maintenance_timer_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">timer_expiration</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">))</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">,</span> <span class="n">timer_expiration</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_stop_maintenance_timer() - Stop maintenance timer</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * The maintenance timer is stopped whenever maintenance ends or when another</span>
<span class="cm"> * state is entered</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">maintenance_timer_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_kick_watchdog() - Kick charger watchdog</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * The charger watchdog have to be kicked periodically whenever the charger is</span>
<span class="cm"> * on, else the ABB will reset the system</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_kick_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check if charger exists and kick watchdog if charging */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">kick_wd</span> <span class="o">&amp;&amp;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">kick_wd</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">kick_wd</span> <span class="o">&amp;&amp;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">kick_wd</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_ac_en() - Turn on/off the AC charger</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> * @enable:	charger on/off</span>
<span class="cm"> * @vset:	requested charger output voltage</span>
<span class="cm"> * @iset:	requested charger output current</span>
<span class="cm"> *</span>
<span class="cm"> * The AC charger will be turned on/off with the requested charge voltage and</span>
<span class="cm"> * current</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_ac_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">vset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span> <span class="o">||</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Select maximum of what both the charger and the battery supports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">max_out_volt</span><span class="p">)</span>
		<span class="n">vset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">vset</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">max_out_volt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">)</span>
		<span class="n">iset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">iset</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_iset</span> <span class="o">=</span> <span class="n">iset</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_vset</span> <span class="o">=</span> <span class="n">vset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_usb_en() - Turn on/off the USB charger</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> * @enable:	charger on/off</span>
<span class="cm"> * @vset:	requested charger output voltage</span>
<span class="cm"> * @iset:	requested charger output current</span>
<span class="cm"> *</span>
<span class="cm"> * The USB charger will be turned on/off with the requested charge voltage and</span>
<span class="cm"> * current</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_usb_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">vset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span> <span class="o">||</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Select maximum of what both the charger and the battery supports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">max_out_volt</span><span class="p">)</span>
		<span class="n">vset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">vset</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">max_out_volt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">)</span>
		<span class="n">iset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">iset</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_iset</span> <span class="o">=</span> <span class="n">iset</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_vset</span> <span class="o">=</span> <span class="n">vset</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">enable</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_update_chg_curr() - Update charger current</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> * @iset:	requested charger output current</span>
<span class="cm"> *</span>
<span class="cm"> * The charger output current will be updated for the charger</span>
<span class="cm"> * that is currently in use</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_update_chg_curr</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">iset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check if charger exists and update current if charging */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">update_curr</span> <span class="o">&amp;&amp;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Select maximum of what both the charger</span>
<span class="cm">		 * and the battery supports</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">)</span>
			<span class="n">iset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">iset</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_iset</span> <span class="o">=</span> <span class="n">iset</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">update_curr</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">update_curr</span> <span class="o">&amp;&amp;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Select maximum of what both the charger</span>
<span class="cm">		 * and the battery supports</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">)</span>
			<span class="n">iset</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">iset</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">max_out_curr</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_iset</span> <span class="o">=</span> <span class="n">iset</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">update_curr</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_stop_charging() - Stop charging</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called from any state where charging should be stopped.</span>
<span class="cm"> * All charging is disabled and all status parameters and timers are changed</span>
<span class="cm"> * accordingly</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">abx500_chargalg_ac_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">abx500_chargalg_usb_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">abx500_chargalg_stop_safety_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_NOT_CHARGING</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">);</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_hold_charging() - Pauses charging</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called in the case where maintenance charging has been</span>
<span class="cm"> * disabled and instead a battery voltage mode is entered to check when the</span>
<span class="cm"> * battery voltage has reached a certain recharge voltage</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_hold_charging</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">abx500_chargalg_ac_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">abx500_chargalg_usb_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">abx500_chargalg_stop_safety_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_CHARGING</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">);</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_start_charging() - Start the charger</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> * @vset:	requested charger output voltage</span>
<span class="cm"> * @iset:	requested charger output current</span>
<span class="cm"> *</span>
<span class="cm"> * A charger will be enabled depending on the requested charger type that was</span>
<span class="cm"> * detected previously.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_start_charging</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">vset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AC_CHG</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;AC parameters: Vset %d, Ich %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
		<span class="n">abx500_chargalg_usb_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">abx500_chargalg_ac_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_CHG</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;USB parameters: Vset %d, Ich %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
		<span class="n">abx500_chargalg_ac_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">abx500_chargalg_usb_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown charger to charge from</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_check_temp() - Check battery temperature ranges</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * The battery temperature is checked against the predefined limits and the</span>
<span class="cm"> * charge state is changed accordingly</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_check_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_low</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_norm</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_high</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_norm</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Temp OK! */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_underover</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowhigh</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_lowhigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_high</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&lt;</span>
				<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_over</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_lowhigh</span><span class="p">)))</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&gt;</span>
				<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_under</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_lowhigh</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_low</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* TEMP minor!!!!! */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_underover</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowhigh</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_norm</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_hysteresis</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_lowhigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_under</span> <span class="o">||</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_over</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TEMP major!!!!! */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_underover</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowhigh</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_lowhigh</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_hysteresis</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Within hysteresis */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Within hysteresis limit temp: %d &quot;</span>
				<span class="s">&quot;hyst_lowhigh %d, hyst normal %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_lowhigh</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">t_hyst_norm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_check_charger_voltage() - Check charger voltage</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Charger voltage is checked against maximum limit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_check_charger_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_volt</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_params</span><span class="o">-&gt;</span><span class="n">usb_volt_max</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_chg_ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_chg_ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_volt</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_params</span><span class="o">-&gt;</span><span class="n">ac_volt_max</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_chg_ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_chg_ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_end_of_charge() - Check if end-of-charge criteria is fulfilled</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * End-of-charge criteria is fulfilled when the battery voltage is above a</span>
<span class="cm"> * certain limit and the battery current is below a certain limit for a</span>
<span class="cm"> * predefined number of consecutive seconds. If true, the battery is full</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_end_of_charge</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_STATUS_CHARGING</span> <span class="o">&amp;&amp;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">==</span> <span class="n">STATE_NORMAL</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">volt</span> <span class="o">&gt;=</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">termination_vol</span> <span class="o">||</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_cv_active</span> <span class="o">||</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_cv_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">avg_curr</span> <span class="o">&lt;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">termination_curr</span> <span class="o">&amp;&amp;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">avg_curr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">eoc_cnt</span> <span class="o">&gt;=</span> <span class="n">EOC_COND_CNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">eoc_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_FULL</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EOC reached!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot; EOC limit reached for the %d&quot;</span>
				<span class="s">&quot; time, out of %d before EOC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">eoc_cnt</span><span class="p">,</span>
				<span class="n">EOC_COND_CNT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">eoc_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_maxim_chg_curr</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">original_iset</span> <span class="o">=</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">normal_cur_lvl</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span> <span class="o">=</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">normal_cur_lvl</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">test_delta_i</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">charger_curr_step</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">max_current</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">chg_curr</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">condition_cnt</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">wait_cycles</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_chg_curr_maxim - increases the charger current to</span>
<span class="cm"> *			compensate for the system load</span>
<span class="cm"> * @di		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This maximization function is used to raise the charger current to get the</span>
<span class="cm"> * battery current as close to the optimal value as possible. The battery</span>
<span class="cm"> * current during charging is affected by the system load</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">maxim_ret</span> <span class="nf">abx500_chargalg_chg_curr_maxim</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delta_i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">ena_maxi</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">MAXIM_RET_NOACTION</span><span class="p">;</span>

	<span class="n">delta_i</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">original_iset</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">inst_curr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_collapsed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Charger voltage has collapsed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">wait_cnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">wait_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lowering current</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">wait_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">condition_cnt</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">wait_cycles</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">max_current</span> <span class="o">=</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span> <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">test_delta_i</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">max_current</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">level</span><span class="o">--</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">MAXIM_RET_CHANGE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Let&#39;s go in here twice before lowering curr again */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">wait_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">wait_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">MAXIM_RET_NOACTION</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">wait_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">inst_curr</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">original_iset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; Maximization Ibat (%dmA) too high&quot;</span>
			<span class="s">&quot; (limit %dmA) (current iset: %dmA)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">inst_curr</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">original_iset</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span> <span class="o">==</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">original_iset</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">MAXIM_RET_NOACTION</span><span class="p">;</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">condition_cnt</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">wait_cycles</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">original_iset</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">MAXIM_RET_IBAT_TOO_HIGH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta_i</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">test_delta_i</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span> <span class="o">+</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">test_delta_i</span><span class="p">)</span> <span class="o">&lt;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">max_current</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">condition_cnt</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Increse the iset with cco.test_delta_i */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">condition_cnt</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">wait_cycles</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span> <span class="o">+=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">test_delta_i</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">level</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; Maximization needed, increase&quot;</span>
				<span class="s">&quot; with %d mA to %dmA (Optimal ibat: %d)&quot;</span>
				<span class="s">&quot; Level %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">test_delta_i</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">original_iset</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">level</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">MAXIM_RET_CHANGE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">MAXIM_RET_NOACTION</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">condition_cnt</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">maxi</span><span class="o">-&gt;</span><span class="n">wait_cycles</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">MAXIM_RET_NOACTION</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_maxim_chg_curr</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">maxim_ret</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_chargalg_chg_curr_maxim</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAXIM_RET_CHANGE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">abx500_chargalg_update_chg_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ccm</span><span class="p">.</span><span class="n">current_iset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set chg curr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAXIM_RET_IBAT_TOO_HIGH</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">abx500_chargalg_update_chg_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">normal_cur_lvl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set chg curr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MAXIM_RET_NOACTION</span>:
	<span class="nl">default:</span>
		<span class="cm">/* Do nothing..*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_get_ext_psy_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">psy_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">psy</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ext</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">to_abx500_chargalg_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>
	<span class="cm">/* For all psy where the driver name appears in any supplied_to */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="n">psy_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psy_found</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Go through all properties for the psy */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_properties</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">prop</span><span class="p">;</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="cm">/* Initialize chargers if not already done */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span> <span class="o">&amp;&amp;</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span><span class="p">)</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span> <span class="o">=</span> <span class="n">psy_to_ux500_charger</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span> <span class="o">&amp;&amp;</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">)</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span> <span class="o">=</span> <span class="n">psy_to_ux500_charger</span><span class="p">(</span><span class="n">ext</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="cm">/* Battery present */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_rem</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="cm">/* Battery removed */</span>
				<span class="k">else</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_rem</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span>:
				<span class="cm">/* AC disconnected */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_conn_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC_CHG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* AC connected */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_conn_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">|=</span> <span class="n">AC_CHG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
				<span class="cm">/* USB disconnected */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_conn_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_CHG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* USB connected */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_conn_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">|=</span> <span class="n">USB_CHG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ONLINE</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span>:
				<span class="cm">/* AC offline */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_online_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC_CHG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* AC online */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_online_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">|=</span> <span class="n">AC_CHG</span><span class="p">;</span>
					<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
				<span class="cm">/* USB offline */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_online_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">USB_CHG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* USB online */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_online_chg</span> <span class="o">=</span>
						<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">|=</span> <span class="n">USB_CHG</span><span class="p">;</span>
					<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_HEALTH</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_UNSPEC_FAILURE</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_DEAD</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_wd_expired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_COLD</span>:
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_OVERHEAT</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_OVERVOLTAGE</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_ovv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_GOOD</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_UNSPEC_FAILURE</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usbchargernotok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_DEAD</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_wd_expired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usbchargernotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_COLD</span>:
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_OVERHEAT</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_thermal_prot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usbchargernotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_OVERVOLTAGE</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usbchargernotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">POWER_SUPPLY_HEALTH_GOOD</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usbchargernotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">volt</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span>:
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_volt</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_volt</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span>:
				<span class="cm">/* AVG is used to indicate when we are</span>
<span class="cm">				 * in CV mode */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_cv_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_cv_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
				<span class="cm">/* AVG is used to indicate when we are</span>
<span class="cm">				 * in CV mode */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_cv_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_cv_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP</span>:
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_curr</span> <span class="o">=</span>
						<span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_curr</span> <span class="o">=</span>
						<span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">inst_curr</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">avg_curr</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_collapsed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_collapsed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY</span>:
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">percent</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_external_power_changed() - callback for power supply changes</span>
<span class="cm"> * @psy:       pointer to the structure power_supply</span>
<span class="cm"> *</span>
<span class="cm"> * This function is the entry point of the pointer external_power_changed</span>
<span class="cm"> * of the structure power_supply.</span>
<span class="cm"> * This function gets executed when there is a change in any external power</span>
<span class="cm"> * supply that this driver needs to be notified of.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_external_power_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">to_abx500_chargalg_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Trigger execution of the algorithm instantly and read</span>
<span class="cm">	 * all power_supply properties there instead</span>
<span class="cm">	 */</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_algorithm() - Main function for the algorithm</span>
<span class="cm"> * @di:		pointer to the abx500_chargalg structure</span>
<span class="cm"> *</span>
<span class="cm"> * This is the main control function for the charging algorithm.</span>
<span class="cm"> * It is called periodically or when something happens that will</span>
<span class="cm"> * trigger a state change</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_algorithm</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">charger_status</span><span class="p">;</span>

	<span class="cm">/* Collect data from all power_supply class devices */</span>
	<span class="n">class_for_each_device</span><span class="p">(</span><span class="n">power_supply_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">,</span> <span class="n">abx500_chargalg_get_ext_psy_data</span><span class="p">);</span>

	<span class="n">abx500_chargalg_end_of_charge</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">abx500_chargalg_check_temp</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="n">abx500_chargalg_check_charger_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="n">charger_status</span> <span class="o">=</span> <span class="n">abx500_chargalg_check_charger_connection</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * First check if we have a charger connected.</span>
<span class="cm">	 * Also we don&#39;t allow charging of unknown batteries if configured</span>
<span class="cm">	 * this way</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">charger_status</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_unknown</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_unknown_bat</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_HANDHELD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">safety_timer_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_HANDHELD_INIT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If suspended, we should not continue checking the flags */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">==</span> <span class="n">STATE_SUSPENDED_INIT</span> <span class="o">||</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">==</span> <span class="n">STATE_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We don&#39;t do anything here, just don,t continue */</span>
	<span class="p">}</span>

	<span class="cm">/* Safety timer expiration */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">safety_timer_expired</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_SAFETY_TIMER_EXPIRED</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">STATE_SAFETY_TIMER_EXPIRED_INIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if any interrupts has occured</span>
<span class="cm">	 * that will prevent us from charging</span>
<span class="cm">	 */</span>

	<span class="cm">/* Battery removed */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_rem</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_BATT_REMOVED</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_BATT_REMOVED_INIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Main or USB charger not ok. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">||</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usbchargernotok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If vbus_collapsed is set, we have to lower the charger</span>
<span class="cm">		 * current, which is done in the normal state below</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_CHG_NOT_OK</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_collapsed</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_CHG_NOT_OK_INIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* VBUS, Main or VBAT OVV. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">||</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_ovv</span> <span class="o">||</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_ovv</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_chg_ok</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_chg_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_OVV_PROTECT</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_OVV_PROTECT_INIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* USB Thermal, stop charging */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">||</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_thermal_prot</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_HW_TEMP_PROTECT</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">STATE_HW_TEMP_PROTECT_INIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Battery temp over/under */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_underover</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_TEMP_UNDEROVER</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
				<span class="n">STATE_TEMP_UNDEROVER_INIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Watchdog expired */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_wd_expired</span> <span class="o">||</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_wd_expired</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_WD_EXPIRED</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_WD_EXPIRED_INIT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Battery temp high/low */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowhigh</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">!=</span> <span class="n">STATE_TEMP_LOWHIGH</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_TEMP_LOWHIGH_INIT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;[CHARGALG] Vb %d Ib_avg %d Ib_inst %d Tb %d Cap %d Maint %d &quot;</span>
		<span class="s">&quot;State %s Active_chg %d Chg_status %d AC %d USB %d &quot;</span>
		<span class="s">&quot;AC_online %d USB_online %d AC_CV %d USB_CV %d AC_I %d &quot;</span>
		<span class="s">&quot;USB_I %d AC_Vset %d AC_Iset %d USB_Vset %d USB_Iset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">volt</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">avg_curr</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">inst_curr</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">percent</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span><span class="p">,</span>
		<span class="n">states</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">],</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">charger_type</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">AC_CHG</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span> <span class="o">&amp;</span> <span class="n">USB_CHG</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_cv_active</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_cv_active</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_curr</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_curr</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_vset</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_iset</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_vset</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_iset</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STATE_HANDHELD_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_DISCHARGING</span><span class="p">;</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_HANDHELD</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_HANDHELD</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_SUSPENDED_INIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">ac_suspended</span><span class="p">)</span>
			<span class="n">abx500_chargalg_ac_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">usb_suspended</span><span class="p">)</span>
			<span class="n">abx500_chargalg_usb_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">abx500_chargalg_stop_safety_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_NOT_CHARGING</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_SUSPENDED</span><span class="p">);</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_SUSPENDED</span>:
		<span class="cm">/* CHARGING is suspended */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_BATT_REMOVED_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_BATT_REMOVED</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_BATT_REMOVED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_rem</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_HW_TEMP_PROTECT_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_HW_TEMP_PROTECT</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_HW_TEMP_PROTECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_thermal_prot</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_OVV_PROTECT_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_OVV_PROTECT</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_OVV_PROTECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">main_ovv</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_ovv</span> <span class="o">&amp;&amp;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">usb_chg_ok</span> <span class="o">&amp;&amp;</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">ac_chg_ok</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_CHG_NOT_OK_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_CHG_NOT_OK</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_CHG_NOT_OK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usbchargernotok</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_SAFETY_TIMER_EXPIRED_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_SAFETY_TIMER_EXPIRED</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_SAFETY_TIMER_EXPIRED</span>:
		<span class="cm">/* We exit this state when charger is removed */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_NORMAL_INIT</span>:
		<span class="n">abx500_chargalg_start_charging</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">normal_vol_lvl</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">normal_cur_lvl</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL</span><span class="p">);</span>
		<span class="n">abx500_chargalg_start_safety_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">init_maxim_chg_curr</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_CHARGING</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">eoc_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_NORMAL</span>:
		<span class="n">handle_maxim_chg_curr</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_STATUS_FULL</span> <span class="o">&amp;&amp;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_chg</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">no_maintenance</span><span class="p">)</span>
				<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">STATE_WAIT_FOR_RECHARGE_INIT</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">STATE_MAINTENANCE_A_INIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* This state will be used when the maintenance state is disabled */</span>
	<span class="k">case</span> <span class="n">STATE_WAIT_FOR_RECHARGE_INIT</span>:
		<span class="n">abx500_chargalg_hold_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_WAIT_FOR_RECHARGE</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">rch_cnt</span> <span class="o">=</span> <span class="n">RCH_COND_CNT</span><span class="p">;</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_WAIT_FOR_RECHARGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">volt</span> <span class="o">&lt;=</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">recharge_vol</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">rch_cnt</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">rch_cnt</span> <span class="o">=</span> <span class="n">RCH_COND_CNT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_MAINTENANCE_A_INIT</span>:
		<span class="n">abx500_chargalg_stop_safety_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_start_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">maint_a_chg_timer_h</span><span class="p">);</span>
		<span class="n">abx500_chargalg_start_charging</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">maint_a_vol_lvl</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">maint_a_cur_lvl</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_MAINTENANCE_A</span><span class="p">);</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough*/</span>

	<span class="k">case</span> <span class="n">STATE_MAINTENANCE_A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">maintenance_timer_expired</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_MAINTENANCE_B_INIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_MAINTENANCE_B_INIT</span>:
		<span class="n">abx500_chargalg_start_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">maint_b_chg_timer_h</span><span class="p">);</span>
		<span class="n">abx500_chargalg_start_charging</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">maint_b_vol_lvl</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">maint_b_cur_lvl</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_MAINTENANCE_B</span><span class="p">);</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough*/</span>

	<span class="k">case</span> <span class="n">STATE_MAINTENANCE_B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">maintenance_timer_expired</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_TEMP_LOWHIGH_INIT</span>:
		<span class="n">abx500_chargalg_start_charging</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">low_high_vol_lvl</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">low_high_cur_lvl</span><span class="p">);</span>
		<span class="n">abx500_chargalg_stop_maintenance_timer</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_CHARGING</span><span class="p">;</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_TEMP_LOWHIGH</span><span class="p">);</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_TEMP_LOWHIGH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowhigh</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_WD_EXPIRED_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_WD_EXPIRED</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_WD_EXPIRED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_wd_expired</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_wd_expired</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATE_TEMP_UNDEROVER_INIT</span>:
		<span class="n">abx500_chargalg_stop_charging</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_TEMP_UNDEROVER</span><span class="p">);</span>
		<span class="cm">/* Intentional fallthrough */</span>

	<span class="k">case</span> <span class="n">STATE_TEMP_UNDEROVER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_underover</span><span class="p">)</span>
			<span class="n">abx500_chargalg_state_to</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">STATE_NORMAL_INIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Start charging directly if the new state is a charge state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">==</span> <span class="n">STATE_NORMAL_INIT</span> <span class="o">||</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">==</span> <span class="n">STATE_MAINTENANCE_A_INIT</span> <span class="o">||</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_state</span> <span class="o">==</span> <span class="n">STATE_MAINTENANCE_B_INIT</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_periodic_work() - Periodic work for the algorithm</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for the charging algorithm</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_periodic_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">abx500_chargalg</span><span class="p">,</span> <span class="n">chargalg_periodic_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">abx500_chargalg_algorithm</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a charger is connected then the battery has to be monitored</span>
<span class="cm">	 * frequently, else the work can be delayed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">conn_chg</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_periodic_work</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">interval_charging</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_periodic_work</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">interval_not_charging</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_wd_work() - periodic work to kick the charger watchdog</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for kicking the charger watchdog</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_wd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">abx500_chargalg</span><span class="p">,</span> <span class="n">chargalg_wd_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;abx500_chargalg_wd_work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_chargalg_kick_watchdog</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to kick watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">,</span> <span class="n">CHG_WD_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_work() - Work to run the charging algorithm instantly</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for calling the charging algorithm</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">abx500_chargalg</span><span class="p">,</span> <span class="n">chargalg_work</span><span class="p">);</span>

	<span class="n">abx500_chargalg_algorithm</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_get_property() - get the chargalg properties</span>
<span class="cm"> * @psy:	pointer to the power_supply structure</span>
<span class="cm"> * @psp:	pointer to the power_supply_property structure</span>
<span class="cm"> * @val:	pointer to the power_supply_propval union</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when an application tries to get the</span>
<span class="cm"> * chargalg properties by reading the sysfs files.</span>
<span class="cm"> * status:     charging/discharging/full/unknown</span>
<span class="cm"> * health:     health of the battery</span>
<span class="cm"> * Returns error code in case of failure else 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">to_abx500_chargalg_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_STATUS</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">charge_status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_HEALTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_ovv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_OVERVOLTAGE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_underover</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">batt_data</span><span class="p">.</span><span class="n">temp</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_under</span><span class="p">)</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_COLD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_OVERHEAT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_GOOD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Exposure to the sysfs interface */</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_sysfs_charger() - sysfs store operations</span>
<span class="cm"> * @kobj:      pointer to the struct kobject</span>
<span class="cm"> * @attr:      pointer to the struct attribute</span>
<span class="cm"> * @buf:       buffer that holds the parameter passed from userspace</span>
<span class="cm"> * @length:    length of the parameter passed</span>
<span class="cm"> *</span>
<span class="cm"> * Returns length of the buffer(input taken from user space) on success</span>
<span class="cm"> * else error code on failure</span>
<span class="cm"> * The operation to be performed on passing the parameters from the user space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">abx500_chargalg_sysfs_charger</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">abx500_chargalg</span><span class="p">,</span> <span class="n">chargalg_kobject</span><span class="p">);</span>
	<span class="kt">long</span> <span class="kt">int</span> <span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac_usb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">*</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ac_usb</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ac_usb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* Disable charging */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">ac_suspended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">usb_suspended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">suspended_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Trigger a state change */</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* Enable AC Charging */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">ac_suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">suspended_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Trigger a state change */</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* Enable USB charging */</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">usb_suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">susp_status</span><span class="p">.</span><span class="n">suspended_change</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* Trigger a state change */</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Wrong input</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;Enter 0. Disable AC/USB Charging</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;1. Enable AC charging</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;2. Enable USB Charging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">};</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="n">abx500_chargalg_en_charger</span> <span class="o">=</span> \
<span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;chargalg&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IWUGO</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">abx500_chargalg_chg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">abx500_chargalg_en_charger</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sysfs_ops</span> <span class="n">abx500_chargalg_sysfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">abx500_chargalg_sysfs_charger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_type</span> <span class="n">abx500_chargalg_ktype</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sysfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">abx500_chargalg_sysfs_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">default_attrs</span> <span class="o">=</span> <span class="n">abx500_chargalg_chg</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_sysfs_exit() - de-init of sysfs entry</span>
<span class="cm"> * @di:                pointer to the struct abx500_chargalg</span>
<span class="cm"> *</span>
<span class="cm"> * This function removes the entry in sysfs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">abx500_chargalg_sysfs_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kobject_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_kobject</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * abx500_chargalg_sysfs_init() - init of sysfs entry</span>
<span class="cm"> * @di:                pointer to the struct abx500_chargalg</span>
<span class="cm"> *</span>
<span class="cm"> * This function adds an entry in sysfs.</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_sysfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kobject_init_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_kobject</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">abx500_chargalg_ktype</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;abx500_chargalg&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* Exposure to the sysfs interface &lt;&lt;END&gt;&gt; */</span>

<span class="cp">#if defined(CONFIG_PM)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Kick charger watchdog if charging (any charger online) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Run the charging algorithm directly to be sure we don&#39;t</span>
<span class="cm">	 * do it too seldom</span>
<span class="cm">	 */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">abx500_chargalg_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">online_chg</span><span class="p">)</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_periodic_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define abx500_chargalg_suspend      NULL</span>
<span class="cp">#define abx500_chargalg_resume       NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">abx500_chargalg_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* sysfs interface to enable/disbale charging from user space */</span>
	<span class="n">abx500_chargalg_sysfs_exit</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="cm">/* Delete the work queue */</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">);</span>

	<span class="n">flush_scheduled_work</span><span class="p">();</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">abx500_chargalg_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">abx500_bm_plat_data</span> <span class="o">*</span><span class="n">plat_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">abx500_chargalg</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span>
		<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">abx500_chargalg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* get device struct */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">plat_data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">chargalg</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">;</span>

	<span class="cm">/* chargalg supply */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;abx500_chargalg&quot;</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">abx500_chargalg_props</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">abx500_chargalg_props</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">abx500_chargalg_get_property</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">supplied_to</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">num_supplicants</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">.</span><span class="n">external_power_changed</span> <span class="o">=</span>
		<span class="n">abx500_chargalg_external_power_changed</span><span class="p">;</span>

	<span class="cm">/* Initilialize safety timer */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">abx500_chargalg_safety_timer_expired</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">safety_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">di</span><span class="p">;</span>

	<span class="cm">/* Initilialize maintenance timer */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span>
		<span class="n">abx500_chargalg_maintenance_timer_expired</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">maintenance_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">di</span><span class="p">;</span>

	<span class="cm">/* Create a work queue for the chargalg */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span> <span class="o">=</span>
		<span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;abx500_chargalg_wq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create work queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init work for chargalg */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_periodic_work</span><span class="p">,</span>
		<span class="n">abx500_chargalg_periodic_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wd_work</span><span class="p">,</span>
		<span class="n">abx500_chargalg_wd_work</span><span class="p">);</span>

	<span class="cm">/* Init work for chargalg */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_work</span><span class="p">,</span> <span class="n">abx500_chargalg_work</span><span class="p">);</span>

	<span class="cm">/* To detect charger at startup */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">chg_info</span><span class="p">.</span><span class="n">prev_conn_chg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Register chargalg power supply class */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register chargalg psy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_chargalg_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>

	<span class="cm">/* sysfs interface to enable/disable charging from user space */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_chargalg_sysfs_init</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create sysfs entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_psy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Run the charging algorithm */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probe success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">free_psy:</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_psy</span><span class="p">);</span>
<span class="nl">free_chargalg_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">chargalg_wq</span><span class="p">);</span>
<span class="nl">free_device_info:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">abx500_chargalg_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">abx500_chargalg_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">abx500_chargalg_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">abx500_chargalg_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">abx500_chargalg_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;abx500-chargalg&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">abx500_chargalg_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abx500_chargalg_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">abx500_chargalg_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">abx500_chargalg_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">abx500_chargalg_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">abx500_chargalg_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Johan Palsson, Karl Komierowski&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:abx500-chargalg&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;abx500 battery charging algorithm&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
