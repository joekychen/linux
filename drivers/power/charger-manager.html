<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › power › charger-manager.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>charger-manager.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This driver enables to monitor battery health and control charger</span>
<span class="cm"> * during suspend-to-mem.</span>
<span class="cm"> * Charger manager depends on other devices. register this later than</span>
<span class="cm"> * the depending devices.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">**/</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/rtc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/power/charger-manager.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">default_event_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CM_EVENT_UNKNOWN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CM_EVENT_BATT_FULL</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Battery Full&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CM_EVENT_BATT_IN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Battery Inserted&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CM_EVENT_BATT_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Battery Pulled Out&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CM_EVENT_EXT_PWR_IN_OUT</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;External Power Attach/Detach&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CM_EVENT_CHG_START_STOP</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Charging Start/Stop&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CM_EVENT_OTHERS</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Other battery events&quot;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Regard CM_JIFFIES_SMALL jiffies is small enough to ignore for</span>
<span class="cm"> * delayed works so that we can run delayed works with CM_JIFFIES_SMALL</span>
<span class="cm"> * without any delays.</span>
<span class="cm"> */</span>
<span class="cp">#define	CM_JIFFIES_SMALL	(2)</span>

<span class="cm">/* If y is valid (&gt; 0) and smaller than x, do x = y */</span>
<span class="cp">#define CM_MIN_VALID(x, y)	x = (((y &gt; 0) &amp;&amp; ((x) &gt; (y))) ? (y) : (x))</span>

<span class="cm">/*</span>
<span class="cm"> * Regard CM_RTC_SMALL (sec) is small enough to ignore error in invoking</span>
<span class="cm"> * rtc alarm. It should be 2 or larger</span>
<span class="cm"> */</span>
<span class="cp">#define CM_RTC_SMALL		(2)</span>

<span class="cp">#define UEVENT_BUF_SIZE		32</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cm_list</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">cm_list_mtx</span><span class="p">);</span>

<span class="cm">/* About in-suspend (suspend-again) monitoring */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtc_device</span> <span class="o">*</span><span class="n">rtc_dev</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Backup RTC alarm</span>
<span class="cm"> * Save the wakeup alarm before entering suspend-to-RAM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="n">rtc_wkalarm_save</span><span class="p">;</span>
<span class="cm">/* Backup RTC alarm time in terms of seconds since 01-01-1970 00:00:00 */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rtc_wkalarm_save_time</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">cm_suspended</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">cm_rtc_set</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cm_suspend_duration_ms</span><span class="p">;</span>

<span class="cm">/* About normal (not suspended) monitoring */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">polling_jiffy</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">;</span> <span class="cm">/* ULONG_MAX: no polling */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_polling</span><span class="p">;</span> <span class="cm">/* Next appointed polling time */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">cm_wq</span><span class="p">;</span> <span class="cm">/* init at driver add */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">cm_monitor_work</span><span class="p">;</span> <span class="cm">/* init at driver add */</span>

<span class="cm">/* Global charger-manager description */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">charger_global_desc</span> <span class="o">*</span><span class="n">g_desc</span><span class="p">;</span> <span class="cm">/* init with setup_charger_manager */</span>

<span class="cm">/**</span>
<span class="cm"> * is_batt_present - See if the battery presents in place.</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_batt_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">present</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">battery_present</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CM_BATTERY_PRESENT</span>:
		<span class="n">present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_NO_BATTERY</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_FUEL_GAUGE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
				<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span>
			<span class="n">present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_CHARGER_STAT</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span>
					<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">present</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_ext_pwr_online - See if an external power source is attached to charge</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if at least one of the chargers of the battery has an external</span>
<span class="cm"> * power source attached to charge the battery regardless of whether it is</span>
<span class="cm"> * actually charging or not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_ext_pwr_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">online</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If at least one of them has one, it&#39;s yes. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span>
				<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">online</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">online</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * get_batt_uV - Get the voltage level of the battery</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> * @uV: the voltage level returned.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if there is no error.</span>
<span class="cm"> * Returns a negative value on error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_batt_uV</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">uV</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
				<span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="o">*</span><span class="n">uV</span> <span class="o">=</span> <span class="n">val</span><span class="p">.</span><span class="n">intval</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_charging - Returns true if the battery is being charged.</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_charging</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">charging</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* If there is no battery, it cannot be charged */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_batt_present</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* If at least one of the charger is charging, return yes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 1. The charger sholuld not be DISABLED */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_enabled</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* 2. The charger should be online (ext-power) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span>
				<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot read ONLINE value from %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">intval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * 3. The charger should not be FULL, DISCHARGING,</span>
<span class="cm">		 * or NOT_CHARGING.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span>
				<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">POWER_SUPPLY_PROP_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot read STATUS value from %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">intval</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_STATUS_FULL</span> <span class="o">||</span>
				<span class="n">val</span><span class="p">.</span><span class="n">intval</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_STATUS_DISCHARGING</span> <span class="o">||</span>
				<span class="n">val</span><span class="p">.</span><span class="n">intval</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_STATUS_NOT_CHARGING</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Then, this is charging. */</span>
		<span class="n">charging</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">charging</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * is_polling_required - Return true if need to continue polling for this CM.</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_polling_required</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CM_POLL_DISABLE</span>:
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_POLL_ALWAYS</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_POLL_EXTERNAL_POWER_ONLY</span>:
		<span class="k">return</span> <span class="n">is_ext_pwr_online</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CM_POLL_CHARGING_ONLY</span>:
		<span class="k">return</span> <span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Incorrect polling_mode (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * try_charger_enable - Enable/Disable chargers altogether</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> * @enable: true: enable / false: disable</span>
<span class="cm"> *</span>
<span class="cm"> * Note that Charger Manager keeps the charger enabled regardless whether</span>
<span class="cm"> * the charger is charging or not (because battery is full or no external</span>
<span class="cm"> * power source exists) except when CM needs to disable chargers forcibly</span>
<span class="cm"> * bacause of emergency causes; when the battery is overheated or too cold.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_charger_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">charger_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* Ignore if it&#39;s redundent command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">num_charger_regulators</span><span class="p">,</span>
					<span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Abnormal battery state - Stop charging forcibly,</span>
<span class="cm">		 * even if charger was enabled at the other places</span>
<span class="cm">		 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">num_charger_regulators</span><span class="p">,</span>
					<span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">num_charger_regulators</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">regulator_is_enabled</span><span class="p">(</span>
				    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">regulator_force_disable</span><span class="p">(</span>
					<span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">consumer</span><span class="p">);</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;Disable regulator(%s) forcibly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * try_charger_restart - Restart charging.</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> *</span>
<span class="cm"> * Restart charging by turning off and on the charger.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_charger_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">try_charger_enable</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">try_charger_enable</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * uevent_notify - Let users know something has changed.</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> * @event: the event string.</span>
<span class="cm"> *</span>
<span class="cm"> * If @event is null, it implies that uevent_notify is called</span>
<span class="cm"> * by resume function. When called in the resume function, cm_suspended</span>
<span class="cm"> * should be already reset to false in order to let uevent_notify</span>
<span class="cm"> * notify the recent event during the suspend to users. While</span>
<span class="cm"> * suspended, uevent_notify does not notify users, but tracks</span>
<span class="cm"> * events so that uevent_notify can notify users later after resumed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uevent_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">env_str</span><span class="p">[</span><span class="n">UEVENT_BUF_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">env_str_save</span><span class="p">[</span><span class="n">UEVENT_BUF_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Nothing in suspended-event buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">env_str_save</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">env_str</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">UEVENT_BUF_SIZE</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span> <span class="cm">/* status not changed */</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">env_str_save</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">UEVENT_BUF_SIZE</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">env_str_save</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">UEVENT_BUF_SIZE</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* Duplicated. */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">env_str_save</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">UEVENT_BUF_SIZE</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No messages pending */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">env_str_save</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">strncpy</span><span class="p">(</span><span class="n">env_str</span><span class="p">,</span> <span class="n">env_str_save</span><span class="p">,</span> <span class="n">UEVENT_BUF_SIZE</span><span class="p">);</span>
		<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
		<span class="n">env_str_save</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* status not changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">env_str</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">UEVENT_BUF_SIZE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* save the status and notify the update */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">env_str</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">UEVENT_BUF_SIZE</span><span class="p">);</span>
	<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="n">KOBJ_CHANGE</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fullbatt_vchk - Check voltage drop some times after &quot;FULL&quot; event.</span>
<span class="cm"> * @work: the work_struct appointing the function</span>
<span class="cm"> *</span>
<span class="cm"> * If a user has designated &quot;fullbatt_vchkdrop_ms/uV&quot; values with</span>
<span class="cm"> * charger_desc, Charger Manager checks voltage drop after the battery</span>
<span class="cm"> * &quot;FULL&quot; event. It checks whether the voltage has dropped more than</span>
<span class="cm"> * fullbatt_vchkdrop_uV by calling this function after fullbatt_vchkrop_ms.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fullbatt_vchk</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span> <span class="o">=</span> <span class="n">to_delayed_work</span><span class="p">(</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">charger_manager</span><span class="p">,</span> <span class="n">fullbatt_vchk_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">charger_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">batt_uV</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">diff</span><span class="p">;</span>

	<span class="cm">/* remove the appointment for fullbatt_vchk */</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_uV</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_ms</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">get_batt_uV</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">batt_uV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: get_batt_uV error(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">diff</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_uV</span><span class="p">;</span>
	<span class="n">diff</span> <span class="o">-=</span> <span class="n">batt_uV</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBATT dropped %duV after full-batt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_uV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">try_charger_restart</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>
		<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="s">&quot;Recharge&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _cm_monitor - Monitor the temperature and return true for exceptions.</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if there is an event to notify for the battery.</span>
<span class="cm"> * (True if the status of &quot;emergency_stop&quot; changes)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">_cm_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">temperature_out_of_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;monitoring (%2.2d.%3.3dC)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* It has been stopped or charging already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="n">temp</span> <span class="o">==</span> <span class="o">!!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_charger_enable</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="s">&quot;OVERHEAT&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="s">&quot;COLD&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_charger_enable</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="s">&quot;CHARGING&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cm_monitor - Monitor every battery.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if there is an event to notify from any of the batteries.</span>
<span class="cm"> * (True if the status of &quot;emergency_stop&quot; changes)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">cm_monitor</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">stop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_cm_monitor</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
			<span class="n">stop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">stop</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * _setup_polling - Setup the next instance of polling.</span>
<span class="cm"> * @work: work_struct of the function _setup_polling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_setup_polling</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">min</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">keep_polling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">_next_polling</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_polling_required</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">keep_polling</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&gt;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span><span class="p">)</span>
				<span class="n">min</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">polling_jiffy</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">min</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">polling_jiffy</span> <span class="o">&lt;=</span> <span class="n">CM_JIFFIES_SMALL</span><span class="p">)</span>
		<span class="n">polling_jiffy</span> <span class="o">=</span> <span class="n">CM_JIFFIES_SMALL</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keep_polling</span><span class="p">)</span>
		<span class="n">polling_jiffy</span> <span class="o">=</span> <span class="n">ULONG_MAX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">polling_jiffy</span> <span class="o">==</span> <span class="n">ULONG_MAX</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">cm_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;charger-manager: workqueue not initialized&quot;</span>
			    <span class="s">&quot;. try it later. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">_next_polling</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">polling_jiffy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">time_after</span><span class="p">(</span><span class="n">next_polling</span><span class="p">,</span> <span class="n">_next_polling</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">);</span>
		<span class="n">next_polling</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">polling_jiffy</span><span class="p">;</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">,</span> <span class="n">polling_jiffy</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">setup_polling</span><span class="p">,</span> <span class="n">_setup_polling</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * cm_monitor_poller - The Monitor / Poller.</span>
<span class="cm"> * @work: work_struct of the function cm_monitor_poller</span>
<span class="cm"> *</span>
<span class="cm"> * During non-suspended state, cm_monitor_poller is used to poll and monitor</span>
<span class="cm"> * the batteries.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm_monitor_poller</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cm_monitor</span><span class="p">();</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_polling</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fullbatt_handler - Event handler for CM_EVENT_BATT_FULL</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fullbatt_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_uV</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_ms</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_suspended</span><span class="p">)</span>
		<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">))</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">,</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_ms</span><span class="p">));</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span>
				       <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_ms</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EVENT_HANDLE: Battery Fully Charged.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">default_event_names</span><span class="p">[</span><span class="n">CM_EVENT_BATT_FULL</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * battout_handler - Event handler for CM_EVENT_BATT_OUT</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">battout_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_suspended</span><span class="p">)</span>
		<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_batt_present</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_emerg</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery Pulled Out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">default_event_names</span><span class="p">[</span><span class="n">CM_EVENT_BATT_OUT</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="s">&quot;Battery Reinserted?&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * misc_event_handler - Handler for other evnets</span>
<span class="cm"> * @cm: the Charger Manager representing the battery.</span>
<span class="cm"> * @type: the Charger Manager representing the battery.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">misc_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">cm_event_types</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm_suspended</span><span class="p">)</span>
		<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">is_polling_required</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span><span class="p">)</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_polling</span><span class="p">);</span>
	<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">default_event_names</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">charger_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
		<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psy</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">charger_manager</span><span class="p">,</span> <span class="n">charger_psy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">charger_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">uV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_STATUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_CHARGING</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ext_pwr_online</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_NOT_CHARGING</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_STATUS_DISCHARGING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_HEALTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_OVERHEAT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_COLD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_batt_present</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_batt_uV</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
				<span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP</span>:
		<span class="cm">/* in thenth of centigrade */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span> <span class="o">==</span> <span class="n">INT_MIN</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">temperature_out_of_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span><span class="p">);</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">measure_battery_temp</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP_AMBIENT</span>:
		<span class="cm">/* in thenth of centigrade */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span> <span class="o">==</span> <span class="n">INT_MIN</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">temperature_out_of_range</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span><span class="p">);</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">measure_battery_temp</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_batt_present</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* There is no battery. Assume 100% */</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
					<span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Do not adjust SOC when charging: voltage is overrated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the capacity value is inconsistent, calibrate it base on</span>
<span class="cm">		 * the battery voltage values and the thresholds given as desc</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_batt_uV</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Voltage information not available. No calibration */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_uV</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">uV</span> <span class="o">&gt;=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_uV</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ONLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ext_pwr_online</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
			    <span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_ext_pwr_online</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Not full if it&#39;s charging. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Full if it&#39;s powered but not charging andi</span>
<span class="cm">			 * not forced stop by emergency</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Full if it&#39;s over the fullbatt voltage */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_batt_uV</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uV</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_uV</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">uV</span> <span class="o">&gt;=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_uV</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Full if the cap is 100 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
					<span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_charging</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
						<span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span><span class="p">,</span>
						<span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* If CHARGE_NOW is supplied, use it */</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NUM_CHARGER_PSY_OPTIONAL	(4)</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">default_charger_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Guaranteed to provide */</span>
	<span class="n">POWER_SUPPLY_PROP_STATUS</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_HEALTH</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span><span class="p">,</span>
	<span class="cm">/*</span>
<span class="cm">	 * Optional properties are:</span>
<span class="cm">	 * POWER_SUPPLY_PROP_CHARGE_NOW,</span>
<span class="cm">	 * POWER_SUPPLY_PROP_CURRENT_NOW,</span>
<span class="cm">	 * POWER_SUPPLY_PROP_TEMP, and</span>
<span class="cm">	 * POWER_SUPPLY_PROP_TEMP_AMBIENT,</span>
<span class="cm">	 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">power_supply</span> <span class="n">psy_default</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;battery&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">default_charger_props</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_charger_props</span><span class="p">),</span>
	<span class="p">.</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">charger_get_property</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * cm_setup_timer - For in-suspend monitoring setup wakeup alarm</span>
<span class="cm"> *		    for suspend_again.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the alarm is set for Charger Manager to use.</span>
<span class="cm"> * Returns false if</span>
<span class="cm"> *	cm_setup_timer fails to set an alarm,</span>
<span class="cm"> *	cm_setup_timer does not need to set an alarm for Charger Manager,</span>
<span class="cm"> *	or an alarm previously configured is to be used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">cm_setup_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wakeup_ms</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fbchk_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* fullbatt_vchk is required. setup timer for that */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fbchk_ms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span>
						    <span class="o">-</span> <span class="n">jiffies</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_eq_jiffies</span><span class="p">(</span>
				<span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span><span class="p">)</span> <span class="o">||</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">fbchk_ms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CM_JIFFIES_SMALL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fullbatt_vchk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
				<span class="n">fbchk_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">CM_MIN_VALID</span><span class="p">(</span><span class="n">wakeup_ms</span><span class="p">,</span> <span class="n">fbchk_ms</span><span class="p">);</span>

		<span class="cm">/* Skip if polling is not required for this CM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_polling_required</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">emergency_stop</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">CM_MIN_VALID</span><span class="p">(</span><span class="n">wakeup_ms</span><span class="p">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wakeup_ms</span> <span class="o">&lt;</span> <span class="n">UINT_MAX</span> <span class="o">&amp;&amp;</span> <span class="n">wakeup_ms</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Charger Manager wakeup timer: %u ms.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wakeup_ms</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtc_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time</span><span class="p">,</span> <span class="n">now</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">add</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wakeup_ms</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Set alarm with the polling interval (wakeup_ms)</span>
<span class="cm">			 * except when rtc_wkalarm_save comes first.</span>
<span class="cm">			 * However, the alarm time should be NOW +</span>
<span class="cm">			 * CM_RTC_SMALL or later.</span>
<span class="cm">			 */</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rtc_read_time</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
			<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">add</span> <span class="o">&lt;</span> <span class="n">CM_RTC_SMALL</span><span class="p">)</span>
				<span class="n">add</span> <span class="o">=</span> <span class="n">CM_RTC_SMALL</span><span class="p">;</span>
			<span class="n">time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">add</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtc_wkalarm_save</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rtc_wkalarm_save_time</span> <span class="o">&amp;&amp;</span>
			    <span class="n">rtc_wkalarm_save_time</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rtc_wkalarm_save_time</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">+</span> <span class="n">CM_RTC_SMALL</span><span class="p">)</span>
					<span class="n">time</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">CM_RTC_SMALL</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">time</span> <span class="o">=</span> <span class="n">rtc_wkalarm_save_time</span><span class="p">;</span>

				<span class="cm">/* The timer is not appointed by CM */</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Waking up after %lu secs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">time</span> <span class="o">-</span> <span class="n">now</span><span class="p">);</span>

			<span class="n">rtc_time_to_tm</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">.</span><span class="n">time</span><span class="p">);</span>
			<span class="n">rtc_set_alarm</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">cm_suspend_duration_ms</span> <span class="o">+=</span> <span class="n">wakeup_ms</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_dev</span><span class="p">)</span>
		<span class="n">rtc_set_alarm</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc_wkalarm_save</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_cm_fbchk_in_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jiffy_now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g_desc</span> <span class="o">&amp;&amp;</span> <span class="n">g_desc</span><span class="o">-&gt;</span><span class="n">assume_timer_stops_in_suspend</span><span class="p">)</span>
		<span class="n">jiffy_now</span> <span class="o">+=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">cm_suspend_duration_ms</span><span class="p">);</span>

	<span class="cm">/* Execute now if it&#39;s going to be executed not too long after */</span>
	<span class="n">jiffy_now</span> <span class="o">+=</span> <span class="n">CM_JIFFIES_SMALL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffy_now</span><span class="p">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span><span class="p">))</span>
		<span class="n">fullbatt_vchk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cm_suspend_again - Determine whether suspend again or not</span>
<span class="cm"> *</span>
<span class="cm"> * Returns true if the system should be suspended again</span>
<span class="cm"> * Returns false if the system should be woken up</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">cm_suspend_again</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_desc</span> <span class="o">||</span> <span class="o">!</span><span class="n">g_desc</span><span class="o">-&gt;</span><span class="n">rtc_only_wakeup</span> <span class="o">||</span> <span class="o">!</span><span class="n">g_desc</span><span class="o">-&gt;</span><span class="n">rtc_only_wakeup</span><span class="p">()</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">cm_rtc_set</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_monitor</span><span class="p">())</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_cm_fbchk_in_suspend</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">status_save_ext_pwr_inserted</span> <span class="o">!=</span> <span class="n">is_ext_pwr_online</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">cm</span><span class="o">-&gt;</span><span class="n">status_save_batt</span> <span class="o">!=</span> <span class="n">is_batt_present</span><span class="p">(</span><span class="n">cm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="n">cm_rtc_set</span> <span class="o">=</span> <span class="n">cm_setup_timer</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="cm">/* It&#39;s about the time when the non-CM appointed timer goes off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_wkalarm_save</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">rtc_read_time</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rtc_wkalarm_save_time</span> <span class="o">&amp;&amp;</span>
		    <span class="n">now</span> <span class="o">+</span> <span class="n">CM_RTC_SMALL</span> <span class="o">&gt;=</span> <span class="n">rtc_wkalarm_save_time</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cm_suspend_again</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * setup_charger_manager - initialize charger_global_desc data</span>
<span class="cm"> * @gd: pointer to instance of charger_global_desc</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">setup_charger_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_global_desc</span> <span class="o">*</span><span class="n">gd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtc_dev</span><span class="p">)</span>
		<span class="n">rtc_class_close</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">);</span>
	<span class="n">rtc_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">g_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">rtc_only_wakeup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;The callback rtc_only_wakeup is not given.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">rtc_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_dev</span> <span class="o">=</span> <span class="n">rtc_class_open</span><span class="p">(</span><span class="n">gd</span><span class="o">-&gt;</span><span class="n">rtc_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtc_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* Retry at probe. RTC may be not registered yet */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;No wakeup timer is given for charger manager.&quot;</span>
			<span class="s">&quot;In-suspend monitoring won&#39;t work.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">g_desc</span> <span class="o">=</span> <span class="n">gd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">setup_charger_manager</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">charger_manager_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">g_desc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rtc_dev</span> <span class="o">&amp;&amp;</span> <span class="n">g_desc</span><span class="o">-&gt;</span><span class="n">rtc_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtc_dev</span> <span class="o">=</span> <span class="n">rtc_class_open</span><span class="p">(</span><span class="n">g_desc</span><span class="o">-&gt;</span><span class="n">rtc_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtc_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get RTC %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">g_desc</span><span class="o">-&gt;</span><span class="n">rtc_name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data (desc) found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Basic Values. Unspecified are Null or 0 */</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot allocate memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_alloc_desc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_desc</span><span class="p">));</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">last_temp_mC</span> <span class="o">=</span> <span class="n">INT_MIN</span><span class="p">;</span> <span class="cm">/* denotes &quot;unmeasured, yet&quot; */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The following two do not need to be errors.</span>
<span class="cm">	 * Users may intentionally ignore those two features.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_uV</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ignoring full-battery voltage threshold&quot;</span>
					<span class="s">&quot; as it is not supplied.&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_ms</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_uV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling full-battery voltage drop &quot;</span>
				<span class="s">&quot;checking mechanism as it is not supplied.&quot;</span><span class="p">);</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">fullbatt_vchkdrop_uV</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span> <span class="o">||</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">num_charger_regulators</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;charger_regulators undefined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_no_charger</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No power supply defined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_charger_stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Counting index only */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_no_charger_stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">power_supply_get_by_name</span><span class="p">(</span>
					<span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot find power supply &quot;</span>
					<span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_chg_stat</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span> <span class="o">=</span> <span class="n">power_supply_get_by_name</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_fuel_gauge</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot find power supply </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_fuel_gauge</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_chg_stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">polling_interval_ms</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">CM_JIFFIES_SMALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;polling_interval_ms is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_chg_stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">temperature_out_of_range</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;there is no temperature_out_of_range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_chg_stat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cm</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psy_default</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psy_default</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">psy_name_buf</span><span class="p">,</span> <span class="n">psy_default</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">PSY_NAME_MAX</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">psy_name_buf</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">psy_name</span><span class="p">,</span> <span class="n">PSY_NAME_MAX</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">psy_name_buf</span><span class="p">;</span>

	<span class="cm">/* Allocate for psy properties because they may vary */</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">enum</span> <span class="n">power_supply_property</span><span class="p">)</span>
				<span class="o">*</span> <span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_charger_props</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">NUM_CHARGER_PSY_OPTIONAL</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot allocate for psy properties.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_chg_stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">,</span> <span class="n">default_charger_props</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">enum</span> <span class="n">power_supply_property</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_charger_props</span><span class="p">));</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">psy_default</span><span class="p">.</span><span class="n">num_properties</span><span class="p">;</span>

	<span class="cm">/* Find which optional psy-properties are available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
					  <span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span><span class="p">;</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fuel_gauge</span><span class="p">,</span>
					  <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">;</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">measure_battery_temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">POWER_SUPPLY_PROP_TEMP</span><span class="p">;</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">[</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">POWER_SUPPLY_PROP_TEMP_AMBIENT</span><span class="p">;</span>
		<span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">num_properties</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">,</span> <span class="n">fullbatt_vchk</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register charger-manager with&quot;</span>
				<span class="s">&quot; name </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">num_charger_regulators</span><span class="p">,</span>
				 <span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get charger regulators.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_bulk_get</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_charger_enable</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable charger regulators</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_chg_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add to the list */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Charger-manager is capable of waking up the systme from sleep</span>
<span class="cm">	 * when event is happend through cm_notify_event()</span>
<span class="cm">	 */</span>
	<span class="n">device_init_wakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_polling</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_chg_enable:</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">num_charger_regulators</span><span class="p">,</span>
			    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">);</span>
<span class="nl">err_bulk_get:</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">);</span>
<span class="nl">err_register:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">);</span>
<span class="nl">err_chg_stat:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">);</span>
<span class="nl">err_no_charger_stat:</span>
<span class="nl">err_no_charger:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
<span class="nl">err_alloc_desc:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>
<span class="nl">err_alloc:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">charger_manager_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">charger_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* Remove from the list */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_polling</span><span class="p">))</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_polling</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">))</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">);</span>

	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">num_charger_regulators</span><span class="p">,</span>
			    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">charger_regulators</span><span class="p">);</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">);</span>

	<span class="n">try_charger_enable</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_psy</span><span class="p">.</span><span class="n">properties</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">charger_manager_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;charger-manager&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">charger_manager_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cm_suspend_noirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_may_wakeup</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cm_suspend_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtc_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtc_time</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">;</span>

			<span class="n">rtc_read_alarm</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc_wkalarm_save</span><span class="p">);</span>
			<span class="n">rtc_read_time</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rtc_wkalarm_save</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_wkalarm_save</span><span class="p">.</span><span class="n">time</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">rtc_wkalarm_save_time</span><span class="p">);</span>
				<span class="n">rtc_tm_to_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">rtc_wkalarm_save_time</span><span class="p">)</span>
					<span class="n">rtc_wkalarm_save_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtc_wkalarm_save_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cm_suspended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">))</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">);</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">status_save_ext_pwr_inserted</span> <span class="o">=</span> <span class="n">is_ext_pwr_online</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>
	<span class="n">cm</span><span class="o">-&gt;</span><span class="n">status_save_batt</span> <span class="o">=</span> <span class="n">is_batt_present</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cm_rtc_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cm_suspend_duration_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cm_rtc_set</span> <span class="o">=</span> <span class="n">cm_setup_timer</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cm_suspend_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cm_suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtc_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rtc_wkalrm</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">rtc_read_alarm</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">rtc_wkalarm_save</span><span class="p">.</span><span class="n">pending</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">.</span><span class="n">pending</span><span class="p">;</span>
			<span class="n">rtc_set_alarm</span><span class="p">(</span><span class="n">rtc_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rtc_wkalarm_save</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cm_suspended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cm_rtc_set</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enqueue delayed work (fullbatt_vchk_work) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">CM_JIFFIES_SMALL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">now</span>
				<span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_jiffies_at</span><span class="p">));</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Account for cm_suspend_duration_ms if</span>
<span class="cm">		 * assume_timer_stops_in_suspend is active</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">g_desc</span> <span class="o">&amp;&amp;</span> <span class="n">g_desc</span><span class="o">-&gt;</span><span class="n">assume_timer_stops_in_suspend</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">cm_suspend_duration_ms</span><span class="p">)</span>
				<span class="n">delay</span> <span class="o">-=</span> <span class="n">cm_suspend_duration_ms</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">fullbatt_vchk_work</span><span class="p">,</span>
				   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">device_set_wakeup_capable</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">charger_manager_pm</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span> <span class="n">cm_suspend_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend_noirq</span>	<span class="o">=</span> <span class="n">cm_suspend_noirq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete</span>	<span class="o">=</span> <span class="n">cm_suspend_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">charger_manager_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;charger-manager&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">charger_manager_pm</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">charger_manager_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">charger_manager_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">charger_manager_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">charger_manager_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cm_wq</span> <span class="o">=</span> <span class="n">create_freezable_workqueue</span><span class="p">(</span><span class="s">&quot;charger_manager&quot;</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_monitor_work</span><span class="p">,</span> <span class="n">cm_monitor_poller</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">charger_manager_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">charger_manager_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">charger_manager_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">cm_wq</span><span class="p">);</span>
	<span class="n">cm_wq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">charger_manager_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">charger_manager_cleanup</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * find_power_supply - find the associated power_supply of charger</span>
<span class="cm"> * @cm: the Charger Manager representing the battery</span>
<span class="cm"> * @psy: pointer to instance of charger&#39;s power_supply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">find_power_supply</span><span class="p">(</span><span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psy</span> <span class="o">==</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">charger_stat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cm_notify_event - charger driver notify Charger Manager of charger event</span>
<span class="cm"> * @psy: pointer to instance of charger&#39;s power_supply</span>
<span class="cm"> * @type: type of charger event</span>
<span class="cm"> * @msg: optional message passed to uevent_notify fuction</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cm_notify_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cm_event_types</span> <span class="n">type</span><span class="p">,</span>
		     <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">charger_manager</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found_power_supply</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cm_list</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found_power_supply</span> <span class="o">=</span> <span class="n">find_power_supply</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">psy</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found_power_supply</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cm_list_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_power_supply</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CM_EVENT_BATT_FULL</span>:
		<span class="n">fullbatt_handler</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_EVENT_BATT_OUT</span>:
		<span class="n">battout_handler</span><span class="p">(</span><span class="n">cm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_EVENT_BATT_IN</span>:
	<span class="k">case</span> <span class="n">CM_EVENT_EXT_PWR_IN_OUT</span> <span class="p">...</span> <span class="n">CM_EVENT_CHG_START_STOP</span>:
		<span class="n">misc_event_handler</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CM_EVENT_UNKNOWN</span>:
	<span class="k">case</span> <span class="n">CM_EVENT_OTHERS</span>:
		<span class="n">uevent_notify</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">msg</span> <span class="o">?</span> <span class="n">msg</span> <span class="o">:</span> <span class="n">default_event_names</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s type not specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">cm_notify_event</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Charger Manager&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
