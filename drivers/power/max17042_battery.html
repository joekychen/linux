<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › power › max17042_battery.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>max17042_battery.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Fuel gauge driver for Maxim 17042 / 8966 / 8997</span>
<span class="cm"> *  Note that Maxim 8966 and 8997 are mfd and this is its subdevice.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Samsung Electronics</span>
<span class="cm"> * MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is based on max17040_battery.c</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/mod_devicetable.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/power/max17042_battery.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>

<span class="cm">/* Status register bits */</span>
<span class="cp">#define STATUS_POR_BIT         (1 &lt;&lt; 1)</span>
<span class="cp">#define STATUS_BST_BIT         (1 &lt;&lt; 3)</span>
<span class="cp">#define STATUS_VMN_BIT         (1 &lt;&lt; 8)</span>
<span class="cp">#define STATUS_TMN_BIT         (1 &lt;&lt; 9)</span>
<span class="cp">#define STATUS_SMN_BIT         (1 &lt;&lt; 10)</span>
<span class="cp">#define STATUS_BI_BIT          (1 &lt;&lt; 11)</span>
<span class="cp">#define STATUS_VMX_BIT         (1 &lt;&lt; 12)</span>
<span class="cp">#define STATUS_TMX_BIT         (1 &lt;&lt; 13)</span>
<span class="cp">#define STATUS_SMX_BIT         (1 &lt;&lt; 14)</span>
<span class="cp">#define STATUS_BR_BIT          (1 &lt;&lt; 15)</span>

<span class="cm">/* Interrupt mask bits */</span>
<span class="cp">#define CONFIG_ALRT_BIT_ENBL	(1 &lt;&lt; 2)</span>
<span class="cp">#define STATUS_INTR_SOCMIN_BIT	(1 &lt;&lt; 10)</span>
<span class="cp">#define STATUS_INTR_SOCMAX_BIT	(1 &lt;&lt; 14)</span>

<span class="cp">#define VFSOC0_LOCK		0x0000</span>
<span class="cp">#define VFSOC0_UNLOCK		0x0080</span>
<span class="cp">#define MODEL_UNLOCK1	0X0059</span>
<span class="cp">#define MODEL_UNLOCK2	0X00C4</span>
<span class="cp">#define MODEL_LOCK1		0X0000</span>
<span class="cp">#define MODEL_LOCK2		0X0000</span>

<span class="cp">#define dQ_ACC_DIV	0x4</span>
<span class="cp">#define dP_ACC_100	0x1900</span>
<span class="cp">#define dP_ACC_200	0x3200</span>

<span class="cp">#define MAX17042_IC_VERSION	0x0092</span>
<span class="cp">#define MAX17047_IC_VERSION	0x00AC	</span><span class="cm">/* same for max17050 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="n">battery</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">max170xx_chip_type</span> <span class="n">chip_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">max17042_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="kt">int</span>    <span class="n">init_complete</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max17042_set_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">max17042_reg_data</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">max17042_battery_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CYCLE_COUNT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_MAX</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_OCV</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_TEMP</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psy</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">max17042_chip</span><span class="p">,</span> <span class="n">battery</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">init_complete</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">MAX17042_STATUS_BattAbsent</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CYCLE_COUNT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_Cycles</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_MAX</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MinMaxVolt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*=</span> <span class="mi">20000</span><span class="p">;</span> <span class="cm">/* Units of LSB = 20mV */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">MAX17042</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_V_empty</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17047_V_empty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*=</span> <span class="mi">10000</span><span class="p">;</span> <span class="cm">/* Units of LSB = 10mV */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_VCELL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">*</span> <span class="mi">625</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_AvgVCELL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">*</span> <span class="mi">625</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_OCV</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_OCVInternal</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">*</span> <span class="mi">625</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RepSOC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_FULL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_TEMP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="cm">/* The value is signed. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x7fff</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* The value is converted into deci-centigrade scale */</span>
		<span class="cm">/* Units of LSB = 1 / 256 degree Celsius */</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_current_sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_Current</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Negative */</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="o">~</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span><span class="o">++</span><span class="p">;</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*=</span> <span class="mi">1562500</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">r_sns</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_current_sense</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
						<span class="n">MAX17042_AvgCurrent</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Negative */</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="o">~</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span><span class="o">++</span><span class="p">;</span>
				<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">*=</span> <span class="mi">1562500</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">r_sns</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_write_verify_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">read_value</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_word_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">read_value</span> <span class="o">=</span>  <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">retries</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&amp;&amp;</span> <span class="n">read_value</span> <span class="o">!=</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">max17042_override_por</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">max10742_unlock_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MLOCKReg1</span><span class="p">,</span> <span class="n">MODEL_UNLOCK1</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MLOCKReg2</span><span class="p">,</span> <span class="n">MODEL_UNLOCK2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">max10742_lock_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MLOCKReg1</span><span class="p">,</span> <span class="n">MODEL_LOCK1</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MLOCKReg2</span><span class="p">,</span> <span class="n">MODEL_LOCK2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">max17042_write_model_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="o">-&gt;</span><span class="n">cell_char_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">max17042_read_model_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">max17042_model_data_compare</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="n">u16</span> <span class="o">*</span><span class="n">data1</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s compare failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0x%x, 0x%x&quot;</span><span class="p">,</span>
				<span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data2</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_init_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">table_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="o">-&gt;</span><span class="n">cell_char_tbl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">temp_data</span><span class="p">;</span>

	<span class="n">temp_data</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">table_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">temp_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">max10742_unlock_model</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">max17042_write_model_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MAX17042_MODELChrTbl</span><span class="p">,</span>
				<span class="n">table_size</span><span class="p">);</span>
	<span class="n">max17042_read_model_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MAX17042_MODELChrTbl</span><span class="p">,</span> <span class="n">temp_data</span><span class="p">,</span>
				<span class="n">table_size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_model_data_compare</span><span class="p">(</span>
		<span class="n">chip</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="o">-&gt;</span><span class="n">cell_char_tbl</span><span class="p">,</span>
		<span class="n">temp_data</span><span class="p">,</span>
		<span class="n">table_size</span><span class="p">);</span>

	<span class="n">max10742_lock_model</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">temp_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_verify_model_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">table_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="o">-&gt;</span><span class="n">cell_char_tbl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">temp_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">temp_data</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">table_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">temp_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">max17042_read_model_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MAX17042_MODELChrTbl</span><span class="p">,</span> <span class="n">temp_data</span><span class="p">,</span>
				<span class="n">table_size</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">temp_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max17042_write_config_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_config_data</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="p">;</span>

	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_CONFIG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_LearnCFG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">learn_cfg</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FilterCFG</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">filter_cfg</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RelaxCFG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">relax_cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">MAX17047</span><span class="p">)</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17047_FullSOCThr</span><span class="p">,</span>
						<span class="n">config</span><span class="o">-&gt;</span><span class="n">full_soc_thresh</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>  <span class="nf">max17042_write_custom_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_config_data</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="p">;</span>

	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RCOMP0</span><span class="p">,</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">rcomp0</span><span class="p">);</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_TempCo</span><span class="p">,</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">tcompc0</span><span class="p">);</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_ICHGTerm</span><span class="p">,</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">ichgt_term</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">MAX17042</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_EmptyTempCo</span><span class="p">,</span>
					<span class="n">config</span><span class="o">-&gt;</span><span class="n">empty_tempco</span><span class="p">);</span>
		<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_K_empty0</span><span class="p">,</span>
					<span class="n">config</span><span class="o">-&gt;</span><span class="n">kempty0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17047_QRTbl00</span><span class="p">,</span>
						<span class="n">config</span><span class="o">-&gt;</span><span class="n">qrtbl00</span><span class="p">);</span>
		<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17047_QRTbl10</span><span class="p">,</span>
						<span class="n">config</span><span class="o">-&gt;</span><span class="n">qrtbl10</span><span class="p">);</span>
		<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17047_QRTbl20</span><span class="p">,</span>
						<span class="n">config</span><span class="o">-&gt;</span><span class="n">qrtbl20</span><span class="p">);</span>
		<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17047_QRTbl30</span><span class="p">,</span>
						<span class="n">config</span><span class="o">-&gt;</span><span class="n">qrtbl30</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max17042_update_capacity_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_config_data</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="p">;</span>

	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAP</span><span class="p">,</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">fullcap</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_DesignCap</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">design_cap</span><span class="p">);</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAPNom</span><span class="p">,</span>
				<span class="n">config</span><span class="o">-&gt;</span><span class="n">fullcapnom</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max17042_reset_vfsoc0_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">vfSoc</span><span class="p">;</span>

	<span class="n">vfSoc</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_VFSOC</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_VFSOC0Enable</span><span class="p">,</span> <span class="n">VFSOC0_UNLOCK</span><span class="p">);</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_VFSOC0</span><span class="p">,</span> <span class="n">vfSoc</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_VFSOC0Enable</span><span class="p">,</span> <span class="n">VFSOC0_LOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max17042_load_new_capacity_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">full_cap0</span><span class="p">,</span> <span class="n">rep_cap</span><span class="p">,</span> <span class="n">dq_acc</span><span class="p">,</span> <span class="n">vfSoc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rem_cap</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">max17042_config_data</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="p">;</span>

	<span class="n">full_cap0</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAP0</span><span class="p">);</span>
	<span class="n">vfSoc</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_VFSOC</span><span class="p">);</span>

	<span class="cm">/* fg_vfSoc needs to shifted by 8 bits to get the</span>
<span class="cm">	 * perc in 1% accuracy, to get the right rem_cap multiply</span>
<span class="cm">	 * full_cap0, fg_vfSoc and devide by 100</span>
<span class="cm">	 */</span>
	<span class="n">rem_cap</span> <span class="o">=</span> <span class="p">((</span><span class="n">vfSoc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">full_cap0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RemCap</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">rem_cap</span><span class="p">);</span>

	<span class="n">rep_cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">rem_cap</span><span class="p">;</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RepCap</span><span class="p">,</span> <span class="n">rep_cap</span><span class="p">);</span>

	<span class="cm">/* Write dQ_acc to 200% of Capacity and dP_acc to 200% */</span>
	<span class="n">dq_acc</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">fullcap</span> <span class="o">/</span> <span class="n">dQ_ACC_DIV</span><span class="p">;</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_dQacc</span><span class="p">,</span> <span class="n">dq_acc</span><span class="p">);</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_dPacc</span><span class="p">,</span> <span class="n">dP_ACC_200</span><span class="p">);</span>

	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAP</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">fullcap</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_DesignCap</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">design_cap</span><span class="p">);</span>
	<span class="n">max17042_write_verify_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAPNom</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">fullcapnom</span><span class="p">);</span>
	<span class="cm">/* Update SOC register with new SOC */</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RepSOC</span><span class="p">,</span> <span class="n">vfSoc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Block write all the override values coming from platform data.</span>
<span class="cm"> * This function MUST be called before the POR initialization proceedure</span>
<span class="cm"> * specified by maxim.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">max17042_override_por_values</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">max17042_config_data</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="p">;</span>

	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_TGAIN</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tgain</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAx17042_TOFF</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">toff</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_CGAIN</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">cgain</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_COFF</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">coff</span><span class="p">);</span>

	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_VALRT_Th</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">valrt_thresh</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_TALRT_Th</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">talrt_thresh</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_SALRT_Th</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">soc_alrt_thresh</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_CONFIG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_SHDNTIMER</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">shdntimer</span><span class="p">);</span>

	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_DesignCap</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">design_cap</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_ICHGTerm</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">ichgt_term</span><span class="p">);</span>

	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_AtRate</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">at_rate</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_LearnCFG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">learn_cfg</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FilterCFG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">filter_cfg</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RelaxCFG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">relax_cfg</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MiscCFG</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">misc_cfg</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MaskSOC</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">masksoc</span><span class="p">);</span>

	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAP</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">fullcap</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FullCAPNom</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">fullcapnom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">MAX17042</span><span class="p">)</span>
		<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_SOC_empty</span><span class="p">,</span>
						<span class="n">config</span><span class="o">-&gt;</span><span class="n">socempty</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_LAvg_empty</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">lavg_empty</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_dQacc</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dqacc</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_dPacc</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">dpacc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">MAX17042</span><span class="p">)</span>
		<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_V_empty</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vempty</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17047_V_empty</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vempty</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_TempNom</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">temp_nom</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_TempLim</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">temp_lim</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_FCTC</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">fctc</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RCOMP0</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rcomp0</span><span class="p">);</span>
	<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_TempCo</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">tcompc0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_EmptyTempCo</span><span class="p">,</span>
					<span class="n">config</span><span class="o">-&gt;</span><span class="n">empty_tempco</span><span class="p">);</span>
		<span class="n">max17042_override_por</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_K_empty0</span><span class="p">,</span>
					<span class="n">config</span><span class="o">-&gt;</span><span class="n">kempty0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">max17042_override_por_values</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* After Power up, the MAX17042 requires 500mS in order</span>
<span class="cm">	 * to perform signal debouncing and initial SOC reporting</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="cm">/* Initialize configaration */</span>
	<span class="n">max17042_write_config_regs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* write cell characterization data */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_init_model</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">max17042_verify_model_lock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s lock verify failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* write custom parameters */</span>
	<span class="n">max17042_write_custom_regs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* update capacity params */</span>
	<span class="n">max17042_update_capacity_regs</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* delay must be atleast 350mS to allow VFSOC</span>
<span class="cm">	 * to be calculated from the new configuration</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">350</span><span class="p">);</span>

	<span class="cm">/* reset vfsoc0 reg */</span>
	<span class="n">max17042_reset_vfsoc0_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* load new capacity params */</span>
	<span class="n">max17042_load_new_capacity_params</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* Init complete, Clear the POR bit */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_STATUS</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_STATUS</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">STATUS_POR_BIT</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max17042_set_soc_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">soc</span><span class="p">,</span> <span class="n">soc_tr</span><span class="p">;</span>

	<span class="cm">/* program interrupt thesholds such that we should</span>
<span class="cm">	 * get interrupt for every &#39;off&#39; perc change in the soc</span>
<span class="cm">	 */</span>
	<span class="n">soc</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_RepSOC</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">soc_tr</span> <span class="o">=</span> <span class="p">(</span><span class="n">soc</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">soc_tr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">soc</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
	<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_SALRT_Th</span><span class="p">,</span> <span class="n">soc_tr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">max17042_thread_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">STATUS_INTR_SOCMIN_BIT</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">STATUS_INTR_SOCMAX_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SOC threshold INTR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">max17042_set_soc_threshold</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">max17042_init_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">max17042_chip</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Initialize registers according to values from the platform data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_por_init</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">config_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_init_chip</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">init_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_OF</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">max17042_platform_data</span> <span class="o">*</span>
<span class="nf">max17042_get_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">of_node</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">max17042_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">np</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">pdata</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Require current sense resistor value to be specified for</span>
<span class="cm">	 * current-sense functionality to be enabled at all.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">of_property_read_u32</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s">&quot;maxim,rsns-microohm&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prop</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">r_sns</span> <span class="o">=</span> <span class="n">prop</span><span class="p">;</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_current_sense</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pdata</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">max17042_platform_data</span> <span class="o">*</span>
<span class="nf">max17042_get_pdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">max17042_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_WORD_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">max17042_get_pdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no platform data provided</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_DevName</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">MAX17042_IC_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;chip type max17042 detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">MAX17042</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">MAX17047_IC_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;chip type max17047/50 detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">MAX17047</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device version mismatch: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;max170xx_battery&quot;</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">type</span>		<span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">get_property</span>	<span class="o">=</span> <span class="n">max17042_get_property</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">properties</span>	<span class="o">=</span> <span class="n">max17042_battery_props</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">num_properties</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">max17042_battery_props</span><span class="p">);</span>

	<span class="cm">/* When current is not measured,</span>
<span class="cm">	 * CURRENT_NOW and CURRENT_AVG properties should be invisible. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_current_sense</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">r_sns</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">r_sns</span> <span class="o">=</span> <span class="n">MAX17042_DEFAULT_SNS_RESISTOR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">)</span>
		<span class="n">max17042_set_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_init_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">enable_current_sense</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_CGAIN</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_MiscCFG</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
		<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_LearnCFG</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed: power supply register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">max17042_thread_handler</span><span class="p">,</span>
						<span class="n">IRQF_TRIGGER_FALLING</span><span class="p">,</span>
						<span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span>  <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_CONFIG</span><span class="p">);</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">CONFIG_ALRT_BIT_ENBL</span><span class="p">;</span>
			<span class="n">max17042_write_reg</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_CONFIG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">max17042_set_soc_threshold</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(): cannot get IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">max17042_read_reg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">MAX17042_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">STATUS_POR_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">max17042_init_worker</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">init_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">max17042_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * disable the irq and enable irq_wake</span>
<span class="cm">	 * capability to the interrupt line.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">max17042_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">max17042_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="cm">/* re-program the SOC thresholds to 1% change */</span>
		<span class="n">max17042_set_soc_threshold</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">max17042_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">max17042_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">max17042_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define MAX17042_PM_OPS (&amp;max17042_pm_ops)</span>
<span class="cp">#else</span>
<span class="cp">#define MAX17042_PM_OPS NULL</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_OF</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">max17042_dt_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;maxim,max17042&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;maxim,max17047&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;maxim,max17050&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">max17042_dt_match</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">max17042_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;max17042&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max17047&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;max17050&quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">max17042_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">max17042_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;max17042&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">of_match_ptr</span><span class="p">(</span><span class="n">max17042_dt_match</span><span class="p">),</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="n">MAX17042_PM_OPS</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">max17042_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">max17042_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">max17042_id</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">max17042_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;MyungJoo Ham &lt;myungjoo.ham@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MAX17042 Fuel Gauge&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
