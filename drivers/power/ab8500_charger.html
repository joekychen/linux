<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › power › ab8500_charger.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ab8500_charger.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2012</span>
<span class="cm"> *</span>
<span class="cm"> * Charger driver for AB8500</span>
<span class="cm"> *</span>
<span class="cm"> * License Terms: GNU General Public License v2</span>
<span class="cm"> * Author:</span>
<span class="cm"> *	Johan Palsson &lt;johan.palsson@stericsson.com&gt;</span>
<span class="cm"> *	Karl Komierowski &lt;karl.komierowski@stericsson.com&gt;</span>
<span class="cm"> *	Arun R Murthy &lt;arun.murthy@stericsson.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/kobject.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500-bm.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500-gpadc.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ux500_chargalg.h&gt;</span>
<span class="cp">#include &lt;linux/usb/otg.h&gt;</span>

<span class="cm">/* Charger constants */</span>
<span class="cp">#define NO_PW_CONN			0</span>
<span class="cp">#define AC_PW_CONN			1</span>
<span class="cp">#define USB_PW_CONN			2</span>

<span class="cp">#define MAIN_WDOG_ENA			0x01</span>
<span class="cp">#define MAIN_WDOG_KICK			0x02</span>
<span class="cp">#define MAIN_WDOG_DIS			0x00</span>
<span class="cp">#define CHARG_WD_KICK			0x01</span>
<span class="cp">#define MAIN_CH_ENA			0x01</span>
<span class="cp">#define MAIN_CH_NO_OVERSHOOT_ENA_N	0x02</span>
<span class="cp">#define USB_CH_ENA			0x01</span>
<span class="cp">#define USB_CHG_NO_OVERSHOOT_ENA_N	0x02</span>
<span class="cp">#define MAIN_CH_DET			0x01</span>
<span class="cp">#define MAIN_CH_CV_ON			0x04</span>
<span class="cp">#define USB_CH_CV_ON			0x08</span>
<span class="cp">#define VBUS_DET_DBNC100		0x02</span>
<span class="cp">#define VBUS_DET_DBNC1			0x01</span>
<span class="cp">#define OTP_ENABLE_WD			0x01</span>

<span class="cp">#define MAIN_CH_INPUT_CURR_SHIFT	4</span>
<span class="cp">#define VBUS_IN_CURR_LIM_SHIFT		4</span>

<span class="cp">#define LED_INDICATOR_PWM_ENA		0x01</span>
<span class="cp">#define LED_INDICATOR_PWM_DIS		0x00</span>
<span class="cp">#define LED_IND_CUR_5MA			0x04</span>
<span class="cp">#define LED_INDICATOR_PWM_DUTY_252_256	0xBF</span>

<span class="cm">/* HW failure constants */</span>
<span class="cp">#define MAIN_CH_TH_PROT			0x02</span>
<span class="cp">#define VBUS_CH_NOK			0x08</span>
<span class="cp">#define USB_CH_TH_PROT			0x02</span>
<span class="cp">#define VBUS_OVV_TH			0x01</span>
<span class="cp">#define MAIN_CH_NOK			0x01</span>
<span class="cp">#define VBUS_DET			0x80</span>

<span class="cm">/* UsbLineStatus register bit masks */</span>
<span class="cp">#define AB8500_USB_LINK_STATUS		0x78</span>
<span class="cp">#define AB8500_STD_HOST_SUSP		0x18</span>

<span class="cm">/* Watchdog timeout constant */</span>
<span class="cp">#define WD_TIMER			0x30 </span><span class="cm">/* 4min */</span><span class="cp"></span>
<span class="cp">#define WD_KICK_INTERVAL		(60 * HZ)</span>

<span class="cm">/* Lowest charger voltage is 3.39V -&gt; 0x4E */</span>
<span class="cp">#define LOW_VOLT_REG			0x4E</span>

<span class="cm">/* UsbLineStatus register - usb types */</span>
<span class="k">enum</span> <span class="n">ab8500_charger_link_status</span> <span class="p">{</span>
	<span class="n">USB_STAT_NOT_CONFIGURED</span><span class="p">,</span>
	<span class="n">USB_STAT_STD_HOST_NC</span><span class="p">,</span>
	<span class="n">USB_STAT_STD_HOST_C_NS</span><span class="p">,</span>
	<span class="n">USB_STAT_STD_HOST_C_S</span><span class="p">,</span>
	<span class="n">USB_STAT_HOST_CHG_NM</span><span class="p">,</span>
	<span class="n">USB_STAT_HOST_CHG_HS</span><span class="p">,</span>
	<span class="n">USB_STAT_HOST_CHG_HS_CHIRP</span><span class="p">,</span>
	<span class="n">USB_STAT_DEDICATED_CHG</span><span class="p">,</span>
	<span class="n">USB_STAT_ACA_RID_A</span><span class="p">,</span>
	<span class="n">USB_STAT_ACA_RID_B</span><span class="p">,</span>
	<span class="n">USB_STAT_ACA_RID_C_NM</span><span class="p">,</span>
	<span class="n">USB_STAT_ACA_RID_C_HS</span><span class="p">,</span>
	<span class="n">USB_STAT_ACA_RID_C_HS_CHIRP</span><span class="p">,</span>
	<span class="n">USB_STAT_HM_IDGND</span><span class="p">,</span>
	<span class="n">USB_STAT_RESERVED</span><span class="p">,</span>
	<span class="n">USB_STAT_NOT_VALID_LINK</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ab8500_usb_state</span> <span class="p">{</span>
	<span class="n">AB8500_BM_USB_STATE_RESET_HS</span><span class="p">,</span>	<span class="cm">/* HighSpeed Reset */</span>
	<span class="n">AB8500_BM_USB_STATE_RESET_FS</span><span class="p">,</span>	<span class="cm">/* FullSpeed/LowSpeed Reset */</span>
	<span class="n">AB8500_BM_USB_STATE_CONFIGURED</span><span class="p">,</span>
	<span class="n">AB8500_BM_USB_STATE_SUSPEND</span><span class="p">,</span>
	<span class="n">AB8500_BM_USB_STATE_RESUME</span><span class="p">,</span>
	<span class="n">AB8500_BM_USB_STATE_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* VBUS input current limits supported in AB8500 in mA */</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P05		50</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P09		98</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P19		193</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P29		290</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P38		380</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P45		450</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P5		500</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P6		600</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P7		700</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P8		800</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_0P9		900</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_1P0		1000</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_1P1		1100</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_1P3		1300</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_1P4		1400</span>
<span class="cp">#define USB_CH_IP_CUR_LVL_1P5		1500</span>

<span class="cp">#define VBAT_TRESH_IP_CUR_RED		3800</span>

<span class="cp">#define to_ab8500_charger_usb_device_info(x) container_of((x), \</span>
<span class="cp">	struct ab8500_charger, usb_chg)</span>
<span class="cp">#define to_ab8500_charger_ac_device_info(x) container_of((x), \</span>
<span class="cp">	struct ab8500_charger, ac_chg)</span>

<span class="cm">/**</span>
<span class="cm"> * struct ab8500_charger_interrupts - ab8500 interupts</span>
<span class="cm"> * @name:	name of the interrupt</span>
<span class="cm"> * @isr		function pointer to the isr</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_charger_interrupts</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span><span class="p">)(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_charger_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">charger_connected</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">charger_online</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">charger_voltage</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cv_active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wd_expired</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_charger_event_flags</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">mainextchnotok</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">main_thermal_prot</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usb_thermal_prot</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vbus_ovv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usbchargernotok</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">chgwdexp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vbus_collapse</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_charger_usb_state</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">usb_changed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_current</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ab8500_usb_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">usb_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct ab8500_charger - ab8500 Charger device information</span>
<span class="cm"> * @dev:		Pointer to the structure device</span>
<span class="cm"> * @max_usb_in_curr:	Max USB charger input current</span>
<span class="cm"> * @vbus_detected:	VBUS detected</span>
<span class="cm"> * @vbus_detected_start:</span>
<span class="cm"> *			VBUS detected during startup</span>
<span class="cm"> * @ac_conn:		This will be true when the AC charger has been plugged</span>
<span class="cm"> * @vddadc_en_ac:	Indicate if VDD ADC supply is enabled because AC</span>
<span class="cm"> *			charger is enabled</span>
<span class="cm"> * @vddadc_en_usb:	Indicate if VDD ADC supply is enabled because USB</span>
<span class="cm"> *			charger is enabled</span>
<span class="cm"> * @vbat		Battery voltage</span>
<span class="cm"> * @old_vbat		Previously measured battery voltage</span>
<span class="cm"> * @autopower		Indicate if we should have automatic pwron after pwrloss</span>
<span class="cm"> * @parent:		Pointer to the struct ab8500</span>
<span class="cm"> * @gpadc:		Pointer to the struct gpadc</span>
<span class="cm"> * @pdata:		Pointer to the abx500_charger platform data</span>
<span class="cm"> * @bat:		Pointer to the abx500_bm platform data</span>
<span class="cm"> * @flags:		Structure for information about events triggered</span>
<span class="cm"> * @usb_state:		Structure for usb stack information</span>
<span class="cm"> * @ac_chg:		AC charger power supply</span>
<span class="cm"> * @usb_chg:		USB charger power supply</span>
<span class="cm"> * @ac:			Structure that holds the AC charger properties</span>
<span class="cm"> * @usb:		Structure that holds the USB charger properties</span>
<span class="cm"> * @regu:		Pointer to the struct regulator</span>
<span class="cm"> * @charger_wq:		Work queue for the IRQs and checking HW state</span>
<span class="cm"> * @check_vbat_work	Work for checking vbat threshold to adjust vbus current</span>
<span class="cm"> * @check_hw_failure_work:	Work for checking HW state</span>
<span class="cm"> * @check_usbchgnotok_work:	Work for checking USB charger not ok status</span>
<span class="cm"> * @kick_wd_work:		Work for kicking the charger watchdog in case</span>
<span class="cm"> *				of ABB rev 1.* due to the watchog logic bug</span>
<span class="cm"> * @ac_work:			Work for checking AC charger connection</span>
<span class="cm"> * @detect_usb_type_work:	Work for detecting the USB type connected</span>
<span class="cm"> * @usb_link_status_work:	Work for checking the new USB link status</span>
<span class="cm"> * @usb_state_changed_work:	Work for checking USB state</span>
<span class="cm"> * @check_main_thermal_prot_work:</span>
<span class="cm"> *				Work for checking Main thermal status</span>
<span class="cm"> * @check_usb_thermal_prot_work:</span>
<span class="cm"> *				Work for checking USB thermal status</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_usb_in_curr</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vbus_detected</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vbus_detected_start</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ac_conn</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vddadc_en_ac</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vddadc_en_usb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vbat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_vbat</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">autopower</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_gpadc</span> <span class="o">*</span><span class="n">gpadc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_charger_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_bm_data</span> <span class="o">*</span><span class="n">bat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger_event_flags</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger_usb_state</span> <span class="n">usb_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ux500_charger</span> <span class="n">ac_chg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ux500_charger</span> <span class="n">usb_chg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger_info</span> <span class="n">ac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger_info</span> <span class="n">usb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator</span> <span class="o">*</span><span class="n">regu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">charger_wq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">check_vbat_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">check_hw_failure_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">check_usbchgnotok_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">kick_wd_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">ac_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">detect_usb_type_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">usb_link_status_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">usb_state_changed_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">check_main_thermal_prot_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">check_usb_thermal_prot_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_phy</span> <span class="o">*</span><span class="n">usb_phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">nb</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* AC properties */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">ab8500_charger_ac_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_HEALTH</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* USB properties */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">ab8500_charger_usb_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_HEALTH</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_power_loss_handling - set how we handle powerloss.</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Magic nummbers are from STE HW department.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_power_loss_handling</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Autopower : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">autopower</span><span class="p">);</span>

	<span class="cm">/* read the autopower register */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable the OPT emulation registers */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">autopower</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8</span><span class="p">;</span>

	<span class="cm">/* write back the changed value to autopower reg */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable the set OTP registers again */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_power_supply_changed - a wrapper with local extentions for</span>
<span class="cm"> * power_supply_changed</span>
<span class="cm"> * @di:	  pointer to the ab8500_charger structure</span>
<span class="cm"> * @psy:  pointer to power_supply_that have changed.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_power_supply_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">autopower_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_connected</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span> <span class="o">&amp;&amp;</span>
		    <span class="n">di</span><span class="o">-&gt;</span><span class="n">autopower</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">autopower</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">ab8500_power_loss_handling</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">autopower</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span> <span class="o">||</span>
			    <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">autopower</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ab8500_power_loss_handling</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">connected</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">connected</span> <span class="o">!=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB connected:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">connected</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_connected</span> <span class="o">=</span> <span class="n">connected</span><span class="p">;</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;present&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_get_ac_voltage() - get ac charger voltage</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns ac charger voltage (on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_get_ac_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vch</span><span class="p">;</span>

	<span class="cm">/* Only measure voltage if the charger is connected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vch</span> <span class="o">=</span> <span class="n">ab8500_gpadc_convert</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span><span class="p">,</span> <span class="n">MAIN_CHARGER_V</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s gpadc conv failed,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">vch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_ac_cv() - check if the main charger is in CV mode</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns ac charger CV mode (on success) else error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_ac_cv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Only check CV mode if the charger is online */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_STATUS1_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MAIN_CH_CV_ON</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_get_vbus_voltage() - get vbus voltage</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the vbus voltage.</span>
<span class="cm"> * Returns vbus voltage (on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_get_vbus_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vch</span><span class="p">;</span>

	<span class="cm">/* Only measure voltage if the charger is connected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vch</span> <span class="o">=</span> <span class="n">ab8500_gpadc_convert</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span><span class="p">,</span> <span class="n">VBUS_V</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s gpadc conv failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">vch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_get_usb_current() - get usb charger current</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the usb charger current.</span>
<span class="cm"> * Returns usb current (on success) and error code on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_get_usb_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ich</span><span class="p">;</span>

	<span class="cm">/* Only measure current if the charger is online */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ich</span> <span class="o">=</span> <span class="n">ab8500_gpadc_convert</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span><span class="p">,</span> <span class="n">USB_CHARGER_C</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ich</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s gpadc conv failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ich</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ich</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_get_ac_current() - get ac charger current</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the ac charger current.</span>
<span class="cm"> * Returns ac current (on success) and error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_get_ac_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ich</span><span class="p">;</span>

	<span class="cm">/* Only measure current if the charger is online */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ich</span> <span class="o">=</span> <span class="n">ab8500_gpadc_convert</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span><span class="p">,</span> <span class="n">MAIN_CHARGER_C</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ich</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s gpadc conv failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ich</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ich</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usb_cv() - check if the usb charger is in CV mode</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns ac charger CV mode (on success) else error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_usb_cv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Only check CV mode if the charger is online */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_USBCH_STAT1_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">USB_CH_CV_ON</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_detect_chargers() - Detect the connected chargers</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the type of charger connected.</span>
<span class="cm"> * For USB it will not mean we can actually charge from it</span>
<span class="cm"> * but that there is a USB cable connected that we have to</span>
<span class="cm"> * identify. This is used during startup when we don&#39;t get</span>
<span class="cm"> * interrupts of the charger detection</span>
<span class="cm"> *</span>
<span class="cm"> * Returns an integer value, that means,</span>
<span class="cm"> * NO_PW_CONN  no power supply is connected</span>
<span class="cm"> * AC_PW_CONN  if the AC power supply is connected</span>
<span class="cm"> * USB_PW_CONN  if the USB power supply is connected</span>
<span class="cm"> * AC_PW_CONN + USB_PW_CONN if USB and AC power supplies are both connected</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_detect_chargers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">NO_PW_CONN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Check for AC charger */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_CH_STATUS1_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">MAIN_CH_DET</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">AC_PW_CONN</span><span class="p">;</span>

	<span class="cm">/* Check for USB charger */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_CH_USBCH_STAT1_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VBUS_DET_DBNC1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VBUS_DET_DBNC100</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">|=</span> <span class="n">USB_PW_CONN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_max_usb_curr() - get the max curr for the USB type</span>
<span class="cm"> * @di:			pointer to the ab8500_charger structure</span>
<span class="cm"> * @link_status:	the identified USB type</span>
<span class="cm"> *</span>
<span class="cm"> * Get the maximum current that is allowed to be drawn from the host</span>
<span class="cm"> * based on the USB type.</span>
<span class="cm"> * Returns error code in case of failure else 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_max_usb_curr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">ab8500_charger_link_status</span> <span class="n">link_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">link_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_STAT_STD_HOST_NC</span>:
	<span class="k">case</span> <span class="n">USB_STAT_STD_HOST_C_NS</span>:
	<span class="k">case</span> <span class="n">USB_STAT_STD_HOST_C_S</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Type - Standard host is &quot;</span>
			<span class="s">&quot;detected through USB driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P09</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_STAT_HOST_CHG_HS_CHIRP</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_STAT_HOST_CHG_HS</span>:
	<span class="k">case</span> <span class="n">USB_STAT_ACA_RID_C_HS</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_STAT_ACA_RID_A</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Dedicated charger level minus maximum current accessory</span>
<span class="cm">		 * can consume (300mA). Closest level is 1100mA</span>
<span class="cm">		 */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_1P1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_STAT_ACA_RID_B</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Dedicated charger level minus 120mA (20mA for ACA and</span>
<span class="cm">		 * 100mA for potential accessory). Closest level is 1300mA</span>
<span class="cm">		 */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_1P3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_STAT_DEDICATED_CHG</span>:
	<span class="k">case</span> <span class="n">USB_STAT_HOST_CHG_NM</span>:
	<span class="k">case</span> <span class="n">USB_STAT_ACA_RID_C_HS_CHIRP</span>:
	<span class="k">case</span> <span class="n">USB_STAT_ACA_RID_C_NM</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_1P5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_STAT_RESERVED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This state is used to indicate that VBUS has dropped below</span>
<span class="cm">		 * the detection level 4 times in a row. This is due to the</span>
<span class="cm">		 * charger output current is set to high making the charger</span>
<span class="cm">		 * voltage collapse. This have to be propagated through to</span>
<span class="cm">		 * chargalg. This is done using the property</span>
<span class="cm">		 * POWER_SUPPLY_PROP_CURRENT_AVG = 1</span>
<span class="cm">		 */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_collapse</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Type - USB_STAT_RESERVED &quot;</span>
			<span class="s">&quot;VBUS has collapsed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">USB_STAT_HM_IDGND</span>:
	<span class="k">case</span> <span class="n">USB_STAT_NOT_CONFIGURED</span>:
	<span class="k">case</span> <span class="n">USB_STAT_NOT_VALID_LINK</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Type - Charging not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P05</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Type - Unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P05</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB Type - 0x%02x MaxCurr: %d&quot;</span><span class="p">,</span>
		<span class="n">link_status</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_read_usb_type() - read the type of usb connected</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Detect the type of the plugged USB</span>
<span class="cm"> * Returns error code in case of failure else 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_read_usb_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_INTERRUPT</span><span class="p">,</span> <span class="n">AB8500_IT_SOURCE21_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_USB</span><span class="p">,</span>
		<span class="n">AB8500_USB_LINE_STAT_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the USB type */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AB8500_USB_LINK_STATUS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_max_usb_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
		<span class="p">(</span><span class="k">enum</span> <span class="n">ab8500_charger_link_status</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_detect_usb_type() - get the type of usb connected</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Detect the type of the plugged USB</span>
<span class="cm"> * Returns error code in case of failure else 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_detect_usb_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On getting the VBUS rising edge detect interrupt there</span>
<span class="cm">	 * is a 250ms delay after which the register UsbLineStatus</span>
<span class="cm">	 * is filled with valid data.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_INTERRUPT</span><span class="p">,</span> <span class="n">AB8500_IT_SOURCE21_REG</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_USB</span><span class="p">,</span>
			<span class="n">AB8500_USB_LINE_STAT_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Until the IT source register is read the UsbLineStatus</span>
<span class="cm">		 * register is not updated, hence doing the same</span>
<span class="cm">		 * Revisit this:</span>
<span class="cm">		 */</span>

		<span class="cm">/* get the USB type */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AB8500_USB_LINK_STATUS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_max_usb_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
		<span class="p">(</span><span class="k">enum</span> <span class="n">ab8500_charger_link_status</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This array maps the raw hex value to charger voltage used by the AB8500</span>
<span class="cm"> * Values taken from the UM0836</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ab8500_charger_voltage_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">3500</span> <span class="p">,</span>
	<span class="mi">3525</span> <span class="p">,</span>
	<span class="mi">3550</span> <span class="p">,</span>
	<span class="mi">3575</span> <span class="p">,</span>
	<span class="mi">3600</span> <span class="p">,</span>
	<span class="mi">3625</span> <span class="p">,</span>
	<span class="mi">3650</span> <span class="p">,</span>
	<span class="mi">3675</span> <span class="p">,</span>
	<span class="mi">3700</span> <span class="p">,</span>
	<span class="mi">3725</span> <span class="p">,</span>
	<span class="mi">3750</span> <span class="p">,</span>
	<span class="mi">3775</span> <span class="p">,</span>
	<span class="mi">3800</span> <span class="p">,</span>
	<span class="mi">3825</span> <span class="p">,</span>
	<span class="mi">3850</span> <span class="p">,</span>
	<span class="mi">3875</span> <span class="p">,</span>
	<span class="mi">3900</span> <span class="p">,</span>
	<span class="mi">3925</span> <span class="p">,</span>
	<span class="mi">3950</span> <span class="p">,</span>
	<span class="mi">3975</span> <span class="p">,</span>
	<span class="mi">4000</span> <span class="p">,</span>
	<span class="mi">4025</span> <span class="p">,</span>
	<span class="mi">4050</span> <span class="p">,</span>
	<span class="mi">4060</span> <span class="p">,</span>
	<span class="mi">4070</span> <span class="p">,</span>
	<span class="mi">4080</span> <span class="p">,</span>
	<span class="mi">4090</span> <span class="p">,</span>
	<span class="mi">4100</span> <span class="p">,</span>
	<span class="mi">4110</span> <span class="p">,</span>
	<span class="mi">4120</span> <span class="p">,</span>
	<span class="mi">4130</span> <span class="p">,</span>
	<span class="mi">4140</span> <span class="p">,</span>
	<span class="mi">4150</span> <span class="p">,</span>
	<span class="mi">4160</span> <span class="p">,</span>
	<span class="mi">4170</span> <span class="p">,</span>
	<span class="mi">4180</span> <span class="p">,</span>
	<span class="mi">4190</span> <span class="p">,</span>
	<span class="mi">4200</span> <span class="p">,</span>
	<span class="mi">4210</span> <span class="p">,</span>
	<span class="mi">4220</span> <span class="p">,</span>
	<span class="mi">4230</span> <span class="p">,</span>
	<span class="mi">4240</span> <span class="p">,</span>
	<span class="mi">4250</span> <span class="p">,</span>
	<span class="mi">4260</span> <span class="p">,</span>
	<span class="mi">4270</span> <span class="p">,</span>
	<span class="mi">4280</span> <span class="p">,</span>
	<span class="mi">4290</span> <span class="p">,</span>
	<span class="mi">4300</span> <span class="p">,</span>
	<span class="mi">4310</span> <span class="p">,</span>
	<span class="mi">4320</span> <span class="p">,</span>
	<span class="mi">4330</span> <span class="p">,</span>
	<span class="mi">4340</span> <span class="p">,</span>
	<span class="mi">4350</span> <span class="p">,</span>
	<span class="mi">4360</span> <span class="p">,</span>
	<span class="mi">4370</span> <span class="p">,</span>
	<span class="mi">4380</span> <span class="p">,</span>
	<span class="mi">4390</span> <span class="p">,</span>
	<span class="mi">4400</span> <span class="p">,</span>
	<span class="mi">4410</span> <span class="p">,</span>
	<span class="mi">4420</span> <span class="p">,</span>
	<span class="mi">4430</span> <span class="p">,</span>
	<span class="mi">4440</span> <span class="p">,</span>
	<span class="mi">4450</span> <span class="p">,</span>
	<span class="mi">4460</span> <span class="p">,</span>
	<span class="mi">4470</span> <span class="p">,</span>
	<span class="mi">4480</span> <span class="p">,</span>
	<span class="mi">4490</span> <span class="p">,</span>
	<span class="mi">4500</span> <span class="p">,</span>
	<span class="mi">4510</span> <span class="p">,</span>
	<span class="mi">4520</span> <span class="p">,</span>
	<span class="mi">4530</span> <span class="p">,</span>
	<span class="mi">4540</span> <span class="p">,</span>
	<span class="mi">4550</span> <span class="p">,</span>
	<span class="mi">4560</span> <span class="p">,</span>
	<span class="mi">4570</span> <span class="p">,</span>
	<span class="mi">4580</span> <span class="p">,</span>
	<span class="mi">4590</span> <span class="p">,</span>
	<span class="mi">4600</span> <span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This array maps the raw hex value to charger current used by the AB8500</span>
<span class="cm"> * Values taken from the UM0836</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ab8500_charger_current_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">100</span> <span class="p">,</span>
	<span class="mi">200</span> <span class="p">,</span>
	<span class="mi">300</span> <span class="p">,</span>
	<span class="mi">400</span> <span class="p">,</span>
	<span class="mi">500</span> <span class="p">,</span>
	<span class="mi">600</span> <span class="p">,</span>
	<span class="mi">700</span> <span class="p">,</span>
	<span class="mi">800</span> <span class="p">,</span>
	<span class="mi">900</span> <span class="p">,</span>
	<span class="mi">1000</span> <span class="p">,</span>
	<span class="mi">1100</span> <span class="p">,</span>
	<span class="mi">1200</span> <span class="p">,</span>
	<span class="mi">1300</span> <span class="p">,</span>
	<span class="mi">1400</span> <span class="p">,</span>
	<span class="mi">1500</span> <span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This array maps the raw hex value to VBUS input current used by the AB8500</span>
<span class="cm"> * Values taken from the UM0836</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ab8500_charger_vbus_in_curr_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P05</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P09</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P19</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P29</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P38</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P45</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P5</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P6</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P7</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P8</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_0P9</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_1P0</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_1P1</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_1P3</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_1P4</span><span class="p">,</span>
	<span class="n">USB_CH_IP_CUR_LVL_1P5</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_voltage_to_regval</span><span class="p">(</span><span class="kt">int</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Special case for voltage below 3.5V */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">&lt;</span> <span class="n">ab8500_charger_voltage_map</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">LOW_VOLT_REG</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_voltage_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">&lt;</span> <span class="n">ab8500_charger_voltage_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If not last element, return error */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_voltage_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">==</span> <span class="n">ab8500_charger_voltage_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_current_to_regval</span><span class="p">(</span><span class="kt">int</span> <span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="n">ab8500_charger_current_map</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_current_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="n">ab8500_charger_current_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If not last element, return error */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_current_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">==</span> <span class="n">ab8500_charger_current_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_vbus_in_curr_to_regval</span><span class="p">(</span><span class="kt">int</span> <span class="n">curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="n">ab8500_charger_vbus_in_curr_map</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_vbus_in_curr_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="n">ab8500_charger_vbus_in_curr_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If not last element, return error */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_vbus_in_curr_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">==</span> <span class="n">ab8500_charger_vbus_in_curr_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_get_usb_cur() - get usb current</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structre</span>
<span class="cm"> *</span>
<span class="cm"> * The usb stack provides the maximum current that can be drawn from</span>
<span class="cm"> * the standard usb host. This will be in mA.</span>
<span class="cm"> * This function converts current in mA to a value that can be written</span>
<span class="cm"> * to the register. Returns -1 if charging is not allowed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_get_usb_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_current</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">100</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P09</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">200</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P19</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">300</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P29</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">400</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P38</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">500</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P05</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_set_vbus_in_curr() - set VBUS input current limit</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> * @ich_in:	charger input current limit</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the current that can be drawn from the USB host</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_set_vbus_in_curr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">ich_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">input_curr_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_value</span><span class="p">;</span>

	<span class="cm">/* We should always use to lowest current limit */</span>
	<span class="n">min_value</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_params</span><span class="o">-&gt;</span><span class="n">usb_curr_max</span><span class="p">,</span> <span class="n">ich_in</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">min_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">100</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">&lt;</span> <span class="n">VBAT_TRESH_IP_CUR_RED</span><span class="p">)</span>
			<span class="n">min_value</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P05</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">500</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">&lt;</span> <span class="n">VBAT_TRESH_IP_CUR_RED</span><span class="p">)</span>
			<span class="n">min_value</span> <span class="o">=</span> <span class="n">USB_CH_IP_CUR_LVL_0P45</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_curr_index</span> <span class="o">=</span> <span class="n">ab8500_vbus_in_curr_to_regval</span><span class="p">(</span><span class="n">min_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input_curr_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBUS input current limit too high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_USBCH_IPT_CRNTLVL_REG</span><span class="p">,</span>
		<span class="n">input_curr_index</span> <span class="o">&lt;&lt;</span> <span class="n">VBUS_IN_CURR_LIM_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_led_en() - turn on/off chargign led</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> * @on:		flag to turn on/off the chargign led</span>
<span class="cm"> *</span>
<span class="cm"> * Power ON/OFF charging LED indication</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_led_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Power ON charging LED indicator, set LED current to 5mA */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_LED_INDICATOR_PWM_CTRL</span><span class="p">,</span>
			<span class="p">(</span><span class="n">LED_IND_CUR_5MA</span> <span class="o">|</span> <span class="n">LED_INDICATOR_PWM_ENA</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Power ON LED failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* LED indicator PWM duty cycle 252/256 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_LED_INDICATOR_PWM_DUTY</span><span class="p">,</span>
			<span class="n">LED_INDICATOR_PWM_DUTY_252_256</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set LED PWM duty cycle failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Power off charging LED indicator */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_LED_INDICATOR_PWM_CTRL</span><span class="p">,</span>
			<span class="n">LED_INDICATOR_PWM_DIS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Power-off LED failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_ac_en() - enable or disable ac charging</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> * @enable:	enable/disable flag</span>
<span class="cm"> * @vset:	charging voltage</span>
<span class="cm"> * @iset:	charging current</span>
<span class="cm"> *</span>
<span class="cm"> * Enable/Disable AC/Mains charging and turns on/off the charging led</span>
<span class="cm"> * respectively.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_ac_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="n">charger</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">volt_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">input_curr_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">overshoot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_ac_device_info</span><span class="p">(</span><span class="n">charger</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if AC is connected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;AC charger not connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable AC charging */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enable AC: %dmV %dmA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">iset</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Due to a bug in AB8500, BTEMP_HIGH/LOW interrupts</span>
<span class="cm">		 * will be triggered everytime we enable the VDD ADC supply.</span>
<span class="cm">		 * This will turn off charging for a short while.</span>
<span class="cm">		 * It can be avoided by having the supply on when</span>
<span class="cm">		 * there is a charger enabled. Normally the VDD ADC supply</span>
<span class="cm">		 * is enabled everytime a GPADC conversion is triggered. We will</span>
<span class="cm">		 * force it to be enabled from this driver to have</span>
<span class="cm">		 * the GPADC module independant of the AB8500 chargers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_ac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regulator_enable</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_ac</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if the requested voltage or current is valid */</span>
		<span class="n">volt_index</span> <span class="o">=</span> <span class="n">ab8500_voltage_to_regval</span><span class="p">(</span><span class="n">vset</span><span class="p">);</span>
		<span class="n">curr_index</span> <span class="o">=</span> <span class="n">ab8500_current_to_regval</span><span class="p">(</span><span class="n">iset</span><span class="p">);</span>
		<span class="n">input_curr_index</span> <span class="o">=</span> <span class="n">ab8500_current_to_regval</span><span class="p">(</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">chg_params</span><span class="o">-&gt;</span><span class="n">ac_curr_max</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volt_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">curr_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">input_curr_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Charger voltage or current too high, &quot;</span>
				<span class="s">&quot;charging not started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* ChVoltLevel: maximum battery charging voltage */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_VOLT_LVL_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">volt_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* MainChInputCurr: current that can be drawn from the charger*/</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_MCH_IPT_CURLVL_REG</span><span class="p">,</span>
			<span class="n">input_curr_index</span> <span class="o">&lt;&lt;</span> <span class="n">MAIN_CH_INPUT_CURR_SHIFT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* ChOutputCurentLevel: protected output current */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_OPT_CRNTLVL_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">curr_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check if VBAT overshoot control should be enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">enable_overshoot</span><span class="p">)</span>
			<span class="n">overshoot</span> <span class="o">=</span> <span class="n">MAIN_CH_NO_OVERSHOOT_ENA_N</span><span class="p">;</span>

		<span class="cm">/* Enable Main Charger */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_MCH_CTRL1</span><span class="p">,</span> <span class="n">MAIN_CH_ENA</span> <span class="o">|</span> <span class="n">overshoot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Power on charging LED indication */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_led_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Disable AC charging */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For ABB revision 1.0 and 1.1 there is a bug in the</span>
<span class="cm">			 * watchdog logic. That means we have to continously</span>
<span class="cm">			 * kick the charger watchdog even when no charger is</span>
<span class="cm">			 * connected. This is only valid once the AC charger</span>
<span class="cm">			 * has been enabled. This is a bug that is not handled</span>
<span class="cm">			 * by the algorithm and the watchdog have to be kicked</span>
<span class="cm">			 * by the charger driver when the AC charger</span>
<span class="cm">			 * is disabled</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_conn</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">kick_wd_work</span><span class="p">,</span>
					<span class="n">round_jiffies</span><span class="p">(</span><span class="n">WD_KICK_INTERVAL</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * We can&#39;t turn off charging completely</span>
<span class="cm">			 * due to a bug in AB8500 cut1.</span>
<span class="cm">			 * If we do, charging will not start again.</span>
<span class="cm">			 * That is why we set the lowest voltage</span>
<span class="cm">			 * and current possible</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">AB8500_CHARGER</span><span class="p">,</span>
				<span class="n">AB8500_CH_VOLT_LVL_REG</span><span class="p">,</span> <span class="n">CH_VOL_LVL_3P5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">AB8500_CHARGER</span><span class="p">,</span>
				<span class="n">AB8500_CH_OPT_CRNTLVL_REG</span><span class="p">,</span> <span class="n">CH_OP_CUR_LVL_0P1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">AB8500_CHARGER</span><span class="p">,</span>
				<span class="n">AB8500_MCH_CTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_led_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to disable LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Disable regulator if enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_ac</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regulator_disable</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_ac</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Disabled AC charging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usb_en() - enable usb charging</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> * @enable:	enable/disable flag</span>
<span class="cm"> * @vset:	charging voltage</span>
<span class="cm"> * @ich_out:	charger output current</span>
<span class="cm"> *</span>
<span class="cm"> * Enable/Disable USB charging and turns on/off the charging led respectively.</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_usb_en</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="n">charger</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ich_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">volt_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">overshoot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_usb_device_info</span><span class="p">(</span><span class="n">charger</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if USB is connected */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB charger not connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Due to a bug in AB8500, BTEMP_HIGH/LOW interrupts</span>
<span class="cm">		 * will be triggered everytime we enable the VDD ADC supply.</span>
<span class="cm">		 * This will turn off charging for a short while.</span>
<span class="cm">		 * It can be avoided by having the supply on when</span>
<span class="cm">		 * there is a charger enabled. Normally the VDD ADC supply</span>
<span class="cm">		 * is enabled everytime a GPADC conversion is triggered. We will</span>
<span class="cm">		 * force it to be enabled from this driver to have</span>
<span class="cm">		 * the GPADC module independant of the AB8500 chargers</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_usb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regulator_enable</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_usb</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable USB charging */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enable USB: %dmV %dmA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vset</span><span class="p">,</span> <span class="n">ich_out</span><span class="p">);</span>

		<span class="cm">/* Check if the requested voltage or current is valid */</span>
		<span class="n">volt_index</span> <span class="o">=</span> <span class="n">ab8500_voltage_to_regval</span><span class="p">(</span><span class="n">vset</span><span class="p">);</span>
		<span class="n">curr_index</span> <span class="o">=</span> <span class="n">ab8500_current_to_regval</span><span class="p">(</span><span class="n">ich_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volt_index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">curr_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Charger voltage or current too high, &quot;</span>
				<span class="s">&quot;charging not started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* ChVoltLevel: max voltage upto which battery can be charged */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_VOLT_LVL_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">volt_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* USBChInputCurr: current that can be drawn from the usb */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_set_vbus_in_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting USBChInputCurr failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* ChOutputCurentLevel: protected output current */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_OPT_CRNTLVL_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">curr_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check if VBAT overshoot control should be enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">enable_overshoot</span><span class="p">)</span>
			<span class="n">overshoot</span> <span class="o">=</span> <span class="n">USB_CHG_NO_OVERSHOOT_ENA_N</span><span class="p">;</span>

		<span class="cm">/* Enable USB Charger */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_USBCH_CTRL1_REG</span><span class="p">,</span> <span class="n">USB_CH_ENA</span> <span class="o">|</span> <span class="n">overshoot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If success power on charging LED indication */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_led_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_vbat_work</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Disable USB charging */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_USBCH_CTRL1_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_led_en</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to disable LED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">wd_expired</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* Disable regulator if enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_usb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regulator_disable</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">);</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">vddadc_en_usb</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s Disabled USB charging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* Cancel any pending Vbat check work */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_vbat_work</span><span class="p">))</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_vbat_work</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_watchdog_kick() - kick charger watchdog</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Kick charger watchdog</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_watchdog_kick</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="n">charger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">charger</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span><span class="p">)</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_ac_device_info</span><span class="p">(</span><span class="n">charger</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">charger</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">)</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_usb_device_info</span><span class="p">(</span><span class="n">charger</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_CHARG_WD_CTRL</span><span class="p">,</span> <span class="n">CHARG_WD_KICK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to kick WD!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_update_charger_current() - update charger current</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Update the charger output current for the specified charger</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_update_charger_current</span><span class="p">(</span><span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="n">charger</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">ich_out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">charger</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span><span class="p">)</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_ac_device_info</span><span class="p">(</span><span class="n">charger</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">charger</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">)</span>
		<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_usb_device_info</span><span class="p">(</span><span class="n">charger</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">curr_index</span> <span class="o">=</span> <span class="n">ab8500_current_to_regval</span><span class="p">(</span><span class="n">ich_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Charger current too high, &quot;</span>
			<span class="s">&quot;charging not started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_CH_OPT_CRNTLVL_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">curr_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the main and usb drop input current measurement counter */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
				<span class="n">AB8500_CHARGER_CTRL</span><span class="p">,</span>
				<span class="mh">0x1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_get_ext_psy_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">psy_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="n">usb_chg</span><span class="p">;</span>

	<span class="n">usb_chg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ux500_charger</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">psy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usb_chg</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_usb_device_info</span><span class="p">(</span><span class="n">usb_chg</span><span class="p">);</span>

	<span class="n">ext</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* For all psy where the driver name appears in any supplied_to */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="n">psy_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psy_found</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Go through all properties for the psy */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_properties</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">prop</span><span class="p">;</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span>:
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">=</span> <span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_check_vbat_work() - keep vbus current within spec</span>
<span class="cm"> * @work	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Due to a asic bug it is necessary to lower the input current to the vbus</span>
<span class="cm"> * charger when charging with at some specific levels. This issue is only valid</span>
<span class="cm"> * for below a certain battery voltage. This function makes sure that the</span>
<span class="cm"> * the allowed current limit isn&#39;t exceeded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_check_vbat_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">check_vbat_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">class_for_each_device</span><span class="p">(</span><span class="n">power_supply_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">,</span> <span class="n">ab8500_charger_get_ext_psy_data</span><span class="p">);</span>

	<span class="cm">/* First run old_vbat is 0. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">old_vbat</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">old_vbat</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">old_vbat</span> <span class="o">&lt;=</span> <span class="n">VBAT_TRESH_IP_CUR_RED</span> <span class="o">&amp;&amp;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">&lt;=</span> <span class="n">VBAT_TRESH_IP_CUR_RED</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">old_vbat</span> <span class="o">&gt;</span> <span class="n">VBAT_TRESH_IP_CUR_RED</span> <span class="o">&amp;&amp;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">&gt;</span> <span class="n">VBAT_TRESH_IP_CUR_RED</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Vbat did cross threshold, curr: %d, new: %d,&quot;</span>
			<span class="s">&quot; old: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">old_vbat</span><span class="p">);</span>
		<span class="n">ab8500_charger_set_vbus_in_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span><span class="p">);</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">old_vbat</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to check the battery voltage every second when not close to</span>
<span class="cm">	 * the threshold.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">VBAT_TRESH_IP_CUR_RED</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vbat</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">VBAT_TRESH_IP_CUR_RED</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)))</span>
			<span class="n">t</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_vbat_work</span><span class="p">,</span> <span class="n">t</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_check_hw_failure_work() - check main charger failure</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for checking the main charger status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_check_hw_failure_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_value</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">check_hw_failure_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/* Check if the status bits for HW failure is still active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mainextchnotok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_CH_STATUS2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg_value</span> <span class="o">&amp;</span> <span class="n">MAIN_CH_NOK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_ovv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_CH_USBCH_STAT2_REG</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg_value</span> <span class="o">&amp;</span> <span class="n">VBUS_OVV_TH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* If we still have a failure, schedule a new check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">||</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_ovv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_hw_failure_work</span><span class="p">,</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_kick_watchdog_work() - kick the watchdog</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for kicking the charger watchdog.</span>
<span class="cm"> *</span>
<span class="cm"> * For ABB revision 1.0 and 1.1 there is a bug in the watchdog</span>
<span class="cm"> * logic. That means we have to continously kick the charger</span>
<span class="cm"> * watchdog even when no charger is connected. This is only</span>
<span class="cm"> * valid once the AC charger has been enabled. This is</span>
<span class="cm"> * a bug that is not handled by the algorithm and the</span>
<span class="cm"> * watchdog have to be kicked by the charger driver</span>
<span class="cm"> * when the AC charger is disabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_kick_watchdog_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">kick_wd_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_CHARG_WD_CTRL</span><span class="p">,</span> <span class="n">CHARG_WD_KICK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to kick WD!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Schedule a new watchdog kick */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">kick_wd_work</span><span class="p">,</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">WD_KICK_INTERVAL</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_ac_work() - work to get and set main charger status</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for checking the main charger status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_ac_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">ac_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we can&#39;t be sure that the events are received</span>
<span class="cm">	 * synchronously, we have the check if the main charger is</span>
<span class="cm">	 * connected by reading the status register</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_detect_chargers</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">AC_PW_CONN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_conn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;present&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_detect_usb_type_work() - work to detect USB type</span>
<span class="cm"> * @work:	Pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Detect the type of USB plugged</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_detect_usb_type_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">detect_usb_type_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we can&#39;t be sure that the events are received</span>
<span class="cm">	 * synchronously, we have the check if is</span>
<span class="cm">	 * connected by reading the status register</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_detect_chargers</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">USB_PW_CONN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_detect_usb_type</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* For ABB cut2.0 and onwards we have an IRQ,</span>
<span class="cm">			 * USB_LINK_STATUS that will be triggered when the USB</span>
<span class="cm">			 * link status changes. The exception is USB connected</span>
<span class="cm">			 * during startup. Then we don&#39;t get a</span>
<span class="cm">			 * USB_LINK_STATUS IRQ</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected_start</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected_start</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_detect_usb_type</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
						<span class="nb">true</span><span class="p">);</span>
					<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usb_link_status_work() - work to detect USB type</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Detect the type of USB plugged</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_usb_link_status_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">usb_link_status_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we can&#39;t be sure that the events are received</span>
<span class="cm">	 * synchronously, we have the check if  is</span>
<span class="cm">	 * connected by reading the status register</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_detect_chargers</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">USB_PW_CONN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_read_usb_type</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Update maximum input current */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_set_vbus_in_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No valid charger type detected */</span>
			<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_usb_state_changed_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">usb_state_changed_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * wait for some time until you get updates from the usb stack</span>
<span class="cm">	 * and negotiations are completed</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_changed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s USB state: 0x%02x mA: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">state</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_current</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AB8500_BM_USB_STATE_RESET_HS</span>:
	<span class="k">case</span> <span class="n">AB8500_BM_USB_STATE_RESET_FS</span>:
	<span class="k">case</span> <span class="n">AB8500_BM_USB_STATE_SUSPEND</span>:
	<span class="k">case</span> <span class="n">AB8500_BM_USB_STATE_MAX</span>:
		<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AB8500_BM_USB_STATE_RESUME</span>:
		<span class="cm">/*</span>
<span class="cm">		 * when suspend-&gt;resume there should be delay</span>
<span class="cm">		 * of 1sec for enabling charging</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="cm">/* Intentional fall through */</span>
	<span class="k">case</span> <span class="n">AB8500_BM_USB_STATE_CONFIGURED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * USB is configured, enable charging with the charging</span>
<span class="cm">		 * input current obtained from USB driver</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500_charger_get_usb_cur</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Update maximum input current */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_set_vbus_in_curr</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">max_usb_in_curr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">ab8500_charger_set_usb_connected</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_check_usbchargernotok_work() - check USB chg not ok status</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for checking the USB charger Not OK status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_check_usbchargernotok_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_value</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">prev_status</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">check_usbchgnotok_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="cm">/* Check if the status bit for usbchargernotok is still active */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_CH_USBCH_STAT2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prev_status</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usbchargernotok</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_value</span> <span class="o">&amp;</span> <span class="n">VBUS_CH_NOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usbchargernotok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* Check again in 1sec */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_usbchgnotok_work</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usbchargernotok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_collapse</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">!=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usbchargernotok</span><span class="p">)</span>
		<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_check_main_thermal_prot_work() - check main thermal status</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for checking the Main thermal prot status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_check_main_thermal_prot_work</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_value</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">check_main_thermal_prot_work</span><span class="p">);</span>

	<span class="cm">/* Check if the status bit for main_thermal_prot is still active */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_CH_STATUS2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_value</span> <span class="o">&amp;</span> <span class="n">MAIN_CH_TH_PROT</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">main_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_check_usb_thermal_prot_work() - check usb thermal status</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work queue function for checking the USB thermal prot status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_charger_check_usb_thermal_prot_work</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_value</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">check_usb_thermal_prot_work</span><span class="p">);</span>

	<span class="cm">/* Check if the status bit for usb_thermal_prot is still active */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_CH_USBCH_STAT2_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_value</span> <span class="o">&amp;</span> <span class="n">USB_CH_TH_PROT</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usb_thermal_prot</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usb_thermal_prot</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_mainchunplugdet_handler() - main charger unplugged</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_mainchunplugdet_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Main charger unplugged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_mainchplugdet_handler() - main charger plugged</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_mainchplugdet_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Main charger plugged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_mainextchnotok_handler() - main charger not ok</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_mainextchnotok_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Main charger not ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>

	<span class="cm">/* Schedule a new HW failure check */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_hw_failure_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_mainchthprotr_handler() - Die temp is above main charger</span>
<span class="cm"> * thermal protection threshold</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_mainchthprotr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Die temp above Main charger thermal protection threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_main_thermal_prot_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_mainchthprotf_handler() - Die temp is below main charger</span>
<span class="cm"> * thermal protection threshold</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_mainchthprotf_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Die temp ok for Main charger thermal protection threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_main_thermal_prot_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_vbusdetf_handler() - VBUS falling detected</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_vbusdetf_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBUS falling detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">detect_usb_type_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_vbusdetr_handler() - VBUS rising detected</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_vbusdetr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBUS rising detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">detect_usb_type_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usblinkstatus_handler() - USB link status has changed</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_usblinkstatus_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;USB link status changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_link_status_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usbchthprotr_handler() - Die temp is above usb charger</span>
<span class="cm"> * thermal protection threshold</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_usbchthprotr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Die temp above USB charger thermal protection threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_usb_thermal_prot_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usbchthprotf_handler() - Die temp is below usb charger</span>
<span class="cm"> * thermal protection threshold</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_usbchthprotf_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Die temp ok for USB charger thermal protection threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_usb_thermal_prot_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usbchargernotokr_handler() - USB charger not ok detected</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_usbchargernotokr_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not allowed USB charger detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_usbchgnotok_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_chwdexp_handler() - Charger watchdog expired</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_chwdexp_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Charger watchdog expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The charger that was online when the watchdog expired</span>
<span class="cm">	 * needs to be restarted for charging to start again</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">wd_expired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">wd_expired</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_vbusovv_handler() - VBUS overvoltage detected</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_charger_vbusovv_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBUS overvoltage detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_ovv</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>

	<span class="cm">/* Schedule a new HW failure check */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_hw_failure_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_ac_get_property() - get the ac/mains properties</span>
<span class="cm"> * @psy:       pointer to the power_supply structure</span>
<span class="cm"> * @psp:       pointer to the power_supply_property structure</span>
<span class="cm"> * @val:       pointer to the power_supply_propval union</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when an application tries to get the ac/mains</span>
<span class="cm"> * properties by reading the sysfs files.</span>
<span class="cm"> * AC/Mains properties are online, present and voltage.</span>
<span class="cm"> * online:     ac/mains charging is in progress or not</span>
<span class="cm"> * present:    presence of the ac/mains</span>
<span class="cm"> * voltage:    AC/Mains voltage</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_ac_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_ac_device_info</span><span class="p">(</span><span class="n">psy_to_ux500_charger</span><span class="p">(</span><span class="n">psy</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_HEALTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mainextchnotok</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_UNSPEC_FAILURE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">wd_expired</span> <span class="o">||</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">wd_expired</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_DEAD</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">main_thermal_prot</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_OVERHEAT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ONLINE</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_online</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_voltage</span> <span class="o">=</span> <span class="n">ab8500_charger_get_ac_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_voltage</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This property is used to indicate when CV mode is entered</span>
<span class="cm">		 * for the AC charger</span>
<span class="cm">		 */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">cv_active</span> <span class="o">=</span> <span class="n">ab8500_charger_ac_cv</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">cv_active</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ab8500_charger_get_ac_current</span><span class="p">(</span><span class="n">di</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_usb_get_property() - get the usb properties</span>
<span class="cm"> * @psy:        pointer to the power_supply structure</span>
<span class="cm"> * @psp:        pointer to the power_supply_property structure</span>
<span class="cm"> * @val:        pointer to the power_supply_propval union</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when an application tries to get the usb</span>
<span class="cm"> * properties by reading the sysfs files.</span>
<span class="cm"> * USB properties are online, present and voltage.</span>
<span class="cm"> * online:     usb charging is in progress or not</span>
<span class="cm"> * present:    presence of the usb</span>
<span class="cm"> * voltage:    vbus voltage</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_usb_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_charger_usb_device_info</span><span class="p">(</span><span class="n">psy_to_ux500_charger</span><span class="p">(</span><span class="n">psy</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_HEALTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usbchargernotok</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_UNSPEC_FAILURE</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">wd_expired</span> <span class="o">||</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">wd_expired</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_DEAD</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">usb_thermal_prot</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_OVERHEAT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_ovv</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_OVERVOLTAGE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_HEALTH_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ONLINE</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_online</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_connected</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_voltage</span> <span class="o">=</span> <span class="n">ab8500_charger_get_vbus_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">charger_voltage</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_AVG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This property is used to indicate when CV mode is entered</span>
<span class="cm">		 * for the USB charger</span>
<span class="cm">		 */</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">cv_active</span> <span class="o">=</span> <span class="n">ab8500_charger_usb_cv</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">.</span><span class="n">cv_active</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ab8500_charger_get_usb_current</span><span class="p">(</span><span class="n">di</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This property is used to indicate when VBUS has collapsed</span>
<span class="cm">		 * due to too high output current from the USB charger</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_collapse</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_charger_init_hw_registers() - Set up charger related registers</span>
<span class="cm"> * @di:		pointer to the ab8500_charger structure</span>
<span class="cm"> *</span>
<span class="cm"> * Set up charger OVV, watchdog and maximum voltage registers as well as</span>
<span class="cm"> * charging of the backup battery</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_init_hw_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup maximum charger current and voltage for ABB cut2.0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_VOLT_LVL_MAX_REG</span><span class="p">,</span> <span class="n">CH_VOL_LVL_4P6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to set CH_VOLT_LVL_MAX_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CH_OPT_CRNTLVL_MAX_REG</span><span class="p">,</span> <span class="n">CH_OP_CUR_LVL_1P6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to set CH_OPT_CRNTLVL_MAX_REG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* VBUS OVV set to 6.3V and enable automatic current limitiation */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_USBCH_CTRL2_REG</span><span class="p">,</span>
		<span class="n">VBUS_OVV_SELECT_6P3V</span> <span class="o">|</span> <span class="n">VBUS_AUTO_IN_CURR_LIM_ENA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set VBUS OVV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable main watchdog in OTP */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_OTP_EMUL</span><span class="p">,</span> <span class="n">AB8500_OTP_CONF_15</span><span class="p">,</span> <span class="n">OTP_ENABLE_WD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable main WD in OTP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable main watchdog */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_MAIN_WDOG_CTRL_REG</span><span class="p">,</span> <span class="n">MAIN_WDOG_ENA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;faile to enable main watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Due to internal synchronisation, Enable and Kick watchdog bits</span>
<span class="cm">	 * cannot be enabled in a single write.</span>
<span class="cm">	 * A minimum delay of 2*32 kHz period (62.5µs) must be inserted</span>
<span class="cm">	 * between writing Enable then Kick bits.</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">63</span><span class="p">);</span>

	<span class="cm">/* Kick main watchdog */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_MAIN_WDOG_CTRL_REG</span><span class="p">,</span>
		<span class="p">(</span><span class="n">MAIN_WDOG_ENA</span> <span class="o">|</span> <span class="n">MAIN_WDOG_KICK</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to kick main watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable main watchdog */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_SYS_CTRL2_BLOCK</span><span class="p">,</span>
		<span class="n">AB8500_MAIN_WDOG_CTRL_REG</span><span class="p">,</span> <span class="n">MAIN_WDOG_DIS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to disable main watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set watchdog timeout */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_CH_WD_TIMER_REG</span><span class="p">,</span> <span class="n">WD_TIMER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set charger watchdog timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Backup battery voltage and current */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_RTC</span><span class="p">,</span>
		<span class="n">AB8500_RTC_BACKUP_CHG_REG</span><span class="p">,</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bkup_bat_v</span> <span class="o">|</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bkup_bat_i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to setup backup battery charging</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable backup battery charging */</span>
	<span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_RTC</span><span class="p">,</span> <span class="n">AB8500_RTC_CTRL_REG</span><span class="p">,</span>
		<span class="n">RTC_BUP_CH_ENA</span><span class="p">,</span> <span class="n">RTC_BUP_CH_ENA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s mask and set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ab8500 charger driver interrupts and their respective isr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ab8500_charger_interrupts</span> <span class="n">ab8500_charger_irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;MAIN_CH_UNPLUG_DET&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_mainchunplugdet_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MAIN_CHARGE_PLUG_DET&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_mainchplugdet_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MAIN_EXT_CH_NOT_OK&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_mainextchnotok_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MAIN_CH_TH_PROT_R&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_mainchthprotr_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;MAIN_CH_TH_PROT_F&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_mainchthprotf_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;VBUS_DET_F&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_vbusdetf_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;VBUS_DET_R&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_vbusdetr_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;USB_LINK_STATUS&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_usblinkstatus_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;USB_CH_TH_PROT_R&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_usbchthprotr_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;USB_CH_TH_PROT_F&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_usbchthprotf_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;USB_CHARGER_NOT_OKR&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_usbchargernotokr_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;VBUS_OVV&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_vbusovv_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CH_WD_EXP&quot;</span><span class="p">,</span> <span class="n">ab8500_charger_chwdexp_handler</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_usb_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_charger</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ab8500_usb_state</span> <span class="n">bm_usb_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mA</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span><span class="n">power</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="n">USB_EVENT_VBUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;not a standard host, returning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: State is fabricate  here. See if charger really needs USB</span>
<span class="cm">	 * state or if mA is enough</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_current</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mA</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">bm_usb_state</span> <span class="o">=</span> <span class="n">AB8500_BM_USB_STATE_RESUME</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mA</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bm_usb_state</span> <span class="o">=</span> <span class="n">AB8500_BM_USB_STATE_RESET_HS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mA</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">bm_usb_state</span> <span class="o">=</span> <span class="n">AB8500_BM_USB_STATE_SUSPEND</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mA</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="cm">/* 8, 100, 500 */</span>
		<span class="n">bm_usb_state</span> <span class="o">=</span> <span class="n">AB8500_BM_USB_STATE_CONFIGURED</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* Should never occur */</span>
		<span class="n">bm_usb_state</span> <span class="o">=</span> <span class="n">AB8500_BM_USB_STATE_RESET_FS</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s usb_state: 0x%02x mA: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">bm_usb_state</span><span class="p">,</span> <span class="n">mA</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_lock</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_lock</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">bm_usb_state</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_current</span> <span class="o">=</span> <span class="n">mA</span><span class="p">;</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state_changed_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_PM)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For ABB revision 1.0 and 1.1 there is a bug in the watchdog</span>
<span class="cm">	 * logic. That means we have to continously kick the charger</span>
<span class="cm">	 * watchdog even when no charger is connected. This is only</span>
<span class="cm">	 * valid once the AC charger has been enabled. This is</span>
<span class="cm">	 * a bug that is not handled by the algorithm and the</span>
<span class="cm">	 * watchdog have to be kicked by the charger driver</span>
<span class="cm">	 * when the AC charger is disabled</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_conn</span> <span class="o">&amp;&amp;</span> <span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
			<span class="n">AB8500_CHARG_WD_CTRL</span><span class="p">,</span> <span class="n">CHARG_WD_KICK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to kick WD!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* If not already pending start a new timer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">kick_wd_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">kick_wd_work</span><span class="p">,</span>
				<span class="n">round_jiffies</span><span class="p">(</span><span class="n">WD_KICK_INTERVAL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If we still have a HW failure, schedule a new check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">mainextchnotok</span> <span class="o">||</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">vbus_ovv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_hw_failure_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_charger_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Cancel any pending HW failure check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_hw_failure_work</span><span class="p">))</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_hw_failure_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ab8500_charger_suspend      NULL</span>
<span class="cp">#define ab8500_charger_resume       NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ab8500_charger_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Disable AC charging */</span>
	<span class="n">ab8500_charger_ac_en</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable USB charging */</span>
	<span class="n">ab8500_charger_usb_en</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_irq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_charger_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable the regulator */</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">);</span>

	<span class="cm">/* Backup battery voltage and current disable */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_RTC</span><span class="p">,</span> <span class="n">AB8500_RTC_CTRL_REG</span><span class="p">,</span> <span class="n">RTC_BUP_CH_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s mask and set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">usb_unregister_notifier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
	<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">);</span>

	<span class="cm">/* Delete the work queue */</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">);</span>

	<span class="n">flush_scheduled_work</span><span class="p">();</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ab8500_charger_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">charger_status</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_bm_plat_data</span> <span class="o">*</span><span class="n">plat_data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_charger</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* get parent data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span> <span class="o">=</span> <span class="n">ab8500_gpadc_get</span><span class="p">(</span><span class="s">&quot;ab8500-gpadc.0&quot;</span><span class="p">);</span>

	<span class="cm">/* initialize lock */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state</span><span class="p">.</span><span class="n">usb_lock</span><span class="p">);</span>

	<span class="cm">/* get charger specific platform data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">charger</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no charger platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get battery specific platform data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no battery platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">autopower</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* AC supply */</span>
	<span class="cm">/* power_supply base class */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500_ac&quot;</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">ab8500_charger_ac_props</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_ac_props</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">ab8500_charger_ac_get_property</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">supplied_to</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">num_supplicants</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span>
	<span class="cm">/* ux500_charger sub-class */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_charger_ac_en</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">kick_wd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_charger_watchdog_kick</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">update_curr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_charger_update_charger_current</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">max_out_volt</span> <span class="o">=</span> <span class="n">ab8500_charger_voltage_map</span><span class="p">[</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_voltage_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">max_out_curr</span> <span class="o">=</span> <span class="n">ab8500_charger_current_map</span><span class="p">[</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_current_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* USB supply */</span>
	<span class="cm">/* power_supply base class */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500_usb&quot;</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_USB</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">ab8500_charger_usb_props</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_usb_props</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">ab8500_charger_usb_get_property</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">supplied_to</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">num_supplicants</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span>
	<span class="cm">/* ux500_charger sub-class */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_charger_usb_en</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">kick_wd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_charger_watchdog_kick</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">update_curr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ab8500_charger_update_charger_current</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">max_out_volt</span> <span class="o">=</span> <span class="n">ab8500_charger_voltage_map</span><span class="p">[</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_voltage_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">max_out_curr</span> <span class="o">=</span> <span class="n">ab8500_charger_current_map</span><span class="p">[</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_current_map</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>


	<span class="cm">/* Create a work queue for the charger */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span> <span class="o">=</span>
		<span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;ab8500_charger_wq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create work queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init work for HW failure check */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_hw_failure_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_check_hw_failure_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_usbchgnotok_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_check_usbchargernotok_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For ABB revision 1.0 and 1.1 there is a bug in the watchdog</span>
<span class="cm">	 * logic. That means we have to continously kick the charger</span>
<span class="cm">	 * watchdog even when no charger is connected. This is only</span>
<span class="cm">	 * valid once the AC charger has been enabled. This is</span>
<span class="cm">	 * a bug that is not handled by the algorithm and the</span>
<span class="cm">	 * watchdog have to be kicked by the charger driver</span>
<span class="cm">	 * when the AC charger is disabled</span>
<span class="cm">	 */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">kick_wd_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_kick_watchdog_work</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_vbat_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_check_vbat_work</span><span class="p">);</span>

	<span class="cm">/* Init work for charger detection */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_link_status_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_usb_link_status_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_work</span><span class="p">,</span> <span class="n">ab8500_charger_ac_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">detect_usb_type_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_detect_usb_type_work</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_state_changed_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_usb_state_changed_work</span><span class="p">);</span>

	<span class="cm">/* Init work for checking HW status */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_main_thermal_prot_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_check_main_thermal_prot_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">check_usb_thermal_prot_work</span><span class="p">,</span>
		<span class="n">ab8500_charger_check_usb_thermal_prot_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * VDD ADC supply needs to be enabled from this driver when there</span>
<span class="cm">	 * is a charger connected to avoid erroneous BTEMP_HIGH/LOW</span>
<span class="cm">	 * interrupts during charging</span>
<span class="cm">	 */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vddadc&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get vddadc regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_charger_wq</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Initialize OVV, and other registers */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_charger_init_hw_registers</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize ABB registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_regulator</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register AC charger class */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register AC charger</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_regulator</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register USB charger class */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register USB charger</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_ac</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_phy</span> <span class="o">=</span> <span class="n">usb_get_transceiver</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get usb transceiver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_usb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">ab8500_charger_usb_notifier_call</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_register_notifier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register usb notifier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">put_usb_phy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Identify the connected charger types during startup */</span>
	<span class="n">charger_status</span> <span class="o">=</span> <span class="n">ab8500_charger_detect_chargers</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">charger_status</span> <span class="o">&amp;</span> <span class="n">AC_PW_CONN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">charger_connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_conn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ab8500_power_supply_changed</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;present&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">charger_status</span> <span class="o">&amp;</span> <span class="n">USB_PW_CONN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VBUS Detect during startup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">vbus_detected_start</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">detect_usb_type_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_charger_irq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_charger_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ab8500_charger_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isr</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span>
			<span class="n">ab8500_charger_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request %s IRQ %d: %d</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">ab8500_charger_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested %s IRQ %d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ab8500_charger_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">free_irq:</span>
	<span class="n">usb_unregister_notifier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">);</span>

	<span class="cm">/* We also have to free all successfully registered irqs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_charger_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">put_usb_phy:</span>
	<span class="n">usb_put_transceiver</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_phy</span><span class="p">);</span>
<span class="nl">free_usb:</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">usb_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
<span class="nl">free_ac:</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">ac_chg</span><span class="p">.</span><span class="n">psy</span><span class="p">);</span>
<span class="nl">free_regulator:</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">regu</span><span class="p">);</span>
<span class="nl">free_charger_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">charger_wq</span><span class="p">);</span>
<span class="nl">free_device_info:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ab8500_charger_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ab8500_charger_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ab8500_charger_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ab8500_charger_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ab8500_charger_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-charger&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ab8500_charger_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_charger_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ab8500_charger_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_charger_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall_sync</span><span class="p">(</span><span class="n">ab8500_charger_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ab8500_charger_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Johan Palsson, Karl Komierowski, Arun R Murthy&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ab8500-charger&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AB8500 charger management driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
