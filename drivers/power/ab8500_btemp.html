<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › power › ab8500_btemp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ab8500_btemp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) ST-Ericsson SA 2012</span>
<span class="cm"> *</span>
<span class="cm"> * Battery temperature driver for AB8500</span>
<span class="cm"> *</span>
<span class="cm"> * License Terms: GNU General Public License v2</span>
<span class="cm"> * Author:</span>
<span class="cm"> *	Johan Palsson &lt;johan.palsson@stericsson.com&gt;</span>
<span class="cm"> *	Karl Komierowski &lt;karl.komierowski@stericsson.com&gt;</span>
<span class="cm"> *	Arun R Murthy &lt;arun.murthy@stericsson.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500-bm.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/abx500/ab8500-gpadc.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#define VTVOUT_V			1800</span>

<span class="cp">#define BTEMP_THERMAL_LOW_LIMIT		-10</span>
<span class="cp">#define BTEMP_THERMAL_MED_LIMIT		0</span>
<span class="cp">#define BTEMP_THERMAL_HIGH_LIMIT_52	52</span>
<span class="cp">#define BTEMP_THERMAL_HIGH_LIMIT_57	57</span>
<span class="cp">#define BTEMP_THERMAL_HIGH_LIMIT_62	62</span>

<span class="cp">#define BTEMP_BATCTRL_CURR_SRC_7UA	7</span>
<span class="cp">#define BTEMP_BATCTRL_CURR_SRC_20UA	20</span>

<span class="cp">#define to_ab8500_btemp_device_info(x) container_of((x), \</span>
<span class="cp">	struct ab8500_btemp, btemp_psy);</span>

<span class="cm">/**</span>
<span class="cm"> * struct ab8500_btemp_interrupts - ab8500 interrupts</span>
<span class="cm"> * @name:	name of the interrupt</span>
<span class="cm"> * @isr		function pointer to the isr</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_btemp_interrupts</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span><span class="p">)(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_btemp_events</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">batt_rem</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">btemp_high</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">btemp_medhigh</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">btemp_lowmed</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">btemp_low</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ac_conn</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">usb_conn</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ab8500_btemp_ranges</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">btemp_high_limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">btemp_med_limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">btemp_low_limit</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * struct ab8500_btemp - ab8500 BTEMP device information</span>
<span class="cm"> * @dev:		Pointer to the structure device</span>
<span class="cm"> * @node:		List of AB8500 BTEMPs, hence prepared for reentrance</span>
<span class="cm"> * @curr_source:	What current source we use, in uA</span>
<span class="cm"> * @bat_temp:		Battery temperature in degree Celcius</span>
<span class="cm"> * @prev_bat_temp	Last dispatched battery temperature</span>
<span class="cm"> * @parent:		Pointer to the struct ab8500</span>
<span class="cm"> * @gpadc:		Pointer to the struct gpadc</span>
<span class="cm"> * @fg:			Pointer to the struct fg</span>
<span class="cm"> * @pdata:		Pointer to the abx500_btemp platform data</span>
<span class="cm"> * @bat:		Pointer to the abx500_bm platform data</span>
<span class="cm"> * @btemp_psy:		Structure for BTEMP specific battery properties</span>
<span class="cm"> * @events:		Structure for information about events triggered</span>
<span class="cm"> * @btemp_ranges:	Battery temperature range structure</span>
<span class="cm"> * @btemp_wq:		Work queue for measuring the temperature periodically</span>
<span class="cm"> * @btemp_periodic_work:	Work for measuring the temperature periodically</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bat_temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_bat_temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_gpadc</span> <span class="o">*</span><span class="n">gpadc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_fg</span> <span class="o">*</span><span class="n">fg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_btemp_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_bm_data</span> <span class="o">*</span><span class="n">bat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="n">btemp_psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp_events</span> <span class="n">events</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp_ranges</span> <span class="n">btemp_ranges</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">btemp_wq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">btemp_periodic_work</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* BTEMP power supply properties */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">ab8500_btemp_props</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_ONLINE</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_TEMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">ab8500_btemp_list</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_get() - returns a reference to the primary AB8500 BTEMP</span>
<span class="cm"> * (i.e. the first BTEMP in the instance list)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="nf">ab8500_btemp_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">btemp</span><span class="p">;</span>
	<span class="n">btemp</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_btemp_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ab8500_btemp</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">btemp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_batctrl_volt_to_res() - convert batctrl voltage to resistance</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> * @v_batctrl:	measured batctrl voltage</span>
<span class="cm"> * @inst_curr:	measured instant current</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the battery resistance that is</span>
<span class="cm"> * derived from the BATCTRL voltage.</span>
<span class="cm"> * Returns value in Ohms.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_batctrl_volt_to_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">v_batctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inst_curr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rbs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For ABB cut1.0 and 1.1 BAT_CTRL is internally</span>
<span class="cm">		 * connected to 1.8V through a 450k resistor</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">450000</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_batctrl</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1800</span> <span class="o">-</span> <span class="n">v_batctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">adc_therm</span> <span class="o">==</span> <span class="n">ABx500_ADC_THERM_BATCTRL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the battery has internal NTC, we use the current</span>
<span class="cm">		 * source to calculate the resistance, 7uA or 20uA</span>
<span class="cm">		 */</span>
		<span class="n">rbs</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_batctrl</span> <span class="o">*</span> <span class="mi">1000</span>
		       <span class="o">-</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">gnd_lift_resistance</span> <span class="o">*</span> <span class="n">inst_curr</span><span class="p">)</span>
		      <span class="o">/</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">curr_source</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * BAT_CTRL is internally</span>
<span class="cm">		 * connected to 1.8V through a 80k resistor</span>
<span class="cm">		 */</span>
		<span class="n">rbs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">80000</span> <span class="o">*</span> <span class="p">(</span><span class="n">v_batctrl</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1800</span> <span class="o">-</span> <span class="n">v_batctrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rbs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_read_batctrl_voltage() - measure batctrl voltage</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the voltage on BATCTRL. Returns value in mV.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_read_batctrl_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vbtemp</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">prev</span><span class="p">;</span>

	<span class="n">vbtemp</span> <span class="o">=</span> <span class="n">ab8500_gpadc_convert</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span><span class="p">,</span> <span class="n">BAT_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vbtemp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s gpadc conversion failed, using previous value&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">prev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">vbtemp</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">vbtemp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_curr_source_enable() - enable/disable batctrl current source</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> * @enable:	enable or disable the current source</span>
<span class="cm"> *</span>
<span class="cm"> * Enable or disable the current sources for the BatCtrl AD channel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_curr_source_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * BATCTRL current sources are included on AB8500 cut2.0</span>
<span class="cm">	 * and future versions</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab8500_1p1_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Only do this for batteries with internal NTC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">adc_therm</span> <span class="o">==</span> <span class="n">ABx500_ADC_THERM_BATCTRL</span> <span class="o">&amp;&amp;</span> <span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">curr_source</span> <span class="o">==</span> <span class="n">BTEMP_BATCTRL_CURR_SRC_7UA</span><span class="p">)</span>
			<span class="n">curr</span> <span class="o">=</span> <span class="n">BAT_CTRL_7U_ENA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">curr</span> <span class="o">=</span> <span class="n">BAT_CTRL_20U_ENA</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set BATCTRL %duA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">curr_source</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
			<span class="n">FORCE_BAT_CTRL_CMP_HIGH</span><span class="p">,</span> <span class="n">FORCE_BAT_CTRL_CMP_HIGH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed setting cmp_force</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We have to wait one 32kHz cycle before enabling</span>
<span class="cm">		 * the current source, since ForceBatCtrlCmpHigh needs</span>
<span class="cm">		 * to be written in a separate cycle</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
			<span class="n">FORCE_BAT_CTRL_CMP_HIGH</span> <span class="o">|</span> <span class="n">curr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed enabling current source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">disable_curr_source</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">adc_therm</span> <span class="o">==</span> <span class="n">ABx500_ADC_THERM_BATCTRL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disable BATCTRL curr source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Write 0 to the curr bits */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
			<span class="n">BAT_CTRL_7U_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_20U_ENA</span><span class="p">,</span>
			<span class="o">~</span><span class="p">(</span><span class="n">BAT_CTRL_7U_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_20U_ENA</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed disabling current source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">disable_curr_source</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable Pull-Up and comparator */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span>	<span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
			<span class="n">BAT_CTRL_PULL_UP_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_CMP_ENA</span><span class="p">,</span>
			<span class="n">BAT_CTRL_PULL_UP_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_CMP_ENA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed enabling PU and comp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">enable_pu_comp</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * We have to wait one 32kHz cycle before disabling</span>
<span class="cm">		 * ForceBatCtrlCmpHigh since this needs to be written</span>
<span class="cm">		 * in a separate cycle</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

		<span class="cm">/* Disable &#39;force comparator&#39; */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
			<span class="n">FORCE_BAT_CTRL_CMP_HIGH</span><span class="p">,</span> <span class="o">~</span><span class="n">FORCE_BAT_CTRL_CMP_HIGH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed disabling force comp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">disable_force_comp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to try unsetting FORCE_BAT_CTRL_CMP_HIGH one more time</span>
<span class="cm">	 * if we got an error above</span>
<span class="cm">	 */</span>
<span class="nl">disable_curr_source:</span>
	<span class="cm">/* Write 0 to the curr bits */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
			<span class="n">BAT_CTRL_7U_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_20U_ENA</span><span class="p">,</span>
			<span class="o">~</span><span class="p">(</span><span class="n">BAT_CTRL_7U_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_20U_ENA</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed disabling current source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">enable_pu_comp:</span>
	<span class="cm">/* Enable Pull-Up and comparator */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span>	<span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
		<span class="n">BAT_CTRL_PULL_UP_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_CMP_ENA</span><span class="p">,</span>
		<span class="n">BAT_CTRL_PULL_UP_ENA</span> <span class="o">|</span> <span class="n">BAT_CTRL_CMP_ENA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed enabling PU and comp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">disable_force_comp:</span>
	<span class="cm">/*</span>
<span class="cm">	 * We have to wait one 32kHz cycle before disabling</span>
<span class="cm">	 * ForceBatCtrlCmpHigh since this needs to be written</span>
<span class="cm">	 * in a separate cycle</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="cm">/* Disable &#39;force comparator&#39; */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_mask_and_set_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">AB8500_CHARGER</span><span class="p">,</span> <span class="n">AB8500_BAT_CTRL_CURRENT_SOURCE</span><span class="p">,</span>
		<span class="n">FORCE_BAT_CTRL_CMP_HIGH</span><span class="p">,</span> <span class="o">~</span><span class="n">FORCE_BAT_CTRL_CMP_HIGH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed disabling force comp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_get_batctrl_res() - get battery resistance</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the battery pack identification resistance.</span>
<span class="cm"> * Returns value in Ohms.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_get_batctrl_res</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">batctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inst_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * BATCTRL current sources are included on AB8500 cut2.0</span>
<span class="cm">	 * and future versions</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_btemp_curr_source_enable</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s curr source enabled failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">)</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">fg</span> <span class="o">=</span> <span class="n">ab8500_fg_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No fg found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_start</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to start current measurement</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since there is no interrupt when current measurement is done,</span>
<span class="cm">	 * loop for over 250ms (250ms is one sample conversion time</span>
<span class="cm">	 * with 32.768 Khz RTC clock). Note that a stop time must be set</span>
<span class="cm">	 * since the ab8500_btemp_read_batctrl_voltage call can block and</span>
<span class="cm">	 * take an unknown amount of time to complete.</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">batctrl</span> <span class="o">+=</span> <span class="n">ab8500_btemp_read_batctrl_voltage</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ab8500_fg_inst_curr_done</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">));</span>
	<span class="n">batctrl</span> <span class="o">/=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_fg_inst_curr_finalize</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inst_curr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to finalize current measurement</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">ab8500_btemp_batctrl_volt_to_res</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">batctrl</span><span class="p">,</span> <span class="n">inst_curr</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ab8500_btemp_curr_source_enable</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s curr source disable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s batctrl: %d res: %d inst_curr: %d samples: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">batctrl</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">inst_curr</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_res_to_temp() - resistance to temperature</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> * @tbl:	pointer to the resiatance to temperature table</span>
<span class="cm"> * @tbl_size:	size of the resistance to temperature table</span>
<span class="cm"> * @res:	resistance to calculate the temperature from</span>
<span class="cm"> *</span>
<span class="cm"> * This function returns the battery temperature in degrees Celcius</span>
<span class="cm"> * based on the NTC resistance.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_res_to_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">abx500_res_to_temp</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tbl_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Calculate the formula for the straight line</span>
<span class="cm">	 * Simple interpolation if we are within</span>
<span class="cm">	 * the resistance table limits, extrapolate</span>
<span class="cm">	 * if resistance is outside the limits.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">resist</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">tbl_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">resist</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">tbl_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">res</span> <span class="o">&lt;=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resist</span> <span class="o">&amp;&amp;</span>
			<span class="n">res</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">resist</span><span class="p">))</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temp</span> <span class="o">+</span> <span class="p">((</span><span class="n">tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">temp</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temp</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resist</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">tbl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">resist</span> <span class="o">-</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resist</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_measure_temp() - measure battery temperature</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns battery temperature (on success) else the previous temperature</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_measure_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">prev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rbat</span><span class="p">,</span> <span class="n">rntc</span><span class="p">,</span> <span class="n">vntc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">adc_therm</span> <span class="o">==</span> <span class="n">ABx500_ADC_THERM_BATCTRL</span> <span class="o">&amp;&amp;</span>
			<span class="n">id</span> <span class="o">!=</span> <span class="n">BATTERY_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">rbat</span> <span class="o">=</span> <span class="n">ab8500_btemp_get_batctrl_res</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s get batctrl res failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Return out-of-range temperature so that</span>
<span class="cm">			 * charging is stopped</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="n">BTEMP_THERMAL_LOW_LIMIT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">ab8500_btemp_res_to_temp</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">r_to_t_tbl</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">n_temp_tbl_elements</span><span class="p">,</span> <span class="n">rbat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vntc</span> <span class="o">=</span> <span class="n">ab8500_gpadc_convert</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span><span class="p">,</span> <span class="n">BTEMP_BALL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vntc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s gpadc conversion failed,&quot;</span>
				<span class="s">&quot; using previous value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">prev</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * The PCB NTC is sourced from VTVOUT via a 230kOhm</span>
<span class="cm">		 * resistor.</span>
<span class="cm">		 */</span>
		<span class="n">rntc</span> <span class="o">=</span> <span class="mi">230000</span> <span class="o">*</span> <span class="n">vntc</span> <span class="o">/</span> <span class="p">(</span><span class="n">VTVOUT_V</span> <span class="o">-</span> <span class="n">vntc</span><span class="p">);</span>

		<span class="n">temp</span> <span class="o">=</span> <span class="n">ab8500_btemp_res_to_temp</span><span class="p">(</span><span class="n">di</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">r_to_t_tbl</span><span class="p">,</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">n_temp_tbl_elements</span><span class="p">,</span> <span class="n">rntc</span><span class="p">);</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery temperature is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_id() - Identify the connected battery</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function will try to identify the battery by reading the ID</span>
<span class="cm"> * resistor. Some brands use a combined ID resistor with a NTC resistor to</span>
<span class="cm"> * both be able to identify and to read the temperature of it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">curr_source</span> <span class="o">=</span> <span class="n">BTEMP_BATCTRL_CURR_SRC_7UA</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span> <span class="o">=</span> <span class="n">BATTERY_UNKNOWN</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span>  <span class="n">ab8500_btemp_get_batctrl_res</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s get batctrl res failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BATTERY_UNKNOWN is defined on position 0, skip it! */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">BATTERY_UNKNOWN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">n_btypes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">&lt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resis_high</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resis_low</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery detected on %s&quot;</span>
				<span class="s">&quot; low %d &lt; res %d &lt; high: %d&quot;</span>
				<span class="s">&quot; index: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">adc_therm</span> <span class="o">==</span> <span class="n">ABx500_ADC_THERM_BATCTRL</span> <span class="o">?</span>
				<span class="s">&quot;BATCTRL&quot;</span> <span class="o">:</span> <span class="s">&quot;BATTEMP&quot;</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resis_low</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span>
				<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resis_high</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span> <span class="o">==</span> <span class="n">BATTERY_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery identified as unknown&quot;</span>
			<span class="s">&quot;, resistance %d Ohm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only have to change current source if the</span>
<span class="cm">	 * detected type is Type 1, else we use the 7uA source</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">adc_therm</span> <span class="o">==</span> <span class="n">ABx500_ADC_THERM_BATCTRL</span> <span class="o">&amp;&amp;</span>
			<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Set BATCTRL current source to 20uA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">curr_source</span> <span class="o">=</span> <span class="n">BTEMP_BATCTRL_CURR_SRC_20UA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_periodic_work() - Measuring the temperature periodically</span>
<span class="cm"> * @work:	pointer to the work_struct structure</span>
<span class="cm"> *</span>
<span class="cm"> * Work function for measuring the temperature periodically</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_btemp_periodic_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ab8500_btemp</span><span class="p">,</span> <span class="n">btemp_periodic_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">=</span> <span class="n">ab8500_btemp_measure_temp</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">!=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">prev_bat_temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">prev_bat_temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span><span class="p">;</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_conn</span> <span class="o">||</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_conn</span><span class="p">)</span>
		<span class="n">interval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_interval_chg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">interval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">temp_interval_nochg</span><span class="p">;</span>

	<span class="cm">/* Schedule a new measurement */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_wq</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_periodic_work</span><span class="p">,</span>
		<span class="n">round_jiffies</span><span class="p">(</span><span class="n">interval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_batctrlindb_handler() - battery removal detected</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       void pointer that has to address of ab8500_btemp</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_btemp_batctrlindb_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery removal detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_rem</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_templow_handler() - battery temp lower than 10 degrees</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       void pointer that has to address of ab8500_btemp</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_btemp_templow_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab8500_2p0_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Ignore false btemp low irq&quot;</span>
			<span class="s">&quot; for ABB cut 1.0, 1.1 and 2.0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_crit</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery temperature lower than -10deg c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_low</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_high</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_medhigh</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowmed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_temphigh_handler() - battery temp higher than max temp</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       void pointer that has to address of ab8500_btemp</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_btemp_temphigh_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_crit</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery temperature is higher than MAX temp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_high</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_medhigh</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowmed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_low</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_lowmed_handler() - battery temp between low and medium</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       void pointer that has to address of ab8500_btemp</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_btemp_lowmed_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery temperature is between low and medium</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowmed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_medhigh</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_high</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_low</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_medhigh_handler() - battery temp between medium and high</span>
<span class="cm"> * @irq:       interrupt number</span>
<span class="cm"> * @_di:       void pointer that has to address of ab8500_btemp</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ status(IRQ_HANDLED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ab8500_btemp_medhigh_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">_di</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Battery temperature is between medium and high</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_medhigh</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowmed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_high</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_low</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">power_supply_changed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_periodic() - Periodic temperature measurements</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> * @enable:	enable or disable periodic temperature measurements</span>
<span class="cm"> *</span>
<span class="cm"> * Starts of stops periodic temperature measurements. Periodic measurements</span>
<span class="cm"> * should only be done when a charger is connected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_btemp_periodic</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">,</span>
	<span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Enable periodic temperature measurements: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">enable</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make sure a new measurement is done directly by cancelling</span>
<span class="cm">	 * any pending work</span>
<span class="cm">	 */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_periodic_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_periodic_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_get_temp() - get battery temperature</span>
<span class="cm"> * @di:		pointer to the ab8500_btemp structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns battery temperature</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_get_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The BTEMP events are not reliabe on AB8500 cut2.0</span>
<span class="cm">	 * and prior versions</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ab8500_2p0_or_earlier</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_low</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_low_limit</span><span class="p">)</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_low_limit</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_high</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_high_limit</span><span class="p">)</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_high_limit</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_lowmed</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_med_limit</span><span class="p">)</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_med_limit</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">btemp_medhigh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_med_limit</span><span class="p">)</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_med_limit</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_get_batctrl_temp() - get the temperature</span>
<span class="cm"> * @btemp:      pointer to the btemp structure</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the batctrl temperature in millidegrees</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ab8500_btemp_get_batctrl_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">btemp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">btemp</span><span class="o">-&gt;</span><span class="n">bat_temp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_get_property() - get the btemp properties</span>
<span class="cm"> * @psy:        pointer to the power_supply structure</span>
<span class="cm"> * @psp:        pointer to the power_supply_property structure</span>
<span class="cm"> * @val:        pointer to the power_supply_propval union</span>
<span class="cm"> *</span>
<span class="cm"> * This function gets called when an application tries to get the btemp</span>
<span class="cm"> * properties by reading the sysfs files.</span>
<span class="cm"> * online:	presence of the battery</span>
<span class="cm"> * present:	presence of the battery</span>
<span class="cm"> * technology:	battery technology</span>
<span class="cm"> * temp:	battery temperature</span>
<span class="cm"> * Returns error code in case of failure else 0(on success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_btemp_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_ONLINE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">batt_rem</span><span class="p">)</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">bat_type</span><span class="p">[</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="o">-&gt;</span><span class="n">batt_id</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ab8500_btemp_get_temp</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_get_ext_psy_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">ext</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">psy_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">psy</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ext</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_btemp_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For all psy where the name of your driver</span>
<span class="cm">	 * appears in any supplied_to</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">psy</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="n">psy_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psy_found</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Go through all properties for the psy */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">num_properties</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">prop</span><span class="p">;</span>
		<span class="n">prop</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">properties</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">get_property</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">prop</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_MAINS</span>:
				<span class="cm">/* AC disconnected */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_conn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_conn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* AC connected */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_conn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_conn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_conn</span><span class="p">)</span>
						<span class="n">ab8500_btemp_periodic</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">POWER_SUPPLY_TYPE_USB</span>:
				<span class="cm">/* USB disconnected */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_conn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_conn</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* USB connected */</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">intval</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_conn</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">usb_conn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">.</span><span class="n">ac_conn</span><span class="p">)</span>
						<span class="n">ab8500_btemp_periodic</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ab8500_btemp_external_power_changed() - callback for power supply changes</span>
<span class="cm"> * @psy:       pointer to the structure power_supply</span>
<span class="cm"> *</span>
<span class="cm"> * This function is pointing to the function pointer external_power_changed</span>
<span class="cm"> * of the structure power_supply.</span>
<span class="cm"> * This function gets executed when there is a change in the external power</span>
<span class="cm"> * supply to the btemp.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ab8500_btemp_external_power_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">to_ab8500_btemp_device_info</span><span class="p">(</span><span class="n">psy</span><span class="p">);</span>

	<span class="n">class_for_each_device</span><span class="p">(</span><span class="n">power_supply_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">,</span> <span class="n">ab8500_btemp_get_ext_psy_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ab8500 btemp driver interrupts and their respective isr */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ab8500_btemp_interrupts</span> <span class="n">ab8500_btemp_irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;BAT_CTRL_INDB&quot;</span><span class="p">,</span> <span class="n">ab8500_btemp_batctrlindb_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BTEMP_LOW&quot;</span><span class="p">,</span> <span class="n">ab8500_btemp_templow_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BTEMP_HIGH&quot;</span><span class="p">,</span> <span class="n">ab8500_btemp_temphigh_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BTEMP_LOW_MEDIUM&quot;</span><span class="p">,</span> <span class="n">ab8500_btemp_lowmed_handler</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;BTEMP_MEDIUM_HIGH&quot;</span><span class="p">,</span> <span class="n">ab8500_btemp_medhigh_handler</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_PM)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ab8500_btemp_periodic</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ab8500_btemp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ab8500_btemp_periodic</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ab8500_btemp_suspend      NULL</span>
<span class="cp">#define ab8500_btemp_resume       NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">ab8500_btemp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_btemp_irq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_btemp_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Delete the work queue */</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_wq</span><span class="p">);</span>

	<span class="n">flush_scheduled_work</span><span class="p">();</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ab8500_btemp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">abx500_bm_plat_data</span> <span class="o">*</span><span class="n">plat_data</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ab8500_btemp</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No platform data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* get parent data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">gpadc</span> <span class="o">=</span> <span class="n">ab8500_gpadc_get</span><span class="p">(</span><span class="s">&quot;ab8500-gpadc.0&quot;</span><span class="p">);</span>

	<span class="cm">/* get btemp specific platform data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">btemp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no btemp platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get battery specific platform data */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span> <span class="o">=</span> <span class="n">plat_data</span><span class="o">-&gt;</span><span class="n">battery</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">bat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no battery platform data supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BTEMP supply */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500_btemp&quot;</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">ab8500_btemp_props</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_btemp_props</span><span class="p">);</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">ab8500_btemp_get_property</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">supplied_to</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">supplied_to</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">num_supplicants</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_supplicants</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">.</span><span class="n">external_power_changed</span> <span class="o">=</span>
		<span class="n">ab8500_btemp_external_power_changed</span><span class="p">;</span>


	<span class="cm">/* Create a work queue for the btemp */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_wq</span> <span class="o">=</span>
		<span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;ab8500_btemp_wq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to create work queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_device_info</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init work for measuring temperature periodically */</span>
	<span class="n">INIT_DELAYED_WORK_DEFERRABLE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_periodic_work</span><span class="p">,</span>
		<span class="n">ab8500_btemp_periodic_work</span><span class="p">);</span>

	<span class="cm">/* Identify the battery */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ab8500_btemp_id</span><span class="p">(</span><span class="n">di</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to identify the battery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Set BTEMP thermal limits. Low and Med are fixed */</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_low_limit</span> <span class="o">=</span> <span class="n">BTEMP_THERMAL_LOW_LIMIT</span><span class="p">;</span>
	<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_med_limit</span> <span class="o">=</span> <span class="n">BTEMP_THERMAL_MED_LIMIT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">abx500_get_register_interruptible</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">AB8500_CHARGER</span><span class="p">,</span>
		<span class="n">AB8500_BTEMP_HIGH_TH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ab8500 read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_btemp_wq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BTEMP_HIGH_TH_57_0</span>:
	<span class="k">case</span> <span class="n">BTEMP_HIGH_TH_57_1</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_high_limit</span> <span class="o">=</span>
			<span class="n">BTEMP_THERMAL_HIGH_LIMIT_57</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BTEMP_HIGH_TH_52</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_high_limit</span> <span class="o">=</span>
			<span class="n">BTEMP_THERMAL_HIGH_LIMIT_52</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BTEMP_HIGH_TH_62</span>:
		<span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_ranges</span><span class="p">.</span><span class="n">btemp_high_limit</span> <span class="o">=</span>
			<span class="n">BTEMP_THERMAL_HIGH_LIMIT_62</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register BTEMP power supply class */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">power_supply_register</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register BTEMP psy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_btemp_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ab8500_btemp_irq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_btemp_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ab8500_btemp_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isr</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_NO_SUSPEND</span><span class="p">,</span>
			<span class="n">ab8500_btemp_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to request %s IRQ %d: %d</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="p">,</span> <span class="n">ab8500_btemp_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Requested %s IRQ %d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ab8500_btemp_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>

	<span class="cm">/* Kick off periodic temperature measurements */</span>
	<span class="n">ab8500_btemp_periodic</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ab8500_btemp_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">free_irq:</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_psy</span><span class="p">);</span>

	<span class="cm">/* We also have to free all successfully registered irqs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ab8500_btemp_irq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">free_btemp_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">btemp_wq</span><span class="p">);</span>
<span class="nl">free_device_info:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ab8500_btemp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ab8500_btemp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ab8500_btemp_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ab8500_btemp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ab8500_btemp_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ab8500-btemp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ab8500_btemp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_btemp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ab8500_btemp_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ab8500_btemp_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">subsys_initcall_sync</span><span class="p">(</span><span class="n">ab8500_btemp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ab8500_btemp_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Johan Palsson, Karl Komierowski, Arun R Murthy&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:ab8500-btemp&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AB8500 battery temperature driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
