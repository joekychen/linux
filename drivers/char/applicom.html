<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › applicom.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>applicom.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Derived from Applicom driver ac.c for SCO Unix                            */</span>
<span class="cm">/* Ported by David Woodhouse, Axiom (Cambridge) Ltd.                         */</span>
<span class="cm">/* dwmw2@infradead.org 30/8/98                                               */</span>
<span class="cm">/* $Id: ac.c,v 1.30 2000/03/22 16:03:57 dwmw2 Exp $			     */</span>
<span class="cm">/* This module is for Linux 2.1 and 2.2 series kernels.                      */</span>
<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* J PAGET 18/02/94 passage V2.4.2 ioctl avec code 2 reset to les interrupt  */</span>
<span class="cm">/* ceci pour reseter correctement apres une sortie sauvage                   */</span>
<span class="cm">/* J PAGET 02/05/94 passage V2.4.3 dans le traitement de d&#39;interruption,     */</span>
<span class="cm">/* LoopCount n&#39;etait pas initialise a 0.                                     */</span>
<span class="cm">/* F LAFORSE 04/07/95 version V2.6.0 lecture bidon apres acces a une carte   */</span>
<span class="cm">/*           pour liberer le bus                                             */</span>
<span class="cm">/* J.PAGET 19/11/95 version V2.6.1 Nombre, addresse,irq n&#39;est plus configure */</span>
<span class="cm">/* et passe en argument a acinit, mais est scrute sur le bus pour s&#39;adapter  */</span>
<span class="cm">/* au nombre de cartes presentes sur le bus. IOCL code 6 affichait V2.4.3    */</span>
<span class="cm">/* F.LAFORSE 28/11/95 creation de fichiers acXX.o avec les differentes       */</span>
<span class="cm">/* addresses de base des cartes, IOCTL 6 plus complet                         */</span>
<span class="cm">/* J.PAGET le 19/08/96 copie de la version V2.6 en V2.8.0 sans modification  */</span>
<span class="cm">/* de code autre que le texte V2.6.1 en V2.8.0                               */</span>
<span class="cm">/*****************************************************************************/</span>


<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;applicom.h&quot;</span>


<span class="cm">/* NOTE: We use for loops with {write,read}b() instead of </span>
<span class="cm">   memcpy_{from,to}io throughout this driver. This is because</span>
<span class="cm">   the board doesn&#39;t correctly handle word accesses - only</span>
<span class="cm">   bytes. </span>
<span class="cm">*/</span>


<span class="cp">#undef DEBUG</span>

<span class="cp">#define MAX_BOARD 8		</span><span class="cm">/* maximum of pc board possible */</span><span class="cp"></span>
<span class="cp">#define MAX_ISA_BOARD 4</span>
<span class="cp">#define LEN_RAM_IO 0x800</span>
<span class="cp">#define AC_MINOR 157</span>

<span class="cp">#ifndef PCI_VENDOR_ID_APPLICOM</span>
<span class="cp">#define PCI_VENDOR_ID_APPLICOM                0x1389</span>
<span class="cp">#define PCI_DEVICE_ID_APPLICOM_PCIGENERIC     0x0001</span>
<span class="cp">#define PCI_DEVICE_ID_APPLICOM_PCI2000IBS_CAN 0x0002</span>
<span class="cp">#define PCI_DEVICE_ID_APPLICOM_PCI2000PFB     0x0003</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">ac_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">applicom_pci_devnames</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;PCI board&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCI2000IBS / PCI2000CAN&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCI2000PFB&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">applicom_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLICOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLICOM_PCIGENERIC</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLICOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLICOM_PCI2000IBS_CAN</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">APPLICOM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_APPLICOM_PCI2000PFB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">applicom_pci_tbl</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Woodhouse &amp; Applicom International&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for Applicom Profibus card&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_MISCDEV</span><span class="p">(</span><span class="n">AC_MINOR</span><span class="p">);</span>

<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;ac&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">applicom_board</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">PhysIO</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">RamIO</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">FlagSleepSend</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mutex</span><span class="p">;</span>
<span class="p">}</span> <span class="n">apbs</span><span class="p">[</span><span class="n">MAX_BOARD</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* interrupt number IRQ       */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* physical segment of board  */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ of the Applicom board&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="s">&quot;Shared Memory Address of Applicom board&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numboards</span><span class="p">;</span>	<span class="cm">/* number of installed boards */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Dummy</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">FlagSleepRec</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">WriteErrorCount</span><span class="p">;</span>	<span class="cm">/* number of write error      */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ReadErrorCount</span><span class="p">;</span>	<span class="cm">/* number of read error       */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DeviceErrorCount</span><span class="p">;</span>	<span class="cm">/* number of device error     */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ac_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ac_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">ac_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ac_interrupt</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ac_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ac_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ac_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">ac_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">miscdevice</span> <span class="n">ac_miscdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AC_MINOR</span><span class="p">,</span>
	<span class="s">&quot;ac&quot;</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">ac_fops</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">;</span>	<span class="cm">/* dev_id for request_irq() */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac_register_board</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physloc</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">loc</span><span class="p">,</span> 
		      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">boardno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte_reset_it</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">CONF_END_TEST</span><span class="p">)</span>     <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">CONF_END_TEST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">CONF_END_TEST</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">CONF_END_TEST</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boardno</span><span class="p">)</span>
		<span class="n">boardno</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">NUMCARD_OWNER_TO_PC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boardno</span> <span class="o">||</span> <span class="n">boardno</span> <span class="o">&gt;</span> <span class="n">MAX_BOARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Board #%d (at 0x%lx) is out of range (1 &lt;= x &lt;= %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">boardno</span><span class="p">,</span> <span class="n">physloc</span><span class="p">,</span> <span class="n">MAX_BOARD</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Board #%d (at 0x%lx) conflicts with previous board #%d (at 0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">boardno</span><span class="p">,</span> <span class="n">physloc</span><span class="p">,</span> <span class="n">boardno</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">PhysIO</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">boardno</span><span class="o">--</span><span class="p">;</span>

	<span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span><span class="p">].</span><span class="n">PhysIO</span> <span class="o">=</span> <span class="n">physloc</span><span class="p">;</span>
	<span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">=</span> <span class="n">loc</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span><span class="p">].</span><span class="n">FlagSleepSend</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span><span class="p">].</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">byte_reset_it</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="n">RAM_IT_TO_PC</span><span class="p">);</span>

	<span class="n">numboards</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">boardno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">applicom_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_miscdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">applicom_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">numisa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">RamIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">boardno</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Applicom driver: $Id: ac.c,v 1.30 2000/03/22 16:03:57 dwmw2 Exp $</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* No mem and irq given - check for a PCI card */</span>

	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_class</span><span class="p">(</span><span class="n">PCI_CLASS_OTHERS</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_match_id</span><span class="p">(</span><span class="n">applicom_pci_tbl</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">RamIO</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">LEN_RAM_IO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RamIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ac.o: Failed to ioremap PCI memory &quot;</span>
				<span class="s">&quot;space at 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Applicom %s found at mem 0x%llx, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">applicom_pci_devnames</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

		<span class="n">boardno</span> <span class="o">=</span> <span class="n">ac_register_board</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">RamIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">boardno</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ac.o: PCI Applicom device doesn&#39;t have correct signature.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">RamIO</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;Applicom PCI&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Could not allocate IRQ %d for PCI Applicom device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">RamIO</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Enable interrupts. */</span>

		<span class="n">writeb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_FROM_PC</span><span class="p">);</span>

		<span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finished with PCI cards. If none registered, </span>
<span class="cm">	 * and there was no mem/irq specified, exit */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span> <span class="o">||</span> <span class="o">!</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">numboards</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fin</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ac.o: No PCI boards found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ac.o: For an ISA board you must supply memory and irq parameters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now try the specified ISA cards */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ISA_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RamIO</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">mem</span> <span class="o">+</span> <span class="p">(</span><span class="n">LEN_RAM_IO</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="n">LEN_RAM_IO</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RamIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ac.o: Failed to ioremap the ISA card&#39;s memory space (slot #%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">boardno</span> <span class="o">=</span> <span class="n">ac_register_board</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem</span><span class="o">+</span> <span class="p">(</span><span class="n">LEN_RAM_IO</span><span class="o">*</span><span class="n">i</span><span class="p">),</span>
						  <span class="n">RamIO</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">RamIO</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Applicom ISA card found at mem 0x%lx, irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem</span> <span class="o">+</span> <span class="p">(</span><span class="n">LEN_RAM_IO</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">numisa</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;Applicom ISA&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Could not allocate IRQ %d for ISA Applicom device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">RamIO</span><span class="p">);</span>
				<span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">apbs</span><span class="p">[</span><span class="n">boardno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">numisa</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">numisa</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ac.o: No valid ISA Applicom boards found &quot;</span>
				<span class="s">&quot;at mem 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>

 <span class="nl">fin:</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">);</span>

	<span class="n">WriteErrorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ReadErrorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DeviceErrorCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">numboards</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_miscdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ac.o: Unable to register misc device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">boardname</span><span class="p">[(</span><span class="n">SERIAL_NUMBER</span> <span class="o">-</span> <span class="n">TYPE_CARD</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">serial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">serial</span> <span class="o">&lt;</span> <span class="n">SERIAL_NUMBER</span> <span class="o">-</span> <span class="n">TYPE_CARD</span><span class="p">;</span> <span class="n">serial</span><span class="o">++</span><span class="p">)</span>
				<span class="n">boardname</span><span class="p">[</span><span class="n">serial</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TYPE_CARD</span> <span class="o">+</span> <span class="n">serial</span><span class="p">);</span>

			<span class="n">boardname</span><span class="p">[</span><span class="n">serial</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Applicom board %d: %s, PROM V%d.%d&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">boardname</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>
			
			<span class="n">serial</span> <span class="o">=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> 
				<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> 
				<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">serial</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; S/N %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">applicom_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">applicom_exit</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ac_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">NumCard</span><span class="p">;</span>	<span class="cm">/* Board number 1 -&gt; 8           */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">IndexCard</span><span class="p">;</span>	<span class="cm">/* Index board number 0 -&gt; 7     */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">TicCard</span><span class="p">;</span>	<span class="cm">/* Board TIC to send             */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>	<span class="cm">/* Current priority              */</span>
	<span class="k">struct</span> <span class="n">st_ram_io</span> <span class="n">st_loc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mailbox</span> <span class="n">tmpmailbox</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">warncount</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">warncount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hmmm. write() of Applicom card, length %zd != expected %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">));</span>
			<span class="n">warncount</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_loc</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)))</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmpmailbox</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)],</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">)))</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">NumCard</span> <span class="o">=</span> <span class="n">st_loc</span><span class="p">.</span><span class="n">num_card</span><span class="p">;</span>	<span class="cm">/* board number to send          */</span>
	<span class="n">TicCard</span> <span class="o">=</span> <span class="n">st_loc</span><span class="p">.</span><span class="n">tic_des_from_pc</span><span class="p">;</span>	<span class="cm">/* tic number to send            */</span>
	<span class="n">IndexCard</span> <span class="o">=</span> <span class="n">NumCard</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">NumCard</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">NumCard</span> <span class="o">&gt;</span> <span class="n">MAX_BOARD</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Write to applicom card #%d. struct st_ram_io follows:&quot;</span><span class="p">,</span>
	       <span class="n">IndexCard</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">);)</span> <span class="p">{</span>
		
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%5.5X: %2.2X&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">st_loc</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">;</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">);</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">st_loc</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">struct mailbox follows:&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">);)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%5.5X: %2.2X&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tmpmailbox</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">;</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">);</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tmpmailbox</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Test octet ready correct */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> 
		<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;APPLICOM driver write error board %d, DataFromPcReady = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">IndexCard</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">));</span>
		<span class="n">DeviceErrorCount</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Place ourselves on the wait queue */</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">FlagSleepSend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* Check whether the card is ready for us */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>
		<span class="cm">/* It&#39;s busy. Sleep. */</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">FlagSleepSend</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We may not have actually slept */</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">FlagSleepSend</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">);</span>

	<span class="cm">/* Which is best - lock down the pages with rawio and then</span>
<span class="cm">	   copy directly, or use bounce buffers? For now we do the latter </span>
<span class="cm">	   because it works with 2.2 still */</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tmpmailbox</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_FROM_PC</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">);</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writeb</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">from</span><span class="o">++</span><span class="p">),</span> <span class="n">to</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TIC_OWNER_FROM_PC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">NUMCARD_OWNER_FROM_PC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">TicCard</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TIC_DES_FROM_PC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">NumCard</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">NUMCARD_DES_FROM_PC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_FROM_PC</span><span class="p">);</span>
	<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_ac_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">IndexCard</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">st_ram_io</span> <span class="o">*</span><span class="n">st_loc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mailbox</span> <span class="o">*</span><span class="n">mailbox</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_TO_PC</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mailbox</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">st_loc</span><span class="o">-&gt;</span><span class="n">tic_owner_to_pc</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TIC_OWNER_TO_PC</span><span class="p">);</span>
	<span class="n">st_loc</span><span class="o">-&gt;</span><span class="n">numcard_owner_to_pc</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">NUMCARD_OWNER_TO_PC</span><span class="p">);</span>


	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">);</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">to</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">from</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">ACK_FROM_PC_READY</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TYP_ACK_FROM_PC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">IndexCard</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">NUMCARD_ACK_FROM_PC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TIC_OWNER_TO_PC</span><span class="p">),</span> 
	       <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TIC_ACK_FROM_PC</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">ACK_FROM_PC_READY</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_TO_PC_READY</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_FROM_PC</span><span class="p">);</span>
	<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Read from applicom card #%d. struct st_ram_io follows:&quot;</span><span class="p">,</span> <span class="n">NumCard</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">);)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%5.5X: %2.2X&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">st_loc</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">;</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">);</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">st_loc</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">struct mailbox follows:&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">);)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">%5.5X: %2.2X&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mailbox</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">++</span><span class="p">;</span> <span class="n">c</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">);</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %2.2X&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mailbox</span><span class="p">)[</span><span class="n">c</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ac_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="kt">int</span> <span class="n">loopcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* No need to ratelimit this. Only root can trigger it anyway */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;Hmmm. read() of Applicom card, length %zd != expected %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">count</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mailbox</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Stick ourself on the wait queue */</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		
		<span class="cm">/* Scan each board, looking for one which has a packet for us */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_TO_PC_READY</span><span class="p">);</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">st_ram_io</span> <span class="n">st_loc</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">mailbox</span> <span class="n">mailbox</span><span class="p">;</span>

				<span class="cm">/* Got a packet for us */</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_loc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st_loc</span><span class="p">));</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">do_ac_read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st_loc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mailbox</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
				<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st_loc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st_loc</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">st_loc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mailbox</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mailbox</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Got an error */</span>
				<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>
				
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
				<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
				
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;APPLICOM driver read error board %d, DataToPcReady = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_TO_PC_READY</span><span class="p">));</span>
				<span class="n">DeviceErrorCount</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="cm">/* Nothing for us. Try the next board */</span>
			<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			
		<span class="p">}</span> <span class="cm">/* per board */</span>

		<span class="cm">/* OK - No boards had data for us. Sleep now */</span>

		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loopcount</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Looping in ac_read. loopcount %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">loopcount</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> 
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ac_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">vec</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FlagInt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">LoopCount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>printk("Applicom interrupt on IRQ %d occurred\n", vec);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">LoopCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">FlagInt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			
			<span class="cm">/* Skip if this board doesn&#39;t exist */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">);</span>

			<span class="cm">/* Skip if this board doesn&#39;t want attention */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_TO_PC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">FlagInt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_TO_PC</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_TO_PC_READY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;APPLICOM driver interrupt err board %d, DataToPcReady = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_TO_PC_READY</span><span class="p">));</span>
				<span class="n">DeviceErrorCount</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
			   <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
				
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;APPLICOM driver interrupt err board %d, DataFromPcReady = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">));</span>
				<span class="n">DeviceErrorCount</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_TO_PC_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* mailbox sent by the card ?   */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* ram i/o free for write by pc ? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FlagSleepSend</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* process sleep during read ?    */</span>
					<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FlagSleepSend</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_TO_PC</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* There&#39;s another int waiting on this card */</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">);</span>
				<span class="n">i</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mutex</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FlagInt</span><span class="p">)</span>
			<span class="n">LoopCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">LoopCount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">LoopCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">long</span> <span class="nf">ac_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
     
<span class="p">{</span>				<span class="cm">/* @ ADG ou ATO selon le cas */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">IndexCard</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pmem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte_reset_it</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_ram_io</span> <span class="o">*</span><span class="n">adgl</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="cm">/* In general, the device is only openable by root anyway, so we&#39;re not</span>
<span class="cm">	   particularly concerned that bogus ioctls can flood the console. */</span>

	<span class="n">adgl</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">adgl</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">adgl</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_mutex</span><span class="p">);</span>	
	<span class="n">IndexCard</span> <span class="o">=</span> <span class="n">adgl</span><span class="o">-&gt;</span><span class="n">num_card</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	 
	<span class="k">if</span><span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">IndexCard</span> <span class="o">&gt;=</span> <span class="n">MAX_BOARD</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">warncount</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">warncount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span> <span class="n">KERN_WARNING</span> <span class="s">&quot;APPLICOM driver IOCTL, bad board number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">IndexCard</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">warncount</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adgl</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">pmem</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">adgl</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">adgl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">pmem</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">CONF_END_TEST</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adgl</span><span class="o">-&gt;</span><span class="n">conf_end_test</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="o">++</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adgl</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="o">++</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adgl</span><span class="o">-&gt;</span><span class="n">parameter_error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="o">++</span><span class="p">);</span>
		<span class="n">pmem</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">;</span>
		<span class="n">adgl</span><span class="o">-&gt;</span><span class="n">vers</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="p">);</span>
		<span class="n">pmem</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TYPE_CARD</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adgl</span><span class="o">-&gt;</span><span class="n">reserv1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="o">++</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">adgl</span><span class="o">-&gt;</span><span class="n">reserv1</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span>  
			<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> 
			<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> 
			<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">adgl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">pmem</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">CONF_END_TEST</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">pmem</span><span class="o">++</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">adgl</span><span class="o">-&gt;</span><span class="n">data_from_pc_ready</span><span class="p">,</span> 
		       <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">);</span>

		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_FROM_PC</span><span class="p">);</span>
		
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">byte_reset_it</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_TO_PC</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">pmem</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TIC_DES_FROM_PC</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">adgl</span><span class="o">-&gt;</span><span class="n">tic_des_from_pc</span><span class="p">,</span> <span class="n">pmem</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">pmem</span> <span class="o">=</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TIC_OWNER_TO_PC</span><span class="p">;</span>
		<span class="n">adgl</span><span class="o">-&gt;</span><span class="n">tic_owner_to_pc</span>     <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="o">++</span><span class="p">);</span>
		<span class="n">adgl</span><span class="o">-&gt;</span><span class="n">numcard_owner_to_pc</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pmem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">adgl</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_ram_io</span><span class="p">)))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">writeb</span><span class="p">(</span><span class="n">adgl</span><span class="o">-&gt;</span><span class="n">num_card</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">NUMCARD_OWNER_TO_PC</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">adgl</span><span class="o">-&gt;</span><span class="n">num_card</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">NUMCARD_DES_FROM_PC</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">adgl</span><span class="o">-&gt;</span><span class="n">num_card</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">NUMCARD_ACK_FROM_PC</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">DATA_FROM_PC_READY</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">RAM_IT_FROM_PC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;APPLICOM driver release .... V2.8.0 ($Revision: 1.30 $)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Number of installed boards . %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">numboards</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Segment of board ........... %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mem</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Interrupt IRQ number ....... %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">boardname</span><span class="p">[(</span><span class="n">SERIAL_NUMBER</span> <span class="o">-</span> <span class="n">TYPE_CARD</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">serial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">serial</span> <span class="o">&lt;</span> <span class="n">SERIAL_NUMBER</span> <span class="o">-</span> <span class="n">TYPE_CARD</span><span class="p">;</span> <span class="n">serial</span><span class="o">++</span><span class="p">)</span>
				<span class="n">boardname</span><span class="p">[</span><span class="n">serial</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">TYPE_CARD</span> <span class="o">+</span> <span class="n">serial</span><span class="p">);</span>
			<span class="n">boardname</span><span class="p">[</span><span class="n">serial</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Prom version board %d ....... V%d.%d %s&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">),</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">),</span>
			       <span class="n">boardname</span><span class="p">);</span>


			<span class="n">serial</span> <span class="o">=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> 
				<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> 
				<span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">SERIAL_NUMBER</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">serial</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; S/N %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DeviceErrorCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DeviceErrorCount ........... %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DeviceErrorCount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ReadErrorCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ReadErrorCount ............. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ReadErrorCount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WriteErrorCount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;WriteErrorCount ............ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">WriteErrorCount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">FlagSleepRec</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Process in read pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_BOARD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">&amp;&amp;</span> <span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">FlagSleepSend</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Process in write pending board %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">Dummy</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">apbs</span><span class="p">[</span><span class="n">IndexCard</span><span class="p">].</span><span class="n">RamIO</span> <span class="o">+</span> <span class="n">VERS</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adgl</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
