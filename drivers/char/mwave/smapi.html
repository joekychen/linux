<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › char › mwave › smapi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>smapi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">*</span>
<span class="cm">* smapi.c -- SMAPI interface routines</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">* Written By: Mike Sullivan IBM Corporation</span>
<span class="cm">*</span>
<span class="cm">* Copyright (C) 1999 IBM Corporation</span>
<span class="cm">*</span>
<span class="cm">* This program is free software; you can redistribute it and/or modify</span>
<span class="cm">* it under the terms of the GNU General Public License as published by</span>
<span class="cm">* the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">* (at your option) any later version.</span>
<span class="cm">*</span>
<span class="cm">* This program is distributed in the hope that it will be useful,</span>
<span class="cm">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">* GNU General Public License for more details.</span>
<span class="cm">*</span>
<span class="cm">* NO WARRANTY</span>
<span class="cm">* THE PROGRAM IS PROVIDED ON AN &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR</span>
<span class="cm">* CONDITIONS OF ANY KIND, EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT</span>
<span class="cm">* LIMITATION, ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT,</span>
<span class="cm">* MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Each Recipient is</span>
<span class="cm">* solely responsible for determining the appropriateness of using and</span>
<span class="cm">* distributing the Program and assumes all risks associated with its</span>
<span class="cm">* exercise of rights under this Agreement, including but not limited to</span>
<span class="cm">* the risks and costs of program errors, damage to or loss of data,</span>
<span class="cm">* programs or equipment, and unavailability or interruption of operations.</span>
<span class="cm">*</span>
<span class="cm">* DISCLAIMER OF LIABILITY</span>
<span class="cm">* NEITHER RECIPIENT NOR ANY CONTRIBUTORS SHALL HAVE ANY LIABILITY FOR ANY</span>
<span class="cm">* DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm">* DAMAGES (INCLUDING WITHOUT LIMITATION LOST PROFITS), HOWEVER CAUSED AND</span>
<span class="cm">* ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR</span>
<span class="cm">* TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="cm">* USE OR DISTRIBUTION OF THE PROGRAM OR THE EXERCISE OF ANY RIGHTS GRANTED</span>
<span class="cm">* HEREUNDER, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGES</span>
<span class="cm">*</span>
<span class="cm">* You should have received a copy of the GNU General Public License</span>
<span class="cm">* along with this program; if not, write to the Free Software</span>
<span class="cm">* Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*</span>
<span class="cm">*</span>
<span class="cm">* 10/23/2000 - Alpha Release</span>
<span class="cm">*	First release to the public</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mc146818rtc.h&gt;	</span><span class="cm">/* CMOS defines */</span><span class="cp"></span>
<span class="cp">#include &quot;smapi.h&quot;</span>
<span class="cp">#include &quot;mwavedd.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">g_usSmapiPort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">smapi_request</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">inBX</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">inCX</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">inDI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">inSI</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">outAX</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">outBX</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">outCX</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">outDX</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">outDI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">outSI</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">myoutAX</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">pmyoutAX</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">myoutAX</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">myoutBX</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="o">*</span><span class="n">pmyoutBX</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">myoutBX</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">myoutCX</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="n">pmyoutCX</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">myoutCX</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">myoutDX</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">*</span><span class="n">pmyoutDX</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">myoutDX</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">myoutDI</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="n">pmyoutDI</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">myoutDI</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">myoutSI</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="o">*</span><span class="n">pmyoutSI</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">myoutSI</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">usSmapiOK</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">,</span> <span class="o">*</span><span class="n">pusSmapiOK</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usSmapiOK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inBXCX</span> <span class="o">=</span> <span class="p">(</span><span class="n">inBX</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">inCX</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inDISI</span> <span class="o">=</span> <span class="p">(</span><span class="n">inDI</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">inSI</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PRINTK_5</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;inBX %x inCX %x inDI %x inSI %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">inBX</span><span class="p">,</span> <span class="n">inCX</span><span class="p">,</span> <span class="n">inDI</span><span class="p">,</span> <span class="n">inSI</span><span class="p">);</span>

	<span class="n">__asm__</span> <span class="n">__volatile__</span><span class="p">(</span><span class="s">&quot;movw  $0x5380,%%ax</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movl  %7,%%ebx</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;shrl  $16, %%ebx</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %7,%%cx</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movl  %8,%%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;shrl  $16,%%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %8,%%si</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %9,%%dx</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;out   %%al,%%dx</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;out   %%al,$0x4F</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;cmpb  $0x53,%%ah</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;je    2f</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;1:</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;orb   %%ah,%%ah</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;jnz   2f</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %%ax,%0</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %%bx,%1</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %%cx,%2</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %%dx,%3</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %%di,%4</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  %%si,%5</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;movw  $1,%6</span><span class="se">\n\t</span><span class="s">&quot;</span>
			    <span class="s">&quot;2:</span><span class="se">\n\t</span><span class="s">&quot;</span><span class="o">:</span><span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmyoutAX</span><span class="p">),</span>
			    <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmyoutBX</span><span class="p">),</span>
			    <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmyoutCX</span><span class="p">),</span>
			    <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmyoutDX</span><span class="p">),</span>
			    <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmyoutDI</span><span class="p">),</span>
			    <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">pmyoutSI</span><span class="p">),</span>
			    <span class="s">&quot;=m&quot;</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">pusSmapiOK</span><span class="p">)</span>
			    <span class="o">:</span><span class="s">&quot;m&quot;</span><span class="p">(</span><span class="n">inBXCX</span><span class="p">),</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="n">inDISI</span><span class="p">),</span> <span class="s">&quot;m&quot;</span><span class="p">(</span><span class="n">g_usSmapiPort</span><span class="p">)</span>
			    <span class="o">:</span><span class="s">&quot;%eax&quot;</span><span class="p">,</span> <span class="s">&quot;%ebx&quot;</span><span class="p">,</span> <span class="s">&quot;%ecx&quot;</span><span class="p">,</span> <span class="s">&quot;%edx&quot;</span><span class="p">,</span> <span class="s">&quot;%edi&quot;</span><span class="p">,</span>
			    <span class="s">&quot;%esi&quot;</span><span class="p">);</span>

	<span class="n">PRINTK_8</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
		<span class="s">&quot;myoutAX %x myoutBX %x myoutCX %x myoutDX %x myoutDI %x myoutSI %x usSmapiOK %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">myoutAX</span><span class="p">,</span> <span class="n">myoutBX</span><span class="p">,</span> <span class="n">myoutCX</span><span class="p">,</span> <span class="n">myoutDX</span><span class="p">,</span> <span class="n">myoutDI</span><span class="p">,</span> <span class="n">myoutSI</span><span class="p">,</span>
		<span class="n">usSmapiOK</span><span class="p">);</span>
	<span class="o">*</span><span class="n">outAX</span> <span class="o">=</span> <span class="n">myoutAX</span><span class="p">;</span>
	<span class="o">*</span><span class="n">outBX</span> <span class="o">=</span> <span class="n">myoutBX</span><span class="p">;</span>
	<span class="o">*</span><span class="n">outCX</span> <span class="o">=</span> <span class="n">myoutCX</span><span class="p">;</span>
	<span class="o">*</span><span class="n">outDX</span> <span class="o">=</span> <span class="n">myoutDX</span><span class="p">;</span>
	<span class="o">*</span><span class="n">outDI</span> <span class="o">=</span> <span class="n">myoutDI</span><span class="p">;</span>
	<span class="o">*</span><span class="n">outSI</span> <span class="o">=</span> <span class="n">myoutSI</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">usSmapiOK</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">PRINTK_2</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_request exit retval %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">smapi_query_DSP_cfg</span><span class="p">(</span><span class="n">SMAPI_DSP_SETTINGS</span> <span class="o">*</span> <span class="n">pSettings</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bRC</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">usAX</span><span class="p">,</span> <span class="n">usBX</span><span class="p">,</span> <span class="n">usCX</span><span class="p">,</span> <span class="n">usDX</span><span class="p">,</span> <span class="n">usDI</span><span class="p">,</span> <span class="n">usSI</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ausDspBases</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x4E30</span><span class="p">,</span> <span class="mh">0x8E30</span><span class="p">,</span> <span class="mh">0xCE30</span><span class="p">,</span> <span class="mh">0x0130</span><span class="p">,</span> <span class="mh">0x0350</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x0DB0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ausUartBases</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x03F8</span><span class="p">,</span> <span class="mh">0x02F8</span><span class="p">,</span> <span class="mh">0x03E8</span><span class="p">,</span> <span class="mh">0x02E8</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">numDspBases</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">numUartBases</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1802</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg: Error: Could not get DSP Settings. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg, smapi_request OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">bDSPPresent</span> <span class="o">=</span> <span class="p">((</span><span class="n">usBX</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">bDSPEnabled</span> <span class="o">=</span> <span class="p">((</span><span class="n">usCX</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspIRQ</span> <span class="o">=</span> <span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">;</span>
	<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspDMA</span> <span class="o">=</span> <span class="p">(</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">usDI</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numDspBases</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspBaseIO</span> <span class="o">=</span> <span class="n">ausDspBases</span><span class="p">[</span><span class="n">usDI</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspBaseIO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PRINTK_6</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
		<span class="s">&quot;smapi::smapi_query_DSP_cfg get DSP Settings bDSPPresent %x bDSPEnabled %x usDspIRQ %x usDspDMA %x usDspBaseIO %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">bDSPPresent</span><span class="p">,</span> <span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">bDSPEnabled</span><span class="p">,</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspIRQ</span><span class="p">,</span> <span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspDMA</span><span class="p">,</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspBaseIO</span><span class="p">);</span>

	<span class="cm">/* check for illegal values */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspBaseIO</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> 
		<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg: Worry: DSP base I/O address is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usDspIRQ</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg: Worry: DSP IRQ line is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1804</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	   	<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="s">&quot;smapi::smapi_query_DSP_cfg: Error: Could not get DSP modem settings. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
	<span class="p">}</span> 

	<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg, smapi_request OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">bModemEnabled</span> <span class="o">=</span> <span class="p">((</span><span class="n">usCX</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usUartIRQ</span> <span class="o">=</span> <span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">numUartBases</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usUartBaseIO</span> <span class="o">=</span> <span class="n">ausUartBases</span><span class="p">[(</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usUartBaseIO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTK_4</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
		<span class="s">&quot;smapi::smapi_query_DSP_cfg get DSP modem settings bModemEnabled %x usUartIRQ %x usUartBaseIO %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">bModemEnabled</span><span class="p">,</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usUartIRQ</span><span class="p">,</span>
		<span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usUartBaseIO</span><span class="p">);</span>

	<span class="cm">/* check for illegal values */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usUartBaseIO</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> 
		<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg: Worry: UART base I/O address is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">pSettings</span><span class="o">-&gt;</span><span class="n">usUartIRQ</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg: Worry: UART IRQ line is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">PRINTK_2</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_query_DSP_cfg exit bRC %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bRC</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">smapi_set_DSP_cfg</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bRC</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">usAX</span><span class="p">,</span> <span class="n">usBX</span><span class="p">,</span> <span class="n">usCX</span><span class="p">,</span> <span class="n">usDX</span><span class="p">,</span> <span class="n">usDI</span><span class="p">,</span> <span class="n">usSI</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ausDspBases</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x4E30</span><span class="p">,</span> <span class="mh">0x8E30</span><span class="p">,</span> <span class="mh">0xCE30</span><span class="p">,</span> <span class="mh">0x0130</span><span class="p">,</span> <span class="mh">0x0350</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x0DB0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ausUartBases</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x03F8</span><span class="p">,</span> <span class="mh">0x02F8</span><span class="p">,</span> <span class="mh">0x03E8</span><span class="p">,</span> <span class="mh">0x02E8</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ausDspIrqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ausUartIrqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">numDspBases</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">numUartBases</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">numDspIrqs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">numUartIrqs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">dspio_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uartio_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PRINTK_5</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
		<span class="s">&quot;smapi::smapi_set_DSP_cfg entry mwave_3780i_irq %x mwave_3780i_io %x mwave_uart_irq %x mwave_uart_io %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mwave_3780i_irq</span><span class="p">,</span> <span class="n">mwave_3780i_io</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">,</span> <span class="n">mwave_uart_io</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_3780i_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numDspBases</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mwave_3780i_io</span> <span class="o">==</span> <span class="n">ausDspBases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">numDspBases</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_set_DSP_cfg: Error: Invalid mwave_3780i_io address %x. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mwave_3780i_io</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dspio_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_3780i_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numDspIrqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mwave_3780i_irq</span> <span class="o">==</span> <span class="n">ausDspIrqs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">numDspIrqs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_set_DSP_cfg: Error: Invalid mwave_3780i_irq %x. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mwave_3780i_irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_uart_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numUartBases</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mwave_uart_io</span> <span class="o">==</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">numUartBases</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_set_DSP_cfg: Error: Invalid mwave_uart_io address %x. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mwave_uart_io</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">uartio_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_uart_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numUartIrqs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mwave_uart_irq</span> <span class="o">==</span> <span class="n">ausUartIrqs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">numUartIrqs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_set_DSP_cfg: Error: Invalid mwave_uart_irq %x. Aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_uart_irq</span> <span class="o">||</span> <span class="n">mwave_uart_io</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Check serial port A */</span>
		<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1402</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
		<span class="cm">/* bRC == 0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usBX</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* serial port A is present */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usCX</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* serial port is enabled */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">mwave_uart_irq</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
					<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port A irq %x conflicts with mwave_uart_irq %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">);</span>
<span class="cp">#else</span>
					<span class="n">PRINTK_3</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port A irq %x conflicts with mwave_uart_irq %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
					<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg Disabling conflicting serial port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1403</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1402</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
<span class="cp">#else</span>
					<span class="k">goto</span> <span class="n">exit_conflict</span><span class="p">;</span>
<span class="cp">#endif</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">usSI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">uartio_index</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
						<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span>
							<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port A base I/O address %x conflicts with mwave uart I/O %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">usSI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">],</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">uartio_index</span><span class="p">]);</span>
<span class="cp">#else</span>
						<span class="n">PRINTK_3</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
							<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port A base I/O address %x conflicts with mwave uart I/O %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">usSI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">],</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">uartio_index</span><span class="p">]);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
						<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
							<span class="s">&quot;smapi::smapi_set_DSP_cfg Disabling conflicting serial port A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span> <span class="p">(</span><span class="mh">0x1403</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
						<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span> <span class="p">(</span><span class="mh">0x1402</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
<span class="cp">#else</span>
						<span class="k">goto</span> <span class="n">exit_conflict</span><span class="p">;</span>
<span class="cp">#endif</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Check serial port B */</span>
		<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1404</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
		<span class="cm">/* bRC == 0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usBX</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* serial port B is present */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usCX</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* serial port is enabled */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span> <span class="n">mwave_uart_irq</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
					<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port B irq %x conflicts with mwave_uart_irq %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">);</span>
<span class="cp">#else</span>
					<span class="n">PRINTK_3</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port B irq %x conflicts with mwave_uart_irq %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
					<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg Disabling conflicting serial port B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1405</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1404</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
<span class="cp">#else</span>
					<span class="k">goto</span> <span class="n">exit_conflict</span><span class="p">;</span>
<span class="cp">#endif</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">usSI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">uartio_index</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
						<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span>
							<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port B base I/O address %x conflicts with mwave uart I/O %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">usSI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">],</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">uartio_index</span><span class="p">]);</span>
<span class="cp">#else</span>
						<span class="n">PRINTK_3</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
							<span class="s">&quot;smapi::smapi_set_DSP_cfg: Serial port B base I/O address %x conflicts with mwave uart I/O %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">usSI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">],</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">uartio_index</span><span class="p">]);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
						<span class="n">PRINTK_1</span> <span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
						    <span class="s">&quot;smapi::smapi_set_DSP_cfg Disabling conflicting serial port B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span> <span class="p">(</span><span class="mh">0x1405</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
						<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span> <span class="p">(</span><span class="mh">0x1404</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
<span class="cp">#else</span>
						<span class="k">goto</span> <span class="n">exit_conflict</span><span class="p">;</span>
<span class="cp">#endif</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Check IR port */</span>
		<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1700</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
		<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1704</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
		<span class="cm">/* bRC == 0 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">usCX</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* IR port not disabled */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">usCX</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">mwave_uart_irq</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
				<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span>
					<span class="s">&quot;smapi::smapi_set_DSP_cfg: IR port irq %x conflicts with mwave_uart_irq %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usCX</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">PRINTK_3</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
					<span class="s">&quot;smapi::smapi_set_DSP_cfg: IR port irq %x conflicts with mwave_uart_irq %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usCX</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mwave_uart_irq</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
				<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
					<span class="s">&quot;smapi::smapi_set_DSP_cfg Disabling conflicting IR port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1701</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
				<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
				<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1705</span><span class="p">,</span> <span class="mh">0x01ff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
				<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1704</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
<span class="cp">#else</span>
				<span class="k">goto</span> <span class="n">exit_conflict</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">uartio_index</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
					<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg: IR port base I/O address %x conflicts with mwave uart I/O %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">],</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">uartio_index</span><span class="p">]);</span>
<span class="cp">#else</span>
					<span class="n">PRINTK_3</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg: IR port base I/O address %x conflicts with mwave uart I/O %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">],</span> <span class="n">ausUartBases</span><span class="p">[</span><span class="n">uartio_index</span><span class="p">]);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES</span>
					<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
						<span class="s">&quot;smapi::smapi_set_DSP_cfg Disabling conflicting IR port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1701</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1700</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1705</span><span class="p">,</span> <span class="mh">0x01ff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
					<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1704</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>
<span class="cp">#else</span>
					<span class="k">goto</span> <span class="n">exit_conflict</span><span class="p">;</span>
<span class="cp">#endif</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1802</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_3780i_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usDI</span> <span class="o">=</span> <span class="n">dspio_index</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_3780i_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usSI</span> <span class="o">=</span> <span class="p">(</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="n">mwave_3780i_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1803</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="n">usDI</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1804</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_uart_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usSI</span> <span class="o">=</span> <span class="p">(</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">uartio_index</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mwave_uart_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usSI</span> <span class="o">=</span> <span class="p">(</span><span class="n">usSI</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">|</span> <span class="n">mwave_uart_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1805</span><span class="p">,</span> <span class="mh">0x0101</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usSI</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1802</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x1804</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bRC</span><span class="p">)</span> <span class="k">goto</span> <span class="n">exit_smapi_request_error</span><span class="p">;</span>

<span class="cm">/* normal exit: */</span>
	<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_set_DSP_cfg exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_conflict:</span>
	<span class="cm">/* Message has already been printed */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">exit_smapi_request_error:</span>
	<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="n">KERN_ERR_MWAVE</span> <span class="s">&quot;smapi::smapi_set_DSP_cfg exit on smapi_request error bRC %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bRC</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">smapi_set_DSP_power_state</span><span class="p">(</span><span class="n">BOOLEAN</span> <span class="n">bOn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bRC</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">usAX</span><span class="p">,</span> <span class="n">usBX</span><span class="p">,</span> <span class="n">usCX</span><span class="p">,</span> <span class="n">usDX</span><span class="p">,</span> <span class="n">usDI</span><span class="p">,</span> <span class="n">usSI</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">usPowerFunction</span><span class="p">;</span>

	<span class="n">PRINTK_2</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_set_DSP_power_state entry bOn %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bOn</span><span class="p">);</span>

	<span class="n">usPowerFunction</span> <span class="o">=</span> <span class="p">(</span><span class="n">bOn</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bRC</span> <span class="o">=</span> <span class="n">smapi_request</span><span class="p">(</span><span class="mh">0x4901</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usPowerFunction</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">usAX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usBX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usCX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usDI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usSI</span><span class="p">);</span>

	<span class="n">PRINTK_2</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_set_DSP_power_state exit bRC %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bRC</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bRC</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int SmapiQuerySystemID(void)</span>
<span class="c">{</span>
<span class="c">	int bRC = -EIO;</span>
<span class="c">	unsigned short usAX = 0xffff, usBX = 0xffff, usCX = 0xffff,</span>
<span class="c">		usDX = 0xffff, usDI = 0xffff, usSI = 0xffff;</span>

<span class="c">	printk(&quot;smapi::SmapiQUerySystemID entry\n&quot;);</span>
<span class="c">	bRC = smapi_request(0x0000, 0, 0, 0,</span>
<span class="c">		&amp;usAX, &amp;usBX, &amp;usCX, &amp;usDX, &amp;usDI, &amp;usSI);</span>

<span class="c">	if (bRC == 0) {</span>
<span class="c">		printk(&quot;AX=%x, BX=%x, CX=%x, DX=%x, DI=%x, SI=%x\n&quot;,</span>
<span class="c">			usAX, usBX, usCX, usDX, usDI, usSI);</span>
<span class="c">	} else {</span>
<span class="c">		printk(&quot;smapi::SmapiQuerySystemID smapi_request error\n&quot;);</span>
<span class="c">	}</span>

<span class="c">	return bRC;</span>
<span class="c">}</span>
<span class="cp">#endif  /*  0  */</span>

<span class="kt">int</span> <span class="nf">smapi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">usSmapiID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">PRINTK_1</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_init entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">usSmapiID</span> <span class="o">=</span> <span class="n">CMOS_READ</span><span class="p">(</span><span class="mh">0x7C</span><span class="p">);</span>
	<span class="n">usSmapiID</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CMOS_READ</span><span class="p">(</span><span class="mh">0x7D</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">PRINTK_2</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span> <span class="s">&quot;smapi::smapi_init usSmapiID %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usSmapiID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usSmapiID</span> <span class="o">==</span> <span class="mh">0x5349</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">g_usSmapiPort</span> <span class="o">=</span> <span class="n">CMOS_READ</span><span class="p">(</span><span class="mh">0x7E</span><span class="p">);</span>
		<span class="n">g_usSmapiPort</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CMOS_READ</span><span class="p">(</span><span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">g_usSmapiPort</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="s">&quot;smapi::smapi_init, ERROR unable to read from SMAPI port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PRINTK_2</span><span class="p">(</span><span class="n">TRACE_SMAPI</span><span class="p">,</span>
				<span class="s">&quot;smapi::smapi_init, exit TRUE g_usSmapiPort %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">g_usSmapiPort</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>SmapiQuerySystemID();</p></td><td class="code"><div class="highlight"><pre>		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PRINTK_ERROR</span><span class="p">(</span><span class="s">&quot;smapi::smapi_init, ERROR invalid usSmapiID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
